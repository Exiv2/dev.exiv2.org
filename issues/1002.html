<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #1002: libexiv2 crashes on some video files - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="mu5TFSdKBpgBDtLKk/58PYz08s6KrVJrWV+9TXiqlst4o/j6VTDKmFRqzcYsKXAOs2amt3tO89Gkfy3FO5NxpA==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #1002: libexiv2 crashes on some video files" href="https://dev.exiv2.org/issues/1002.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #1002</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>libexiv2 crashes on some video files</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/4279">Johannes Zarl</a> <a title="25 Nov 2014 16:52" href="/projects/exiv2/activity?from=2014-11-25">almost 7 years</a> ago.
        Updated <a title="21 Jun 2015 16:42" href="/projects/exiv2/activity?from=2015-06-21">over 6 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/3290">Abhinav Badola</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">video</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="17 May 2015" href="/versions/51">0.25</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">25 Nov 2014</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value"></div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>libexiv2 crashes on some AVI video files in my collection. MPlayer does not report any problem with the file. As far as I can remember, the video has been rotated/reencoded using mencoder.<br />I've first encountered this because KPhotoAlbum crashed while reading exif information from a video, but it can be observed using the exiv2 commandline tool as well:</p>


<pre>
zing@mani:~/tmp/kphotoalbum/build$ exiv2 crash-exiv2.avi
*** Error in `exiv2': free(): invalid next size (fast): 0x0000000000bfca30 ***
Aborted (core dumped)
zing@mani:~/tmp/kphotoalbum/build$ echo "bt" | gdb --quiet exiv2 core
Reading symbols from exiv2...(no debugging symbols found)...done.
[New LWP 7618]
Core was generated by `exiv2 crash-exiv2.avi'.
Program terminated with signal SIGABRT, Aborted.
#0  0x00007fc4222c0107 in __GI_raise (sig=sig@entry=6) at ../nptl/sysdeps/unix/sysv/linux/raise.c:56
56      ../nptl/sysdeps/unix/sysv/linux/raise.c: No such file or directory.
(gdb) #0  0x00007fc4222c0107 in __GI_raise (sig=sig@entry=6) at ../nptl/sysdeps/unix/sysv/linux/raise.c:56
#1  0x00007fc4222c14e8 in __GI_abort () at abort.c:89
#2  0x00007fc4222fe044 in __libc_message (do_abort=do_abort@entry=1, fmt=fmt@entry=0x7fc4223f0c60 "*** Error in `%s': %s: 0x%s ***\n") at ../sysdeps/posix/libc_fatal.c:175
#3  0x00007fc42230381e in malloc_printerr (action=1, str=0x7fc4223f0e20 "free(): invalid next size (fast)", ptr=&lt;optimized out&gt;) at malloc.c:4996
#4  0x00007fc422304526 in _int_free (av=&lt;optimized out&gt;, p=&lt;optimized out&gt;, have_lock=0) at malloc.c:3840
#5  0x00007fc422f914f9 in Exiv2::RiffVideo::infoTagsHandler() () from /usr/lib/x86_64-linux-gnu/libexiv2.so.13
#6  0x00007fc422f95355 in Exiv2::RiffVideo::decodeBlock() () from /usr/lib/x86_64-linux-gnu/libexiv2.so.13
#7  0x00007fc422f94f88 in Exiv2::RiffVideo::tagDecoder(Exiv2::DataBuf&#38;, unsigned long) () from /usr/lib/x86_64-linux-gnu/libexiv2.so.13
#8  0x00007fc422f95355 in Exiv2::RiffVideo::decodeBlock() () from /usr/lib/x86_64-linux-gnu/libexiv2.so.13
#9  0x00007fc422f956f8 in Exiv2::RiffVideo::readMetadata() () from /usr/lib/x86_64-linux-gnu/libexiv2.so.13
#10 0x00000000004177ab in ?? ()
#11 0x000000000041a0fc in ?? ()
#12 0x00000000004057fe in ?? ()
#13 0x00007fc4222acb45 in __libc_start_main (main=0x4056e0, argc=2, argv=0x7fff457c97e8, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fff457c97d8) at libc-start.c:287
#14 0x0000000000405aea in ?? ()
(gdb) quit
</pre>

	<p>Some information on the video:<br /><pre>
$ mplayer -really-quiet -identify -frames 0 crash-exiv2.avi 
ID_VIDEO_ID=0
ID_AUDIO_ID=0
ID_CLIP_INFO_NAME0=date
ID_CLIP_INFO_VALUE0=$2
ID_CLIP_INFO_NAME1=encoder
ID_CLIP_INFO_VALUE1=Lavf53.32.100
ID_CLIP_INFO_N=2
ID_FILENAME=crash-exiv2.avi
ID_DEMUXER=lavfpref
ID_VIDEO_FORMAT=MP4V
ID_VIDEO_BITRATE=0
ID_VIDEO_WIDTH=240
ID_VIDEO_HEIGHT=320
ID_VIDEO_FPS=15.000
ID_VIDEO_ASPECT=0.7500
ID_AUDIO_FORMAT=1
ID_AUDIO_BITRATE=64000
ID_AUDIO_RATE=8000
ID_AUDIO_NCH=1
ID_START_TIME=0.00
ID_LENGTH=1.27
ID_SEEKABLE=1
ID_CHAPTERS=0
ID_VIDEO_CODEC=ffodivx
ID_AUDIO_BITRATE=64000
ID_AUDIO_RATE=8000
ID_AUDIO_NCH=1
ID_AUDIO_CODEC=pcm
ID_EXIT=EOF
</pre></p>


	<p>I'm using Debian unstable with libexiv2-13:<br /><pre>
$ dpkg -l exiv2 libexiv2-13 libexiv2-dev
Desired=Unknown/Install/Remove/Purge/Hold
| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend
|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)
||/ Name                                                  Version                         Architecture                    Description
+++-=====================================================-===============================-===============================-===============================================================================================================
ii  exiv2                                                 0.24-4                          amd64                           EXIF/IPTC metadata manipulation tool
ii  libexiv2-13:amd64                                     0.24-4                          amd64                           EXIF/IPTC metadata manipulation library
ii  libexiv2-dev                                          0.24-4                          amd64                           EXIF/IPTC metadata manipulation library - development files
</pre></p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/689">crash-exiv2.avi</a>    <span class="size">(281 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/689/crash-exiv2.avi">crash-exiv2.avi</a>  </td>
  <td></td>
  <td>
      <span class="author">Johannes Zarl, 25 Nov 2014 16:52</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>








</div>




<div id="history">
<h3>History</h3>
  <div id="change-2984" class="journal has-notes">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/3290">Abhinav Badola</a> <a title="26 Nov 2014 04:22" href="/projects/exiv2/activity?from=2014-11-26">almost 7 years</a> ago
      <span id="journal-2984-private_notes" class=""></span>
    </h4>

    <div id="journal-2984-notes" class="wiki"><p>Thanks Johannes. :)</p>


	<p>I will look into this bug this coming weekend and work on the fix.</p></div>
    </div>
  </div>
  
  <div id="change-2997" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/3290">Abhinav Badola</a> <a title="30 Nov 2014 19:42" href="/projects/exiv2/activity?from=2014-11-30">almost 7 years</a> ago
      <span id="journal-2997-private_notes" class=""></span>
    </h4>

    <div id="journal-2997-notes" class="wiki"><p>Hi Johannes,</p>


	<p>I am sorry, but I am not able to reproduce the bug on my laptop.<br />I am using the exiv2 from the trunk and this is what I got.</p>


<pre>

[badola@XPS:~/exiv2/trunk/build]$./bin/exiv2 -pa ../../crash-exiv2.avi 
Xmp.video.FileSize                           XmpText     8  0.274137
Xmp.video.FileName                           XmpText    21  ../../crash-exiv2.avi
Xmp.video.MimeType                           XmpText    10  video/riff
Xmp.video.Container                          XmpText     4  RIFF
Xmp.video.FileType                           XmpText     4  AVI 
Xmp.video.MicroSecPerFrame                   XmpText     5  66666
Xmp.video.MaxDataRate                        XmpText     6  7.8125
Xmp.video.FrameCount                         XmpText     2  19
Xmp.video.StreamCount                        XmpText     1  2
Xmp.video.Width                              XmpText     3  240
Xmp.video.Height                             XmpText     3  320
Xmp.video.AspectRatio                        XmpText     3  0.7
Xmp.video.FileDataRate                       XmpText    11  0.000216538
Xmp.video.Duration                           XmpText     4  1266
Xmp.video.Codec                              XmpText     4  FMP4
Xmp.video.FrameRate                          XmpText     2  15
Xmp.video.VideoQuality                       XmpText    10  4294967295
Xmp.video.VideoSampleSize                    XmpText     1  0
Xmp.video.Planes                             XmpText     1  1
Xmp.video.PixelDepth                         XmpText     2  24
Xmp.video.Compressor                         XmpText     4  FMP4
Xmp.video.ImageLength                        XmpText     6  230400
Xmp.video.PixelPerMeterX                     XmpText     1  0
Xmp.video.PixelPerMeterY                     XmpText     1  0
Xmp.video.NumOfColours                       XmpText    11  Unspecified
Xmp.video.NumOfImpColours                    XmpText     3  All
Xmp.audio.Codec                              XmpText     1  
Xmp.audio.SampleRate                         XmpText     4  8000
Xmp.audio.SampleCount                        XmpText     5  10144
Xmp.audio.Compressor                         XmpText    13  Microsoft PCM
Xmp.audio.ChannelType                        XmpText     4  Mono
Xmp.audio.SampleType                         XmpText     4  8000
Xmp.audio.BitsPerSample                      XmpText     1  8
Xmp.video.Junk                               XmpText     0  
Xmp.video.DateTimeDigitized                  XmpText     2  $2

</pre>

	<p>Maybe the bug got fixed in trunk and is present in some older version.</p>


	<p>Can you please confirm if you are using the latest code from the trunk..??</p></div>
    </div>
  </div>
  
  <div id="change-3001" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4279">Johannes Zarl</a> <a title="30 Nov 2014 22:31" href="/projects/exiv2/activity?from=2014-11-30">almost 7 years</a> ago
      <span id="journal-3001-private_notes" class=""></span>
    </h4>

    <div id="journal-3001-notes" class="wiki"><p>Hi Abhinav,</p>


	<p>I've checked again with the latest trunk, and it seems to be fixed. The version in tags/0.24 crashes.</p>


	<p>I guess I'll just have to wait for version 0.25, then ;-)</p>


	<p>Thanks for looking into it,<br />  Johannes</p></div>
    </div>
  </div>
  
  <div id="change-3002" class="journal has-notes has-details">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="01 Dec 2014 09:19" href="/projects/exiv2/activity?from=2014-12-01">almost 7 years</a> ago
      <span id="journal-3002-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>New</i> to <i>Resolved</i></li>
       <li><strong>Target version</strong> set to <i>0.25</i></li>
    </ul>
    <div id="journal-3002-notes" class="wiki"><p>Abhinav and Johannes</p>


	<p>I'm going to mark this as "Resolved".  It will not be changed to "Closed" until review as part of the v0.25 release process.  If anything new comes to light about this, please update this issue report and it will be investigated.</p>


	<p>Robin</p></div>
    </div>
  </div>
  
  <div id="change-3012" class="journal has-notes has-details">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/3290">Abhinav Badola</a> <a title="04 Dec 2014 04:43" href="/projects/exiv2/activity?from=2014-12-04">almost 7 years</a> ago
      <span id="journal-3012-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>0</i> to <i>100</i></li>
    </ul>
    <div id="journal-3012-notes" class="wiki"><p>Thanks Johannes, for verifying it for us. :)</p></div>
    </div>
  </div>
  
  <div id="change-3132" class="journal has-notes">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4338">Nico Kruber</a> <a title="09 Feb 2015 00:48" href="/projects/exiv2/activity?from=2015-02-09">almost 7 years</a> ago
      <span id="journal-3132-private_notes" class=""></span>
    </h4>

    <div id="journal-3132-notes" class="wiki"><p>FYI: I fixed this bug by applying the patch from revision 3264, i.e. <a class="external" href="http://dev.exiv2.org/projects/exiv2/repository/revisions/3264">http://dev.exiv2.org/projects/exiv2/repository/revisions/3264</a></p>


	<p>So, this bug seems to be related to <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Problem With Exiv2 ( Video files) (Closed)" href="/issues/960">#960</a></p></div>
    </div>
  </div>
  
  <div id="change-3133" class="journal has-notes">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/3290">Abhinav Badola</a> <a title="09 Feb 2015 02:43" href="/projects/exiv2/activity?from=2015-02-09">almost 7 years</a> ago
      <span id="journal-3133-private_notes" class=""></span>
    </h4>

    <div id="journal-3133-notes" class="wiki"><p>Thanks a lot, Nico. :)</p>


	<p>Really appreciate your efforts in making Exiv2 better.</p>


	<p>Nico Kruber wrote:</p>


<blockquote>

	<p>FYI: I fixed this bug by applying the patch from revision 3264, i.e. <a class="external" href="http://dev.exiv2.org/projects/exiv2/repository/revisions/3264">http://dev.exiv2.org/projects/exiv2/repository/revisions/3264</a></p>


	<p>So, this bug seems to be related to <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Problem With Exiv2 ( Video files) (Closed)" href="/issues/960">#960</a></p>


</blockquote></div>
    </div>
  </div>
  
  <div id="change-3134" class="journal has-notes">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4338">Nico Kruber</a> <a title="10 Feb 2015 01:15" href="/projects/exiv2/activity?from=2015-02-10">almost 7 years</a> ago
      <span id="journal-3134-private_notes" class=""></span>
    </h4>

    <div id="journal-3134-notes" class="wiki"><p>thanks for your patch, Abhinav - I finally have a working digikam again :)<br />(luckily it was a clean patch which I could apply to 0.24 straight away)</p></div>
    </div>
  </div>
  
  <div id="change-3898" class="journal has-details">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="21 Jun 2015 16:41" href="/projects/exiv2/activity?from=2015-06-21">over 6 years</a> ago
      <span id="journal-3898-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Resolved</i> to <i>Closed</i></li>
    </ul>
    
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1002.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1002.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
