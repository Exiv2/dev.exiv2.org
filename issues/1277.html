<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #1277: Crash with Canon CR2 file - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="09LbuOpvQot/nMW+mtVsq7gVEs/w3D/VrgF333j/dVkxn3BXmBWOiyr42rIlAmCYh4dGtgE/nm9TIedXO8aSNg==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #1277: Crash with Canon CR2 file" href="https://dev.exiv2.org/issues/1277.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #1277</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Crash with Canon CR2 file</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/4722">Ben Touchette</a> <a title="14 Feb 2017 18:31" href="/projects/exiv2/activity?from=2017-02-14">almost 5 years</a> ago.
        Updated <a title="14 Feb 2017 20:53" href="/projects/exiv2/activity?from=2017-02-14">almost 5 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">image format</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="28 Apr 2017" href="/versions/52">0.26</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">14 Feb 2017</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">1.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>Have a client with a crash on a Canon CR2 file that contains unknown tags with random sizes (most likely a corrupted file) on an inner tiff structure.  The camera model as a 350D (Rbel XT) according to the metadata.</p>


	<p>Including the image and a fix for the crash. When we detect an unknown tag with value of 0 break from the foor loop for that tiff data dir.</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1133">IMG_3770.CR2</a>    <span class="size">(8.18 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1133/IMG_3770.CR2">IMG_3770.CR2</a>  </td>
  <td>image with crash issue</td>
  <td>
      <span class="author">Ben Touchette, 14 Feb 2017 18:31</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1134">cr2_crash_fix.diff</a>    <span class="size">(639 Bytes)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1134/cr2_crash_fix.diff">cr2_crash_fix.diff</a>  </td>
  <td>patch to work around issue.</td>
  <td>
      <span class="author">Ben Touchette, 14 Feb 2017 18:31</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1135">Tiff.png</a>    <span class="size">(40.1 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1135/Tiff.png">Tiff.png</a>  </td>
  <td></td>
  <td>
      <span class="author">Robin Mills, 14 Feb 2017 20:07</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>








</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 4706" href="/projects/exiv2/repository/exiv2/revisions/4706">Revision 4706</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4706/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Feb 2017 20:07" href="/projects/exiv2/activity?from=2017-02-14">almost 5 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash with Canon CR2 file (Closed)" href="/issues/1277">#1277</a> Fix submitted.  Thank You to Ben for reporting this and providing a patch.</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-5847" class="journal has-notes has-details">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Feb 2017 20:07" href="/projects/exiv2/activity?from=2017-02-14">almost 5 years</a> ago
      <span id="journal-5847-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/1135">Tiff.png</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/1135/Tiff.png">Tiff.png</a> added</li>
       <li><strong>Category</strong> set to <i>image format</i></li>
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Target version</strong> set to <i>0.26</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>50</i></li>
       <li><strong>Estimated time</strong> set to <i>2.00 h</i></li>
    </ul>
    <div id="journal-5847-notes" class="wiki"><p>Ben</p>


	<p>Thanks for you little Valentine's Day surprise gift!  The surprise is that I don't get a crash on my trunk <a class="changeset" title="#1275 Fix issue with Exiv2::Key.familyName() for key.ifdId_ == mpfId" href="/projects/exiv2/repository/exiv2/revisions/4705">r4705</a> with either command:<pre>$ exiv2 -pR ~/Downloads/IMG_3770.CR2
or
$ exiv2 -pa ~/Downloads/IMG_3770.CR2</pre></p>


	<p>Type should always be in 1-13 as illustrated in this drawing below which I made about the structure of Tiff files (in exiv2/team/drawings/Tiff.graffle).</p>


	<p>Thanks very much for reporting this and for investigating and providing a patch.</p>


	<p>I've submitted a variant of your patch: <a class="changeset" title="#1277 Fix submitted.  Thank You to Ben for reporting this and providing a patch." href="/projects/exiv2/repository/exiv2/revisions/4706">r4706</a>.  I made a little change to check the range type being 1-13.  I also write a warning to std::cerr when this is detected.<pre>576 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pR ~/Downloads/*.CR2 &gt; /dev/null
invalid type value detected in Image::printIFDStructure:  0
577 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre></p>


	<p>There is a "loose end".  I'm wondering how the TiffVisitor will handle this situation.  However as the file isn't causing a crash, I believe the situation is benign.</p>


	<p>Perhaps you could review my change.  If you are happy, please close the issue.  If you have other CR2 files which cause Exiv2 to crash I will investigate more.</p>


	<p>Happy Valentines.</p></div>
    </div>
  </div>
  
  <div id="change-5848" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4722">Ben Touchette</a> <a title="14 Feb 2017 20:17" href="/projects/exiv2/activity?from=2017-02-14">almost 5 years</a> ago
      <span id="journal-5848-private_notes" class=""></span>
    </h4>

    <div id="journal-5848-notes" class="wiki"><p>I don't pay attention to most holidays, lol, more so if they are hyper commercialized :) sorry if i messed up any plans :)</p>


	<p>Yes i understand that but on my end the file gets a type 0. The size for the bit of data was around 4GB.</p>


	<p>I was testing with <a class="changeset" title="Update Pentax camera list to match ExifTool version 10.41." href="/projects/exiv2/repository/exiv2/revisions/4703">r4703</a>, just looked at the latest code updates and not sure why the changes after that would help though.</p>


	<p>Doesn't hurt to have the check anyways :)</p></div>
    </div>
  </div>
  
  <div id="change-5849" class="journal has-notes has-details">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Feb 2017 20:53" href="/projects/exiv2/activity?from=2017-02-14">almost 5 years</a> ago
      <span id="journal-5849-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Closed</i></li>
       <li><strong>% Done</strong> changed from <i>50</i> to <i>100</i></li>
       <li><strong>Estimated time</strong> changed from <i>2.00 h</i> to <i>1.00 h</i></li>
    </ul>
    <div id="journal-5849-notes" class="wiki"><p>We don't do anything on Valentines.  Or maybe, every day is Valentines!</p>


	<p>I totally agree that this test is necessary.  This was bug waiting to appear and it hasn't revealed itself to me.  If you discover files that cause this message to appear, please attach them and change the status to "Assigned" and I'll investigate.  In the meanwhile, I'll close this issue.</p>


	<p><img src="/attachments/download/1135/Tiff.png" alt="" /></p></div>
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1277.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1277.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
