<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Patch #993: Generating svn_version.h with CMake - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="HOXbL5765GTBVlwilvMcVMqg0rFjMtBc6dPeL+pTY/P+qHDA7IAoZJQyQy4pJBBn9TKGyJLRceYU806nqWqEnA==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Patch #993: Generating svn_version.h with CMake" href="https://dev.exiv2.org/issues/993.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Patch #993</h2>

<div class="issue tracker-4 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Generating svn_version.h with CMake</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/2456">Daniel Kaneider</a> <a title="21 Sep 2014 11:14" href="/projects/exiv2/activity?from=2014-09-21">about 7 years</a> ago.
        Updated <a title="21 Jun 2015 16:42" href="/projects/exiv2/activity?from=2015-06-21">over 6 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">build</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="17 May 2015" href="/versions/51">0.25</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">21 Sep 2014</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value"></div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>Hi,</p>


	<p>I took the liberty to provide you a patch to enable the svn version detection in a (almost) clean way. It works for CMake only (including windows), and there is a fallback if the source directory is not under svn version control.</p>


	<p>On linux, svn should be automatically detected. On windows, svn can be either on the system path, detected via installed TortoiseSVN client (including binaries), or using the following additional command on cmake:</p>


	<p><code>cmake.exe ... -DCMAKE_PROGRAM_PATH=C:\Subversion-Directory\bin</code></p>


	<p>Pay attention, that the cygwin svn binary doesn't work in combination with CMake.</p>


	<p>There is still a small room for improvement: if header files (svn_version.h) are changed, then all files using an import to that file will get recompiled. This behaviour was already present. You might think about changing that it to an external definition in a header ( <code>extern int svnVersion;</code> ), which then gets resolved at link time ( <code>char g_GIT_SHA1[] = "123";</code> ). This is how we do it in LuminanceHDR, and on svn changes it reduces the files required to recompile to basically one.</p>


	<p>Tested on Windows VS 2012 x64, with CMake 3.0.2. The patch is against the 3364 version.</p>


	<p>Best,<br />Daniel</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/680">cmake-svn.patch</a>    <span class="size">(3.86 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/680/cmake-svn.patch">cmake-svn.patch</a>  </td>
  <td></td>
  <td>
      <span class="author">Daniel Kaneider, 21 Sep 2014 11:14</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>








</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 3396" href="/projects/exiv2/repository/exiv2/revisions/3396">Revision 3396</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/3396/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="30 Nov 2014 07:28" href="/projects/exiv2/activity?from=2014-11-30">almost 7 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-4 status-5 priority-4 priority-default closed" title="Patch: Generating svn_version.h with CMake (Closed)" href="/issues/993">#993</a>.  svn_version.h generated in wrong directory for out of source cmake builds.</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-2922" class="journal has-notes has-details">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="21 Sep 2014 11:47" href="/projects/exiv2/activity?from=2014-09-21">about 7 years</a> ago
      <span id="journal-2922-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Target version</strong> set to <i>0.25</i></li>
    </ul>
    <div id="journal-2922-notes" class="wiki"><p>Thanks, Daniel.  I appreciate this very much.  I will commit this (or a slightly modified version) shortly.  However I'd like to hear your response to my thoughts before I commit:</p>


	<ol>
	<li>I don't think we can remove ./svn_version.sh because it's used by the autotools to generate svn_version.h</li>
		<li>Will this code keep rewriting svn_version.h which will cause recompilation of version.cpp (and possibly other code).  One of the features of svn_version.sh is to grep svn_version.h and only update svn_version.h when necessary.</li>
		<li>Does svn_version.h get updated if required on every build.  Or does this code only update svn_version when we run/rerun CMake?</li>
		<li>If CMake/Cygwin/svn are in collision, should we continue to use svn_version.sh for Cygwin (as I believe we have to retain it for the autotools anyway)?</li>
		<li>I'm uneasy about requiring TortoiseSVN (which I really like) or an additional command-line -DCMAKE_PROGRAM_PATH argument.  I'm sure we can invoke svn and test ERRORLEVEL.  Perhaps we need a little batch file svn_version.bat (very similar to svn_version.sh) to generate svn_version.h from DOS.  I can run svn_version.bat from CMake and Visual Studio.  One reason I didn't do that was because grep is not guaranteed available on DOS and I've never understood the DOS find command.</li>
	</ol>


	<p>Thanks for doing this, Daniel.  Very good work.</p>


	<p>Robin</p></div>
    </div>
  </div>
  
  <div id="change-2923" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/2456">Daniel Kaneider</a> <a title="03 Oct 2014 21:50" href="/projects/exiv2/activity?from=2014-10-03">about 7 years</a> ago
      <span id="journal-2923-private_notes" class=""></span>
    </h4>

    <div id="journal-2923-notes" class="wiki"><p>Robin,</p>


	<p>First I'm glad that the web site appears to be up and running. AWS sounds definitely nice ;) If you can't view my attached patch, plz let me know. See my comments below</p>


<blockquote>

	<p>Thanks, Daniel.  I appreciate this very much.  I will commit this (or a slightly modified version) shortly.  However I'd like to hear your response to my thoughts before I commit:</p>


	<ol>
	<li>I don't think we can remove ./svn_version.sh because it's used by the autotools to generate svn_version.h</li>
	</ol>


</blockquote>

	<p>The solution for the future would be to drop autotools and to just relay on CMake. Since I guess you want to postpone that step, I suggest to incorporate those 5 lines of code of the svn_version.sh file into autotools/config. Then you should be able to remove it without any problems</p>


<blockquote>

	<ol>
	<li>Will this code keep rewriting svn_version.h which will cause recompilation of version.cpp (and possibly other code).  One of the features of svn_version.sh is to grep svn_version.h and only update svn_version.h when necessary.</li>
	</ol>


</blockquote>

	<p>As far as I tested it a few weeks ago, CMake will take care of that. This means that the file gets recompiled if and only if the svn version gets changed. CMake takes care about a lot of things like that.</p>


<blockquote>

	<ol>
	<li>Does svn_version.h get updated if required on every build.  Or does this code only update svn_version when we run/rerun CMake?</li>
	</ol>


</blockquote>

	<p>You have to rerun CMake, which you should do every time after an svn update</p>


<blockquote>

	<ol>
	<li>If CMake/Cygwin/svn are in collision, should we continue to use svn_version.sh for Cygwin (as I believe we have to retain it for the autotools anyway)?</li>
	</ol>


</blockquote>

	<p>A small misunderstanding: Just if svn is used through cygwin without the cygwin console (you get thousands of warnings if you do so anyway) you get problems. Using the regular cygwin pipeline should work (didn't test it).</p>


<blockquote>

	<ol>
	<li>I'm uneasy about requiring TortoiseSVN (which I really like) or an additional command-line -DCMAKE_PROGRAM_PATH argument.  I'm sure we can invoke svn and test ERRORLEVEL.  Perhaps we need a little batch file svn_version.bat (very similar to svn_version.sh) to generate svn_version.h from DOS.  I can run svn_version.bat from CMake and Visual Studio.  One reason I didn't do that was because grep is not guaranteed available on DOS and I've never understood the DOS find command.</li>
	</ol>


</blockquote>

	<p>The thing here is that you gonna need to tell CMAke somehow where to find the svn binary. For windows I suggest installing the command line svn version and making sure it can be found on the command line. Thats it. Normally the installers already take care about that. Alternatively you can use the methods described above. The DCMAKE_PROGRAM_PATH might be interesting for your Jenkins system. <br />I don't get your point with the .bat file. It does not make any sense to me. svn_version is currently not generated for VS, so why should it? Official packagers should use CMake, and public folk doesn't need svn version generation.</p>


	<p>--Daniel</p></div>
    </div>
  </div>
  
  <div id="change-2925" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/133">Robin Mills</a> <a title="04 Oct 2014 14:22" href="/projects/exiv2/activity?from=2014-10-04">about 7 years</a> ago
      <span id="journal-2925-private_notes" class=""></span>
    </h4>

    <div id="journal-2925-notes" class="wiki"><p>I'm going to go along with you on this, Daniel.  I'll submit your patch on Sunday.</p>


	<p>I don't think we're going to be dropping autotools any time soon.  However our long-term goal is to make CMake our primary build platform.  We're not there yet.</p></div>
    </div>
  </div>
  
  <div id="change-2926" class="journal has-notes">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="05 Oct 2014 19:08" href="/projects/exiv2/activity?from=2014-10-05">about 7 years</a> ago
      <span id="journal-2926-private_notes" class=""></span>
    </h4>

    <div id="journal-2926-notes" class="wiki"><p>Patch submitted: <a class="changeset" title="Issue: 993.  Thank you Daniel for the patch.  Two changes to the patch are explained in the Issue..." href="/projects/exiv2/repository/exiv2/revisions/3371">r3371</a></p>


	<p>I made two changes to the patch:</p>


	<ol>
	<li>I am going to continue with svn_version.sh for the autotools build.  It's called from src/Makefile which is not a config generated file.</li>
		<li>There was a block of code for <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Unit tests do not build with CMake and out of source build (Closed)" href="/issues/722">#722</a> removed by the patch.  I've retained that code.  If you have a strong reason to remove that code, please let me know and I'll remove it.</li>
	</ol>


<pre>
IF( NOT MSVC )
  # Issue #722: out of source builds compiled against standard include files such as /usr/local/lib/include/exiv2
  # do not use CREATE_SYMLINK or CMAKE_CAN_SYMLINK as they don't work on CYGWIN
  EXECUTE_PROCESS( WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}           COMMAND ln -sf ${CMAKE_CURRENT_SOURCE_DIR}/src exiv2)

  IF( EXIV2_ENABLE_BUILD_SAMPLES )
    EXECUTE_PROCESS( WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/samples COMMAND ln -sf ${CMAKE_CURRENT_SOURCE_DIR}/src exiv2)
  ENDIF( EXIV2_ENABLE_BUILD_SAMPLES )

  IF( EXIV2_ENABLE_BUILD_PO )
    EXECUTE_PROCESS( WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/po      COMMAND ln -sf ${CMAKE_CURRENT_SOURCE_DIR}/src exiv2)
  ENDIF( EXIV2_ENABLE_BUILD_PO )
ENDIF()
</pre>

	<p>I apologise for confusing you about svn_version.bat.  I have thought about having a little batch file which has the same purpose an svn_version.sh and would be called by the Visual Studio 'native' project files.  I'm not going to bother with this.  You've put something very nice into the CMake files to generate svn_version.h and that's great.  Let's leave it be.  The primary purpose of svn_version.h is for developers and I think it's OK for this not to be supported in Visual Studio 'native' builds.</p>


	<p>Thanks very much for your patience with this, Daniel.  As you know, we've relocated the Exiv2 server and the project has been "off the air" for 2 weeks.</p>


	<p>Robin</p></div>
    </div>
  </div>
  
  <div id="change-2927" class="journal has-details">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="05 Oct 2014 19:19" href="/projects/exiv2/activity?from=2014-10-05">about 7 years</a> ago
      <span id="journal-2927-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Resolved</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-2992" class="journal has-notes">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="30 Nov 2014 07:29" href="/projects/exiv2/activity?from=2014-11-30">almost 7 years</a> ago
      <span id="journal-2992-private_notes" class=""></span>
    </h4>

    <div id="journal-2992-notes" class="wiki"><p>Fix submitted: <a class="changeset" title="#993.  svn_version.h generated in wrong directory for out of source cmake builds." href="/projects/exiv2/repository/exiv2/revisions/3396">r3396</a>.  svn_version.h was being generated in the wrong directory for out of source cmake builds.</p></div>
    </div>
  </div>
  
  <div id="change-2993" class="journal has-details">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="30 Nov 2014 07:30" href="/projects/exiv2/activity?from=2014-11-30">almost 7 years</a> ago
      <span id="journal-2993-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Subject</strong> changed from <i>svn_version for CMake windows (patch)</i> to <i>Generating svn_version.h with CMake</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-3606" class="journal has-details">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="08 May 2015 16:13" href="/projects/exiv2/activity?from=2015-05-08">over 6 years</a> ago
      <span id="journal-3606-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>0</i> to <i>100</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-3892" class="journal has-details">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="21 Jun 2015 16:41" href="/projects/exiv2/activity?from=2015-06-21">over 6 years</a> ago
      <span id="journal-3892-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Resolved</i> to <i>Closed</i></li>
    </ul>
    
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/993.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/993.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
