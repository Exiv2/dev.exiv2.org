<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Feature #1245: Better I/O implementation when EXV_HAVE_MMAP is not set - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="NDFg6aRznr1SG1QncCdLkY1JqzGGgywg0pz4pavwgTDWfMsG1glSvQd/SyvP8Eeistv/SHdgjZovvGgt6MlmXw==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Feature #1245: Better I/O implementation when EXV_HAVE_MMAP is not set" href="https://dev.exiv2.org/issues/1245.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Feature #1245</h2>

<div class="issue tracker-2 status-2 priority-4 priority-default details">
    <div class="next-prev-links contextual">
      <a title="#1246" accesskey="p" href="/issues/1246">« Previous</a> |
        <span class="position">
          <a href="/issues?f%5B%5D=status_id&amp;f%5B%5D=author_id&amp;op%5Bauthor_id%5D=%3D&amp;op%5Bstatus_id%5D=%2A&amp;page=1&amp;per_page=100&amp;set_filter=1&amp;sort=id%3Adesc&amp;v%5Bauthor_id%5D%5B%5D=119&amp;v%5Bstatus_id%5D%5B%5D=">17 of 115</a>
        </span> |
      <a title="#1244" accesskey="n" href="/issues/1244">Next »</a>
    </div>

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Better I/O implementation when EXV_HAVE_MMAP is not set</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="17 Oct 2016 15:33" href="/projects/exiv2/activity?from=2016-10-17">about 5 years</a> ago.
        Updated <a title="01 Nov 2016 08:39" href="/projects/exiv2/activity?from=2016-11-01">about 5 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Assigned</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">design</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="31 Dec 2020" href="/versions/54">0.28</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">17 Oct 2016</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-0"><tr><td style="width: 100%;" class="todo"></td></tr></table><p class="percent">0%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value"></div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>See discussion in <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: exiv2 without EXV_HAVE_MMAP throws an exception (Closed)" href="/issues/1244">#1244</a>.</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1086">v025plus.patch.zip</a>    <span class="size">(41 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1086/v025plus.patch.zip">v025plus.patch.zip</a>  </td>
  <td></td>
  <td>
      <span class="author">Robin Mills, 20 Oct 2016 18:24</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>







<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/1245" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="RhGrv1izHJE3J3qncQLblcoWEtABc+9q9hTNJ7+0uNGkXABQKsnQkWJDZavO1dem9YRGqfCQTtALNF2v/I1fvg==" />
  <table class="list issues odd-even"><tr id="relation-253" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1244" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/1244">Bug #1244</a>: exiv2 without EXV_HAVE_MMAP throws an exception</td><td class="status">Closed</td><td class="start_date">15 Oct 2016</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-254" class="issue hascontextmenu issue tracker-2 status-2 priority-4 priority-default"><td class="checkbox"><input type="checkbox" name="ids[]" value="992" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-2 status-2 priority-4 priority-default" href="/issues/992">Feature #992</a>: Better raw file support and test</td><td class="status">Assigned</td><td class="start_date">18 Sep 2014</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-0"><tr><td style="width: 100%;" class="todo"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/1245/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=1245&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>




<div id="history">
<h3>History</h3>
  <div id="change-5703" class="journal has-notes has-details">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="20 Oct 2016 18:24" href="/projects/exiv2/activity?from=2016-10-20">about 5 years</a> ago
      <span id="journal-5703-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/1086">v025plus.patch.zip</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/1086/v025plus.patch.zip">v025plus.patch.zip</a> added</li>
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
    </ul>
    <div id="journal-5703-notes" class="wiki"><p>Discussion with Asdiel Echevarria</p>


<blockquote>

	<p>We really like your idea and implementation for reading only the metadata blocks while still using File I/O and we are thinking to try to back port it to 0.26 once 0.26 is released.  We will of course share it back in the repository in case you guys do a release between 0.26 and 0.27.</p>


</blockquote>

	<p>My reply:</p>


	<p>I’ve backported the necessary code from v0.26 to v0.25.  The changes to make that happen are mostly in src/*image.cpp and src/basicio.cpp (and their .hpp companions).  It’s not as trivial as I say because you have to update the build and other consequential magic.  There are new files in v0.26 (src/webpimage.cpp, src/ini.cpp).  However I’ve done everything in about two hours.  It builds and executes the v0.25 test suite without crashing.  The test suite reports various matters which have been fixed in v0.26.  The formatted output from the command exiv2 -pS is slightly different in v0.26.  For certain this is sufficient to be sent to your test/QE people. <a class="external" href="http://clanmills.com/exiv2/exiv2-0.25+.tar.gz">http://clanmills.com/exiv2/exiv2-0.25+.tar.gz</a> and I attach a patch for v0.25.</p>


	<p>It reads TIFFs over the internet very efficiency.  I added instrumentation to HttpIo to see the blocks being fetched.  11 blocks of 1024bytes.<br /><pre>1052 rmills@rmillsmbp:~/gnu/exiv2 $ ssh secret-user-name@clanmills.com ls -alt www/files/Reagan.tiff
-rw-r--r-- 1 clanmil1 clanmil1 8628164 Oct 16 10:45 www/files/Reagan.tiff
1053 rmills@rmillsmbp:~/gnu/exiv2/v0.25/build $ bin/Debug/exiv2 -pa --grep Software http://clanmills.com/files/Reagan.tiff
HttpIo::HttpImpl::getDataByRange: 0,0
HttpIo::HttpImpl::getDataByRange: 8416,8416
HttpIo::HttpImpl::getDataByRange: 8417,8417
HttpIo::HttpImpl::getDataByRange: 8418,8418
HttpIo::HttpImpl::getDataByRange: 8419,8422
HttpIo::HttpImpl::getDataByRange: 8423,8425
Exif.Image.Software                          Ascii      29  Adobe Photoshop CS Macintosh
1054 rmills@rmillsmbp:~/gnu/exiv2/v0.25/build $</pre>If/When you make the changes for the network drive, I will be very happy to accept a patch.  I’ll review and test it, then put it on the trunk after v0.26 has shipped.  From my point of view, there is no hurry at all with this.</p>


	<p>Incidentally, I pulled down all the raw images yesterday from here: <a class="external" href="https://www.rawsamples.ch/index.php/en/">https://www.rawsamples.ch/index.php/en/</a>  Exiv2 reads all 322 without a single stumble when they are on local storage.  <a class="external" href="https://www.rawsamples.ch/index.php/en/">https://www.rawsamples.ch/index.php/en/</a>  The project for 2017 to enhance our raw image support and test will investigate that every image can be read efficiently over the internet.  I’m planning to recruit a Google Summer of Code student for that project.  So it would be good to have your patch by May 2017.<pre>529 rmills@rmillsmbp:~/gnu/exiv2/trunk $ time build/bin/Debug/exiv2 -pa -g Software http://clanmills.com/files/Reagan.tiff
Exif.Image.Software                          Ascii      29  Adobe Photoshop CS Macintosh

real    0m1.582s
user    0m0.014s
sys    0m0.012s
530 rmills@rmillsmbp:~/gnu/exiv2/trunk $ time curl -O http://clanmills.com/files/Reagan.tiff
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 8425k  100 8425k    0     0   787k      0  0:00:10  0:00:10 --:--:-- 1601k

real    0m10.745s
user    0m0.074s
sys    0m0.319s
531 rmills@rmillsmbp:~/gnu/exiv2/trunk $ ls -alt Reagan.tiff
-rw-r--r--+ 1 rmills staff 8628164 Oct 21 12:00 Reagan.tiff
532 rmills@rmillsmbp:~/gnu/exiv2/trunk $</pre></p></div>
    </div>
  </div>
  
  <div id="change-5737" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="01 Nov 2016 08:39" href="/projects/exiv2/activity?from=2016-11-01">about 5 years</a> ago
      <span id="journal-5737-private_notes" class=""></span>
    </h4>

    <div id="journal-5737-notes" class="wiki"><p>Here's a discussion with Asdiel that I would like to share with Hanno who is interested in fuzzing in <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: floating point exception / crash on malformed input (Closed)" href="/issues/1248">#1248</a>.</p>


<blockquote>

	<p>I like your idea to use MMAP on local drives.  I’ve not so enthusiastic about class NetworkIo because I think there is a simpler way!  There’s an option “useCurl” in the ImageFactory.  Perhaps you could expand that from a simple boolean to an enum.  Something like:</p>


</blockquote>

<pre>typedef enum { kifNone = 0x0 , kifUseCurl = 0x01, kifUseMMAP = 0x02 , kifUseOtherMagic = 0x04  } ImageFactoryOption;</pre>

<blockquote>

	<p>You’ll need code in FileIo which I’ve already added to RemoteIo to read the blockMap.  However try to avoid cutting’n’pasting code.  Promote code in the class hierarchy where possible.</p>


	<p>How the get from here to happiness?</p>


	<p>As you know, getting a product to ship is a tough time.  I’ve fixed TiffImage/RemoteIo by calling TiffImage::printStructure(kpsRecursive) in TiffImage::readMetadata().  I’ll have to implement CrwImage::printStructure().  Gosh, our project to review and strengthen RawImage support is scheduled for v0.27.  If I pursue every dark hole, I’ll be here forever!</p>


	<p>My agenda is to finish v0.26 and do not want to be diverted into making those changes in FileIo.  However, you can do the work and test it.  I’ll accept (review and test) your patch and put it on the trunk AFTER v0.26 has shipped.</p>


	<p>I didn’t write Exiv2, so there are areas of the code that are unfamiliar.  I don’t remember how the image factory works, however you can make your own AlienFactory from which you may instance AlienIo classes and/or our classes such as FileIo classes.</p>


	<p>However, rather than start a parallel universe, I feel it would be better if you build on the excellent foundations of Andreas and Brad.  Build on FileIo and share the code for everybody to use!  After all, you get this magic and a lot of my time for nothing.  Share with the community - that’s the open-source way!</p>


</blockquote></div>
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1245.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1245.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
