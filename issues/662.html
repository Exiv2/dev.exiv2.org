<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #662: Incorrect Unicode encoding of Exif UserComment tag - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="dUyBp0Uo3glpxsRpT49SWs00CA3BH9Zu2lFhDyl36XiXASpIN1ISCTyi22XwWF5p8qZcdDD8d9QncfGHak4OFw==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #662: Incorrect Unicode encoding of Exif UserComment tag" href="https://dev.exiv2.org/issues/662.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #662</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Incorrect Unicode encoding of Exif UserComment tag</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/311">Leo Sutic</a> <a title="18 Dec 2009 09:46" href="/projects/exiv2/activity?from=2009-12-18">almost 12 years</a> ago.
        Updated <a title="29 May 2010 10:42" href="/projects/exiv2/activity?from=2010-05-29">over 11 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value">-</div></div><div class="category attribute"><div class="label">Category:</div><div class="value">metadata</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="30 May 2010" href="/versions/45">0.20</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">18 Dec 2009</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value"></div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>In the Exif UserComment tag, the characters may be encoded as Ascii, Unicode, JIS or "Undefined".</p>


	<p>This bug concerns the encoding when choosing Unicode encoding.</p>


	<p>Exiv2 uses UTF-8. Exiftool, Windows and Microsoft Photo Info use UCS-2 and decode UserComments written by exiv2 as a jumble of glyphs. Exiv2, OTOH, can't decode the tags written by the aforementioned programs. There is a problem here.</p>


	<p>So, which one is right?</p>


	<p>The Exif 2.1 spec references the "Unicode Standard, The Unicode Consortium, 1991, Addison-Wesley". This is the 1.0.0 version of the Unicode spec, and back then UCS-2 was the default encoding. The Exif 2.2 spec makes no reference to any specific version of the Unicode standard, but we can assume that it is the intention of the Exif standards body to make Exif 2.2 backwards compatible with Exif 2.1.</p>


	<p>I would therefore say that it is Exiv2 that is in error here.</p>


	<p>If the Exiv2 team finds this argument valid, we need a short and a long term solution. The short term solution is intended to bridge the gap between now and until all images whose UserComment fields have been written as UTF-8 have been converted to UCS-2. The long term solution is to completely switch to UCS-2.</p>


	<p>My suggested short-term solution is this:</p>


	<ol>
	<li>This only applies to UserComment tags marked "Unicode".</li>
		<li>Make Exiv write UCS-2 tags, always. Optionally, allow the user to apecify a "UTF-8"-encoding, in case someone really needs it.</li>
		<li>On read, decode the 8-byte charset specifier. If it is Unicode:
	<ol>
	<li>Look at the tag size. If odd, it can't be UCS-2 (as it is a fixed-size, 2-byte ecoding). Decode as UTF-8.</li>
		<li>Look for a zero byte in the text. If one is found, the text can't be UTF-8, as that encoding has no zero bytes, and the UserComment field isn't null-terminated. Decode as UCS-2.</li>
		<li>If no zero bytes, and even tag length - check for any bytes > 0x7f or <= 0x8. If none, decode as UTF-8, as it is likely to be an Ascii comment written as UTF-8. (The limits have been chosen to allow everything from tab to the end of Ascii.)</li>
		<li>Decode as UCS-2.</li>
	</ol></li>
	</ol>


	<p>There will always be corner cases, but right now exiv2 UserComment tags can't be read by any other Exif viewer, so the fact that this hasn't been changed yet tells me that people don't use exiv2 to write UserComment tags all that much. We are therefore trading failure on corner cases of a feature that isn't used all that much against having that feature work <strong>at all</strong> with other programs. I think the trade-off it worth it.</p>


	<p>Additionally:</p>


	<ol>
	<li>A conversion tool that reads UTF-8 and writes UCS-2 could be created.</li>
		<li>Perhaps some parameter could be passed to the parser to force parsing of UserComment as UTF-8 or UCS-2, for the corner cases.</li>
	</ol>


	<p>I'd send a patch, but I'd like to run this past you first to see if there is any interest in accepting such a patch, should I write it, before I go through the work of doing it.</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/127">unicode_support.patch</a>    <span class="size">(11.8 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/127/unicode_support.patch">unicode_support.patch</a>  </td>
  <td></td>
  <td>
      <span class="author">Leo Sutic, 07 Jan 2010 09:52</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/128">exiv2-exifcomment-unicode.patch</a>    <span class="size">(14.8 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/128/exiv2-exifcomment-unicode.patch">exiv2-exifcomment-unicode.patch</a>  </td>
  <td>The patch.</td>
  <td>
      <span class="author">Leo Sutic, 11 Jan 2010 15:09</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/129">exiv2-bug662.jpg</a>    <span class="size">(1.34 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/129/exiv2-bug662.jpg">exiv2-bug662.jpg</a>  </td>
  <td>To be placed in test/data/</td>
  <td>
      <span class="author">Leo Sutic, 11 Jan 2010 15:09</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/130">convert_bug.patch</a>    <span class="size">(1.05 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/130/convert_bug.patch">convert_bug.patch</a>  </td>
  <td></td>
  <td>
      <span class="author">Leo Sutic, 12 Jan 2010 09:40</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/131">exiv2-exifcomment-unicode.patch</a>    <span class="size">(6.64 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/131/exiv2-exifcomment-unicode.patch">exiv2-exifcomment-unicode.patch</a>  </td>
  <td></td>
  <td>
      <span class="author">Leo Sutic, 12 Jan 2010 10:09</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>







<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/662" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="41RynXDn46AC3rNkhJu4gyqjH/P66Dwi4Sebid+KKgwBGdlyAp0voFe6rGg7TLSwFTFLigsLnZgcBwsBnLPNYw==" />
  <table class="list issues odd-even"><tr id="relation-75" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="708" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/708">Bug #708</a>: On Windows, convertStringCharset() should use respective Windows functions</td><td class="status">Closed</td><td class="start_date">28 May 2010</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-48" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="562" /></td><td class="subject" style="width: 50%">Is duplicate of Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/562">Bug #562</a>: Exif.Photo.UserComment unicode comment doesn&#39;t work (Debian bug #486884)</td><td class="status">Closed</td><td class="start_date"></td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/662/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=662&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 1998" href="/projects/exiv2/repository/exiv2/revisions/1998">Revision 1998</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/1998/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="07 Jan 2010 08:55" href="/projects/exiv2/activity?from=2010-01-07">almost 12 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p>Published convertStringCharset() in the API (for <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Incorrect Unicode encoding of Exif UserComment tag (Closed)" href="/issues/662">#662</a>).</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 2000" href="/projects/exiv2/repository/exiv2/revisions/2000">Revision 2000</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/2000/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="12 Jan 2010 06:06" href="/projects/exiv2/activity?from=2010-01-12">almost 12 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Incorrect Unicode encoding of Exif UserComment tag (Closed)" href="/issues/662">#662</a>: Patch exiv2-exifcomment-unicode.patch from Leo Sutic (unmodified, without exiv2-bug662.jpg).</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 2001" href="/projects/exiv2/repository/exiv2/revisions/2001">Revision 2001</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/2001/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="12 Jan 2010 08:29" href="/projects/exiv2/activity?from=2010-01-12">almost 12 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Incorrect Unicode encoding of Exif UserComment tag (Closed)" href="/issues/662">#662</a>: Mostly formatting changes and a few tweaks. Move exifcomment tests to bugfixes-test.sh</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 2002" href="/projects/exiv2/repository/exiv2/revisions/2002">Revision 2002</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/2002/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="12 Jan 2010 09:07" href="/projects/exiv2/activity?from=2010-01-12">almost 12 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Incorrect Unicode encoding of Exif UserComment tag (Closed)" href="/issues/662">#662</a>: Updated expected test results.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 2003" href="/projects/exiv2/repository/exiv2/revisions/2003">Revision 2003</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/2003/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="13 Jan 2010 18:26" href="/projects/exiv2/activity?from=2010-01-13">almost 12 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Incorrect Unicode encoding of Exif UserComment tag (Closed)" href="/issues/662">#662</a>: Fixes by Leo Sutic. Added carriage return to the special characters.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 2005" href="/projects/exiv2/repository/exiv2/revisions/2005">Revision 2005</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/2005/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="14 Jan 2010 08:54" href="/projects/exiv2/activity?from=2010-01-14">almost 12 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Incorrect Unicode encoding of Exif UserComment tag (Closed)" href="/issues/662">#662</a>: Charset conversion on read and write (and if needed on copy).</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 2006" href="/projects/exiv2/repository/exiv2/revisions/2006">Revision 2006</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/2006/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="15 Jan 2010 03:29" href="/projects/exiv2/activity?from=2010-01-15">almost 12 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Incorrect Unicode encoding of Exif UserComment tag (Closed)" href="/issues/662">#662</a>: Added CommentValue::detectCharset and an optional parameter for the encoding to CommentValue::comment().</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 2011" href="/projects/exiv2/repository/exiv2/revisions/2011">Revision 2011</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/2011/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="19 Jan 2010 06:04" href="/projects/exiv2/activity?from=2010-01-19">almost 12 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Incorrect Unicode encoding of Exif UserComment tag (Closed)" href="/issues/662">#662</a>: Code tweak and updated expected test results.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 2013" href="/projects/exiv2/repository/exiv2/revisions/2013">Revision 2013</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/2013/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="20 Jan 2010 04:07" href="/projects/exiv2/activity?from=2010-01-20">almost 12 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Incorrect Unicode encoding of Exif UserComment tag (Closed)" href="/issues/662">#662</a>: Detect and interpret a BOM.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 2027" href="/projects/exiv2/repository/exiv2/revisions/2027">Revision 2027</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/2027/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="12 Feb 2010 07:37" href="/projects/exiv2/activity?from=2010-02-12">almost 12 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Incorrect Unicode encoding of Exif UserComment tag (Closed)" href="/issues/662">#662</a>: Added new option -n and action fixcom to exiv2 utility.</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-1410" class="journal has-notes">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="18 Dec 2009 17:46" href="/projects/exiv2/activity?from=2009-12-18">almost 12 years</a> ago
      <span id="journal-1410-private_notes" class=""></span>
    </h4>

    <div id="journal-1410-notes" class="wiki"><p>Leo,</p>


	<p>Thanks for your thoughts.</p>


<blockquote>

	<p>In the Exif UserComment tag, the characters may be encoded as Ascii, Unicode, JIS or "Undefined".</p>


	<p>This bug concerns the encoding when choosing Unicode encoding.</p>


</blockquote>

	<p>Technically, this is a duplicate of <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Exif.Photo.UserComment unicode comment doesn&#39;t work (Debian bug #486884) (Closed)" href="/issues/562">#562</a>. I'll comment here but we should eventually close this bug as a duplicate.</p>


<blockquote>

	<p>Exiv2 uses UTF-8.</p>


</blockquote>

	<p>Exiv2 actually doesn't do any conversion at all. It just writes the string that the applications/user provides to the field. So it's up to them to do the right thing for now.</p>


<blockquote>

	<p>I would therefore say that it is Exiv2 that is in error here.</p>


</blockquote>

	<p>Yes. Exif UserComment tags with charset set to UNICODE should be encoded in UCS-2.</p>


<blockquote>

	<p>If the Exiv2 team finds this argument valid, we need a short and a long term solution. The short term solution is intended to bridge the gap between now and until all images whose UserComment fields have been written as UTF-8 have been converted to UCS-2. The long term solution is to completely switch to UCS-2.</p>


</blockquote>

	<p>Since we don't have control over what happens to images which have already been modified, we can aim for the long term solution straight away. The concern is that applications which use Exiv2 should continue to function if possible, in particular if they already convert the comments correctly.</p>


<blockquote>

	<ol>
	<li>This only applies to UserComment tags marked "Unicode".</li>
		<li>Make Exiv write UCS-2 tags, always.</li>
	</ol>


</blockquote>

	<p>Ok. Note that there is some existing code to convert between UCS-2 and UTF-8, used for certain Windows XP tags. There is also code used to convert between XMP and IPTC datasets, which detects a charset and converts to UTF-8 (<a class="changeset" title="#571: Detect charset and convert to UTF-8 when converting IPTC to XMP; set Iptc.Envelope.Characte..." href="/projects/exiv2/repository/exiv2/revisions/1908">r1908</a>). Aim to reuse existing code and generalize where needed.</p>


<blockquote>

	<p>Optionally, allow the user to apecify a "UTF-8"-encoding, in case someone really needs it.</p>


</blockquote>

	<p>Not desirable. Instead provide backward compatibility similar to what was done for <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Need to convert character set when writing XMP sidecar (Closed)" href="/issues/571">#571</a> with <a class="changeset" title="#571: Detect charset and convert to UTF-8 when converting IPTC to XMP; set Iptc.Envelope.Characte..." href="/projects/exiv2/repository/exiv2/revisions/1908">r1908</a>.</p>


<blockquote>

	<ol>
	<li>On read, decode the 8-byte charset specifier. If it is Unicode:
	<ol>
	<li>Look at the tag size. If odd, it can't be UCS-2 (as it is a fixed-size, 2-byte ecoding). Decode as UTF-8.</li>
		<li>Look for a zero byte in the text. If one is found, the text can't be UTF-8, as that encoding has no zero bytes, and the UserComment field isn't null-terminated. Decode as UCS-2.</li>
		<li>If no zero bytes, and even tag length - check for any bytes > 0x7f or <= 0x8. If none, decode as UTF-8, as it is likely to be an Ascii comment written as UTF-8. (The limits have been chosen to allow everything from tab to the end of Ascii.)</li>
		<li>Decode as UCS-2.</li>
	</ol></li>
	</ol>


</blockquote>

	<p>Consider something similar to what Exiftool does. It writes the UserComment tag with an Exif character code<br />"ASCII" if the text consists of only 7-bit characters, else it uses the Exif<br />character code "UNICODE" and encodes the text in UTF-16.<br />It encodes the UTF-16 string using the same byte order as the rest of the<br />Exif/TIFF structure and without a BOM.<br />On read it expects a UTF-16 encoded text, has some intelligence to guess the<br />byte order, and interprets a BOM if there is one. It doesn't seems to have any<br />provision for UTF-8 encoded UserComment text.</p>


	<p>The proposed logic based on size and existence of 0-bytes in the comment will fail in many cases because some cameras write 0-byte (sometimes other characters) as fillers to this field, presumably so that it can be modified later without having to re-write the complete TIFF structure.</p>


<blockquote>

	<p>I'd send a patch, [...]</p>


</blockquote>

	<p>Please do :) I'll be happy to discuss further and comment as the work progresses.</p>


	<p>Andreas</p></div>
    </div>
  </div>
  
  <div id="change-1411" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="18 Dec 2009 18:21" href="/projects/exiv2/activity?from=2009-12-18">almost 12 years</a> ago
      <span id="journal-1411-private_notes" class=""></span>
    </h4>

    <div id="journal-1411-notes" class="wiki"><a name="Related-info"></a>
<h3 >Related info<a href="#Related-info" class="wiki-anchor">&para;</a></h3>


	<ul>
	<li>General remarks about the lack of Exiv2 characterset conversions<br /><a class="external" href="http://dev.exiv2.org/boards/3/topics/show/220#message-221">http://dev.exiv2.org/boards/3/topics/show/220#message-221</a><br /><a class="external" href="http://dev.exiv2.org/boards/3/topics/show/62#message-66">http://dev.exiv2.org/boards/3/topics/show/62#message-66</a></li>
	</ul>


	<ul>
	<li>The <a href="http://www.metadataworkinggroup.com" class="external">Metadata Working Group</a> has published a <a href="http://www.metadataworkinggroup.com/pdf/mwg_guidance.pdf" class="external">technical specification</a> with useful information on the topic.</li>
	</ul>


	<ul>
	<li>Bugs <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Exif.Photo.UserComment unicode comment doesn&#39;t work (Debian bug #486884) (Closed)" href="/issues/562">#562</a>, <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: exiv2: Exif.Photo.UserComment unicode comment doesn&#39;t work (Closed)" href="/issues/592">#592</a>: Exif.Photo.UserComment unicode comment doesn't work (Debian bug #486884). Exiv2 should decode to and from UTF-16 / UCS-2.</li>
	</ul>


	<ul>
	<li><a href="https://bugs.kde.org/show_bug.cgi?id=205824#c8" class="external">Exiv2 vs Exiftool handling of Exif UNICODE user comments</a></li>
	</ul>


	<ul>
	<li>Bug <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Need to convert character set when writing XMP sidecar (Closed)" href="/issues/571">#571</a>: Convert character set when writing XMP sidecar. Adds UTF-8 charset detection logic and charset conversion to Exiv2</li>
	</ul>


	<ul>
	<li><a href="http://www.cpanforum.com/threads/2114" class="external">Using UTF-8 (and other character sets) in IPTC datasets</a></li>
	</ul></div>
    </div>
  </div>
  
  <div id="change-1412" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="18 Dec 2009 19:09" href="/projects/exiv2/activity?from=2009-12-18">almost 12 years</a> ago
      <span id="journal-1412-private_notes" class=""></span>
    </h4>

    <div id="journal-1412-notes" class="wiki"><p>Hi Andreas,</p>


	<p>having had a brief look at the code, it seems like CommentValue::read(const std::string&#38; comment) is the place to put the modification in. Since the method reads an ASCII string (and I suspect the signature of the read function is fixed - no way to make it take a std::wstring), I suggest we simply let unicode escapes be passed into the function and decode them there to UCS-2 characters.</p>


	<p>So you can have:</p>
	<pre><code>exifData["Exif.Photo.UserComment"] = "charset=\"Unicode\" \\u1f8f is a Greek Character"</code></pre>


	<p>Note that we escape the backslash, as the decoding of the \u1f8f sequence is done in CommentValue::read.</p>


	<p>This would make it easy to specify any Unicode character (Including linebreaks) on command lines, and in command files without having to worry about encoding issues there.</p>


	<p>How does the above sound to you? Did I understand things correctly that the std::string passed to CommentValue::read is a byte-string (char)? Or can it be a wchar_t string?</p></div>
    </div>
  </div>
  
  <div id="change-1413" class="journal has-notes">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="18 Dec 2009 22:53" href="/projects/exiv2/activity?from=2009-12-18">almost 12 years</a> ago
      <span id="journal-1413-private_notes" class=""></span>
    </h4>

    <div id="journal-1413-notes" class="wiki"><blockquote>

	<p>How does the above sound to you? Did I understand things correctly that the std::string passed to CommentValue::read is a byte-string (char)? Or can it be a wchar_t string?</p>


</blockquote>

	<p>Yes, only a simple char_t string is supposed to be used.</p>


	<p>And yes, CommentValue, is the class that requires modifications.</p>


	<p>Conceptually, I think we should follow <a href="http://dev.exiv2.org/boards/3/topics/show/220" class="external">Vladimir's suggestion</a> and internally maintain the comment in UTF-8.</p>


	<p>CommentValue::read(const std::string &#38;buf) can make an attempt to translate whatever data it receives to UTF-8 (can it?) and store that in CommentValue. That function is used to set strings passed by the application/user, as in your example above, so we would expect the input to be Ascii or UTF-8 encoded text (or Windows Latin, I'm not familiar with that), i.e., nothing to do here in the first round.<br />The other read method, CommentValue::read (const byte *buf, long len, ByteOrder byteOrder) is used to read the comment value from the binary data stored in the Exif tag, i.e., we would expect the input to be in UCS-2 for charset=Unicode comments. It can make an attempt to verify that assumption and make a better decision if necessary, and in any case, convert the value to UTF-8, using the byte order passed in.</p>


	<p>CommentValue::write and CommentValue::comment then output the UTF-8 value, that's straightforward. Finally, CommentValue::copy should output the correctly encoded data, depending on the charset indicated in the CommentValue and the byte order. I.e., for charset=Unicode, it should encode the string to UCS-2. And for everything to work as expected, size() and count() both will need to return the number of bytes in the output of copy().</p>


	<p>With this, I suspect it is no longer practical to derive CommentValue from StringValueBase (even though it will still use an std::string value_), it may be better to derive it from Value directly now.</p></div>
    </div>
  </div>
  
  <div id="change-1414" class="journal has-details">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="19 Dec 2009 03:21" href="/projects/exiv2/activity?from=2009-12-19">almost 12 years</a> ago
      <span id="journal-1414-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Target version</strong> deleted (<del><i>0.18.2</i></del>)</li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-1415" class="journal has-notes">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="19 Dec 2009 03:35" href="/projects/exiv2/activity?from=2009-12-19">almost 12 years</a> ago
      <span id="journal-1415-private_notes" class=""></span>
    </h4>

    <div id="journal-1415-notes" class="wiki"><p>Yes, Vladimir's suggestion makes sense.</p>


	<p>I still think we should derive it from StringValueBase. The UserComment is basically a string value with an encoding for serialization attached.</p>


	<p>Since read() is used both for user input as well as application "input", I'll have to think it over. We need one way to accept already UTF8 encoded strings, and one for user input with Unicode escape sequences.</p>


	<p>I am thinking about letting read() only accept UTF8 strings, and put the escape sequence decoding ahead of that. Maybe in the command line parser.</p></div>
    </div>
  </div>
  
  <div id="change-1416" class="journal has-notes">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="19 Dec 2009 03:51" href="/projects/exiv2/activity?from=2009-12-19">almost 12 years</a> ago
      <span id="journal-1416-private_notes" class=""></span>
    </h4>

    <div id="journal-1416-notes" class="wiki"><blockquote>

	<p>I still think we should derive it from StringValueBase. The UserComment is basically a string value with an encoding for serialization attached.</p>


</blockquote>

	<p>No problem if it's still possible.</p>


<blockquote>

	<p>I am thinking about letting read() only accept UTF8 strings, and put the escape sequence decoding ahead of that. Maybe in the command line parser.</p>


</blockquote>

	<p>I like that better too. It's not something the library needs to provide.</p></div>
    </div>
  </div>
  
  <div id="change-1417" class="journal has-notes">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="19 Dec 2009 04:38" href="/projects/exiv2/activity?from=2009-12-19">almost 12 years</a> ago
      <span id="journal-1417-private_notes" class=""></span>
    </h4>

    <div id="journal-1417-notes" class="wiki"><blockquote><blockquote>

	<p>I am thinking about letting read() only accept UTF8 strings, and put the escape sequence decoding ahead of that. Maybe in the command line parser.</p>


</blockquote>

	<p>I like that better too. It's not something the library needs to provide.</p>


</blockquote>

	<p>It is also dangerous, since if the application reads the UserComment, and then sets it to the same value that was read, there is a second decoding of unicode escapes.</p>


	<p>I think this decoding of unicode escapes can be useful for all values on the command line. How about inserting it after line 1084 of exiv.cpp, at the end of parseLine? That way, we ensure that when the command line is parsed, <strong>all</strong> values are UTF-8. So the spec is: <strong>The command line and all command files are to be in Ascii with Unicode escapes ("\uXXXX"). They are parsed into UTF8 for internal use.</strong> It means that the CLI interface is firmed up a bit, but on the upside the results will be more predictable.</p></div>
    </div>
  </div>
  
  <div id="change-1418" class="journal has-notes">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="19 Dec 2009 22:43" href="/projects/exiv2/activity?from=2009-12-19">almost 12 years</a> ago
      <span id="journal-1418-private_notes" class=""></span>
    </h4>

    <div id="journal-1418-notes" class="wiki"><blockquote>

	<p>I think this decoding of unicode escapes can be useful for all values on the command line. How about inserting it after line 1084 of exiv.cpp, at the end of parseLine?</p>


</blockquote>

	<p>Yes, that's where it should go. Other things can also be done there once we have an escape character (like newlines and escaped quotes). But that's all secondary right now.</p>


<blockquote>

	<p>So the spec is: *The command line and all command files are to be in Ascii with Unicode escapes ("uXXXX").</p>


</blockquote>

	<p>What if my input is already UTF-8? Many people have set their terminals to use UTF-8 character encoding. They will ecpect things to "just work" without escaping anything.</p>


	<p>Anyway, let's concentrate on the library changes, i.e., CommentValue first. For that all we need to do is specify that the input of CommentValue::read(const std::string &#38;buf) is in UTF-8.</p></div>
    </div>
  </div>
  
  <div id="change-1421" class="journal has-notes">
    <div id="note-10">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-10" class="journal-link">#10</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="21 Dec 2009 08:27" href="/projects/exiv2/activity?from=2009-12-21">almost 12 years</a> ago
      <span id="journal-1421-private_notes" class=""></span>
    </h4>

    <div id="journal-1421-notes" class="wiki"><p>Andreas Huggel wrote:</p>


<blockquote><blockquote>

	<p>I think this decoding of unicode escapes can be useful for all values on the command line. How about inserting it after line 1084 of exiv.cpp, at the end of parseLine?</p>


</blockquote>

	<p>Yes, that's where it should go. Other things can also be done there once we have an escape character (like newlines and escaped quotes). But that's all secondary right now.</p>


<blockquote>

	<p>So the spec is: *The command line and all command files are to be in Ascii with Unicode escapes ("uXXXX").</p>


</blockquote>

	<p>What if my input is already UTF-8? Many people have set their terminals to use UTF-8 character encoding. They will ecpect things to "just work" without escaping anything.</p>


</blockquote>

	<p>If the input is UTF-8 and it contains Unicode escapes, those escapes will be interpreted as such. So if someone wants to insert the literal text "\u1234", then they <strong>must</strong> escape the backslash ("\\u1234"). I don't think there is any good way to get around that. Maybe strings with Unicode escapes should be a different data type, but I think this is an interface change that is worth it. Having a uniform way to input strings is needed and should be the default.</p>


	<p>How about this rule: Interpret Unicode escapes, but just copy everything else? That way, Ascii with escapes will give the expected result, and UTF-8 with escapes will, too, as the backslash is a single-byte UTF-8 character and will not be mistaken for a component of a UTF-8 multibyte character (all components have the highest bit set, and '\\' == 0x5c).</p>


	<p>I'll have a quick go at this later this evening, but I leave for the holidays and will be back on the January 6, 2010.</p>


	<p>I think we have the whole thing pretty much figured out, though.</p></div>
    </div>
  </div>
  
  <div id="change-1422" class="journal has-notes">
    <div id="note-11">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-11" class="journal-link">#11</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="21 Dec 2009 09:01" href="/projects/exiv2/activity?from=2009-12-21">almost 12 years</a> ago
      <span id="journal-1422-private_notes" class=""></span>
    </h4>

    <div id="journal-1422-notes" class="wiki"><p>I am having trouble compiling.</p>


	<p>I got Cmake to Configure everything (I think, this is my first time using CMake):</p>
	<pre><code>&gt;C:/PROGRA~2/MinGW/bin/mingw32-make.exe<br /> ================&gt; ICONV_LIBRARIES :<br /> -- None:<br /> -- Debug:             <del>g<br /> -</del> Release:           <del>O3 -DNDEBUG<br /> -</del> RelWithDebInfo:    <del>O2 -g<br /> -</del> MinSizeRel:        <del>Os -DNDEBUG<br /> -</del> -------------------------------------------------------------<br /> -- Building PNG support:            NO<br /> -- Building shared library:         NO<br /> -- XMP metadata support:            NO<br /> -- Building static libxmp:          NO<br /> -- Native language support:         NO<br /> -- Conversion of Windows XP tags:   YES<br /> -- Nikon lens database:             NO<br /> -- commercial build:                NO<br /> -- -------------------------------------------------------------<br /> ----------------&gt; ICONV_LIBRARIES :<br /> -- Configuring done<br /> -- Generating done<br /> -- Build files have been written to: C:/Users/leo/Documents/Development/Exiv/final<br /> [  1%] Building CXX object src/CMakeFiles/exiv2.dir/convert.cpp.obj<br /> C:\Users\leo\Documents\Development\Exiv\exiv2\src\convert.cpp:53:20: iconv.h: No such file or directory<br /> (...)<br /> mingw32-make.exe[2]: <b>* [src/CMakeFiles/exiv2.dir/convert.cpp.obj] Error 1<br /> mingw32-make.exe[1]: <strong></b> [src/CMakeFiles/exiv2.dir/all] Error 2<br /> mingw32-make.exe: *</strong>* [all] Error 2</code></pre>


	<p>So basically, the compiler can't find iconv.h. I have set ICONV_INCLUDE_DIR in CMake.</p>


	<p>If I look in src\CMakeFiles\exiv2.dir\flags.make, I see:</p>
	<pre><code>CXX_FLAGS = -IC:\Users\leo\Documents\Development\Exiv\final -IC:\Users\leo\Documents\Development\Exiv\exiv2\xmpsdk\include -Wall -Wcast-align -Wpointer-arith -Wformat-security  -Wmissing-format-attribute -Woverloaded-virtual -W</code></pre>


	<p>...and it seems to me that the ICONV_INCLUDE_DIR i have specified should be in there somewhere.</p></div>
    </div>
  </div>
  
  <div id="change-1423" class="journal has-notes">
    <div id="note-12">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-12" class="journal-link">#12</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="21 Dec 2009 16:33" href="/projects/exiv2/activity?from=2009-12-21">almost 12 years</a> ago
      <span id="journal-1423-private_notes" class=""></span>
    </h4>

    <div id="journal-1423-notes" class="wiki"><blockquote>

	<p>How about this rule: Interpret Unicode escapes, but just copy everything else? That way, Ascii with escapes will give the expected result, and UTF-8 with escapes will, too, as the backslash is a single-byte UTF-8 character and will not be mistaken for a component of a UTF-8 multibyte character (all components have the highest bit set, and '\' == 0x5c).</p>


</blockquote>

	<p>ok</p></div>
    </div>
  </div>
  
  <div id="change-1424" class="journal has-notes">
    <div id="note-13">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-13" class="journal-link">#13</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="21 Dec 2009 16:43" href="/projects/exiv2/activity?from=2009-12-21">almost 12 years</a> ago
      <span id="journal-1424-private_notes" class=""></span>
    </h4>

    <div id="journal-1424-notes" class="wiki"><blockquote>

	<p>I am having trouble compiling.</p>


	<p>I got Cmake to Configure everything (I think, this is my first time using CMake):<br />[...]</p>


</blockquote>

	<p>Oops, that was not intended to be a trap. CMake is still a highly experimental feature and not well tested (I will exclude it from the upcoming release). While it's interesting to see it in action, it requires work. I recommend you don't bother and use the good old configuration files. Essentially "make config; ./configure; make". See the README for details and how to configure it for iconv. I have that working here on MinGW/MSYS (although not used recently).</p>


	<p>Have a good holiday!</p></div>
    </div>
  </div>
  
  <div id="change-1492" class="journal has-notes">
    <div id="note-14">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-14" class="journal-link">#14</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="07 Jan 2010 07:57" href="/projects/exiv2/activity?from=2010-01-07">almost 12 years</a> ago
      <span id="journal-1492-private_notes" class=""></span>
    </h4>

    <div id="journal-1492-notes" class="wiki"><p>Ok, I'm back.</p>


	<p>I have written the escape-sequence decoder now. It works by first converting everything to UCS-2, and then using iconv to convert that to UTF-8. For laziness I used the <code>convertStringCharset</code> function from convert.cpp. It is very useful. Could we move it to Util.cpp/hpp?</p></div>
    </div>
  </div>
  
  <div id="change-1493" class="journal has-notes">
    <div id="note-15">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-15" class="journal-link">#15</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="07 Jan 2010 09:00" href="/projects/exiv2/activity?from=2010-01-07">almost 12 years</a> ago
      <span id="journal-1493-private_notes" class=""></span>
    </h4>

    <div id="journal-1493-notes" class="wiki"><p>hi!</p>


	<p>With <a class="changeset" title="Published convertStringCharset() in the API (for #662)." href="/projects/exiv2/repository/exiv2/revisions/1998">r1998</a> the function is now part of the API, declared in convert.hpp for want of a better place for now (utils.cpp is not part of the library, it's only used by the exiv2 utility.)</p></div>
    </div>
  </div>
  
  <div id="change-1494" class="journal has-notes has-details">
    <div id="note-16">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-16" class="journal-link">#16</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="07 Jan 2010 09:52" href="/projects/exiv2/activity?from=2010-01-07">almost 12 years</a> ago
      <span id="journal-1494-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/127">unicode_support.patch</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/127/unicode_support.patch">unicode_support.patch</a> added</li>
    </ul>
    <div id="journal-1494-notes" class="wiki"><p>Here's the first attempt. Can you tell me how it works for you?</p>


	<p>I had to modify convert.cpp to count the number of output bytes when converting to UCS-2, due to zero-bytes in the output.</p></div>
    </div>
  </div>
  
  <div id="change-1495" class="journal has-notes">
    <div id="note-17">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-17" class="journal-link">#17</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="11 Jan 2010 02:15" href="/projects/exiv2/activity?from=2010-01-11">almost 12 years</a> ago
      <span id="journal-1495-private_notes" class=""></span>
    </h4>

    <div id="journal-1495-notes" class="wiki"><p>Thanks! I finally had a look at it. I have only reviewed the code, not tested it. Some comments:</p>


	<ul>
	<li>Please use StringValueBase::value_ instead of a second string CommentValue::_comment (it is public), so we don't have 2 strings for essentially the same thing.</li>
		<li>In CommentValue::read(const byte* buf, long len, ByteOrder byteOrder): a conversion is only required if charsetId_  unicode (ignoring whatever conversion would be needed for "jis")</li>
		<li>CommentValue::encode(ByteOrder byteOrder): Similarly, only needed if charsetId_  unicode. The first 8 bytes are the charset identifier according to the Exif specs, that part is never converted to UCS-2.</li>
		<li>Style: Please change "this-><em>charsetId" to "charsetId</em>" to be consistent with the existing code.</li>
		<li>parseEscape: The conversion of the input to UCS-2 implies that the input is in ASCII. But as discussed, it may also be UTF-8 encoded. Instead, I prefer to require (and assume) that the input is in UTF-8 and simply insert the escaped characters into the string, according to <a href="http://dev.exiv2.org/issues/show/662#note-12" class="external">your rule above</a></li>
	</ul></div>
    </div>
  </div>
  
  <div id="change-1496" class="journal has-notes">
    <div id="note-18">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-18" class="journal-link">#18</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="11 Jan 2010 03:30" href="/projects/exiv2/activity?from=2010-01-11">almost 12 years</a> ago
      <span id="journal-1496-private_notes" class=""></span>
    </h4>

    <div id="journal-1496-notes" class="wiki"><p>Some comments on your comments:</p>


	<ol>
	<li>The difference between value_ and <em>comment (which should be comment</em>) is that value_ contains the charset specifier (charset="...") given by the user. Should this be dropped and only the actual comment value be stored?</li>
		<li>Ok</li>
		<li>Ok</li>
		<li>Ok</li>
		<li>Ok, that one was embarrassing... will fix.</li>
	</ol></div>
    </div>
  </div>
  
  <div id="change-1497" class="journal has-notes">
    <div id="note-19">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-19" class="journal-link">#19</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="11 Jan 2010 04:49" href="/projects/exiv2/activity?from=2010-01-11">almost 12 years</a> ago
      <span id="journal-1497-private_notes" class=""></span>
    </h4>

    <div id="journal-1497-notes" class="wiki"><blockquote>

	<ol>
	<li>The difference between value_ and <em>comment (which should be comment</em>) is that value_ contains the charset specifier (charset="...") given by the user. Should this be dropped and only the actual comment value be stored?</li>
	</ol>


</blockquote>

	<p>Since you introduced CommentValue::charsetId_ I was under the impression this now replaces that charset specifier in the comment itself. Either way is fine with me, but we should avoid maintaining the information redundantly, esp since the members of these value classes are public.</p></div>
    </div>
  </div>
  
  <div id="change-1498" class="journal has-notes">
    <div id="note-20">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-20" class="journal-link">#20</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="11 Jan 2010 07:54" href="/projects/exiv2/activity?from=2010-01-11">almost 12 years</a> ago
      <span id="journal-1498-private_notes" class=""></span>
    </h4>

    <div id="journal-1498-notes" class="wiki"><p>I thought I'd fix all the character conversions while I was at it - in particular, convert JIS to UTF8 and UTF8 to JIS on read/copy. Do you know which character encoding to use for JIS? The Exif 2.2 spec mentions JIS X 208-1990, but that is only a character set and not a specific encoding of characters into bytes. I don't think it is a problem if we just leave it untranslated, but it would be nice to get the three major character encodings (Ascii, Unicode and JIS) sorted in one big go.</p></div>
    </div>
  </div>
  
  <div id="change-1499" class="journal has-notes">
    <div id="note-21">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-21" class="journal-link">#21</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="11 Jan 2010 14:06" href="/projects/exiv2/activity?from=2010-01-11">almost 12 years</a> ago
      <span id="journal-1499-private_notes" class=""></span>
    </h4>

    <div id="journal-1499-notes" class="wiki"><p>I am about to write testcases for the comment handling. I tried running the existing tests by cd'ing into test/ and running "make". That produced a lot of errors. Is this a known issue, or have I just broken exiv2?</p></div>
    </div>
  </div>
  
  <div id="change-1500" class="journal has-notes has-details">
    <div id="note-22">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-22" class="journal-link">#22</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="11 Jan 2010 15:09" href="/projects/exiv2/activity?from=2010-01-11">almost 12 years</a> ago
      <span id="journal-1500-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/128">exiv2-exifcomment-unicode.patch</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/128/exiv2-exifcomment-unicode.patch">exiv2-exifcomment-unicode.patch</a> added</li>
       <li><strong>File</strong> <a href="/attachments/129">exiv2-bug662.jpg</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/129/exiv2-bug662.jpg">exiv2-bug662.jpg</a> added</li>
    </ul>
    <div id="journal-1500-notes" class="wiki"><p>Second attempt.</p></div>
    </div>
  </div>
  
  <div id="change-1501" class="journal has-notes">
    <div id="note-23">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-23" class="journal-link">#23</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="11 Jan 2010 22:44" href="/projects/exiv2/activity?from=2010-01-11">almost 12 years</a> ago
      <span id="journal-1501-private_notes" class=""></span>
    </h4>

    <div id="journal-1501-notes" class="wiki"><p>Leo Sutic wrote:</p>


<blockquote>

	<p>I am about to write testcases for the comment handling.</p>


</blockquote>

	<p>Good. That's commendable.</p>


<blockquote>

	<p>I tried running the existing tests by cd'ing into test/ and running "make". That produced a lot of errors. Is this a known issue, or have I just broken exiv2?</p>


</blockquote>

	<p>They all pass here with <a class="changeset" title="#665: Quick-fix for the exiv2 utility to allow inserting Exif data into ORF files." href="/projects/exiv2/repository/exiv2/revisions/1999">r1999</a>. You need to make; make install; make samples before cd test; make<br />I hope a few tests will still fail after this though, even if your stuff now works perfectly :) Would mean that they are useful, after all you changed the way the CommentValue interface works.</p>


	<ul>
	<li>Instead of running all the tests in one go, you can run each script individually</li>
		<li>Once you have validated that the reported differences are as expected based on your changes, simply copy the output from the test script in the tmp/ directory to the data/ directory (i.e., update the expected output)</li>
		<li>Consider adding your test cases to bugfixes-test.sh</li>
	</ul></div>
    </div>
  </div>
  
  <div id="change-1502" class="journal has-notes">
    <div id="note-24">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-24" class="journal-link">#24</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="11 Jan 2010 23:02" href="/projects/exiv2/activity?from=2010-01-11">almost 12 years</a> ago
      <span id="journal-1502-private_notes" class=""></span>
    </h4>

    <div id="journal-1502-notes" class="wiki"><blockquote>

	<ul>
	<li>Consider adding your test cases to bugfixes-test.sh</li>
	</ul>


</blockquote>

	<p>Oh you already wrote your own test script. That's fine too, of course.</p></div>
    </div>
  </div>
  
  <div id="change-1503" class="journal has-notes">
    <div id="note-25">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-25" class="journal-link">#25</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="12 Jan 2010 08:27" href="/projects/exiv2/activity?from=2010-01-12">almost 12 years</a> ago
      <span id="journal-1503-private_notes" class=""></span>
    </h4>

    <div id="journal-1503-notes" class="wiki"><p>I'm stuck at conversions.sh, testcase 6. I have the file m.xmp, containing:</p>


<pre>
&lt;rdf:li xml:lang="x-default"&gt;This is a JIS encoded Exif user comment. Or was it?&lt;/rdf:li&gt;
</pre>

	<p>But when I do <code>exiv2 -PEkyct tmp/m.xmp</code> I get:</p>


<pre>
Exif.Photo.UserComment                       Undefined 208  (Binary value suppressed)
</pre>

	<p>So the comment value has suddenly balooned to 208 bytes (from 59). Doing a hexdump of it with <code>exiv2 -PEkych tmp/m.xmp</code>:</p>


<pre>
Exif.Photo.UserComment                       Undefined 208
  0000  55 4e 49 43 4f 44 45 00 00 54 00 68 00 69 00 73  UNICODE..T.h.i.s
  0010  00 20 00 69 00 73 00 20 00 61 00 20 00 4a 00 49  . .i.s. .a. .J.I
  0020  00 53 00 20 00 65 00 6e 00 63 00 6f 00 64 00 65  .S. .e.n.c.o.d.e
  0030  00 64 00 20 00 45 00 78 00 69 00 66 00 20 00 75  .d. .E.x.i.f. .u
  0040  00 73 00 65 00 72 00 20 00 63 00 6f 00 6d 00 6d  .s.e.r. .c.o.m.m
  0050  00 65 00 6e 00 74 00 2e 00 20 00 4f 00 72 00 20  .e.n.t... .O.r.
  0060  00 77 00 61 00 73 00 20 00 69 00 74 00 3f 00 69  .w.a.s. .i.t.?.i
  0070  00 73 00 20 00 69 00 73 00 20 00 61 00 20 00 4a  .s. .i.s. .a. .J
  0080  00 49 00 53 00 20 00 65 00 6e 00 63 00 6f 00 64  .I.S. .e.n.c.o.d
  0090  00 65 00 64 00 20 00 45 00 78 00 69 00 66 00 20  .e.d. .E.x.i.f.
  00a0  00 75 00 73 00 65 00 72 00 20 00 63 00 6f 00 6d  .u.s.e.r. .c.o.m
  00b0  00 6d 00 65 00 6e 00 74 00 2e 00 20 00 4f 00 72  .m.e.n.t... .O.r
  00c0  00 20 00 77 00 61 00 73 00 20 00 69 00 00 00 00  . .w.a.s. .i....
</pre>

	<p>That is, it looks like some kind of buffer overflow. I've tried to trace the path of the comment data through the code, but am completely stuck.</p></div>
    </div>
  </div>
  
  <div id="change-1504" class="journal has-notes">
    <div id="note-26">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-26" class="journal-link">#26</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="12 Jan 2010 09:19" href="/projects/exiv2/activity?from=2010-01-12">almost 12 years</a> ago
      <span id="journal-1504-private_notes" class=""></span>
    </h4>

    <div id="journal-1504-notes" class="wiki"><p>If it's an overflow, valgrind usually says useful things. The conversion from XMP to Exif is in convert.cpp, Converter::cnvXmpComment, if I'm not mistaken.</p>


	<p>In the meantime I've checked-in your 2nd patch and subsequently modified it a bit. Please have a look at the related revisions and svn update.</p>


	<p>Besides the issues with the conversion tests there is one left in bugfixes-test: If we write to an image with an existing comment shorter than 8 bytes (i.e., an invalid user comment), this "fixes" the comment in passing. I don't quite like that, but we can leave it for the moment. It's late here now, I'm signing off.</p></div>
    </div>
  </div>
  
  <div id="change-1505" class="journal has-notes">
    <div id="note-27">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-27" class="journal-link">#27</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="12 Jan 2010 09:22" href="/projects/exiv2/activity?from=2010-01-12">almost 12 years</a> ago
      <span id="journal-1505-private_notes" class=""></span>
    </h4>

    <div id="journal-1505-notes" class="wiki"><p>I get everything to work expect the bugfixes-test.sh script.</p>


	<p>It produces a 62428 byte output file. The correct file (data/bugfixes-test.out) is 7477 bytes.</p>


	<p>Help.</p></div>
    </div>
  </div>
  
  <div id="change-1506" class="journal has-notes">
    <div id="note-28">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-28" class="journal-link">#28</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="12 Jan 2010 09:31" href="/projects/exiv2/activity?from=2010-01-12">almost 12 years</a> ago
      <span id="journal-1506-private_notes" class=""></span>
    </h4>

    <div id="journal-1506-notes" class="wiki"><p>Strange, why is your data/bugfixes-test.out so small? Mine is and always was much larger:</p>


<pre>
andreas@mowgli:~/src/exiv2/trunk/test/data$ svn up -r1999
U    bugfixes-test.out
Updated to revision 1999.
andreas@mowgli:~/src/exiv2/trunk/test/data$ ls -la bugfixes-test.out
-rw-r--r-- 1 andreas andreas 62428 13-Jan-10 bugfixes-test.out
andreas@mowgli:~/src/exiv2/trunk/test/data$ svn up
U    bugfixes-test.out
Updated to revision 2002.
andreas@mowgli:~/src/exiv2/trunk/test/data$ ls -la bugfixes-test.out
-rw-r--r-- 1 andreas andreas 64491 13-Jan-10 bugfixes-test.out
</pre></div>
    </div>
  </div>
  
  <div id="change-1507" class="journal has-notes">
    <div id="note-29">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-29" class="journal-link">#29</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="12 Jan 2010 09:34" href="/projects/exiv2/activity?from=2010-01-12">almost 12 years</a> ago
      <span id="journal-1507-private_notes" class=""></span>
    </h4>

    <div id="journal-1507-notes" class="wiki"><p>And this is the output that I get, related to the issue mentioned above:</p>


<pre>
andreas@mowgli:~/src/exiv2/trunk/test$ ./bugfixes-test.sh
Files ./tmp/bugfixes-test.out-stripped and ./data/bugfixes-test.out differ
55c55
&lt; Exif.Photo.UserComment                       Undefined   8
---
&gt; Exif.Photo.UserComment                       Undefined   1
</pre></div>
    </div>
  </div>
  
  <div id="change-1508" class="journal has-notes has-details">
    <div id="note-30">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-30" class="journal-link">#30</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="12 Jan 2010 09:40" href="/projects/exiv2/activity?from=2010-01-12">almost 12 years</a> ago
      <span id="journal-1508-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/130">convert_bug.patch</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/130/convert_bug.patch">convert_bug.patch</a> added</li>
    </ul>
    <div id="journal-1508-notes" class="wiki"><p>Andreas Huggel wrote:</p>


<blockquote>

	<p>If it's an overflow, valgrind usually says useful things. The conversion from XMP to Exif is in convert.cpp, Converter::cnvXmpComment, if I'm not mistaken.</p>


	<p>In the meantime I've checked-in your 2nd patch</p>


</blockquote>

	<p>There are some serious bugs in that one (in convertStringCharset in particular - the line where I do outstr.append I use outbytesProduced, which is the cumulative number of output bytes produced, but I should only use the number of bytes produced in this particular call to iconv). Apply this patch to fix.</p></div>
    </div>
  </div>
  
  <div id="change-1509" class="journal has-notes">
    <div id="note-31">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-31" class="journal-link">#31</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="12 Jan 2010 09:41" href="/projects/exiv2/activity?from=2010-01-12">almost 12 years</a> ago
      <span id="journal-1509-private_notes" class=""></span>
    </h4>

    <div id="journal-1509-notes" class="wiki"><p>Andreas Huggel wrote:</p>


<blockquote>

	<p>And this is the output that I get, related to the issue mentioned above:</p>


	<p>[...]</p>


</blockquote>

	<p>Yes, since the size of the comment is now 8 bytes (character encoding) plus nothing more, you get 8 bytes for an empty comment.</p></div>
    </div>
  </div>
  
  <div id="change-1510" class="journal has-notes has-details">
    <div id="note-32">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-32" class="journal-link">#32</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="12 Jan 2010 10:09" href="/projects/exiv2/activity?from=2010-01-12">almost 12 years</a> ago
      <span id="journal-1510-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/131">exiv2-exifcomment-unicode.patch</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/131/exiv2-exifcomment-unicode.patch">exiv2-exifcomment-unicode.patch</a> added</li>
    </ul>
    <div id="journal-1510-notes" class="wiki"><p>Ok, third (and hopefully final) patch.</p>


	<p>This includes the convertStringCharset patch, and fixes printing of comment values (changes to tags.cpp). It passes all except exiv2-test.sh here. I really don't know what is happening. I get crazy errors like:</p>


<pre>
Files ./tmp/exiv2-test.out and ./data/exiv2-test.out differ
217d216
&lt; exiv2-empty.jpg: No Exif data found in the file
219a219
&gt; exiv2-empty.jpg: No Exif data found in the file
</pre>

	<p>Can you apply the patch and see if the tests work for you?</p></div>
    </div>
  </div>
  
  <div id="change-1511" class="journal has-notes">
    <div id="note-33">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-33" class="journal-link">#33</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="12 Jan 2010 22:23" href="/projects/exiv2/activity?from=2010-01-12">almost 12 years</a> ago
      <span id="journal-1511-private_notes" class=""></span>
    </h4>

    <div id="journal-1511-notes" class="wiki"><p>Leo Sutic wrote:</p>


<blockquote>

	<p>Ok, third (and hopefully final) patch.</p>


</blockquote>

	<p>Looks good, thanks :)</p>


<blockquote>

	<p>This includes the convertStringCharset patch, and fixes printing of comment values (changes to tags.cpp). It passes all except exiv2-test.sh here. I really don't know what is happening. I get crazy errors like:</p>


	<p>[...]</p>


</blockquote>

	<p>I get these too on some systems, but ignore them...</p>


<blockquote>

	<p>Can you apply the patch and see if the tests work for you?</p>


</blockquote>

	<p>Will check it in tonight. As for the exifcomment-encoding-test.sh script, I moved the new testcases to bugfixes-test.sh last night, so this is not required anymore.</p></div>
    </div>
  </div>
  
  <div id="change-1513" class="journal has-notes has-details">
    <div id="note-34">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-34" class="journal-link">#34</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="13 Jan 2010 19:27" href="/projects/exiv2/activity?from=2010-01-13">almost 12 years</a> ago
      <span id="journal-1513-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>New</i> to <i>Resolved</i></li>
       <li><strong>Target version</strong> set to <i>0.20</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>100</i></li>
    </ul>
    <div id="journal-1513-notes" class="wiki"><p>For Exif UNICODE comments, Exiv2 now expects the input encoded in UTF-8 and serializes it to UCS-2. In addition, special characters can be escaped in the input. The output is also in UTF-8.</p>


	<p>Applications which previously worked around this problem by setting UNICODE comments in UCS-2 will need to be changed accordingly.</p></div>
    </div>
  </div>
  
  <div id="change-1514" class="journal has-notes">
    <div id="note-35">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-35" class="journal-link">#35</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="13 Jan 2010 19:41" href="/projects/exiv2/activity?from=2010-01-13">almost 12 years</a> ago
      <span id="journal-1514-private_notes" class=""></span>
    </h4>

    <div id="journal-1514-notes" class="wiki"><p>Leo,</p>


	<p>If an image has a UNICODE comment encoded in UTF-8 (e.g., set using a previous version of Exiv2), would it be possible to detect that and not convert it on read then?</p>


	<p>There is actually existing code to determine if text is UTF-8 encoded in IptcData::detectCharset(), iptc.cpp. I'm wondering if that algorithm could be generalized to also detect UCS-2 incl. the byte-order used. Then we could also deal with comments that have an UCS-2 comment but encoded using a different byte-order than the rest of the Exif data (which is another problem that an Exiv2 application could have previously introduced).</p>


	<p>In any case, thanks again for your contribution so far! The escaping logic also fixes <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: exiv2 tool: It should be possible to insert newlines in text strings. (Closed)" href="/issues/572">#572</a>.</p>


	<p>Andreas</p></div>
    </div>
  </div>
  
  <div id="change-1516" class="journal has-notes">
    <div id="note-36">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-36" class="journal-link">#36</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="14 Jan 2010 01:38" href="/projects/exiv2/activity?from=2010-01-14">almost 12 years</a> ago
      <span id="journal-1516-private_notes" class=""></span>
    </h4>

    <div id="journal-1516-notes" class="wiki"><p>Andreas Huggel wrote:</p>


<blockquote>

	<p>If an image has a UNICODE comment encoded in UTF-8 (e.g., set using a previous version of Exiv2), would it be possible to detect that and not convert it on read then?</p>


</blockquote>

	<p>I think we went over this at the start of this bug... The conclusion seems to be: Yes, but you are bound to mis-detect something. There are just so many UTF-8 byte sequences that actually are valid UCS-2 sequences that you can't just depend on detecting when the bytes cannot possibly be UCS-2. Exiftool, for example, tries to do some smart decoding, but even it fails on old exiv2 comments...</p>


	<p>The only options I can think of is to add a method to the CommentValue class:<br /> //! Decodes the raw comment data (that we squirrel away on read) as the given charset<br /> std::string CommentValue::commentDecodedAs(std::string iconvCharset)<br /> //! Returns the raw comment data (that we squirrel away on read)<br /> CommentValue::data()</p>


	<p>The read(std::string) method would set the "raw data" to the output of CommentValue::encode().</p>


	<p>We can then have a utility that fixes the comments by reading them as UTF8 and writing UCS-2. It would be a one-time thing to run them on all files. The utility can be set to not convert comments that contain zero bytes, or only comments that contain UTF8 multibyte sequences. I think that would be preferable, as we would then know that the input <strong>most likely</strong> is UTF-8 (otherwise the user wouldn't run the utility).</p>


<blockquote>

	<p>There is actually existing code to determine if text is UTF-8 encoded in IptcData::detectCharset(), iptc.cpp. I'm wondering if that algorithm could be generalized to also detect UCS-2 incl. the byte-order used.</p>


</blockquote>

	<p>Only heuristically. I think we need some kind of input from the user saying that "this comment <strong>needs</strong> autodetection" - otherwise you'll end up not converting when you should for some locale.</p>


	<p>Or maybe run with autodetection as default for six months and then turn it off for the next version.</p></div>
    </div>
  </div>
  
  <div id="change-1517" class="journal has-notes">
    <div id="note-37">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-37" class="journal-link">#37</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="14 Jan 2010 06:46" href="/projects/exiv2/activity?from=2010-01-14">almost 12 years</a> ago
      <span id="journal-1517-private_notes" class=""></span>
    </h4>

    <div id="journal-1517-notes" class="wiki"><p>Ok. So the exiv2 utility could then work like this:</p>


	<ul>
	<li>By default, it autodetects the comment charset (via CommentValue::write)</li>
		<li>If that doesn't give the correct result, the user can indicate the charset to be used with a new command line option (in this case the proposed new function is used to decode the comment)</li>
		<li>The utility gets a new command to fix the comment encoding. Similarly, this command also uses autodetection by default or the charset specified with the same new command line option (and all it does is decode the comment using the specified charset and set it again)</li>
	</ul>


	<p>And all of this is only applicable for UNICODE comments.</p>


	<p>As for the implementation, I think this means that CommentValue internally stores (only) the raw comment (again). copy() becomes trivial, decoding is done in write (from UCS-2/the autodetected charset) and in the new function (from the specified charset) and encoding is done in read(const std::string&#38;). The other proposed new function is not necessary since value_ is public.</p>


	<p>What do you think?</p></div>
    </div>
  </div>
  
  <div id="change-1518" class="journal has-notes">
    <div id="note-38">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-38" class="journal-link">#38</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="14 Jan 2010 09:02" href="/projects/exiv2/activity?from=2010-01-14">almost 12 years</a> ago
      <span id="journal-1518-private_notes" class=""></span>
    </h4>

    <div id="journal-1518-notes" class="wiki"><p>I've refactored the implementation as sketched above, see <a class="changeset" title="#662: Charset conversion on read and write (and if needed on copy)." href="/projects/exiv2/repository/exiv2/revisions/2005">r2005</a>. It was slightly more hairy than expected because read() and write() don't know the byte order of course (copy() is not trivial because of that). I think the autodetection logic could now be added quite easily. The tests pass except for the special case that we mentioned earlier (that now again behaves as it used to).</p></div>
    </div>
  </div>
  
  <div id="change-1519" class="journal has-notes">
    <div id="note-39">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-39" class="journal-link">#39</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="15 Jan 2010 03:33" href="/projects/exiv2/activity?from=2010-01-15">almost 12 years</a> ago
      <span id="journal-1519-private_notes" class=""></span>
    </h4>

    <div id="journal-1519-notes" class="wiki"><p>Added detectCharset() and an optional parameter for the encoding to comment(). The rules to actually detect the character encoding are missing, if you have time to add them, please do, I will leave this as it is now for the next few days.</p></div>
    </div>
  </div>
  
  <div id="change-1523" class="journal has-notes">
    <div id="note-40">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-40" class="journal-link">#40</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="21 Jan 2010 15:27" href="/projects/exiv2/activity?from=2010-01-21">almost 12 years</a> ago
      <span id="journal-1523-private_notes" class=""></span>
    </h4>

    <div id="journal-1523-notes" class="wiki"><p>Andreas Huggel wrote:</p>


<blockquote>

	<p>Added detectCharset() and an optional parameter for the encoding to comment(). The rules to actually detect the character encoding are missing, if you have time to add them, please do, I will leave this as it is now for the next few days.</p>


</blockquote>

	<p>Hi, sorry for not getting back to you sooner.</p>


	<p>I'll have a look at stuff tomorrow or over the weekend. The changes you've made sound fine.</p></div>
    </div>
  </div>
  
  <div id="change-1524" class="journal has-notes">
    <div id="note-41">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-41" class="journal-link">#41</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="21 Jan 2010 18:30" href="/projects/exiv2/activity?from=2010-01-21">almost 12 years</a> ago
      <span id="journal-1524-private_notes" class=""></span>
    </h4>

    <div id="journal-1524-notes" class="wiki"><p>Ok, great. There is some code to detect UTF-8 text in IptcData::detectCharset (iptc.cpp), maybe that should become a utility function so that it can be re-used. Anyway, I'll leave this issue alone over the weekend.</p></div>
    </div>
  </div>
  
  <div id="change-1526" class="journal has-notes">
    <div id="note-42">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-42" class="journal-link">#42</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/311">Leo Sutic</a> <a title="24 Jan 2010 16:30" href="/projects/exiv2/activity?from=2010-01-24">almost 12 years</a> ago
      <span id="journal-1526-private_notes" class=""></span>
    </h4>

    <div id="journal-1526-notes" class="wiki"><p>Andreas Huggel wrote:</p>


<blockquote>

	<p>Ok, great. There is some code to detect UTF-8 text in IptcData::detectCharset (iptc.cpp), maybe that should become a utility function so that it can be re-used. Anyway, I'll leave this issue alone over the weekend.</p>


</blockquote>

	<p>For the life of me, I can't find the new command line parameter (to override the autodetection).</p>


	<p>The charset detection looks like a simple job, but where do you want it factored out to? Converter?</p></div>
    </div>
  </div>
  
  <div id="change-1527" class="journal has-notes">
    <div id="note-43">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-43" class="journal-link">#43</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="24 Jan 2010 17:18" href="/projects/exiv2/activity?from=2010-01-24">almost 12 years</a> ago
      <span id="journal-1527-private_notes" class=""></span>
    </h4>

    <div id="journal-1527-notes" class="wiki"><blockquote>

	<p>For the life of me, I can't find the new command line parameter (to override the autodetection).</p>


</blockquote>

	<p>That's because there is none yet. Maybe what I said above is misleading. Only the library part was refactored, the new utility functionality has not been added yet.</p>


<blockquote>

	<p>The charset detection looks like a simple job, but where do you want it factored out to? Converter?</p>


</blockquote>

	<p>I was thinking of another new function in convert.[ch]pp, like what we did with <code>convertStringCharset</code>.</p></div>
    </div>
  </div>
  
  <div id="change-1538" class="journal has-notes">
    <div id="note-44">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-44" class="journal-link">#44</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="12 Feb 2010 07:38" href="/projects/exiv2/activity?from=2010-02-12">almost 12 years</a> ago
      <span id="journal-1538-private_notes" class=""></span>
    </h4>

    <div id="journal-1538-notes" class="wiki"><blockquote>

	<p>For the life of me, I can't find the new command line parameter (to override the autodetection).</p>


</blockquote>

	<p>Added with <a class="changeset" title="#662: Added new option -n and action fixcom to exiv2 utility." href="/projects/exiv2/repository/exiv2/revisions/2027">r2027</a>.</p></div>
    </div>
  </div>
  
  <div id="change-1656" class="journal has-details">
    <div id="note-45">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-45" class="journal-link">#45</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="29 May 2010 10:42" href="/projects/exiv2/activity?from=2010-05-29">over 11 years</a> ago
      <span id="journal-1656-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Resolved</i> to <i>Closed</i></li>
    </ul>
    
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/662.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/662.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
