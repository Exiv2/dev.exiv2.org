<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #1187: Crash while reading in parallel threads - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="hC86Oe4H4c7bX1Or1pMVgdk7+rPNMoqm+LqjitLUV+pmYpHWnH0tzo47TKdpRBmy5qmuyjzRKxwFmjMCke2whQ==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #1187: Crash while reading in parallel threads" href="https://dev.exiv2.org/issues/1187.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #1187</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Crash while reading in parallel threads</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="29 May 2016 08:06" href="/projects/exiv2/activity?from=2016-05-29">over 5 years</a> ago.
        Updated <a title="24 Jul 2016 09:01" href="/projects/exiv2/activity?from=2016-07-24">over 5 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">xmp</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="28 Apr 2017" href="/versions/52">0.26</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">29 May 2016</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">15.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>I'm using exiv2 library for my project, Xpiks (<a class="external" href="http://ribtoks.github.io/xpiks/">http://ribtoks.github.io/xpiks/</a>). I've implemented parallel reading of metadata, but it seem to be crashing every second time.</p>


	<p>Operating system: OS X 10.10.5<br />Exiv2 version: 0.25 - release</p>


	<p>I really need a patch for this asap, since the bug started to repro suddenly and I've already released my version with exiv2 (previously I used exiftool).</p>


	<p>Full stacktraces here:<br /><a class="external" href="http://pastebin.com/egUDkf3X">http://pastebin.com/egUDkf3X</a></p>


	<p>Code working with exiv2 is here:<br /><a class="external" href="https://github.com/Ribtoks/xpiks/blob/master/src/xpiks-qt/MetadataIO/exiv2readingworker.cpp">https://github.com/Ribtoks/xpiks/blob/master/src/xpiks-qt/MetadataIO/exiv2readingworker.cpp</a> (from the line 552)<br />Threading here:<br /><a class="external" href="https://github.com/Ribtoks/xpiks/blob/master/src/xpiks-qt/MetadataIO/readingorchestrator.cpp">https://github.com/Ribtoks/xpiks/blob/master/src/xpiks-qt/MetadataIO/readingorchestrator.cpp</a> (nothing unusual)</p>


	<p>Stacktraces related to exiv2:</p>


	<p>Thread 25 Crashed:: QThread<br />0   com.yourcompany.xpiks-qt          0x0000000101865c9d std::__1::__tree_node_base&lt;void*&gt;* std::__1::__tree_next&lt;std::__1::__tree_node_base&lt;void*&gt;*>(std::__1::__tree_node_base&lt;void*&gt;*) + 109<br />1   com.yourcompany.xpiks-qt          0x00000001017b8c60 Exiv2::XmpProperties::lookupNsRegistry(Exiv2::XmpNsInfo::Prefix const&#38;) + 1136<br />2   com.yourcompany.xpiks-qt          0x00000001017bafd5 Exiv2::XmpProperties::ns(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; > const&#38;) + 69<br />3   com.yourcompany.xpiks-qt          0x00000001017bc958 Exiv2::XmpKey::Impl::Impl(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; > const&#38;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; > const&#38;) + 440<br />4   com.yourcompany.xpiks-qt          0x00000001017bcb55 Exiv2::XmpKey::Impl::Impl(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; > const&#38;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; > const&#38;) + 37<br />5   com.yourcompany.xpiks-qt          0x00000001017bd4d8 Exiv2::XmpKey::XmpKey(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; > const&#38;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; > const&#38;) + 104<br />6   com.yourcompany.xpiks-qt          0x00000001017bd555 Exiv2::XmpKey::XmpKey(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; > const&#38;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; > const&#38;) + 37<br />7   com.yourcompany.xpiks-qt          0x000000010188fdd4 Exiv2::XmpParser::decode(Exiv2::XmpData&#38;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; > const&#38;) + 15220<br />8   com.yourcompany.xpiks-qt          0x000000010188d3a9 Exiv2::XmpParser::decode(Exiv2::XmpData&#38;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; > const&#38;) + 4425<br />9   com.yourcompany.xpiks-qt          0x0000000101734d61 Exiv2::JpegBase::readMetadata() + 3889<br />10  com.yourcompany.xpiks-qt          0x00000001015652b2 MetadataIO::Exiv2ReadingWorker::readMetadata(Models::ArtworkMetadata*, MetadataIO::ImportDataResult&#38;) + 178<br />11  com.yourcompany.xpiks-qt          0x0000000101564866 MetadataIO::Exiv2ReadingWorker::process() + 470<br />12  org.qt-project.QtCore             0x00000001028202e2 QMetaObject::activate(QObject*, int, int, void**) + 2994<br />13  org.qt-project.QtCore             0x0000000102644d76 QThreadStorageData::finish(void**) + 2662<br />14  libsystem_pthread.dylib           0x00007fff88d4705a _pthread_body + 131<br />15  libsystem_pthread.dylib           0x00007fff88d46fd7 _pthread_start + 176<br />16  libsystem_pthread.dylib           0x00007fff88d443ed thread_start + 13</p>


	<p>Thread 26:: QThread<br />0   libsystem_kernel.dylib            0x00007fff8b79d166 _<em>psynch_mutexwait + 10<br />1   com.yourcompany.xpiks-qt          0x000000010162ffa5 XMP_EnterCriticalRegion(_opaque_pthread_mutex_t&#38;) + 21<br />2   com.yourcompany.xpiks-qt          0x0000000101661f02 XMP_AutoMutex::XMP_AutoMutex() + 34<br />3   com.yourcompany.xpiks-qt          0x0000000101661e95 XMP_AutoMutex::XMP_AutoMutex() + 21<br />4   com.yourcompany.xpiks-qt          0x00000001016618b4 WXMPIterator_Next_1 + 68<br />5   com.yourcompany.xpiks-qt          0x000000010189901c TXMPIterator&lt;std::</em>_1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; > >::Next(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; ><strong>, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; ></strong>, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; ><strong>, unsigned long</strong>) + 188<br />6   com.yourcompany.xpiks-qt          0x000000010188e339 Exiv2::XmpParser::decode(Exiv2::XmpData&#38;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; > const&#38;) + 8409<br />7   com.yourcompany.xpiks-qt          0x0000000101734d61 Exiv2::JpegBase::readMetadata() + 3889<br />8   com.yourcompany.xpiks-qt          0x00000001015652b2 MetadataIO::Exiv2ReadingWorker::readMetadata(Models::ArtworkMetadata*, MetadataIO::ImportDataResult&#38;) + 178<br />9   com.yourcompany.xpiks-qt          0x0000000101564866 MetadataIO::Exiv2ReadingWorker::process() + 470<br />10  org.qt-project.QtCore             0x00000001028202e2 QMetaObject::activate(QObject*, int, int, void**) + 2994<br />11  org.qt-project.QtCore             0x0000000102644d76 QThreadStorageData::finish(void**) + 2662<br />12  libsystem_pthread.dylib           0x00007fff88d4705a _pthread_body + 131<br />13  libsystem_pthread.dylib           0x00007fff88d46fd7 _pthread_start + 176<br />14  libsystem_pthread.dylib           0x00007fff88d443ed thread_start + 13</p>


	<p>Thread 25 crashed with X86 Thread State (64-bit):<br />  rax: 0x0000000101be3da8  rbx: 0x000060800056b580  rcx: 0x0000000000000000  rdx: 0x0000000000000001<br />  rdi: 0x00006080000bdac0  rsi: 0x0000000000000000  rbp: 0x000000013adaafb0  rsp: 0x000000013adaafb0<br />   <a class="changeset" title="More code" href="/projects/exiv2/repository/exiv2/revisions/8">r8</a>: 0x656c6261746b7261   <a class="changeset" title="Added Value et al." href="/projects/exiv2/repository/exiv2/revisions/9">r9</a>: 0x0000000000000000  <a class="changeset" title="Values implemented" href="/projects/exiv2/repository/exiv2/revisions/10">r10</a>: 0xffffffffffffffff  <a class="changeset" title="More code..." href="/projects/exiv2/repository/exiv2/revisions/11">r11</a>: 0xffff9f813ab98651<br />  <a class="changeset" title="added license blabla" href="/projects/exiv2/repository/exiv2/revisions/12">r12</a>: 0x00007ffed3dd5560  <a class="changeset" title="Metadatum interface, Ifd::Entry" href="/projects/exiv2/repository/exiv2/revisions/13">r13</a>: 0x000000013adadc80  <a class="changeset" title="Fix in the docu" href="/projects/exiv2/repository/exiv2/revisions/14">r14</a>: 0x000000013adadc80  <a class="changeset" title="Rewrote Thumbnail::read(), added ExifData::findKey, cleanup" href="/projects/exiv2/repository/exiv2/revisions/15">r15</a>: 0x0000608000244f50<br />  rip: 0x0000000101865c9d  rfl: 0x0000000000010202  cr2: 0x0000000000000000</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1006">DSC_0042.jpg</a>    <span class="size">(110 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1006/DSC_0042.jpg">DSC_0042.jpg</a>  </td>
  <td></td>
  <td>
      <span class="author">Robin Mills, 29 May 2016 17:08</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1007">rwlock_025.svn_patch</a>    <span class="size">(6.25 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1007/rwlock_025.svn_patch">rwlock_025.svn_patch</a>  </td>
  <td></td>
  <td>
      <span class="author">Taras Kushnir, 29 May 2016 17:28</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1010">LargsPanorama.jpg</a>    <span class="size">(122 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1010/LargsPanorama.jpg">LargsPanorama.jpg</a>  </td>
  <td></td>
  <td>
      <span class="author">Robin Mills, 31 May 2016 08:00</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>







<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/1187" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="Dl1RrdxsoAa7nwZ7o+6phfIIEHlT9lL72s3yTXFf+ZLsEPpCrhZsBu77GXccOaW2zZpEAKIV80En7WLFMmYe/Q==" />
  <table class="list issues odd-even"><tr id="relation-229" class="issue hascontextmenu issue tracker-2 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1188" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-2 status-5 priority-4 priority-default closed" href="/issues/1188">Feature #1188</a>: Provide build support for C++11</td><td class="status">Closed</td><td class="start_date">29 May 2016</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-237" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1207" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/1207">Bug #1207</a>: digiKam maintenance tool to synchronize files metadata and database crash in Exiv2 (re-entrancy issue ?)</td><td class="status">Closed</td><td class="start_date">13 Aug 2016</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-264" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1270" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/1270">Bug #1270</a>: Using libexiv2.a/.lib  in multhreaded app segfaults.</td><td class="status">Closed</td><td class="start_date">13 Jan 2017</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/1187/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=1187&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 4308" href="/projects/exiv2/repository/exiv2/revisions/4308">Revision 4308</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4308/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="30 May 2016 14:45" href="/projects/exiv2/activity?from=2016-05-30">over 5 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187">#1187</a> Thank You to Taras for the patch.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4309" href="/projects/exiv2/repository/exiv2/revisions/4309">Revision 4309</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4309/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="01 Jun 2016 20:17" href="/projects/exiv2/activity?from=2016-06-01">over 5 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187">#1187</a> Fixing msvc build breaker in <a class="changeset" title="#1187 Thank You to Taras for the patch." href="/projects/exiv2/repository/exiv2/revisions/4308">r4308</a>  Thank You Taras for the patch.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4311" href="/projects/exiv2/repository/exiv2/revisions/4311">Revision 4311</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4311/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="04 Jun 2016 05:56" href="/projects/exiv2/activity?from=2016-06-04">over 5 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187">#1187</a> and <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: CMake toolchain for windows (Closed)" href="/issues/1041">#1041</a> Fixing CMake/MSVC build breaker</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4312" href="/projects/exiv2/repository/exiv2/revisions/4312">Revision 4312</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4312/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="04 Jun 2016 17:08" href="/projects/exiv2/activity?from=2016-06-04">over 5 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187">#1187</a> and <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: CMake toolchain for windows (Closed)" href="/issues/1041">#1041</a>.  Fixing CMake/MSVC 2013/15 build breakers</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4313" href="/projects/exiv2/repository/exiv2/revisions/4313">Revision 4313</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4313/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="05 Jun 2016 06:15" href="/projects/exiv2/activity?from=2016-06-05">over 5 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187">#1187</a> and <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: CMake toolchain for windows (Closed)" href="/issues/1041">#1041</a>.  Fixing CMake/Linux build breakers concerning libpthread</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4314" href="/projects/exiv2/repository/exiv2/revisions/4314">Revision 4314</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4314/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="07 Jun 2016 15:27" href="/projects/exiv2/activity?from=2016-06-07">over 5 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187">#1187</a> Fixing ./configure build breaker concerning libpthread</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4320" href="/projects/exiv2/repository/exiv2/revisions/4320">Revision 4320</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4320/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="12 Jun 2016 12:17" href="/projects/exiv2/activity?from=2016-06-12">over 5 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Camera accessory overflow file (Closed)" href="/issues/1034">#1034</a> (and <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187">#1187</a>).  Fixed buildbreaker in MinGW/configure build.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4323" href="/projects/exiv2/repository/exiv2/revisions/4323">Revision 4323</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4323/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="13 Jun 2016 13:18" href="/projects/exiv2/activity?from=2016-06-13">over 5 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187">#1187</a> and <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: CMake toolchain for windows (Closed)" href="/issues/1041">#1041</a>.  Fixing CMake to install include/exiv2/rwlock.hpp (detected by contrib/buildserver/test_daily.sh)</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4324" href="/projects/exiv2/repository/exiv2/revisions/4324">Revision 4324</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4324/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="13 Jun 2016 15:14" href="/projects/exiv2/activity?from=2016-06-13">over 5 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187">#1187</a> and <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: CMake toolchain for windows (Closed)" href="/issues/1041">#1041</a>.  Fixing src/Makefile to install include/exiv2/rwlock.hpp (detected by contrib/buildserver/test_daily.sh)</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-5067" class="journal has-notes">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="29 May 2016 08:14" href="/projects/exiv2/activity?from=2016-05-29">over 5 years</a> ago
      <span id="journal-5067-private_notes" class=""></span>
    </h4>

    <div id="journal-5067-notes" class="wiki"><p>It reproes only in Release build for me so I can't debug it.</p></div>
    </div>
  </div>
  
  <div id="change-5068" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="29 May 2016 08:40" href="/projects/exiv2/activity?from=2016-05-29">over 5 years</a> ago
      <span id="journal-5068-private_notes" class=""></span>
    </h4>

    <div id="journal-5068-notes" class="wiki"><p>digiKam use multithreading to do exactly the same task than you, and it do not crash. We use also Qt as i'm sure that you know already as i i see my comments in your code.</p>


	<p>Your trace show a XMP problem. 99% of chance that XMP SDK from Adobe is not initiate properly at your application startup...</p>


	<p>Gilles Caulier</p></div>
    </div>
  </div>
  
  <div id="change-5069" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="29 May 2016 08:47" href="/projects/exiv2/activity?from=2016-05-29">over 5 years</a> ago
      <span id="journal-5069-private_notes" class=""></span>
    </h4>

    <div id="journal-5069-notes" class="wiki"><p>Gilles Caulier wrote:</p>


<blockquote>

	<p>Your trace show a XMP problem. 99% of chance that XMP SDK from Adobe is not initiate properly at your application startup...</p>


</blockquote>

	<p>Thanks for the fast response!</p>


	<p>Umm. Can you please tell me how to initiate it "properly"?</p></div>
    </div>
  </div>
  
  <div id="change-5070" class="journal has-notes has-details">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="29 May 2016 09:11" href="/projects/exiv2/activity?from=2016-05-29">over 5 years</a> ago
      <span id="journal-5070-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> set to <i>xmp</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Priority</strong> changed from <i>Urgent</i> to <i>Normal</i></li>
       <li><strong>Target version</strong> set to <i>0.26</i></li>
    </ul>
    <div id="journal-5070-notes" class="wiki"><p>I made a change last September in lookupNsRegistry() and I'm wondering if this is thread-safe.  I'm on vacation at the moment and my time to investigate is limited.  Are you using the shipping version of v0.25 which does not have my change to lookupNsRegistry()?</p></div>
    </div>
  </div>
  
  <div id="change-5071" class="journal has-notes">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="29 May 2016 09:17" href="/projects/exiv2/activity?from=2016-05-29">over 5 years</a> ago
      <span id="journal-5071-private_notes" class=""></span>
    </h4>

    <div id="journal-5071-notes" class="wiki"><p>Robin Mills wrote:</p>


<blockquote>

	<p>I made a change last September in lookupNsRegistry() and I'm wondering if this is thread-safe.  I'm on vacation at the moment and my time to investigate is limited.  Are you using the shipping version of v0.25 which does not have my change to lookupNsRegistry().</p>


</blockquote>

	<p>I'm using "latest stable" I was able to find which is v0.25 atm.</p>


	<p>A have added a call to Exiv2::XmpParser::initialize() in the beginning of my app's startup and it still crashes inside lookupNsRegistry().</p>


	<p>Overall I didn't see how 0.26 is going, but static variables and threading is a sure recipe for disaster.</p>


	<p>BTW, is trunk in SVN "production ready"? Or there're is some big testing planned?</p></div>
    </div>
  </div>
  
  <div id="change-5072" class="journal has-notes">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="29 May 2016 10:37" href="/projects/exiv2/activity?from=2016-05-29">over 5 years</a> ago
      <span id="journal-5072-private_notes" class=""></span>
    </h4>

    <div id="journal-5072-notes" class="wiki"><p>This issue has nothing to do with initialize() which is racy as well (if you don't call it in the beginning of the startup).</p>


	<p>The problem is that XmpProperties::registerNs(), XmpProperties::lookupNsRegistry() and XmpProperties::unregisterNs()<br />have pretty obvious race conditions accessing std::map&lt;std::string, XmpNsInfo&gt; _nsRegistry.</p>


	<p>All of them should have locking/etc. Code in trunk (is it future 0.26) is same as 0.25 for the methods above.</p></div>
    </div>
  </div>
  
  <div id="change-5073" class="journal has-notes">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="29 May 2016 12:55" href="/projects/exiv2/activity?from=2016-05-29">over 5 years</a> ago
      <span id="journal-5073-private_notes" class=""></span>
    </h4>

    <div id="journal-5073-notes" class="wiki"><p>I've created a patch with a fix and tested it running ~150 threads in parallel. It crashes if I use old lib and does not if I use lib with my patch. I've added RW lock for operations with NsRegistry nsRegistry_</p>


	<p>So the patch for:</p>


	<p>- properties.cpp<br /><a class="external" href="https://github.com/Ribtoks/xpiks/blob/db25d22f7df71ba3b18bbf5e57a2d94658ddf44b/src/exiv2-0.25/rwlock.patch">https://github.com/Ribtoks/xpiks/blob/db25d22f7df71ba3b18bbf5e57a2d94658ddf44b/src/exiv2-0.25/rwlock.patch</a></p>


	<p>- properties.h<br />is topmost here<br /><a class="external" href="https://github.com/Ribtoks/xpiks/commit/db25d22f7df71ba3b18bbf5e57a2d94658ddf44b">https://github.com/Ribtoks/xpiks/commit/db25d22f7df71ba3b18bbf5e57a2d94658ddf44b</a></p>


	<p>- new file rwlock.hpp<br /><a class="external" href="https://github.com/Ribtoks/xpiks/blob/77e356af7b02a5a6e9aecb4c1f2966a79c618d79/src/exiv2-0.25/include/exiv2/rwlock.hpp">https://github.com/Ribtoks/xpiks/blob/77e356af7b02a5a6e9aecb4c1f2966a79c618d79/src/exiv2-0.25/include/exiv2/rwlock.hpp</a></p>


	<p>I know every project has it's own rules for submitting patches and stuff, but I'm really super busy right now to read them and read docs about SVN how to submit my patch over there <br />(it would be so much easier if you guys just used GitHub or Bitbucket - just look how many clones of Exiv2 project exist nowadays over there).</p></div>
    </div>
  </div>
  
  <div id="change-5074" class="journal has-notes">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="29 May 2016 12:59" href="/projects/exiv2/activity?from=2016-05-29">over 5 years</a> ago
      <span id="journal-5074-private_notes" class=""></span>
    </h4>

    <div id="journal-5074-notes" class="wiki"><p>Gilles Caulier wrote:</p>


<blockquote>

	<p>digiKam use multithreading to do exactly the same task than you, and it do not crash. <br />Gilles Caulier</p>


</blockquote>

	<p>It does not mean that it's stable, but means nobody found a race condition there.</p>


	<p>If you will look in the code, multithreaded access to NsRegistry (properties.cpp) can lead to race condition: a reader who cycles over the std::map in lookupNsRegistry() and writer who calls registerNs() which modifies the very same std::map at the same time.</p></div>
    </div>
  </div>
  
  <div id="change-5075" class="journal has-notes">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="29 May 2016 15:54" href="/projects/exiv2/activity?from=2016-05-29">over 5 years</a> ago
      <span id="journal-5075-private_notes" class=""></span>
    </h4>

    <div id="journal-5075-notes" class="wiki"><p>All the changes in patch summarized (+ fixes for Windows build)<br /><a class="external" href="https://bitbucket.org/ribtoks/xpiks-deps/commits/18181953b628ed56719fd8a8c1774eeac3a0999b?at=master">https://bitbucket.org/ribtoks/xpiks-deps/commits/18181953b628ed56719fd8a8c1774eeac3a0999b?at=master</a></p></div>
    </div>
  </div>
  
  <div id="change-5076" class="journal has-notes has-details">
    <div id="note-10">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-10" class="journal-link">#10</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="29 May 2016 17:08" href="/projects/exiv2/activity?from=2016-05-29">over 5 years</a> ago
      <span id="journal-5076-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/1006">DSC_0042.jpg</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/1006/DSC_0042.jpg">DSC_0042.jpg</a> added</li>
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>50</i></li>
       <li><strong>Estimated time</strong> set to <i>2.00 h</i></li>
    </ul>
    <div id="journal-5076-notes" class="wiki"><p>Thanks, Taras.  I see you've been busy while I've been having a nice day out.  I attach some flowers from Buxton, Derbyshire, England.</p>


	<p>I have found it impossible to decrypt your urls (at least one of which is wrong) back into a patch that compiles. Can I ask you to make your changes to a checked out copy of the code and send me a copy of the output from the command:<pre>$ svn diff</pre></p>


	<p>I see you have made changes to the CMake build to prefer C++11.  This may be something you'd like to see us support, however it's unrelated to this issue.  Can I ask you to submit a feature request to support C++11 and provide the patch.  Supporting C++11 does not only involve CMake, it has implications for the msvc and ./configure build environments.  I don't know if we should say "use C++11 if available".  Is this the normal default or should it be build a build option (for both CMake and ./configure).</p>


	<p>Are the changes to preview.cpp and epsimage.cpp related to C++11?</p>


	<p>I will not get into a discussion of the superiority of GIT over SVN.</p>


<hr />


	<p>You're right.  The foo_ statics in XMPsdk are not thread safe.  I believe they came from the Adobe SDK.  One of the priority features for v0.27 is to update our code to use XMPsdk as an external library and of course to adopt the latest Adobe XMPsdk.</p>


	<p><img src="/attachments/download/1006/DSC_0042.jpg" alt="" /></p></div>
    </div>
  </div>
  
  <div id="change-5077" class="journal has-notes has-details">
    <div id="note-11">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-11" class="journal-link">#11</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="29 May 2016 17:28" href="/projects/exiv2/activity?from=2016-05-29">over 5 years</a> ago
      <span id="journal-5077-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/1007">rwlock_025.svn_patch</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/1007/rwlock_025.svn_patch">rwlock_025.svn_patch</a> added</li>
    </ul>
    <div id="journal-5077-notes" class="wiki"><p>output from `svn diff` is in the attachment</p>


	<p>using Exiv2::byte; (in preview.cpp and epsimage.cpp) is a compilation fix for ambiguity when building in Windows (some types header in windows has typedef for "byte");</p>


	<p>Changes for C++11 in CMakeLists.txt are only related to my project and you can dismiss them (of course being able to build Exiv2 for C++11 without errors is vital). They are not included in the file attached to this message.</p>


	<p>I need you also to review my changes - I'm not sure I didn't break something and also whether I covered all threading issues in the domain I patched (I mean it's possible that my changes can cause a deadlock - if one of the routines I refactored is somehow called from another - somebody should review it thoroughly)</p></div>
    </div>
  </div>
  
  <div id="change-5078" class="journal has-notes">
    <div id="note-12">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-12" class="journal-link">#12</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="29 May 2016 18:57" href="/projects/exiv2/activity?from=2016-05-29">over 5 years</a> ago
      <span id="journal-5078-private_notes" class=""></span>
    </h4>

    <div id="journal-5078-notes" class="wiki"><p>I've added issue <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Provide build support for C++11 (Closed)" href="/issues/1188">#1188</a> to support C++11.</p>


	<p>You code is still failing to compile (as I found after I'd tried to build the patch manually).  I've added the missing file rwlock.h, however there's a static rowlock_ missing from somewhere.</p>


	<p>Still doesn't compile:<pre>libtool: compile:  g++ -ggdb -fvisibility=hidden -fvisibility-inlines-hidden -Wall -Wcast-align \
-Wpointer-arith -Wformat-security -Wmissing-format-attribute -Woverloaded-virtual -W -MMD \
-I../src -I../include/ -I../include/exiv2 -I/usr/local/include -I/usr/local/include \
-DEXV_LOCALEDIR=\"/usr/local/share/locale\" -I../xmpsdk/include -c -DEXV_BUILDING_LIB=1 \
properties.cpp  -fno-common -DPIC -o .libs/properties.o
properties.cpp:2242:46: error: no member named 'rwLock_' in 'Exiv2::XmpProperties'
    Internal::RWLock          XmpProperties::rwLock_;
                              ~~~~~~~~~~~~~~~^
1 error generated.
make[1]: *** [properties.o] Error 1
make: *** [all] Error 2
525 rmills@rmillsmbp:~/gnu/exiv2/bigtiff $ </pre>I looked at your new file <em><strong>rwlock.hpp</strong></em>.  I think it's OK.  We don't have anything in our test suite to test multi-threading, so I can only give it visual inspection.  I will review it carefully before I submit it and after it and passes the test suite on all our supported platforms.</p></div>
    </div>
  </div>
  
  <div id="change-5079" class="journal has-notes">
    <div id="note-13">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-13" class="journal-link">#13</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="29 May 2016 19:02" href="/projects/exiv2/activity?from=2016-05-29">over 5 years</a> ago
      <span id="journal-5079-private_notes" class=""></span>
    </h4>

    <div id="journal-5079-notes" class="wiki"><p>Robin Mills wrote:</p>


<blockquote>

	<p>I've added issue <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Provide build support for C++11 (Closed)" href="/issues/1188">#1188</a> to support C++11.</p>


	<p>You code is still failing to compile (as I found after I'd tried to build the patch manually).  I've added the missing file rwlock.h, however there's a static rowlock_ missing from somewhere.</p>


	<p>Still doesn't compile:[...]I looked at your new file <em><strong>rwlock.hpp</strong></em>.  I think it's OK.  We don't have anything in our test suite to test multi-threading, so I can only give it visual inspection.  I will review it carefully before I submit it and after it and passes the test suite on all our supported platforms.</p>


</blockquote>

	<p>Compilation error is because of you didn't apply patch to properties.hpp where the rwLock_ is defined.<br />Pls take a look at the included file in the previous commit (rwlock_025.svn_patch)</p>


	<p>Of course file rwlock.hpp is ok - it's super trivial and it's just wrapper over the library calls. I was talking about refactoring of properties.cpp. It has a lot of tricky methods which call one another - ns(), nsInfo() and friends.</p></div>
    </div>
  </div>
  
  <div id="change-5080" class="journal has-notes has-details">
    <div id="note-14">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-14" class="journal-link">#14</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="29 May 2016 19:33" href="/projects/exiv2/activity?from=2016-05-29">over 5 years</a> ago
      <span id="journal-5080-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Closed</i></li>
       <li><strong>% Done</strong> changed from <i>50</i> to <i>100</i></li>
       <li><strong>Estimated time</strong> changed from <i>2.00 h</i> to <i>3.00 h</i></li>
    </ul>
    <div id="journal-5080-notes" class="wiki"><p>I did apply the patch and failed to notice a message from properties.hpp "Failed to apply hunk".  I did try a couple of times to add the static.  Other compilation issues.</p>


	<p>I will have to check out v0.25 and apply your patch to that to discover exactly what you have done.  Then I can treat the trunk appropriately.</p>


	<p>I'm closing this bug because you have a work-around (your patch).  I am on vacation to get away from stuff like this.  I've linked this issue to <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Upgrade xmpsdk source to Adobe&#39;s current version (Closed)" href="/issues/941">#941</a> to update the Adobe SDK.</p></div>
    </div>
  </div>
  
  <div id="change-5081" class="journal has-notes">
    <div id="note-15">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-15" class="journal-link">#15</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="30 May 2016 07:33" href="/projects/exiv2/activity?from=2016-05-30">over 5 years</a> ago
      <span id="journal-5081-private_notes" class=""></span>
    </h4>

    <div id="journal-5081-notes" class="wiki"><p>Patch file was generated from differences from 0.25 release, but not from trunk. If this file was modified in trunk, of course there would be merge conflicts. I didn't generate it against trunk because I won't know how to correctly resolve merge conflicts (but you will).</p>


	<p>I hope so much that this fix will get into 0.26</p></div>
    </div>
  </div>
  
  <div id="change-5083" class="journal has-notes">
    <div id="note-16">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-16" class="journal-link">#16</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="30 May 2016 09:55" href="/projects/exiv2/activity?from=2016-05-30">over 5 years</a> ago
      <span id="journal-5083-private_notes" class=""></span>
    </h4>

    <div id="journal-5083-notes" class="wiki"><p>A fix for this will go into v0.26.  I was too tired last night to deal with this.  I've tried your patch on v0.25 and it builds and passes the test suite.  I will add it to the trunk and it will ship in v0.26.</p>


	<p>I'll review your code.  I didn't write Exiv2, so there are parts that I know well, and other dark corners.  Everything concerning XMP is in one of the dark places.</p>


	<p>I'm not involved in the release process - that is exclusively the domain of the project founder Andreas.  He is clever, cautious and careful.  I'll be surprised if he has tests beyond the test suite, however I've never discussed it with him.</p></div>
    </div>
  </div>
  
  <div id="change-5084" class="journal has-notes">
    <div id="note-17">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-17" class="journal-link">#17</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="30 May 2016 14:46" href="/projects/exiv2/activity?from=2016-05-30">over 5 years</a> ago
      <span id="journal-5084-private_notes" class=""></span>
    </h4>

    <div id="journal-5084-notes" class="wiki"><p>Fix submitted <a class="changeset" title="#1187 Thank You to Taras for the patch." href="/projects/exiv2/repository/exiv2/revisions/4308">r4308</a>.  Thank You to Tara for the patch.</p></div>
    </div>
  </div>
  
  <div id="change-5085" class="journal has-notes has-details">
    <div id="note-18">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-18" class="journal-link">#18</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="30 May 2016 15:07" href="/projects/exiv2/activity?from=2016-05-30">over 5 years</a> ago
      <span id="journal-5085-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Estimated time</strong> changed from <i>3.00 h</i> to <i>4.00 h</i></li>
    </ul>
    <div id="journal-5085-notes" class="wiki"><p>I looked at your changes.  I see you are "grabbing the lock" accessing/modifying the XMPsdk data and "releasing the lock".  Seems OK to me.  I don't think it's perfect.  This strategy could lead to starving one or more threads.  However it's better than crashing!</p>


	<p>Perhaps you could review <a class="changeset" title="#1187 Thank You to Taras for the patch." href="/projects/exiv2/repository/exiv2/revisions/4308">r4308</a> to see if I have carelessly lost any of your code when I added it to the trunk.</p>


	<p>I should add a multi-threaded test application to our test suite.  There have been several multi-threading issues reported in the last couple of years.  If you have suitable code, I'll be happy to accept your help.  There's lots to be done and I only have one (old) pair of hands.</p>


	<p>Anyway - thank you for investigating and fixing this matter.  Your help is appreciated.  I have opened issue <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Provide build support for C++11 (Closed)" href="/issues/1188">#1188</a> to provide support for C++11.</p></div>
    </div>
  </div>
  
  <div id="change-5091" class="journal has-notes">
    <div id="note-19">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-19" class="journal-link">#19</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="30 May 2016 18:23" href="/projects/exiv2/activity?from=2016-05-30">over 5 years</a> ago
      <span id="journal-5091-private_notes" class=""></span>
    </h4>

    <div id="journal-5091-notes" class="wiki"><p>You have moved my changes well, but you didn't add rwlock.hpp to visual studio projects thus exiv2 will not compile under Windows. I didn't include it to the patch, because it was impossible - I've converted all projects to VS 2015.</p>


	<p>Can you please elaborate on what starving you were talking about? If there would be so many readers that writers will never have access? Can you provide an example so I can fix flaws in my patch?</p>


	<p>Yes, your test suite should definitely include threading tests.</p>


	<p>I would contribute to exiv2 if only I didn't have tons of work on my own project. If I will find any new issues, I will try to fix them in exiv2. Anyway, you can point me out these threading issues so I can investigate whether they will affect me.</p></div>
    </div>
  </div>
  
  <div id="change-5092" class="journal has-notes has-details">
    <div id="note-20">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-20" class="journal-link">#20</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="30 May 2016 19:01" href="/projects/exiv2/activity?from=2016-05-30">over 5 years</a> ago
      <span id="journal-5092-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>100</i> to <i>80</i></li>
       <li><strong>Estimated time</strong> changed from <i>4.00 h</i> to <i>5.00 h</i></li>
    </ul>
    <div id="journal-5092-notes" class="wiki"><p>You're right about MSVC.  I'm surprised.  I thought CL would find include/exiv2/rwlock.hpp without assistance from Visual Studio.  Grrrrr.  Something else to do.  However you are right and the build failure has been reproduced on the buildserver.  Our "on commit" msvc build is Visual Studio 2005/64.  Our nightly build is msvc 2005/8/10/12/13/15 (Win32 and x64).  I'll fix msvc later in the week.  <a class="external" href="http://exiv2.dyndns.org:8080/job/Exiv2-trunk/label=msvc/2456/console">http://exiv2.dyndns.org:8080/job/Exiv2-trunk/label=msvc/2456/console</a></p>


	<p>Do you know the "dining philosophers" puzzle?  This is a classic multi-threading puzzle involving two resources.  Each philosopher has to acquire the knife <em><strong>AND</strong></em> fork to eat.  Of course <em><strong>deadlock</strong></em> must be avoided, however <em><strong>starvation</strong></em> must always be avoided.  Even with a single resource in which only the fork is required, in the mad scramble to acquire the fork, one philosopher could be unsuccessful in ever acquiring the fork.  In a single process that will terminate in finite time, this will not happen because eventually all philosophers will acquire the fork and eat.  Starvation is impossible.</p>


	<p>However, there is an outstanding project (part of our webready initiative) to provide an exiv2d daemon/server.  If exiv2d is very busy, he could starve a client.  Regrettably the single lock model cannot solve starvation.  It is necessary to add a priority mechanism to ensure that the most hungry philosopher gets to eat first.</p>


	<p><em><strong>Caution</strong></em>: the single lock model is very vulnerable to deadlock the instant anybody adds an additional lock anywhere in the system.  Multi-threaded systems are not easy.</p>


	<p>I worked on embedded systems at Novariant in Fremont, CA.  They developed and use QF (Quantum Framework) to avoid deadlock, race and starvation by design.  You can find out more about this here:  <a class="external" href="http://www.state-machine.com">http://www.state-machine.com</a></p>


	<p>For sure, I don't want to complicate exiv2 by adding QF.  Your contribution of rwlock.hpp seems sufficient for the moment and I thank you for doing this work.  It's fine to leave things as they are.  Thank You for your contribution.</p>


	<p>And thank you for considering contributing to Exiv2.  It's a simple fact that busy people are busy.  It's not easy to recruit people to invest the effort involved in open source as I am sure you already know.</p></div>
    </div>
  </div>
  
  <div id="change-5093" class="journal has-notes">
    <div id="note-21">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-21" class="journal-link">#21</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="30 May 2016 19:12" href="/projects/exiv2/activity?from=2016-05-30">over 5 years</a> ago
      <span id="journal-5093-private_notes" class=""></span>
    </h4>

    <div id="journal-5093-notes" class="wiki"><p>Yes, I know "dining philosophers" problem. However, in my understanding starvation is when low-priority thread constantly fails to acquire a resource because of context switches between higher-priority threads. I would not call starvation any situation when some threads are waiting some time in order to acquire the resource (as in this case - readers and writers are supposed to be of equal priority), because such waiting is inevitable part of live with any synchronization.</p>


	<p>I completely agree that multithreading is super error-prone and especially for a stranger to a project to refactor some parts of it to multithreaded support. That's why I was asking to review my changes very carefully.</p>


	<p>Thanks for the reference to Quantum Framework. Will take a look into that!</p></div>
    </div>
  </div>
  
  <div id="change-5095" class="journal has-notes">
    <div id="note-22">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-22" class="journal-link">#22</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="30 May 2016 19:29" href="/projects/exiv2/activity?from=2016-05-30">over 5 years</a> ago
      <span id="journal-5095-private_notes" class=""></span>
    </h4>

    <div id="journal-5095-notes" class="wiki"><p>There's also another strange thing related to this issue.</p>


	<p>Static methods I've mentioned predictably crash in OS X when being used with 30-40 threads, but never crash on Windows 7 and Windows 10 even on different computers. I can't understand why they don't crash.</p></div>
    </div>
  </div>
  
  <div id="change-5096" class="journal has-notes has-details">
    <div id="note-23">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-23" class="journal-link">#23</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="30 May 2016 19:49" href="/projects/exiv2/activity?from=2016-05-30">over 5 years</a> ago
      <span id="journal-5096-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Closed</i> to <i>Assigned</i></li>
       <li><strong>% Done</strong> changed from <i>80</i> to <i>70</i></li>
       <li><strong>Estimated time</strong> changed from <i>5.00 h</i> to <i>7.00 h</i></li>
    </ul>
    <div id="journal-5096-notes" class="wiki"><p>Well, if you're confident that the thread scheduling algorithm embodies priority, then all is well <em><strong>if</strong></em> all threads are equal priority.  The hungriest philosopher will get to eat and avoid starvation.  Multi-threading is a process matter.  Thread safety is a library prerequisite to be used in a multi-threaded application.  There used to be an article on the Wiki about thread safety.  It has mysteriously disappeared.  I think we agree that libexiv2 is "mostly" thread-safe.  We currently do not have a multi-threading example.  Perhaps I should write one using QF.  That would be fun.</p>


	<p>The top feature requested for v0.27 is to upgrade our XMP support to use the latest Adobe SDK as an external library.  Maybe there will a thread-safe fix for the XMPsdk <em><strong>fooBar</em></strong>_ statics.  I believe the XMPsdk code embedded in Exiv2 was added by Brad before I joined the project 8 years ago.  Andreas said something like "anything involving XMP is a total pain".  I'm about to discover the truth of that <em><strong>after</strong></em> v0.26 is code-complete in June and <em><strong>after</strong></em> I have a break from Exiv2 in July and August (to deal with various family matters).</p>


	<p>I don't want to spend any more time on this at the moment (after from getting MSVC to build).  If it's working on 40 threads on MacOS-X, I'm OK with that.  Gimme'a'break, buddy.  I'm on vacation!</p></div>
    </div>
  </div>
  
  <div id="change-5097" class="journal has-notes">
    <div id="note-24">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-24" class="journal-link">#24</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="30 May 2016 19:54" href="/projects/exiv2/activity?from=2016-05-30">over 5 years</a> ago
      <span id="journal-5097-private_notes" class=""></span>
    </h4>

    <div id="journal-5097-notes" class="wiki"><p>Sure. Excuse me for distracting you more than necessary. Have a nice time.</p></div>
    </div>
  </div>
  
  <div id="change-5101" class="journal has-notes">
    <div id="note-25">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-25" class="journal-link">#25</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="31 May 2016 07:15" href="/projects/exiv2/activity?from=2016-05-31">over 5 years</a> ago
      <span id="journal-5101-private_notes" class=""></span>
    </h4>

    <div id="journal-5101-notes" class="wiki"><p><a class="external" href="https://bitbucket.org/ribtoks/xpiks-deps/commits/23231c5ab8edafd4e873634dae742996ef068e1e">https://bitbucket.org/ribtoks/xpiks-deps/commits/23231c5ab8edafd4e873634dae742996ef068e1e</a></p>


	<p>One more fix needed for Windows build to succeed (bool -> BOOLEAN)</p></div>
    </div>
  </div>
  
  <div id="change-5105" class="journal has-notes has-details">
    <div id="note-26">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-26" class="journal-link">#26</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="31 May 2016 08:00" href="/projects/exiv2/activity?from=2016-05-31">over 5 years</a> ago
      <span id="journal-5105-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/1010">LargsPanorama.jpg</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/1010/LargsPanorama.jpg">LargsPanorama.jpg</a> added</li>
    </ul>
    <div id="journal-5105-notes" class="wiki"><p>Taras</p>


	<p>The MSVC build is failing due to the code in the WIN32_ branch of rwlock.hpp.  It doesn't require changes in the msvc project files.  There are a couple of things which aren't quite right.  Here's the code:<pre>namespace Exiv2 {
    namespace Internal {
#ifdef _WIN32
        class RWLock
        {
        public:
            RWLock()
            {
                InitializeSRWLock(&#38;rwlock_);
            }

            ~RWLock()
            {
                // do not explicitly destroy
            }

            void wrlock()
            {
                AcquireSRWLockExclusive(&#38;rwlock_);
            }

            bool trywrlock()
            {
                return TryAcquireSRWLockExclusive(&#38;rwlock_);
            }

            void rdlock()
            {
                AcquireSRWLockShared(&#38;rwlock_);
            }

            bool tryrdlock()
            {
                return TryAcquireSRWLockShared(&#38;rwlock_);
            }

            void rdunlock()
            {
                ReleaseSRWLockShared(&#38;rwlock_);
            }

            void wrunlock()
            {
                ReleaseSRWLockExclusive(&#38;rwlock_);
            }

        private:
            SRWLOCK rwlock_;
        };
#else</pre>The error is on SRWLOCK rwlock_; Macro/class SRWLOCK isn't defined.  I changed it to ScopedReadLock and added a <em><strong><code>class ScopedReadLock;</code></strong></em> forward reference.  Compiler grumbled in RWLock::RWLock() c'tor about not initialising rwlock_.</p>


	<p>I know you've got access to Visual Studio 2015.  Can you take a look and let me know the fix please?  We're off to Scotland today.  I'll leave you to have a look while I'm on the road to the land of haggis, bagpipes and kilts.  Forecast for Largs (where I was born) is 21ºC and full sun.</p>


	<p><img src="/attachments/download/1010/LargsPanorama.jpg" alt="" /></p></div>
    </div>
  </div>
  
  <div id="change-5106" class="journal has-notes">
    <div id="note-27">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-27" class="journal-link">#27</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="31 May 2016 08:09" href="/projects/exiv2/activity?from=2016-05-31">over 5 years</a> ago
      <span id="journal-5106-private_notes" class=""></span>
    </h4>

    <div id="journal-5106-notes" class="wiki"><p>Robin, I've just compiled patched exiv2 v0.25 successfully with Visual Studio 2015 and yesterday I did the same with Visual Studio 2013.</p>


	<p><a class="external" href="https://msdn.microsoft.com/en-us/library/br244843.aspx">https://msdn.microsoft.com/en-us/library/br244843.aspx</a> - SRWLock is a known class. I've included &lt;windows.h&gt; so it should have been resolved. From your description it's not quite clear what can be wrong. I need to investigate the particular case. Maybe there're some other errors which screw SRWLock's definition and VC compiler thinks it's unknown class.</p>


	<p>P.S. Me posting here does not oblige you to respond while you're on vacation. I'm just posting important stuff so it won't get lost with time.</p></div>
    </div>
  </div>
  
  <div id="change-5107" class="journal has-notes">
    <div id="note-28">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-28" class="journal-link">#28</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="31 May 2016 09:19" href="/projects/exiv2/activity?from=2016-05-31">over 5 years</a> ago
      <span id="journal-5107-private_notes" class=""></span>
    </h4>

    <div id="journal-5107-notes" class="wiki"><p>Regrettably, SRWLock isn't in VS 2005/8/10/12.  Maybe it's possible to use a static CRITICAL_SECTION to achieve our aims.  <a class="external" href="http://stackoverflow.com/questions/3498798/replace-critical-section-with-srw-lock">http://stackoverflow.com/questions/3498798/replace-critical-section-with-srw-lock</a></p>


	<p>CRITICAL_SECTION is a Win32 feature, so you should be able to develop/test it with VS2015, even if you decide to use CRITICAL_SECTION in older versions of Visual Studio and SRWLock in 2013/15.  There's code in include/exiv2/exv_msvc.h to detect the version of CL in use.</p>


	<p>I don't feel obliged to do this on vacation <em>or at any other time</em>!  However I like to deal with support issues quickly to let me focus on developing v0.26.  I still have several things to finish for v0.26 and I'm in danger of slipping due to support issues consuming my time.  I'm going to defer the low priority features of v0.26 to make the schedule.   <a class="external" href="http://dev.exiv2.org/news/2">http://dev.exiv2.org/news/2</a></p></div>
    </div>
  </div>
  
  <div id="change-5108" class="journal has-notes">
    <div id="note-29">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-29" class="journal-link">#29</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="31 May 2016 09:26" href="/projects/exiv2/activity?from=2016-05-31">over 5 years</a> ago
      <span id="journal-5108-private_notes" class=""></span>
    </h4>

    <div id="journal-5108-notes" class="wiki"><p>It's possible to use CriticalSection, but it will be less optimal than Read Write lock. I would prefer to use Read/Write lock whenever is possible for VS 13/15, and use Critical Section in other cases. I will send a patch for that a bit later today.</p></div>
    </div>
  </div>
  
  <div id="change-5111" class="journal has-notes">
    <div id="note-30">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-30" class="journal-link">#30</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4008">T Modes</a> <a title="31 May 2016 15:41" href="/projects/exiv2/activity?from=2016-05-31">over 5 years</a> ago
      <span id="journal-5111-private_notes" class=""></span>
    </h4>

    <div id="journal-5111-notes" class="wiki"><p>The current code produces over 100 warnings of type<br /><code>warning C4800: "BOOLEAN": forcing value to bool 'true' or 'false' (performance warning)</code><br />in rwlock.hpp(33) and rwlock.hpp(43) with MSVC2015.</p>


	<p>Also function <code>TryAcquireSRWLockExclusive</code> is only available in Windows 7 and later. So the code will not run on Windows XP and Vista.</p></div>
    </div>
  </div>
  
  <div id="change-5113" class="journal has-notes">
    <div id="note-31">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-31" class="journal-link">#31</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="31 May 2016 16:04" href="/projects/exiv2/activity?from=2016-05-31">over 5 years</a> ago
      <span id="journal-5113-private_notes" class=""></span>
    </h4>

    <div id="journal-5113-notes" class="wiki"><p>Pls see comment #25 - I've added one more tiny patch. dev.exiv2.org/issues/1187#note-25</p>


	<p>TryAcquireSRWLockExclusive indeed will not work before Windows 7 <del>(but who cares)</del>. Anyway, that part should be rewritten in order to be compilable by legacy visual studios (like vs 2005).</p></div>
    </div>
  </div>
  
  <div id="change-5116" class="journal has-notes">
    <div id="note-32">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-32" class="journal-link">#32</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4008">T Modes</a> <a title="31 May 2016 16:34" href="/projects/exiv2/activity?from=2016-05-31">over 5 years</a> ago
      <span id="journal-5116-private_notes" class=""></span>
    </h4>

    <div id="journal-5116-notes" class="wiki"><p>And it is not consistent:<br />On Windows (with your patch) we have in class <code>RWLock</code><br /><code>BOOLEAN trywrlock()</code><br />and otherwise<br /><code>int trywrlock()</code><br />The function should not have different return types depending on the system.</p></div>
    </div>
  </div>
  
  <div id="change-5118" class="journal has-notes">
    <div id="note-33">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-33" class="journal-link">#33</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="31 May 2016 21:24" href="/projects/exiv2/activity?from=2016-05-31">over 5 years</a> ago
      <span id="journal-5118-private_notes" class=""></span>
    </h4>

    <div id="journal-5118-notes" class="wiki"><p>Completely agree about consistency. As I've stated, didn't have much time since my changes with bug in exiv2 were in production so I wanted to fix that asap and afterwards sent my patch here.</p>


	<p>How can I have access to the repo to fix all those things and not sending you "patches via email"? Are there in SVN world any kind of pull requests?</p></div>
    </div>
  </div>
  
  <div id="change-5119" class="journal has-notes">
    <div id="note-34">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-34" class="journal-link">#34</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="31 May 2016 21:52" href="/projects/exiv2/activity?from=2016-05-31">over 5 years</a> ago
      <span id="journal-5119-private_notes" class=""></span>
    </h4>

    <div id="journal-5119-notes" class="wiki"><p>Taras:</p>


	<p>I can't grant you write access to the repos.  The credentials to grant write access are retained by Andreas and he likes new contributors to provide patches while we get to know each other.</p>


	<p>At the moment, MSVC 2005/8/10/12 builds are broken on the trunk by <a class="changeset" title="#1187 Thank You to Taras for the patch." href="/projects/exiv2/repository/exiv2/revisions/4308">r4308</a>.  We should fix or revert this.  I can setup a branch for rwlock development and when the branch builds and passes the test suite on all platforms, I'll merge to trunk.</p>


	<p>I agree with T about consistency.  BOOLEAN is a Windows 1.0 relic.  It's a macro (or typedef) for <em>unsigned short int</em> or something.  I would prefer that you return bool, even if it is Internal and not exposed as a public API.</p></div>
    </div>
  </div>
  
  <div id="change-5121" class="journal has-notes">
    <div id="note-35">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-35" class="journal-link">#35</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="01 Jun 2016 08:13" href="/projects/exiv2/activity?from=2016-06-01">over 5 years</a> ago
      <span id="journal-5121-private_notes" class=""></span>
    </h4>

    <div id="journal-5121-notes" class="wiki"><p><a class="external" href="https://bitbucket.org/ribtoks/xpiks-deps/commits/10ae89e8fca5e472a5779ad30398da74e9ccb0f7">https://bitbucket.org/ribtoks/xpiks-deps/commits/10ae89e8fca5e472a5779ad30398da74e9ccb0f7</a> - this is the patch with consolidation of api and workaround for Windows < 7</p>


	<p>Why do you guys care to support Windows Vista and XP? They are not supported by MS anymore.. <br /><del>(from the other point, why do I even ask.. you still have VS 2003 and SVN..)</del></p></div>
    </div>
  </div>
  
  <div id="change-5122" class="journal has-notes">
    <div id="note-36">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-36" class="journal-link">#36</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="01 Jun 2016 09:39" href="/projects/exiv2/activity?from=2016-06-01">over 5 years</a> ago
      <span id="journal-5122-private_notes" class=""></span>
    </h4>

    <div id="journal-5122-notes" class="wiki"><p>Thanks, Taras.  I'll look at that this evening.  Suggestion: <pre>bool trywrlock()
            {
                return 0 != TryAcquireSRWLockExclusive(&#38;rwlock_);
            }</pre>Change to: <pre>bool trywrlock()
            {
                return TryAcquireSRWLockExclusive(&#38;rwlock_) == TRUE;
            }</pre></p>


	<p><em><strong>GIT vs SVN</strong></em></p>
	<pre><code><a class="external" href="http://dev.exiv2.org/boards/3/topics/1786?r=1788#message-1788">http://dev.exiv2.org/boards/3/topics/1786?r=1788#message-1788</a></code></pre>


	<p>If you join me in Exiv2, I will agree to use GIT for v0.27 <em><strong>IF you promise</em></strong> to help me when I get stuck in GIT hell.</p>


	<p><em><strong>Old Versions of Visual Studio</strong></em>:</p>


	<p>If we can build on old versions of Visual Studio, I'm happy to continue to support them.  When I was contracting in Silicon Valley, I was rather surprised to discover ancient old tools being used on legacy systems (Dev Studio 6.0 and the like).  I don't want to encourage this, however if it's not painful to support 2005/8/10/12, let's keep them alive.  v0.26 will be the final release that support Visual Studio .Net (2003).</p></div>
    </div>
  </div>
  
  <div id="change-5125" class="journal has-notes">
    <div id="note-37">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-37" class="journal-link">#37</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="01 Jun 2016 10:19" href="/projects/exiv2/activity?from=2016-06-01">over 5 years</a> ago
      <span id="journal-5125-private_notes" class=""></span>
    </h4>

    <div id="journal-5125-notes" class="wiki"><p>I don't agree with your proposed change.<br />TRUE is defined as 1 in wintypes.h<br /><pre>
#define FALSE 0
#define TRUE 1
</pre></p>


	<p>while the MSDN about TryAcquireSRWLockShared says: <a class="external" href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd405524%28v=vs.85%29.aspx">https://msdn.microsoft.com/en-us/library/windows/desktop/dd405524%28v=vs.85%29.aspx</a><br /><pre>
*Return value*
If the lock is successfully acquired, the return value is nonzero.
</pre></p>


	<p>Obviosly, nonzero != 1 and I would leave it as is for the compatibility with the official documentation.</p>


	<p>Such a discussion about method which is even not used. It will make more sense to remove it until it will be used.</p>


<hr />


	<p>Git stuff. Please define "help". I can offer my help in setting up and maintaining git repo at GitHub + continuous integration for Windows (AppVeyor) and Linux/OS X (Travis CI). However I'm not sure what do you mean by "help".</p>


	<p>I also would like you to understand, that I'm not saying that "Git is super the best. Just use Git". What I'm saying instead is that nowadays there're a lot of usefully interconnected services which in most cases work over Git(Hub). Also accepting and managing contributions in there is so much easier .</p>


	<p>(Besides that Git seems to have it's own pros and cons comparatively to SVN and seems to be more useful for me, but it's just my point of view)</p></div>
    </div>
  </div>
  
  <div id="change-5127" class="journal has-notes">
    <div id="note-38">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-38" class="journal-link">#38</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="01 Jun 2016 10:30" href="/projects/exiv2/activity?from=2016-06-01">over 5 years</a> ago
      <span id="journal-5127-private_notes" class=""></span>
    </h4>

    <div id="journal-5127-notes" class="wiki"><p>What do I mean by "Help?".  Folks get into trouble with GIT.  I've worked with folks who use GIT and they say "It's months of mental fog before you 'get git'".  Within a few commands you can be lost and have no idea of the state of your code.  So they pull down a fresh copy from the repos.  I'm a little afraid that I'll loose control of the code.  There is no "central" server.  So if I'm in trouble, I don't know from where to pull down a new copy.</p>


	<p>SVN is very stable and I have nice tools (SmartSVN).  I have purchased a license for SmartGIT.  I want to concentrate on Exiv2 development and avoid battles with the source code control system.</p>


	<p>My thoughts about moving to GIT are to get involved with a well established project that uses it.  I'll come up to speed in the company of more experience GIT users.  I'm nervous to drag Exiv2 down this road on my own.</p></div>
    </div>
  </div>
  
  <div id="change-5128" class="journal has-notes">
    <div id="note-39">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-39" class="journal-link">#39</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="01 Jun 2016 10:33" href="/projects/exiv2/activity?from=2016-06-01">over 5 years</a> ago
      <span id="journal-5128-private_notes" class=""></span>
    </h4>

    <div id="journal-5128-notes" class="wiki"><p>I've misunderstood the return value of that function.  You are right and I am wrong.  Apologies.</p></div>
    </div>
  </div>
  
  <div id="change-5129" class="journal has-notes">
    <div id="note-40">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-40" class="journal-link">#40</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="01 Jun 2016 11:56" href="/projects/exiv2/activity?from=2016-06-01">over 5 years</a> ago
      <span id="journal-5129-private_notes" class=""></span>
    </h4>

    <div id="journal-5129-notes" class="wiki"><p>Regarding what do you say about "lost in few commands" - my experience with Git is directly opposite. For me with Git it's always clear where you are.</p>


	<p>In my opinion GUI "tools/helpers" for git are the things that will mislead you in the first place since the reason you're using them is that you don't want to bring changes in your life and have exactly UI as you've had with SVN and don't care that Git is underneath. As for me, I didn't ever use any third-party tool for git except of the tools which go with standard git distribution and don't feed need in one.</p>


	<p>I've just been recently through move from SVN to Git in quite a big organization with people working with SVN half of their lifes. It was painful for them. But now, after 3 months, majority of them sometimes say "huh, this or that is so much easier now".</p>


	<p>Anyway, I will be able to help you with porting exiv2 from svn to git when you will ask particular questions (better in private, of course, since discussion of this issue went too far). To be confident with Git I can suggest you to read only one book "Pro Git" and I hope it will be enough.</p></div>
    </div>
  </div>
  
  <div id="change-5131" class="journal has-notes">
    <div id="note-41">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-41" class="journal-link">#41</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="01 Jun 2016 16:47" href="/projects/exiv2/activity?from=2016-06-01">over 5 years</a> ago
      <span id="journal-5131-private_notes" class=""></span>
    </h4>

    <div id="journal-5131-notes" class="wiki"><p>Yes.  I bought an e-book license for "Pro Git".  Thanks for being willing to help with Git.  I have no intention to use Git as it will consume lots of my time that is better spent working on exiv2.</p>


	<p>Thanks for your Windows Patch for <a class="changeset" title="#1187 Thank You to Taras for the patch." href="/projects/exiv2/repository/exiv2/revisions/4308">r4308</a>.  I'll review that and submit it after dinner.</p></div>
    </div>
  </div>
  
  <div id="change-5133" class="journal has-notes has-details">
    <div id="note-42">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-42" class="journal-link">#42</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="07 Jun 2016 21:25" href="/projects/exiv2/activity?from=2016-06-07">over 5 years</a> ago
      <span id="journal-5133-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>70</i> to <i>90</i></li>
       <li><strong>Estimated time</strong> changed from <i>7.00 h</i> to <i>15.00 h</i></li>
    </ul>
    <div id="journal-5133-notes" class="wiki"><p>Quite a lot of work necessary to stabilise the build on all platforms and the buildserver.</p></div>
    </div>
  </div>
  
  <div id="change-5134" class="journal has-notes">
    <div id="note-43">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-43" class="journal-link">#43</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4668">Taras Kushnir</a> <a title="08 Jun 2016 04:48" href="/projects/exiv2/activity?from=2016-06-08">over 5 years</a> ago
      <span id="journal-5134-private_notes" class=""></span>
    </h4>

    <div id="journal-5134-notes" class="wiki"><p>Thank You, Robin for putting in the effort to get my patch into libexiv2.</p></div>
    </div>
  </div>
  
  <div id="change-5135" class="journal has-notes has-details">
    <div id="note-44">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-44" class="journal-link">#44</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="08 Jun 2016 09:22" href="/projects/exiv2/activity?from=2016-06-08">over 5 years</a> ago
      <span id="journal-5135-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Closed</i></li>
       <li><strong>% Done</strong> changed from <i>90</i> to <i>100</i></li>
    </ul>
    <div id="journal-5135-notes" class="wiki"><p>Buildserver built and tested with CMake:  <a class="external" href="http://rmillsmm:8080/job/trunk-cmake-daily/275/">http://rmillsmm:8080/job/trunk-cmake-daily/275/</a><br />Buildserver built and tested with Native tools (./configure and msvc2005 project/solution files): <a class="external" href="http://rmillsmm:8080/job/Exiv2-trunk/2462/">http://rmillsmm:8080/job/Exiv2-trunk/2462/</a></p>


	<p>MinGW build has been broken since late March and I will investigate/remedy that shortly.</p></div>
    </div>
  </div>
  
  <div id="change-5208" class="journal has-notes">
    <div id="note-45">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-45" class="journal-link">#45</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Jul 2016 09:01" href="/projects/exiv2/activity?from=2016-07-24">over 5 years</a> ago
      <span id="journal-5208-private_notes" class=""></span>
    </h4>

    <div id="journal-5208-notes" class="wiki"><p>I have received the following email from Taras:</p>


<blockquote>

	<p>Unfortunately, I've found a bug in my patch. 1 odd lock aquisition.<br /><a class="external" href="https://bitbucket.org/ribtoks/xpiks-deps/commits/f4ddc6129174515dbe87043a9c9669982f1e2a62">https://bitbucket.org/ribtoks/xpiks-deps/commits/f4ddc6129174515dbe87043a9c9669982f1e2a62</a> - link to a 1-line patch for a patch.</p>


	<p>If that's not gonna work for you, the patch is to remove the line:</p>


	<p>Internal::ScopedReadLock srl(rwLock_);</p>


	<p>in file properties.cpp in function <pre><code class="cplusplus syntaxhl"><span class="k">const</span> <span class="n">XmpNsInfo</span><span class="o">*</span> <span class="n">XmpProperties</span><span class="o">::</span><span class="n">nsInfoUnsafe</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">prefix</span><span class="p">)</span></code></pre></p>


</blockquote>

	<p>And my reply:</p>


<blockquote>

	<p>Thank you for the patch which has been submitted as <a class="changeset" title="#1189 Code change provided by private email from Taras.  Thank You Taras." href="/projects/exiv2/repository/exiv2/revisions/4350">r4350</a>.</p>


</blockquote></div>
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1187.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1187.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
