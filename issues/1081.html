<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #1081: Read XMP values from CR2 raw file when stored in XMLPacket - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="jimH4V8mD04DsN0IJN/NI8wgE8ZEtPsKUQDONaaz0qVsZCwOLVzDTlbUwgSbCMEQ87JHv7VXWrCsIF695Yo1yg==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #1081: Read XMP values from CR2 raw file when stored in XMLPacket" href="https://dev.exiv2.org/issues/1081.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #1081</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Read XMP values from CR2 raw file when stored in XMLPacket</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/4433">Eric Mesa</a> <a title="15 May 2015 10:11" href="/projects/exiv2/activity?from=2015-05-15">over 6 years</a> ago.
        Updated <a title="16 Jan 2016 06:49" href="/projects/exiv2/activity?from=2016-01-16">almost 6 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/4035">Alan Pater</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">xmp</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="28 Apr 2017" href="/versions/52">0.26</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">15 May 2015</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">10.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>CR2 file is given tag, title, and description in Digikam: <br /><a class="external" href="https://www.dropbox.com/s/jvqiinpsaapzxf4/_MG_3694.CR2?dl=0">https://www.dropbox.com/s/jvqiinpsaapzxf4/_MG_3694.CR2?dl=0</a></p>


	<p>Processing is done and a JPEG is produced:<br /><a class="external" href="https://www.dropbox.com/s/ip503k3tom9ciew/_MG_3694.jpg?dl=0">https://www.dropbox.com/s/ip503k3tom9ciew/_MG_3694.jpg?dl=0</a></p>


	<p>When I check with EXIFTOOL, the tag, title, and description are in both the CR2 and the JPEG, however, Digikam (which uses Exiv2 and told me to come here with this bug report), only sees the description, not the title and tag.</p>


	<p>So I installed Exiv2 on my computer and here's the output:<br />exiv2 _MG_3694.CR2<br />File name       : _MG_3694.CR2<br />File size       : 9180576 Bytes<br />MIME type       : image/x-canon-cr2<br />Image size      : 3888 x 2592<br />Camera make     : Canon<br />Camera model    : Canon EOS DIGITAL REBEL XTi<br />Image timestamp : 2015:05:13 17:08:52<br />Image number    : <br />Exposure time   : 1/500 s<br />Aperture        : F2<br />Exposure bias   : 0 EV<br />Flash           : No, compulsory<br />Flash bias      : 0 EV<br />Focal length    : 50.0 mm<br />Subject distance: 0<br />ISO speed       : 100<br />Exposure mode   : Aperture priority<br />Metering mode   : Partial<br />Macro mode      : Off<br />Image quality   : RAW<br />Exif Resolution : 1936 x 1288<br />White balance   : Auto<br />Thumbnail       : image/jpeg, 8709 Bytes<br />Copyright       : <br />Exif comment    : Leaves and Scarlett</p>


	<p>Not sure why it doesn't show the tag and title, but I <strong>can</strong> see them in Digikam</p>


	<p>Here's the JPEG:<br />xiv2 _MG_3694.jpg<br />Warning: Ignoring IPTC information encoded in the Exif data.<br />Warning: Ignoring XMP information encoded in the Exif data.<br />File name       : _MG_3694.jpg<br />File size       : 1962688 Bytes<br />MIME type       : image/jpeg<br />Image size      : 3898 x 2594<br />Camera make     : Canon<br />Camera model    : Canon EOS DIGITAL REBEL XTi<br />Image timestamp : 2015:05:13 17:08:52<br />Image number    : <br />Exposure time   : 1/500 s<br />Aperture        : F2<br />Exposure bias   : 0 EV<br />Flash           : No, compulsory<br />Flash bias      : 0 EV<br />Focal length    : 50.0 mm<br />Subject distance: 0<br />ISO speed       : 100<br />Exposure mode   : Aperture priority<br />Metering mode   : Partial<br />Macro mode      : Off<br />Image quality   : RAW<br />Exif Resolution : 3898 x 2594<br />White balance   : Auto<br />Thumbnail       : None<br />Copyright       : <br />Exif comment    : Leaves and Scarlett</p>


	<p>Why does it say it's ignoring the IPTC info? Because that's where, I'm pretty sure, the info is stored.</p>


	<p>Thank you.</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/884">XMPSpecPart3Page75.png</a>    <span class="size">(106 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/884/XMPSpecPart3Page75.png">XMPSpecPart3Page75.png</a>  </td>
  <td></td>
  <td>
      <span class="author">Robin Mills, 14 Jan 2016 17:02</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>







<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/1081" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="1HqYgB4rztL6I/+Zm8BLj4F9cNROO3f85qVQ7mazYgk2NzNvbFEC0q9H4JUkF0e8vu8krb/Y1kYbhcBmJYqFZg==" />
  <table class="list issues odd-even"><tr id="relation-156" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="900" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/900">Bug #900</a>: TIFF images lose XMP packet on write if exiv2 was compiled without XMP support</td><td class="status">Closed</td><td class="start_date">13 May 2013</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-157" class="issue hascontextmenu issue tracker-2 status-2 priority-4 priority-default"><td class="checkbox"><input type="checkbox" name="ids[]" value="992" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-2 status-2 priority-4 priority-default" href="/issues/992">Feature #992</a>: Better raw file support and test</td><td class="status">Assigned</td><td class="start_date">18 Sep 2014</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-0"><tr><td style="width: 100%;" class="todo"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-158" class="issue hascontextmenu issue tracker-2 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="922" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-2 status-5 priority-4 priority-default closed" href="/issues/922">Feature #922</a>: Add options -pS and -dI to application exiv2</td><td class="status">Closed</td><td class="start_date">25 Sep 2013</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-202" class="issue hascontextmenu issue tracker-2 status-1 priority-4 priority-default"><td class="checkbox"><input type="checkbox" name="ids[]" value="1154" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-2 status-1 priority-4 priority-default" href="/issues/1154">Feature #1154</a>: Read XMP and IPTC data from Exif Data in JPEGs</td><td class="status">New</td><td class="start_date">15 Jan 2016</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-0"><tr><td style="width: 100%;" class="todo"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/1081/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=1081&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 4184" href="/projects/exiv2/repository/exiv2/revisions/4184">Revision 4184</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4184/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Jan 2016 10:14" href="/projects/exiv2/activity?from=2016-01-14">almost 6 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Read XMP values from CR2 raw file when stored in XMLPacket (Closed)" href="/issues/1081">#1081</a>  Added Cr2Image::printStructure()</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-3700" class="journal has-notes">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="15 May 2015 11:29" href="/projects/exiv2/activity?from=2015-05-15">over 6 years</a> ago
      <span id="journal-3700-private_notes" class=""></span>
    </h4>

    <div id="journal-3700-notes" class="wiki"><p>What did you set the tag and title to?</p></div>
    </div>
  </div>
  
  <div id="change-3701" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="15 May 2015 12:26" href="/projects/exiv2/activity?from=2015-05-15">over 6 years</a> ago
      <span id="journal-3701-private_notes" class=""></span>
    </h4>

    <div id="journal-3701-notes" class="wiki"><p>Eric, have you set digikam to "If possible, write Metadata to RAW files (experimental)"?</p></div>
    </div>
  </div>
  
  <div id="change-3702" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4433">Eric Mesa</a> <a title="15 May 2015 12:56" href="/projects/exiv2/activity?from=2015-05-15">over 6 years</a> ago
      <span id="journal-3702-private_notes" class=""></span>
    </h4>

    <div id="journal-3702-notes" class="wiki"><p>Alan Pater wrote:</p>


<blockquote>

	<p>What did you set the tag and title to?</p>


</blockquote>

	<p>The tag is "Scarlett" <br />The title is "Scarlett Playing with Leaves"</p>


<blockquote>

	<p>Eric, have you set digikam to "If possible, write Metadata to RAW files (experimental)"?</p>


</blockquote>

	<p>Yes. That's how the data got there to begin with. The only thing that's carrying over is the Exif Comment. Nothing else is carrying over from CF2 to JPEG</p></div>
    </div>
  </div>
  
  <div id="change-3703" class="journal has-notes">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="15 May 2015 13:59" href="/projects/exiv2/activity?from=2015-05-15">over 6 years</a> ago
      <span id="journal-3703-private_notes" class=""></span>
    </h4>

    <div id="journal-3703-notes" class="wiki"><p>It's all in both the cr2 and the jpg, but the XMP is embedded inside Exif ApplicationNotes as shown by exiftool.</p>


<pre>

  | 16) ApplicationNotes (SubDirectory) --&gt;
  | + [XMP directory, 4868 bytes]
  | | XMPToolkit = XMP Core 4.4.0-Exiv2
  | | Software = digiKam-4.9.0
  | | DateTime = 2015-05-13T17:08:52
  | | CreatorTool = digiKam-4.9.0
  | | CreateDate = 2015-05-13T17:08:52
  | | MetadataDate = 2015-05-13T17:08:52
  | | ModifyDate = 2015-05-13T17:08:52
  | | DateTimeOriginal = 2015-05-13T17:08:52
  | | DateCreated = 2015-05-13T17:08:52
  | | Urgency = 0
  | | PickLabel = 0
  | | ColorLabel = 0
  | | ImageDescription = Leaves and Scarlett
  | | UserComment = Leaves and Scarlett
  | | TagsList = Scarlett
  | | CaptionsAuthorNames = 
  | | CaptionsDateTimeStamps = 2015-05-13T20:33:02
  | | RegionList = 
  | | RegionInfoRegions = 
  | | LastKeywordXMP = Scarlett
  | | HierarchicalSubject = Scarlett
  | | Title = Scarlett Playing with Leaves
  | | Description = Leaves and Scarlett
  | | Subject = Scarlett

</pre></div>
    </div>
  </div>
  
  <div id="change-3704" class="journal has-notes">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="15 May 2015 14:02" href="/projects/exiv2/activity?from=2015-05-15">over 6 years</a> ago
      <span id="journal-3704-private_notes" class=""></span>
    </h4>

    <div id="journal-3704-notes" class="wiki"><p>digikam Bug 347737 - Tagged RAW files do not show tags after round trip to RawTherapee </p>
	<pre><code><a class="external" href="https://bugs.kde.org/show_bug.cgi?id=347737">https://bugs.kde.org/show_bug.cgi?id=347737</a></code></pre></div>
    </div>
  </div>
  
  <div id="change-3705" class="journal has-notes">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4433">Eric Mesa</a> <a title="15 May 2015 14:21" href="/projects/exiv2/activity?from=2015-05-15">over 6 years</a> ago
      <span id="journal-3705-private_notes" class=""></span>
    </h4>

    <div id="journal-3705-notes" class="wiki"><p>Alan Pater wrote:</p>


<blockquote>

	<p>digikam Bug 347737 - Tagged RAW files do not show tags after round trip to RawTherapee</p>


	<p><a class="external" href="https://bugs.kde.org/show_bug.cgi?id=347737">https://bugs.kde.org/show_bug.cgi?id=347737</a></p>


</blockquote>

	<p>Alan,</p>


	<p>Thanks for tracing things across both bug trackers.</p></div>
    </div>
  </div>
  
  <div id="change-3707" class="journal has-notes">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4433">Eric Mesa</a> <a title="15 May 2015 16:24" href="/projects/exiv2/activity?from=2015-05-15">over 6 years</a> ago
      <span id="journal-3707-private_notes" class=""></span>
    </h4>

    <div id="journal-3707-notes" class="wiki"><p>Based on <a class="external" href="https://bugs.kde.org/show_bug.cgi?id=347737#c10">https://bugs.kde.org/show_bug.cgi?id=347737#c10</a> in which you commented:</p>


	<p>"Ok, it looks like what exiftool calls ApplicationNotes, exiv2 calls Exif.Image.XMLPacket."</p>


	<p>What are your thoughts at this point? Where does the issue appear to lie?</p></div>
    </div>
  </div>
  
  <div id="change-3708" class="journal has-notes has-details">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="15 May 2015 17:03" href="/projects/exiv2/activity?from=2015-05-15">over 6 years</a> ago
      <span id="journal-3708-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Subject</strong> changed from <i>Raw file given tag and title in Digikam. After processing in RawTherapee, resulting JPEG&#39;s tag and title not read by Digikam.</i> to <i>Unable to read XMP from CR2 raw file when stored in XMLPacket</i></li>
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Target version</strong> changed from <i>0.25</i> to <i>0.26</i></li>
    </ul>
    <div id="journal-3708-notes" class="wiki"><p>It appears that exiv2 has no method to read XMP metadata when it is stored in Exif.Image.XMLPacket.</p></div>
    </div>
  </div>
  
  <div id="change-3709" class="journal has-notes">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4433">Eric Mesa</a> <a title="15 May 2015 17:18" href="/projects/exiv2/activity?from=2015-05-15">over 6 years</a> ago
      <span id="journal-3709-private_notes" class=""></span>
    </h4>

    <div id="journal-3709-notes" class="wiki"><p>Alan Pater wrote:</p>


<blockquote>

	<p>It appears that exiv2 has no method to read XMP metadata when it is stored in Exif.Image.XMLPacket.</p>


</blockquote>

	<p>Bummer that it's for 0.26 as that comes out next year at best.</p>


	<p>At any rate, just for completion's sake on the changed subject of the bug - it's actually able to read the CR2 file in Digikam as that's where I tagged it. It's the JPEG that's created where it can't read the data stored in Exif.Image.XMLPacket.</p>


	<p>In other words, I tag the files in Digikam. And Digikam can read the tags on the DNGs and CR2s. It's only the created JPEGs that can't be read. Which seems to be weird, based on where it's stored. Or maybe Digikam is doing some extra stuff on the side like a Database or something? It's tough when we have 3+ programs interacting.</p>


	<p>Also, this holds for DNGs as well as CR2 raw files.</p>


	<p>See: <br /><strong>DNG:</strong><br /><img src="http://www.ericsbinaryworld.com/wp-content/uploads/2015/05/Day-2-Scarlett-running-after-RawTherapee-and-back-in-Digikam-463x300.png" alt="" /></p>


	<p><strong>CR2:</strong><br /><img src="http://www.ericsbinaryworld.com/wp-content/uploads/2015/05/Day-2-Scarlett-and-Tree-after-RawTherapee-in-Digikam-lost-title-and-tags-488x300.png" alt="" /></p>


	<p>Finally, it's weird that Exiv2 puts the data there, but then can't access it again....or maybe I've misunderstood something subtle.</p></div>
    </div>
  </div>
  
  <div id="change-3711" class="journal has-notes">
    <div id="note-10">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-10" class="journal-link">#10</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4433">Eric Mesa</a> <a title="15 May 2015 22:10" href="/projects/exiv2/activity?from=2015-05-15">over 6 years</a> ago
      <span id="journal-3711-private_notes" class=""></span>
    </h4>

    <div id="journal-3711-notes" class="wiki"><p>For comparison purposes, here are DNG and JPEG files exhibiting the same problem. (Showing that it's not unique to CR2)</p>


	<p>DNG:<br /><a class="external" href="https://www.dropbox.com/s/pmz8oneual5pq82/Pots.dng?dl=0">https://www.dropbox.com/s/pmz8oneual5pq82/Pots.dng?dl=0</a></p>


	<p>JPEG:<br /><a class="external" href="https://www.dropbox.com/s/l8rw3zpjgf599f7/Pots.jpg?dl=0">https://www.dropbox.com/s/l8rw3zpjgf599f7/Pots.jpg?dl=0</a></p></div>
    </div>
  </div>
  
  <div id="change-3712" class="journal has-notes">
    <div id="note-11">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-11" class="journal-link">#11</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="15 May 2015 23:08" href="/projects/exiv2/activity?from=2015-05-15">over 6 years</a> ago
      <span id="journal-3712-private_notes" class=""></span>
    </h4>

    <div id="journal-3712-notes" class="wiki"><p>Let's see:</p>


<pre>
:~$ exiv2 -g XMLPacket Pots.jpg
Warning: Ignoring IPTC information encoded in the Exif data.
Warning: Ignoring XMP information encoded in the Exif data.
Exif.Image.XMLPacket                         Byte      7246  (Binary value suppressed)

:~$ exiv2 -g XMLPacket Pots.dng
Error: Directory Canon with 25665 entries considered invalid; not read.
Exif.Image.XMLPacket                         Byte      7246  (Binary value suppressed)
</pre>

<pre>
:~$ exiv2 -px Pots.jpg
Warning: Ignoring IPTC information encoded in the Exif data.
Warning: Ignoring XMP information encoded in the Exif data.

:~$ exiv2 -px Pots.dng
Error: Directory Canon with 25665 entries considered invalid; not read.
Xmp.dc.format                                XmpText     9  image/dng
Xmp.dc.creator                               XmpSeq      1  Eric Mesa
Xmp.dc.rights                                LangAlt     1  lang="x-default" 2014 Eric Mesa; This work is licensed to the public under the Creative Commons BY-NC-SA
Xmp.dc.title                                 LangAlt     1  lang="x-default" Pots Title
Xmp.dc.description                           LangAlt     1  lang="x-default" Pots Caption
Xmp.dc.subject                               XmpBag      1  pots
Xmp.aux.SerialNumber                         XmpText     9  820420518
Xmp.aux.LensInfo                             XmpText    17  50/1 50/1 0/0 0/0
Xmp.aux.Lens                                 XmpText    12  EF50mm f/1.8
Xmp.aux.LensID                               XmpText     2  29
Xmp.aux.ImageNumber                          XmpText     2  48
Xmp.aux.FlashCompensation                    XmpText     3  0/1
Xmp.aux.OwnerName                            XmpText     9  Eric Mesa
Xmp.aux.Firmware                             XmpText     5  1.0.4
Xmp.xmp.ModifyDate                           XmpText    19  2015-05-13T17:12:43
Xmp.xmp.CreateDate                           XmpText    19  2015-05-13T17:12:43
Xmp.xmp.CreatorTool                          XmpText    41  Adobe Photoshop Lightroom 5.7.1 (Windows)
Xmp.xmp.MetadataDate                         XmpText    19  2015-05-13T17:12:43
Xmp.xmp.Rating                               XmpText     1  5
Xmp.photoshop.DateCreated                    XmpText    19  2015-05-13T17:12:43
Xmp.photoshop.CaptionWriter                  XmpText     9  Eric Mesa
Xmp.photoshop.Urgency                        XmpText     1  0
Xmp.xmpMM.DocumentID                         XmpText    44  xmp.did:f4db08a3-598a-a045-85d8-2cf419e1b5ec
Xmp.xmpMM.OriginalDocumentID                 XmpText    32  51711369AC381F3A72B5B60DDF7F26A1
Xmp.xmpMM.InstanceID                         XmpText    44  xmp.iid:f4db08a3-598a-a045-85d8-2cf419e1b5ec
Xmp.xmpMM.History                            XmpText     0  type="Seq" 
Xmp.xmpMM.History[1]                         XmpText     0  type="Struct" 
Xmp.xmpMM.History[1]/stEvt:action            XmpText     7  derived
Xmp.xmpMM.History[1]/stEvt:parameters        XmpText    68  converted from image/x-canon-cr2 to image/dng, saved to new location
Xmp.xmpMM.History[2]                         XmpText     0  type="Struct" 
Xmp.xmpMM.History[2]/stEvt:action            XmpText     5  saved
Xmp.xmpMM.History[2]/stEvt:instanceID        XmpText    44  xmp.iid:f4db08a3-598a-a045-85d8-2cf419e1b5ec
Xmp.xmpMM.History[2]/stEvt:when              XmpText    25  2015-05-13T20:05:29-04:00
Xmp.xmpMM.History[2]/stEvt:softwareAgent     XmpText    41  Adobe Photoshop Lightroom 5.7.1 (Windows)
Xmp.xmpMM.History[2]/stEvt:changed           XmpText     1  /
Xmp.xmpMM.DerivedFrom                        XmpText     0  type="Struct" 
Xmp.xmpMM.DerivedFrom/stRef:documentID       XmpText    32  51711369AC381F3A72B5B60DDF7F26A1
Xmp.xmpMM.DerivedFrom/stRef:originalDocumentID XmpText    32  51711369AC381F3A72B5B60DDF7F26A1
Xmp.xmpRights.Marked                         XmpText     4  True
Xmp.xmpRights.WebStatement                   XmpText    48  http://creativecommons.org/license/by-nc-sa/3.0/
Xmp.xmpRights.UsageTerms                     LangAlt     1  lang="x-default" Creative Commons Attribution-NonCommercial-ShareAlike
Xmp.crs.HasCrop                              XmpText     5  False
Xmp.tiff.Software                            XmpText    13  digiKam-4.9.0
Xmp.tiff.DateTime                            XmpText    19  2015-05-13T17:12:43
Xmp.tiff.ImageDescription                    LangAlt     1  lang="x-default" Pots Caption
Xmp.exif.DateTimeOriginal                    XmpText    19  2015:05:13 17:12:43
Xmp.exif.UserComment                         LangAlt     1  lang="x-default" Pots Caption
Xmp.digiKam.PickLabel                        XmpText     1  0
Xmp.digiKam.ColorLabel                       XmpText     1  0
Xmp.digiKam.TagsList                         XmpSeq      1  pots
Xmp.digiKam.CaptionsAuthorNames              LangAlt     1  lang="x-default" 
Xmp.digiKam.CaptionsDateTimeStamps           LangAlt     1  lang="x-default" 2015-05-15T17:20:37
Xmp.MicrosoftPhoto.Rating                    XmpText     2  99
Xmp.MicrosoftPhoto.LastKeywordXMP            XmpBag      1  pots
Xmp.iptc.CreatorContactInfo                  XmpText     0  type="Struct" 
Xmp.iptc.CreatorContactInfo/Iptc4xmpCore:CiEmailWork XmpText    26  ericsbinaryworld@gmail.com
Xmp.iptc.CreatorContactInfo/Iptc4xmpCore:CiAdrCtry XmpText     3  USA
Xmp.iptc.CreatorContactInfo/Iptc4xmpCore:CiAdrCity XmpText     8  Elkridge
Xmp.iptc.CreatorContactInfo/Iptc4xmpCore:CiAdrRegion XmpText     2  MD
Xmp.iptc.CreatorContactInfo/Iptc4xmpCore:CiUrlWork XmpText    31  http://www.ericsbinaryworld.com
Xmp.mwg-rs.Regions                           XmpText     0  type="Struct" 
Xmp.mwg-rs.Regions/mwg-rs:RegionList         XmpBag      0  
Xmp.MP.RegionInfo                            XmpText     0  type="Struct" 
Xmp.MP.RegionInfo/MPRI:Regions               XmpBag      0  
Xmp.lr.hierarchicalSubject                   XmpBag      1  pots

</pre></div>
    </div>
  </div>
  
  <div id="change-3713" class="journal has-notes">
    <div id="note-12">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-12" class="journal-link">#12</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="15 May 2015 23:19" href="/projects/exiv2/activity?from=2015-05-15">over 6 years</a> ago
      <span id="journal-3713-private_notes" class=""></span>
    </h4>

    <div id="journal-3713-notes" class="wiki"><blockquote>

	<p>JPEG:<br /><a class="external" href="https://www.dropbox.com/s/l8rw3zpjgf599f7/Pots.jpg?dl=0">https://www.dropbox.com/s/l8rw3zpjgf599f7/Pots.jpg?dl=0</a></p>


</blockquote>

	<p>That JPEG file was created from the DNG using RawTherapee?</p></div>
    </div>
  </div>
  
  <div id="change-3714" class="journal has-notes">
    <div id="note-13">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-13" class="journal-link">#13</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4433">Eric Mesa</a> <a title="15 May 2015 23:49" href="/projects/exiv2/activity?from=2015-05-15">over 6 years</a> ago
      <span id="journal-3714-private_notes" class=""></span>
    </h4>

    <div id="journal-3714-notes" class="wiki"><p>Alan Pater wrote:</p>


<blockquote><blockquote>

	<p>JPEG:<br /><a class="external" href="https://www.dropbox.com/s/l8rw3zpjgf599f7/Pots.jpg?dl=0">https://www.dropbox.com/s/l8rw3zpjgf599f7/Pots.jpg?dl=0</a></p>


</blockquote>

	<p>That JPEG file was created from the DNG using RawTherapee?</p>


</blockquote>

	<p>Correct!</p></div>
    </div>
  </div>
  
  <div id="change-3715" class="journal has-notes">
    <div id="note-14">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-14" class="journal-link">#14</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4433">Eric Mesa</a> <a title="15 May 2015 23:49" href="/projects/exiv2/activity?from=2015-05-15">over 6 years</a> ago
      <span id="journal-3715-private_notes" class=""></span>
    </h4>

    <div id="journal-3715-notes" class="wiki"><p>Alan Pater wrote:</p>


<blockquote><blockquote>

	<p>JPEG:<br /><a class="external" href="https://www.dropbox.com/s/l8rw3zpjgf599f7/Pots.jpg?dl=0">https://www.dropbox.com/s/l8rw3zpjgf599f7/Pots.jpg?dl=0</a></p>


</blockquote>

	<p>That JPEG file was created from the DNG using RawTherapee?</p>


</blockquote>

	<p>The Lightroom tags are from when I made the DNG</p></div>
    </div>
  </div>
  
  <div id="change-3716" class="journal has-notes">
    <div id="note-15">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-15" class="journal-link">#15</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="15 May 2015 23:56" href="/projects/exiv2/activity?from=2015-05-15">over 6 years</a> ago
      <span id="journal-3716-private_notes" class=""></span>
    </h4>

    <div id="journal-3716-notes" class="wiki"><p>Eric Mesa wrote:</p>


<blockquote>

	<p>Alan Pater wrote:</p>


<blockquote><blockquote>

	<p>JPEG:<br /><a class="external" href="https://www.dropbox.com/s/l8rw3zpjgf599f7/Pots.jpg?dl=0">https://www.dropbox.com/s/l8rw3zpjgf599f7/Pots.jpg?dl=0</a></p>


</blockquote>

	<p>That JPEG file was created from the DNG using RawTherapee?</p>


</blockquote>

	<p>Correct!</p>


</blockquote>

	<p>We might be looking at: <a class="external" href="https://code.google.com/p/rawtherapee/issues/detail?id=2323">https://code.google.com/p/rawtherapee/issues/detail?id=2323</a></p></div>
    </div>
  </div>
  
  <div id="change-3717" class="journal has-notes">
    <div id="note-16">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-16" class="journal-link">#16</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4433">Eric Mesa</a> <a title="15 May 2015 23:58" href="/projects/exiv2/activity?from=2015-05-15">over 6 years</a> ago
      <span id="journal-3717-private_notes" class=""></span>
    </h4>

    <div id="journal-3717-notes" class="wiki"><p>Eric Mesa wrote:</p>


<blockquote>

	<p>Alan Pater wrote:</p>


<blockquote><blockquote>

	<p>JPEG:<br /><a class="external" href="https://www.dropbox.com/s/l8rw3zpjgf599f7/Pots.jpg?dl=0">https://www.dropbox.com/s/l8rw3zpjgf599f7/Pots.jpg?dl=0</a></p>


</blockquote>

	<p>That JPEG file was created from the DNG using RawTherapee?</p>


</blockquote>

	<p>The Lightroom tags are from when I made the DNG</p>


</blockquote>

	<p>What's interesting is that since LR made the first tags, Digikam/Exiv2 put their tags in there too.</p></div>
    </div>
  </div>
  
  <div id="change-3718" class="journal has-notes">
    <div id="note-17">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-17" class="journal-link">#17</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="16 May 2015 00:03" href="/projects/exiv2/activity?from=2015-05-16">over 6 years</a> ago
      <span id="journal-3718-private_notes" class=""></span>
    </h4>

    <div id="journal-3718-notes" class="wiki"><p>Eric Mesa wrote:</p>


<blockquote><blockquote>

	<p>The Lightroom tags are from when I made the DNG</p>


</blockquote>

	<p>What's interesting is that since LR made the first tags, Digikam/Exiv2 put their tags in there too.</p>


</blockquote>

	<p>Yes, Digikam tries to be as interoperable as possible, mapping a wide variety of proprietary tags as well as following MWG guidelines. Exiv2 just provides the background functions to allow that to happen.</p></div>
    </div>
  </div>
  
  <div id="change-3720" class="journal has-notes">
    <div id="note-18">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-18" class="journal-link">#18</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4433">Eric Mesa</a> <a title="16 May 2015 00:20" href="/projects/exiv2/activity?from=2015-05-16">over 6 years</a> ago
      <span id="journal-3720-private_notes" class=""></span>
    </h4>

    <div id="journal-3720-notes" class="wiki"><p>Alan Pater wrote:</p>


<blockquote>

	<p>Eric Mesa wrote:</p>


<blockquote>

	<p>Alan Pater wrote:</p>


<blockquote><blockquote>

	<p>JPEG:<br /><a class="external" href="https://www.dropbox.com/s/l8rw3zpjgf599f7/Pots.jpg?dl=0">https://www.dropbox.com/s/l8rw3zpjgf599f7/Pots.jpg?dl=0</a></p>


</blockquote>

	<p>That JPEG file was created from the DNG using RawTherapee?</p>


</blockquote>

	<p>Correct!</p>


</blockquote>

	<p>We might be looking at: <a class="external" href="https://code.google.com/p/rawtherapee/issues/detail?id=2323">https://code.google.com/p/rawtherapee/issues/detail?id=2323</a></p>


</blockquote>

	<p>Certainly looks similar. I'll mention it on their bug forums.</p></div>
    </div>
  </div>
  
  <div id="change-4703" class="journal has-notes has-details">
    <div id="note-19">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-19" class="journal-link">#19</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Jan 2016 10:20" href="/projects/exiv2/activity?from=2016-01-14">almost 6 years</a> ago
      <span id="journal-4703-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>20</i></li>
       <li><strong>Estimated time</strong> set to <i>5.00 h</i></li>
    </ul>
    <div id="journal-4703-notes" class="wiki"><p>I'm not sure what this is about.</p>


	<p><a class="changeset" title="#1081  Added Cr2Image::printStructure()" href="/projects/exiv2/repository/exiv2/revisions/4184">r4184</a> I've submitted a change to src/cr2image.cpp to support options -pS, -pR, -pX, -pC which print the <strong>S</strong> imple Structure, <strong>R</strong> ecursive Structure, <strong>X</strong> MP and ICC <strong>C</strong> olor Profile, so now we can get the RAW XMP in the file:<pre>$ exiv2 -pX ~/MG.CR2
&lt;?xpacket begin="﻿" id="W5M0MpCehiHzreSzNTczkc9d"?&gt;
&lt;x:xmpmeta xmlns:x="adobe:ns:meta/" x:xmptk="XMP Core 4.4.0-Exiv2"&gt;
 &lt;rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"&gt;
  ...
 &lt;/rdf:RDF&gt;
&lt;/x:xmpmeta&gt;</pre>And -pR reveals something very interesting:<pre>1744 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pR ~/MG.CR2 | head -2 ; exiv2 -pR ~/MG.CR2|grep XMLPacket 
STRUCTURE OF TIFF FILE (II): /Users/rmills/MG.CR2
 address |    tag                           |      type |    count |   offset | value
     210 | 0x02bc XMLPacket                 |      BYTE |     4868 |      386 | &lt;?xpacket begin="..." id="W5M0Mp ...
$ </pre>There are 4868 bytes of XML within the Exif data.  I never knew this was possible.  However these the same bytes that we extract with -pX<pre>$ exiv2 -pX ~/MG.CR2 | wc  
     110     116    4868
$ </pre></p>


	<p>When you ran:</p>


<blockquote>

	<p>So I installed Exiv2 on my computer and here's the output: $ exiv2 _MG_3694.CR2<br />...<br />Exif comment : Leaves and Scarlett</p>


	<p>Not sure why it doesn't show the tag and title, but I can see them in Digicam</p>


</blockquote>

	<p>You'll have to use the option -pa (print all) to see all the metadata and there are 206 items: <pre>$ exiv2 -pa MG.CR2 | wc
     206    1765   17371
1700 rmills@rmillsmbp:~ $ </pre>When I look at the JPG image from dropbox, there is no metadata whatsoever.  I think Dropbox has removed the metadata.</p>


	<p>Can you help me to help you?  What is the question?</p></div>
    </div>
  </div>
  
  <div id="change-4704" class="journal has-notes">
    <div id="note-20">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-20" class="journal-link">#20</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Jan 2016 10:42" href="/projects/exiv2/activity?from=2016-01-14">almost 6 years</a> ago
      <span id="journal-4704-private_notes" class=""></span>
    </h4>

    <div id="journal-4704-notes" class="wiki"><p>Eric</p>


	<p>I've goofed up with Dropbox.  I'm right and wrong.</p>


	<p><em><strong>Right</strong></em> - the image displayed in the browser by dropbox (unspecified.jpeg) is a JPEG with no APP1 data segment.  Zapped. No metadata. <br /><em><strong>Wrong</strong></em> - when I click "download", I get the original JPEG with the metadata.</p>


	<p>I'm also surprised by the <em><strong>"Warning: Ignoring"</strong></em> messages.  I've never seen them before.<pre>$ exiv2 -pa ~/Downloads/Pots.jpg | wc
Warning: Ignoring IPTC information encoded in the Exif data.
Warning: Ignoring XMP information encoded in the Exif data.
      56     315    4252
$</pre>I didn't write exiv2, I'm the project's build engineer.  However I wrote -pS|X|C|R to learn more about how metadata is stored in images.</p>


	<p>I am really lost in this discussion about DigiKam, RawTherapee, DNGs, JPEG and CR2 files.  What is the question?</p></div>
    </div>
  </div>
  
  <div id="change-4705" class="journal has-notes">
    <div id="note-21">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-21" class="journal-link">#21</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="14 Jan 2016 13:54" href="/projects/exiv2/activity?from=2016-01-14">almost 6 years</a> ago
      <span id="journal-4705-private_notes" class=""></span>
    </h4>

    <div id="journal-4705-notes" class="wiki"><p>Robin, if I recall correctly, we are trying to print out all the Xmp.dc.* values that are embedded in Exif.Image.XMLPacket in the Pots.jpg file.</p>


	<p>How that XMP data got into Exif.Image.XMLPacket is what all the discussion about DigiKam, RawTherapee, DNGs, JPEG and CR2 is about.</p></div>
    </div>
  </div>
  
  <div id="change-4706" class="journal has-notes">
    <div id="note-22">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-22" class="journal-link">#22</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="14 Jan 2016 14:00" href="/projects/exiv2/activity?from=2016-01-14">almost 6 years</a> ago
      <span id="journal-4706-private_notes" class=""></span>
    </h4>

    <div id="journal-4706-notes" class="wiki"><p>The RawTherapee bug report has been moved to </p>
	<pre><code><a class="external" href="https://github.com/Beep6581/RawTherapee/issues/2307">https://github.com/Beep6581/RawTherapee/issues/2307</a></code></pre></div>
    </div>
  </div>
  
  <div id="change-4707" class="journal has-notes has-details">
    <div id="note-23">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-23" class="journal-link">#23</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Jan 2016 15:43" href="/projects/exiv2/activity?from=2016-01-14">almost 6 years</a> ago
      <span id="journal-4707-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Estimated time</strong> changed from <i>5.00 h</i> to <i>10.00 h</i></li>
    </ul>
    <div id="journal-4707-notes" class="wiki"><p>Ah, right!  Gaaazzzunk.  The Penny has Dropped!!!  Ching.</p>


	<p>There are two different file parsers in exiv2.  The ones written by Andreas and Brad and the ones I wrote which handle -pX, -pR, -pS, -pC.  Mine know about XMLPacket and I suspect that Andreas/Brad parsers don't.  However Pots.jpg has revealed an interesting bug in -pX which I'll fix this afternoon.  No problem.</p>


	<p>Then I'll have a sniff into the Andreas/Brad parser.  I'm sure it's broken in the same way which is:<br />a) XMP is normally stored in JPEGs in an APP1 segment<pre>$ exiv2 -pS Stonehenge.jpg 
STRUCTURE OF JPEG FILE: Stonehenge.jpg
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xe1 APP1  |   15288 | Exif..II*......................
   15294 | 0xe1 APP1  |    2610 | http://ns.adobe.com/xap/1.0/.&lt;?x
   17906 | 0xed APP13 |      96 | Photoshop 3.0.8BIM.......'.....
   18004 | 0xe2 APP2  |    4094 | MPF.II*...............0100.....
   22100 | 0xdb DQT   |     132 
   22234 | 0xc0 SOF0  |      17 
   22253 | 0xc4 DHT   |     418 
   22673 | 0xda SOS   |      12 
$ </pre>XMP is normally stored in an XMLPacket in a Tiff:<pre>$ exiv2 -pS Reagan.tiff 
STRUCTURE OF TIFF FILE (MM): Reagan.tiff
 address |    tag                           |      type |    count |   offset | value
...
 8619248 | 0x02bc XMLPacket                 |      BYTE |     3686 |  8621334 | &lt;x:xmpmeta xmlns:x="adobe:ns:met ...
 8619260 | 0x83bb IPTCNAA                   | UNDEFINED |      925 |  8620408 |  ...
 8619272 | 0x8769 ExifTag                   |      LONG |        1 |        8 | 8
 8619284 | 0x8773 InterColorProfile         | UNDEFINED |     3144 |  8625020 |  ...
...
END Reagan.tiff
$ </pre>Pots.jpg doesn't have an APP1/XMP packet:<pre>$ exiv2 -pS ~/Downloads/Pots.jpg 
STRUCTURE OF JPEG FILE: /Users/rmills/Downloads/Pots.jpg
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xe1 APP1  |    8548 | Exif..II*...............:......
    8554 | 0xe2 APP2  |   25588 | ICC_PROFILE.....c.lcms.0..mntrRG
   34144 | 0xdb DQT   |      67 
   34213 | 0xdb DQT   |      67 
   34282 | 0xc0 SOF0  |      17 
   34301 | 0xc4 DHT   |      29 
   34332 | 0xc4 DHT   |      85 
   34419 | 0xc4 DHT   |      28 
   34449 | 0xc4 DHT   |      72 
   34523 | 0xda SOS   |      12 
$ </pre>It does however have an XMLPacket embedded in the exif data (which is a TIFF formatted data-structure).<pre>$ exiv2 -pR ~/Downloads/Pots.jpg 
STRUCTURE OF JPEG FILE: /Users/rmills/Downloads/Pots.jpg
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xe1 APP1  |    8548 | Exif..II*...............:......
  STRUCTURE OF TIFF FILE (II): MemIo
   address |    tag                           |      type |    count |   offset | value
        10 | 0x0100 ImageWidth                |      LONG |        1 |     3898 | 3898
        22 | 0x0101 ImageLength               |      LONG |        1 |     2594 | 2594
       ....
       214 | 0x014a SubIFDs                   |      LONG |        5 |     7972 | 7992 8022 8028 8034 8040
       226 | 0x02bc XMLPacket                 |      BYTE |     7246 |      468 | &lt;?xpacket begin="..." id="W5M0Mp ...
       ....
       274 | 0x83bb IPTCNAA                   |      LONG |       25 |     7802 | 5898524 1193614083 4260380 1734960135 1835092841 ...
       286 | 0x8769 ExifTag                   |      LONG |        1 |     8046 | 8046
    STRUCTURE OF TIFF FILE (II): MemIo
     address |    tag                           |      type |    count |   offset | value
        8048 | 0x829a ExposureTime              |  RATIONAL |        1 |     8352 | 8352/0
        ....
        8336 | 0xa434 LensModel                 |     ASCII |       13 |     8526 | EF50mm f/1.8
    END MemIo
       298 | 0x9211 ImageNumber               |      LONG |        1 |       48 | 48
       ....
       346 | 0xc65d RawDataUniqueID           |      BYTE |       16 |     7956 | .............6.7
  END MemIo
    8554 | 0xe2 APP2  |   25588 | ICC_PROFILE.....c.lcms.0..mntrRG
....
$</pre>I suspect this is violation of the XMP/Embedding Specification <a class="external" href="http://www.adobe.com/content/dam/Adobe/en/devnet/xmp/pdfs/XMPSpecificationPart3.pdf">http://www.adobe.com/content/dam/Adobe/en/devnet/xmp/pdfs/XMPSpecificationPart3.pdf</a>  Like many Adobe Specs, the document is unreadably boring, however it will be 100% accurate and comprehensive.  I'm going to:</p>


	<p>1) Take the dog for a walk<br />2) Look at <a class="external" href="http://www.adobe.com/content/dam/Adobe/en/devnet/xmp/pdfs/XMPSpecificationPart3.pdf">http://www.adobe.com/content/dam/Adobe/en/devnet/xmp/pdfs/XMPSpecificationPart3.pdf</a><br />3) Fix my parser to handle Pots.jpg<br />4) Have a read into the Andreas/Brad code.  I'm not promising to change that code, however I will investigate.</p>


	<p>This team work stuff works.  Thank you for the clarification.</p></div>
    </div>
  </div>
  
  <div id="change-4708" class="journal has-notes has-details">
    <div id="note-24">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-24" class="journal-link">#24</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Jan 2016 17:02" href="/projects/exiv2/activity?from=2016-01-14">almost 6 years</a> ago
      <span id="journal-4708-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/884">XMPSpecPart3Page75.png</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/884/XMPSpecPart3Page75.png">XMPSpecPart3Page75.png</a> added</li>
       <li><strong>% Done</strong> changed from <i>20</i> to <i>100</i></li>
       <li><strong>Estimated time</strong> changed from <i>10.00 h</i> to <i>3.00 h</i></li>
    </ul>
    <div id="journal-4708-notes" class="wiki"><p>Eureka!  This is a clear violation of <a class="external" href="http://www.adobe.com/content/dam/Adobe/en/devnet/xmp/pdfs/XMPSpecificationPart3.pdf">http://www.adobe.com/content/dam/Adobe/en/devnet/xmp/pdfs/XMPSpecificationPart3.pdf</a> <br />On page 75 it says:</p>


	<p><strong>4.3.1 Metadata storage in JPEG files</strong><br />JPEG files, including Exif JPEG, use a mixture of native marker segments, TIFF tags, and Photoshop image resources.</p>


	<p>Metadata can be found in 3 APPn marker segments:</p>


	<table style="margin-left:50px;border:4px solid #628DB6;background:#ffffdd;">
		<tr>
			<td style="border:3px solid #628DB6;text-align:center;" colspan="3"><strong>Table 47 — APPn marker segments containing XMP metadata</strong> </td>
		</tr>
		<tr>
			<td style="border:3px solid #628DB6;text-align:center;"> <strong>Marker</strong> </td>
			<td style="border:3px solid #628DB6;text-align:center;"><strong>Signature, including NULLs</strong> </td>
			<td style="border:3px solid #628DB6;text-align:center;"><strong>Usage</strong> </td>
		</tr>
		<tr>
			<td> APP1 </td>
			<td> "Exif\0\0” </td>
			<td> TIFF and Exif (2 NULLs) </td>
		</tr>
		<tr>
			<td> APP1 </td>
			<td> "http://ns.adobe.com/xap/1.0/\0” </td>
			<td> XMP </td>
		</tr>
		<tr>
			<td> APP13 </td>
			<td> "Photoshop 3.0\0” </td>
			<td> Photoshop image resources </td>
		</tr>
	</table>




	<p>The TIFF in the <strong>Exif APP1</strong> marker segment <em><strong>should not contain tag 700 (XMP), tag 33723 (IPTC), or tag 34377 (Photoshop image resources)</strong></em>. There should be only one copy of the IPTC in a JPEG file, in Photoshop image resource 1028 (ignoring the possible Mac OS ANPA 10000 resource).</p>


	<p><strong>Conclusion:</strong><br />I don't intend to do further work on this.  Somebody will have to swim upstream to determine who wrote this illegal file.  I don't believe it was written by Exiv2.</p>


	<p><img src="/attachments/download/884/XMPSpecPart3Page75.png" alt="" /></p></div>
    </div>
  </div>
  
  <div id="change-4725" class="journal has-notes">
    <div id="note-25">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-25" class="journal-link">#25</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4433">Eric Mesa</a> <a title="15 Jan 2016 02:35" href="/projects/exiv2/activity?from=2016-01-15">almost 6 years</a> ago
      <span id="journal-4725-private_notes" class=""></span>
    </h4>

    <div id="journal-4725-notes" class="wiki"><p>"I don't believe it was written by Exiv2."</p>


	<p>Hey,</p>


	<p>I'm the OP and I was following your progress today. I created the file with Digikam and they use Exiv2 for their metadata. Could they be using Exiv2 incorrectly or something?</p></div>
    </div>
  </div>
  
  <div id="change-4726" class="journal has-notes has-details">
    <div id="note-26">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-26" class="journal-link">#26</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Jan 2016 05:39" href="/projects/exiv2/activity?from=2016-01-15">almost 6 years</a> ago
      <span id="journal-4726-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Closed</i></li>
    </ul>
    <div id="journal-4726-notes" class="wiki"><p>OP?  Old Person?</p>


	<p>This bug report is in-penetrable. What does this mean (second sentence of your issue report):</p>


<blockquote>

	<p>Processing is done and a JPEG is produced:</p>


</blockquote>

	<p>I'm closing this.  Please discuss this with DigiKam.  I can only deal with issues which can be demonstrated/reproduced with the sample applications distributed with our code.</p></div>
    </div>
  </div>
  
  <div id="change-4727" class="journal has-notes has-details">
    <div id="note-27">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-27" class="journal-link">#27</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Jan 2016 08:59" href="/projects/exiv2/activity?from=2016-01-15">almost 6 years</a> ago
      <span id="journal-4727-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Closed</i> to <i>Assigned</i></li>
       <li><strong>% Done</strong> changed from <i>100</i> to <i>30</i></li>
       <li><strong>Estimated time</strong> changed from <i>3.00 h</i> to <i>10.00 h</i></li>
    </ul>
    <div id="journal-4727-notes" class="wiki"><p>I'm reopening this issue.  We need to painstakingly investigate what has happened here.  We can't guess.</p>


	<p>I apologise for being so cross.  Jumping to the conclusion that Exiv2 is 100% to blame is not helpful.  It would also be constructive for you to thank me for the effort I have invested into your issue.</p>


	<p>Let's go back to the start. I've download the original CR2 and JPEG files as MG.CR2 and MG.jpg.  There is an XMLPacket in the CR2. <pre>$ exiv2 -pX MG.CR2 | xmllint --pretty 1 -
&lt;?xml version="1.0"?&gt;
&lt;?xpacket begin="﻿" id="W5M0MpCehiHzreSzNTczkc9d"?&gt;
&lt;x:xmpmeta xmlns:x="adobe:ns:meta/" x:xmptk="XMP Core 4.4.0-Exiv2"&gt;
  &lt;rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"&gt;
    &lt;rdf:Description xmlns:tiff="http://ns.adobe.com/tiff/1.0/" ...&gt;
      &lt;tiff:ImageDescription&gt;
        &lt;rdf:Alt&gt;
          &lt;rdf:li xml:lang="x-default"&gt;Leaves and Scarlett&lt;/rdf:li&gt;
        &lt;/rdf:Alt&gt;
      &lt;/tiff:ImageDescription&gt;
      &lt;exif:UserComment&gt;
        &lt;rdf:Alt&gt;
          &lt;rdf:li xml:lang="x-default"&gt;Leaves and Scarlett&lt;/rdf:li&gt;
        &lt;/rdf:Alt&gt;
      &lt;/exif:UserComment&gt;
      &lt;digiKam:TagsList&gt;
        &lt;rdf:Seq&gt;
          &lt;rdf:li&gt;Scarlett&lt;/rdf:li&gt;
        &lt;/rdf:Seq&gt;
      &lt;/digiKam:TagsList&gt;
      &lt;digiKam:CaptionsAuthorNames&gt;
        &lt;rdf:Alt&gt;
          &lt;rdf:li xml:lang="x-default"/&gt;
        &lt;/rdf:Alt&gt;
      &lt;/digiKam:CaptionsAuthorNames&gt;
      &lt;digiKam:CaptionsDateTimeStamps&gt;
        &lt;rdf:Alt&gt;
          &lt;rdf:li xml:lang="x-default"&gt;2015-05-13T20:33:02&lt;/rdf:li&gt;
        &lt;/rdf:Alt&gt;
      &lt;/digiKam:CaptionsDateTimeStamps&gt;
      &lt;mwg-rs:Regions rdf:parseType="Resource"&gt;
        &lt;mwg-rs:RegionList&gt;
          &lt;rdf:Bag/&gt;
        &lt;/mwg-rs:RegionList&gt;
      &lt;/mwg-rs:Regions&gt;
      &lt;MP:RegionInfo rdf:parseType="Resource"&gt;
        &lt;MPRI:Regions&gt;
          &lt;rdf:Bag/&gt;
        &lt;/MPRI:Regions&gt;
      &lt;/MP:RegionInfo&gt;
      &lt;MicrosoftPhoto:LastKeywordXMP&gt;
        &lt;rdf:Bag&gt;
          &lt;rdf:li&gt;Scarlett&lt;/rdf:li&gt;
        &lt;/rdf:Bag&gt;
      &lt;/MicrosoftPhoto:LastKeywordXMP&gt;
      &lt;lr:hierarchicalSubject&gt;
        &lt;rdf:Bag&gt;
          &lt;rdf:li&gt;Scarlett&lt;/rdf:li&gt;
        &lt;/rdf:Bag&gt;
      &lt;/lr:hierarchicalSubject&gt;
      &lt;dc:title&gt;
        &lt;rdf:Alt&gt;
          &lt;rdf:li xml:lang="x-default"&gt;Scarlett Playing with Leaves&lt;/rdf:li&gt;
        &lt;/rdf:Alt&gt;
      &lt;/dc:title&gt;
      &lt;dc:description&gt;
        &lt;rdf:Alt&gt;
          &lt;rdf:li xml:lang="x-default"&gt;Leaves and Scarlett&lt;/rdf:li&gt;
        &lt;/rdf:Alt&gt;
      &lt;/dc:description&gt;
      &lt;dc:subject&gt;
        &lt;rdf:Bag&gt;
          &lt;rdf:li&gt;Scarlett&lt;/rdf:li&gt;
        &lt;/rdf:Bag&gt;
      &lt;/dc:subject&gt;
    &lt;/rdf:Description&gt;
  &lt;/rdf:RDF&gt;
&lt;/x:xmpmeta&gt;
&lt;?xpacket end="w"?&gt;
$</pre>And this is identified by exiv2:<pre>$ exiv2 -px MG.CR2
Xmp.tiff.Software                            XmpText    13  digiKam-4.9.0
Xmp.tiff.DateTime                            XmpText    19  2015-05-13T17:08:52
Xmp.tiff.ImageDescription                    LangAlt     1  lang="x-default" Leaves and Scarlett
Xmp.xmp.CreatorTool                          XmpText    13  digiKam-4.9.0
Xmp.xmp.CreateDate                           XmpText    19  2015-05-13T17:08:52
Xmp.xmp.MetadataDate                         XmpText    19  2015-05-13T17:08:52
Xmp.xmp.ModifyDate                           XmpText    19  2015-05-13T17:08:52
Xmp.exif.DateTimeOriginal                    XmpText    19  2015:05:13 17:08:52
Xmp.exif.UserComment                         LangAlt     1  lang="x-default" Leaves and Scarlett
Xmp.photoshop.DateCreated                    XmpText    19  2015-05-13T17:08:52
Xmp.photoshop.Urgency                        XmpText     1  0
Xmp.digiKam.PickLabel                        XmpText     1  0
Xmp.digiKam.ColorLabel                       XmpText     1  0
Xmp.digiKam.TagsList                         XmpSeq      1  Scarlett
Xmp.digiKam.CaptionsAuthorNames              LangAlt     1  lang="x-default" 
Xmp.digiKam.CaptionsDateTimeStamps           LangAlt     1  lang="x-default" 2015-05-13T20:33:02
Xmp.mwg-rs.Regions                           XmpText     0  type="Struct" 
Xmp.mwg-rs.Regions/mwg-rs:RegionList         XmpBag      0  
Xmp.MP.RegionInfo                            XmpText     0  type="Struct" 
Xmp.MP.RegionInfo/MPRI:Regions               XmpBag      0  
Xmp.MicrosoftPhoto.LastKeywordXMP            XmpBag      1  Scarlett
Xmp.lr.hierarchicalSubject                   XmpBag      1  Scarlett
Xmp.dc.title                                 LangAlt     1  lang="x-default" Scarlett Playing with Leaves
Xmp.dc.description                           LangAlt     1  lang="x-default" Leaves and Scarlett
Xmp.dc.subject                               XmpBag      1  Scarlett
1865 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>This is not the original file from the Camera.  It has already been modified by DigiKam - as you can see in the Xmp.xmp.CreatorTool.</p>


	<p>Next we have the JPEG.  Which appears to have NO XMP data at all:<pre>$ exiv2 -px MG.JPG
Warning: Ignoring IPTC information encoded in the Exif data.
Warning: Ignoring XMP information encoded in the Exif data.
$ </pre>It has no APP1/XMP segment as required by the Adobe Spec: <pre>$ exiv2 -pS MG.jpg 
STRUCTURE OF JPEG FILE: MG.jpg
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xe1 APP1  |   32716 | Exif..II*...............:......
   32722 | 0xe2 APP2  |   25588 | ICC_PROFILE.....c.lcms.0..mntrRG
   58312 | 0xdb DQT   |      67 
   58381 | 0xdb DQT   |      67 
   58450 | 0xc0 SOF0  |      17 
   58469 | 0xc4 DHT   |      29 
   58500 | 0xc4 DHT   |      77 
   58579 | 0xc4 DHT   |      28 
   58609 | 0xc4 DHT   |      70 
   58681 | 0xda SOS   |      12 
$</pre>It has no XMLPacket (as demonstrated by Pots.jpg). <pre>$ exiv2 -pR MG.jpg | head -2 ; exiv2 -pR MG.jpg | grep -i xmp
STRUCTURE OF JPEG FILE: MG.jpg
 address | marker     | length  | data
$ </pre></p>


	<p><strong>Conclusion</strong></p>


	<p>I don't know how the CR2 was converted into a JPEG.  To my knowledge, Exiv2 does not do image format conversion.  The XMP has been lost in that conversion.  I recommend that you discuss this with DigiKam as I don't believe we performed that conversion.</p>


	<p>The discoveries about Pots.jpg are interesting, however I don't understand the genesis or relevance of that file to the discussion.</p>


	<p>Please understand that it's hard for me to deal with bugs that occur in applications that use Exiv2.  It's easy for DigiKam/Gimp/Geeqie/gThumb and others to say "Metadata issue, must be Exiv2".  It's seldom Exiv2's issue.  However I will investigate when the issue is condensed and reproducible using our sample applications.  Sure that's hard work to isolate and identify the issue.  I can't undertake that effort without a lot more input including version and platform.  And please understand that I don't use DigiKam/Gimp... so it takes a lot of effort for me to reproduce the application behaviour.  It only makes sense to ask the engineers at DigiKam/Gimp... to do that work.  I will help you, as I have above, to give you the analysis to present your case to DigiKam/Gimp...  The essential information is here.  Let me summarise:</p>


	<p>1) You have a .CR2 which contains metadata.  That metadata is correctly identified by Exiv2. <em><strong>snipp from above</strong></em><br />2) You have saved the image as a JPEG.  The file no longer has XMP metadata <em><strong>snipp from above</strong></em></p>


	<p>I will investigate the meaning of the messages: <pre>Warning: Ignoring IPTC information encoded in the Exif data.
Warning: Ignoring XMP information encoded in the Exif data.</pre>I didn't write the code that generates those messages, however I'll step the code in the debugger and discover what this is about.</p></div>
    </div>
  </div>
  
  <div id="change-4728" class="journal has-details">
    <div id="note-28">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-28" class="journal-link">#28</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Jan 2016 09:33" href="/projects/exiv2/activity?from=2016-01-15">almost 6 years</a> ago
      <span id="journal-4728-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>30</i> to <i>40</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-4729" class="journal has-notes has-details">
    <div id="note-29">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-29" class="journal-link">#29</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Jan 2016 10:06" href="/projects/exiv2/activity?from=2016-01-15">almost 6 years</a> ago
      <span id="journal-4729-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>40</i> to <i>50</i></li>
    </ul>
    <div id="journal-4729-notes" class="wiki"><p>I've thought (over breakfast) of how Exiv2 could be responsible for the loss of metadata.  I won't explain my thoughts in detail because I have explored and <em><strong>eliminated</strong></em> my idea.  To convert an image to another format, I believe DigiKam has to:</p>


	<p>1) Create an empty "container" of the required format<br />2) Copy the metadata from the source to the destination <br />3) Copy the image</p>


	<p>We have an empty JPG in our test suite and the sample application <em><strong>metacopy</strong></em> can perform the metadata copy.  I've reproduced steps 1 and 2 as follows:<pre>$ cp test/data/exiv2-empty.jpg .
$ bin/metacopy -a MG.CR2 exiv2-empty.jpg 
Warning: Exif tag Exif.Photo.MakerNote not encoded
Warning: Exif tag Exif.Canon.0x4002 not encoded
Warning: Exif tag Exif.Canon.0x4005 not encoded
$ exiv2 -px exiv2-empty.jpg 
Xmp.tiff.Software                            XmpText    13  digiKam-4.9.0
Xmp.tiff.DateTime                            XmpText    19  2015-05-13T17:08:52
Xmp.tiff.ImageDescription                    LangAlt     1  lang="x-default" Leaves and Scarlett
Xmp.xmp.CreatorTool                          XmpText    13  digiKam-4.9.0
Xmp.xmp.CreateDate                           XmpText    19  2015-05-13T17:08:52
Xmp.xmp.MetadataDate                         XmpText    19  2015-05-13T17:08:52
Xmp.xmp.ModifyDate                           XmpText    19  2015-05-13T17:08:52
Xmp.exif.DateTimeOriginal                    XmpText    19  2015:05:13 17:08:52
Xmp.exif.UserComment                         LangAlt     1  lang="x-default" Leaves and Scarlett
Xmp.photoshop.DateCreated                    XmpText    19  2015-05-13T17:08:52
Xmp.photoshop.Urgency                        XmpText     1  0
Xmp.digiKam.PickLabel                        XmpText     1  0
Xmp.digiKam.ColorLabel                       XmpText     1  0
Xmp.digiKam.TagsList                         XmpSeq      1  Scarlett
Xmp.digiKam.CaptionsDateTimeStamps           LangAlt     1  lang="x-default" 2015-05-13T20:33:02
Xmp.mwg-rs.Regions                           XmpText     0  type="Struct" 
Xmp.mwg-rs.Regions/mwg-rs:RegionList         XmpBag      0  
Xmp.MP.RegionInfo                            XmpText     0  type="Struct" 
Xmp.MP.RegionInfo/MPRI:Regions               XmpBag      0  
Xmp.MicrosoftPhoto.LastKeywordXMP            XmpBag      1  Scarlett
Xmp.lr.hierarchicalSubject                   XmpBag      1  Scarlett
Xmp.dc.title                                 LangAlt     1  lang="x-default" Scarlett Playing with Leaves
Xmp.dc.description                           LangAlt     1  lang="x-default" Leaves and Scarlett
Xmp.dc.subject                               XmpBag      1  Scarlett
$ </pre>The new file has an APP1/xmp segment and does not have a XMLPacket. <pre>$ exiv2 -pS empty.jpg 
STRUCTURE OF JPEG FILE: empty.jpg
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xe0 APP0  |      16 | JFIF.....H.H....
      22 | 0xe1 APP1  |    2386 | http://ns.adobe.com/xap/1.0/.&lt;?x
    2410 | 0xdb DQT   |      67 
    2479 | 0xdb DQT   |      67 
    2548 | 0xc0 SOF0  |      17 
    2567 | 0xc4 DHT   |      28 
    2597 | 0xc4 DHT   |      60 
    2659 | 0xc4 DHT   |      26 
    2687 | 0xc4 DHT   |      37 
    2726 | 0xda SOS   |      12 
$ exiv2 -pR empty.jpg | grep -i XMP 
$ </pre>This seems correct to me.  I don't know how DigiKam added the metadata during the conversion from CR2 to JPEG - however it doesn't appear to use our recommended code provided in samples/metacopy.cpp as MG.jpg does not have an APP1/XMP data segment:<pre>1885 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pS MG.jpg 
STRUCTURE OF JPEG FILE: MG.jpg
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xe1 APP1  |   32716 | Exif..II*...............:......
   32722 | 0xe2 APP2  |   25588 | ICC_PROFILE.....c.lcms.0..mntrRG
   58312 | 0xdb DQT   |      67 
   58381 | 0xdb DQT   |      67 
   58450 | 0xc0 SOF0  |      17 
   58469 | 0xc4 DHT   |      29 
   58500 | 0xc4 DHT   |      77 
   58579 | 0xc4 DHT   |      28 
   58609 | 0xc4 DHT   |      70 
   58681 | 0xda SOS   |      12 </pre>It does however have an ICC profile.  I'm adding ICC support in v0.26 and when that is finished, metacopy will be updated appropriately.  Until v0.26 ships, Exiv2 does not provide support for ICC profiles.  So there is strong evidence that DigiKam has used some other software to do the image conversion and lost the XMP in the process.</p></div>
    </div>
  </div>
  
  <div id="change-4733" class="journal has-notes">
    <div id="note-30">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-30" class="journal-link">#30</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="15 Jan 2016 12:30" href="/projects/exiv2/activity?from=2016-01-15">almost 6 years</a> ago
      <span id="journal-4733-private_notes" class=""></span>
    </h4>

    <div id="journal-4733-notes" class="wiki"><p>My understanding is that RawTherapee was used to convert the raw files to jpeg. And that RawTherapee wrongly places the XMP data in XMLPacket. RawTherapee needs to stop doing that. <a class="external" href="https://github.com/Beep6581/RawTherapee/issues/2307">https://github.com/Beep6581/RawTherapee/issues/2307</a></p>


	<p>The question for exiv2 is if we can get inside that XMLPacket and return the XMP values to the user.</p></div>
    </div>
  </div>
  
  <div id="change-4734" class="journal has-notes has-details">
    <div id="note-31">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-31" class="journal-link">#31</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="15 Jan 2016 12:38" href="/projects/exiv2/activity?from=2016-01-15">almost 6 years</a> ago
      <span id="journal-4734-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Tracker</strong> changed from <i>Bug</i> to <i>Feature</i></li>
       <li><strong>Subject</strong> changed from <i>Unable to read XMP from CR2 raw file when stored in XMLPacket</i> to <i>Read XMP values from CR2 raw file when stored in XMLPacket</i></li>
    </ul>
    <div id="journal-4734-notes" class="wiki"><p>I think this is a feature request rather then a bug in exiv2.</p></div>
    </div>
  </div>
  
  <div id="change-4735" class="journal has-notes">
    <div id="note-32">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-32" class="journal-link">#32</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Jan 2016 13:21" href="/projects/exiv2/activity?from=2016-01-15">almost 6 years</a> ago
      <span id="journal-4735-private_notes" class=""></span>
    </h4>

    <div id="journal-4735-notes" class="wiki"><p>For certain this is not a bug in Exiv2.  I almost understand this now.  I thought DigiKam was involved.  It's RawTherapee that is the culprit.  He has converted the file to JPEG and preserved the XMLPacket.  That's a violation of the Adobe spec.  They should put the XMP into the APP1 segment of the JPEG.</p>


	<p>And I've realised that I used -pR incorrectly on MG.jpg to grep for xmp.  It should be xml<pre>$ exiv2 -pR MG.jpg | head -1 ; exiv2 -pR MG.jpg | grep offset ; exiv2 -pR MG.jpg | grep XML  
STRUCTURE OF JPEG FILE: MG.jpg
   address |    tag            | type |    count |   offset | value
       202 | 0x02bc XMLPacket  | BYTE |     4868 |      344 | &lt;?xpacket begin="..." id="W5M0Mp ...
$</pre>This is the behaviour observed in Pots.jpg.  We're on the same page now.  Phew!</p>


	<p>Let's discuss the following proposal:</p>


	<p><em>I can easily get -pX to read the XMLPacket.  I haven't investigated the Andreas/Brad file parsers, however I think it's probably easy.</em></p>


	<p><em>However, if we rescue the situation, there will be no pressure on RawTherapee to fix their code.  We are blessing a violation of the Adobe spec.  You've got a tough sell to persuade me to do that.</em></p>


	<p><em>We could add an option to exiv2 --fixXMLPacket to repair the JPEG.  We have a precedent for this when I agreed to implement -dI to fix files with multiple PhotoShop APP13 segments. <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Add options -pS and -dI to application exiv2 (Closed)" href="/issues/922">#922</a>  I still haven't dealt with -dI yet and maybe we can implement both as the single option --fixJPEG.  I don't believe that is blessing a spec violation - quite the opposite.  We are providing a utility to enforce the specification.  The user has to run the command, we shouldn't do this automatically.</em></p>


	<p><em>If we decide to adopt this solution, I don't need to look at the Andreas/Brad file parsers and they will continue to issue their warnings.  This is good.  Andreas and Brad have done a great job and I will only modify their code if I find a bug.</em></p>


	<p><em>I don't think we should be in hurry to implement this.  Perhaps some pressure can be applied to RawTherapee.  On this evidence, they don't appear to be using Exiv2.  I'm willing to work with them to integrate libexiv2 into their product.  However I don't have time to work with them until v0.26 is code-complete in April.</em></p>


	<p>Thoughts?</p></div>
    </div>
  </div>
  
  <div id="change-4736" class="journal has-notes">
    <div id="note-33">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-33" class="journal-link">#33</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="15 Jan 2016 14:28" href="/projects/exiv2/activity?from=2016-01-15">almost 6 years</a> ago
      <span id="journal-4736-private_notes" class=""></span>
    </h4>

    <div id="journal-4736-notes" class="wiki"><p>Eric, please work with the RawTherapee folks to fix this on their end.</p>


	<p>Robin, for this feature to be useful to users on Digikam and other existing applications, it needs to work with the default exiv2 command line. "exiv2 pots.jpg" should display the XMP values hidden in XMLPacket.</p>


	<p>Fixing data errors in broken image files is another can of worms. If exiv2 can provide a way to read the data, other utilities can use that to fix broken files. I don't think exiv2 needs that feature internally when it can be provided by an external program.</p></div>
    </div>
  </div>
  
  <div id="change-4737" class="journal has-notes">
    <div id="note-34">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-34" class="journal-link">#34</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Jan 2016 15:18" href="/projects/exiv2/activity?from=2016-01-15">almost 6 years</a> ago
      <span id="journal-4737-private_notes" class=""></span>
    </h4>

    <div id="journal-4737-notes" class="wiki"><p>One thing is 100% certain.  There is no bug in Exiv2.  The behaviour of our code is correct.</p>


	<p>If we read that file and silently forgive the error, RawTherapee will do nothing about their bug.</p>


	<p>There is a second spec violation.  IPTC should be stored in the APP13/Photoshop segment of a JPEG.  IPTC data should not be stored in an IPTCNAA tag within the Exif data:<pre>$ exiv2 -pR MG.jpg | head -1 ; exiv2 -pR MG.jpg | grep address ; exiv2 -pR MG.jpg | grep IPTC
STRUCTURE OF JPEG FILE: MG.jpg
   address |    tag          | type | count |   offset | value
       214 | 0x83bb IPTCNAA  | LONG |    33 |     5212 | 5898524 1193614083 4260380 1734960135 1835092841 ...
$ </pre>The Andreas/Brad file parser correctly issues warning and ignores those tags.<pre>Warning: Ignoring IPTC information encoded in the Exif data.
Warning: Ignoring XMP information encoded in the Exif data.</pre>Here's a new proposal:</p>


	<p><em>1) We close this issue.</em><br /><em>2) We open a new feature request and set the Target version to 1.0</em><br /><em>This new issue can skip most of the detail discussed here (however the new issue should be linked to this).</em></p>


	<p>I've asked Andreas to review all 1.0 issues before we ship v0.26.  We can add Phil as a watcher on the new issue.  Phil is really smart and will say something interesting and clever about this.</p></div>
    </div>
  </div>
  
  <div id="change-4738" class="journal has-notes has-details">
    <div id="note-35">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-35" class="journal-link">#35</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Jan 2016 16:52" href="/projects/exiv2/activity?from=2016-01-15">almost 6 years</a> ago
      <span id="journal-4738-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Tracker</strong> changed from <i>Feature</i> to <i>Bug</i></li>
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Closed</i></li>
       <li><strong>% Done</strong> changed from <i>50</i> to <i>100</i></li>
    </ul>
    <div id="journal-4738-notes" class="wiki"><p>I'm going to close this.  It's not a bug.</p>


	<p>I'll open a new issue to consider reading the illegal XMP and IPTC data from the Tiff-Encoded Exif.  The target for that issue will be 1.0.  So it will be reviewed as part of the v0.26 release process and a decision made about the best course of action.</p></div>
    </div>
  </div>
  
  <div id="change-4743" class="journal has-notes has-details">
    <div id="note-36">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-36" class="journal-link">#36</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="16 Jan 2016 06:49" href="/projects/exiv2/activity?from=2016-01-16">almost 6 years</a> ago
      <span id="journal-4743-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Assignee</strong> changed from <i>Robin Mills</i> to <i>Alan Pater</i></li>
    </ul>
    <div id="journal-4743-notes" class="wiki"><p>I'm assigned this to Alan.  Alan's the guy who really understood this issue and dealt with RawTherapee.  Great Job, Alan.</p></div>
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1081.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1081.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
