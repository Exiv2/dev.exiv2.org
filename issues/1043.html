<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #1043: pyexiv2 fails on cifs shares on an Ubuntu client - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="tfoEKaMVnOeHKzXjYHwcOtu8YOne652rbQagMjUdgBVXt6/G0W9Q59JPKu/fqxAJ5C40kC8IPBGQJjC6diRneg==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #1043: pyexiv2 fails on cifs shares on an Ubuntu client" href="https://dev.exiv2.org/issues/1043.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #1043</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>pyexiv2 fails on cifs shares on an Ubuntu client</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/4381">thoralf schulze</a> <a title="19 Mar 2015 09:41" href="/projects/exiv2/activity?from=2015-03-19">over 6 years</a> ago.
        Updated <a title="07 May 2016 13:13" href="/projects/exiv2/activity?from=2016-05-07">over 5 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/360">Thomas Beutlich</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">basicio</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="17 May 2015" href="/versions/51">0.25</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">19 Mar 2015</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value"></div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>hi,</p>


	<p>i got referred here by olivier tilloy, the maintainer of pyexiv2 - the python bindings for exiv2.ยน</p>


	<p>while playing around with pyexiv2, i ran into a strang bug when writing metadata with pyexiv's write.metadata() method. this method is just a really thin wrapper around exiv2's writeMetadata(), so the issue at hand might actually be caused by exiv2 itself.</p>


	<p>okay, on to the bug: writing exif metadata to a jpeg file hangs if and only if:<br />- the file to be written resides on a cifs share mounted from a win2k8 server<br />- the jpeg file is larger than ~100kb</p>


	<p>everythings works flawlessly if:<br />- $file is bigger than 100k and resides on a cifs share served by a samba server or a local file system<br />- $file is smaller than 100k and resides on either cifs share<br />- $file is bigger than 100k, resides on a cifs share served by the infamous win2k8 server and the python process executing the script is being strace'd<br />- $file is bigger than 100k, resides on a cifs share served by the infamous win2k8 server and the share is mounted with mount.cifs' "cache=none"-option</p>


	<p>please let me know if there is anything i can do to help to resolve this issue</p>


	<p>ยน - please see <a class="external" href="https://bugs.launchpad.net/pyexiv2/+bug/1433747">https://bugs.launchpad.net/pyexiv2/+bug/1433747</a> for details</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/736">Anniversary.jpg</a>    <span class="size">(67.5 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/736/Anniversary.jpg">Anniversary.jpg</a>  </td>
  <td></td>
  <td>
      <span class="author">Robin Mills, 24 Mar 2015 12:05</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/740">T1043.patch</a>    <span class="size">(4.23 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/740/T1043.patch">T1043.patch</a>  </td>
  <td></td>
  <td>
      <span class="author">Thomas Beutlich, 24 Mar 2015 22:14</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/745">diff_thoralf.diff</a>    <span class="size">(3.05 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/745/diff_thoralf.diff">diff_thoralf.diff</a>  </td>
  <td></td>
  <td>
      <span class="author">thoralf schulze, 30 Mar 2015 18:16</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>







<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/1043" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="5ru+/gmVbaQVjwradpVK5J7aO7SlqAcm0SaLRRQZ1BYE9hURe++hpEDrFdbJQkbXoUhvzVRLppwsBhvNVyAzeQ==" />
  <table class="list issues odd-even"><tr id="relation-119" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1042" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/1042">Bug #1042</a>: Exiv2 nulls file on CIFS share when modifying Exif.Photo.UserComment</td><td class="status">Closed</td><td class="start_date">15 Mar 2015</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/1043/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=1043&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 3627" href="/projects/exiv2/repository/exiv2/revisions/3627">Revision 3627</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/3627/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="21 Mar 2015 16:35" href="/projects/exiv2/activity?from=2015-03-21">over 6 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Exiv2 nulls file on CIFS share when modifying Exif.Photo.UserComment (Closed)" href="/issues/1042">#1042</a> and <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: pyexiv2 fails on cifs shares on an Ubuntu client (Closed)" href="/issues/1043">#1043</a>.  Don't use a MemIo object for small temporary files.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 3630" href="/projects/exiv2/repository/exiv2/revisions/3630">Revision 3630</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/3630/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Mar 2015 00:27" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: pyexiv2 fails on cifs shares on an Ubuntu client (Closed)" href="/issues/1043">#1043</a> and <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Exiv2 nulls file on CIFS share when modifying Exif.Photo.UserComment (Closed)" href="/issues/1042">#1042</a>.  Thanks to Thomas for showing that <a class="changeset" title="#1042 and #1043.  Don&#39;t use a MemIo object for small temporary files." href="/projects/exiv2/repository/exiv2/revisions/3627">r3627</a> reintroduced <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a>.  Thanks to Thoralf for suggesting msync MemIo fix.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 3631" href="/projects/exiv2/repository/exiv2/revisions/3631">Revision 3631</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/3631/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Mar 2015 10:36" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Exiv2 nulls file on CIFS share when modifying Exif.Photo.UserComment (Closed)" href="/issues/1042">#1042</a> <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: pyexiv2 fails on cifs shares on an Ubuntu client (Closed)" href="/issues/1043">#1043</a> <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a>  Added test regression detectors</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 3635" href="/projects/exiv2/repository/exiv2/revisions/3635">Revision 3635</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/3635/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Mar 2015 22:25" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: pyexiv2 fails on cifs shares on an Ubuntu client (Closed)" href="/issues/1043">#1043</a> <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Exiv2 nulls file on CIFS share when modifying Exif.Photo.UserComment (Closed)" href="/issues/1042">#1042</a> <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a>.  Thank You to Thomas for this "polishing" patch.  Thank you to everybody who has worked on this issue.  Adding all the comments on the three issues together comes to about 60 items by at least 6 contributors.  And it involves platform issues, networking, Linux and Windows APIs.  One of the most complex issues to arise in Exiv2.  Well done everybody.  And we've dealt with this quickly.  Only 9 days since Calvin first reported <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Exiv2 nulls file on CIFS share when modifying Exif.Photo.UserComment (Closed)" href="/issues/1042">#1042</a>.</p>


	<p>I use the term "complex" to mean many threads of technology.  "complex" != "complicated".  "complicated" = "difficult to understand".  We try to avoid "complicated".</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-3237" class="journal has-notes has-details">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="19 Mar 2015 10:37" href="/projects/exiv2/activity?from=2015-03-19">over 6 years</a> ago
      <span id="journal-3237-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> set to <i>metadata</i></li>
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Target version</strong> set to <i>0.26</i></li>
    </ul>
    <div id="journal-3237-notes" class="wiki"><p>Thanks for reporting this.  This seems to be a duplicate of 1042 which is currently being investigated.  Your server is Windows.  On what platform are you using pyexiv2?</p>


	<p>You may be interested to learn that  Vincent Vyvre has released a version of pyexiv2 for python3.  <a class="external" href="http://dev.exiv2.org/boards/3/topics/1886">http://dev.exiv2.org/boards/3/topics/1886</a></p>


	<p>I use pyexiv2 a lot.  Almost all 50,000 photographs on my web site are processed by a python script.  I'm sympathetic that the underlying issue is in libexiv2, however you'll understand that I'm not going to get involved with supporting pyexiv2.</p>


	<p>I strongly suspect that this is a Samba issue.  We normally use memory mapping to perform I/O, however this can be disabled and then we use the Standard "C" fopen/fread/fseek/ftell/fclose library calls.  I built the library without memory mapping, and this hang issue occurred on Linux.</p>


	<p>Getting to the bottom of this isn't going to be easy if this is an issue in Samba.  I had a google into Samba/Ubuntu 14.04.  Gosh, there are a lot of folks complaining about Samba4.</p></div>
    </div>
  </div>
  
  <div id="change-3238" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4381">thoralf schulze</a> <a title="19 Mar 2015 14:09" href="/projects/exiv2/activity?from=2015-03-19">over 6 years</a> ago
      <span id="journal-3238-private_notes" class=""></span>
    </h4>

    <div id="journal-3238-notes" class="wiki"><p>hi Robin,</p>


	<p>thank you for your time and your efforts โฆ not sure if my email reply made it into redmine, so i'll post it here again:</p>


<blockquote>

	<p>Your server is Windows.  On what platform are you using pyexiv2?</p>


</blockquote>

	<p>we are using pyexiv2 on a debian wheezy box. both pyexiv2 and libexiv2<br />are straight from the debian repositories, libexiv2 is 0.23-1. the same<br />applies to cifs-utils โฆ<br />everything is fine when pyexiv2 is writing to a share provided by a<br />samba4 server - so yeah, the root cause could well be some subtle<br />differences in the cifs implementation between samba and windows.</p>


<blockquote>

	<p>I use pyexiv2 a lot.  Almost all 50,000 photographs on my web site<br />are processed by a python script.  I'm sympathetic that the<br />underlying issue is in libexiv2, however you'll understand that I'm<br />not going to get involved with supporting pyexiv2.</p>


</blockquote>

	<p>fair enough :-)<br />i can reproduce the issue here quite reliably, and it occurs with exiv2,<br />too:</p>


	<p>KMT\adlibworker@stone:~$ mount | grep win2k<br />//shatner.server.kinemathek.de/images on<br />/home/adlibworker/win2k-share-with-cache type cifs<br />(rw,relatime,vers=1.0,cache=strict,username=adlibworker,domain=KMT,uid=10047,forceuid,gid=10000,forcegid,addr=172.20.1.61,file_mode=0755,dir_mode=0755,nounix,serverino,rsize=61440,wsize=65536,actimeo=1)<br />//shatner.server.kinemathek.de/images on<br />/home/adlibworker/win2k-share-without-cache type cifs<br />(rw,relatime,vers=1.0,cache=none,username=adlibworker,domain=KMT,uid=10047,forceuid,gid=10000,forcegid,addr=172.20.1.61,file_mode=0755,dir_mode=0755,nounix,serverino,rsize=61440,wsize=65536,actimeo=1)<br />KMT\adlibworker@stone:~$ ls <del>al keksrezept*<br />-rw-r--r-</del> 1 KMT\adlibworker KMT\domain users 489057 Mar 19 13:08<br />keksrezept.jpg<br /><del>rw-r--r-</del> 1 KMT\adlibworker KMT\domain users  30254 Mar 19 13:08<br />keksrezept-small.jpg<br />KMT\adlibworker@stone:~$ pwd<br />/home/adlibworker<br />KMT\adlibworker@stone:~$ cp keksrezept* win2k-share-with-cache/ &#38;&#38; cp<br />keksrezept* win2k-share-without-cache/<br />KMT\adlibworker@stone:~$ exiv2 -M"set Exif.Photo.PixelXDimension 666" <br />win2k-share-without-cache/keksrezept.jpg<br />KMT\adlibworker@stone:~$ exiv2 -M"set Exif.Photo.PixelXDimension 666" <br />win2k-share-without-cache/keksrezept-small.jpg<br />KMT\adlibworker@stone:~$ exiv2 -M"set Exif.Photo.PixelXDimension 666" <br />win2k-share-with-cache/keksrezept-small.jpg<br />KMT\adlibworker@stone:~$ exiv2 -M"set Exif.Photo.PixelXDimension 666" <br />win2k-share-with-cache/keksrezept.jpg</p>


	<p>the latter hangs until it is SIGKILLed, strace'ing it does not yield<br />anything - same symptoms as with pyexiv2. exiv2 ist from the wheezy<br />repositories.</p>


<blockquote>

	<p>Getting to the bottom of this isn't going to be easy if this is an<br />issue in Samba.  I had a google into Samba/Ubuntu 14.04.  Gosh, there<br />are a lot of folks complaining about Samba4.</p>


</blockquote>

	<p>i am more than willing to try the procedure above again, and i am more<br />or less comfortable with compiling exiv2 or other binaries myself โฆ</p>


	<p>thank you for your time &#38; with kind regards,<br />t.</p></div>
    </div>
  </div>
  
  <div id="change-3239" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="19 Mar 2015 15:13" href="/projects/exiv2/activity?from=2015-03-19">over 6 years</a> ago
      <span id="journal-3239-private_notes" class=""></span>
    </h4>

    <div id="journal-3239-notes" class="wiki"><p>Thanks for all this effort.</p>


	<p>The build is straight forward and documented here:  <a class="external" href="http://dev.exiv2.org/projects/exiv2/wiki/How_do_I_build_Exiv2_on_the_XYZ_platform">http://dev.exiv2.org/projects/exiv2/wiki/How_do_I_build_Exiv2_on_the_XYZ_platform</a></p>


	<p>This on-liner should do the trick:<pre>$ svn export svn://dev.exiv2.org/svn/trunk ; cd trunk ; make config ; ./configure ; make -j4 ; sudo make install ; make samples ; make tests</pre>Should take less than 2 minutes (it's about 100k lines of code).  At the moment, I haven't had an idea about what to test.  I/O in Exiv2 is performed in basicio.cpp.  We have an abstract I/O class from which we derive concrete classes for File/Mem/Http etc:<pre>$ grep class ~/gnu/exiv2/trunk/src/basicio.cpp 
// class member definitions
    //! Internal Pimpl structure of class FileIo.
    class FileIo::Impl {
    }; // class FileIo::Impl
    //! Internal Pimpl structure of class MemIo.
    class MemIo::Impl {
    }; // class MemIo::Impl
            // call super class method
    //! Internal Pimpl abstract structure of class RemoteIo.
    class RemoteIo::Impl {
    }; // class RemoteIo::Impl
    //! Internal Pimpl structure of class HttpIo.
    class HttpIo::HttpImpl : public Impl  {
    }; // class HttpIo::HttpImpl
    //! Internal Pimpl structure of class RemoteIo.
    class CurlIo::CurlImpl : public Impl  {
    }; // class RemoteIo::Impl
    //! Internal Pimpl structure of class RemoteIo.
    class SshIo::SshImpl : public Impl  {
    }; // class RemoteIo::Impl</pre>We have an I/O test program in our test suite (samples/iotest.cpp).  I'm going play with that.  I didn't write Exiv2 - my good buddy Andreas did that - and has done a great job.  I'll have some fun investigating this one.  I've already built without MemIO, so I don't really suspect him.  Calvin's given me the command to mount a Windows drive from Linux.  I'm going to investigate reading/writing from Linux on the Samba/Windows drive.</p>


	<p>It's remarkable that you and Calvin have shown up on consecutive days talking about this.  Most of the I/O code has been in service for years without anything like this being mentioned before.  It'll fun to find this and say "Ah........ who would have thought ......... of course!"</p></div>
    </div>
  </div>
  
  <div id="change-3240" class="journal has-notes">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="19 Mar 2015 21:22" href="/projects/exiv2/activity?from=2015-03-19">over 6 years</a> ago
      <span id="journal-3240-private_notes" class=""></span>
    </h4>

    <div id="journal-3240-notes" class="wiki"><p>I've done some work on this.  No result - however progress.</p>


	<ol>
	<li>I've persuaded smb4k to connect Linux to Windows</li>
		<li>I've reproduced the hang Ubuntu <-> Windows 7 Ultimate</li>
		<li>I've used exiv2/samples/iotest over Ubuntu <-> Windows 7 and Ubuntu <-> Ubuntu</li>
	</ol>


	<p>samples/iotest makes two copies of a file, one with FileIO and one with MemIO.  It's working fine.</p>


<pre>1042 rmills@rmillsmm-kubuntu:~/smb4k/RMILLS-LAPTOP/C/temp $ ls -alt Fonts.zip
-rwxr-xr-x 1 rmills rmills 64143832 Mar 19 20:18 Fonts.zip
1043 rmills@rmillsmm-kubuntu:~/smb4k/RMILLS-LAPTOP/C/temp $ ~/gnu/exiv2/trunk/bin/iotest Fonts.zip P.zip Q.zip
1044 rmills@rmillsmm-kubuntu:~/smb4k/RMILLS-LAPTOP/C/temp $ ls -alt Fonts.zip P.zip Q.zip
-rwxr-xr-x 1 rmills rmills 64143832 Mar 19 20:26 Q.zip
-rwxr-xr-x 1 rmills rmills 64143832 Mar 19 20:26 P.zip
-rwxr-xr-x 1 rmills rmills 64143832 Mar 19 20:18 Fonts.zip
1045 rmills@rmillsmm-kubuntu:~/smb4k/RMILLS-LAPTOP/C/temp $ 
1045 rmills@rmillsmm-kubuntu:~/smb4k/RMILLS-LAPTOP/C/temp $ md5sum Fonts.zip P.zip Q.zip
46559156b6ffb2c4777a0eaa4b039110  Fonts.zip
46559156b6ffb2c4777a0eaa4b039110  P.zip
46559156b6ffb2c4777a0eaa4b039110  Q.zip
1046 rmills@rmillsmm-kubuntu:~/smb4k/RMILLS-LAPTOP/C/temp $ </pre>All good news.  At least "low level" I/O seems to working correctly.

	<p>Calvin's original script is:<pre>for i in `ls`; do exiv2 -v -M"set Exif.Photo.UserComment charset=Ascii New Exif comment3" $i; done</pre>It's running in a loop, so every iteration invokes a new process.  So even if we're being careless about closing files/memory - the system "should be" cleaning up on our behalf.  I've tried adding a little sleep between the "runs":<pre>for i in `ls`; do exiv2 -v -M"set Exif.Photo.UserComment charset=Ascii New Exif comment3" $i; sleep 1; done</pre>Runs more slowly of course, however it hangs after about 50 files.</p>


	<p>I've run this from Windows7 to the Ubuntu server:<pre>P:\home\rmills\temp\exiv2test&gt;for %i in (*.jpg) do exiv2 -v -M"set Exif.Photo.UserComment charset=Ascii New Exif comment3" %i</pre></p>


	<p>Tomorrow I will instrument and the trace all the I/O calls.  The clear suspect is:  exiv2+Linux-client.  The Mac and Windows clients appear fine.  All the servers appear fine.  And we know the exiv2 file and memio classes are solid.  We just keep digging for that "Ah" moment.</p>


	<p>Incidentally, I discovered why I couldn't connect smb4k to Windows.  It was smb4k.  It wouldn't connect to Ubuntu (although that had been working).  The /var/lib/samba/private directory was missing!  Gone!  Disappeared!  I recreated it with smbpasswd and everything worked.</p>


	<p>Guys, if you have any ideas - please share.  I've added Calvin as a watcher for this issue and intend to discuss both 1042 and 1043 in this thread.</p></div>
    </div>
  </div>
  
  <div id="change-3241" class="journal has-notes">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4378">Calvin Browne</a> <a title="20 Mar 2015 06:22" href="/projects/exiv2/activity?from=2015-03-20">over 6 years</a> ago
      <span id="journal-3241-private_notes" class=""></span>
    </h4>

    <div id="journal-3241-notes" class="wiki"><p>Ok, I've tested the following:</p>


	<p>XP SMB client <-> Ubuntu 14.04.2 LTS on just over 4000 files with a similar windows batch file.<br />  2 of the 3 binaries you made available (trunk and .23)<br />not reproducible.</p>


	<p>On Ubuntu 14.04.2 LTS  NFS Client to NFS Server on just over 4000 file<br />  My compiled trunk and standard ubuntu version "exiv2 -V<br />  exiv2 0.23 001700 (64 bit build)" <br />not reproducible.</p>


	<p>So this definitely points to a CIFS client issue on Ubuntu.</p>


	<p>Unfortunately, I'm off to Germany on Sunday for WHD and then some leave, so it's going to be 2 weeks before I can start getting into that.</p>


	<p>In the meantime - maybe a readme in the release notes, with a recommendation on nfs over cifs? When I get back I can also try an earlier ubuntu version, assuming it has an older cifs client.</p></div>
    </div>
  </div>
  
  <div id="change-3242" class="journal has-notes has-details">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="21 Mar 2015 16:38" href="/projects/exiv2/activity?from=2015-03-21">over 6 years</a> ago
      <span id="journal-3242-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Target version</strong> changed from <i>0.26</i> to <i>0.25</i></li>
    </ul>
    <div id="journal-3242-notes" class="wiki"><p>I've found and submitted a fix.  <a class="changeset" title="#1059 doc template for acdsee schema" href="/projects/exiv2/repository/exiv2/revisions/3725">r3725</a></p>


	<p>I'm going to assign this to Andreas to review.  I haven't studied the MemIo class enough to know why it's not working correctly on smb/Ubuntu.</p>


	<p>Andreas: If you're pushed for time, please assign this back to me and I will continue to investigate.</p></div>
    </div>
  </div>
  
  <div id="change-3244" class="journal has-notes has-details">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="21 Mar 2015 16:43" href="/projects/exiv2/activity?from=2015-03-21">over 6 years</a> ago
      <span id="journal-3244-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Subject</strong> changed from <i>pyexiv2 fails on cifs shares served by win2k8-servers</i> to <i>pyexiv2 fails on cifs shares on an Ubuntu client</i></li>
    </ul>
    <div id="journal-3244-notes" class="wiki"><p>I'm going to modify the title of this issue.  We've eliminated the Windows Server in our investigation.  The clear candidate for investigation is exiv2 running on Ubuntu on a Samba share (cifs).</p></div>
    </div>
  </div>
  
  <div id="change-3245" class="journal has-details">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="21 Mar 2015 16:44" href="/projects/exiv2/activity?from=2015-03-21">over 6 years</a> ago
      <span id="journal-3245-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Assignee</strong> changed from <i>Robin Mills</i> to <i>Andreas Huggel</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-3246" class="journal has-notes">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4381">thoralf schulze</a> <a title="23 Mar 2015 13:05" href="/projects/exiv2/activity?from=2015-03-23">over 6 years</a> ago
      <span id="journal-3246-private_notes" class=""></span>
    </h4>

    <div id="journal-3246-notes" class="wiki"><p>hi robin,</p>


	<p>thank you for having a look! i can confirm that your patch resolves the issue:</p>


	<p>KMT\adlibworker@stone:~$ which exiv2<br />/usr/local/bin/exiv2<br />KMT\adlibworker@stone:~$ /usr/local/bin/exiv2 -V | head -n5<br />exiv2 0.24 001800 (64 bit build)<br />Copyright (C) 2004-2013 Andreas Huggel.</p>


	<p>This program is free software; you can redistribute it and/or<br />modify it under the terms of the GNU General Public License<br />KMT\adlibworker@stone:~$ cp keksrezept* win2k-share-without-cache/<br />KMT\adlibworker@stone:~$ exiv2 -M"set Exif.Photo.PixelXDimension 666" win2k-share-without-cache/keksrezept.jpg<br />KMT\adlibworker@stone:~$ exiv2 -M"set Exif.Photo.PixelXDimension 666" win2k-share-without-cache/keksrezept-small.jpg<br />KMT\adlibworker@stone:~$ cp keksrezept* win2k-share-with-cache/<br />KMT\adlibworker@stone:~$ exiv2 -M"set Exif.Photo.PixelXDimension 666" win2k-share-with-cache/keksrezept-small.jpg<br />KMT\adlibworker@stone:~$ exiv2 -M"set Exif.Photo.PixelXDimension 666" win2k-share-with-cache/keksrezept.jpg <br />KMT\adlibworker@stone:~$</p>


	<p>so, not using mmap'ed temporary files does not trigger the bug โฆ interesting. i also tried with this:</p>


	<p>thoralf@tfbb:~/Baustelle/exiv2/trunk$ diff <del>ub src/basicio.cpp{.orig,}<br />--</del> src/basicio.cpp.orig        2015-03-23 12:40:37.672506212 <ins>0100<br /></ins>++ src/basicio.cpp     2015-03-23 13:24:45.273634955 +0100<br /><code>@ -584,7 +584,8 </code>@<br />         // buffer, which is a workaround to ensure that the links don't get broken.</p>
	<pre><code>// #1042 and #1043.  Always use a FileIo object to avoid Samba/Ubuntu/cifs error<br />-        ret = 911;<br />+        // try with msync()<br />+        // ret = 911;<br />         if (ret != 0 || (buf.st_size &gt; 1048576 &#38;&#38; nlink == 1)) {<br />             pid_t pid = ::getpid();<br />             std::auto_ptr&amp;lt;FileIo&amp;gt; fileIo;<br /><code>@ -1177,6 +1178,7 </code>@<br />     MemIo::~MemIo()
     {<br />         if (p_-&gt;isMalloced_) {<br />+            msync(p_, p_-&gt;size_, MS_ASYNC);<br />             std::free(p_-&gt;data_);<br />         }<br />         delete p_;<br />thoralf@tfbb:~/Baustelle/exiv2/trunk$</code></pre>


	<p>โฆ which also <em>seems</em> to work. however, i do not speak c(++) and wouldn't trust this code to not set my house on fire or eat my babies. fortunately, i have neither :-)<br />i'm also not sure if the unconditional msync doesn't defeat the purpose of using mmap'ed files in the first place.</p>


<blockquote>

	<p>Unfortunately, I'm off to Germany on Sunday for WHD and then some leave</p>


</blockquote>

	<p>say hello if you are in berlin - beers will be on me :-)</p>


	<p>thank you very much &#38; with kind regards,<br />t.</p></div>
    </div>
  </div>
  
  <div id="change-3247" class="journal has-notes has-details">
    <div id="note-10">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-10" class="journal-link">#10</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="23 Mar 2015 19:25" href="/projects/exiv2/activity?from=2015-03-23">over 6 years</a> ago
      <span id="journal-3247-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Priority</strong> changed from <i>Normal</i> to <i>High</i></li>
    </ul>
    <div id="journal-3247-notes" class="wiki"><p>I consider the 911-change (<a class="changeset" title="#1042 and #1043.  Don&#39;t use a MemIo object for small temporary files." href="/projects/exiv2/repository/exiv2/revisions/3627">r3627</a>) as a temporary hack only because it breaks <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a> on Win again.</p>


	<p>Also, msync is Linux only and won't compile on MSVC. Hence, compiler switches are needed for later. Looks like msync and reverting the 911-hack could be the proper solution. However I am not Linux expert.</p></div>
    </div>
  </div>
  
  <div id="change-3248" class="journal has-details">
    <div id="note-11">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-11" class="journal-link">#11</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="23 Mar 2015 19:26" href="/projects/exiv2/activity?from=2015-03-23">over 6 years</a> ago
      <span id="journal-3248-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> changed from <i>metadata</i> to <i>basicio</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-3249" class="journal has-notes has-details">
    <div id="note-12">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-12" class="journal-link">#12</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="23 Mar 2015 20:21" href="/projects/exiv2/activity?from=2015-03-23">over 6 years</a> ago
      <span id="journal-3249-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Assignee</strong> changed from <i>Andreas Huggel</i> to <i>Robin Mills</i></li>
       <li><strong>Priority</strong> changed from <i>High</i> to <i>Normal</i></li>
    </ul>
    <div id="journal-3249-notes" class="wiki"><p>Thomas</p>


	<p>I thank you for bringing my attention to <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a>.  I've assigned this issue (<a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: pyexiv2 fails on cifs shares on an Ubuntu client (Closed)" href="/issues/1043">#1043</a>) back to myself to consider your observation, although I don't know what <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a> is about as you haven't bothered to say. You are right to have changed the category from metadata (where the issue surfaced) to I/O where the issue lies.</p>


	<p>It is not up to you to assign priority to bugs.  Your behaviour around the Exiv2 project is very demotivating.  If you wish to help, please be constructive and cooperative.  You have consumed a considerable amount of my time over the last few months and seldom bothered with the courtesy to say "Thank You".</p>


	<p>Robin</p></div>
    </div>
  </div>
  
  <div id="change-3250" class="journal has-notes">
    <div id="note-13">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-13" class="journal-link">#13</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="23 Mar 2015 22:02" href="/projects/exiv2/activity?from=2015-03-23">over 6 years</a> ago
      <span id="journal-3250-private_notes" class=""></span>
    </h4>

    <div id="journal-3250-notes" class="wiki"><p>Thanks You Thoral for your suggestion about msync().  I doubt if it would eat your (non-existing) babies.</p>


	<p>In view of Thomas observation that the 911 fix causes <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a> to resurface on Windows, I'll have to read the code with more care to understand this more deeply.  I did ask Andreas to review this fix as I believe he wrote the code.  I see he was involved in <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a> which involves erroneously "emptying" files which have multiple hard links.</p>


	<p>My thoughts are that I should:</p>


	<ol>
	<li>Study <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a> to understand what's going on</li>
		<li>Add to test/bugfixes-test.sh to detect <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a></li>
		<li>Perhaps MemIo can never be used to rewrite a file nlinks > 1 on any platform</li>
	</ol>


	<p>Specifically, about msync():</p>


	<ol>
	<li>munmap()/mmap() may be portable and have the same effect as msync()</li>
		<li>munmap()/mmap() may cause the MemIo encapsulated pointer to change (hopefully without side-effects)</li>
	</ol>


	<p>Ah......  Its often tough to deal with other folks code.  However getting to the bottom of these matters can be satisfying.  For sure, we've made considerable progress in one week.</p>


	<p>If you get to meet Calvin, enjoy your beer.  If Thomas can also join you, so much the merrier.  "Cheers" from Merry England.</p></div>
    </div>
  </div>
  
  <div id="change-3251" class="journal has-notes">
    <div id="note-14">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-14" class="journal-link">#14</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="23 Mar 2015 22:10" href="/projects/exiv2/activity?from=2015-03-23">over 6 years</a> ago
      <span id="journal-3251-private_notes" class=""></span>
    </h4>

    <div id="journal-3251-notes" class="wiki"><p><a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a> is about destroying hard links after writing metadata to file. There is a link to a 3 year old discussion inside <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a> but you don't need to follow it all through. Just see the comment above your 911-commit in basicio.cpp, lines 583 and 584:<br /><code><br />        // use a memory buffer. I.e., files with hard links always use a memory<br />        // buffer, which is a workaround to ensure that the links don't get broken.<br /></code><br />This does no longer hold after <a class="changeset" title="#1042 and #1043.  Don&#39;t use a MemIo object for small temporary files." href="/projects/exiv2/repository/exiv2/revisions/3627">r3627</a>. Thus hot-fixing this ticket broke another one.</p>


	<p>One more sentence about constructive input: If you read my previous comment again you'll see that I pointed to msync as a possible solution fixing this one <ins>and</ins> keeping <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a> closed.</p></div>
    </div>
  </div>
  
  <div id="change-3252" class="journal has-notes">
    <div id="note-15">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-15" class="journal-link">#15</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="23 Mar 2015 22:16" href="/projects/exiv2/activity?from=2015-03-23">over 6 years</a> ago
      <span id="journal-3252-private_notes" class=""></span>
    </h4>

    <div id="journal-3252-notes" class="wiki"><p>One more thought about <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a>. I guess it's not purely related to Windows and should also apply to Linux. And of course, you are right about adding the missing test case.</p>


	<p>Thank you, Robin.</p></div>
    </div>
  </div>
  
  <div id="change-3253" class="journal has-notes">
    <div id="note-16">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-16" class="journal-link">#16</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="23 Mar 2015 22:34" href="/projects/exiv2/activity?from=2015-03-23">over 6 years</a> ago
      <span id="journal-3253-private_notes" class=""></span>
    </h4>

    <div id="journal-3253-notes" class="wiki"><p>Thomas</p>


	<p>I think there has been a misunderstanding.  You have been very helpful by pointing out that the 911 fix breaks the fix to <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a>.  However increasing the priority of the bug amounts to you shouting at me.  Please don't do that.</p>


	<p>You are probably correct that protecting the msync() call with #if HAVE_MSYNC .. #endif is a good fix.  I feel I must add an <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a> detector to the test suite (in case it is erroneously reintroduced). And I will need to add an HAVE_MSYNC detector to both the autotools and CMake build environments.  We know it's not available on MSVC.  I don't know its status on Cygwin and MInGW.</p>


	<p>I do appreciate your input and help.  I will spend more time on this.</p>


	<p>Robin</p></div>
    </div>
  </div>
  
  <div id="change-3255" class="journal has-notes">
    <div id="note-17">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-17" class="journal-link">#17</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="23 Mar 2015 22:46" href="/projects/exiv2/activity?from=2015-03-23">over 6 years</a> ago
      <span id="journal-3255-private_notes" class=""></span>
    </h4>

    <div id="journal-3255-notes" class="wiki"><p>Oh, I've thought of something else.  I'll confess:  "I didn't read the comment about the hard links!".  Or, I glanced at it without realising the implication.  I was so focused on the size condition that I thought "what's size go to do with it?"  (as Tina Turner once sang).</p>


	<p>So, I thought res = 911; makes it very clear that we're always gonna head down the FileIo route and never risk MemIo.  And then I thought "I'll dump this on Andreas to review".  However he's rather dormant on the project at the moment and we're going to have to live without him.</p>


	<p>The <strong>good news</strong> is that the team of Thomas, Thoralf, Calvin and Robin seem to be pulling together to fix this.  Well Done Everybody.  Sounds like Thoralf is offering to buy everybody beer in Berlin one night this week.  It's my Wedding Anniversary on Friday (41 happy years).  I'll toast your health with a glass of English Bitter if we've nailed this issue by the end of the week.</p></div>
    </div>
  </div>
  
  <div id="change-3256" class="journal has-notes">
    <div id="note-18">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-18" class="journal-link">#18</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="23 Mar 2015 22:48" href="/projects/exiv2/activity?from=2015-03-23">over 6 years</a> ago
      <span id="journal-3256-private_notes" class=""></span>
    </h4>

    <div id="journal-3256-notes" class="wiki"><p>Just checked: msync is in sys/mman.h of Cygwin. Mingw should be also positive. Can check tomorrow.</p></div>
    </div>
  </div>
  
  <div id="change-3257" class="journal has-notes">
    <div id="note-19">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-19" class="journal-link">#19</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="23 Mar 2015 22:58" href="/projects/exiv2/activity?from=2015-03-23">over 6 years</a> ago
      <span id="journal-3257-private_notes" class=""></span>
    </h4>

    <div id="journal-3257-notes" class="wiki"><p>Thanks, Thomas.</p>


	<p>I expect them to be there.  However, I'm updating configure.ac to test for itself and set HAVE_MSYNC.  You never know, there might be an old Cygwin (or worse, a future Cygwin) that doesn't include it.  Or when compiling with Clang.  Or an unsupported platform such as Sun or AIX which may, or may not, have msync().  Better to leave autotools/CMake to test-link the the function to be sure it's on the build platform.  And I'll update src/version.cpp which not reports those flags when your run $ exiv2 --verbose --version</p>


	<p>I'm hoping to fix this before going to bed.  Adding something to the test suite will be done later.  I won't mark this issue "Resolved" until I have something in the test suite to detect <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a>.</p></div>
    </div>
  </div>
  
  <div id="change-3258" class="journal has-notes">
    <div id="note-20">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-20" class="journal-link">#20</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="23 Mar 2015 23:04" href="/projects/exiv2/activity?from=2015-03-23">over 6 years</a> ago
      <span id="journal-3258-private_notes" class=""></span>
    </h4>

    <div id="journal-3258-notes" class="wiki"><p>There are already detectors for EXV_HAVE_SYS_MMAN_H, EXV_HAVE_MMAP and EXV_HAVE_MUNMAP.</p>


	<p>Unfortunately I cannot answer Thoralfs question if unconditional msync doesn't defeat the purpose of using mmap'ed files.</p>


	<p>If it proves to be the solution what about moving msync from dtor of MemIO to MemIo::munmap() or MemIo::close() which are a dummy function right now?</p></div>
    </div>
  </div>
  
  <div id="change-3260" class="journal has-notes">
    <div id="note-21">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-21" class="journal-link">#21</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="23 Mar 2015 23:24" href="/projects/exiv2/activity?from=2015-03-23">over 6 years</a> ago
      <span id="journal-3260-private_notes" class=""></span>
    </h4>

    <div id="journal-3260-notes" class="wiki"><p>I'm not sure either about Thoralf's question about msync defeating using mmap'ed file.</p>


	<p>I'm focused on adding msync() and a detector.  Exactly where we put the msync() call isn't too important - it should be protected by #if HAVE_MSYNC ... #endif.  Maybe I will should add a method MemIo.msync() and hide the detector there.</p>


	<p>However .... it's getting late in Germany ... you go to bed and I'll finish the autotools/CMake/version.cpp code and test it tonight.  I'll manually test nlinks > 1 on the Mac.  Adding to test/bugfixes-test.sh isn't getting done tonight.</p></div>
    </div>
  </div>
  
  <div id="change-3261" class="journal has-notes">
    <div id="note-22">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-22" class="journal-link">#22</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Mar 2015 00:33" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago
      <span id="journal-3261-private_notes" class=""></span>
    </h4>

    <div id="journal-3261-notes" class="wiki"><p>OK, guys.  Fix submitted. <a class="changeset" title="#1043 and #1042.  Thanks to Thomas for showing that r3627 reintroduced #812.  Thanks to Thoralf f..." href="/projects/exiv2/repository/exiv2/revisions/3630">r3630</a></p>


	<p>Thanks to everybody for getting involved on this - especially Thomas.  Well done, Thomas: you pushed me to realise my error.  Thanks.</p>


	<p>I hope we're really done on this.  I've checked on Mac and Linux that we're not destroying files with multiple hard links.<pre>
$ exiv2 -v -M"set Exif.Photo.UserComment charset=Ascii New Exif comment3" R.jpg
File 1/1: R.jpg
Set Exif.Photo.UserComment "charset=Ascii New Exif comment3" (Comment)
$ ln R.jpg Q.jpg
$ exiv2 -v -M"set Exif.Photo.UserComment charset=Ascii changed the comment" R.jpg
File 1/1: R.jpg
Set Exif.Photo.UserComment "charset=Ascii changed the comment" (Comment)
$ exiv2 -pa -g UserComment R.jpg
Exif.Photo.UserComment                       Undefined  27  changed the comment
$ exiv2 -pa -g UserComment Q.jpg
Exif.Photo.UserComment                       Undefined  27  changed the comment
</pre>Thomas can check this on Windows.  I've seldom used the obscure NTFS command MKLINK (much better name than Unix's horrid ln command).  I wonder if hard links work on Cygwin or MinGW (probably will if NTFS).</p>


	<p>And, we got lucky.  The macro MS_SYNC is a companion of msync(), so I didn't need to update the build environment.  I'll check the build server tomorrow to be sure that this has build OK on all platforms (perhaps MSVC has a different MS_SYNC macro!).</p>


	<p>If nobody says "not fixed" then I'll add something to ./test/bugfixes-test.sh later this week and update this issue to resolved.</p></div>
    </div>
  </div>
  
  <div id="change-3262" class="journal has-notes has-details">
    <div id="note-23">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-23" class="journal-link">#23</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Mar 2015 12:05" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago
      <span id="journal-3262-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/736">Anniversary.jpg</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/736/Anniversary.jpg">Anniversary.jpg</a> added</li>
    </ul>
    <div id="journal-3262-notes" class="wiki"><p>Submitted regression detectors: <a class="changeset" title="#1042 #1043 #812  Added test regression detectors" href="/projects/exiv2/repository/exiv2/revisions/3631">r3631</a>.  Built and tested on all supported platforms: <a class="external" href="http://exiv2.dyndns.org:8080/job/Exiv2-trunk/1884/">http://exiv2.dyndns.org:8080/job/Exiv2-trunk/1884/</a></p>


	<p>I hope this is the last time I hear about <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: pyexiv2 fails on cifs shares on an Ubuntu client (Closed)" href="/issues/1043">#1043</a> and <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a>.  Thanks Everybody: Thoralf, Calvin and Thomas for your contributions.  I hope (in the nicest possible way) that this is the last time we talk about this.  However, when you discover other issues, we'll meet again.  Beers in Berlin on Friday Night - 2015-03-27 - to toast Exiv2 and my 41st Wedding Anniversary.  I've got a date in England and can't attend.</p>


	<p>(Whoops, the photo in Arizona was on our 40th Anniversary last year: 2014-03-27).</p>


	<p><img src="/attachments/download/736/Anniversary.jpg" alt="" /></p></div>
    </div>
  </div>
  
  <div id="change-3263" class="journal has-notes">
    <div id="note-24">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-24" class="journal-link">#24</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="24 Mar 2015 12:06" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago
      <span id="journal-3263-private_notes" class=""></span>
    </h4>

    <div id="journal-3263-notes" class="wiki"><p>Thank you, Robin.</p>


	<p>Just a quick comment for now: I guess there is once call of <code>msync()</code> missing in function <code>MemIo::transfer</code> in case <code>memIo!=this</code>.</p></div>
    </div>
  </div>
  
  <div id="change-3264" class="journal has-notes">
    <div id="note-25">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-25" class="journal-link">#25</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Mar 2015 12:15" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago
      <span id="journal-3264-private_notes" class=""></span>
    </h4>

    <div id="journal-3264-notes" class="wiki"><p>Do you mean:<pre>    void MemIo::transfer(BasicIo&#38; src)
    {
        MemIo *memIo = dynamic_cast&lt;MemIo*&gt;(&#38;src);
        if (memIo) {
            // Optimization if src is another instance of MemIo
            if (true == p_-&gt;isMalloced_) {
                std::free(p_-&gt;data_);
            }
            p_-&gt;idx_ = 0;
            p_-&gt;data_ = memIo-&gt;p_-&gt;data_;
            p_-&gt;size_ = memIo-&gt;p_-&gt;size_;
            p_-&gt;isMalloced_ = memIo-&gt;p_-&gt;isMalloced_;
            memIo-&gt;p_-&gt;idx_ = 0;
            memIo-&gt;p_-&gt;data_ = 0;
            memIo-&gt;p_-&gt;size_ = 0;
            memIo-&gt;p_-&gt;isMalloced_ = false;
        }
        else {
            // Generic reopen to reset position to start
            if (src.open() != 0) {
                throw Error(9, src.path(), strError());
            }
            p_-&gt;idx_ = 0;
            write(src);
            src.close();
        }
        if (error() || src.error()) throw Error(19, strError());
    }</pre><br />Should be:<pre>
...
        if (memIo) {
            // Optimization if src is another instance of MemIo
            if (true == p_-&gt;isMalloced_) {
                msync();
                std::free(p_-&gt;data_);
            }
...</pre></p></div>
    </div>
  </div>
  
  <div id="change-3265" class="journal has-notes">
    <div id="note-26">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-26" class="journal-link">#26</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="24 Mar 2015 12:28" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago
      <span id="journal-3265-private_notes" class=""></span>
    </h4>

    <div id="journal-3265-notes" class="wiki">Some more ideas:
	<ul>
	<li>MemIo::munmap() could return the return value of MemIo::msycn().</li>
		<li>No need to have MemIo::msycn() virtual. Could be even private.</li>
	</ul></div>
    </div>
  </div>
  
  <div id="change-3266" class="journal has-notes">
    <div id="note-27">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-27" class="journal-link">#27</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="24 Mar 2015 12:29" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago
      <span id="journal-3266-private_notes" class=""></span>
    </h4>

    <div id="journal-3266-notes" class="wiki"><p>Robin Mills wrote:</p>


<blockquote>

	<p>Do you mean:[...]<br />Should be:[...]</p>


</blockquote>

	<p>Yes, exactly.</p></div>
    </div>
  </div>
  
  <div id="change-3267" class="journal has-notes">
    <div id="note-28">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-28" class="journal-link">#28</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="24 Mar 2015 12:33" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago
      <span id="journal-3267-private_notes" class=""></span>
    </h4>

    <div id="journal-3267-notes" class="wiki"><p>Important question is also if msync() must be called before FileIO::munmap is called. According to msync documentation ist should be called. Unfortunately I am not a Linux API expert.</p></div>
    </div>
  </div>
  
  <div id="change-3268" class="journal has-notes">
    <div id="note-29">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-29" class="journal-link">#29</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="24 Mar 2015 12:39" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago
      <span id="journal-3268-private_notes" class=""></span>
    </h4>

    <div id="journal-3268-notes" class="wiki"><p>It was confusing to me that msync doc refers to mmap/munmap which is not used in MemIO but FileIO.</p>


	<p>This one is interesting: <a class="external" href="http://stackoverflow.com/questions/5902629/mmap-msync-and-linux-process-termination">http://stackoverflow.com/questions/5902629/mmap-msync-and-linux-process-termination</a></p>


	<p>msync is used case of mmap/munmap = FileIO. For MemIO class we could try fsync.</p></div>
    </div>
  </div>
  
  <div id="change-3269" class="journal has-notes">
    <div id="note-30">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-30" class="journal-link">#30</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Mar 2015 12:52" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago
      <span id="journal-3269-private_notes" class=""></span>
    </h4>

    <div id="journal-3269-notes" class="wiki"><p>I'm a little lost here, Thomas. Where is this <em>"if msync() must be called before FileIO::munmap is called"</em> ?</p>


	<p>I call the msync() method in MemIo:munmap() in <a class="changeset" title="#1043 and #1042.  Thanks to Thomas for showing that r3627 reintroduced #812.  Thanks to Thoralf f..." href="/projects/exiv2/repository/exiv2/revisions/3630">r3630</a>.  And MemIo::msync() could be declared private and does not need to be virtual.  However I don't see anything incorrect in what's been submitted.</p>


	<p>And Thomas.  I have another life.  I can't endlessly explore and test every possibility.  It appears to be building and working fine on all supported platforms.  I have Daniel moaning at me about CMake/MSVC.  Gilles discussing the webp GSoC 2015 project.  Alan wants something about Lightroom Categories.  And I have 14 other oustanding issues to deal with for v0.25.  Oh, and more jenkins/build-server stuff to finish. And you how many volunteers do I have for all those tasks.</p>


	<p>And I'm rather puzzled that the Windows Memory Mapping appears to be used in the FileIo class.  I didn't write it and don't have time to deal with all of this.</p></div>
    </div>
  </div>
  
  <div id="change-3270" class="journal has-notes">
    <div id="note-31">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-31" class="journal-link">#31</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Mar 2015 13:07" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago
      <span id="journal-3270-private_notes" class=""></span>
    </h4>

    <div id="journal-3270-notes" class="wiki"><p>Thomas.  Please provide a patch with all your suggested changes.  I'll review and submit.  However I can't endlessly work on this.  I have other things to get on with - including my life!</p></div>
    </div>
  </div>
  
  <div id="change-3271" class="journal has-notes">
    <div id="note-32">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-32" class="journal-link">#32</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="24 Mar 2015 13:21" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago
      <span id="journal-3271-private_notes" class=""></span>
    </h4>

    <div id="journal-3271-notes" class="wiki"><blockquote>

	<p>I'm a little lost here, Thomas. Where is this <em>"if msync() must be called before FileIO::munmap is called"</em> ?</p>


</blockquote>

	<p>This ought to be a question. It is taken from here: <a class="external" href="http://man7.org/linux/man-pages/man2/msync.2.html">http://man7.org/linux/man-pages/man2/msync.2.html</a><br /><code><br />       msync() flushes changes made to the in-core copy of a file that was<br />       mapped into memory using mmap(2) back to the filesystem.  Without use<br />       of this call there is no guarantee that changes are written back<br />       before munmap(2) is called.<br /></code><br />Currently we don't do it in FileIO. That's why I asked the Linux API experts.</p>


<blockquote>

	<p>And I'm rather puzzled that the Windows Memory Mapping appears to be used in the FileIo class.  I didn't write it and don't have time to deal with all of this.</p>


</blockquote>

	<p>Yes, for sure it is there. This is the usual Win-API programming compared to Linux API mmap/munmap. No need to bother with this.</p>


<blockquote>

	<p>Please provide a patch with all your suggested changes. I'll review and submit. However I can't endlessly work on this. I have other things to get on with - including my life!</p>


</blockquote>

	<p>I can try. But I cannot test if it fixes this ticket.</p></div>
    </div>
  </div>
  
  <div id="change-3272" class="journal has-notes">
    <div id="note-33">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-33" class="journal-link">#33</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4381">thoralf schulze</a> <a title="24 Mar 2015 13:39" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago
      <span id="journal-3272-private_notes" class=""></span>
    </h4>

    <div id="journal-3272-notes" class="wiki"><p>hi,</p>


	<p>Thomas Beutlich wrote:</p>


<blockquote>

	<p>[โฆ] But I cannot test if it fixes this ticket.</p>


</blockquote>

	<p>i have a working build environment for linux amd64 here, and i am more than willing to keep it around for a little while. i didn't use the test suite yet, but am fairly confident to be able to figure it out โฆ i won't be able to check robins latest checkin today, but will do so tomorrow.</p>


	<p>Robin Mills wrote:</p>


<blockquote>

	<p>Beers in Berlin on Friday Night - 2015-03-27 - to toast Exiv2 and my 41st Wedding Anniversary.</p>


</blockquote>

	<p>sounds good to me, my offer "free beer to anyone involved" still holds :-) for the berliners, i'd suggest the bierkombinat kreuzberg, ~8 pm? robin, we'll have a toast on you and you anniversary.</p>


	<p>with kind regards,<br />t.</p></div>
    </div>
  </div>
  
  <div id="change-3273" class="journal has-notes">
    <div id="note-34">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-34" class="journal-link">#34</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Mar 2015 13:45" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago
      <span id="journal-3273-private_notes" class=""></span>
    </h4>

    <div id="journal-3273-notes" class="wiki"><p>Thomas.</p>


	<p>The build server builds and tests the code when it's submitted.    <a class="external" href="http://exiv2.dyndns.org:8080">http://exiv2.dyndns.org:8080</a></p>


	<p>When you give me your patch, I'll review and submit it.  If it builds and passes the test suite on the build server, we're done!  However I can't spend any more time on this.</p>


	<p>Thoralf</p>


	<p>Thanks for your input. If Thomas comes for beer on Friday, don't let him discuss this issue (or his other contributions) all night.  Drown him in beer!</p>


	<p>Robin</p></div>
    </div>
  </div>
  
  <div id="change-3280" class="journal has-notes has-details">
    <div id="note-35">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-35" class="journal-link">#35</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="24 Mar 2015 22:14" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago
      <span id="journal-3280-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/740">T1043.patch</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/740/T1043.patch">T1043.patch</a> added</li>
    </ul>
    <div id="journal-3280-notes" class="wiki"><p>Find attached the trivial patch (based on <a class="changeset" title="#1043 and #1042.  Thanks to Thomas for showing that r3627 reintroduced #812.  Thanks to Thoralf f..." href="/projects/exiv2/repository/exiv2/revisions/3630">r3630</a>) I can offer. It is nothing special about it at all.</p></div>
    </div>
  </div>
  
  <div id="change-3282" class="journal has-notes">
    <div id="note-36">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-36" class="journal-link">#36</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Mar 2015 22:30" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago
      <span id="journal-3282-private_notes" class=""></span>
    </h4>

    <div id="journal-3282-notes" class="wiki"><p>Patch submitted.  <a class="changeset" title="Fixed output error in functions.source/hardLinkFiles() reporting &quot;ln: bug812-B.jpg: File exists&quot; ..." href="/projects/exiv2/repository/exiv2/revisions/3633">r3633</a>.  Thank You Thomas for providing the patch.</p>


	<p>I will keep myself as the "Assignee" on this issue and check the build server tomorrow.  If everything's fine (which I expect it to be), I'll mark this "Resolved" and change the Assignee to Thomas to recognise his important contribution.  However this has been a real team effort to fix this. Thank You everybody.</p></div>
    </div>
  </div>
  
  <div id="change-3284" class="journal has-notes">
    <div id="note-37">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-37" class="journal-link">#37</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="24 Mar 2015 22:37" href="/projects/exiv2/activity?from=2015-03-24">over 6 years</a> ago
      <span id="journal-3284-private_notes" class=""></span>
    </h4>

    <div id="journal-3284-notes" class="wiki"><p>Yes, builds should likely be fine. But tests on this issue are more interesting. Thoralf can help here and should be the one credited for adding msync.</p></div>
    </div>
  </div>
  
  <div id="change-3293" class="journal has-notes">
    <div id="note-38">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-38" class="journal-link">#38</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4381">thoralf schulze</a> <a title="25 Mar 2015 12:14" href="/projects/exiv2/activity?from=2015-03-25">over 6 years</a> ago
      <span id="journal-3293-private_notes" class=""></span>
    </h4>

    <div id="journal-3293-notes" class="wiki"><p>hi,</p>


	<p>i checked <a class="changeset" title="Fixed output error in functions.source/hardLinkFiles() reporting &quot;ln: bug812-B.jpg: File exists&quot; ..." href="/projects/exiv2/repository/exiv2/revisions/3633">r3633</a>. unfortunately, it exhibits the same symptoms as versions before <a class="changeset" title="#1042 and #1043.  Don&#39;t use a MemIo object for small temporary files." href="/projects/exiv2/repository/exiv2/revisions/3627">r3627</a> - it hangs on large files, does work fine while being strace'd etc.<br />i also double-checked with a fresh checkout of <a class="changeset" title="#1042 and #1043.  Don&#39;t use a MemIo object for small temporary files." href="/projects/exiv2/repository/exiv2/revisions/3627">r3627</a>, which still works fine.</p>


	<p>sorry for the bad news, please don't kill the messenger โฆ</p>


	<p>with kind regards,<br />t.</p></div>
    </div>
  </div>
  
  <div id="change-3294" class="journal has-notes">
    <div id="note-39">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-39" class="journal-link">#39</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="25 Mar 2015 12:35" href="/projects/exiv2/activity?from=2015-03-25">over 6 years</a> ago
      <span id="journal-3294-private_notes" class=""></span>
    </h4>

    <div id="journal-3294-notes" class="wiki"><p>Thanks for testing and reporting this.  We have to know about this sooner or later.  Much better to know sooner.</p></div>
    </div>
  </div>
  
  <div id="change-3295" class="journal has-notes">
    <div id="note-40">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-40" class="journal-link">#40</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="25 Mar 2015 12:40" href="/projects/exiv2/activity?from=2015-03-25">over 6 years</a> ago
      <span id="journal-3295-private_notes" class=""></span>
    </h4>

    <div id="journal-3295-notes" class="wiki"><p>Thoralf, can you please repeat the test where you replace MS_SYNC by MS_ASYNC in basicio.cpp. This is the only difference I can think about.</p></div>
    </div>
  </div>
  
  <div id="change-3296" class="journal has-notes">
    <div id="note-41">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-41" class="journal-link">#41</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4381">thoralf schulze</a> <a title="25 Mar 2015 13:02" href="/projects/exiv2/activity?from=2015-03-25">over 6 years</a> ago
      <span id="journal-3296-private_notes" class=""></span>
    </h4>

    <div id="journal-3296-notes" class="wiki"><p>hi,</p>


	<p>Thomas Beutlich wrote:</p>


<blockquote>

	<p>Thoralf, can you please repeat the test where you replace MS_SYNC by MS_ASYNC in basicio.cpp. This is the only difference I can think about.</p>


</blockquote>

	<p>i did - same issue, hangs as well. i also did another test with <a class="changeset" title="#1042 and #1043.  Don&#39;t use a MemIo object for small temporary files." href="/projects/exiv2/repository/exiv2/revisions/3627">r3627</a> and the msync()-patch applied, which failed in the same way this time :-(</p>


	<p>so msync seems to have been a red herring, and i feel rather stupid now.</p>


	<p>sorry,<br />t.</p></div>
    </div>
  </div>
  
  <div id="change-3297" class="journal has-notes">
    <div id="note-42">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-42" class="journal-link">#42</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="25 Mar 2015 13:50" href="/projects/exiv2/activity?from=2015-03-25">over 6 years</a> ago
      <span id="journal-3297-private_notes" class=""></span>
    </h4>

    <div id="journal-3297-notes" class="wiki"><p>Thanks for testing. Very strange observations.</p>


	<p>I will try to debug it once more to see how FileIO and MemIO work. I won't be able to do it today.</p></div>
    </div>
  </div>
  
  <div id="change-3308" class="journal has-notes">
    <div id="note-43">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-43" class="journal-link">#43</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="25 Mar 2015 23:10" href="/projects/exiv2/activity?from=2015-03-25">over 6 years</a> ago
      <span id="journal-3308-private_notes" class=""></span>
    </h4>

    <div id="journal-3308-notes" class="wiki"><p>Gentlemen:</p>


	<p>Are you sure this is a problem.  It seems to be working OK for me.  Here's the setup:</p>


	<ul>
	<li>7mb JPG - with/without links.  </li>
		<li>client is Ubuntu (machine = rmillsmbp-kubuntu)</li>
		<li>directory is mounted with cifs on rmillsmm-kubuntu (running 14.10)</li>
		<li>exiv2 built on head of trunk.  basicio.cpp is <a class="changeset" title="#1043 #1042 #812.  Thank You to Thomas for this &quot;polishing&quot; patch.  Thank you to everybody who ha..." href="/projects/exiv2/repository/exiv2/revisions/3635">r3635</a></li>
	</ul>


Tests:
	<ol>
	<li>Run a loop of 100 write/reads on foo.jpg.  Result OK</li>
		<li>hard-link P.jpg and Q.jpg to foo.jpg</li>
		<li>Run a loop of 10 write/reads on foo.jpg.  Result OK</li>
	</ol>


	<p>Here's the evidence:<pre>$ uname -a
Linux rmillsmbp-kubuntu 3.13.0-46-generic #79-Ubuntu SMP Tue Mar 10 20:06:50 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux

$ svn info ~/gnu/exiv2/trunk/src/basicio.cpp | grep Rev
Revision: 3644
Last Changed Rev: 3635

$ exiv2 -vV -g svn -g date -g time
exiv2 0.24 001800 (64 bit build)
date=Mar 25 2015
time=22:39:42
svn=3644
have_gmtime_r=1
have_timegm=1

$ df --print-type .
Filesystem                Type 1K-blocks     Used Available Use% Mounted on
//RMILLSMM-KUBUNTU/rmills cifs  63859580 12738888  47853776  22% /home/rmills/smb4k/RMILLSMM-KUBUNTU/rmills

$ ls -alt foo.jpg
-rw-r--r-- 1 rmills rmills 7169528 Mar 25 22:42 foo.jpg

$ for i in {1..100}; do exiv2 -M"set Exif.Photo.UserComment hello $i" foo.jpg ; exiv2 -pa -g UserComment foo.jpg; done
Exif.Photo.UserComment                       Undefined  15  hello 1
Exif.Photo.UserComment                       Undefined  15  hello 2
...
Exif.Photo.UserComment                       Undefined  16  hello 99
Exif.Photo.UserComment                       Undefined  17  hello 100

$ ln foo.jpg P.jpg
$ ln foo.jpg Q.jpg

$ for i in {200..210}; do exiv2 -M"set Exif.Photo.UserComment hello $i" foo.jpg ; exiv2 -pa -g UserComment *.jpg; done     
foo.jpg               Exif.Photo.UserComment                       Undefined  17  hello 200
P.jpg                 Exif.Photo.UserComment                       Undefined  17  hello 200
Q.jpg                 Exif.Photo.UserComment                       Undefined  17  hello 200
foo.jpg               Exif.Photo.UserComment                       Undefined  17  hello 201
P.jpg                 Exif.Photo.UserComment                       Undefined  17  hello 201
Q.jpg                 Exif.Photo.UserComment                       Undefined  17  hello 201
...
foo.jpg               Exif.Photo.UserComment                       Undefined  17  hello 210
P.jpg                 Exif.Photo.UserComment                       Undefined  17  hello 210
Q.jpg                 Exif.Photo.UserComment                       Undefined  17  hello 210
$</pre></p></div>
    </div>
  </div>
  
  <div id="change-3315" class="journal has-notes has-details">
    <div id="note-44">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-44" class="journal-link">#44</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="27 Mar 2015 12:29" href="/projects/exiv2/activity?from=2015-03-27">over 6 years</a> ago
      <span id="journal-3315-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Resolved</i></li>
    </ul>
    <div id="journal-3315-notes" class="wiki"><p>As nobody has disputed my successful test, I'm going to mark this "Resolved".  If you can reproduce this, please provide the evidence and I will investigate.  This morning, I did consider going to Berlin for Beer this morning and decided "not this time".  Our son us send ยฃ41 this morning and that'll pay for a curry in the local Indian Restaurant this evening.</p></div>
    </div>
  </div>
  
  <div id="change-3317" class="journal has-notes">
    <div id="note-45">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-45" class="journal-link">#45</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4381">thoralf schulze</a> <a title="27 Mar 2015 16:40" href="/projects/exiv2/activity?from=2015-03-27">over 6 years</a> ago
      <span id="journal-3317-private_notes" class=""></span>
    </h4>

    <div id="journal-3317-notes" class="wiki"><p>hi,</p>


	<p>i am able to use exiv2 / libexiv2 with mount.cifs "cache=none" option, which is a more or less workable situation here โฆ</p>


	<p>i also realise that mounting smb shares form a win2k8 server might not really be a commonplace endeavour. and finally, i am willing to grant shell access to the box where this issue persists to anyone who wants to investigate this issue further.</p>


	<p>short of other ideas (and still not being the c++ guy), i sprinkled debug statements all over the place (i've been using <a class="changeset" title="Adding CMake support for samples/exifdata.cpp and samples/exifvalue.cpp" href="/projects/exiv2/repository/exiv2/revisions/3637">r3637</a>):</p>


<pre>
thoralf@tfbb:~/Baustelle/exiv2/trunk$ diff -u1 -b src/actions.cpp{.orig,} 
--- src/actions.cpp.orig        2015-03-27 17:19:02.597381466 +0100
+++ src/actions.cpp     2015-03-27 16:29:12.098552387 +0100
@@ -1215,2 +1215,3 @@
     try {
+        std::cout &lt;&lt; "modify_run\n";
         if (!Exiv2::fileExists(path, true)) {
@@ -1248,2 +1249,3 @@
     {
+        std::cout &lt;&lt; "modify_apply\n";
         if (!Params::instance().jpegComment_.empty()) {
@@ -1290,2 +1292,3 @@
     {
+        std::cout &lt;&lt; "modify_addmeta\n";
         if (Params::instance().verbose_) {
@@ -1326,2 +1329,3 @@
     {
+        std::cout &lt;&lt; "modify_setmeta\n";
         if (Params::instance().verbose_) {
@@ -1398,2 +1402,3 @@
     {
+        std::cout &lt;&lt; "modify_delmeta\n";
         if (Params::instance().verbose_) {
@@ -1430,2 +1435,3 @@
     {
+        std::cout &lt;&lt; "modify_regname\n";
         if (Params::instance().verbose_) {
@@ -1453,2 +1459,3 @@
     try {
+        std::cout &lt;&lt; "adjust_run\n";
         adjustment_      = Params::instance().adjustment_;
thoralf@tfbb:~/Baustelle/exiv2/trunk$
thoralf@tfbb:~/Baustelle/exiv2/trunk$ diff -u2 -b src/basicio.cpp{.orig,} 
--- src/basicio.cpp.orig        2015-03-27 10:47:20.112838974 +0100
+++ src/basicio.cpp     2015-03-27 16:58:35.687297553 +0100
@@ -182,4 +182,5 @@
     int FileIo::Impl::switchMode(OpMode opMode)
     {
+        // std::cout &lt;&lt; "FileIo::Impl::switchMode here\n";
         assert(fp_ != 0);
         if (opMode_ == opMode) return 0;
@@ -369,4 +370,5 @@
     int FileIo::munmap()
     {
+        std::cout &lt;&lt; "fileio::munmap here\n";
         int rc = 0;
         if (p_-&gt;pMappedArea_ != 0) {
@@ -403,4 +405,5 @@
     byte* FileIo::mmap(bool isWriteable)
     {
+        std::cout &lt;&lt; "fileio::mmap here\n";
         assert(p_-&gt;fp_ != 0);
         if (munmap() != 0) {
@@ -572,4 +575,5 @@
         BasicIo::AutoPtr basicIo;

+        std::cout &lt;&lt; "hi there, basicio here\n";
         Impl::StructStat buf;
         int ret = p_-&gt;stat(buf);
@@ -587,4 +591,5 @@
         // ret = 911;
         if (ret != 0 || (buf.st_size &gt; 1048576 &#38;&#38; nlink == 1)) {
+            std::cout &lt;&lt; "doing file-io\n";
             pid_t pid = ::getpid();
             std::auto_ptr&lt;FileIo&gt; fileIo;
@@ -615,4 +620,5 @@
         }
         else {
+            std::cout &lt;&lt; "doing mem-io\n";
             basicIo.reset(new MemIo);
         }
@@ -653,4 +659,5 @@
     void FileIo::transfer(BasicIo&#38; src)
     {
+        std::cout &lt;&lt; "FileIo::transfer here\n";
         const bool wasOpen = (p_-&gt;fp_ != 0);
         const std::string lastMode(p_-&gt;openMode_);
thoralf@tfbb:~/Baustelle/exiv2/trunk$ 
</pre><br />โฆ which yields the following:<br /><pre>
KMT\adlibworker@stone:~$ /usr/local/bin/exiv2 -v -Q d -M"set Exif.Photo.PixelYDimension 66666" win2k-share-with-cache/keksrezept-small.jpg 
File 1/1: win2k-share-with-cache/keksrezept-small.jpg
modify_run
fileio::munmap here
fileio::munmap here
fileio::munmap here
fileio::munmap here
fileio::munmap here
modify_apply
modify_setmeta
Set Exif.Photo.PixelYDimension "66666" (Long)
fileio::munmap here
hi there, basicio here
doing mem-io
Info: Write strategy: Intrusive
fileio::munmap here
FileIo::transfer here
fileio::munmap here
fileio::munmap here
fileio::munmap here
KMT\adlibworker@stone:~$ /usr/local/bin/exiv2 -v -Q d -M"set Exif.Photo.PixelYDimension 66666" win2k-share-with-cache/keksrezept.jpg 
File 1/1: win2k-share-with-cache/keksrezept.jpg
modify_run
fileio::munmap here
fileio::munmap here
fileio::munmap here
fileio::munmap here
fileio::munmap here
modify_apply
modify_setmeta
Set Exif.Photo.PixelYDimension "66666" (Long)
fileio::munmap here
hi there, basicio here
doing mem-io
Info: Write strategy: Intrusive
fileio::munmap here
FileIo::transfer here
fileio::munmap here
[ โฆ hang occurs right here ]
^C
KMT\adlibworker@stone:~$ 
</pre>

a few observations:
	<ul>
	<li>the hanging process can be terminated by pressing ^C now</li>
		<li>fileio::mmap doesn't seem to be called at all</li>
		<li>commenting in the <code>std::cout << "FileIo::Impl::switchMode here\n";</code>-statement makes the code work for both my testfiles (as does strace'ing the original code, which might be related)</li>
	</ul>


	<p>with kind regards,<br />t.</p></div>
    </div>
  </div>
  
  <div id="change-3318" class="journal has-notes">
    <div id="note-46">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-46" class="journal-link">#46</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4381">thoralf schulze</a> <a title="27 Mar 2015 16:51" href="/projects/exiv2/activity?from=2015-03-27">over 6 years</a> ago
      <span id="journal-3318-private_notes" class=""></span>
    </h4>

    <div id="journal-3318-notes" class="wiki"><p>hi,</p>


	<p>s/3637/3627 - time for beer, and bon appetit to the curry connoisseurs as well :-)</p>


	<p>t.</p></div>
    </div>
  </div>
  
  <div id="change-3319" class="journal has-notes has-details">
    <div id="note-47">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-47" class="journal-link">#47</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="27 Mar 2015 17:08" href="/projects/exiv2/activity?from=2015-03-27">over 6 years</a> ago
      <span id="journal-3319-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Resolved</i> to <i>Assigned</i></li>
    </ul>
    <div id="journal-3319-notes" class="wiki"><p>Your work-around with 'cache=none' might have to be the final resolution here.</p>


	<p>You'd reported it failing on <a class="changeset" title="Fixed output error in functions.source/hardLinkFiles() reporting &quot;ln: bug812-B.jpg: File exists&quot; ..." href="/projects/exiv2/repository/exiv2/revisions/3633">r3633</a>.  basicio.cpp was changed on <a class="changeset" title="#1043 #1042 #812.  Thank You to Thomas for this &quot;polishing&quot; patch.  Thank you to everybody who ha..." href="/projects/exiv2/repository/exiv2/revisions/3635">r3635</a>.  So I though "oh, he doesn't have the latest code".<pre>$ svn log src/basicio.cpp
------------------------------------------------------------------------
r3635 | robinwmills | 2015-03-24 22:25:34 +0000 (Tue, 24 Mar 2015) | 3 lines
#1043 #1042 #812.  Thank You to Thomas for this "polishing" patch.  Bla Bla
------------------------------------------------------------------------
r3630 | robinwmills | 2015-03-24 00:27:59 +0000 (Tue, 24 Mar 2015) | 1 line
#1043 and #1042.  Thanks to Thomas for showing that r3627 reintroduced #812.
Thanks to Thoralf for suggesting msync MemIo fix.
------------------------------------------------------------------------
r3627 | robinwmills | 2015-03-21 16:35:06 +0000 (Sat, 21 Mar 2015) | 1 line
#1042 and #1043.  Don't use a MemIo object for small temporary files.</pre></p>


	<p>I can test Linux <-> W7 immediately.  I have a legal copy of W2008 Server on a DVD which I can load on a VM if necessary.</p>


	<p>Banging printf's into the code is called "Instrumentation" in the land of C++ (a posh title for hacking really).</p>


	<p>We have friends coming from the States on Tuesday for Easter.  If I don't deal with this by Tuesday, it'll have to wait for a while.</p>


	<p>Enjoy the beer and we'll enjoy the curry.</p></div>
    </div>
  </div>
  
  <div id="change-3321" class="journal has-notes">
    <div id="note-48">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-48" class="journal-link">#48</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="27 Mar 2015 21:35" href="/projects/exiv2/activity?from=2015-03-27">over 6 years</a> ago
      <span id="journal-3321-private_notes" class=""></span>
    </h4>

    <div id="journal-3321-notes" class="wiki"><p>Very strange that <code>FileIo::mmap()</code> is never called.</p>


	<p>Can you please instrument further in <code>FileIo::munmap()</code>, especially before and after <code>::munmap()</code>? I guess that it does not return in case it hangs.</p>


	<p>See also my comment:28 again: Important question is also if <code>::msync()</code> must be called before <code>FileIO::munmap()</code> is called? Can you add it and test once more?</p></div>
    </div>
  </div>
  
  <div id="change-3322" class="journal has-notes has-details">
    <div id="note-49">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-49" class="journal-link">#49</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="28 Mar 2015 11:10" href="/projects/exiv2/activity?from=2015-03-28">over 6 years</a> ago
      <span id="journal-3322-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Resolved</i></li>
    </ul>
    <div id="journal-3322-notes" class="wiki"><p>I've repeated the tests that I performed in #43 on Linux <-> Windows7.  Same perfect result.</p>


	<p>I use smb4k to mount the drives and I am not sure what options it uses.  Although I can mount the drive using the command line, I get "permission denied" when I attempt to write on the drive.</p>


	<p>Gentlemen:  I have to move on.  This matter has consumed a great deal of time during the last 2 weeks.  Thoralf has a work-around by using the mount option cache=none.  If anybody wishes to work on this, I will accept a patch <strong>IF</strong> it passes our test suite on all platforms (Mac/ Linux/ Windows/ Cygwin/ MinGW).  The test suite has been extended to provide a regression detector for both <a class="issue tracker-1 status-5 priority-5 priority-high3 closed" title="Bug: Exiv2 destroys hard links (Closed)" href="/issues/812">#812</a> and <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: pyexiv2 fails on cifs shares on an Ubuntu client (Closed)" href="/issues/1043">#1043</a>.</p>


	<p>Working on Exiv2 is a full time unpaid job.  You are both very interested in this CIFS/MemIo topic, however this is not the only matter competing for my time.  We are evaluating proposals for Google Summer of Code 2015.  Daniel wants our CMake/MSVC support improved.  Mikayel got 8 hours of my time on Wednesday.  There are outstanding matters to be dealt with for v0.25 and Jenkins.  George wants a bug investigated where occasionally (but not consistently) crashes while processing every file in a directory of 40000 images on Windows.  And there will be some other matters that I have forgotten at the moment.  Oh, and I have a life as well.</p></div>
    </div>
  </div>
  
  <div id="change-3323" class="journal has-notes has-details">
    <div id="note-50">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-50" class="journal-link">#50</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4381">thoralf schulze</a> <a title="30 Mar 2015 18:16" href="/projects/exiv2/activity?from=2015-03-30">over 6 years</a> ago
      <span id="journal-3323-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/745">diff_thoralf.diff</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/745/diff_thoralf.diff">diff_thoralf.diff</a> added</li>
    </ul>
    <div id="journal-3323-notes" class="wiki"><p>hi,</p>


	<p>i consider 1042 and 1043 to be non-trivial bugs in exiv2 that should be squashed now, and i am willing to investigate further. if time permits :-/</p>


	<p>instrumenting the hell out of fileinfo::munmap() (see the attached patch [against the current trunk]), i can conclude that ::munmap never gets called either:<br /><pre>
KMT\adlibworker@stone:~$ /usr/local/bin/exiv2 -v -Q d -M"set Exif.Photo.PixelYDimension 66666" win2k-share-with-cache/keksrezept.jpg 
File 1/1: win2k-share-with-cache/keksrezept.jpg
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0
 โฆ return value: 0
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0
 โฆ return value: 0
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0
 โฆ return value: 0
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0
 โฆ return value: 0
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0
 โฆ return value: 0
Set Exif.Photo.PixelYDimension "66666" (Long)
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0
 โฆ return value: 0
Info: Write strategy: Intrusive
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0
 โฆ return value: 0
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0
 โฆ return value: 0
</pre><br />does <code>if (p_->pMappedArea_ != 0)</code> (line 372) check for a null pointer?</p>


	<p>for reference, the same test with the (working) small file:<br /><pre>
KMT\adlibworker@stone:~$ /usr/local/bin/exiv2 -v -Q d -M"set Exif.Photo.PixelYDimension 66666" win2k-share-with-cache/keksrezept-sma
ll.jpg
File 1/1: win2k-share-with-cache/keksrezept-small.jpg
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0 
 โฆ return value: 0  
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0 
 โฆ return value: 0  
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0 
 โฆ return value: 0  
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0 
 โฆ return value: 0  
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0 
 โฆ return value: 0  
Set Exif.Photo.PixelYDimension "66666" (Long)
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0 
 โฆ return value: 0  
Info: Write strategy: Intrusive
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0 
 โฆ return value: 0  
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0 
 โฆ return value: 0  
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0
 โฆ return value: 0
fileio::munmap
 โฆ common block
   โฆ iswriteable: 0
 โฆ return value: 0  
KMT\adlibworker@stone:~$
</pre></p>


	<p>i guess that p_->isWriteable_ should evaluate to true at some point, shouldn't it?</p>


	<p>thank you &#38; with kind regards,<br />t.</p></div>
    </div>
  </div>
  
  <div id="change-3324" class="journal has-notes">
    <div id="note-51">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-51" class="journal-link">#51</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4381">thoralf schulze</a> <a title="30 Mar 2015 18:34" href="/projects/exiv2/activity?from=2015-03-30">over 6 years</a> ago
      <span id="journal-3324-private_notes" class=""></span>
    </h4>

    <div id="journal-3324-notes" class="wiki"><p>hi thomas,</p>


	<p>Thomas Beutlich wrote:</p>


<blockquote>

	<p>See also my comment:28 again: Important question is also if <code>::msync()</code> must be called before <code>FileIO::munmap()</code> is called? Can you add it and test once more?</p>


</blockquote>

	<p>where exactly do you want me to put it?</p>


	<p>with kind regards,<br />t.</p></div>
    </div>
  </div>
  
  <div id="change-3325" class="journal has-notes">
    <div id="note-52">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-52" class="journal-link">#52</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="30 Mar 2015 18:47" href="/projects/exiv2/activity?from=2015-03-30">over 6 years</a> ago
      <span id="journal-3325-private_notes" class=""></span>
    </h4>

    <div id="journal-3325-notes" class="wiki"><p>Gentlemen</p>


	<p>I am now on vacation.  We have friends here from California.  I will be checking email while on the road, however my time for working is limited.  They leave on April 10.</p>


	<p>I have requested write access to the repository for Thomas and I wish you well in getting to the bottom of this matter.  To avoid debugging this on the trunk, I will set up a new branch "memio-investigation" and monitor in with Jenkins.  <a class="external" href="http://exiv2.dyndns.org:8080/">http://exiv2.dyndns.org:8080/</a></p>


	<p>Robin</p></div>
    </div>
  </div>
  
  <div id="change-3326" class="journal has-notes">
    <div id="note-53">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-53" class="journal-link">#53</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="30 Mar 2015 18:52" href="/projects/exiv2/activity?from=2015-03-30">over 6 years</a> ago
      <span id="journal-3326-private_notes" class=""></span>
    </h4>

    <div id="journal-3326-notes" class="wiki"><p>I just started to debug (on Win though).</p>


	<p>Yes, I also disgagree on moving on too early. Behaviour shall be identical for small and large files!</p></div>
    </div>
  </div>
  
  <div id="change-3331" class="journal has-notes">
    <div id="note-54">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-54" class="journal-link">#54</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="30 Mar 2015 20:24" href="/projects/exiv2/activity?from=2015-03-30">over 6 years</a> ago
      <span id="journal-3331-private_notes" class=""></span>
    </h4>

    <div id="journal-3331-notes" class="wiki"><p>Thank you both Thoralf and Thomas for getting involved with this.  I'm exhausted and need a break.</p></div>
    </div>
  </div>
  
  <div id="change-3332" class="journal has-details">
    <div id="note-55">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-55" class="journal-link">#55</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="30 Mar 2015 20:24" href="/projects/exiv2/activity?from=2015-03-30">over 6 years</a> ago
      <span id="journal-3332-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Resolved</i> to <i>Assigned</i></li>
       <li><strong>Assignee</strong> changed from <i>Robin Mills</i> to <i>Thomas Beutlich</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-3335" class="journal has-notes">
    <div id="note-56">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-56" class="journal-link">#56</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="30 Mar 2015 21:20" href="/projects/exiv2/activity?from=2015-03-30">over 6 years</a> ago
      <span id="journal-3335-private_notes" class=""></span>
    </h4>

    <div id="journal-3335-notes" class="wiki"><p>OK, <code>FileIo::munmap()</code> actually does nothing since for jpg files there never is <code>FileIo::mmap()</code> called. Thus we do not need to further concentrate on this. Telling from Thoralf logs I propose to further concentrate on function <code>FileIo::transfer()</code>.</p>


Can you please,
	<ul>
	<li>in FileIo::munmap() change the first line to</li>
	</ul>


<code><br />std::cout << "fileio::munmap " << p_ << " " << p_->path_ << "\n";<br /></code>
	<ul>
	<li><code>FileIo::close()</code> replace by</li>
	</ul>


	<p>@<br />    int FileIo::close()
    {<br />        int rc = 0;<br />        if (munmap() != 0) rc = 2;<br />        if (p_->fp_ != 0) {<br />            std::cout << "before close\n";<br />            if (std::fclose(p_->fp_) != 0) rc |= 1;<br />            std::cout << "after close\n";<br />            p_->fp_= 0;<br />        }<br />        return rc;<br />    }<br />@</p>


	<ul>
	<li>and <code>FileIo::open()</code> replace by<br />@<br />    int FileIo::open(const std::string&#38; mode)
    {<br />        close();<br />        p_->openMode_ = mode;<br />        p_->opMode_ = Impl::opSeek;<br />#ifdef EXV_UNICODE_PATH<br />        if (p_->wpMode_ == Impl::wpUnicode) {<br />            std::cout << "before open\n";<br />            p_->fp_ = ::_wfopen(wpath().c_str(), s2ws(mode).c_str());<br />            std::cout << "after open\n";<br />        }<br />        else<br />#endif
        {<br />            std::cout << "before open\n";<br />            p_->fp_ = ::fopen(path().c_str(), mode.c_str());<br />            std::cout << "after open\n";<br />        }<br />        if (!p_->fp_) return 1;<br />        return 0;<br />    }<br />@</li>
	</ul></div>
    </div>
  </div>
  
  <div id="change-3340" class="journal has-notes">
    <div id="note-57">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-57" class="journal-link">#57</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4381">thoralf schulze</a> <a title="31 Mar 2015 09:09" href="/projects/exiv2/activity?from=2015-03-31">over 6 years</a> ago
      <span id="journal-3340-private_notes" class=""></span>
    </h4>

    <div id="journal-3340-notes" class="wiki"><p>hi,</p>


	<p>robin: thank you for your cooperation :-)<br />thomas โฆ thank you for having a look. small file:<br /><pre>
KMT\adlibworker@stone:~$ /usr/local/bin/exiv2 -v -Q d -M"set Exif.Photo.PixelYDimension 66666" win2k-share-with-cache/keksrezept-small.jpg 
File 1/1: win2k-share-with-cache/keksrezept-small.jpg
fileio::munmap 0x14d3a50 win2k-share-with-cache/keksrezept-small.jpg
before open
after open
fileio::munmap 0x14d3a50 win2k-share-with-cache/keksrezept-small.jpg
before close
after close
before open
after open
fileio::munmap 0x14d3a50 win2k-share-with-cache/keksrezept-small.jpg
before close
after close
fileio::munmap 0x14d3a50 win2k-share-with-cache/keksrezept-small.jpg
before open
after open
fileio::munmap 0x14d3a50 win2k-share-with-cache/keksrezept-small.jpg
before close
after close
Set Exif.Photo.PixelYDimension "66666" (Long)
fileio::munmap 0x14d3a50 win2k-share-with-cache/keksrezept-small.jpg
before open
after open
Info: Write strategy: Intrusive
fileio::munmap 0x14d3a50 win2k-share-with-cache/keksrezept-small.jpg
before close
after close
fileio::munmap 0x14d3a50 win2k-share-with-cache/keksrezept-small.jpg
before open
after open
fileio::munmap 0x14d3a50 win2k-share-with-cache/keksrezept-small.jpg
before close
after close
fileio::munmap 0x14d3a50 win2k-share-with-cache/keksrezept-small.jpg
KMT\adlibworker@stone:~$ 
</pre><br />big file:<br /><pre>
KMT\adlibworker@stone:~$ /usr/local/bin/exiv2 -v -Q d -M"set Exif.Photo.PixelYDimension 66666" win2k-share-with-cache/keksrezept.jpg 
File 1/1: win2k-share-with-cache/keksrezept.jpg
fileio::munmap 0x2004a50 win2k-share-with-cache/keksrezept.jpg
before open
after open
fileio::munmap 0x2004a50 win2k-share-with-cache/keksrezept.jpg
before close
after close
before open
after open
fileio::munmap 0x2004a50 win2k-share-with-cache/keksrezept.jpg
before close
after close
fileio::munmap 0x2004a50 win2k-share-with-cache/keksrezept.jpg
before open
after open
fileio::munmap 0x2004a50 win2k-share-with-cache/keksrezept.jpg
before close
after close
Set Exif.Photo.PixelYDimension "66666" (Long)
fileio::munmap 0x2004a50 win2k-share-with-cache/keksrezept.jpg
before open
after open
Info: Write strategy: Intrusive
fileio::munmap 0x2004a50 win2k-share-with-cache/keksrezept.jpg
before close
after close
fileio::munmap 0x2004a50 win2k-share-with-cache/keksrezept.jpg
before open
after open
fileio::munmap 0x2004a50 win2k-share-with-cache/keksrezept.jpg
before close
after close
fileio::munmap 0x2004a50 win2k-share-with-cache/keksrezept.jpg
KMT\adlibworker@stone:~$ 
</pre><br />โฆ no hang on this call. next try:<br /><pre>
KMT\adlibworker@stone:~$ /usr/local/bin/exiv2 -v -Q d -M"set Exif.Photo.PixelYDimension 66666" win2k-share-with-cache/keksrezept.jpg 
File 1/1: win2k-share-with-cache/keksrezept.jpg
fileio::munmap 0x1705a50 win2k-share-with-cache/keksrezept.jpg
before open
after open
fileio::munmap 0x1705a50 win2k-share-with-cache/keksrezept.jpg
before close
after close
before open
after open
fileio::munmap 0x1705a50 win2k-share-with-cache/keksrezept.jpg
before close
after close
fileio::munmap 0x1705a50 win2k-share-with-cache/keksrezept.jpg
before open
after open
fileio::munmap 0x1705a50 win2k-share-with-cache/keksrezept.jpg
before close
after close
Set Exif.Photo.PixelYDimension "66666" (Long)
fileio::munmap 0x1705a50 win2k-share-with-cache/keksrezept.jpg
before open
after open
Info: Write strategy: Non-intrusive
fileio::munmap 0x1705a50 win2k-share-with-cache/keksrezept.jpg
before close
after close
fileio::munmap 0x1705a50 win2k-share-with-cache/keksrezept.jpg
before open
after open

[ โฆ hang ]
</pre></p>


	<p>thank you &#38; with kind regards,<br />t.</p>


	<p>btw: please send me an openvpn certificate request if you need access to the machine โฆ</p></div>
    </div>
  </div>
  
  <div id="change-3341" class="journal has-notes">
    <div id="note-58">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-58" class="journal-link">#58</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="31 Mar 2015 09:30" href="/projects/exiv2/activity?from=2015-03-31">over 6 years</a> ago
      <span id="journal-3341-private_notes" class=""></span>
    </h4>

    <div id="journal-3341-notes" class="wiki"><p>Can you try ro reproduce the hang with intrusive write strategy. This is different in the last two logs of the big file. Maybe you need to set other value than 66666.</p>


	<p>On Win it looks completely different where a temp file is opened.</p>


Can you please debug where it hangs with gdb?
	<ul>
	<li>Compile exiv2 with <code>-g</code></li>
		<li>In shell type: <code>gdb exiv2</code></li>
		<li>Then type in gdb shell: <code>run -v -Q d -M"set Exif.Photo.PixelYDimension 66666" win2k-share-with-cache/keksrezept.jpg</code></li>
		<li>When it hangs type: <code>where</code></li>
	</ul></div>
    </div>
  </div>
  
  <div id="change-3342" class="journal has-notes">
    <div id="note-59">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-59" class="journal-link">#59</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4381">thoralf schulze</a> <a title="31 Mar 2015 10:05" href="/projects/exiv2/activity?from=2015-03-31">over 6 years</a> ago
      <span id="journal-3342-private_notes" class=""></span>
    </h4>

    <div id="journal-3342-notes" class="wiki"><p>hi thomas,</p>


	<p>Thomas Beutlich wrote:</p>


<blockquote>

	<p>Can you try ro reproduce the hang with intrusive write strategy. This is different in the last two logs of the big file. Maybe you need to set other value than 66666.</p>


</blockquote>

	<p>seems to be hit and miss โฆ sometimes exiv2 does not hang when intrusive is being used, most of the time it does - the successful execution in #57 seems to be a rare exception. when it succeeds to write the big file, it resorts to non-intrusive on the next run, which then also hangs most of the time.</p>


<blockquote>

Can you please debug where it hangs with gdb?
	<ul>
	<li>Compile exiv2 with <code>-g</code></li>
		<li>In shell type: <code>gdb exiv2</code></li>
		<li>Then type in gdb shell: <code>run -v -Q d -M"set Exif.Photo.PixelYDimension 66666" win2k-share-with-cache/keksrezept.jpg</code></li>
		<li>When it hangs type: <code>where</code></li>
	</ul>


</blockquote>

	<p>i am not able to ^c back to gdb once exiv2 hangs:<br /><pre>
KMT\adlibworker@stone:~$ gdb /usr/local/bin/exiv2
GNU gdb (GDB) 7.4.1-debian
Copyright (C) 2012 Free Software Foundation, Inc.
[ bla โฆ ]
Reading symbols from /usr/local/bin/exiv2...done.
(gdb) run -v -Q d -M"set Exif.Photo.PixelYDimension 66666" win2k-share-with-cache/keksrezept.jpg
Starting program: /usr/local/bin/exiv2 -v -Q d -M"set Exif.Photo.PixelYDimension 66666" win2k-share-with-cache/keksrezept.jpg
File 1/1: win2k-share-with-cache/keksrezept.jpg
fileio::munmap 0x62aa50 win2k-share-with-cache/keksrezept.jpg
before open
[ โฆ like above]
fileio::munmap 0x62aa50 win2k-share-with-cache/keksrezept.jpg
before open
after open
[ โฆ hang occurs here ]
^C
where
^C
where
^C^C^C^C

where
bt
</pre></p>


	<p>โฆ i'll try to play around with breakpoints.</p>


	<p>with kind regards,<br />t.</p></div>
    </div>
  </div>
  
  <div id="change-3343" class="journal has-notes">
    <div id="note-60">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-60" class="journal-link">#60</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="31 Mar 2015 10:15" href="/projects/exiv2/activity?from=2015-03-31">over 6 years</a> ago
      <span id="journal-3343-private_notes" class=""></span>
    </h4>

    <div id="journal-3343-notes" class="wiki"><p>Thanks for testing. <code>FileIO::transfer()</code> should be a good candicate to play with.</p></div>
    </div>
  </div>
  
  <div id="change-3344" class="journal has-notes">
    <div id="note-61">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-61" class="journal-link">#61</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4381">thoralf schulze</a> <a title="31 Mar 2015 13:20" href="/projects/exiv2/activity?from=2015-03-31">over 6 years</a> ago
      <span id="journal-3344-private_notes" class=""></span>
    </h4>

    <div id="journal-3344-notes" class="wiki"><p>hi thomas,</p>


	<p>the hang occurs in FileIo::transfer's <code>write(src)</code>-line - this is <a class="issue tracker-4 status-5 priority-4 priority-default closed" title="Patch: User-readable output of Olympus&#39; FocusDistance (Closed)" href="/issues/896">#896</a> in the non-instrumented source.</p>


<pre>
KMT\adlibworker@stone:~$ gdb /usr/local/bin/exiv2 
[โฆ]
(gdb) # this is the beginning of void FileIo::transfer(BasicIo&#38; src)
(gdb) break basicio.cpp:690
(gdb) run -v -Q d -M"set Exif.Photo.PixelYDimension 66666" win2k-share-with-cache/keksrezept.jpg
Starting program: /usr/local/bin/exiv2 -v -Q d -M"set Exif.Photo.PixelYDimension 66666" win2k-share-with-cache/keksrezept.jpg
File 1/1: win2k-share-with-cache/keksrezept.jpg
fileio::munmap 0x62aa50 win2k-share-with-cache/keksrezept.jpg
before open
after open
fileio::munmap 0x62aa50 win2k-share-with-cache/keksrezept.jpg
[โฆ]
Set Exif.Photo.PixelYDimension "66666" (Long)
fileio::munmap 0x62aa50 win2k-share-with-cache/keksrezept.jpg
before open
after open
Info: Write strategy: Intrusive
fileio::munmap 0x62aa50 win2k-share-with-cache/keksrezept.jpg
before close
after close
FileIo::transfer here

Breakpoint 2, Exiv2::FileIo::transfer (this=0x62aa30, src=...) at basicio.cpp:691
warning: Source file is more recent than executable.
691             const bool wasOpen = (p_-&gt;fp_ != 0);
(gdb) n
692             const std::string lastMode(p_-&gt;openMode_);
(gdb) n
691             const bool wasOpen = (p_-&gt;fp_ != 0);
(gdb) n
692             const std::string lastMode(p_-&gt;openMode_);
(gdb) n
691             const bool wasOpen = (p_-&gt;fp_ != 0);
(gdb) n
692             const std::string lastMode(p_-&gt;openMode_);
(gdb) n
694             FileIo *fileIo = dynamic_cast&lt;FileIo*&gt;(&#38;src);
(gdb) n
695             if (fileIo) {
(gdb) n
694             FileIo *fileIo = dynamic_cast&lt;FileIo*&gt;(&#38;src);
(gdb) n
695             if (fileIo) {
(gdb) n
913                 if (open("w+b") != 0) {
(gdb) n
fileio::munmap 0x62aa50 win2k-share-with-cache/keksrezept.jpg
before open
after open
924                 if (src.open() != 0) {
(gdb) n
935                 write(src);
(gdb) n
[ โฆ hang]
</pre>

	<p>with kind regards,<br />t.</p></div>
    </div>
  </div>
  
  <div id="change-3345" class="journal has-notes">
    <div id="note-62">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-62" class="journal-link">#62</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4381">thoralf schulze</a> <a title="31 Mar 2015 13:28" href="/projects/exiv2/activity?from=2015-03-31">over 6 years</a> ago
      <span id="journal-3345-private_notes" class=""></span>
    </h4>

    <div id="journal-3345-notes" class="wiki"><p>hi,</p>


	<p>a bit more detail:<br /><pre>
677                 writeTotal += writeCount = (long)std::fwrite(buf, 1, readCount, p_-&gt;fp_);
(gdb) n
678                 if (writeCount != readCount) {
(gdb) n
676             while ((readCount = src.read(buf, sizeof(buf)))) {
(gdb) n
677                 writeTotal += writeCount = (long)std::fwrite(buf, 1, readCount, p_-&gt;fp_);
(gdb) n
678                 if (writeCount != readCount) {
(gdb) n
676             while ((readCount = src.read(buf, sizeof(buf)))) {
(gdb) n
677                 writeTotal += writeCount = (long)std::fwrite(buf, 1, readCount, p_-&gt;fp_);
(gdb) n
n
[โฆ hang]
</pre><br />โฆ this is <code>long FileIo::write(BasicIo&#38; src)</code></p>


	<p>with kind regards,<br />t.</p></div>
    </div>
  </div>
  
  <div id="change-3346" class="journal has-notes">
    <div id="note-63">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-63" class="journal-link">#63</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4381">thoralf schulze</a> <a title="31 Mar 2015 13:53" href="/projects/exiv2/activity?from=2015-03-31">over 6 years</a> ago
      <span id="journal-3346-private_notes" class=""></span>
    </h4>

    <div id="journal-3346-notes" class="wiki"><p>hi,</p>


	<p>amending the write-loop in <code>long FileIo::write(BasicIo&#38; src)</code> like this:<br /><pre>
        while ((readCount = src.read(buf, sizeof(buf)))) {
            std::cout &lt;&lt; "write loop โฆ rc: " &lt;&lt; readCount &lt;&lt; " wc: " &lt;&lt; writeCount &lt;&lt; " wt: " &lt;&lt; writeTotal &lt;&lt; "\n";
            writeTotal += writeCount = (long)std::fwrite(buf, 1, readCount, p_-&gt;fp_);
            if (writeCount != readCount) {
                // try to reset back to where write stopped
                src.seek(writeCount-readCount, BasicIo::cur);
                break;
            }
        }
</pre><br />yields this for the large file:<br /><pre>
FileIo::transfer here
fileio::munmap 0xaf0a50 win2k-share-with-cache/keksrezept.jpg
before open
after open
in fileio::write โฆ
write loop โฆ rc: 4096 wc: 0 wt: 0
write loop โฆ rc: 4096 wc: 4096 wt: 4096
write loop โฆ rc: 4096 wc: 4096 wt: 8192
write loop โฆ rc: 4096 wc: 4096 wt: 12288
write loop โฆ rc: 4096 wc: 4096 wt: 16384
[ โฆ hang]
</pre><br />and this:<br /><pre>
FileIo::transfer here
fileio::munmap 0x1ecea50 win2k-share-with-cache/keksrezept-small.jpg
before open
after open
in fileio::write โฆ
write loop โฆ rc: 4096 wc: 0 wt: 0
write loop โฆ rc: 4096 wc: 4096 wt: 4096
write loop โฆ rc: 4096 wc: 4096 wt: 8192
write loop โฆ rc: 4096 wc: 4096 wt: 12288
write loop โฆ rc: 4096 wc: 4096 wt: 16384
write loop โฆ rc: 4096 wc: 4096 wt: 20480
write loop โฆ rc: 4096 wc: 4096 wt: 24576
write loop โฆ rc: 1648 wc: 4096 wt: 28672
fileio::munmap 0x1ecea50 win2k-share-with-cache/keksrezept-small.jpg
before close
after close
fileio::munmap 0x1ecea50 win2k-share-with-cache/keksrezept-small.jpg
KMT\adlibworker@stone:~$
</pre><br />for the small file. i'm stumped.</p>


	<p>with kind regards,<br />t.</p></div>
    </div>
  </div>
  
  <div id="change-3347" class="journal has-notes">
    <div id="note-64">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-64" class="journal-link">#64</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="31 Mar 2015 14:55" href="/projects/exiv2/activity?from=2015-03-31">over 6 years</a> ago
      <span id="journal-3347-private_notes" class=""></span>
    </h4>

    <div id="journal-3347-notes" class="wiki"><p>Guys</p>


	<p>Can I encourage you to look at samples/iotest.cpp.  It's effectively a file copy program which uses both FileIO and MemIO in basicio.cpp.  It's used by our test suite - however it's worth playing with this a little on large and small files.  It's easy to understand it.</p>


	<p>Thanks for doing this work.</p>


	<p>Robin</p></div>
    </div>
  </div>
  
  <div id="change-3348" class="journal has-notes">
    <div id="note-65">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-65" class="journal-link">#65</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="31 Mar 2015 21:03" href="/projects/exiv2/activity?from=2015-03-31">over 6 years</a> ago
      <span id="journal-3348-private_notes" class=""></span>
    </h4>

    <div id="journal-3348-notes" class="wiki"><p>To give an expression how it looks on Win:<br /><pre>
C:\Projekte\wdx_jpg_comment_src\exiv2\msvc\exiv2\Debug&gt;exiv2 -v -Q d -M"set Exif.Photo.PixelYDimension 66666" keksrezept.jpg
File 1/1: keksrezept.jpg
fileio::munmap 003A7370 keksrezept.jpg
 . common block
   . iswriteable: 0
 . return value: 0
before open
after open
fileio::munmap 003A7370 keksrezept.jpg
 . common block
   . iswriteable: 0
 . return value: 0
before close
after close
before open
after open
fileio::munmap 003A7370 keksrezept.jpg
 . common block
   . iswriteable: 0
 . return value: 0
before close
after close
fileio::munmap 003A7370 keksrezept.jpg
 . common block
   . iswriteable: 0
 . return value: 0
before open
after open
fileio::munmap 003A7370 keksrezept.jpg
 . common block
   . iswriteable: 0
 . return value: 0
before close
after close
Set Exif.Photo.PixelYDimension "66666" (Long)
fileio::munmap 003A7370 keksrezept.jpg
 . common block
   . iswriteable: 0
 . return value: 0
before open
after open
fileio::munmap 007BB9B8 keksrezept.jpg2056
 . common block
   . iswriteable: 0
 . return value: 0
before open
after open
Info: Write strategy: Non-intrusive
fileio::munmap 003A7370 keksrezept.jpg
 . common block
   . iswriteable: 0
 . return value: 0
before close
after close
fileio::munmap 007BB9B8 keksrezept.jpg2056
 . common block
   . iswriteable: 0
 . return value: 0
before close
after close
fileio::munmap 003A7370 keksrezept.jpg
 . common block
   . iswriteable: 0
 . return value: 0
before open
after open
fileio::munmap 003A7370 keksrezept.jpg
 . common block
   . iswriteable: 0
 . return value: 0
before close
after close
fileio::munmap 003A7370 keksrezept.jpg
 . common block
   . iswriteable: 0
 . return value: 0
fileio::munmap 007BB9B8 keksrezept.jpg2056
 . common block
   . iswriteable: 0
 . return value: 0
fileio::munmap 003A7370 keksrezept.jpg
 . common block
   . iswriteable: 0
 . return value: 0
</pre><br />You see that there is a temporary file with trailing PID created by <code>JpegBase::writeMetadata()</code> -> <code>FileIo::temporary()</code>. Why is there no such file in the Linux case?</p></div>
    </div>
  </div>
  
  <div id="change-3349" class="journal has-notes">
    <div id="note-66">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-66" class="journal-link">#66</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="31 Mar 2015 21:43" href="/projects/exiv2/activity?from=2015-03-31">over 6 years</a> ago
      <span id="journal-3349-private_notes" class=""></span>
    </h4>

    <div id="journal-3349-notes" class="wiki"><p>Sorry, forget about my last comment. We are doing <code>MemIo</code> here which is case for large files having hard links.</p></div>
    </div>
  </div>
  
  <div id="change-3350" class="journal has-notes">
    <div id="note-67">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-67" class="journal-link">#67</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="31 Mar 2015 22:12" href="/projects/exiv2/activity?from=2015-03-31">over 6 years</a> ago
      <span id="journal-3350-private_notes" class=""></span>
    </h4>

    <div id="journal-3350-notes" class="wiki">Some (alternative) ideas for <code>long FileIo::write(BasicIo&#38; src)</code> to test.
	<ul>
	<li>Increase buffer size to some greater value. For test you could also try to set the exact file size (or some greater value) as buffer size such that there is only one call to <code>std::fwrite()</code>.</li>
		<li>Call <code>setvbuf(p_->fp_, NULL, _IONBF, 0);</code> anywhere before the <code>while</code> loop.</li>
		<li>Call <code>setvbuf(p_->fp_, (char*)buf, _IOFBF, 4096);</code> anywhere before the <code>while</code> loop.</li>
		<li>Call <code>setvbuf(p_->fp_, NULL, _IOFBF, 4096);</code> anywhere before the <code>while</code> loop.</li>
		<li>Call <code>fflush(p_->fp_);</code> after each call to <code>std::fwrite()</code>.</li>
		<li>Swap second and third element of <code>std::fwrite()@to @std::fwrite(buf, readCount, 1, p_->fp_)</code>. Should not matter.</li>
	</ul></div>
    </div>
  </div>
  
  <div id="change-3353" class="journal has-notes">
    <div id="note-68">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-68" class="journal-link">#68</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4381">thoralf schulze</a> <a title="02 Apr 2015 12:55" href="/projects/exiv2/activity?from=2015-04-02">over 6 years</a> ago
      <span id="journal-3353-private_notes" class=""></span>
    </h4>

    <div id="journal-3353-notes" class="wiki"><p>hi there,</p>


	<p>just a quick note: i'll be on vacation next week and won't show up here. i will definitely have a look at iotest.cpp and thomas' suggestions afterwards โฆ</p>


	<p>thank you &#38; with kind regards,<br />t.</p></div>
    </div>
  </div>
  
  <div id="change-3354" class="journal has-notes">
    <div id="note-69">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-69" class="journal-link">#69</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="02 Apr 2015 17:01" href="/projects/exiv2/activity?from=2015-04-02">over 6 years</a> ago
      <span id="journal-3354-private_notes" class=""></span>
    </h4>

    <div id="journal-3354-notes" class="wiki"><p>Have a nice break, Thoralf.  We'll talk when you (and I) get back to work.</p>


	<p>Robin</p></div>
    </div>
  </div>
  
  <div id="change-3403" class="journal has-notes">
    <div id="note-70">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-70" class="journal-link">#70</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4378">Calvin Browne</a> <a title="11 Apr 2015 07:55" href="/projects/exiv2/activity?from=2015-04-11">over 6 years</a> ago
      <span id="journal-3403-private_notes" class=""></span>
    </h4>

    <div id="journal-3403-notes" class="wiki"><p>Hi Guys,</p>


	<p>got back from my break.</p>


	<p>svn checkout svn://dev.exiv2.org/svn/trunk<br />make config<br />cd trunk/<br />make config<br />./configure</p>


	<p>and yay!</p>


	<p>for i in `ls`; do ~/exiv2-trunk/trunk/bin/exiv2 -v -M"set Exif.Photo.UserComment charset=Ascii New Exif comment2" $i; done</p>


	<p>runs through, several times with no truncations. (Ubuntu 14.04.2 LTS client &#38; server)</p>


	<p>did a 'make install' and loaded up shotwell and it no hangs on my 50k library (although to be fair only a portion of them were due to have comments rewritten).</p>


	<p>So, from <strong>my</strong> perspective all looks good.</p>


	<p>Any pointers on getting this fix into the Ubuntu project? (I'm not fortunate enough to be involved in these things regularly so know the procedures so pointers would help).</p>


	<p>Many thanks!</p>


	<p>--Calvin</p></div>
    </div>
  </div>
  
  <div id="change-3404" class="journal has-notes">
    <div id="note-71">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-71" class="journal-link">#71</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="11 Apr 2015 08:29" href="/projects/exiv2/activity?from=2015-04-11">over 6 years</a> ago
      <span id="journal-3404-private_notes" class=""></span>
    </h4>

    <div id="journal-3404-notes" class="wiki"><p>Calvin</p>


	<p>How nice to hear from you.  And to hear your good news.</p>


	<p>Thoralf and Thomas are continuing to work on this matter.  There's no smoke without fire and Thoralf can see smoke on Windows Server 2008.  So T &#38; T are going to continue to work on this and that enables me to pursue other matters.</p>


	<p>Hope you've enjoyed your trip.</p>


	<p>Robin</p></div>
    </div>
  </div>
  
  <div id="change-3456" class="journal has-notes">
    <div id="note-72">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-72" class="journal-link">#72</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="20 Apr 2015 19:21" href="/projects/exiv2/activity?from=2015-04-20">over 6 years</a> ago
      <span id="journal-3456-private_notes" class=""></span>
    </h4>

    <div id="journal-3456-notes" class="wiki"><p><a class="user active" href="/users/4381">thoralf schulze</a>: Do you have any news on my above suggestions? Obviously you are the only one left who can reproduce the problem.</p></div>
    </div>
  </div>
  
  <div id="change-3479" class="journal has-notes">
    <div id="note-73">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-73" class="journal-link">#73</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4381">thoralf schulze</a> <a title="23 Apr 2015 19:57" href="/projects/exiv2/activity?from=2015-04-23">over 6 years</a> ago
      <span id="journal-3479-private_notes" class=""></span>
    </h4>

    <div id="journal-3479-notes" class="wiki"><p>hi thomas, hi all,</p>


	<p>โฆ sorry for taking so long, i am drowning in work. i was just about to try thomas' suggestions and cannot reproduce the issue anymore. long story short: about a week ago, we've had to reboot the machine that exhibited the symptoms - it all works fine now, sorry for making demands on your time.</p>


	<p>a bit more nitty-gritty: the machine needed a reboot due to a bunch of more or less critical updates accumulating. among them was a kernel updateยน - skimming through the changelogs, i found these notes:<br />- cifs: fix deadlock in cifs_ioctl_clone()<br />- cifs: Complete oplock break jobs before closing file handle (regression in 3.15)<br />โฆ both issues were fixed in 3.16.7-ckt7-1. i suspect that the latter patch fixes our issue, please see <a class="external" href="http://permalink.gmane.org/gmane.linux.kernel.stable/123919">http://permalink.gmane.org/gmane.linux.kernel.stable/123919</a> for details.</p>


	<p>i've let my testcase run for a while now, with both my butchered version of exiv2 and the one from the debian repositories โฆ they did run for 1000+ iterations now, without any hiccups.</p>


	<p>i guess we are all set now - please feel free to close this issue. "beers in berlin for anyone involved" is still (and will always be) a standing offer.</p>


	<p>thank you very much for your time &#38; with kind regards,<br />t.</p>


	<p>ยน - linux-image-3.16.0-0.bpo.4-amd64:amd64 3.16.7-ckt4-3~bpo70+1 to 3.16.7-ckt7-1~bpo70+1</p></div>
    </div>
  </div>
  
  <div id="change-3480" class="journal has-notes has-details">
    <div id="note-74">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-74" class="journal-link">#74</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="23 Apr 2015 20:21" href="/projects/exiv2/activity?from=2015-04-23">over 6 years</a> ago
      <span id="journal-3480-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Resolved</i></li>
    </ul>
    <div id="journal-3480-notes" class="wiki"><p>Well this is a very happy ending and a fine state of affairs.  Well, apart from your drowning in work.  Good team-work all round here.  And some beer in Berlin's a great offer - you'll find I can be very thirsty!  If you're in England, let me know.  We're 20 miles from Heathrow in the beautiful county of Surrey.</p></div>
    </div>
  </div>
  
  <div id="change-3482" class="journal has-notes">
    <div id="note-75">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-75" class="journal-link">#75</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="24 Apr 2015 08:06" href="/projects/exiv2/activity?from=2015-04-24">over 6 years</a> ago
      <span id="journal-3482-private_notes" class=""></span>
    </h4>

    <div id="journal-3482-notes" class="wiki"><p>Good news. Thanks.</p>


	<p>Will check again which commits were done here and if they were necessary.</p>


	<p>@Robin: i think you can delete the svn branch you offered for testing.</p></div>
    </div>
  </div>
  
  <div id="change-3483" class="journal has-notes">
    <div id="note-76">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-76" class="journal-link">#76</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Apr 2015 08:21" href="/projects/exiv2/activity?from=2015-04-24">over 6 years</a> ago
      <span id="journal-3483-private_notes" class=""></span>
    </h4>

    <div id="journal-3483-notes" class="wiki"><p>Good thinking, Thomas.  Can you review changes and tidy up if necessary.  I've removed the memo-investigation branch from SVN and removed the branch monitor from Jenkins.</p></div>
    </div>
  </div>
  
  <div id="change-3501" class="journal has-notes">
    <div id="note-77">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-77" class="journal-link">#77</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="25 Apr 2015 21:16" href="/projects/exiv2/activity?from=2015-04-25">over 6 years</a> ago
      <span id="journal-3501-private_notes" class=""></span>
    </h4>

    <div id="journal-3501-notes" class="wiki"><p>I revisited the commits bound to this issue, esp. <a class="changeset" title="#1043 and #1042.  Thanks to Thomas for showing that r3627 reintroduced #812.  Thanks to Thoralf f..." href="/projects/exiv2/repository/exiv2/revisions/3630">r3630</a>. I do no think that msync is necessary for MemIo. According to <a class="external" href="http://man7.org/linux/man-pages/man2/msync.2.html">http://man7.org/linux/man-pages/man2/msync.2.html</a> msync is only useful for memory mapped files which is not the case in MemIo. I would rather see it in FileIo where there are the memory mapped files. Thus my questions in <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: pyexiv2 fails on cifs shares on an Ubuntu client (Closed)" href="/issues/1043#note-28">#1043-28</a> (28) and <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: pyexiv2 fails on cifs shares on an Ubuntu client (Closed)" href="/issues/1043#note-29">#1043-29</a> (29) are still not answered.</p></div>
    </div>
  </div>
  
  <div id="change-3587" class="journal has-notes">
    <div id="note-78">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-78" class="journal-link">#78</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/360">Thomas Beutlich</a> <a title="07 May 2015 18:15" href="/projects/exiv2/activity?from=2015-05-07">over 6 years</a> ago
      <span id="journal-3587-private_notes" class=""></span>
    </h4>

    <div id="journal-3587-notes" class="wiki"><p>Robin, should I open a new issue for this open questions?</p></div>
    </div>
  </div>
  
  <div id="change-3589" class="journal has-notes">
    <div id="note-79">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-79" class="journal-link">#79</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="07 May 2015 19:49" href="/projects/exiv2/activity?from=2015-05-07">over 6 years</a> ago
      <span id="journal-3589-private_notes" class=""></span>
    </h4>

    <div id="journal-3589-notes" class="wiki"><p>Thomas:</p>


	<p>I think <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: pyexiv2 fails on cifs shares on an Ubuntu client (Closed)" href="/issues/1043">#1043</a> (and his buddy <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Exiv2 nulls file on CIFS share when modifying Exif.Photo.UserComment (Closed)" href="/issues/1042">#1042</a>) are resolved.  I'm happy if you log a new issue about msync().</p>


	<p>As we're very close to v0.25, I'd like to delay any work on this new issue.  If you believe this is an essential fix for v0.25, could you associate the new issue with #1071 which is the 'Umbrella' for v0.25.</p>


	<p>If this new issue is not essential for v0.25, please target it at v0.26.</p></div>
    </div>
  </div>
  
  <div id="change-3824" class="journal has-details">
    <div id="note-80">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-80" class="journal-link">#80</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="21 Jun 2015 16:39" href="/projects/exiv2/activity?from=2015-06-21">over 6 years</a> ago
      <span id="journal-3824-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Resolved</i> to <i>Closed</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-5038" class="journal has-details">
    <div id="note-81">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-81" class="journal-link">#81</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="07 May 2016 13:13" href="/projects/exiv2/activity?from=2016-05-07">over 5 years</a> ago
      <span id="journal-5038-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>0</i> to <i>100</i></li>
    </ul>
    
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1043.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1043.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
