<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #1207: digiKam maintenance tool to synchronize files metadata and database crash in Exiv2 (re-entrancy issue ?) - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="1yjgYe4d0T/vXizWTDfmOcfqdMmEUxmsovl5MD+2VQc1ZUuOnGcdP7o6M9rz4OoK+HggsHWwuBZf2em4fI+yaA==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #1207: digiKam maintenance tool to synchronize files metadata and database crash in Exiv2 (re-entrancy issue ?)" href="https://dev.exiv2.org/issues/1207.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #1207</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>digiKam maintenance tool to synchronize files metadata and database crash in Exiv2 (re-entrancy issue ?)</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/4731">Uwe Haider</a> <a title="13 Aug 2016 12:40" href="/projects/exiv2/activity?from=2016-08-13">over 5 years</a> ago.
        Updated <a title="21 Aug 2016 10:15" href="/projects/exiv2/activity?from=2016-08-21">over 5 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">testing</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="28 Apr 2017" href="/versions/52">0.26</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">13 Aug 2016</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">6.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>Gilles sayed me to post the problem here....<br />runnig maintenance in digikam and writing to sidecar/exif I get al lot of this:</p>


	<p>-------<br /><code>digikam.general: Use Exif/IPTC preview extraction. Size of image:  1280 x 851<br />digikam.metaengine: Orientation => Exif.Image.Orientation =>  1<br />digikam.facesengine: detectMultiScale gave  ()<br />digikam.general: Found 0 faces in "20141017T143010.png" QSize(3264, 4928) QSize(3264, 4928)<br />digikam.general: Use Exif/IPTC preview extraction. Size of image:  1280 x 851<br />digikam.general: Check for finish:  51 packages, 0 infos to filter, hasFinished() false<br />digikam.metaengine: Orientation => Exif.Image.Orientation =>  1<br />digikam.general: Use Exif/IPTC preview extraction. Size of image:  1280 x 851<br />digikam.metaengine: Orientation => Exif.Image.Orientation =>  1<br />digikam.general: Use Exif/IPTC preview extraction. Size of image:  1280 x 851<br />digikam.metaengine: Orientation => Exif.Image.Orientation =>  1<br />digikam.general: Use Exif/IPTC preview extraction. Size of image:  1280 x 851<br />digikam.metaengine: Orientation => Exif.Image.Orientation =>  1<br />digikam.metaengine: Orientation => Exif.Image.Orientation =>  6<br />digikam.general: Use Exif/IPTC preview extraction. Size of image:  1280 x 851<br />digikam.metaengine: Orientation => Exif.Image.Orientation =>  1<br />digikam.general: Use Exif/IPTC preview extraction. Size of image:  1280 x 851<br />digikam.metaengine: Orientation => Exif.Image.Orientation =>  1<br />digikam.dimg: "/home/uhai/Dokumente/CFotobuch/Carla 18/Kopie von SabineHaider2006-06-22_10-16-46D50.JPG"  : JPEG file identified<br />digikam.metaengine: Orientation => Exif.Image.Orientation =>  1<br />digikam.dimg: "/home/uhai/Bilder_alt/2014/2014-10-17/20141017T143011_v1.png"  : PNG file identified<br />digikam.dimg: "/home/uhai/Dokumente/CFotobuch/Carla 18/Kopie von SabineHaider2006-06-22_10-16-46D50.JPG"  : JPEG file identified<br />[Switching to Thread 0x7ffee7ff7700 (LWP 6946)]<br />Catchpoint 1 (exception thrown), __cxxabiv1::__cxa_throw (obj=0x7ffeec27dd40, tinfo=0x7ffff71a8340 &lt;typeinfo for Exiv2::BasicError&lt;char&gt;>, dest=0x7ffff6818ce0 &lt;Exiv2::BasicError&lt;char&gt;::~BasicError()>)<br />    at /var/tmp/portage/sys-devel/gcc-4.9.3/work/gcc-4.9.3/libstdc++-v3/libsupc++/eh_throw.cc:63<br />63      in /var/tmp/portage/sys-devel/gcc-4.9.3/work/gcc-4.9.3/libstdc++-v3/libsupc++/eh_throw.cc</code><br />-----</p>


	<p>After many of this breaks digikam crashes finally....</p>


	<p>This are the components of my digikam-5.1.0:</p>


	<p>digikam version 5.1.0 CPU cores: 4 Eigen: 3.2.8 Exiv2: 0.25 Exiv2 can write to Jp2: Ja (yes) Exiv2 can write to Jpeg: Ja (yes) Exiv2 can write to Pgf: Ja (yes) Exiv2 can write to Png: Ja (yes) Exiv2 can write to Tiff: Ja (yes) Exiv2 supports XMP metadata: Ja (yes) KDE: 5.25.0 LensFun: 0.3.2-0 LibCImg: 130 LibJPEG: 62 LibJasper: 1.900.1 LibLCMS: 2060 LibLqr support: Ja (yes) LibPGF: 7.15.32 LibPNG: 1.6.21+apng LibRaw: 0.18.0-201604 LibTIFF: LIBTIFF, Version 4.0.6 Copyright (c) 1988-1996 Sam Leffler Copyright (c) 1991-1996 Silicon Graphics, Inc. Marble: 0.24.1 (stable release) Parallelized demosaicing: Ja (yes) Qt: 5.6.1 RawSpeed codec support: Keine (no) DBus support: Ja (yes) Datenbanktreiber: QMYSQL Interner Datenbank-Server:: Keine (no) KIPI-Module: 5.1.0 LibGphoto2: 2.5.10 LibKipi: 5.1.0 LibOpenCV: 3.1.0 Unterstützung für Baloo: Ja (yes) Unterstützung für Calender: Nein (no) Unterstützung für Panorama: Ja (yes) Unterstützung für QtMultimedia: Ja (yes) Unterstützung von Akonadi-Kontakten: Nein (no)</p>


	<p>I am running Gentoo on an amd64 QuadCore:<br />Portage 2.2.8-<a class="changeset" title="New repository initialized by cvs2svn." href="/projects/exiv2/repository/exiv2/revisions/1">r1</a> (default/linux/amd64/13.0/desktop, gcc-4.7.3, glibc-2.19-<a class="changeset" title="New repository initialized by cvs2svn." href="/projects/exiv2/repository/exiv2/revisions/1">r1</a>, 3.14.14-gentooy x86_64) ================================================================= System uname: Linux-3.14.14-gentooy-x86_64-AMD_Phenom-tm-_II_X4_945_Processor-with-gentoo-2.2 KiB Mem: 16435256 total, 2520984 free KiB Swap: 17414456 total, 16775396 free Timestamp of tree: Wed, 03 Sep 2014 18:45:01 +0000 ld GNU ld (GNU Binutils) 2.23.2 ccache version 3.1.9 [enabled] app-shells/bash: 4.2_p45 dev-java/java-config: 2.2.0 dev-lang/python: 2.7.7, 3.3.5-<a class="changeset" title="New repository initialized by cvs2svn." href="/projects/exiv2/repository/exiv2/revisions/1">r1</a> dev-util/ccache: 3.1.9-<a class="changeset" title="This commit was manufactured by cvs2svn to create branch &#39;ahuggel&#39;." href="/projects/exiv2/repository/exiv2/revisions/3">r3</a> dev-util/cmake: 2.8.12.2-<a class="changeset" title="New repository initialized by cvs2svn." href="/projects/exiv2/repository/exiv2/revisions/1">r1</a> dev-util/pkgconfig: 0.28-<a class="changeset" title="New repository initialized by cvs2svn." href="/projects/exiv2/repository/exiv2/revisions/1">r1</a> sys-apps/baselayout: 2.2 sys-apps/openrc: 0.12.4 sys-apps/sandbox: 2.6-<a class="changeset" title="New repository initialized by cvs2svn." href="/projects/exiv2/repository/exiv2/revisions/1">r1</a> sys-devel/autoconf: 2.13, 2.69 sys-devel/automake: 1.11.6, 1.12.6, 1.14.1 sys-devel/binutils: 2.23.2 sys-devel/gcc: 4.6.4, 4.7.3-<a class="changeset" title="New repository initialized by cvs2svn." href="/projects/exiv2/repository/exiv2/revisions/1">r1</a> sys-devel/gcc-config: 1.7.3 sys-devel/libtool: 2.4.2-<a class="changeset" title="New repository initialized by cvs2svn." href="/projects/exiv2/repository/exiv2/revisions/1">r1</a> sys-devel/make: 3.82-<a class="changeset" title="Exif library, batch and Qt frontend" href="/projects/exiv2/repository/exiv2/revisions/4">r4</a> sys-kernel/linux-headers: 3.16 (virtual/os-headers) sys-libs/glibc: 2.19-<a class="changeset" title="New repository initialized by cvs2svn." href="/projects/exiv2/repository/exiv2/revisions/1">r1</a> Repositories: gentoo kde x-overlay Installed sets: @kde-4.12 ACCEPT_KEYWORDS="amd64" ACCEPT_LICENSE="* -@EULA" CBUILD="x86_64-pc-linux-gnu" CFLAGS="-march=native -O2 -pipe -ggdb" CHOST="x86_64-pc-linux-gnu" CONFIG_PROTECT="/etc /usr/lib64/fax /usr/share/config /usr/share/gnupg/qualified.txt /var/lib/hsqldb /var/spool/fax/etc" CONFIG_PROTECT_MASK="/etc/ca-certificates.conf /etc/dconf /etc/env.d /etc/fonts/fonts.conf /etc/gconf /etc/gentoo-release /etc/php/apache2-php5.5/ext-active/ /etc/php/cgi-php5.5/ext-active/ /etc/php/cli-php5.5/ext-active/ /etc/revdep-rebuild /etc/sandbox.d /etc/terminfo /etc/texmf/language.dat.d /etc/texmf/language.def.d /etc/texmf/updmap.d /etc/texmf/web2c" CXXFLAGS="-march=native -O2 -pipe -ggdb" DISTDIR="/usr/portage/distfiles" FCFLAGS="-O2 -pipe" FEATURES="assume-digests binpkg-logs ccache config-protect-if-modified distlocks ebuild-locks fixlafiles merge-sync news parallel-fetch preserve-libs protect-owned sandbox sfperms splitdebug strict unknown-features-warn unmerge-logs unmerge-orphans userpriv usersandbox usersync" FFLAGS="-O2 -pipe" GENTOO_MIRRORS="http://distfiles.gentoo.org/" LANG="de_DE.UTF-8" LDFLAGS="-Wl,-O1 -Wl,--as-needed" MAKEOPTS="-j5" PKGDIR="/usr/portage/packages" PORTAGE_CONFIGROOT="/" PORTAGE_RSYNC_OPTS="--recursive --links --safe-links --perms --times --omit-dir-times --compress --force --whole-file --delete --stats --human-readable --timeout=180 --exclude=/distfiles --exclude=/local --exclude=/packages" PORTAGE_TMPDIR="/var/tmp" PORTDIR="/usr/portage" PORTDIR_OVERLAY="/var/lib/layman/kde /usr/local/portage/overlay" SYNC="rsync://rsync.europe.gentoo.org/gentoo-portage" USE="3dnow X a52 aac acl acpi akonadi alsa amd64 apache2 avi berkdb bluetooth branding bzip2 cairo cdda cddb cdr cleartype cli corefonts cracklib crypt cups cxx dbus dga divx dts dv dvd dvdr dvdread emboss encode exif fam fame ffmpeg firefox flac fortran gdbm gif gphoto2 gpm gps gtk gudev iconv introspection ipv6 java java6 javascript jpeg jpeg2k lcms ldap libnotify lm_sensors mad midi mjpeg mmx mng modules mp3 mp4 mpeg msn multilib ncurses networkmanager nls nptl nvidia ogg opengl openmp pam pango pcre pda pdf phonon png policykit ppds python qt3support qt4 quicktime raw readline scanner sdl semantic-desktop session smp spell sql sse sse2 ssl startup-notification subtitles svg syslog systemd tcpd threads tiff timidity truetype type1 udev udisks unicode upower usb v4l v4l2 vcd vorbis wavpack win32codecs wmf wxwidgets x264 xcb xine xml xpm xv xvid zlib" ABI_X86="64" ALSA_CARDS="ali5451 als4000 atiixp atiixp-modem bt87x ca0106 cmipci emu10k1x ens1370 ens1371 es1938 es1968 fm801 hda-intel intel8x0 intel8x0m maestro3 trident usb-audio via82xx via82xx-modem ymfpci" APACHE2_MODULES="authn_core authz_core socache_shmcb unixd actions alias auth_basic authn_alias authn_anon authn_dbm authn_default authn_file authz_dbm authz_default authz_groupfile authz_host authz_owner authz_user autoindex cache cgi cgid dav dav_fs dav_lock deflate dir disk_cache env expires ext_filter file_cache filter headers include info log_config logio mem_cache mime mime_magic negotiation rewrite setenvif speling status unique_id userdir usertrack vhost_alias" CALLIGRA_FEATURES="kexi words flow plan sheets stage tables krita karbon braindump author" CAMERAS="ptp2" COLLECTD_PLUGINS="df interface irq load memory rrdtool swap syslog" ELIBC="glibc" GPSD_PROTOCOLS="ashtech aivdm earthmate evermore fv18 garmin garmintxt gpsclock itrax mtk3301 nmea ntrip navcom oceanserver oldstyle oncore rtcm104v2 rtcm104v3 sirf superstar2 timing tsip tripmate tnt ublox ubx" INPUT_DEVICES="evdev wacom" KERNEL="linux" LCD_DEVICES="bayrad cfontz cfontz633 glk hd44780 lb216 lcdm001 mtxorb ncurses text" LIBREOFFICE_EXTENSIONS="presenter-console presenter-minimizer" LINGUAS="de" OFFICE_IMPLEMENTATION="libreoffice" PHP_TARGETS="php5-5" PYTHON_SINGLE_TARGET="python2_7" PYTHON_TARGETS="python2_7 python3_3" RUBY_TARGETS="ruby19 ruby20" USERLAND="GNU" VIDEO_CARDS="nvidia" XTABLES_ADDONS="quota2 psd pknock lscan length2 ipv4options ipset ipp2p iface geoip fuzzy condition tee tarpit sysrq steal rawnat logmark ipmark dhcpmac delude chaos account" Unset: CPPFLAGS, CTARGET, EMERGE_DEFAULT_OPTS, INSTALL_MASK, LC_ALL, PORTAGE_BUNZIP2_COMMAND, PORTAGE_COMPRESS, PORTAGE_COMPRESS_FLAGS, PORTAGE_RSYNC_EXTRA_OPTS, USE_PYTHON</p>


	<p>The digikam bug can be found here <a class="external" href="https://bugs.kde.org/show_bug.cgi?id=329091">https://bugs.kde.org/show_bug.cgi?id=329091</a></p>


	<p>My exiv2 si build with this USE-Flags:<br />media-gfx/exiv2 Verfügbare Versionen: 0.24-r1(0/13) ~0.25-r1(0/14) 0.25-r2(0/14)[1] {contrib doc examples nls png static-libs webready xmp zlib ABI_MIPS="n32 n64 o32" ABI_PPC="32 64" ABI_S390="32 64" ABI_X86="32 64 x32" LINGUAS="bs de es fi fr gl ms pl pt ru sk sv ug uk vi"} Installierte Versionen: 0.25-r2(0/14)(16:57:49 14.02.2016)(nls png xmp -doc -examples -webready ABI_MIPS="-n32 -n64 -o32" ABI_PPC="-32 -64" ABI_S390="-32 -64" ABI_X86="32 64 -x32" LINGUAS="de -bs -es -fi -fr -gl -ms -pl -pt -ru -sk -sv -ug -uk -vi") Startseite: <a class="external" href="http://www.exiv2.org/">http://www.exiv2.org/</a> Beschreibung: EXIF, IPTC and XMP metadata C++ library and command line utility</p>


	<p>Missing infos? Please aks me for it, I don't know what you will need....</p>


	<p>Thanks for your help</p>


	<p>uhai</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1034">2011-07-28T12-14-33SW.png</a>    <span class="size">(2.64 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1034/2011-07-28T12-14-33SW.png">2011-07-28T12-14-33SW.png</a>  </td>
  <td>crash-file</td>
  <td>
      <span class="author">Uwe Haider, 14 Aug 2016 08:29</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1039">error6.zip</a>    <span class="size">(18.1 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1039/error6.zip">error6.zip</a>  </td>
  <td>error 6 files</td>
  <td>
      <span class="author">Uwe Haider, 20 Aug 2016 05:12</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>







<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/1207" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="TX5uUUJ4CYNGMv7wEQpW2CxNF6XQ93dQtk/mvoiWhMmvM8W+MALFgxNW4fyu3VrrE99D3CEU1upLb3Y2y69jpg==" />
  <table class="list issues odd-even"><tr id="relation-237" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1187" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/1187">Bug #1187</a>: Crash while reading in parallel threads</td><td class="status">Closed</td><td class="start_date">29 May 2016</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-245" class="issue hascontextmenu issue tracker-1 status-2 priority-4 priority-default"><td class="checkbox"><input type="checkbox" name="ids[]" value="1227" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-2 priority-4 priority-default" href="/issues/1227">Bug #1227</a>:  File extension Issue</td><td class="status">Assigned</td><td class="start_date">18 Sep 2016</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-0"><tr><td style="width: 100%;" class="todo"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-246" class="issue hascontextmenu issue tracker-1 status-2 priority-4 priority-default"><td class="checkbox"><input type="checkbox" name="ids[]" value="1228" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-2 priority-4 priority-default" href="/issues/1228">Bug #1228</a>: Crash in Windows when reading metadata in parallel</td><td class="status">Assigned</td><td class="start_date">22 Sep 2016</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-0"><tr><td style="width: 100%;" class="todo"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/1207/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=1207&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 4422" href="/projects/exiv2/repository/exiv2/revisions/4422">Revision 4422</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4422/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="21 Aug 2016 08:16" href="/projects/exiv2/activity?from=2016-08-21">over 5 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: digiKam maintenance tool to synchronize files metadata and database crash in Exiv2 (re-entrancy i... (Closed)" href="/issues/1207">#1207</a> Added samples/mt-test.cpp</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4423" href="/projects/exiv2/repository/exiv2/revisions/4423">Revision 4423</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4423/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="21 Aug 2016 09:50" href="/projects/exiv2/activity?from=2016-08-21">over 5 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: digiKam maintenance tool to synchronize files metadata and database crash in Exiv2 (re-entrancy i... (Closed)" href="/issues/1207">#1207</a> Dynamically new/delete thread array in mt-test.cpp</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4424" href="/projects/exiv2/repository/exiv2/revisions/4424">Revision 4424</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4424/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="21 Aug 2016 22:54" href="/projects/exiv2/activity?from=2016-08-21">about 5 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: digiKam maintenance tool to synchronize files metadata and database crash in Exiv2 (re-entrancy i... (Closed)" href="/issues/1207">#1207</a>  Don't build mt-test by default.  It requires C++11.  G++ 5.3 will not compile #include &lt;exiv2/exiv2.hpp&gt; because AutoPtr is deprecated.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4425" href="/projects/exiv2/repository/exiv2/revisions/4425">Revision 4425</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4425/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="22 Aug 2016 13:44" href="/projects/exiv2/activity?from=2016-08-22">about 5 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: digiKam maintenance tool to synchronize files metadata and database crash in Exiv2 (re-entrancy i... (Closed)" href="/issues/1207">#1207</a> Updating comments in samples/mt-test.cpp to document build restrictions.</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-5320" class="journal has-notes">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="13 Aug 2016 12:57" href="/projects/exiv2/activity?from=2016-08-13">over 5 years</a> ago
      <span id="journal-5320-private_notes" class=""></span>
    </h4>

    <div id="journal-5320-notes" class="wiki"><p>More info from my side :</p>


	<p>The digiKam maintenance tool has an option to use all CPU core at the same time, to process file metadata synchronization. Typically, each thread run same code to operate with Exiv2. Each code is re-entrant of course. <br />Each thread operate one file, as to read image metadata and update the database (and vis versa).<br />We have lock in Database interface to prevent no re-entrancy cases, depending of database backend used.<br />Other code not using Exiv2 already operate with database in separated threads without problem.</p>


	<p>We use Qt to manage a queue of threads to fork on separate CPU core. One thread is taken from the queue and executed on one available core. Onether one is taken if more than one core is available, etc. When a thread is completed, another one is taken from the queue, until the queue is empty. The goal of course is to parallelize operation to reduce execution time, especially with large collection of images.</p>


	<p>We have small classes to do it. A test code based on these classes can be written quickly, if you is interested.</p>


	<p>I hope to be enough clear with the internal digiKam code.</p>


	<p>So the questions are :</p>


	<p>Exiv2 code is really fully re-entrant everywhere ? <br />Did you have already tried this kind of use-case into test code ?</p>


	<p>PS : The report from digiKam bugzilla listed in this entry is not alone. A lots of reports have been already send, with similar traces. Remember that whole digiKam use multicore/multithreading everywhere when it's possible.</p>


	<p>Gilles Caulier</p></div>
    </div>
  </div>
  
  <div id="change-5321" class="journal has-details">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="13 Aug 2016 13:05" href="/projects/exiv2/activity?from=2016-08-13">over 5 years</a> ago
      <span id="journal-5321-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Subject</strong> changed from <i>digikam maintenance crashed in exiv2</i> to <i>digiKam maintenance tool to synchronize files metadata and database crash in Exiv2 (re-entrancy issue ?)</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-5322" class="journal has-notes has-details">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="13 Aug 2016 14:37" href="/projects/exiv2/activity?from=2016-08-13">over 5 years</a> ago
      <span id="journal-5322-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> set to <i>design</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Target version</strong> set to <i>0.26</i></li>
    </ul>
    <div id="journal-5322-notes" class="wiki"><p>Gentlemen</p>


	<p>Thanks for reporting this.  This is going to be painful to isolate and fix.  Here's our thread safety status:<br /><a class="external" href="http://dev.exiv2.org/projects/exiv2/wiki/Thread_safety">http://dev.exiv2.org/projects/exiv2/wiki/Thread_safety</a></p>


	<p>As you know, multithreading is a painful matter.  What's easy to crash on the user's computer is often impossible to reproduce on the developer's machine.  Can you confirm at the file that is crashing in ImageFactory is good.  You can open and read the metadata from the terminal/command-prompt?</p>


	<p>We recently had a report of a multithreading issue and it was fixed with the use of a lock.  I dislike locks for reasons discussed in <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187">#1187</a>.  The code involved was XmpProperties::lookupNsRegistry.  One consequence of <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187">#1187</a> was to think "I really ought to write a multi-threaded sample and put it in the test suite.".</p>


	<p>At the moment, I'm trying to get v0.26 finished and don't want to delay that by working on multi-threading.  I see you are using exiv2 v0.23.  There was a bug fixed in v0.25 which could be involved here.  <a class="external" href="http://dev.exiv2.org/issues/1065">http://dev.exiv2.org/issues/1065</a></p>


	<p>Is it possible for you:<br />1) To confirm that your test file is good and works OK from the terminal/command-line<br />2) To update to at least Exiv2 v0.25</p>


	<p>And, for Gilles' information, Ben and I are making good progress with WebP and will probably have that finished next week.</p></div>
    </div>
  </div>
  
  <div id="change-5326" class="journal has-notes">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4731">Uwe Haider</a> <a title="13 Aug 2016 20:44" href="/projects/exiv2/activity?from=2016-08-13">over 5 years</a> ago
      <span id="journal-5326-private_notes" class=""></span>
    </h4>

    <div id="journal-5326-notes" class="wiki"><p>Robin Mills wrote:<br />[...]</p>


<blockquote>

	<p>Is it possible for you:<br />1) To confirm that your test file is good and works OK from the terminal/command-line</p>


</blockquote>

	<p>It is possible, but I need some time....</p>


<blockquote>

	<p>2) To update to at least Exiv2 v0.25</p>


</blockquote>

	<p>Installierte Versionen: 0.25-r2(0/14)(16:57:49 14.02.2016) -> this is ther running exiv2 here - sorry my posting isn't well easy to read. I will try to make it better.</p>


	<p>uhai</p></div>
    </div>
  </div>
  
  <div id="change-5327" class="journal has-notes">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="13 Aug 2016 21:09" href="/projects/exiv2/activity?from=2016-08-13">over 5 years</a> ago
      <span id="journal-5327-private_notes" class=""></span>
    </h4>

    <div id="journal-5327-notes" class="wiki"><p>Uwe</p>


	<p>Thanks for getting back to me.  If you can attach the test files to this issue, I'll test them on my machines.  If you want to keep the test files confidential please share them on Dropbox so I can collect them.  I'll let you know when I get them from Dropbox and you are remove them.</p>


	<p>Robin</p></div>
    </div>
  </div>
  
  <div id="change-5331" class="journal has-notes has-details">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4731">Uwe Haider</a> <a title="14 Aug 2016 08:29" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5331-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/1034">2011-07-28T12-14-33SW.png</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/1034/2011-07-28T12-14-33SW.png">2011-07-28T12-14-33SW.png</a> added</li>
    </ul>
    <div id="journal-5331-notes" class="wiki"><p>ok, gdb has found a breakpoint:</p>


	<p><code>digikam.database: Info :  "\n\nChannel: 0\nWeighted Mean: 0.5\nWeighted Standard Deviation: 9.92863e-10\n\nChannel: 1\nWeighted Mean: 0.500001\nWeighted Standard Deviation: 9.92865e-10\n\nChannel: 2\nWeighted Mean: 88.5873\nWeighted Standard Deviation: 2.13222" <br />digikam.database: All is completed<br />digikam.database: Amount of Noise present in image is :  0.35537<br />digikam.database: Amount of compression artifacts present in image is :  0<br />digikam.database: Exposure level present in image is :  2<br />digikam.general: One job is done<br />Catchpoint 1 (exception thrown), __cxxabiv1::__cxa_throw (obj=0x7fff2c8aa9d0, tinfo=0x7ffff71a8340 &lt;typeinfo for Exiv2::BasicError&lt;char&gt;>, dest=0x7ffff6818ce0 &lt;Exiv2::BasicError&lt;char&gt;::~BasicError()>)<br />    at /var/tmp/portage/sys-devel/gcc-4.9.3/work/gcc-4.9.3/libstdc++-v3/libsupc++/eh_throw.cc:63<br />63      in /var/tmp/portage/sys-devel/gcc-4.9.3/work/gcc-4.9.3/libstdc++-v3/libsupc++/eh_throw.cc<br />(gdb) c<br />Continuing.<br />digikam.metaengine: Cannot load metadata from file   (Error # 14 :  Failed to read image data<br />digikam.dimg: "/home/uhai/Bilder_alt/2011/2011-07-28/2011-07-28T14-02-52.png"  : PNG file identified<br />Catchpoint 1 (exception thrown), __cxxabiv1::__cxa_throw (obj=0x7fff2d356640, tinfo=0x7ffff71a8340 &lt;typeinfo for Exiv2::BasicError&lt;char&gt;>, dest=0x7ffff6818ce0 &lt;Exiv2::BasicError&lt;char&gt;::~BasicError()>)<br />    at /var/tmp/portage/sys-devel/gcc-4.9.3/work/gcc-4.9.3/libstdc++-v3/libsupc++/eh_throw.cc:63<br />63      in /var/tmp/portage/sys-devel/gcc-4.9.3/work/gcc-4.9.3/libstdc++-v3/libsupc++/eh_throw.cc</code></p>


	<p>And this shows exiv2:</p>


	<p><code>█▓▒░uhai@Master_Tux█▓▒░ So Aug 14 10:15:45 <br />~/ exiv2 pr /home/uhai/Bilder_alt/2011/2011-07-28/2011-07-28T14-02-52.png  <br />Exiv2 exception in print action for file /home/uhai/Bilder_alt/2011/2011-07-28/2011-07-28T14-02-52.png:<br />Failed to read image data<br /></code></p>


	<p>Picture attached - thanks for your time :-)</p>


	<p>uhai</p></div>
    </div>
  </div>
  
  <div id="change-5332" class="journal has-notes">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="14 Aug 2016 08:38" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5332-private_notes" class=""></span>
    </h4>

    <div id="journal-5332-notes" class="wiki"><p>If this PNG image crash Exiv2, why the library do not generate a C++ exception.</p>


	<p>In digiKam, Exiv2 API are all wrapped in C++ exception catcher. All Exiv2 API are only wrapped in dedicated classes to complete exception handling. Exiv2 API are not used in whole digiKam but only located in low level classes metaengine_* :</p>


	<p><a class="external" href="https://quickgit.kde.org/?p=digikam.git&#38;a=tree&#38;f=libs%2Fdmetadata">https://quickgit.kde.org/?p=digikam.git&#38;a=tree&#38;f=libs%2Fdmetadata</a></p>


	<p>Gilles Caulier</p></div>
    </div>
  </div>
  
  <div id="change-5333" class="journal has-notes">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Aug 2016 09:15" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5333-private_notes" class=""></span>
    </h4>

    <div id="journal-5333-notes" class="wiki"><p>Good news:</p>


	<p>1) Your file is good.<br />2) I've written a very simple mt-test.cpp and it's working (code below)</p>


	<p><strong>1 Your file</strong><pre>1065 rmills@rmillsmbp:~/gnu/exiv2/trunk/samples $ exiv2 -pa --grep Exif http://dev.exiv2.org/attachments/download/1034/2011-07-28T12-14-33SW.png 
Exif.Image.ProcessingSoftware                Ascii      14  digiKam-5.0.0
Exif.Image.Software                          Ascii      14  digiKam-2.9.0
Exif.Image.DateTime                          Ascii      20  2011:08:01 07:11:14
Exif.Image.ExifTag                           Long        1  110
Exif.Photo.DateTimeOriginal                  Ascii      20  2011:08:01 07:11:14
Exif.Photo.DateTimeDigitized                 Ascii      20  2011:08:01 07:11:14
1066 rmills@rmillsmbp:~/gnu/exiv2/trunk/samples $ exiv2 -pa --grep Exif http://dev.exiv2.org/attachments/download/1034/2011-07-28T12-14-33SW.png | wc
       6      27     452
1067 rmills@rmillsmbp:~/gnu/exiv2/trunk/samples $ </pre><strong>2 Build my code and run it</strong><pre>1067 rmills@rmillsmbp:~/gnu/exiv2/trunk/samples $ make -B mt-test "CXXFLAGS=-std=c++11 -stdlib=libc++" 
g++ -std=c++11 -stdlib=libc++ `pkg-config exiv2 --cflags` -c -I../include -I../include/exiv2 -o mt-test.o mt-test.cpp
mkdir -pv ../bin 2&gt;&#38;1 &gt; /dev/null
../libtool --mode=link g++ `pkg-config exiv2 --libs` -rpath /usr/local/lib -L/usr/local/lib -o ../bin/mt-test mt-test.o
libtool: link: g++ -o ../bin/mt-test mt-test.o -Wl,-bind_at_load  -L/usr/local/lib /usr/local/lib/libexiv2.dylib -L/Users/rmills/gnu/exiv2/trunk/xmpsdk/src /usr/local/lib/libintl.dylib -lc -liconv -lz -lpthread
1068 rmills@rmillsmbp:~/gnu/exiv2/trunk/samples $ ../bin/mt-test http://dev.exiv2.org/attachments/download/1034/2011-07-28T12-14-33SW.png ~/Stonehenge.jpg ~/Stonehenge2.webp
file: /Users/rmills/Stonehenge2.webp n: 3 count: 209 
file: /Users/rmills/Stonehenge.jpg n: 2 count: 209 
file: http://dev.exiv2.org/attachments/download/1034/2011-07-28T12-14-33SW.png n: 1 count: 6 
1069 rmills@rmillsmbp:~/gnu/exiv2/trunk/samples $ </pre><strong>3 My Code</strong><pre>// ***************************************************************** -*- C++ -*-
// mt-test.cpp, $Rev: 3090 $
// Sample program to test multi-threading

#include &lt;exiv2/exiv2.hpp&gt;
#include &lt;iostream&gt;
#include &lt;iomanip&gt;
#include &lt;cassert&gt;
#include &lt;string&gt;
#include &lt;thread&gt;
#include &lt;mutex&gt;

std::mutex m;

void reportExifMetadataCount(int n,const char* argv[])
{
    int count = 0 ;
    std::string what;
    try {
        Exiv2::Image::AutoPtr image = Exiv2::ImageFactory::open(argv[n]);
        assert(image.get() != 0);
        image-&gt;readMetadata();

        Exiv2::ExifData &#38;exifData = image-&gt;exifData();
        if (!exifData.empty()) {
            Exiv2::ExifData::const_iterator end = exifData.end();
            for (Exiv2::ExifData::const_iterator i = exifData.begin(); i != end; ++i)
                count++;
        }
    } catch (Exiv2::Error&#38; e) {
        what = e.what() ;
        count = -1;
    }

    m.lock();
    std::cout &lt;&lt; "file: "  &lt;&lt; argv[n] &lt;&lt; " " 
              &lt;&lt; "n: "     &lt;&lt; n       &lt;&lt; " " 
              &lt;&lt; "count: " &lt;&lt; count   &lt;&lt; " " 
              &lt;&lt; (count &lt; 0 ? "exception: " : what)
              &lt;&lt; what                 &lt;&lt; std::endl;
    m.unlock();
}

int main(int argc,const char* argv[])
{
    int result = 0;
    if ( argc != 4 ) {
        std::cerr &lt;&lt; "syntax: " &lt;&lt; argv[0] &lt;&lt; " path1 path2 path3" &lt;&lt; std::endl;
        result = 1 ;
    } else {
        std::thread t1(reportExifMetadataCount,1,argv);
        std::thread t2(reportExifMetadataCount,2,argv);
        std::thread t3(reportExifMetadataCount,3,argv);
        if (t1.joinable())    t1.join();
        if (t2.joinable())    t2.join();
        if (t3.joinable())    t3.join();
    }
    return result;
}</pre></p>


	<p><strong>4 Next steps</strong></p>


	<p>I haven't submitted this code to the repository.</p>


	<p>Gilles: you said you might have some simple code to simulate your use case.  I'd prefer not to get sucked into dealing with Qt if it can be avoided.  All help appreciated.</p></div>
    </div>
  </div>
  
  <div id="change-5334" class="journal has-notes">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Aug 2016 09:46" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5334-private_notes" class=""></span>
    </h4>

    <div id="journal-5334-notes" class="wiki"><p>Even better news.  I think I've found the fix:</p>


	<p>1) Upgrade to the trunk version of exiv2 which includes the fix for <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187">#1187</a><br />2) Explicitly call  Exiv2::XmpParser::initialize() before spinning up the threads.</p>


	<p>Here's my analysis.  It's crashing consistently with a 'vanilla' v0.25. Down in the dungeons of XMPsdk:<pre>0   libsystem_kernel.dylib            0x00007fff9bf1dde6 __psynch_mutexwait + 10
1   libsystem_pthread.dylib           0x00007fff9d54ee4a _pthread_mutex_lock_wait + 89
2   libexiv2.14.dylib                 0x000000010bfaf859 XMP_EnterCriticalRegion(_opaque_pthread_mutex_t&#38;) + 9
3   libexiv2.14.dylib                 0x000000010bfa64a2 WXMPIterator_Next_1 + 66
4   libexiv2.14.dylib                 0x000000010bf9b759 TXMPIterator&lt;std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; &gt;::Next(std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;*, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;*, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;*, unsigned long*) + 137
5   libexiv2.14.dylib                 0x000000010bf96ec1 Exiv2::XmpParser::decode(Exiv2::XmpData&#38;, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&#38;) + 545
6   libexiv2.14.dylib                 0x000000010bf17906 Exiv2::JpegBase::readMetadata() + 2006
7   mt-test                           0x000000010beb6bd0 reportExifMetadataCount(int, char const**) + 1776</pre>I'm fairly sure this is the issue that was solved by <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187">#1187</a>.</p>


	<p>I'm a little blind here.  It almost feels as though you are getting an exception.  Then your code crashes when it reports the exception.<pre>digikam.metaengine: Cannot load metadata from file (Error # 14 : Failed to read image data
digikam.dimg: "/home/uhai/Bilder_alt/2011/2011-07-28/2011-07-28T14-02-52.png" : PNG file identified
Catchpoint 1 (exception thrown), __cxxabiv1::__cxa_throw (obj=0x7fff2d356640, tinfo=0x7ffff71a8340 &lt;typeinfo for Exiv2::BasicError&lt;char&gt;&gt;, dest=0x7ffff6818ce0 &lt;Exiv2::BasicError&lt;char&gt;::~BasicError()&gt;)</pre>Gilles: I believe you'll be integrating the trunk later this week to work with the WebP code.  Perhaps the fix in <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187">#1187</a> is the culprit.</p>


	<p>I've rebuilt the trunk with C++11 and getting curious results:<pre>1095 rmills@rmillsmbp:~/gnu/exiv2/trunk/samples $ ../bin/mt-test ~/Stonehenge.jpg ~/Stonehenge.jpg ~/Stonehenge.jpg 
Error: XMP Toolkit error 102: Unknown namespace prefix for qualified name
Warning: Failed to decode XMP metadata.
file: /Users/rmills/Stonehenge.jpg n: 1 count: 209 
Error: XMP Toolkit error 102: Unknown nameEsrpraocre:  prXeMfPi xT ofoolrk iqtu aelrirfoire d1 0n2a:m eU
nknownW anranmiensgp:a ceF apirleefdi xt of odre cqoudael iXfMiPe dm entaamdea
ta.
Warning: Failed to decode XMP metadata.
file: /Users/rmills/Stonehenge.jpg n: 2 count: 209 
file: /Users/rmills/Stonehenge.jpg n: 3 count: 209 
1096 rmills@rmillsmbp:~/gnu/exiv2/trunk/samples $ ../bin/mt-test ~/Stonehenge.jpg ~/Stonehenge.jpg ~/Stonehenge.jpg 
file: /Users/rmills/Stonehenge.jpg n: 3 count: 209 
file: /Users/rmills/Stonehenge.jpg n: 2 count: 209 
file: /Users/rmills/Stonehenge.jpg n: 1 count: 209 
1097 rmills@rmillsmbp:~/gnu/exiv2/trunk/samples $ </pre>There's something unpleasant in XMP Toolkit. I think that can be resolved by explicitly calling Exiv2::XmpParser::initialize() before spinning up the threads.  This is mentioned in <a class="external" href="http://dev.exiv2.org/projects/exiv2/wiki/Thread_safety">http://dev.exiv2.org/projects/exiv2/wiki/Thread_safety</a></p>


	<p>Gentlemen:  I've run out of time for today.  Share your thoughts and I'll spend more time on this during the week.</p></div>
    </div>
  </div>
  
  <div id="change-5335" class="journal has-notes">
    <div id="note-10">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-10" class="journal-link">#10</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4731">Uwe Haider</a> <a title="14 Aug 2016 09:52" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5335-private_notes" class=""></span>
    </h4>

    <div id="journal-5335-notes" class="wiki"><p>Gilles Caulier wrote:</p>


<blockquote>

	<p>If this PNG image crash Exiv2, why the library do not generate a C++ exception.</p>


	<p>In digiKam, Exiv2 API are all wrapped in C++ exception catcher. All Exiv2 API are only wrapped in dedicated classes to complete exception handling. Exiv2 API are not used in whole digiKam but only located in low level classes metaengine_* :</p>


</blockquote>

	<p>Is this a crash? or an exception? I think I can continue in gdb....</p>


	<p><code>(gdb) c<br />Continuing.<br />digikam.metaengine: Cannot load metadata from file (Error # 14 : Failed to read image data<br />digikam.dimg: "/home/uhai/Bilder_alt/2011/2011-07-28/2011-07-28T14-02-52.png" : PNG file identified<br />Catchpoint 1 (exception thrown), __cxxabiv1::__cxa_throw (obj=0x7fff2d356640, tinfo=0x7ffff71a8340 &lt;typeinfo for Exiv2::BasicError&lt;char&gt;>, dest=0x7ffff6818ce0 &lt;Exiv2::BasicError&lt;char&gt;::~BasicError()>)<br />at /var/tmp/portage/sys-devel/gcc-4.9.3/work/gcc-4.9.3/libstdc++-v3/libsupc++/eh_throw.cc:63<br />63 in /var/tmp/portage/sys-devel/gcc-4.9.3/work/gcc-4.9.3/libstdc++-v3/libsupc++/eh_throw.cc<br />(gdb)</code></p>


	<p>uhai</p></div>
    </div>
  </div>
  
  <div id="change-5336" class="journal has-notes">
    <div id="note-11">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-11" class="journal-link">#11</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Aug 2016 10:14" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5336-private_notes" class=""></span>
    </h4>

    <div id="journal-5336-notes" class="wiki"><p>Exception handlers don't catch signals.  This is discussed here:  <a class="external" href="http://dev.exiv2.org/issues/1164">http://dev.exiv2.org/issues/1164</a>  Signal handlers are a process responsibility and should be dealt with by the application and not a library.  In this case digiKam.</p>


	<p>There is an exception involved.  That's how you have the information: <pre>Cannot load metadata from file (Error # 14 : Failed to read image data
digikam.dimg: "/home/uhai/Bilder_alt/2011/2011-07-28/2011-07-28T14-02-52.png" :</pre>However there's more to this an uncaught exception.  I'd really like you to try my 2 step recipe and let me know how that works for you:</p>


	<p>1) Upgrade to the trunk version of exiv2 which includes the fix for <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187">#1187</a><br />2) Explicitly call Exiv2::XmpParser::initialize() before spinning up the threads.</p></div>
    </div>
  </div>
  
  <div id="change-5337" class="journal has-notes">
    <div id="note-12">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-12" class="journal-link">#12</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4731">Uwe Haider</a> <a title="14 Aug 2016 11:25" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5337-private_notes" class=""></span>
    </h4>

    <div id="journal-5337-notes" class="wiki"><p>Robin Mills wrote:</p>


<blockquote>

	<p>Exception handlers don't catch signals.  This is discussed here:  <a class="external" href="http://dev.exiv2.org/issues/1164">http://dev.exiv2.org/issues/1164</a>  Signal handlers are a process responsibility and should be dealt with by the application and not a library.  In this case digiKam.</p>


	<p>There is an exception involved.  That's how you have the information: [...]However there's more to this an uncaught exception.  I'd really like you to try my 2 step recipe and let me know how that works for you:</p>


	<p>1) Upgrade to the trunk version of exiv2 which includes the fix for <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187">#1187</a></p>


</blockquote>

	<p>Sorry, I'm not sure... I'm only a user, no dev. Is this the version I shall use:</p>


	<p><code>Installierte Versionen: 0.25-r2(0/14)(16:57:49 14.02.2016)(nls png xmp -doc -examples -webready ABI_MIPS="-n32 -n64 -o32" ABI_PPC="-32 -64" ABI_S390="-32 -64" ABI_X86="32 64 -x32" LINGUAS="de -bs -es -fi -fr -gl -ms -pl -pt -ru -sk -sv -ug -uk -vi") </code></p>


<blockquote>

	<p>2) Explicitly call Exiv2::XmpParser::initialize() before spinning up the threads.</p>


</blockquote>

	<p>This part I don't understand. Will you be so kind to give me an detailed howto? or an link to an howto for this?</p>


	<p>Sorry, no programming skills, bad english - your job is hard :-)</p>


	<p>uhai</p></div>
    </div>
  </div>
  
  <div id="change-5338" class="journal has-notes">
    <div id="note-13">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-13" class="journal-link">#13</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Aug 2016 11:40" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5338-private_notes" class=""></span>
    </h4>

    <div id="journal-5338-notes" class="wiki"><p>Here's how I called that in the mt-test.cpp code listed above:<pre>int main(int argc,const char* argv[])
{
    int result = 0;
    if ( argc != 4 ) {
        std::cerr &lt;&lt; "syntax: " &lt;&lt; argv[0] &lt;&lt; " path1 path2 path3" &lt;&lt; std::endl;
        result = 1 ;
    } else {
        Exiv2::XmpParser::initialize();
        std::thread t1(reportExifMetadataCount,1,argv);
        std::thread t2(reportExifMetadataCount,2,argv);
        std::thread t3(reportExifMetadataCount,3,argv);
        if (t1.joinable())    t1.join();
        if (t2.joinable())    t2.join();
        if (t3.joinable())    t3.join();
    }
    return result;
}</pre></p></div>
    </div>
  </div>
  
  <div id="change-5339" class="journal has-notes">
    <div id="note-14">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-14" class="journal-link">#14</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="14 Aug 2016 11:59" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5339-private_notes" class=""></span>
    </h4>

    <div id="journal-5339-notes" class="wiki"><blockquote>

	<p>2) Explicitly call Exiv2::XmpParser::initialize() before spinning up the threads.<br />This part I don't understand. Will you be so kind to give me an detailed howto? or an link to an howto for this?<br />Sorry, no programming skills, bad english - your job is hard :-)</p>


</blockquote>

	<p>This is already done in digiKam since a while (more than few years)... into metadata engine wrapper line 75.</p>


	<p><a class="external" href="https://quickgit.kde.org/?p=digikam.git&#38;a=blob&#38;f=libs%2Fdmetadata%2Fmetaengine.cpp">https://quickgit.kde.org/?p=digikam.git&#38;a=blob&#38;f=libs%2Fdmetadata%2Fmetaengine.cpp</a></p>


	<p>So the problem is not here...</p>


	<p>Gilles Caulier</p></div>
    </div>
  </div>
  
  <div id="change-5340" class="journal has-notes">
    <div id="note-15">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-15" class="journal-link">#15</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="14 Aug 2016 12:07" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5340-private_notes" class=""></span>
    </h4>

    <div id="journal-5340-notes" class="wiki"><p>Robin,</p>


	<p>You MT code is too simple. It read by 3 thread the same file.</p>


	<p>It's not enough. The read must be done on different files from different type. On i7 CPU, 8 core want mean 8 threads at the same time.</p>


	<p>Also, i think reading is not the most critical stage. Writing is more and less tedious. Imagine the case where a thread update metadata and another one read metadata at the same time, on the same file of course...</p>


	<p>But as we have seen in backtrace, the crash appear while read metadata. If you test file can support to read metadata from a huge collection, this will be a good step.</p>


	<p>My tips : in you MT test code, pass a path as argument to a collection a file. parse the path recursively an make a list of file path to read with Exiv2. Loop over the list step by step depending of CPU cores available and read file into separated threads until the list is completed. This is how digiKam process in Maintenance tool.</p>


	<p>Gilles Caulier</p></div>
    </div>
  </div>
  
  <div id="change-5341" class="journal has-notes">
    <div id="note-16">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-16" class="journal-link">#16</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="14 Aug 2016 12:09" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5341-private_notes" class=""></span>
    </h4>

    <div id="journal-5341-notes" class="wiki"><p>Uwe,</p>


	<p>An important question : when the crash appear, did you synchronize database with file metadata (read files and update DB), or the inverse (read DB and write in files).</p>


	<p>The behavior is completely different as reading metadata from files do not change files contents. The inverse of course, yes...</p>


	<p>Gilles Caulier</p></div>
    </div>
  </div>
  
  <div id="change-5342" class="journal has-notes">
    <div id="note-17">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-17" class="journal-link">#17</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4731">Uwe Haider</a> <a title="14 Aug 2016 12:11" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5342-private_notes" class=""></span>
    </h4>

    <div id="journal-5342-notes" class="wiki"><p>Please correct me, if it is wrong:</p>


	<p>exiv2-0.25-<a class="changeset" title="Initial revision" href="/projects/exiv2/repository/exiv2/revisions/2">r2</a> is the version I shall try.</p>


	<p>First step - save your code as mt-test<br />Second step - make mt-test -> make complains about "for this aim is nothing to do"</p>


	<p>Is this the correct make command:<br />make -B mt-test "CXXFLAGS=-std=c++11 -stdlib=libc++" <br />g++ -std=c++11 -stdlib=libc++ `pkg-config exiv2 --cflags` -c -I../include -I../include/exiv2 -o mt-test.o mt-test.cpp<br />mkdir -pv ../bin 2>&#38;1 > /dev/null<br />../libtool --mode=link g++ `pkg-config exiv2 --libs` -rpath /usr/local/lib -L/usr/local/lib -o ../bin/mt-test mt-test.o<br />libtool: link: g++ -o ../bin/mt-test mt-test.o -Wl,-bind_at_load  -L/usr/local/lib /usr/local/lib/libexiv2.dylib -L/Users/rmills/gnu/exiv2/trunk/xmpsdk/src /usr/local/lib/libintl.dylib -lc -liconv -lz -lpthread</p>


	<p>So I had to correct the paths - ok so far? What's next?</p>


	<p>uhai</p></div>
    </div>
  </div>
  
  <div id="change-5343" class="journal has-notes">
    <div id="note-18">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-18" class="journal-link">#18</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4731">Uwe Haider</a> <a title="14 Aug 2016 12:17" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5343-private_notes" class=""></span>
    </h4>

    <div id="journal-5343-notes" class="wiki"><p>Gilles Caulier wrote:</p>


<blockquote>

	<p>Uwe,</p>


	<p>An important question : when the crash appear, did you synchronize database with file metadata (read files and update DB), or the inverse (read DB and write in files).</p>


</blockquote>

	<p>No, I have only marked maintenance - quality. Nothing else. I've tested both directions of metadata-synchronizing a couple of days ago.</p>


	<p>I can start an new test, please tell me what maintenance-function I shall run. Multicore or no multicore?</p>


	<p>Uwe</p></div>
    </div>
  </div>
  
  <div id="change-5344" class="journal has-notes">
    <div id="note-19">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-19" class="journal-link">#19</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="14 Aug 2016 12:44" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5344-private_notes" class=""></span>
    </h4>

    <div id="journal-5344-notes" class="wiki"><p>Uwe,</p>


	<p>Maintenance Quality Sort tool will only read metadata from file and Tag image in database accordingly with quality parser result.</p>


	<p>So the current problem is only when read metadata.</p>


	<p>For the Metadata Synchroniser, we will see later, step by step, but both directions and both threaded processing are important to test. If problem disappear in single thread and appear in multi threads, there is really a re-entrance problem somewhere.</p>


	<p>Gilles Caulier</p></div>
    </div>
  </div>
  
  <div id="change-5345" class="journal has-notes">
    <div id="note-20">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-20" class="journal-link">#20</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4731">Uwe Haider</a> <a title="14 Aug 2016 13:04" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5345-private_notes" class=""></span>
    </h4>

    <div id="journal-5345-notes" class="wiki"><p>So I test now Maintenance quality sort without multicore-support? Perhaps only with the folder with the uploaded picture?</p>


	<p>Uwe</p></div>
    </div>
  </div>
  
  <div id="change-5348" class="journal has-notes">
    <div id="note-21">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-21" class="journal-link">#21</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Aug 2016 16:12" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5348-private_notes" class=""></span>
    </h4>

    <div id="journal-5348-notes" class="wiki"><p>Gilles</p>


	<p>In the last week, I have spent about 20 hours working on stuff for you and DigiKam.  Perhaps you'd like to spend 20 seconds to say "Thank You".  My multi-threaded test may not deal with every nuance of your use case.  However I have identified useful short-comings on Exiv2 multi-threading support.  I've asked you to modify your code in a couple of ways and let me know the outcome.  Please help me to help you.  And please have the courtesy to occasionally say "Thank You".</p></div>
    </div>
  </div>
  
  <div id="change-5349" class="journal has-notes">
    <div id="note-22">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-22" class="journal-link">#22</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="14 Aug 2016 16:20" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5349-private_notes" class=""></span>
    </h4>

    <div id="journal-5349-notes" class="wiki"><p>In comment #12 you said :</p>


<blockquote>

	<p>Exception handlers don't catch signals. This is discussed here: <a class="external" href="http://dev.exiv2.org/issues/1164">http://dev.exiv2.org/issues/1164</a> Signal >handlers are a process responsibility and should be dealt with by the application and not a library. In this >case digiKam.</p>


</blockquote>

	<p>I don't understand well the incidence if a signal handler is not implemented in digiKam metadata engine. It's not the case currently.</p>


	<p>Do i need to do it ? This can prevent a crash from Exiv2 ? If yes, why exactly ? Why Exiv2 send a signal to client application ?</p>


	<p>This signal are Posix signals. Right ? If yes, how do you deal under Windows which is not a Posix compliant system ?</p>


	<p>Gilles... (who thank you sir for your support (:=)))</p></div>
    </div>
  </div>
  
  <div id="change-5350" class="journal has-notes">
    <div id="note-23">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-23" class="journal-link">#23</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Aug 2016 16:46" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5350-private_notes" class=""></span>
    </h4>

    <div id="journal-5350-notes" class="wiki"><p>Gilles.  This conversation is not going well.  I don't know what's wrong.  It's possible for the signal to come from your exception handler.  Here's where we are:</p>


	<p>1) I've asked you to try two changes and report back.<br />2) You've asked me to do additional work on my mt-test.cpp code.  I'll look at that on Monday.<br />3) I can't build and debug the whole assembly of DigiKam, Qt, KDE and Exiv2 working together.  I can't for a couple of reasons:<br />a) I don't know how to.<br />b) I don't have the time.<br />c) I don't believe it is necessary for me to take on ownership of the whole problem.</p>


	<p>There is another approach.  Please reduce the problem to a modest little test program based on mt-test.cpp, or any code you have available.  Please provide a simple definition of the issue that does not involve Qt, boost, DigiKam or any other huge frameworks and then we can fix this.</p>


	<p>I assure you that I am trying to help you.</p></div>
    </div>
  </div>
  
  <div id="change-5351" class="journal has-notes">
    <div id="note-24">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-24" class="journal-link">#24</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="14 Aug 2016 17:36" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5351-private_notes" class=""></span>
    </h4>

    <div id="journal-5351-notes" class="wiki"><p>yes, tomorrow i will look to code test implementation about multi-core and Exiv2.</p>


	<p>But my question about the signal still valid. You said :</p>


<blockquote>

	<p>I don't know what's wrong. It's possible for the signal to come from your exception handler.</p>


</blockquote>

	<p>No signal are emitted from digiKam metadata engine wrapper. We don't use Posix signals in digiKam.</p>


	<p>In <a class="external" href="http://dev.exiv2.org/issues/1164">http://dev.exiv2.org/issues/1164</a>, it said to implement a signal handler in digiKam. The question is why ?</p>


	<p>Gilles Caulier</p></div>
    </div>
  </div>
  
  <div id="change-5352" class="journal has-notes has-details">
    <div id="note-25">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-25" class="journal-link">#25</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Aug 2016 18:10" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5352-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
    </ul>
    <div id="journal-5352-notes" class="wiki"><p>I don't provide software engineering tutorials.  When we have closed this issue and <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: WebP file support (Closed)" href="/issues/1199">#1199</a>, I will under no circumstances give you or digiKam support.  Other members of Team Exiv2 may of course help you, however I will not.</p></div>
    </div>
  </div>
  
  <div id="change-5354" class="journal has-details">
    <div id="note-26">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-26" class="journal-link">#26</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Aug 2016 22:25" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5354-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Assignee</strong> changed from <i>Robin Mills</i> to <i>Gilles Caulier</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-5357" class="journal has-notes">
    <div id="note-27">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-27" class="journal-link">#27</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="14 Aug 2016 23:42" href="/projects/exiv2/activity?from=2016-08-14">over 5 years</a> ago
      <span id="journal-5357-private_notes" class=""></span>
    </h4>

    <div id="journal-5357-notes" class="wiki"><p>uwe,</p>


	<p>in digiKam source code i written a simple CLI test tool named "metareaderthread" :</p>


	<p><a class="external" href="https://quickgit.kde.org/?p=digikam.git&#38;a=blob&#38;f=tests%2Fdmetadata%2Fmetareaderthread.cpp">https://quickgit.kde.org/?p=digikam.git&#38;a=blob&#38;f=tests%2Fdmetadata%2Fmetareaderthread.cpp</a></p>


	<p>Binary is located in build/core/tests/dmetadata/. It's compiled if you enable tests at configuration time through Cmake, with option "-DBUILD_TESTING=ON". If you use bootstrap.linux script to configure whole digiKam source code, this option is enabled by default.</p>


	<p>In command line, just call this tool with a path where is located your collection of images files. The tool will parse the collection recursively and will load metadata from all jpg, png, and tif files. This will use all CPU cores available to run threads where Exiv2 will load metadata and print a resume of main photo info.</p>


	<p>Here, on 4 cores CPU running on a VM, 2000 images from my test collection is parsed in 5 secondes :</p>


	<p>[gilles@localhost dmetadata]$ pwd<br />/home/gilles/Devel/5.x/build/core/tests/dmetadata<br />[gilles@localhost dmetadata]$ ls <del>al<br />total 6524<br />drwxr-xr-x  3 gilles gilles    4096 Aug 14 19:08 ./<br />drwxr-xr-x 20 gilles gilles    4096 Aug 14 17:21 ../<br />drwxr-xr-x 24 gilles gilles    4096 Aug 14 17:21 CMakeFiles/<br />-rw-r--r-</del>  1 gilles gilles     997 Aug 10 06:49 cmake_install.cmake<br /><del>rwxr-xr-x  1 gilles gilles 1027736 Aug 14 17:43 commentReadWriteTest*<br />-rw-r--r-</del>  1 gilles gilles      85 Aug 14 13:41 commentReadWriteTest_automoc.cpp<br /><del>rw-r--r-</del>  1 gilles gilles     305 Aug 10 06:49 CTestTestfile.cmake<br /><del>rwxr-xr-x  1 gilles gilles  393936 Aug 14 17:46 erasetag*<br />-rw-r--r-</del>  1 gilles gilles      93 Aug 10 06:49 erasetag_automoc.cpp<br /><del>rwxr-xr-x  1 gilles gilles  355104 Aug 14 17:45 loadfromba*<br />-rw-r--r-</del>  1 gilles gilles      93 Aug 10 06:49 loadfromba_automoc.cpp<br /><del>rw-r--r-</del>  1 gilles gilles   48923 Aug 14 17:21 Makefile<br /><del>rwxr-xr-x  1 gilles gilles  806040 Aug 14 19:08 metareaderthread*<br />-rw-r--r-</del>  1 gilles gilles      81 Aug 14 19:00 metareaderthread_automoc.cpp<br /><del>rw-r--r-</del>  1 gilles gilles    4231 Aug 14 13:41 moc_commentreadwritetest.cpp<br /><del>rw-r--r-</del>  1 gilles gilles    4234 Aug 14 19:00 moc_metareaderthread.cpp<br /><del>rw-r--r-</del>  1 gilles gilles    4210 Aug 14 13:41 moc_ratingreadwritetest.cpp<br /><del>rw-r--r-</del>  1 gilles gilles    4806 Aug 14 13:41 moc_tagsreadwritetest.cpp<br /><del>rwxr-xr-x  1 gilles gilles  425432 Aug 14 17:45 printtagslist*<br />-rw-r--r-</del>  1 gilles gilles      93 Aug 10 06:49 printtagslist_automoc.cpp<br /><del>rwxr-xr-x  1 gilles gilles  849120 Aug 14 17:43 ratingReadWriteTest*<br />-rw-r--r-</del>  1 gilles gilles      84 Aug 14 13:41 ratingReadWriteTest_automoc.cpp<br /><del>rwxr-xr-x  1 gilles gilles  392904 Aug 14 17:49 readimagewritexmpsidecar*<br />-rw-r--r-</del>  1 gilles gilles      93 Aug 10 06:49 readimagewritexmpsidecar_automoc.cpp<br /><del>rwxr-xr-x  1 gilles gilles  552896 Aug 14 17:45 setiptcpreview*<br />-rw-r--r-</del>  1 gilles gilles      93 Aug 10 06:49 setiptcpreview_automoc.cpp<br /><del>rwxr-xr-x  1 gilles gilles  462872 Aug 14 17:43 setxmpface*<br />-rw-r--r-</del>  1 gilles gilles      93 Aug 10 06:49 setxmpface_automoc.cpp<br /><del>rwxr-xr-x  1 gilles gilles  857880 Aug 14 17:46 tagsReadWriteTest*<br />-rw-r--r-</del>  1 gilles gilles      82 Aug 14 13:41 tagsReadWriteTest_automoc.cpp<br /><del>rwxr-xr-x  1 gilles gilles  393120 Aug 14 17:46 usexmpsidecar*<br />-rw-r--r-</del>  1 gilles gilles      93 Aug 10 06:49 usexmpsidecar_automoc.cpp<br />[gilles@localhost dmetadata]$ ./metareaderthread /mnt/data/<br />digikam.general: Using  4  CPU core to run threads<br />"/mnt/data/2014/2014-07-29/pano4/DSC04692.jpg" <br />"/mnt/data/2014/2014-07-29/pano4/DSC04690.jpg" <br />"/mnt/data/2014/2014-07-29/pano4/DSC04678.jpg" <br />"/mnt/data/2014/2014-07-29/pano4/DSC04700.jpg" <br />"/mnt/data/2014/2014-07-29/pano4/DSC04695.jpg" <br />"/mnt/data/2014/2014-07-29/pano4/DSC04699.jpg" <br />"/mnt/data/2014/2014-07-29/pano4/DSC04702.jpg" <br />"/mnt/data/2014/2014-07-29/pano4/DSC04679.jpg" <br />"/mnt/data/2014/2014-07-29/pano4/DSC04676.jpg" <br />"/mnt/data/2014/2014-07-29/pano4/DSC04682.jpg" <br />"/mnt/data/2014/2014-07-29/pano4/DSC04698.jpg" <br />"/mnt/data/2014/2014-07-29/pano4/DSC04675.jpg" <br />...<br />Photo info:<br />digikam.metaengine: DateTime => Exif.Photo.DateTimeOriginal =>  QDateTime(2014-04-07 16:08:01.000 EDT Qt::TimeSpec(LocalTime))<br />PhotoInfoContainer::make: "SONY", PhotoInfoContainer::model: "SLT-A77V", PhotoInfoContainer::lens: "70-200mm F2.8", PhotoInfoContainer::exposureTime: "1/2000 s", PhotoInfoContainer::exposureMode: "Auto", PhotoInfoContainer::exposureProgram: "Aperture priority", PhotoInfoContainer::aperture: "F2.8", PhotoInfoContainer::focalLength: "70.0 mm", PhotoInfoContainer::focalLength35mm: "105.0 mm", PhotoInfoContainer::sensitivity: "100"PhotoInfoContainer::flash: "No, compulsory"PhotoInfoContainer::whiteBalance: "Auto"PhotoInfoContainer::dateTime: QDateTime(2014-04-07 16:08:01.000 EDT Qt::TimeSpec(LocalTime))PhotoInfoContainer::hasCoordinates: true<br />digikam.general: One job is done<br />2000  files processed<br />digikam.general: Cancel Main Thread<br />[gilles@localhost dmetadata]$</p>


	<p>This tools work fine for you with your collection, without to see a crash ?</p>


	<p>Gilles Caulier</p></div>
    </div>
  </div>
  
  <div id="change-5386" class="journal has-notes">
    <div id="note-28">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-28" class="journal-link">#28</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4731">Uwe Haider</a> <a title="19 Aug 2016 16:30" href="/projects/exiv2/activity?from=2016-08-19">over 5 years</a> ago
      <span id="journal-5386-private_notes" class=""></span>
    </h4>

    <div id="journal-5386-notes" class="wiki"><p>Sorry, got troubles with bootstrap.linux:</p>


	<p>-- The following REQUIRED packages have been found:</p>
	<ul>
	<li>KF5Config (required version >= 5.1.0)
 * KF5XmlGui (required version >= 5.1.0)
 * KF5Service (required version >= 5.1.0)
 * KF5 (required version >= 5.1.0)
 * JPEG
 * PNG
 * TIFF
 * Qt5Gui (required version >= 5.6.1)
 * Qt5Widgets
 * Gettext
 * PythonInterp
 * KF5I18n (required version >= 5.1.0)
 * KF5Wallet (required version >= 5.1.0)
 * KF5WidgetsAddons (required version >= 5.1.0)
 * KF5TextWidgets (required version >= 5.1.0)
 * ECM (required version >= 1.5.0)
 * Qt5Network
 * KF5CoreAddons (required version >= 5.5.0)
 * Qt5Core
 * Qt5Test
 * Qt5 (required version >= 5.2.0)</li>
	</ul>


	<p>CMake Error at extra/libkvkontakte/CMakeLists.txt:34 (find_package):<br />  By not providing "FindKF5WebKit.cmake" in CMAKE_MODULE_PATH this project<br />  has asked CMake to find a package configuration file provided by<br />  "KF5WebKit", but CMake did not find one.</p>
	<pre><code>Could not find a package configuration file provided by "KF5WebKit" <br />  (requested version 5.3.0) with any of the following names:</code></pre>
	<pre><code>KF5WebKitConfig.cmake<br />    kf5webkit-config.cmake</code></pre>
	<pre><code>Add the installation prefix of "KF5WebKit" to CMAKE_PREFIX_PATH or set<br />  "KF5WebKit_DIR" to a directory containing one of the above files.  If<br />  "KF5WebKit" provides a separate development package or SDK, be sure it has<br />  been installed.</code></pre>


	<p>-- Configuring incomplete, errors occurred!<br />See also "/root/digikam-5.1.0/dk/build/CMakeFiles/CMakeOutput.log".</p>


	<p>What's wrong? Do I need KF5WebKit?</p>


	<p>Uwe</p></div>
    </div>
  </div>
  
  <div id="change-5387" class="journal has-notes">
    <div id="note-29">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-29" class="journal-link">#29</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="19 Aug 2016 16:41" href="/projects/exiv2/activity?from=2016-08-19">over 5 years</a> ago
      <span id="journal-5387-private_notes" class=""></span>
    </h4>

    <div id="journal-5387-notes" class="wiki"><p>Uwe</p>


	<p>You're welcome to use this issue to continue to discuss this matter.  However this is mostly about building something.  DigiKam maybe?  Can you restrict discussion here to Exiv2/Threading.</p></div>
    </div>
  </div>
  
  <div id="change-5388" class="journal has-notes">
    <div id="note-30">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-30" class="journal-link">#30</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4731">Uwe Haider</a> <a title="19 Aug 2016 16:51" href="/projects/exiv2/activity?from=2016-08-19">over 5 years</a> ago
      <span id="journal-5388-private_notes" class=""></span>
    </h4>

    <div id="journal-5388-notes" class="wiki"><p>Hi Robin,</p>


	<p>I try to build digikam from git to test the metreaderthread-code from Gilles. Sorry I#am only an user . This is my first time cloning git repository and build without portage. Any help is welcome...</p>


	<p>Uwe</p></div>
    </div>
  </div>
  
  <div id="change-5389" class="journal has-notes">
    <div id="note-31">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-31" class="journal-link">#31</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="19 Aug 2016 17:11" href="/projects/exiv2/activity?from=2016-08-19">over 5 years</a> ago
      <span id="journal-5389-private_notes" class=""></span>
    </h4>

    <div id="journal-5389-notes" class="wiki"><p>Uwe,</p>


	<p>edit bootstrap.linux and change-DDIGIKAMSC_COMPILE_LIBKVKONTAKTE=ON to OFF, and restart it.</p>


	<p>Gilles</p></div>
    </div>
  </div>
  
  <div id="change-5390" class="journal has-notes">
    <div id="note-32">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-32" class="journal-link">#32</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="19 Aug 2016 17:15" href="/projects/exiv2/activity?from=2016-08-19">over 5 years</a> ago
      <span id="journal-5390-private_notes" class=""></span>
    </h4>

    <div id="journal-5390-notes" class="wiki"><p>Robin,</p>


	<p>This is to configure digiKam and compile my multi-cores/mult-threads test CLI tool to check if Exiv2 crash while scanning all images from Uwe in parallel. The goal is to test with a limited code from digiKam to reproduce the problem. Ideally, it's to identify if problem is in digiKam or Exiv2.</p>


	<p>On my computer, it do not crash with current implementation from svn/trunk. I just tested with 2000 items (jpg, png, and tif). Perhaps Uwe will observe another behavior.</p>


	<p>Gilles Caulier</p></div>
    </div>
  </div>
  
  <div id="change-5391" class="journal has-notes">
    <div id="note-33">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-33" class="journal-link">#33</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="19 Aug 2016 17:35" href="/projects/exiv2/activity?from=2016-08-19">over 5 years</a> ago
      <span id="journal-5391-private_notes" class=""></span>
    </h4>

    <div id="journal-5391-notes" class="wiki"><p>I'm very pleased to hear you're making good progress with this.  This is not easy for Uwe.  Building a big application like digiKam is a challenge.  Ben and I are making very good progress with WebP.  I've been working on testing WebP all day.  Hoping to declare WebP solid for reading and writing metadata in the next few days.</p></div>
    </div>
  </div>
  
  <div id="change-5392" class="journal has-notes">
    <div id="note-34">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-34" class="journal-link">#34</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4731">Uwe Haider</a> <a title="19 Aug 2016 17:45" href="/projects/exiv2/activity?from=2016-08-19">over 5 years</a> ago
      <span id="journal-5392-private_notes" class=""></span>
    </h4>

    <div id="journal-5392-notes" class="wiki"><p>It's not easy - but I'm learning a lot :-)</p>


	<p>Now bootstrap.linux runs fine. make too - be back soon.</p>


	<p>I enjoy digikam since 0.7 and I like help to make it better.</p>


	<p>Uwe</p></div>
    </div>
  </div>
  
  <div id="change-5393" class="journal has-notes">
    <div id="note-35">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-35" class="journal-link">#35</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="19 Aug 2016 17:49" href="/projects/exiv2/activity?from=2016-08-19">over 5 years</a> ago
      <span id="journal-5393-private_notes" class=""></span>
    </h4>

    <div id="journal-5393-notes" class="wiki"><p>If you work in software development, you never stop learning.  Every day brings surprises and new technology to be mastered.</p></div>
    </div>
  </div>
  
  <div id="change-5395" class="journal has-notes">
    <div id="note-36">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-36" class="journal-link">#36</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4731">Uwe Haider</a> <a title="19 Aug 2016 19:25" href="/projects/exiv2/activity?from=2016-08-19">over 5 years</a> ago
      <span id="journal-5395-private_notes" class=""></span>
    </h4>

    <div id="journal-5395-notes" class="wiki"><p>I have a job as facility manager. Every day brings surprises and new problems to be mastered.</p>


	<p>I try to learn programming for a while but after work I'm too tired for thinking hard. All I do is taking photos and managing the collection with gentoo (hard enough sometinmes). So bughunting is an new thing for me.</p>


	<p>Now make and make install are all ok. metareadthread is running. First files are done well, now there are some *.png from 2011  giving error 6 invalid key Xmp.exif.Exposureindex &#38; xmp.exif.ISOSpeedratings - but still running.</p>


	<p>Should I start it in gdb?</p>


	<p>Uwe</p></div>
    </div>
  </div>
  
  <div id="change-5397" class="journal has-notes">
    <div id="note-37">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-37" class="journal-link">#37</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="19 Aug 2016 19:31" href="/projects/exiv2/activity?from=2016-08-19">over 5 years</a> ago
      <span id="journal-5397-private_notes" class=""></span>
    </h4>

    <div id="journal-5397-notes" class="wiki"><p>Oh, boy.  gdb isn't a tool for users.  The problem of the multi-threaded crash appears to have gone away.  So I think we've resolved this issue.</p>


	<p>Collect some of the files giving messages into a ZIP and attach them to this issue.  I'll look at them.  Errors/warnings are probably correct.</p></div>
    </div>
  </div>
  
  <div id="change-5406" class="journal has-notes has-details">
    <div id="note-38">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-38" class="journal-link">#38</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4731">Uwe Haider</a> <a title="20 Aug 2016 05:12" href="/projects/exiv2/activity?from=2016-08-20">over 5 years</a> ago
      <span id="journal-5406-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/1039">error6.zip</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/1039/error6.zip">error6.zip</a> added</li>
    </ul>
    <div id="journal-5406-notes" class="wiki"><p><code>digikam.metaengine: DateTime => Exif.Photo.DateTimeOriginal =>  QDateTime(2005-02-01 19:06:15.000 CET Qt::TimeSpec(LocalTime))<br />"p2010001_v1.png" PhotoInfoContainer::make: "OLYMPUS OPTICAL CO.,LTD", PhotoInfoContainer::model: "X-2,C-50Z       ", PhotoInfoContainer::lens: "", PhotoInfoContainer::exposureTime: "1/100 s", PhotoInfoContainer::exposureMode: "Auto", PhotoInfoContainer::exposureProgram: "Creative program", PhotoInfoContainer::aperture: "F4.8", PhotoInfoContainer::focalLength: "23.4 mm", PhotoInfoContainer::focalLength35mm: "", PhotoInfoContainer::sensitivity: "80"PhotoInfoContainer::flash: "Yes, auto"PhotoInfoContainer::whiteBalance: "Auto"PhotoInfoContainer::dateTime: QDateTime(2005-02-01 19:06:15.000 CET Qt::TimeSpec(LocalTime))PhotoInfoContainer::hasCoordinates: false<br />digikam.general: One job is done<br />Reading metadata from  105516  files took  8793.28  seconds<br />digikam.general: Cancel Main Thread</code></p>


	<p>Done! It took a while but no crash.</p>


	<p>Here are the errors of 3 files:<br /><code>digikam.metaengine: DateTime => Exif.Photo.DateTimeOriginal =>  QDateTime(2011-08-15 18:57:59.000 CEST Qt::TimeSpec(LocalTime))<br />digikam.metaengine: Cannot find Exif key 'Xmp.exif.ISOSpeedRatings' into image using Exiv2   (Error # 6 :  Invalid key `Xmp.exif.ISOSpeedRatings'<br />digikam.metaengine: Cannot find Exif key 'Xmp.exif.ExposureIndex' into image using Exiv2   (Error # 6 :  Invalid key `Xmp.exif.ExposureIndex'<br />"2011-08-15T18:57:59.png" PhotoInfoContainer::make: "NIKON CORPORATION", PhotoInfoContainer::model: "NIKON D50", PhotoInfoContainer::lens: "Nikon AF-S DX Zoom-Nikkor 55-200mm f/4-5.6G ED", PhotoInfoContainer::exposureTime: "1/50 s", PhotoInfoContainer::exposureMode: "Auto", PhotoInfoContainer::exposureProgram: "Auto", PhotoInfoContainer::aperture: "F8", PhotoInfoContainer::focalLength: "200.0 mm", PhotoInfoContainer::focalLength35mm: "300.0 mm", PhotoInfoContainer::sensitivity: "200"PhotoInfoContainer::flash: "No flash"PhotoInfoContainer::whiteBalance: "Auto"PhotoInfoContainer::dateTime: QDateTime(2011-08-15 18:57:59.000 CEST Qt::TimeSpec(LocalTime))PhotoInfoContainer::hasCoordinates: false<br />digikam.general: One job is done<br /></code></p>


	<p><code>digikam.metaengine: DateTime => Exif.Photo.DateTimeOriginal =>  QDateTime(2011-08-16 21:25:11.000 CEST Qt::TimeSpec(LocalTime))<br />digikam.metaengine: Cannot find Exif key 'Xmp.exif.ISOSpeedRatings' into image using Exiv2   (Error # 6 :  Invalid key `Xmp.exif.ISOSpeedRatings'<br />digikam.metaengine: Cannot find Exif key 'Xmp.exif.ExposureIndex' into image using Exiv2   (Error # 6 :  Invalid key `Xmp.exif.ExposureIndex'<br />"2011-08-16T21:25:11.png" PhotoInfoContainer::make: "NIKON CORPORATION", PhotoInfoContainer::model: "NIKON D50", PhotoInfoContainer::lens: "Nikon AF-S DX Zoom-Nikkor 18-55mm f/3.5-5.6G ED", PhotoInfoContainer::exposureTime: "1/13 s", PhotoInfoContainer::exposureMode: "Auto", PhotoInfoContainer::exposureProgram: "Auto", PhotoInfoContainer::aperture: "F3.5", PhotoInfoContainer::focalLength: "18.0 mm", PhotoInfoContainer::focalLength35mm: "27.0 mm", PhotoInfoContainer::sensitivity: "200"PhotoInfoContainer::flash: "No flash"PhotoInfoContainer::whiteBalance: "Auto"PhotoInfoContainer::dateTime: QDateTime(2011-08-16 21:25:11.000 CEST Qt::TimeSpec(LocalTime))PhotoInfoContainer::hasCoordinates: true<br />digikam.general: One job is done</code></p>


	<p><code><br />digikam.metaengine: DateTime => Exif.Photo.DateTimeOriginal =>  QDateTime(2011-08-17 12:06:37.000 CEST Qt::TimeSpec(LocalTime))<br />digikam.metaengine: Cannot find Exif key 'Xmp.exif.ISOSpeedRatings' into image using Exiv2   (Error # 6 :  Invalid key `Xmp.exif.ISOSpeedRatings'<br />digikam.metaengine: Cannot find Exif key 'Xmp.exif.ExposureIndex' into image using Exiv2   (Error # 6 :  Invalid key `Xmp.exif.ExposureIndex'<br />"2011-08-17T12:06:37.png" PhotoInfoContainer::make: "NIKON CORPORATION", PhotoInfoContainer::model: "NIKON D50", PhotoInfoContainer::lens: "Nikon AF-S DX Zoom-Nikkor 18-55mm f/3.5-5.6G ED", PhotoInfoContainer::exposureTime: "1/200 s", PhotoInfoContainer::exposureMode: "Auto", PhotoInfoContainer::exposureProgram: "Auto", PhotoInfoContainer::aperture: "F7.1", PhotoInfoContainer::focalLength: "32.0 mm", PhotoInfoContainer::focalLength35mm: "48.0 mm", PhotoInfoContainer::sensitivity: "200"PhotoInfoContainer::flash: "No flash"PhotoInfoContainer::whiteBalance: "Auto"PhotoInfoContainer::dateTime: QDateTime(2011-08-17 12:06:37.000 CEST Qt::TimeSpec(LocalTime))PhotoInfoContainer::hasCoordinates: false<br />digikam.general: One job is done</code></p>


	<p>I have attached the files.</p>


	<p>Uwe</p></div>
    </div>
  </div>
  
  <div id="change-5407" class="journal has-notes">
    <div id="note-39">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-39" class="journal-link">#39</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="20 Aug 2016 05:23" href="/projects/exiv2/activity?from=2016-08-20">over 5 years</a> ago
      <span id="journal-5407-private_notes" class=""></span>
    </h4>

    <div id="journal-5407-notes" class="wiki"><blockquote>

	<p>Reading metadata from 105516 files took 8793.28 seconds</p>


</blockquote>

	<p>Great. Exiv2 parallelization work fine. It's a good point.</p>


	<p>The exception printed on 3 files are not errors in fact. The digiKam Exiv2 interface try to get a sets of tags in image to populate a photo info container grouping common photograph details of shot. Exiv2 do not find some tags checked by interface. That all..</p>


	<p>Gilles Caulier</p></div>
    </div>
  </div>
  
  <div id="change-5408" class="journal has-notes">
    <div id="note-40">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-40" class="journal-link">#40</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="20 Aug 2016 08:03" href="/projects/exiv2/activity?from=2016-08-20">over 5 years</a> ago
      <span id="journal-5408-private_notes" class=""></span>
    </h4>

    <div id="journal-5408-notes" class="wiki"><p>Right.  Well done everybody.  Can I confirm that the resolution for this is:</p>


	<p>1 Exiv2 svn 4350+ to include fix for <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187">#1187</a><br />2 Call Exiv2::XmpParser::initialize(); before spinning up threads<br />(digiKam has done this for years in its exiv2 interface wrapper)</p>


	<p>Gilles:<br />If you are satisfied that no code changes are required in Exiv2, please assign this back to me.  I will add mt-test.cpp to our test suite <em><strong>AND</strong></em> I'll test with more than 3 threads <em><strong>AND</strong></em> many different files.</p></div>
    </div>
  </div>
  
  <div id="change-5419" class="journal has-notes">
    <div id="note-41">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-41" class="journal-link">#41</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="20 Aug 2016 15:56" href="/projects/exiv2/activity?from=2016-08-20">over 5 years</a> ago
      <span id="journal-5419-private_notes" class=""></span>
    </h4>

    <div id="journal-5419-notes" class="wiki"><p>Robin,</p>


	<p>Typically the result while reading on multicore with Exiv2 sound good now.</p>


	<p>It rest a test to do which will be more problematic : writing operations in parallel.</p>


	<p>Uwe,</p>


	<p>I will modify the test CLI tool in digiKam to be able to write something in images. Of course this must be done on a copy of your collection. This will touch your file of course.<br />I think to write one Exif, one Iptc, and one XMP tags at the same time on all image.</p>


	<p>Gilles Caulier</p></div>
    </div>
  </div>
  
  <div id="change-5420" class="journal has-notes has-details">
    <div id="note-42">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-42" class="journal-link">#42</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="20 Aug 2016 16:07" href="/projects/exiv2/activity?from=2016-08-20">over 5 years</a> ago
      <span id="journal-5420-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> changed from <i>design</i> to <i>testing</i></li>
       <li><strong>Assignee</strong> changed from <i>Gilles Caulier</i> to <i>Robin Mills</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>50</i></li>
       <li><strong>Estimated time</strong> set to <i>5.00 h</i></li>
    </ul>
    <div id="journal-5420-notes" class="wiki"><p>Thanks, Gilles.  I will add test/mt-test.cpp.  Testing multi-threading is difficult.  Ssome multithreaded testing is better than none.</p></div>
    </div>
  </div>
  
  <div id="change-5422" class="journal has-notes">
    <div id="note-43">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-43" class="journal-link">#43</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="20 Aug 2016 16:24" href="/projects/exiv2/activity?from=2016-08-20">over 5 years</a> ago
      <span id="journal-5422-private_notes" class=""></span>
    </h4>

    <div id="journal-5422-notes" class="wiki"><p>Uwe ,</p>


	<p>In your collection, do you have video files. If yes, the curretn tool do not try to read video files.</p>


	<p>It's also the case with RAW files. I will at least oatch the code to play with RAW files.</p>


	<p>Gilles Caulier</p></div>
    </div>
  </div>
  
  <div id="change-5423" class="journal has-notes">
    <div id="note-44">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-44" class="journal-link">#44</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="20 Aug 2016 20:12" href="/projects/exiv2/activity?from=2016-08-20">over 5 years</a> ago
      <span id="journal-5423-private_notes" class=""></span>
    </h4>

    <div id="journal-5423-notes" class="wiki"><p>Uwe,</p>


	<p>Implemented with commit <a class="external" href="http://commits.kde.org/digikam/4e9884e4439ba73dd19a600693ac49488b33a4ef">http://commits.kde.org/digikam/4e9884e4439ba73dd19a600693ac49488b33a4ef</a></p>


	<p>new CLI tool syntax :</p>


	<p>bash-3.2$ ./metareaderthread<br />metareaderthread - test to load metadata from images through multi-core threads<br />Usage  : &lt;direction: READ | WRITE&gt; &lt;images path&gt; &lt;image file filter&gt; ... &lt;image file filter&gt;<br />Example: READ /mnt/photos *.jpg *.png *.tif *.nef *.dng<br />Warning: Write direction will touch file matadata contents!</p>


	<p>Gilles Caulier</p></div>
    </div>
  </div>
  
  <div id="change-5424" class="journal has-notes has-details">
    <div id="note-45">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-45" class="journal-link">#45</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="21 Aug 2016 08:21" href="/projects/exiv2/activity?from=2016-08-21">over 5 years</a> ago
      <span id="journal-5424-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Closed</i></li>
       <li><strong>% Done</strong> changed from <i>50</i> to <i>100</i></li>
       <li><strong>Estimated time</strong> changed from <i>5.00 h</i> to <i>6.00 h</i></li>
    </ul>
    <div id="journal-5424-notes" class="wiki"><p><a class="changeset" title="#1207 Added samples/mt-test.cpp" href="/projects/exiv2/repository/exiv2/revisions/4422">r4422</a> Added samples/mt-test.cpp</p>


	<p>It's amazing how fast this code executes. 42 images from my vacation in Finland.  Opened and read in less than 0.1 seconds.<pre>808 rmills@rmillsmbp:~/gnu/exiv2/trunk $ time bin/mt-test  ~/Pictures/2016/Finland/Alskar/*.jpg | wc
      42     252    3309

real    0m0.084s
user    0m0.086s
sys    0m0.030s
809 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre></p></div>
    </div>
  </div>
  
  <div id="change-5426" class="journal has-notes">
    <div id="note-46">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-46" class="journal-link">#46</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="21 Aug 2016 08:34" href="/projects/exiv2/activity?from=2016-08-21">over 5 years</a> ago
      <span id="journal-5426-private_notes" class=""></span>
    </h4>

    <div id="journal-5426-notes" class="wiki"><p>Robin,</p>


	<p>The speed depend a lots of drive device type with Exiv2.. With my multicore CLI tool,  here i use SSD, and 2000 items are parsed in few seconds. If i do the same in a real hard drive, it's note really the same.... Time is at least multiplied by 10.</p>


	<p>Also, the cache memory from device and driver have a lots of influence. I recommend to check with more items. As in statistic in real world, use more than 1000 items to start to have a real sample measurement results..</p>


	<p>Gilles Caulier</p></div>
    </div>
  </div>
  
  <div id="change-5427" class="journal has-notes">
    <div id="note-47">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-47" class="journal-link">#47</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="21 Aug 2016 09:25" href="/projects/exiv2/activity?from=2016-08-21">over 5 years</a> ago
      <span id="journal-5427-private_notes" class=""></span>
    </h4>

    <div id="journal-5427-notes" class="wiki"><p>2000 in just over a second:<pre>842 rmills@rmillsmbp:~/gnu/exiv2/trunk $ time find ~/Pictures/2016 -print0 -name "*.jpg" | xargs -0 bin/mt-test 2&gt;/dev/null  | wc
    2236   25236  272275

real    0m1.293s
user    0m2.758s
sys    0m1.201s
843 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre></p></div>
    </div>
  </div>
  
  <div id="change-5428" class="journal has-notes">
    <div id="note-48">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-48" class="journal-link">#48</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="21 Aug 2016 09:31" href="/projects/exiv2/activity?from=2016-08-21">over 5 years</a> ago
      <span id="journal-5428-private_notes" class=""></span>
    </h4>

    <div id="journal-5428-notes" class="wiki"><p>Robin,</p>


	<p>Did you use a SSD ?</p>


	<p>Gilles</p></div>
    </div>
  </div>
  
  <div id="change-5429" class="journal has-notes">
    <div id="note-49">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-49" class="journal-link">#49</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="21 Aug 2016 10:15" href="/projects/exiv2/activity?from=2016-08-21">over 5 years</a> ago
      <span id="journal-5429-private_notes" class=""></span>
    </h4>

    <div id="journal-5429-notes" class="wiki"><p>Yes.  That was running on my MacBook Pro with an SSD.  Not so quick on my elderly 2008 iMac with a 3TB HD where it dies a horrible death:<pre>libc++abi.dylib: terminating with uncaught exception of type std::__1::system_error: thread constructor failed: Resource temporarily unavailable</pre>I think it's running out of threads on the 2-Core machine.  I'd have to add code to throttle the number of concurrent threads.</p>


	<p>I don't want to spend any more time on this.</p></div>
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1207.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1207.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
