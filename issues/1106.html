<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #1106: Crash in exiv2 due to assertion when setting rating on jpg with a Casio makernote - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="iNdJXm5bKi7PSggI8hJEkgLbU2UAzju+hasRB4b5UhZqmuKxHCHmLpouFwRNxUihPUkHHPEtmgR4i4GPxcC1eQ==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #1106: Crash in exiv2 due to assertion when setting rating on jpg with a Casio makernote" href="https://dev.exiv2.org/issues/1106.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #1106</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Crash in exiv2 due to assertion when setting rating on jpg with a Casio makernote</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/4270">Luca Carlon</a> <a title="19 Aug 2015 00:43" href="/projects/exiv2/activity?from=2015-08-19">over 6 years</a> ago.
        Updated <a title="16 Jul 2017 10:07" href="/projects/exiv2/activity?from=2017-07-16">over 4 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">metadata</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="28 Apr 2017" href="/versions/52">0.26</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">19 Aug 2015</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">12.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>When setting the rating for a specific jpg file I get a crash of digikam because of an assertion with this backtrace:</p>


	<p><code>(gdb) bt<br />#0  0x00007ffff106c267 in __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:55<br />#1  0x00007ffff106deca in __GI_abort () at abort.c:89<br />#2  0x00007ffff106503d in __assert_fail_base (fmt=0x7ffff11c7028 "%s%s%s:%u: %s%sAssertion `%s' failed.\n%n", <br />    assertion=assertion@entry=0x7fffef2b449f "mn_", file=file@entry=0x7fffef2b4248 "/home/luca/project/digikam/exiv2-0.25/src/tiffcomposite.cpp", <br />    line=line@entry=749, <br />    function=function@entry=0x7fffef2b4cc0 &lt;Exiv2::Internal::TiffMnEntry::doAddPath(unsigned short, std::stack&lt;Exiv2::Internal::TiffPathItem, std::deque&lt;Exiv2::Internal::TiffPathItem, std::allocator&lt;Exiv2::Internal::TiffPathItem&gt; > >&#38;, Exiv2::Internal::TiffComponent*, std::auto_ptr&lt;Exiv2::Internal::TiffComponent&gt;)::__PRETTY_FUNCTION__> "virtual Exiv2::Internal::TiffComponent* Exiv2::Internal::TiffMnEntry::doAddPath(uint16_t, Exiv2::Internal::TiffPath&#38;, Exiv2::Internal::TiffComponent*, Exiv2::Internal::TiffComponent::AutoPtr)") at assert.c:92<br />#3  0x00007ffff10650f2 in __GI___assert_fail (assertion=0x7fffef2b449f "mn_", <br />    file=0x7fffef2b4248 "/home/luca/project/digikam/exiv2-0.25/src/tiffcomposite.cpp", line=749, <br />    function=0x7fffef2b4cc0 &lt;Exiv2::Internal::TiffMnEntry::doAddPath(unsigned short, std::stack&lt;Exiv2::Internal::TiffPathItem, std::deque&lt;Exiv2::Internal::TiffPathItem, std::allocator&lt;Exiv2::Internal::TiffPathItem&gt; > >&#38;, Exiv2::Internal::TiffComponent*, std::auto_ptr&lt;Exiv2::Internal::TiffComponent&gt;)::__PRETTY_FUNCTION__> "virtual Exiv2::Internal::TiffComponent* Exiv2::Internal::TiffMnEntry::doAddPath(uint16_t, Exiv2::Internal::TiffPath&#38;, Exiv2::Internal::TiffComponent*, Exiv2::Internal::TiffComponent::AutoPtr)") at assert.c:101<br />#4  0x00007fffef1c4253 in Exiv2::Internal::TiffMnEntry::doAddPath(unsigned short, std::stack&lt;Exiv2::Internal::TiffPathItem, std::deque&lt;Exiv2::Internal::TiffPathItem, std::allocator&lt;Exiv2::Internal::TiffPathItem&gt; > >&#38;, Exiv2::Internal::TiffComponent*, std::auto_ptr&lt;Exiv2::Internal::TiffComponent&gt;)<br />    () from /home/luca/project/digikam/staging/lib/libexiv2.so.14<br />#5  0x00007fffef1c3871 in Exiv2::Internal::TiffComponent::addPath(unsigned short, std::stack&lt;Exiv2::Internal::TiffPathItem, std::deque&lt;Exiv2::Internal::TiffPathItem, std::allocator&lt;Exiv2::Internal::TiffPathItem&gt; > >&#38;, Exiv2::Internal::TiffComponent*, std::auto_ptr&lt;Exiv2::Internal::TiffComponent&gt;)<br />    () from /home/luca/project/digikam/staging/lib/libexiv2.so.14<br />#6  0x00007fffef1c3cf4 in Exiv2::Internal::TiffDirectory::doAddPath(unsigned short, std::stack&lt;Exiv2::Internal::TiffPathItem, std::deque&lt;Exiv2::Internal::TiffPathItem, std::allocator&lt;Exiv2::Internal::TiffPathItem&gt; > >&#38;, Exiv2::Internal::TiffComponent*, std::auto_ptr&lt;Exiv2::Internal::TiffComponent&gt;) () from /home/luca/project/digikam/staging/lib/libexiv2.so.14<br />#7  0x00007fffef1c3871 in Exiv2::Internal::TiffComponent::addPath(unsigned short, std::stack&lt;Exiv2::Internal::TiffPathItem, std::deque&lt;Exiv2::Internal::TiffPathItem, std::allocator&lt;Exiv2::Internal::TiffPathItem&gt; > >&#38;, Exiv2::Internal::TiffComponent*, std::auto_ptr&lt;Exiv2::Internal::TiffComponent&gt;)<br />    () from /home/luca/project/digikam/staging/lib/libexiv2.so.14<br />#8  0x00007fffef1c4060 in Exiv2::Internal::TiffSubIfd::doAddPath(unsigned short, std::stack&lt;Exiv2::Internal::TiffPathItem, std::deque&lt;Exiv2::Internal::TiffPathItem, std::allocator&lt;Exiv2::Internal::TiffPathItem&gt; > >&#38;, Exiv2::Internal::TiffComponent*, std::auto_ptr&lt;Exiv2::Internal::TiffComponent&gt;)<br />    () from /home/luca/project/digikam/staging/lib/libexiv2.so.14<br />#9  0x00007fffef1c3871 in Exiv2::Internal::TiffComponent::addPath(unsigned short, std::stack&lt;Exiv2::Internal::TiffPathItem, std::deque&lt;Exiv2::Internal::TiffPathItem, std::allocator&lt;Exiv2::Internal::TiffPathItem&gt; > >&#38;, Exiv2::Internal::TiffComponent*, std::auto_ptr&lt;Exiv2::Internal::TiffComponent&gt;)<br />    () from /home/luca/project/digikam/staging/lib/libexiv2.so.14<br />#10 0x00007fffef1c3cf4 in Exiv2::Internal::TiffDirectory::doAddPath(unsigned short, std::stack&lt;Exiv2::Internal::TiffPathItem, std::deque&lt;Exiv2::Internal::TiffPathItem, std::allocator&lt;Exiv2::Internal::TiffPathItem&gt; > >&#38;, Exiv2::Internal::TiffComponent*, std::auto_ptr&lt;Exiv2::Internal::TiffComponent&gt;) () from /home/luca/project/digikam/staging/lib/libexiv2.so.14<br />#11 0x00007fffef1c3871 in Exiv2::Internal::TiffComponent::addPath(unsigned short, std::stack&lt;Exiv2::Internal::TiffPathItem, std::deque&lt;Exiv2::Internal::TiffPathItem, std::allocator&lt;Exiv2::Internal::TiffPathItem&gt; > >&#38;, Exiv2::Internal::TiffComponent*, std::auto_ptr&lt;Exiv2::Internal::TiffComponent&gt;)<br />    () from /home/luca/project/digikam/staging/lib/libexiv2.so.14<br />#12 0x00007fffef1e6d0c in Exiv2::Internal::TiffEncoder::add(Exiv2::Internal::TiffComponent*, Exiv2::Internal::TiffComponent*, unsigned int) ()<br />   from /home/luca/project/digikam/staging/lib/libexiv2.so.14<br />#13 0x00007fffef1d3310 in Exiv2::Internal::TiffParserWorker::encode(Exiv2::BasicIo&#38;, unsigned char const*, unsigned int, Exiv2::ExifData const&#38;, Exiv2::IptcData const&#38;, Exiv2::XmpData const&#38;, unsigned int, void (Exiv2::Internal::TiffEncoder::*(*)(std::string const&#38;, unsigned int, Exiv2::Internal::IfdId))(Exiv2::Internal::TiffEntryBase*, Exiv2::Exifdatum const*), Exiv2::Internal::TiffHeaderBase*, Exiv2::Internal::OffsetWriter*) ()<br />   from /home/luca/project/digikam/staging/lib/libexiv2.so.14<br />#14 0x00007fffef142657 in Exiv2::ExifParser::encode(std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; >&#38;, unsigned char const*, unsigned int, Exiv2::ByteOrder, Exiv2::ExifData const&#38;) () from /home/luca/project/digikam/staging/lib/libexiv2.so.14<br />#15 0x00007fffef165a0b in Exiv2::JpegBase::doWriteMetadata(Exiv2::BasicIo&#38;) () from /home/luca/project/digikam/staging/lib/libexiv2.so.14<br />#16 0x00007fffef164824 in Exiv2::JpegBase::writeMetadata() () from /home/luca/project/digikam/staging/lib/libexiv2.so.14<br />#17 0x00007ffff62e6c7e in KExiv2Iface::KExiv2::Private::saveOperations (this=this@entry=0x7fff6c07a8d0, finfo=..., image=...)<br />    at /home/luca/project/digikam/libkexiv2-15.04.3/libkexiv2/kexiv2_p.cpp:312<br />#18 0x00007ffff62e9d85 in KExiv2Iface::KExiv2::Private::saveToFile (this=0x7fff6c07a8d0, finfo=...)<br />    at /home/luca/project/digikam/libkexiv2-15.04.3/libkexiv2/kexiv2_p.cpp:155<br />#19 0x00007ffff62e2ec8 in KExiv2Iface::KExiv2::save (this=0x7fff617f93b0, imageFilePath=...)<br />    at /home/luca/project/digikam/libkexiv2-15.04.3/libkexiv2/kexiv2.cpp:448<br />#20 0x00007ffff62e46a9 in KExiv2Iface::KExiv2::applyChanges (this=this@entry=0x7fff617f93b0)<br />    at /home/luca/project/digikam/libkexiv2-15.04.3/libkexiv2/kexiv2.cpp:476<br />#21 0x00007ffff5bc8780 in Digikam::DMetadata::applyChanges (this=this@entry=0x7fff617f93b0)<br />    at /home/luca/project/digikam/digikam-software-compilation/core/libs/dmetadata/dmetadata.cpp:130<br />#22 0x000000000062ce7f in Digikam::MetadataHub::write (this=this@entry=0x7fff617f9420, filePath=..., <br />    writeMode=writeMode@entry=Digikam::MetadataHub::FullWrite, settings=...)<br />    at /home/luca/project/digikam/digikam-software-compilation/core/app/fileaction/metadatahub.cpp:764<br />#23 0x00000000006362c4 in Digikam::FileActionMngrFileWorker::writeMetadataToFiles (this=0x143e7f0, infos=...)<br />    at /home/luca/project/digikam/digikam-software-compilation/core/app/fileaction/fileworkeriface.cpp:103<br />#24 0x0000000000635b1f in Digikam::FileWorkerInterface::qt_static_metacall (_o=0x143e7f0, _c=&lt;optimized out&gt;, _id=&lt;optimized out&gt;, <br />    _a=&lt;optimized out&gt;) at /home/luca/project/digikam/digikam-software-compilation/build/core/app/fileworkeriface.moc:66<br />#25 0x00007ffff1d438e1 in QObject::event(QEvent*) () from /usr/lib/x86_64-linux-gnu/libQtCore.so.4<br />#26 0x00007ffff27379bc in QApplicationPrivate::notify_helper(QObject*, QEvent*) () from /usr/lib/x86_64-linux-gnu/libQtGui.so.4<br />#27 0x00007ffff273e4d8 in QApplication::notify(QObject*, QEvent*) () from /usr/lib/x86_64-linux-gnu/libQtGui.so.4<br />#28 0x00007ffff36e0c2a in KApplication::notify(QObject*, QEvent*) () from /usr/lib/libkdeui.so.5<br />#29 0x00007ffff1d2a1cd in QCoreApplication::notifyInternal(QObject*, QEvent*) () from /usr/lib/x86_64-linux-gnu/libQtCore.so.4<br />#30 0x00007ffff1d2da71 in QCoreApplicationPrivate::sendPostedEvents(QObject*, int, QThreadData*) () from /usr/lib/x86_64-linux-gnu/libQtCore.so.4<br />#31 0x00007ffff1d596ee in ?? () from /usr/lib/x86_64-linux-gnu/libQtCore.so.4<br />#32 0x00007fffea835c3d in g_main_context_dispatch () from /lib/x86_64-linux-gnu/libglib-2.0.so.0<br />#33 0x00007fffea835f20 in ?? () from /lib/x86_64-linux-gnu/libglib-2.0.so.0<br />#34 0x00007fffea835fcc in g_main_context_iteration () from /lib/x86_64-linux-gnu/libglib-2.0.so.0<br />#35 0x00007ffff1d5985e in QEventDispatcherGlib::processEvents(QFlags&lt;QEventLoop::ProcessEventsFlag&gt;) ()<br />   from /usr/lib/x86_64-linux-gnu/libQtCore.so.4<br />#36 0x00007ffff1d28d21 in QEventLoop::processEvents(QFlags&lt;QEventLoop::ProcessEventsFlag&gt;) () from /usr/lib/x86_64-linux-gnu/libQtCore.so.4<br />#37 0x00007ffff1d29085 in QEventLoop::exec(QFlags&lt;QEventLoop::ProcessEventsFlag&gt;) () from /usr/lib/x86_64-linux-gnu/libQtCore.so.4<br />#38 0x00007ffff5c484f3 in Digikam::WorkerObjectRunnable::run (this=0x7fff8c046180)<br />    at /home/luca/project/digikam/digikam-software-compilation/core/libs/threads/threadmanager.cpp:196<br />#39 0x00007ffff1c12b70 in ?? () from /usr/lib/x86_64-linux-gnu/libQtCore.so.4<br />#40 0x00007ffff1c1f6ff in ?? () from /usr/lib/x86_64-linux-gnu/libQtCore.so.4<br />#41 0x00007fffee12f6aa in start_thread (arg=0x7fff617fa700) at pthread_create.c:333<br />#42 0x00007ffff113deed in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109</code></p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/817">CIMG2288.JPG</a>    <span class="size">(1.81 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/817/CIMG2288.JPG">CIMG2288.JPG</a>  </td>
  <td>Rating was set once. Will crash setting once again.</td>
  <td>
      <span class="author">Luca Carlon, 21 Aug 2015 01:29</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/818">CIMG2289.JPG</a>    <span class="size">(1.75 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/818/CIMG2289.JPG">CIMG2289.JPG</a>  </td>
  <td>Never set rating but it is supposed to crash as coming from the same camera.</td>
  <td>
      <span class="author">Luca Carlon, 21 Aug 2015 01:29</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>







<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/1106" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="OUT67nOp9Qd0FtZQwFqQOt0XcA3qumqYq/fd6arkrYDbCVEBAdM5ByFyyVx/jZwJ4oUkdBtZyyJW101h6d1K7w==" />
  <table class="list issues odd-even"><tr id="relation-165" class="issue hascontextmenu issue tracker-2 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="933" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-2 status-5 priority-4 priority-default closed" href="/issues/933">Feature #933</a>: Casio Makernotes</td><td class="status">Closed</td><td class="start_date">29 Oct 2013</td><td class="due_date">07 Dec 2013</td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-195" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1146" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/1146">Bug #1146</a>: Crash when saving a rotated JPG image</td><td class="status">Closed</td><td class="start_date">27 Dec 2015</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-222" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1181" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/1181">Bug #1181</a>: Casio.jpg exports crash darktable - suse leap 42.1</td><td class="status">Closed</td><td class="start_date">27 Apr 2016</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-228" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1184" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/1184">Bug #1184</a>: digikam crash when importing Casio jpeg</td><td class="status">Closed</td><td class="start_date">16 May 2016</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-172" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1094" /></td><td class="subject" style="width: 50%">Has duplicate Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/1094">Bug #1094</a>: Crash in Exiv2 shared lib</td><td class="status">Closed</td><td class="start_date">19 Jul 2015</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/1106/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=1106&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 3889" href="/projects/exiv2/repository/exiv2/revisions/3889">Revision 3889</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/3889/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="22 Aug 2015 06:44" href="/projects/exiv2/activity?from=2015-08-22">about 6 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash in exiv2 due to assertion when setting rating on jpg with a Casio makernote (Closed)" href="/issues/1106">#1106</a> (<a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Casio Makernotes (Closed)" href="/issues/933">#933</a>): Fixed oversight that prevented writing Casio2 makernotes.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 3890" href="/projects/exiv2/repository/exiv2/revisions/3890">Revision 3890</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/3890/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="22 Aug 2015 10:43" href="/projects/exiv2/activity?from=2015-08-22">about 6 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash in exiv2 due to assertion when setting rating on jpg with a Casio makernote (Closed)" href="/issues/1106">#1106</a> (<a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Casio Makernotes (Closed)" href="/issues/933">#933</a>): Fixed oversight that prevented writing to images with a Casio makernote.</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-3973" class="journal has-notes">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="20 Aug 2015 19:51" href="/projects/exiv2/activity?from=2015-08-20">over 6 years</a> ago
      <span id="journal-3973-private_notes" class=""></span>
    </h4>

    <div id="journal-3973-notes" class="wiki"><p>There really isn't enough information here to make progress on this issue.  Can you provide a test file, please?</p>


	<p>Additionally, I'm not familiar with DigiKam and don't know how it maps "Rating" to metadata in an image.  To help me, can you reproduce the fault with the exiv2 command-line application?  I've performed this little test on one of my images:<pre>710 rmills@rmillsmbp:~/Downloads $ curl http://dev.exiv2.org/attachments/download/805/DSC_7154.jpg &gt; Stonehenge.jpg
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 6597k    0 6597k    0     0  1323k      0 --:--:--  0:00:04 --:--:-- 1531k
711 rmills@rmillsmbp:~/Downloads $ exiv2 -g Rating Stonehenge.jpg
Exif.Photo.ISOSpeedRatings                   Short       1  200
Xmp.xmp.Rating                               XmpText     1  0
712 rmills@rmillsmbp:~/Downloads $ exiv2 -M"set Xmp.xmp.Rating Great" Stonehenge.jpg
713 rmills@rmillsmbp:~/Downloads $ exiv2 -g Rating Stonehenge.jpg
Exif.Photo.ISOSpeedRatings                   Short       1  200
Xmp.xmp.Rating                               XmpText     5  Great
714 rmills@rmillsmbp:~/Downloads $ </pre>Looking at the traceback, we appear to be a few levels of recursion into addPath/doAddPath and attempting to update a makernote.  So, I don't believe DigiKam is attempting to work on Xmp.xmp.Rating as this XMP and not part of a MakerNote.</p>


	<p>A test image in necessary to progress this issue.  Perhaps you also have an image for which DigiKam has successfully updated 'Rating'.  It could be very useful to see the exiv2 output before/after changing the 'Rating' to give me more insight about which metadata field DigiKam is trying to set.</p></div>
    </div>
  </div>
  
  <div id="change-3974" class="journal has-notes has-details">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4270">Luca Carlon</a> <a title="21 Aug 2015 01:29" href="/projects/exiv2/activity?from=2015-08-21">over 6 years</a> ago
      <span id="journal-3974-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/817">CIMG2288.JPG</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/817/CIMG2288.JPG">CIMG2288.JPG</a> added</li>
       <li><strong>File</strong> <a href="/attachments/818">CIMG2289.JPG</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/818/CIMG2289.JPG">CIMG2289.JPG</a> added</li>
    </ul>
    <div id="journal-3974-notes" class="wiki"><p>Fortunately it is simple to reproduce. Just changing the rating for any photo produced with a specific camera model (Casio) makes it crash. Pay attention to the fact that after crashing it seems the rating is actually applied and can be read. But will then crash again when trying to change it.</p>


	<p>I attach two images. I already assigned the rating once for CIMG2288.JPG. Never for CIMG2289.JPG. Both are supposed to crash as they all come from the same camera. Please let me know if there is anything else I can do.</p></div>
    </div>
  </div>
  
  <div id="change-3975" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4270">Luca Carlon</a> <a title="21 Aug 2015 02:18" href="/projects/exiv2/activity?from=2015-08-21">over 6 years</a> ago
      <span id="journal-3975-private_notes" class=""></span>
    </h4>

    <div id="journal-3975-notes" class="wiki"><p>Unless digikam saves the rating also in some internal db. In that case I was wrong. The rating is not successful.</p></div>
    </div>
  </div>
  
  <div id="change-3976" class="journal has-notes">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="21 Aug 2015 02:32" href="/projects/exiv2/activity?from=2015-08-21">over 6 years</a> ago
      <span id="journal-3976-private_notes" class=""></span>
    </h4>

    <div id="journal-3976-notes" class="wiki"><p>Reproduced on my Ubuntu system with digikam 4.12.0 and exiv 0.25. Here are a few notes.</p>


	<p>Digikam shows the Rating as stars under the image thumbnails. Clicking the stars to change the Rating crashes Digikam for the attached images. Doing the same for other images on my system does not result in a crash. As Luca said, for the affected images, the Rating does not actually get successfully written to the image, it does however remain in the Digikam DB so it appears that the rating has been saved.</p>


	<p>From the command line, exiv2 does not crash when writing the Rating to the file:<br /><pre>
~$ exiv2 -M"set Xmp.xmp.Rating 3" CIMG2288.JPG
~$ exiv2 -g Rating CIMG2288.JPG 
Xmp.xmp.Rating                               XmpText     1  3
</pre></p>


	<p>The setImageRating function in Digikam can be seen here:</p>


	<p><a class="external" href="https://projects.kde.org/projects/extragear/graphics/digikam/repository/revisions/master/entry/libs/dmetadata/dmetadata.cpp#L861">https://projects.kde.org/projects/extragear/graphics/digikam/repository/revisions/master/entry/libs/dmetadata/dmetadata.cpp#L861</a></p></div>
    </div>
  </div>
  
  <div id="change-3977" class="journal has-notes">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="21 Aug 2015 02:38" href="/projects/exiv2/activity?from=2015-08-21">over 6 years</a> ago
      <span id="journal-3977-private_notes" class=""></span>
    </h4>

    <div id="journal-3977-notes" class="wiki"><p>Here is the result for a test image which does not crash Digikam</p>


<pre>
~$ exiv2 -g ating rating.jpg 
Exif.Image.Rating                            SLong       1  4
Exif.Image.RatingPercent                     SLong       1  75
Xmp.xmp.Rating                               XmpText     1  4
Xmp.acdsee.rating                            XmpText     1  4
Xmp.MicrosoftPhoto.Rating                    XmpText     2  75
</pre></div>
    </div>
  </div>
  
  <div id="change-3984" class="journal has-notes has-details">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="21 Aug 2015 10:30" href="/projects/exiv2/activity?from=2015-08-21">over 6 years</a> ago
      <span id="journal-3984-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> set to <i>metadata</i></li>
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Target version</strong> set to <i>0.26</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>10</i></li>
       <li><strong>Estimated time</strong> set to <i>10.00 h</i></li>
    </ul>
    <div id="journal-3984-notes" class="wiki"><p>Thanks for digging up the DigiKam code, Alan.  It looks as though DigiKam is only attempting to set a few tags (3 XMP and 2 Exif).  So why is the traceback indicating a recursive dive in an attempt to modify makernotes?  How odd. I will have to get DigiKam to step a debug libexiv2 in the debugger.  Groan: it's gonna take a while to feel motivated to tackle this.  Maybe Gilles can be persuaded/cajoled into this as he's tooled up for this and in his comfort zone.</p></div>
    </div>
  </div>
  
  <div id="change-3989" class="journal has-notes">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="21 Aug 2015 13:59" href="/projects/exiv2/activity?from=2015-08-21">about 6 years</a> ago
      <span id="journal-3989-private_notes" class=""></span>
    </h4>

    <div id="journal-3989-notes" class="wiki"><p>Another note:</p>


	<p>It is not just setting the Rating that crashes Digikam. I tried setting the Title on the Casio test images and that caused a crash as well.</p></div>
    </div>
  </div>
  
  <div id="change-4012" class="journal has-notes has-details">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="22 Aug 2015 03:55" href="/projects/exiv2/activity?from=2015-08-22">about 6 years</a> ago
      <span id="journal-4012-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Assignee</strong> changed from <i>Robin Mills</i> to <i>Andreas Huggel</i></li>
    </ul>
    <div id="journal-4012-notes" class="wiki"><p>Alan was close, just write an Exif tag instead of an XMP property to reproduce this. Exiv2 will then have to re-write the entire Exif structure, including the Makernote, which triggers the assertion. (If you write an XMP property, only the XMP structure is re-written.) Something in the Exif structure of this image violates an assumption that the Tiff parser makes. That is a bug, and likely a rather hairy one. I'll steal this from Robin and will take a look.</p>


<pre>
$ exiv2 -M"set Exif.Image.Rating 3" CIMG2289.JPG 
exiv2: tiffcomposite.cpp:749: 
virtual Exiv2::Internal::TiffComponent* Exiv2::Internal::TiffMnEntry::doAddPath(uint16_t, Exiv2::Internal::TiffPath&#38;, 
Exiv2::Internal::TiffComponent*, 
Exiv2::Internal::TiffComponent::AutoPtr): Assertion `mn_' failed.
Aborted (core dumped)
</pre></div>
    </div>
  </div>
  
  <div id="change-4021" class="journal has-notes has-details">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="22 Aug 2015 10:47" href="/projects/exiv2/activity?from=2015-08-22">about 6 years</a> ago
      <span id="journal-4021-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Resolved</i></li>
       <li><strong>% Done</strong> changed from <i>10</i> to <i>100</i></li>
    </ul>
    <div id="journal-4021-notes" class="wiki"><p>No, nothing wrong with the Tiff parser. Just two missing lines in the original Casio makernote implementation (<a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Casio Makernotes (Closed)" href="/issues/933">#933</a>).<br />Luca, can you try with Exiv2 from the trunk and let us know if it works for you too?</p></div>
    </div>
  </div>
  
  <div id="change-4024" class="journal has-notes">
    <div id="note-10">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-10" class="journal-link">#10</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4270">Luca Carlon</a> <a title="22 Aug 2015 11:49" href="/projects/exiv2/activity?from=2015-08-22">about 6 years</a> ago
      <span id="journal-4024-private_notes" class=""></span>
    </h4>

    <div id="journal-4024-notes" class="wiki"><p>Rebuilt exiv2, kexiv2 and digikam with current HEAD. Rating seems fixed:</p>


	<p>luca@luca-virtual-machine:...$ exiv2 -g ating CIMG2233.JPG<br />Exif.Photo.ISOSpeedRatings                   Short       1  64<br />luca@luca-virtual-machine:...$ exiv2 -g ating CIMG2233.JPG<br />Exif.Image.Rating                            SLong       1  4<br />Exif.Image.RatingPercent                     SLong       1  75<br />Exif.Photo.ISOSpeedRatings                   Short       1  64<br />Xmp.xmp.Rating                               XmpText     1  4<br />Xmp.acdsee.rating                            XmpText     1  4<br />Xmp.MicrosoftPhoto.Rating                    XmpText     2  75</p>


	<p>Tried a few times. No crash. Great work! Thanks!</p></div>
    </div>
  </div>
  
  <div id="change-4026" class="journal has-notes">
    <div id="note-11">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-11" class="journal-link">#11</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="22 Aug 2015 13:54" href="/projects/exiv2/activity?from=2015-08-22">about 6 years</a> ago
      <span id="journal-4026-private_notes" class=""></span>
    </h4>

    <div id="journal-4026-notes" class="wiki"><p>Well done, team.  This team-work stuff works wonders.</p>


	<p>I'll leave this as "Resolved" for a while.  If nothing else surfaces about this matter, I'll mark it "closed" before we ship v0.26.</p></div>
    </div>
  </div>
  
  <div id="change-4105" class="journal has-details">
    <div id="note-12">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-12" class="journal-link">#12</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="24 Aug 2015 05:05" href="/projects/exiv2/activity?from=2015-08-24">about 6 years</a> ago
      <span id="journal-4105-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Subject</strong> changed from <i>Crash in exiv2 due to assertion when setting rating on jpg</i> to <i>Crash in exiv2 due to assertion when setting rating on jpg with a Casio makernote</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-4437" class="journal has-notes has-details">
    <div id="note-13">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-13" class="journal-link">#13</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="08 Nov 2015 18:38" href="/projects/exiv2/activity?from=2015-11-08">about 6 years</a> ago
      <span id="journal-4437-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Resolved</i> to <i>Closed</i></li>
    </ul>
    <div id="journal-4437-notes" class="wiki"><p>I'm going to set the status of this to closed.  It has been 100% resolved for some time without further incident.</p></div>
    </div>
  </div>
  
  <div id="change-4990" class="journal has-notes">
    <div id="note-14">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-14" class="journal-link">#14</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="27 Apr 2016 21:11" href="/projects/exiv2/activity?from=2016-04-27">over 5 years</a> ago
      <span id="journal-4990-private_notes" class=""></span>
    </h4>

    <div id="journal-4990-notes" class="wiki"><p><a class="changeset" title="#1106 (#933): Fixed oversight that prevented writing Casio2 makernotes." href="/projects/exiv2/repository/exiv2/revisions/3889">r3889</a> and <a class="changeset" title="#1106 (#933): Fixed oversight that prevented writing to images with a Casio makernote." href="/projects/exiv2/repository/exiv2/revisions/3890">r3890</a> are included in exiv2: 0.25-2.1pmjdebruijn1~xenial <a class="external" href="https://launchpad.net/~pmjdebruijn/+archive/ubuntu/darktable-unstable/+packages">https://launchpad.net/~pmjdebruijn/+archive/ubuntu/darktable-unstable/+packages</a> thanks to splendid work by Pascal.</p></div>
    </div>
  </div>
  
  <div id="change-5226" class="journal has-notes">
    <div id="note-15">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-15" class="journal-link">#15</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4723">D T</a> <a title="01 Aug 2016 20:39" href="/projects/exiv2/activity?from=2016-08-01">over 5 years</a> ago
      <span id="journal-5226-private_notes" class=""></span>
    </h4>

    <div id="journal-5226-notes" class="wiki"><p>Robin Mills wrote:</p>


<blockquote>

	<p>I'm going to set the status of this to closed.  It has been 100% resolved for some time without further incident.</p>


</blockquote>

	<p>I apologize if I should open a new incident instead of reporting here, but I am wondering if my error represents a continuation of this same issue. I am on Arch Linux 64 bit (fully updated).</p>


	<p>I installed this package which includes exiv2:</p>


	<p>Arch Linux - gimp-ufraw 0.22-7 (x86_64)<br /><a class="external" href="https://www.archlinux.org/packages/comm">https://www.archlinux.org/packages/comm</a> … imp-ufraw/</p>


	<p>install:</p>


	<p><code>$ sudo pacman -S gimp-ufraw</code></p>


	<p>run:</p>


	<p><code>ufraw /path/to/file.dng</code></p>


	<p>Error message:</p>


	<p><code>ufraw: tiffcomposite.cpp:749: virtual Exiv2::Internal::TiffComponent* Exiv2::Internal::TiffMnEntry::doAddPath(uint16_t, Exiv2::Internal::TiffPath&#38;, Exiv2::Internal::TiffComponent*, Exiv2::Internal::TiffComponent::AutoPtr): Assertion `mn_' failed.<br />Aborted (core dumped)</code></p>


	<p>More info:<br /><code><br />$ uname -a<br />Linux myserver 4.6.4-1-ARCH #1 SMP PREEMPT Mon Jul 11 19:12:32 CEST 2016 x86_64 GNU/Linux</code><br /><code><br />$ exiv2 --version<br />exiv2 0.25 001900 (64 bit build)</code></p>


	<p><code>$ ufraw --version<br />ufraw 0.22<br />EXIV2 enabled.<br />JPEG enabled.<br />JPEG2000 (libjasper) enabled.<br />TIFF enabled.<br />PNG enabled.<br />FITS enabled.<br />ZIP enabled.<br />BZIP2 enabled.<br />LENSFUN enabled.</code></p>


	<p>I got here via these links:</p>


	<p>Bug #1584853 “Shotwell crashes on startup / Crash in exiv2 due t...” : Bugs : exiv2 package : Ubuntu<br /><a class="external" href="https://bugs.launchpad.net/ubuntu/+sour">https://bugs.launchpad.net/ubuntu/+sour</a> … ug/1584853</p>


	<p>Bug 765963 – assert in exiv2 when writing metadata<br /><a class="external" href="https://bugzilla.gnome.org/show_bug.cgi?id=765963">https://bugzilla.gnome.org/show_bug.cgi?id=765963</a></p>


	<p>Bug <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash in exiv2 due to assertion when setting rating on jpg with a Casio makernote (Closed)" href="/issues/1106">#1106</a>: Crash in exiv2 due to assertion when setting rating on jpg with a Casio makernote - Exiv2<br /><a class="external" href="http://dev.exiv2.org/issues/1106">http://dev.exiv2.org/issues/1106</a></p>


	<p>Here's my original post on the issue:</p>


	<p>ufraw error / core dumped in component exiv2 / Applications &#38; Desktop Environments / Arch Linux Forums<br /><a class="external" href="https://bbs.archlinux.org/viewtopic.php?pid=1644551#p1644551">https://bbs.archlinux.org/viewtopic.php?pid=1644551#p1644551</a></p></div>
    </div>
  </div>
  
  <div id="change-5227" class="journal has-notes">
    <div id="note-16">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-16" class="journal-link">#16</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="05 Aug 2016 20:42" href="/projects/exiv2/activity?from=2016-08-05">over 5 years</a> ago
      <span id="journal-5227-private_notes" class=""></span>
    </h4>

    <div id="journal-5227-notes" class="wiki"><p>I think this matter is OK on our trunk.  You are installing v0.25 which has this issue.  We are almost complete on Exiv2 v0.26 and I believe when that ships and is in use by ufraw this issue will disappear.</p></div>
    </div>
  </div>
  
  <div id="change-6026" class="journal has-notes">
    <div id="note-17">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-17" class="journal-link">#17</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/6158">Raymond Gauthier</a> <a title="14 Jul 2017 20:08" href="/projects/exiv2/activity?from=2017-07-14">over 4 years</a> ago
      <span id="journal-6026-private_notes" class=""></span>
    </h4>

    <div id="journal-6026-notes" class="wiki"><p>The matter is still not OK with 0.26. I just tried with digikam + exiv2 0.26 on nixos and it still crashes on the same assertion as soon as I rotate an image.</p>


	<p>I was able to fix it on 0.25 by applying the patch 4499 at rev from &lt;svn://dev.exiv2.org/svn/trunk&gt;. Is it possible this revision was not or improperly merged to the trunk?</p></div>
    </div>
  </div>
  
  <div id="change-6027" class="journal has-notes">
    <div id="note-18">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-18" class="journal-link">#18</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/6158">Raymond Gauthier</a> <a title="14 Jul 2017 20:11" href="/projects/exiv2/activity?from=2017-07-14">over 4 years</a> ago
      <span id="journal-6027-private_notes" class=""></span>
    </h4>

    <div id="journal-6027-notes" class="wiki"><p>I used &lt;<a class="external" href="http://www.exiv2.org/builds/exiv2-0.26-trunk.tar.gz">http://www.exiv2.org/builds/exiv2-0.26-trunk.tar.gz</a>&gt; downloaded yesterday.</p></div>
    </div>
  </div>
  
  <div id="change-6028" class="journal has-notes">
    <div id="note-19">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-19" class="journal-link">#19</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/6158">Raymond Gauthier</a> <a title="14 Jul 2017 20:18" href="/projects/exiv2/activity?from=2017-07-14">over 4 years</a> ago
      <span id="journal-6028-private_notes" class=""></span>
    </h4>

    <div id="journal-6028-notes" class="wiki"><p>Raymond Gauthier wrote:</p>


<blockquote>

	<p>The matter is still not OK with 0.26. I just tried with digikam + exiv2 0.26 on nixos and it still crashes on the same assertion as soon as I rotate an image.</p>


	<p>I was able to fix it on 0.25 by updated to rev 4499 from &lt;svn://dev.exiv2.org/svn/trunk&gt;. Is it possible this revision was not or improperly merged to the trunk?</p>


</blockquote></div>
    </div>
  </div>
  
  <div id="change-6032" class="journal has-notes has-details">
    <div id="note-20">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-20" class="journal-link">#20</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Jul 2017 06:29" href="/projects/exiv2/activity?from=2017-07-15">over 4 years</a> ago
      <span id="journal-6032-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Closed</i> to <i>Assigned</i></li>
       <li><strong>Assignee</strong> changed from <i>Andreas Huggel</i> to <i>Robin Mills</i></li>
       <li><strong>Target version</strong> changed from <i>0.26</i> to <i>0.27</i></li>
    </ul>
    <div id="journal-6032-notes" class="wiki"><p>Groan.  I'll look at this over the weekend.</p>


	<p>Can you reproduce this using the exiv2(.exe) command-line program, or is this only reproducible from DigiKam?  I'm a little lost here.  I can't find the file CIMG2288.JPG and puzzled by your reference to --revision 4499.</p>


	<p>Help me to help you and the DigiKam community.</p></div>
    </div>
  </div>
  
  <div id="change-6033" class="journal has-notes has-details">
    <div id="note-21">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-21" class="journal-link">#21</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Jul 2017 06:35" href="/projects/exiv2/activity?from=2017-07-15">over 4 years</a> ago
      <span id="journal-6033-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>100</i> to <i>90</i></li>
    </ul>
    <div id="journal-6033-notes" class="wiki"><p>I've found the file (it was hiding in front of my nose).  What is "Rating"?  I can update <em>XMP.xmp.Rating</em> and <em>Exif.Image.Rating</em>:<pre>592 rmills@rmillsmbp:~ $ exiv2 -pa ~/Downloads/CIMG2288.JPG | grep -i rating
Exif.Photo.ISOSpeedRatings                   Short       1  64
593 rmills@rmillsmbp:~ $ exiv2 -M"set Xmp.xmp.Rating Great" ~/Downloads/CIMG2288.JPG 
594 rmills@rmillsmbp:~ $ exiv2 -pa ~/Downloads/CIMG2288.JPG | grep -i rating
Exif.Photo.ISOSpeedRatings                   Short       1  64
Xmp.xmp.Rating                               XmpText     5  Great
595 rmills@rmillsmbp:~ $ exiv2 -M"set Exif.Image.Rating 3" ~/Downloads/CIMG2288.JPG 
596 rmills@rmillsmbp:~ $ exiv2 -pa ~/Downloads/CIMG2288.JPG | grep -i rating
Exif.Image.Rating                            Short       1  3
Exif.Photo.ISOSpeedRatings                   Short       1  64
Xmp.xmp.Rating                               XmpText     5  Great
597 rmills@rmillsmbp:~ $ </pre></p></div>
    </div>
  </div>
  
  <div id="change-6034" class="journal has-notes">
    <div id="note-22">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-22" class="journal-link">#22</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="15 Jul 2017 07:00" href="/projects/exiv2/activity?from=2017-07-15">over 4 years</a> ago
      <span id="journal-6034-private_notes" class=""></span>
    </h4>

    <div id="journal-6034-notes" class="wiki"><p>rating in digiKam (and all photo management programs) is a start rate system to identify the image quality (from user viewpoint)</p>


	<p>It's stored at many place in metadata, for interroperability purpose.</p>


	<p>See the setup dialog from  digiKam to read and save rate values from tags (Exif, Iptc, or Xmp) :</p>


	<p><a class="external" href="https://www.flickr.com/photos/digikam/35092293434/in/dateposted-public/">https://www.flickr.com/photos/digikam/35092293434/in/dateposted-public/</a></p></div>
    </div>
  </div>
  
  <div id="change-6035" class="journal has-notes">
    <div id="note-23">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-23" class="journal-link">#23</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="15 Jul 2017 07:13" href="/projects/exiv2/activity?from=2017-07-15">over 4 years</a> ago
      <span id="journal-6035-private_notes" class=""></span>
    </h4>

    <div id="journal-6035-notes" class="wiki"><p>Start => star of course...</p></div>
    </div>
  </div>
  
  <div id="change-6036" class="journal has-notes">
    <div id="note-24">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-24" class="journal-link">#24</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="15 Jul 2017 07:16" href="/projects/exiv2/activity?from=2017-07-15">over 4 years</a> ago
      <span id="journal-6036-private_notes" class=""></span>
    </h4>

    <div id="journal-6036-notes" class="wiki"><p><a class="external" href="https://docs.kde.org/trunk5/en/extragear-graphics/digikam/using-digikam.html#using-mainwindow-labelsview">https://docs.kde.org/trunk5/en/extragear-graphics/digikam/using-digikam.html#using-mainwindow-labelsview</a></p></div>
    </div>
  </div>
  
  <div id="change-6037" class="journal has-notes">
    <div id="note-25">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-25" class="journal-link">#25</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Jul 2017 07:37" href="/projects/exiv2/activity?from=2017-07-15">over 4 years</a> ago
      <span id="journal-6037-private_notes" class=""></span>
    </h4>

    <div id="journal-6037-notes" class="wiki"><p>Thanks for the clarification.  Yes, I've seen that in DigiKam.  And you use that to update many tags in the metadata.  However which tag is causing the crash?  Issues should be reproducible using the Exiv2 command line.</p>


	<p>There's nothing else in the Casio Makernote that makes me thing "Rating".<pre>599 rmills@rmillsmbp:~ $ exiv2 -pa --grep Casio ~/Downloads/CIMG2288.JPG 
Exif.Casio2.PreviewImageSize                 Short       2  320 240
Exif.Casio2.PreviewImageLength               Long        1  19480
Exif.Casio2.PreviewImageStart                Long        1  5078
Exif.Casio2.PreviewImage                     Undefined 19480  (Binary value suppressed)
Exif.Casio2.FirmwareDate                     Ascii      18  2008:02:14 16:32
Exif.Casio2.WhiteBalanceBias                 Short       2  584 406
Exif.Casio2.WhiteBalance2                    Short       1  (8)
Exif.Casio2.AFPointPosition                  Short       4  160 320 120 240
Exif.Casio2.ObjectDistance                   Long        1  Inf
Exif.Casio2.FlashDistance                    Short       1  0
Exif.Casio2.SpecialEffectMode                Byte        3  4 4 4
Exif.Casio2.RecordMode                       Short       1  2
Exif.Casio2.ReleaseMode                      Short       1  Normal
Exif.Casio2.Quality                          Short       1  Fine
Exif.Casio2.FocusMode2                       Short       1  Single-Area Auto Focus
Exif.Casio2.HometownCity                     Ascii      24  Rome
Exif.Casio2.BestShotMode                     Short       1  1
Exif.Casio2.AutoISO                          Short       1  On (anti-shake)
Exif.Casio2.AFMode                           Short       1  Spot
Exif.Casio2.Sharpness2                       Undefined   2  0 0
Exif.Casio2.Contrast2                        Undefined   2  0 0
Exif.Casio2.Saturation2                      Undefined   2  0 0
Exif.Casio2.ISO                              Short       1  64
Exif.Casio2.ColorMode                        Short       1  Off
Exif.Casio2.Enhancement                      Short       1  Off
Exif.Casio2.ColorFilter                      Short       1  Off
Exif.Casio2.ArtMode                          Short       1  Normal
Exif.Casio2.SequenceNumber                   Short       1  0
Exif.Casio2.ImageStabilization               Short       2  2 0
Exif.Casio2.LightingMode                     Short       1  Off
Exif.Casio2.PortraitRefiner                  Short       1  Off
Exif.Casio2.DriveMode                        Short       1  Continuous Shooting
600 rmills@rmillsmbp:~ $ </pre>I've tried all the tags in the screen shot and they can be updated successfully:<pre>600 rmills@rmillsmbp:~ $ exiv2 -M'set Xmp.dc.description Saturday' ~/Downloads/CIMG2288.JPG
601 rmills@rmillsmbp:~ $ exiv2 -pa --grep    description           ~/Downloads/CIMG2288.JPG 
Xmp.dc.description                           LangAlt     1  lang="x-default" Saturday
602 rmills@rmillsmbp:~ $ exiv2 -M'set Xmp.exif.UserComment Saturday again' ~/Downloads/CIMG2288.JPG
603 rmills@rmillsmbp:~ $ exiv2 -pa --grep      User                        ~/Downloads/CIMG2288.JPG 
Xmp.exif.UserComment                         LangAlt     1  lang="x-default" Saturday again
604 rmills@rmillsmbp:~ $ exiv2 -M'set Xmp.tiff.ImageDescription Saturday once more' ~/Downloads/CIMG2288.JPG
605 rmills@rmillsmbp:~ $ exiv2 -pa --grep      ImageDescription                     ~/Downloads/CIMG2288.JPG 
Xmp.tiff.ImageDescription                    LangAlt     1  lang="x-default" Saturday once more
606 rmills@rmillsmbp:~ $ etc.............</pre>There could be a bug when Exiv2 encodes the Casio Maker Note.  However, I can rewrite 'HometownCity':<pre>606 rmills@rmillsmbp:~ $ exiv2 -M'set Exif.Casio2.HometownCity Eternal City' ~/Downloads/CIMG2288.JPG 
607 rmills@rmillsmbp:~ $ exiv2 -pa --grep         Hometown                   ~/Downloads/CIMG2288.JPG 
Exif.Casio2.HometownCity                     Ascii      13  Eternal City
608 rmills@rmillsmbp:~ $ </pre></p></div>
    </div>
  </div>
  
  <div id="change-6038" class="journal has-notes">
    <div id="note-26">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-26" class="journal-link">#26</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="15 Jul 2017 09:57" href="/projects/exiv2/activity?from=2017-07-15">over 4 years</a> ago
      <span id="journal-6038-private_notes" class=""></span>
    </h4>

    <div id="journal-6038-notes" class="wiki"><p>/home/luca/project/digikam/exiv2-0.25/src/tiffcomposite.cpp</p>


	<p>==> Exiv2 0.25, not 0.26.</p>


	<p>I recommend to not lost time with Exiv2 older than 2 year and to be focused to last stable release.</p>


	<p>Luca, Even if Exiv2 0.25 crash with your image with digiKam, you must recompile digiKAm with Exiv2 0.26.</p>


	<p>The current digiKam implementation from git/master for until now to use Exiv2 0.26 (for next digiKam 5.7.0).</p>


	<p>Please unintall Exiv2 0.25, recompile Exiv2 0.26, and recompile whole digiKam. Try again to play with your image and confirm or not that problem still reproducible or not.</p>


	<p>Gilles Caulier</p></div>
    </div>
  </div>
  
  <div id="change-6039" class="journal has-notes">
    <div id="note-27">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-27" class="journal-link">#27</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/76">Gilles Caulier</a> <a title="15 Jul 2017 10:01" href="/projects/exiv2/activity?from=2017-07-15">over 4 years</a> ago
      <span id="journal-6039-private_notes" class=""></span>
    </h4>

    <div id="journal-6039-notes" class="wiki"><p>Robin,</p>


	<p>Even if user set a rating value from digiKam , few other tags are updated, as the application name and version which make changes for ex. This can be the problem.</p>


	<p>The backtrace is not enough detailed to see which part is touched in the mix. We have a metadata hub which build a synthesis of changes depending of complex settings done by user, and send a separated thread to apply on images (users can changes more than one images at the same time from GUI).</p>


	<p>Luca, it miss here a console trace from digiKam. This one is verbose with debug statements to indicate which metadata will be touch by the metadata hub.</p></div>
    </div>
  </div>
  
  <div id="change-6042" class="journal has-notes">
    <div id="note-28">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-28" class="journal-link">#28</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4270">Luca Carlon</a> <a title="15 Jul 2017 17:43" href="/projects/exiv2/activity?from=2017-07-15">over 4 years</a> ago
      <span id="journal-6042-private_notes" class=""></span>
    </h4>

    <div id="journal-6042-notes" class="wiki"><p>Gilles, are you referring to me? For me the problem was resolved 2 years ago.</p></div>
    </div>
  </div>
  
  <div id="change-6043" class="journal has-notes has-details">
    <div id="note-29">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-29" class="journal-link">#29</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Jul 2017 19:53" href="/projects/exiv2/activity?from=2017-07-15">over 4 years</a> ago
      <span id="journal-6043-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Estimated time</strong> changed from <i>10.00 h</i> to <i>12.00 h</i></li>
    </ul>
    <div id="journal-6043-notes" class="wiki"><p>This subject was reopened by Raymond Gauthier in #note-17 above:  <a class="external" href="http://dev.exiv2.org/issues/1106#note-17">http://dev.exiv2.org/issues/1106#note-17</a></p>


	<p>Raymond: I can only deal with issues that can be reproduced with the exiv2(.exe) command line program.  If you are using libexiv2 through DigiKam, I'm mostly blind to the metadata processing being done by DigiKam.  Can I ask you to discuss this with the DigiKam engineers and I will become involved when the issue is isolated and understood.</p></div>
    </div>
  </div>
  
  <div id="change-6044" class="journal has-details">
    <div id="note-30">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-30" class="journal-link">#30</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="16 Jul 2017 10:06" href="/projects/exiv2/activity?from=2017-07-16">over 4 years</a> ago
      <span id="journal-6044-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Target version</strong> changed from <i>0.27</i> to <i>0.26</i></li>
       <li><strong>% Done</strong> changed from <i>90</i> to <i>100</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-6045" class="journal has-details">
    <div id="note-31">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-31" class="journal-link">#31</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="16 Jul 2017 10:07" href="/projects/exiv2/activity?from=2017-07-16">over 4 years</a> ago
      <span id="journal-6045-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Closed</i></li>
    </ul>
    
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1106.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1106.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
