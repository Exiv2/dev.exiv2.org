<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #780: save thumbnail - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="k1Gjyr6pVrUNdE/kdMlDd2e+NRsNlMJ1ahm9nWIxivRxHAglzNOatVgQUOjLHk9EWCxhYvx3Y8+XOS0VIQhtmw==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #780: save thumbnail" href="https://dev.exiv2.org/issues/780.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #780</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>save thumbnail</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/2523">Florian Kleber</a> <a title="18 Jul 2011 06:45" href="/projects/exiv2/activity?from=2011-07-18">over 10 years</a> ago.
        Updated <a title="29 Apr 2016 23:07" href="/projects/exiv2/activity?from=2016-04-29">over 5 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">withdrawn</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="28 Apr 2017" href="/versions/52">0.26</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">18 Jul 2011</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">1.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>Hello,</p>


	<p>we've tried to use exiv2 for reading and writing thumbs (windows7, msvc compiler). although the reading of thumbnails works fine, we've problems if the thumbnails doesn't exist and we try to create a new one. writeMetaData throws an exception in tiffimage.cpp, line 1853 (io.transfer(*tempio). the complete code for the writing of the thumbs is listed below. it seems that the temporary file is locked. the exception is thrown in basicio.cpp, line 635 (called by transfer). The Error Code of "DeleteFile" is 32. it doesn't matter if the file is a tif file or another kind of image type.<br />we've tried the last official release as well as the trunk version. thank you for any help.</p>


	<p>kind regards,</p>


	<p>florian</p>


<pre>
    Exiv2::ExifData exifData = exifImg-&gt;exifData();

    if (exifData.empty()) {
        DkUtils::printDebug(DK_MODULE, "exif data is empty\n");
        exifData = Exiv2::ExifData();
    }

    // ok, let's try to save the thumbnail...
    try {

        Exiv2::ExifThumb eThumb(exifData);

        if (isTiff()) {
            eThumb.erase();

            Exiv2::ExifData::const_iterator pos = exifData.findKey(Exiv2::ExifKey("Exif.Image.NewSubfileType"));
            if (pos == exifData.end() || pos-&gt;count() != 1 || pos-&gt;toLong() != 0) {
                 throw DkException("Exif.Image.NewSubfileType missing or not set as main image", __LINE__, __FILE__);
             }
             std::string subImage1("SubImage1");
             for (Exiv2::ExifData::iterator md = exifData.begin(); md != exifData.end();)
             {
                 if (md-&gt;groupName() == subImage1)
                     md = exifData.erase(md);
                 else
                     ++md;
             }
        }

        QByteArray data;
        QBuffer buffer(&#38;data);
        buffer.open(QIODevice::WriteOnly);
        thumb.save(&#38;buffer, "JPEG");

        if (isTiff()) {
            Exiv2::DataBuf buf((Exiv2::byte *)data.data(), data.size());
            Exiv2::ULongValue val;
            val.read("0");
            val.setDataArea(buf.pData_, buf.size_);
            exifData["Exif.SubImage1.JPEGInterchangeFormat"] = val;
            exifData["Exif.SubImage1.JPEGInterchangeFormatLength"] = uint32_t(buf.size_);
            exifData["Exif.SubImage1.Compression"] = uint16_t(6); // JPEG (old-style)
            exifData["Exif.SubImage1.NewSubfileType"] = uint32_t(1); // Thumbnail image
            DkUtils::printDebug(DK_MODULE, "As you told me to, I am writing the tiff thumbs...\n");

        } else {
            eThumb.setJpegThumbnail((Exiv2::byte *)data.data(), data.size());
            DkUtils::printDebug(DK_MODULE, "As you told me to, I am writing the thumbs...\n");
        }

        exifImg-&gt;setExifData(exifData);
        exifImg-&gt;writeMetadata();
</pre>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/270">thumb.cpp</a>    <span class="size">(2.33 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/270/thumb.cpp">thumb.cpp</a>  </td>
  <td>Reproducer based on the code in the bug report</td>
  <td>
      <span class="author">Andreas Huggel, 27 Jul 2011 19:35</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>








</div>




<div id="history">
<h3>History</h3>
  <div id="change-1952" class="journal has-notes has-details">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="27 Jul 2011 19:35" href="/projects/exiv2/activity?from=2011-07-27">over 10 years</a> ago
      <span id="journal-1952-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/270">thumb.cpp</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/270/thumb.cpp">thumb.cpp</a> added</li>
    </ul>
    <div id="journal-1952-notes" class="wiki"><p>Florian, I tried to reproduce the issue on OSX but it works fine here. Can you try the attached program (a standalone version of your sample code) on your system?</p>


	<p>Andreas</p></div>
    </div>
  </div>
  
  <div id="change-1955" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/2523">Florian Kleber</a> <a title="01 Aug 2011 04:26" href="/projects/exiv2/activity?from=2011-08-01">over 10 years</a> ago
      <span id="journal-1955-private_notes" class=""></span>
    </h4>

    <div id="journal-1955-notes" class="wiki"><p>Andreas, we've tried your sample code. it works fine, until the file is locked (Write) somewhere else, <br />e.g. <br /><pre>
QFile* fu = new QFile(QString("H:\\img0001.tif"));
fu-&gt;open(QIODevice::ReadWrite);
</pre></p>


	<p>in this case, the output of your sample code is:<br /><em>As you told me to, I am writing the TIFF thumbs...<br />Caught Exiv2 exception 'H:\img0001.tif: Call to `::remove' failed: Permission denied (errno = 13)'</em></p>


	<p>which results in an empty file: img0001.tif and a (correct) backup file <em>img0001.tif676</em><br />we've missinterpreted the error the last time, when we've wrote the ticket. however we suggest to check if the file is locked in advance, in order to avoid destroyed files... would it be possible? thank you for your help.</p>


	<p>florian</p></div>
    </div>
  </div>
  
  <div id="change-1959" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="03 Aug 2011 17:39" href="/projects/exiv2/activity?from=2011-08-03">over 10 years</a> ago
      <span id="journal-1959-private_notes" class=""></span>
    </h4>

    <div id="journal-1959-notes" class="wiki"><p>There is already a test to make sure the file can be opened for writing (at the beginning of transfer()).<br />However that is not sufficient to ensure the file can be removed. On Windows this is apparently not the case if someone still has the file open for writing ("locked"). On Unix, the file can't be removed (but may be written to) if the process doesn't have write permissions for the directory that contains the file.</p>


	<p>Do you know how I can check if a file can be removed on Windows?</p>


	<p>Andreas</p></div>
    </div>
  </div>
  
  <div id="change-1960" class="journal has-notes">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/133">Robin Mills</a> <a title="03 Aug 2011 21:15" href="/projects/exiv2/activity?from=2011-08-03">over 10 years</a> ago
      <span id="journal-1960-private_notes" class=""></span>
    </h4>

    <div id="journal-1960-notes" class="wiki"><p>Andreas</p>


	<p>I think if you call LockFile (or LockFileEx) and obtain an exclusive lock on the file, you know you have ownership.<br /><a class="external" href="http://msdn.microsoft.com/en-us/library/aa365203(v=VS.85).aspx">http://msdn.microsoft.com/en-us/library/aa365203(v=VS.85).aspx</a></p>


	<p>DeleteFile will delete the file.<br /><a class="external" href="http://msdn.microsoft.com/en-us/library/aa363915(v=vs.85).aspx">http://msdn.microsoft.com/en-us/library/aa363915(v=vs.85).aspx</a></p>


	<p>If the file has the 'r' attribute set to read-protect the file, I think you'll have to unset that.  GetFileAttributes(), SetFileAttributes()</p>


	<p>Robin</p></div>
    </div>
  </div>
  
  <div id="change-1990" class="journal has-notes">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/2523">Florian Kleber</a> <a title="02 Sep 2011 04:24" href="/projects/exiv2/activity?from=2011-09-02">about 10 years</a> ago
      <span id="journal-1990-private_notes" class=""></span>
    </h4>

    <div id="journal-1990-notes" class="wiki"><p>Andreas, i am not sure if it is possible on windows. you could try to write to the file and throw an exception if it is locked. this will allow to leave the file unchanged to avoid a damaged file.</p>


	<p>florian</p></div>
    </div>
  </div>
  
  <div id="change-4095" class="journal has-details">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="23 Aug 2015 16:19" href="/projects/exiv2/activity?from=2015-08-23">about 6 years</a> ago
      <span id="journal-4095-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Target version</strong> set to <i>53</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-4867" class="journal has-notes has-details">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="28 Mar 2016 15:03" href="/projects/exiv2/activity?from=2016-03-28">over 5 years</a> ago
      <span id="journal-4867-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
    </ul>
    <div id="journal-4867-notes" class="wiki"><p>This issue has been in the database for 4 years and nobody else has requested progress with this matter.  So, unless you engage to persuade me to keep this matter alive, it will be closed on April 30 as “no longer needed/wanted.</p>


	<p>There have been similar issues on Windows tracked down to the virus checker.   <a class="external" href="http://dev.exiv2.org/boards/3/topics/1816">http://dev.exiv2.org/boards/3/topics/1816</a></p></div>
    </div>
  </div>
  
  <div id="change-4994" class="journal has-details">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="29 Apr 2016 22:39" href="/projects/exiv2/activity?from=2016-04-29">over 5 years</a> ago
      <span id="journal-4994-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> changed from <i>basicio</i> to <i>withdrawn</i></li>
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Closed</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>100</i></li>
       <li><strong>Estimated time</strong> set to <i>1.00 h</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-5024" class="journal has-details">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="29 Apr 2016 23:07" href="/projects/exiv2/activity?from=2016-04-29">over 5 years</a> ago
      <span id="journal-5024-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Target version</strong> changed from <i>53</i> to <i>0.26</i></li>
    </ul>
    
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/780.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/780.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
