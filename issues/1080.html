<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #1080: Division by zero / crash on malformed input file - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="AXgti13SORrdabTfpanZx4RuUTZwZWaerwUkbuj+bSPjNYZkL6j1GogNq9MaftX0u/wFT4GGxyRSJbTmq8eKTA==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #1080: Division by zero / crash on malformed input file" href="https://dev.exiv2.org/issues/1080.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #1080</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Division by zero / crash on malformed input file</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/4430">Hanno Böck</a> <a title="13 May 2015 17:03" href="/projects/exiv2/activity?from=2015-05-13">over 6 years</a> ago.
        Updated <a title="19 Oct 2016 19:07" href="/projects/exiv2/activity?from=2016-10-19">about 5 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">metadata</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="28 Apr 2017" href="/versions/52">0.26</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">13 May 2015</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">6.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>The attached file will cause a crash / integer division by zero in exiv2.</p>


	<p>Backtrace:<br />#0  0x00007ffff7a6886f in Exiv2::Internal::print0x9204 (os=..., value=...) at tags.cpp:2551<br />#1  0x0000000000417b62 in Action::Print::printTag (this=this@entry=0x62e560, exifData=..., <br />    key="Exif.Photo.ExposureBiasValue", label="Exposure bias") at actions.cpp:458<br />#2  0x0000000000418494 in Action::Print::printSummary (this=this@entry=0x62e560)<br />    at actions.cpp:325<br />#3  0x000000000041a70c in Action::Print::run (this=0x62e560, path="exiv2-divzero.jpg")<br />    at actions.cpp:236<br />#4  0x000000000040590e in main (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;) at exiv2.cpp:171</p>


	<p>This was found while fuzzing exiv2 with american fuzzy lop.</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/786">exiv2-divzero.jpg</a>    <span class="size">(4.3 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/786/exiv2-divzero.jpg">exiv2-divzero.jpg</a>  </td>
  <td></td>
  <td>
      <span class="author">Hanno Böck, 13 May 2015 17:03</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/799">0001-fix_value_excess_of_max_int32t.patch</a>    <span class="size">(773 Bytes)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/799/0001-fix_value_excess_of_max_int32t.patch">0001-fix_value_excess_of_max_int32t.patch</a>  </td>
  <td>patch</td>
  <td>
      <span class="author">Felix Bolte, 08 Jun 2015 16:41</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/849">Blank.JPG</a>    <span class="size">(693 Bytes)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/849/Blank.JPG">Blank.JPG</a>  </td>
  <td>https://upload.wikimedia.org/wikipedia/en/4/48/Blank.JPG</td>
  <td>
      <span class="author">Felix Bolte, 12 Oct 2015 18:57</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/850">img_4381.jpg</a>    <span class="size">(4.89 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/850/img_4381.jpg">img_4381.jpg</a>  </td>
  <td></td>
  <td>
      <span class="author">Robin Mills, 13 Oct 2015 16:12</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/851">img_4381_small.jpg</a>    <span class="size">(252 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/851/img_4381_small.jpg">img_4381_small.jpg</a>  </td>
  <td></td>
  <td>
      <span class="author">Robin Mills, 13 Oct 2015 16:22</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>







<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/1080" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="D2re8TSG54jk0FxG3vJ6T0Q07BAIUeYXXAH2mCzT9QPtJ3UeRvwriLG0Q0phJXZ8e6a4afmyR62hIWYQb+oSbA==" />
  <table class="list issues odd-even"><tr id="relation-184" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1129" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/1129">Bug #1129</a>: Different behaviour of exiv2 between remote and local file.</td><td class="status">Closed</td><td class="start_date">12 Oct 2015</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/1080/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=1080&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 4645" href="/projects/exiv2/repository/exiv2/revisions/4645">Revision 4645</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4645/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="19 Oct 2016 19:06" href="/projects/exiv2/activity?from=2016-10-19">about 5 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Division by zero / crash on malformed input file (Closed)" href="/issues/1080">#1080</a> Fix submitted.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4646" href="/projects/exiv2/repository/exiv2/revisions/4646">Revision 4646</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4646/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="19 Oct 2016 19:18" href="/projects/exiv2/activity?from=2016-10-19">about 5 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Division by zero / crash on malformed input file (Closed)" href="/issues/1080">#1080</a> Added the file BLANK.JPG to test suite as exiv2-bug1080.jpg</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-3796" class="journal has-notes has-details">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4443">Felix Bolte</a> <a title="08 Jun 2015 16:41" href="/projects/exiv2/activity?from=2015-06-08">over 6 years</a> ago
      <span id="journal-3796-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/799">0001-fix_value_excess_of_max_int32t.patch</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/799/0001-fix_value_excess_of_max_int32t.patch">0001-fix_value_excess_of_max_int32t.patch</a> added</li>
    </ul>
    <div id="journal-3796-notes" class="wiki"><p>hey, just because i stumpled over the same issue by using afl fuzzing, it is not the "/d" (division by zero) problem, it is the "std::abs(bias.first)" which fails, you can reproduce it on any image:<br /><pre>
felix@between:~/afl-1.79b/trunk/build$ ./bin/exiv2 -p a /tmp/test.jpg 
Exif.Image.Flash                             Short       1  (256)
felix@between:~/afl-1.79b/trunk/build$ ./bin/exiv2 -M"set Exif.Photo.ExposureBiasValue SRational -2147483647/1" /tmp/test.jpg
felix@between:~/afl-1.79b/trunk/build$ ./bin/exiv2 -p a /tmp/test.jpg 
Exif.Image.ExifTag                           Long        1  38
Exif.Photo.ExposureBiasValue                 SRational   1  -2147483647 EV
Exif.Image.Flash                             Short       1  (256)
felix@between:~/afl-1.79b/trunk/build$ ./bin/exiv2 -M"set Exif.Photo.ExposureBiasValue SRational -2147483648/1" /tmp/test.jpg
felix@between:~/afl-1.79b/trunk/build$ ./bin/exiv2 -p a /tmp/test.jpg 
Exif.Image.ExifTag                           Long        1  38
Exif.Photo.ExposureBiasValue                 SRational   1  --2147483648 EV
Exif.Image.Flash                             Short       1  (256)
felix@between:~/afl-1.79b/trunk/build$ ./bin/exiv2 -M"set Exif.Photo.ExposureBiasValue SRational -2147483648/13" /tmp/test.jpg
felix@between:~/afl-1.79b/trunk/build$ ./bin/exiv2 -p a /tmp/test.jpg 
Exif.Image.ExifTag                           Long        1  38
Floating point exception (core dumped)
</pre></p>


	<p>so problem is, that INT_MAX is 2147483647 but abs(-2147483648) is executed, i propose the attached patch to the current trunk, which also fixes the double minus in the output if EV is negative!</p></div>
    </div>
  </div>
  
  <div id="change-3797" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4443">Felix Bolte</a> <a title="09 Jun 2015 12:29" href="/projects/exiv2/activity?from=2015-06-09">over 6 years</a> ago
      <span id="journal-3797-private_notes" class=""></span>
    </h4>

    <div id="journal-3797-notes" class="wiki"><p>i have to admit, that the above patch only works partly, if you compile with optimization (>= -O2), we still get a floating point exception on the bias values "-2147483648/12415" ... after some debugging, i found out, that gcd returns a correct "-1", but this number is somehow broken and not what we see, because abs(gcd)) still returns a -1, which is clearly wrong ... anyhow, values of "-2147483647/12415" do work, so it is still a max int problem somewhere ... after looking in the gcd template i see it is doing an own abs on the input, which might corrupt the outcome!?<br /><pre>
    template &lt;typename IntType&gt;
    IntType gcd(IntType n, IntType m)
    {
        // Avoid repeated construction
        IntType zero(0);

        // This is abs() - given the existence of broken compilers with Koenig
        // lookup issues and other problems, I code this explicitly. (Remember,
        // IntType may be a user-defined type).
[...]
        if (n &lt; zero)
            n = -n;
        if (m &lt; zero)
            m = -m;
[...]

        // As n and m are now positive, we can be sure that %= returns a
        // positive value (the standard guarantees this for built-in types,
        // and we require it of user-defined types).
</pre></p>


	<p>if i comment out the abs lines, the program works again even with gcc compiler optimization! ... reading the comments in the code makes clear why we need the abs inside the gcd function, but as you can see, this leads to another problem ...</p>


	<p>so sorry, i guess i am stuck here and a more experienced exiv2 programmer has to look at this problem and fix the gcd construct :)</p></div>
    </div>
  </div>
  
  <div id="change-4005" class="journal has-details">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="21 Aug 2015 18:04" href="/projects/exiv2/activity?from=2015-08-21">about 6 years</a> ago
      <span id="journal-4005-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> set to <i>metadata</i></li>
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Target version</strong> set to <i>0.26</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-4279" class="journal has-details">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Sep 2015 11:09" href="/projects/exiv2/activity?from=2015-09-24">about 6 years</a> ago
      <span id="journal-4279-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Estimated time</strong> set to <i>3.00 h</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-4357" class="journal has-notes has-details">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="10 Oct 2015 07:22" href="/projects/exiv2/activity?from=2015-10-10">about 6 years</a> ago
      <span id="journal-4357-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>0</i> to <i>30</i></li>
    </ul>
    <div id="journal-4357-notes" class="wiki"><p>Felix</p>


	<p>I'm unable to reproduce your report.  The test file seems to be invalid.  <pre>650 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pS http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg
STRUCTURE OF JPEG FILE: http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xe1 APP1  |    4400 | Exif..MM.*.....00000000000000000
    4404 | 0xffffffff a?Z?Exiv2 exception in print action for file http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg:
This does not look like a JPEG image
651 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>If I attempt to run:<pre>659 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pa http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg
Exiv2 exception in print action for file http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg:
Failed to read image data
660 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>This is correct.  image->readMetatdata() throws.  So I never get near the gcd code.</p>


	<p>Do you have your test file /tmp/test.jpg that breaks gcd()</p></div>
    </div>
  </div>
  
  <div id="change-4381" class="journal has-notes">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4443">Felix Bolte</a> <a title="12 Oct 2015 16:48" href="/projects/exiv2/activity?from=2015-10-12">about 6 years</a> ago
      <span id="journal-4381-private_notes" class=""></span>
    </h4>

    <div id="journal-4381-notes" class="wiki"><p>hi robin,</p>


	<p>by coincidence you maybe found a small bug/feature, because when i download the attached image to the filesystem first, ill see the ticket error ... when using "-pa" on the URL i see this via strace:</p>


<pre>
recvfrom(3, 0x721f420d0320, 32768, 0, 0, 0) = -1 EAGAIN (Resource temporarily unavailable)
nanosleep({0, 0}, 0x721f420d0260)       = 0
recvfrom(3, "HTTP/1.1 200 OK\r\nDate: Mon, 12 O"..., 32768, 0, NULL, NULL) = 4877
recvfrom(3, 0x721f420d0320, 32768, 0, 0, 0) = -1 EAGAIN (Resource temporarily unavailable)
nanosleep({0, 0}, 0x721f420d0260)       = 0
recvfrom(3, "", 32768, 0, NULL, NULL)   = 0
close(-1)                               = -1 EBADF (Bad file descriptor)
close(3)                                = 0
write(2, "Exiv2 exception in print action "..., 41Exiv2 exception in print action for file ) = 41
write(2, "http://dev.exiv2.org/attachments"..., 63http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg) = 63
write(2, ":\n", 2:
)                      = 2
write(2, "Failed to read image data", 25Failed to read image data) = 25
write(2, "\n", 1
)                       = 1
exit_group(1)                           = ?
+++ exited with 1 +++
</pre></div>
    </div>
  </div>
  
  <div id="change-4382" class="journal has-notes">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="12 Oct 2015 18:01" href="/projects/exiv2/activity?from=2015-10-12">about 6 years</a> ago
      <span id="journal-4382-private_notes" class=""></span>
    </h4>

    <div id="journal-4382-notes" class="wiki"><p>Interesting find, Felix and you are partly correct.  <pre>rmills@rmillsmbp:~/gnu/exiv2/trunk $ curl -O http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  4404    0  4404    0     0  62061      0 --:--:-- --:--:-- --:--:-- 64764
rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>Option -pS reports the same using local and remote I/O.</p>


	<p>FileIo:<pre>rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pS ./exiv2-divzero.jpg 
STRUCTURE OF JPEG FILE: ./exiv2-divzero.jpg
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xe1 APP1  |    4400 | Exif..MM.*.....00000000000000000
    4404 | 0xffffffff ?? Exiv2 exception in print action for file ./exiv2-divzero.jpg:
This does not look like a JPEG image
rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>HttpIo:<pre>rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pS http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg
STRUCTURE OF JPEG FILE: http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xe1 APP1  |    4400 | Exif..MM.*.....00000000000000000
    4404 | 0xffffffff ?+ Exiv2 exception in print action for file http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg:
This does not look like a JPEG image
</pre>However option -pa behaves differently and, as you have reported, does ultimately throw a floating point exception when the file is local.  However it fails gracefully with httpio.</p>


	<p>FileIo:<pre>rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pa exiv2-divzero.jpg 
Error: Directory Image: Next pointer is out of bounds; ignored.
Warning: Directory Image, entry 0x3030 has unknown Exif (TIFF) type 12336; setting type size 1.
Error: Directory Image, entry 0x3030 has invalid size 808464432*1; skipping entry.
Warning: Directory Image, entry 0x3030 has unknown Exif (TIFF) type 12336; setting type size 1.
... deleted about 100 more reports of this ...
Warning: JPEG format error, rc = 5
Exif.Image.ExifTag                           Long        1  217
Floating point exception: 8
rmills@rmillsmbp:~/gnu/exiv2/trunk $</pre>HttpIo:<pre>rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pa http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg
Exiv2 exception in print action for file http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg:
Failed to read image data
rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>This is a step forward.  It looks to me as though the local file version has ignored the message:<pre>Warning: JPEG format error, rc = 5</pre>This is surprising as our I/O code presents a BasicIo interface and hides the source from the client who in this case is jpgimage.cpp.</p>


	<p>I'll step the code in the debugger to see what's going on here.  I feel the resolution of this will be in FileIo and not gcd().</p>


	<p>Incidentally, we have two implementations of class HttpIo.  We use libcurl with you ./configure --enable-webready.  We have a "no thrills" default http implementation to ensure that http is supported on all builds of exiv2 v0.25 and later.  I've built both ways and HttpIo is consistent in saying "Failed to read image data".</p></div>
    </div>
  </div>
  
  <div id="change-4383" class="journal has-notes has-details">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4443">Felix Bolte</a> <a title="12 Oct 2015 18:57" href="/projects/exiv2/activity?from=2015-10-12">about 6 years</a> ago
      <span id="journal-4383-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/849">Blank.JPG</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/849/Blank.JPG">Blank.JPG</a> added</li>
    </ul>
    <div id="journal-4383-notes" class="wiki"><blockquote>

	<p>This is a step forward. It looks to me as though the local file version has ignored the message:</p>


<pre>
Warning: JPEG format error, rc = 5
</pre>

</blockquote>

	<p>just to clarify, you can easily take any image and add the "bad" exif data yourself (see new attachment), without any further error:<br /><pre>
felix@toaster:~/old_afl-1.80b/exiv2-trunk/build$ ./bin/exiv2 -pS /tmp/Blank.JPG 
STRUCTURE OF JPEG FILE: /tmp/Blank.JPG
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xe0 APP0  |      16 | JFIF.....`.`.....C..............
      22 | 0xdb DQT   |      67 
      91 | 0xdb DQT   |      67 
     160 | 0xc0 SOF0  |      17 
     179 | 0xc4 DHT   |      31 
     212 | 0xc4 DHT   |     181 
     395 | 0xc4 DHT   |      31 
     428 | 0xc4 DHT   |     181 
     611 | 0xda SOS   |      12 
felix@toaster:~/old_afl-1.80b/exiv2-trunk/build$ ./bin/exiv2 -pa /tmp/Blank.JPG 
felix@toaster:~/old_afl-1.80b/exiv2-trunk/build$ ./bin/exiv2 -M"set Exif.Photo.ExposureBiasValue SRational -2147483648/13" /tmp/Blank.JPG
felix@toaster:~/old_afl-1.80b/exiv2-trunk/build$ ./bin/exiv2 -pS /tmp/Blank.JPG 
STRUCTURE OF JPEG FILE: /tmp/Blank.JPG
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xe0 APP0  |      16 | JFIF.....`.`.....&lt;Exif..II*....
      22 | 0xe1 APP1  |      60 | Exif..II*.......i..............
      84 | 0xdb DQT   |      67 
     153 | 0xdb DQT   |      67 
     222 | 0xc0 SOF0  |      17 
     241 | 0xc4 DHT   |      31 
     274 | 0xc4 DHT   |     181 
     457 | 0xc4 DHT   |      31 
     490 | 0xc4 DHT   |     181 
     673 | 0xda SOS   |      12 
felix@toaster:~/old_afl-1.80b/exiv2-trunk/build$ ./bin/exiv2 -pa /tmp/Blank.JPG 
Exif.Image.ExifTag                           Long        1  26
Floating point exception
</pre></p></div>
    </div>
  </div>
  
  <div id="change-4384" class="journal has-notes has-details">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="12 Oct 2015 20:07" href="/projects/exiv2/activity?from=2015-10-12">about 6 years</a> ago
      <span id="journal-4384-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Assignee</strong> changed from <i>Robin Mills</i> to <i>Andreas Huggel</i></li>
       <li><strong>% Done</strong> changed from <i>30</i> to <i>50</i></li>
       <li><strong>Estimated time</strong> changed from <i>3.00 h</i> to <i>5.00 h</i></li>
    </ul>
    <div id="journal-4384-notes" class="wiki"><p>Thanks.  Your file Blank.JPG reproduces this fault.</p>


	<p>I believe ExposureBiasValue is normally a small number to over/under expose the image. 1.0 = Normal<pre>rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pa -g Bias ~/Pictures/2015/Roof/DSC_7443.jpg
Exif.Photo.ExposureBiasValue                 SRational   1  0 EV
Exif.Nikon3.WhiteBalanceBias                 SShort      2  0 0
rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>In this case you've set to an astronomical negative number.  Exiv2 is not a metadata policeman.  We give you the tools and you can set fields to any value even if they don't make sense.</p>


	<p>None the less, exiv2 should not crash.  One simple fix is:<pre>    std::ostream&#38; print0x9204(std::ostream&#38; os, const Value&#38; value, const ExifData*)
    {
        Rational bias = value.toRational();
        if (bias.first == 0) {
            os &lt;&lt; "0 EV";
        } else {
            double  d = (double)bias.first / (double)bias.second ;
            os &lt;&lt; "(" &lt;&lt; bias.first &lt;&lt; "/" &lt;&lt; bias.second &lt;&lt; ") = " &lt;&lt; d &lt;&lt; " EV";
        }
        return os;
    }</pre>And results in the output:<pre>rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pa http://dev.exiv2.org/attachments/download/849/Blank.JPG
Exif.Image.ExifTag                           Long        1  26
Exif.Photo.ExposureBiasValue                 SRational   1  (-2147483648/13) = -1.65191e+08 EV</pre>I didn't write this code.  Without knowing why the code jumps through those hoops, I'm reluctant to change it.  Running the code through svn blame reveals that Andreas added this a long time ago.  I'm going to assign this to him for comment:<pre>rmills@rmillsmbp:~/gnu/exiv2/trunk $ svn blame src/tags.cpp | nl -ba | head -2592 | tail -22
  2571      1512    ahuggel     std::ostream&#38; print0x9204(std::ostream&#38; os, const Value&#38; value, const ExifData*)
  2572       169    ahuggel     {
  2573       169    ahuggel         Rational bias = value.toRational();
  2574       181    ahuggel         if (bias.second &lt;= 0) {
  2575       181    ahuggel             os &lt;&lt; "(" &lt;&lt; bias.first &lt;&lt; "/" &lt;&lt; bias.second &lt;&lt; ")";
  2576       169    ahuggel         }
  2577       181    ahuggel         else if (bias.first == 0) {
  2578      1720    ahuggel             os &lt;&lt; "0 EV";
  2579       181    ahuggel         }
  2580       169    ahuggel         else {
  2581       616    ahuggel             int32_t d = gcd(bias.first, bias.second);
  2582       616    ahuggel             int32_t num = std::abs(bias.first) / d;
  2583       616    ahuggel             int32_t den = bias.second / d;
  2584       181    ahuggel             os &lt;&lt; (bias.first &lt; 0 ? "-" : "+") &lt;&lt; num;
  2585       181    ahuggel             if (den != 1) {
  2586       181    ahuggel                 os &lt;&lt; "/" &lt;&lt; den;
  2587       181    ahuggel             }
  2588      1720    ahuggel             os &lt;&lt; " EV";
  2589       169    ahuggel         }
  2590       169    ahuggel         return os;
  2591       169    ahuggel     }
  2592       169    ahuggel 
rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>I've opened a new issue <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Different behaviour of exiv2 between remote and local file. (Closed)" href="/issues/1129">#1129</a> to investigate the FileIo/HttpIo anomaly observed on exiv2-divzero.jpg</p></div>
    </div>
  </div>
  
  <div id="change-4388" class="journal has-notes has-details">
    <div id="note-10">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-10" class="journal-link">#10</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="13 Oct 2015 16:12" href="/projects/exiv2/activity?from=2015-10-13">about 6 years</a> ago
      <span id="journal-4388-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/850">img_4381.jpg</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/850/img_4381.jpg">img_4381.jpg</a> added</li>
    </ul>
    <div id="journal-4388-notes" class="wiki"><p>While I was clearing the leaves in the garden today, I started thinking about ExposureBiasValue.  So, I got the little Canon camera and took a series of photos using the the exposure +/- control.  Here's the metadata:<pre>722 rmills@rmillsmbp:~/Pictures/2015/October $ exiv2 -pa --grep ExposureBias img_43{75..87}.jpg
img_4375.jpg          Exif.Photo.ExposureBiasValue                 SRational   1  -2 EV
img_4376.jpg          Exif.Photo.ExposureBiasValue                 SRational   1  -5/3 EV
img_4377.jpg          Exif.Photo.ExposureBiasValue                 SRational   1  -4/3 EV
img_4378.jpg          Exif.Photo.ExposureBiasValue                 SRational   1  -1 EV
img_4379.jpg          Exif.Photo.ExposureBiasValue                 SRational   1  -2/3 EV
img_4380.jpg          Exif.Photo.ExposureBiasValue                 SRational   1  -1/3 EV
img_4381.jpg          Exif.Photo.ExposureBiasValue                 SRational   1  0 EV
img_4382.jpg          Exif.Photo.ExposureBiasValue                 SRational   1  +1/3 EV
img_4383.jpg          Exif.Photo.ExposureBiasValue                 SRational   1  +2/3 EV
img_4384.jpg          Exif.Photo.ExposureBiasValue                 SRational   1  +1 EV
img_4385.jpg          Exif.Photo.ExposureBiasValue                 SRational   1  +4/3 EV
img_4386.jpg          Exif.Photo.ExposureBiasValue                 SRational   1  +5/3 EV
img_4387.jpg          Exif.Photo.ExposureBiasValue                 SRational   1  +2 EV
723 rmills@rmillsmbp:~/Pictures/2015/October $ </pre>I believe the EV is the increase in F stops.  So EV = +1 indicates that the lens has been opened by one F stop.  So an EV of -10+8 would indicate that the lens has been closed by 100 million F stops.   That's a lot of F stops!</p>


	<p><img src="/attachments/download/851/img_4381_small.jpg" alt="" /></p></div>
    </div>
  </div>
  
  <div id="change-4389" class="journal has-details">
    <div id="note-11">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-11" class="journal-link">#11</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="13 Oct 2015 16:22" href="/projects/exiv2/activity?from=2015-10-13">about 6 years</a> ago
      <span id="journal-4389-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/851">img_4381_small.jpg</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/851/img_4381_small.jpg">img_4381_small.jpg</a> added</li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-5598" class="journal has-notes has-details">
    <div id="note-12">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-12" class="journal-link">#12</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="16 Sep 2016 07:19" href="/projects/exiv2/activity?from=2016-09-16">about 5 years</a> ago
      <span id="journal-5598-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Closed</i></li>
       <li><strong>% Done</strong> changed from <i>50</i> to <i>100</i></li>
    </ul>
    <div id="journal-5598-notes" class="wiki"><p>I believe this is closed. <pre>797 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pa --grep exposure/i http://dev.exiv2.org/attachments/download/851/img_4381_small.jpg
Exif.Photo.ExposureTime                      Rational    1  1/40 s
Exif.Photo.ExposureBiasValue                 SRational   1  0 EV
Exif.CanonCs.ExposureProgram                 Short       1  Program (P)
Exif.Photo.ExposureMode                      Short       1  Auto
798 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre></p></div>
    </div>
  </div>
  
  <div id="change-5600" class="journal has-notes">
    <div id="note-13">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-13" class="journal-link">#13</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4443">Felix Bolte</a> <a title="16 Sep 2016 09:33" href="/projects/exiv2/activity?from=2016-09-16">about 5 years</a> ago
      <span id="journal-5600-private_notes" class=""></span>
    </h4>

    <div id="journal-5600-notes" class="wiki"><p>please try with the BLANK.jpg i uploaded to this this ticket ... still broken here:</p>


<pre>
[felix@between trunk]$ svn info
Path: .
Working Copy Root Path: /home/felix/Downloads/exiv2/trunk
URL: svn://dev.exiv2.org/svn/trunk
Relative URL: ^/trunk
Repository Root: svn://dev.exiv2.org/svn
Repository UUID: b7c8b350-86e7-0310-a4b4-de8f6a8f16a3
Revision: 4501
Node Kind: directory
Schedule: normal
Last Changed Author: robinwmills
Last Changed Rev: 4501
Last Changed Date: 2016-09-16 07:33:40 +0200 (Fri, 16 Sep 2016)

[felix@between trunk]$ ./bin/exiv2 -pa /tmp/Blank.JPG 
Exif.Image.ExifTag                           Long        1  26
Floating point exception (core dumped)
</pre></div>
    </div>
  </div>
  
  <div id="change-5601" class="journal has-notes has-details">
    <div id="note-14">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-14" class="journal-link">#14</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="16 Sep 2016 10:12" href="/projects/exiv2/activity?from=2016-09-16">about 5 years</a> ago
      <span id="journal-5601-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Closed</i> to <i>Assigned</i></li>
       <li><strong>% Done</strong> changed from <i>100</i> to <i>50</i></li>
    </ul>
    <div id="journal-5601-notes" class="wiki"><p>Yes.  I was too enthusiastic to close this.  I'm putting this back to 50% done and asking Andreas to investigate.</p></div>
    </div>
  </div>
  
  <div id="change-5697" class="journal has-notes has-details">
    <div id="note-15">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-15" class="journal-link">#15</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="19 Oct 2016 19:07" href="/projects/exiv2/activity?from=2016-10-19">about 5 years</a> ago
      <span id="journal-5697-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Closed</i></li>
       <li><strong>Assignee</strong> changed from <i>Andreas Huggel</i> to <i>Robin Mills</i></li>
       <li><strong>% Done</strong> changed from <i>50</i> to <i>100</i></li>
       <li><strong>Estimated time</strong> changed from <i>5.00 h</i> to <i>6.00 h</i></li>
    </ul>
    <div id="journal-5697-notes" class="wiki"><p>Fix submitted <a class="changeset" title="#1080 Fix submitted." href="/projects/exiv2/repository/exiv2/revisions/4645">r4645</a><pre>796 rmills@rmillsmbp:~/gnu/exiv2/trunk/build $ bin/Debug/exiv2 -pR http://dev.exiv2.org/attachments/download/849/Blank.JPG
STRUCTURE OF JPEG FILE: http://dev.exiv2.org/attachments/download/849/Blank.JPG
 address | marker       |  length | data
       0 | 0xffd8 SOI  
       2 | 0xffe0 APP0  |      16 | JFIF.....`.`....
      20 | 0xffe1 APP1  |      60 | Exif..II*.......i..............
  STRUCTURE OF TIFF FILE (II): MemIo
   address |    tag                           |      type |    count |    offset | value
        10 | 0x8769 ExifTag                   |      LONG |        1 |        26 | 26
    STRUCTURE OF TIFF FILE (II): MemIo
     address |    tag                           |      type |    count |    offset | value
          28 | 0x9204 ExposureBiasValue         | SRATIONAL |        1 |        44 | 44/0
    END MemIo
  END MemIo
      82 | 0xffdb DQT   |      67 
     151 | 0xffdb DQT   |      67 
     220 | 0xffc0 SOF0  |      17 
     239 | 0xffc4 DHT   |      31 
     272 | 0xffc4 DHT   |     181 
     455 | 0xffc4 DHT   |      31 
     488 | 0xffc4 DHT   |     181 
     671 | 0xffda SOS  
797 rmills@rmillsmbp:~/gnu/exiv2/trunk/build $ bin/Debug/exiv2 -pa http://dev.exiv2.org/attachments/download/849/Blank.JPG
Exif.Image.ExifTag                           Long        1  26
Exif.Photo.ExposureBiasValue                 SRational   1  0 EV
798 rmills@rmillsmbp:~/gnu/exiv2/trunk/build $ </pre></p></div>
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1080.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1080.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
