<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Feature #1140: Canon EF-S 24mm f/2.8 STM - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="parHBlmY52XV7MI/sWOMpRXozsh7vDAWP3lNSCZeOQlH52zpK+IrZYCI3TMOtICWKnqasYpfkazCWd3AZWfeZg==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Feature #1140: Canon EF-S 24mm f/2.8 STM" href="https://dev.exiv2.org/issues/1140.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Feature #1140</h2>

<div class="issue tracker-2 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Canon EF-S 24mm f/2.8 STM</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/146">Anonymous Poster</a> <a title="20 Dec 2015 00:46" href="/projects/exiv2/activity?from=2015-12-20">almost 6 years</a> ago.
        Updated <a title="13 Jan 2016 19:00" href="/projects/exiv2/activity?from=2016-01-13">almost 6 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">makernote</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="28 Apr 2017" href="/versions/52">0.26</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">20 Dec 2015</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">4.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>This lens appears to be in the latest canonmn.cpp with tag value 4154, but my camera (Canon EOS 30D) with the lens doesn't report this tag value, instead reporting 65535 (hex FF FF) which isn't associated with the any lens name. exiftool also reports a generic 'Unknown 24mm' Lens ID, so maybe there isn't enough information provided to correctly determine this lens on this camera.</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/866">IMG_5604.JPG</a>    <span class="size">(262 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/866/IMG_5604.JPG">IMG_5604.JPG</a>  </td>
  <td>Sample picture</td>
  <td>
      <span class="author">Anonymous Poster, 20 Dec 2015 00:46</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/867">IMG_5604.JPG.output</a>    <span class="size">(12.7 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/867/IMG_5604.JPG.output">IMG_5604.JPG.output</a>  </td>
  <td>Output of exiv2 -pt</td>
  <td>
      <span class="author">Anonymous Poster, 20 Dec 2015 00:46</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>








</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 4133" href="/projects/exiv2/repository/exiv2/revisions/4133">Revision 4133</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4133/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="20 Dec 2015 16:49" href="/projects/exiv2/activity?from=2015-12-20">almost 6 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Canon EF-S 24mm f/2.8 STM (Closed)" href="/issues/1140">#1140</a>  Fix submitted.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4134" href="/projects/exiv2/repository/exiv2/revisions/4134">Revision 4134</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4134/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="20 Dec 2015 17:30" href="/projects/exiv2/activity?from=2015-12-20">almost 6 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Canon EF-S 24mm f/2.8 STM (Closed)" href="/issues/1140">#1140</a>.  Correction to <a class="changeset" title="#1109 and #1041 Update to jenkins_build.sh  surprise: msvc build did not execute.  The &quot;what kind..." href="/projects/exiv2/repository/exiv2/revisions/4132">r4132</a>.  Modified lens detection condition.</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-4548" class="journal has-notes has-details">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="20 Dec 2015 09:31" href="/projects/exiv2/activity?from=2015-12-20">almost 6 years</a> ago
      <span id="journal-4548-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> changed from <i>lens</i> to <i>makernote</i></li>
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Priority</strong> changed from <i>Low</i> to <i>Normal</i></li>
       <li><strong>Target version</strong> set to <i>0.26</i></li>
       <li><strong>Estimated time</strong> set to <i>4.00 h</i></li>
    </ul>
    <div id="journal-4548-notes" class="wiki"><p>Thanks for reporting this.  Niels, our wonderful <em><strong>King Makernotes</strong></em> has gone back to college (in addition to his full-time demanding job) and I've taken over this challenge.  So .... patience ...... I'm on a learning curve.  However I've solved a couple of challenges and so I am optimistic of success.</p>


	<p>There was an issue with a Sigma Lens on a Pentax in which the LensID=0xffff (-1).  The lens detection required a "heuristic" to differentiate several types of lens with LensID == -1 and Phil (of ExifTool) explained it and we got that resolved.  I prefer the term <em>magic</em> to "heuristic".  The <em>magic</em> is some code that sniffs parts of the metadata to deduce how some tags are reported.</p>


	<p>Thanks for the test image.  Here's what I see on the trunk:<pre>$ exiv2 --grep lens/i -pa http://dev.exiv2.org/attachments/download/866/IMG_5604.JPG 
Exif.CanonCs.LensType                        Short       1  (65535)
Exif.CanonCs.Lens                            Short       3  24.0 mm
Exif.CanonCf.LensAFStopButton                Short       1  2304
Exif.Canon.LensModel                         Ascii      64  </pre>I've run this through exiftool:<pre>$ curl --silent -O http://dev.exiv2.org/attachments/download/866/IMG_5604.JPG
$ exiftool IMG_5604.JPG | grep -i lens
PrintLensID begin
PrintLensID B
Lens Type                       : n/a
Lens AF Stop Button             : AF stop
Lens Model                      : 
Lens                            : 24.0 mm
Lens ID                         : Unknown 24mm
Lens                            : 24.0 mm (35 mm equivalent: 38.4 mm)</pre>I don't see a lot of difference.  Exiftool reports Lens Type : n/a and we report -1.  And about the same with LensAFStopButton.  "Lens Model" is empty on both outputs.</p>


	<p>Looking in the code, I've found the 4154 which is associated with your lens.<pre>$ grep EF src/canonmn.cpp  | grep 24 | grep STM
        { 4152,"Canon EF 24-105mm f/3.5-5.6 IS STM"                         },
        { 4154,"Canon EF-S 24mm f/2.8 STM"                                  }</pre>However 4154 is not in your metadata.  Here's what I see (printing the 'vanilla' values):<pre>$ exiv2 --grep Lens/i -pv http://dev.exiv2.org/attachments/download/866/IMG_5604.JPG
0x0016 CanonCs      LensType                    Short       1  65535
0x0017 CanonCs      Lens                        Short       3  24 24 1
0x0009 CanonCf      LensAFStopButton            Short       1  2304
0x0095 Canon        LensModel                   Ascii      64  </pre>There must be existing <em>magic</em> in the code to convert 'CanonCs.Lens from 'Short 3 24 24 1' to '24.0 mm'.  However I don't see any data to explicitly identify it as <em>Canon EF-S 24mm f/2.8 STM</em>.  I see there are tags which are probably unique to your camera.<pre>610 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pa --grep Model/i --grep Lens/i  --grep Firm/i IMG_5604.JPG  
Exif.Image.Model                             Ascii      14  Canon EOS 30D
Exif.CanonCs.LensType                        Short       1  (65535)
Exif.CanonCs.Lens                            Short       3  24.0 mm
Exif.Canon.FirmwareVersion                   Ascii      32  Firmware 1.0.5
Exif.CanonCf.LensAFStopButton                Short       1  2304
Exif.Canon.ModelID                           Long        1  EOS 30D
Exif.Canon.LensModel                         Ascii      64  
611 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>Here's my proposal:<br />1) I cannot modify Exif.Canon.LensModel as we are correctly reporting it as 64 bytes with nothing in it.<br />2) I can modify the <em>magic</em> that converts Short 3 24 24 1 into '24.0 mm', provided:</p>


	<p>a) Image.Model is Canon EOS 30D<br />b) Canon.FirmwareVersion is 1.0.5<br />c) This change does not break our test suite.</p>


	<p>Are you happy with my proposal?</p></div>
    </div>
  </div>
  
  <div id="change-4549" class="journal has-notes has-details">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="20 Dec 2015 16:56" href="/projects/exiv2/activity?from=2015-12-20">almost 6 years</a> ago
      <span id="journal-4549-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>0</i> to <i>80</i></li>
    </ul>
    <div id="journal-4549-notes" class="wiki"><p>Fix submitted <a class="changeset" title="#1140  Fix submitted." href="/projects/exiv2/repository/exiv2/revisions/4133">r4133</a> and <a class="changeset" title="#1140.  Correction to r4132.  Modified lens detection condition." href="/projects/exiv2/repository/exiv2/revisions/4134">r4134</a>.</p>


	<p>The important part of the fix is in src/canonmn.cpp#1588:<pre><code class="cpp syntaxhl"><span class="c1">// 1140</span>
<span class="k">if</span><span class="p">(</span> <span class="n">metadata</span><span class="o">-&gt;</span><span class="n">findKey</span><span class="p">(</span><span class="n">ExifKey</span><span class="p">(</span><span class="s">"Exif.Image.Model"</span>        <span class="p">))</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">().</span><span class="n">toString</span><span class="p">()</span> <span class="o">==</span> <span class="s">"Canon EOS 30D"</span> 
<span class="o">&amp;&amp;</span>  <span class="n">metadata</span><span class="o">-&gt;</span><span class="n">findKey</span><span class="p">(</span><span class="n">ExifKey</span><span class="p">(</span><span class="s">"Exif.CanonCs.Lens"</span>       <span class="p">))</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">().</span><span class="n">toString</span><span class="p">()</span> <span class="o">==</span> <span class="s">"24 24 1"</span> 
<span class="o">&amp;&amp;</span>  <span class="n">metadata</span><span class="o">-&gt;</span><span class="n">findKey</span><span class="p">(</span><span class="n">ExifKey</span><span class="p">(</span><span class="s">"Exif.CanonCs.MaxAperture"</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">().</span><span class="n">toString</span><span class="p">()</span> <span class="o">==</span> <span class="s">"95"</span> <span class="c1">// F2.8</span>
<span class="p">){</span>
    <span class="k">return</span> <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">"Canon EF-S 24mm f/2.8 STM"</span> <span class="p">;</span>
<span class="p">}</span></code></pre>May I ask you to build and run this code on a collection of images taken with this camera + lens combination.</p>


	<p>I have extracted the metadata from your test image and added it to our test suite for regression purposes.  Please let me know if you are unhappy with your data being used in this way.</p></div>
    </div>
  </div>
  
  <div id="change-4554" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4591">Eric Brown</a> <a title="21 Dec 2015 20:34" href="/projects/exiv2/activity?from=2015-12-21">almost 6 years</a> ago
      <span id="journal-4554-private_notes" class=""></span>
    </h4>

    <div id="journal-4554-notes" class="wiki"><p>It seems to work on a collection of pictures that I took on a couple separate days. There also appears to be a "Canon EF 24mm f/2.8 IS" lens for sale )(<a class="external" href="http://www.bhphotovideo.com/c/product/843009-USA/Canon_5345B002_EF_24mm_f_2_8L_IS.html">http://www.bhphotovideo.com/c/product/843009-USA/Canon_5345B002_EF_24mm_f_2_8L_IS.html</a>). I'm not sure how its EXIF data differs or whether it would be incorrectly assigned to the non-image-stabilized USM lens. I don't have access to that lens.</p>


	<p>After some further investigating, it appears as though the firmware version that I have (1.0.5) doesn't store the lens type for any lens that I have but that the updated firmware (1.0.6) does store it. I haven't tried to update the Firmware or see what happens, but perhaps the patch should include a check for the 1.0.5 firmware, since the magic (hopefully) isn't needed for an update camera.</p></div>
    </div>
  </div>
  
  <div id="change-4555" class="journal has-notes">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="21 Dec 2015 21:21" href="/projects/exiv2/activity?from=2015-12-21">almost 6 years</a> ago
      <span id="journal-4555-private_notes" class=""></span>
    </h4>

    <div id="journal-4555-notes" class="wiki"><p>Gosh, Eric.  I'm learning as we go here.  If it's working on your files, let's leave it be and not include the firmware check.  When I added the code yesterday I thought "oh, the firmware could be updated and break this code.".  So let's not try to forward guess the firmware.</p>


	<p>The real fix is for Canon to use LensID == 4154 and then my <em><strong>magic</strong></em> will not be executed.  Perhaps the 1.06 firmware will do exactly that and my <em><strong>magic</strong></em> is irrelevant.</p>


	<p>I've marked this 80% complete.  If a firmware change (or the non-stabilised version of the lens) causes an unhappy change in behaviour, please let me know (with test files) and I will investigate and remedy this situation.</p>


	<p>If you're happy with my response, you'll see the bill I presented to Simon for helping him with 816: <a class="external" href="http://dev.exiv2.org/issues/816#note-39">http://dev.exiv2.org/issues/816#note-39</a></p>


	<p>Happy Holidays.  Seasons Greetings.</p>


	<p><img src="http://exiv2.org/Exiv2Logo.png" alt="" /></p></div>
    </div>
  </div>
  
  <div id="change-4693" class="journal has-notes has-details">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="13 Jan 2016 19:00" href="/projects/exiv2/activity?from=2016-01-13">almost 6 years</a> ago
      <span id="journal-4693-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Closed</i></li>
       <li><strong>% Done</strong> changed from <i>80</i> to <i>100</i></li>
    </ul>
    <div id="journal-4693-notes" class="wiki"><p>As there has been no further incidents, I'm going to close this and mark it 100% resolved.</p></div>
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1140.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1140.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
