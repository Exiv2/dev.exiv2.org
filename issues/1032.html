<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #1032: CMake doesn&#39;t build svn_version.h anymore - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="xhEPEP9RDvvq1K88tEUjExZHhHwQR9/aU/JFUqyruhgkXKT/jSvC+7+wsDALki8gKdXQBeGkfmCu0tXa75Jddw==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #1032: CMake doesn&#39;t build svn_version.h anymore" href="https://dev.exiv2.org/issues/1032.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #1032</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>CMake doesn&#39;t build svn_version.h anymore</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/2456">Daniel Kaneider</a> <a title="15 Feb 2015 15:24" href="/projects/exiv2/activity?from=2015-02-15">almost 7 years</a> ago.
        Updated <a title="21 Jun 2015 16:39" href="/projects/exiv2/activity?from=2015-06-21">over 6 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">build</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="17 May 2015" href="/versions/51">0.25</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">15 Feb 2015</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value"></div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>Hi,<br />as mentioned in the previous issue, commit 3479, caused that svn_version.h is not generated any more. CMake log output correctly reports the svn version, but 'exiv2.exe -V -v'  just puts 0 (the default value). Not that I would particularly care about this bug, I just wanted to let you know.</p>


	<p>Regards,<br />Daniel</p>
  </div>
</div>







</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 3610" href="/projects/exiv2/repository/exiv2/revisions/3610">Revision 3610</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/3610/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Feb 2015 17:05" href="/projects/exiv2/activity?from=2015-02-24">over 6 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: CMake doesn&#39;t build svn_version.h anymore (Closed)" href="/issues/1032">#1032</a>.  Thanks very much to Daniel for his help with this.</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-3138" class="journal has-details">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="16 Feb 2015 02:17" href="/projects/exiv2/activity?from=2015-02-16">almost 7 years</a> ago
      <span id="journal-3138-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> set to <i>build</i></li>
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Target version</strong> set to <i>0.25</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-3163" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="23 Feb 2015 18:17" href="/projects/exiv2/activity?from=2015-02-23">over 6 years</a> ago
      <span id="journal-3163-private_notes" class=""></span>
    </h4>

    <div id="journal-3163-notes" class="wiki"><p>Daniel</p>


	<p>Can you help me with this, please?  My aim is to generate the file src/svn_version.h as follows:<pre>527 rmills@rmillsmbp:~/gnu/exiv2/trunk/src $ ./svn_version.sh 
BASH_SOURCE=([0]="./svn_version.sh")
svn_version=3607
svn_version_h=svn_version.h
528 rmills@rmillsmbp:~/gnu/exiv2/trunk/src $ cat svn_version.h
#ifndef SVN_VERSION
#define SVN_VERSION 3607
#endif</pre>There is a file include/exiv2/svn_version.h which is "hard-wired" to SVN_VERSION 0 and is the fallback to guarantee that #include "svn_version.h" will work and macro SVN_VERSION is defined.</p>


	<p>I believe the bash script &lt;exiv2dir&gt;/src/svn_version.sh (called by the autotools) works fine.  Last Fall, you reported issues with calling svn_version.sh using CMake/Command and provided a patch which I didn't understand.  However, I respect you and therefore committed the patch to our repository.</p>


	<p>The following code in &lt;exiv2dir&gt;/CMakeLists.txt to sets/reports the SVN revision number.  It seems to work fine, although I don't know what Subversion_WC_INFO does.<br /><pre>FIND_PACKAGE(Subversion QUIET)
SET(SVN_REVISION "0")
IF(SUBVERSION_FOUND)
    IF(EXISTS "${CMAKE_SOURCE_DIR}/.svn")
        Subversion_WC_INFO(${PROJECT_SOURCE_DIR} svnExiv2)
        SET(SVN_REVISION "${svnExiv2_WC_REVISION}")
    ENDIF()
ENDIF()
MESSAGE(STATUS  "SVN version:  ${SVN_REVISION}")
</pre></p>


	<p>There is a file &lt;exiv2dir&gt;/src/svn_version.h.in which seems to reference the environment string ${SVN_REVISION}.  However, I don't understand how that file mutates to &lt;exiv2dir&gt;/src/svn_version.h.</p>


<pre>525 rmills@rmillsmbp:~/gnu/exiv2/trunk $ svn log src/svn_version.h.in
------------------------------------------------------------------------
r3374 | robinwmills | 2014-10-11 16:54:56 +0100 (Sat, 11 Oct 2014) | 1 line

#994 Adding src/svn_version.h.in - apologies to Daniel for not committing this, and to Jehan for the inconvenience.
------------------------------------------------------------------------
526 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>

	<p>I have many questions about CMake, however let's start by resolving this matter.  I know you don't care about this particular issue, however we have to start somewhere.  When we make progress with this issue, you will boost my confidence to tackle more serious concerns about MSVC/CMake.</p></div>
    </div>
  </div>
  
  <div id="change-3164" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/2456">Daniel Kaneider</a> <a title="23 Feb 2015 20:51" href="/projects/exiv2/activity?from=2015-02-23">over 6 years</a> ago
      <span id="journal-3164-private_notes" class=""></span>
    </h4>

    <div id="journal-3164-notes" class="wiki"><p>Alright.</p>


	<p>The CMake installation ships with a set of <code>Find*</code> 3rd party modules. One of them deals with Subversion. On my windows machine, this is located under <code>&lt;cmake-dir&gt;\share\cmake-3.2\Modules\FindSubversion.cmake</code>. That is where <code>Subversion_WC_INFO</code> gets defined.  It basically just calls svn binary to get some info about the current working copy. The other lines of code try to detect a subversion client silently, and to set the svn revision (if found) to a non-zero value.</p>


	<p><code>svn_version.h</code> is not supposed to exist in any source directory. It should rather be generated into the output directory, and copied (or CMake-installed) into the 'distribution' directory. I know this concept breaks some existing builds tools, especially msvc is a weird case. Some while ago I included in that patch <br /><pre>
CONFIGURE_FILE( ${CMAKE_CURRENT_SOURCE_DIR}/svn_version.h.in
                ${CMAKE_CURRENT_BINARY_DIR}/svn_version.h @ONLY)
</pre><br />This works with the help of the template <code>svn_version.h.in</code><br /><pre>
#define SVN_VERSION @SVN_REVISION@
</pre><br />and replaces everything between the two <code>-s. It's a CMake command which takes a template as input, and generates/replaces all found variables in the output file. And in order to include the header file for the compilation, I did<br /><redpre#2></pre><br />Again, the intention was to just have the </code>.in@ template file in the source directory, but not the generated headers itself.</p>


	<p>Especially important for VS (but extensible also for other build chains for compatibility) was a change in <code>version.hpp</code>, which didn't include the header file, if it wasn't generated. Using:<br /><pre>
#if     defined(_MSC_VER) &#38;&#38; !defined(CMAKE_BUILD_SVN)
 #define SVN_VERSION 0
#else
 #include "svn_version.h" 
</pre><br />That last change isn't maybe the best approach, but the one which is working with the least changes. The other changes regarding CMake should be straightforward.</p>


	<p>Summarizing to maintain compatibility as much as possible: <br />- consider <code>svn_version.h</code> in the source directory as deprecated, it should get generated. Moving it into a <em>compatibility</em> directory could be a first step. <br />- you could start to CMake-Configure that header file, by replacing it where it is right now</p></div>
    </div>
  </div>
  
  <div id="change-3165" class="journal has-notes">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="23 Feb 2015 22:23" href="/projects/exiv2/activity?from=2015-02-23">over 6 years</a> ago
      <span id="journal-3165-private_notes" class=""></span>
    </h4>

    <div id="journal-3165-notes" class="wiki"><p>Bingo.  I understand.  The CONFIGURE_FILE/foo.h.in dance is the magic to make things work. Right, now I understand.</p>


	<p>&lt;exiv2dir&gt;/src/svn_version.h is not in the code base.  It is always generated.  &lt;exiv2dir&gt;/include/exiv2/svn_version.h is there to save the day when src/svn_version.h is absent for any reason.</p>


	<p>I'll progress this tomorrow and hope to submit.  Then I'll look at <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: CMake build broken when using zlib/expat in clean way (Closed)" href="/issues/1031">#1031</a></p>


	<p>Thank You very much for your help.</p></div>
    </div>
  </div>
  
  <div id="change-3169" class="journal has-details">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="28 Feb 2015 21:43" href="/projects/exiv2/activity?from=2015-02-28">over 6 years</a> ago
      <span id="journal-3169-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Resolved</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-3669" class="journal has-details">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="08 May 2015 16:33" href="/projects/exiv2/activity?from=2015-05-08">over 6 years</a> ago
      <span id="journal-3669-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>0</i> to <i>100</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-3818" class="journal has-details">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="21 Jun 2015 16:39" href="/projects/exiv2/activity?from=2015-06-21">over 6 years</a> ago
      <span id="journal-3818-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Resolved</i> to <i>Closed</i></li>
    </ul>
    
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1032.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1032.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
