<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #533: Support multiple APP13 Photoshop 3.0 segments in a JPEG - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="OQokiTe2lJwHm/WdX92tq7B54DEP/PlFTMlXYUAkvrPbR49mRcxYnFL/6pHgCqGYj+u0SP4fWP+x6cfpAx1Z3A==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #533: Support multiple APP13 Photoshop 3.0 segments in a JPEG" href="https://dev.exiv2.org/issues/533.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #533</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Support multiple APP13 Photoshop 3.0 segments in a JPEG</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="28 Nov 2007 06:09" href="/projects/exiv2/activity?from=2007-11-28">almost 14 years</a> ago.
        Updated <a title="30 Dec 2009 07:50" href="/projects/exiv2/activity?from=2009-12-30">almost 12 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/53">Andreas Huggel</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">jpeg parser</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="30 Dec 2009" href="/versions/44">0.19</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value"></div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value"></div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>It appears there can be multiple APP13 Photoshop 3.0 segments in a JPEG. The payloads of these should be concatenated before processing and the other way around on write.</p>


	<p><strong>Additional information:</strong></p>


	<p>The original discussion in the digiKam bugzilla:<br /><a class="external" href="http://bugs.kde.org/show_bug.cgi?id=152210">http://bugs.kde.org/show_bug.cgi?id=152210</a><br />(in particular from comment 13 onwards)</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/35">fix_jpg_parser.patch</a>    <span class="size">(9.78 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/35/fix_jpg_parser.patch">fix_jpg_parser.patch</a>  </td>
  <td></td>
  <td>
      <span class="author">Redmine Admin, 10 Oct 2008 17:43</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/97">kde_bug_152210_fixed.jpg</a>    <span class="size">(890 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/97/kde_bug_152210_fixed.jpg">kde_bug_152210_fixed.jpg</a>  </td>
  <td></td>
  <td>
      <span class="author">Michael Ulbrich, 19 Jun 2009 14:24</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/98">exiv2_jpg_patches_version5.tgz</a>    <span class="size">(145 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/98/exiv2_jpg_patches_version5.tgz">exiv2_jpg_patches_version5.tgz</a>  </td>
  <td>Patch set for exiv2-0.18.2</td>
  <td>
      <span class="author">Michael Ulbrich, 25 Jun 2009 06:11</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/100">change_Photoshop_IRB_warning_to_debug.patch</a>    <span class="size">(758 Bytes)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/100/change_Photoshop_IRB_warning_to_debug.patch">change_Photoshop_IRB_warning_to_debug.patch</a>  </td>
  <td>Changed warnings &#39;Invalid or extended Photoshop IRB&#39; to debug messages.</td>
  <td>
      <span class="author">Volker Grabsch, 13 Jul 2009 04:53</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>







<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/533" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="ZNN9y2pI8uOb8VelrLf5GbIID1RWGh6cwnfjzmkWhHuGntYkGDI+486VSKkTYPUqjZpbLaf5vyY/V3NGKi9jFA==" />
  <table class="list issues odd-even"><tr id="relation-30" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="542" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/542">Bug #542</a>: exiv2 doesn&#39;t find exif data in attacched file</td><td class="status">Closed</td><td class="start_date"></td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-49" class="issue hascontextmenu issue tracker-1 status-4 priority-4 priority-default"><td class="checkbox"><input type="checkbox" name="ids[]" value="663" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-4 priority-4 priority-default" href="/issues/663">Bug #663</a>: Failure to write to Jpeg from Canon Ixus - digikam bug 214636</td><td class="status">Feedback</td><td class="start_date">20 Dec 2009</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-0"><tr><td style="width: 100%;" class="todo"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/533/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=533&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 1849" href="/projects/exiv2/repository/exiv2/revisions/1849">Revision 1849</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/1849/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="29 Jun 2009 08:24" href="/projects/exiv2/activity?from=2009-06-29">over 12 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Support multiple APP13 Photoshop 3.0 segments in a JPEG (Closed)" href="/issues/533">#533</a>: Applied patch 6_fix_test_conversions_timezone (Michael Ulbrich, Volker Grabsch)</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 1856" href="/projects/exiv2/repository/exiv2/revisions/1856">Revision 1856</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/1856/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="12 Jul 2009 06:22" href="/projects/exiv2/activity?from=2009-07-12">over 12 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Support multiple APP13 Photoshop 3.0 segments in a JPEG (Closed)" href="/issues/533">#533</a>: Added Volker Grabsch and Michael Ulbrich to authors.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 1861" href="/projects/exiv2/repository/exiv2/revisions/1861">Revision 1861</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/1861/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="13 Jul 2009 08:02" href="/projects/exiv2/activity?from=2009-07-13">over 12 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Support multiple APP13 Photoshop 3.0 segments in a JPEG (Closed)" href="/issues/533">#533</a>: Changed two more warnings to debug messages (Volker Grabsch)</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-957" class="journal has-notes">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="09 Dec 2007 00:03" href="/projects/exiv2/activity?from=2007-12-09">almost 14 years</a> ago
      <span id="journal-957-private_notes" class=""></span>
    </h4>

    <div id="journal-957-notes" class="wiki"><p><a class="changeset" title="#533: An attempt to read IPTC data from multiple APP13 Photoshop 3.0 segments." href="/projects/exiv2/repository/exiv2/revisions/1338">r1338</a>: Read IPTC from multiple APP13 Photoshop 3.0 segments</p></div>
    </div>
  </div>
  
  <div id="change-958" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="08 Oct 2008 03:35" href="/projects/exiv2/activity?from=2008-10-08">about 13 years</a> ago
      <span id="journal-958-private_notes" class=""></span>
    </h4>

    <div id="journal-958-notes" class="wiki"><p>Another suggestion: Process only the first APP13 segment.<br /><a class="external" href="http://uk.groups.yahoo.com/group/exiv2/message/1382">http://uk.groups.yahoo.com/group/exiv2/message/1382</a></p></div>
    </div>
  </div>
  
  <div id="change-959" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/124">Michael Ulbrich</a> <a title="10 Oct 2008 14:25" href="/projects/exiv2/activity?from=2008-10-10">about 13 years</a> ago
      <span id="journal-959-private_notes" class=""></span>
    </h4>

    <div id="journal-959-notes" class="wiki"><p>Two situations where a JPEG file contains multiple APP13 segments have occured:</p>


	<p>a) an IPTC block, which doesn't fit into a single APP13 segment has been split into  multiple consecutive APP13 segments.</p>


	<p>b) an application, instead of modifying IPTC data contained in an existing APP13 segment, has chosen to prepend a new APP13 segment with an independent IPTC block.</p>


	<p>Both cases could be considered "broken" on the metadata level. The basic JPEG structure is intact.</p>


	<p>Case a) owes it's size to the presence of IPTC extended dataset 2#202 "ObjectData Preview Data" with a maximum size of 256000 bytes. It is quite uncommon to put an image preview into the IPTC block, since there is image resource block <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: New lens ID for Tamron 70-300mm f/4-5.6 Di VC USD (Canon mount) (Closed)" href="/issues/1036">#1036</a> which usually would contain the (much smaller!) thumbnail image.</p>


	<p>Case b) originated from an image communication network where intermediate nodes may add a new IPTC block with credit / copyright information and keep the original IPTC data for reference.</p>


	<p>exiv2 currently copes with a) but merges IPTC blocks according to b) into one.</p>


	<p>The attempt to uniquely distinguish these cases and handle both correctly seems impossible since there is no known semantic of splitting APP13 segments.</p>


	<p>An experimental patch to restrict exiv2's IPTC editing only to the first APP13 segment and leave all possibly following untouched has been provided. [Attachment: fix_jpg_parser.patch -ahu. ]</p>


	<p>Thanks + Best regards ... Michael</p></div>
    </div>
  </div>
  
  <div id="change-1303" class="journal has-notes has-details">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/124">Michael Ulbrich</a> <a title="19 Jun 2009 14:24" href="/projects/exiv2/activity?from=2009-06-19">over 12 years</a> ago
      <span id="journal-1303-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/97">kde_bug_152210_fixed.jpg</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/97/kde_bug_152210_fixed.jpg">kde_bug_152210_fixed.jpg</a> added</li>
    </ul>
    <div id="journal-1303-notes" class="wiki"><p>Some remarks on how correct splitting of APP13 segments in JPEG images might look like.</p>


	<p>I recently came across some JPEGs which our Exiv2-based Metadata-Tool was unable to process. On closer inspection these images had multiple APP13 segments due to the presence of multiple large IRBs (IDs 0x07D0 ff.) containing saved path information.</p>


	<p>The following refers to above cited original discussion in the digiKam bugzilla: <a class="external" href="http://bugs.kde.org/show_bug.cgi?id=152210">http://bugs.kde.org/show_bug.cgi?id=152210</a></p>


	<p>In comment #14 Andreas attaches a JPEG ( <a class="external" href="http://bugs.kde.org/attachment.cgi?id=22410">http://bugs.kde.org/attachment.cgi?id=22410</a> ) where the IPTC IRB sizes were fixed with respect to the original attachment in comment #11 ( <a class="external" href="http://bugs.kde.org/attachment.cgi?id=22180">http://bugs.kde.org/attachment.cgi?id=22180</a> ).</p>


	<p>The problem with the method of splitting as implemented in these DigiKam examples lies in the fact that it is done on the IPTC (IRB payload) level and not on the IRB level. An application which wishes to detect a split APP13 situation would have to understand IPTC to distinguish a valid split from a broken metadata structure. Actually there are more types of IRBs than just IPTC with differently formatted payloads, which potentially might need splitting among APP13 segments. An application would hence need knowledge about all these payload formats to securely distinguish splitting from corruption.</p>


	<p>In example 22410 both APP13 segments decode cleanly on the Image Resource Block level since all the IRB lengths are correct. The decoder has to descend to the IPTC level to find tag 0xca (ObjectPreviewData) with a length pointing beyond the end of the first APP13 segment. The following APP13 segment then starts with the standard preamble "Photoshop 3.0" and again signals an IPTC IRB by "8BIM" 0x0404 followed by the correct length of the second IPTC fragment. The problem here is that a fresh IPTC IRB is opened which soon violates the format by not starting with a valid IPTC tag 0x1c02 but appending the second fragment of tag 0xca instead. BTW example 22410 leads to "Invalid IPTC entry (tag 202, len 68198)" from the first and "Warning = Bad IPTC data tag (marker 0x28)" from the second IPTC fragment, if parsed by exiftool.</p>


	<p>Now back to above mentioned JPEGs with path information IRBs split across consecutive APP13 segments. Here the length of the split IRB contains the total - not the fragment - length and points beyond the end of the first APP13 segment. The second APP13 segment starts neither with the preamble nor with a fresh IRB but instead immediately continues with the second fragment of the split IRB. A parser will be able to detect the split solely on the IRB level without descending into payload semantics. Second and higher APP13 markers without preamble / initial 8BIM will give a strong indication of splitting. After concatenating these split APP13 segments parse cleanly on the IRB level. If not, the metadata structure is corrupt.</p>


	<p>I have modified example 22410 and split the APP13 markers as described above. The image is attached to this message.</p>


	<p>A set of patches is available for reading/writing JPEG APP13 segments according to this method. These patches will be posted together with comments either to the forum or this bug report in the next days.</p></div>
    </div>
  </div>
  
  <div id="change-1316" class="journal has-notes has-details">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/124">Michael Ulbrich</a> <a title="25 Jun 2009 06:11" href="/projects/exiv2/activity?from=2009-06-25">over 12 years</a> ago
      <span id="journal-1316-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/98">exiv2_jpg_patches_version5.tgz</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/98/exiv2_jpg_patches_version5.tgz">exiv2_jpg_patches_version5.tgz</a> added</li>
    </ul>
    <div id="journal-1316-notes" class="wiki"><p>As already announced here's a set of patches, which implements support for multiple APP13 Photoshop 3.0 segments in JPEG according to previous post.</p>


	<p>These are the patches with comments:</p>


	<p>1_handle_empty_IRB indep*</p>


	<p>Currently empty IRB at end of APP13 is treated as error. This patch changes behaviour<br />insofar that trailing empty IRBs are treated as normal image resource blocks.</p>


	<p>Per IPTC spec no empty IPTC IRBs are allowed but they occur in practice anyway.<br />size = 12 -> empty IRB<br />size = 14 -> length 1 + padding '0'</p>


	<p>In DEBUG mode empty IRBs will be reported.</p>


	<p>2_read_and_modify_only_the_first_XMP_segment indep*</p>


	<p>Current implementation modifies last XMP segment, if multiple segments are present.<br />Change behaviour to only modify first XMP segment and leave the following untouched.</p>


	<p>3_skip_writing_redundant_IPTC_IRBs indep*?</p>


	<p>Multiple IPTC IRBs inside same APP13 segment (theoretical).<br />Current implementaion concatenates IPTC IRB contents on read but replaces only first<br />with concatenated IPTC content on write, leaves the following untouched.</p>
	<pre><code>APP13                          APP13<br />        IRB-1                          IRB-1<br />        IRB-2 (IPTC)                   IRB-2 (IPTC)<br />            IPTC-a                          IPTC-a*<br />        IRB-3                               IPTC-b*<br />        IRB-4             -----&gt;            IPTC-c*<br />        IRB-5 (IPTC)                   IRB-3<br />            IPTC-b                     IRB-4<br />        IRB-6 (IPTC)                   IRB-5 (IPTC)<br />            IPTC-c                         IPTC-b<br />        IRB-7                          IRB-6 (IPTC)<br />                                           IPTC-c<br />                                       IRB-7</code></pre>


	<p>Now concatenated IPTC IRB replaces first IPTC IRB. Following IPTC IRBs are<br />discarded. Non IPTC IRBs are kept and not modified.</p>
	<pre><code>APP13                          APP13<br />        IRB-1                          IRB-1<br />        IRB-2 (IPTC)                   IRB-2 (IPTC)<br />            IPTC-a                          IPTC-a*<br />        IRB-3                               IPTC-b*<br />        IRB-4             -----&gt;            IPTC-c*<br />        IRB-5 (IPTC)                   IRB-3<br />            IPTC-b                     IRB-4<br />        IRB-6 (IPTC)                   IRB-7<br />            IPTC-c<br />        IRB-7</code></pre>


	<p>4_new_function_Photoshop_valid (needed by 8)</p>


	<p>Used to detect extended (split) IRBs. Checks all IRBs in APP13 for correct length.<br />Returns false, if length mismatch was found.</p>


	<p>5_recognize_small_corrupt_IRBs indep*</p>


	<p>Related to 1. Handle (corrupt) IRBs shorter than 12 byte as error. Additionally<br />needed to correctly locate split boundary.</p>


	<p>6_fix_test_conversions_timezone indep*</p>


	<p>Set correct timezone for test. 'make test' currently fails, if local time zone not GMT-8</p>


	<p>7_more_iptc_test_images (needs all patches to succeed all tests)</p>


	<p>Add synthetically generated JPEG images with various IPTC stuctures for testing.<br />Tarball with test images.</p>


	<p>8_handle_extended_Photoshop_IRBs</p>


	<p>support multiple (split) APP13 Photoshop 3.0 segments in JPEG. On write split APP13 segments on 65533 byte boundary. If split boundary coincides with end of IRB, decrease segment size to force IRB split (detectable!).</p>


	<p>Additional remarks:</p>


	<p>1. Example JPEG images with split APP13 segments written by Photoshop were found.<br />In these cases not IPTC IRBs with embedded preview image, but multiple IRBs containing<br />complex clipping paths were responsible for APP13 size exceeding limit.</p>


	<p>2. Actually APP13 segments in above example JPEGs were split on 32000 byte boundary and not on the expected 65533. On write Exiftool uses the latter as well.</p>


	<p>3. Patches 1, 2, 3, 5, 6 are independent (indep*). Patch 4 and test images are needed by patch 8. Patches apply cleanly against exiv2-0.18.2. All tests succeed.</p>


	<p>4. If patches are accepted for inclusion, please add Volker Grabsch (vogATnotjusthostingDOTcom) as contributor (in fact he did all the coding ...).</p>


	<p>Thanks to all for exiv2!</p>


	<p>Best regards ... Michael</p></div>
    </div>
  </div>
  
  <div id="change-1323" class="journal has-notes">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="28 Jun 2009 09:42" href="/projects/exiv2/activity?from=2009-06-28">over 12 years</a> ago
      <span id="journal-1323-private_notes" class=""></span>
    </h4>

    <div id="journal-1323-notes" class="wiki"><p>Thanks for this very comprehensive analysis and patchset!</p>


	<p>I've checked-in all patches except for 6_* with <a class="changeset" title="533: Applied patch 1_handle_empty_IRB (Michael Ulbrich, Volker Grabsch)" href="/projects/exiv2/repository/exiv2/revisions/1842">r1842</a> - <a class="changeset" title="533: Applied patch 8_handle_extended_Photoshop_IRBs (Michael Ulbrich, Volker Grabsch)" href="/projects/exiv2/repository/exiv2/revisions/1848">r1848</a> (but forgot the # in front of the issue number in the commit message), without much testing. I'll have a closer look at 6_* as soon as I can. The output of "cd test; make" now contains several warnings, is that intended? (see below).</p>


	<p>As usual, the copyright question: Can I add you to the list of authors of the modified files but retain the copyright for the complete files myself?</p>


	<p>Andreas</p>


<pre>
Running addmoddel.sh ...
All testcases passed.
Running bugfixes-test.sh ...
Files ./tmp/bugfixes-test.out-stripped and ./data/bugfixes-test.out differ
265,266d264
&lt; Warning: Invalid Photoshop IRB data size 144775 or extended Photoshop IRB
&lt; Warning: Invalid Photoshop IRB data size 144775 or extended Photoshop IRB
Running exifdata-test.sh ...
All testcases passed.
Running exiv2-test.sh ...
All testcases passed.
Running imagetest.sh ...

Erase all tests.......Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
.Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
.Warning: Invalid Photoshop IRB data size 25 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 25 or extended Photoshop IRB
.........
Copy all tests.........
Copy iptc tests.........
---------------------------------------------------------
All test cases passed
Running iotest.sh ...

Io tests...
---------------------------------------------------------
All test cases passed
Running iptctest.sh ...

Read tests....Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
.Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
.Warning: Invalid Photoshop IRB data size 25 or extended Photoshop IRB
............
Remove tests....Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
.Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
.Warning: Invalid Photoshop IRB data size 25 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 25 or extended Photoshop IRB
............
Add/Mod tests....Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
.Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
.Warning: Invalid Photoshop IRB data size 25 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 25 or extended Photoshop IRB
............
Extended tests....Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 33034 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 33034 or extended Photoshop IRB
.Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
.Warning: Invalid Photoshop IRB data size 25 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 25 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
Warning: Invalid Photoshop IRB data size 3978 or extended Photoshop IRB
............
---------------------------------------------------------
All test cases passed
Running modify-test.sh ...
All testcases passed.
Running path-test.sh ...
Running stringto-test.sh ...
All testcases passed.
Running tiff-test.sh ...
All testcases passed.
Running write-test.sh ...
All testcases passed.
Running write2-test.sh ...
All testcases passed.
Running xmpparser-test.sh ...
All testcases passed.
Running conversions.sh ...
All testcases passed.
</pre></div>
    </div>
  </div>
  
  <div id="change-1324" class="journal has-notes">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="29 Jun 2009 19:10" href="/projects/exiv2/activity?from=2009-06-29">over 12 years</a> ago
      <span id="journal-1324-private_notes" class=""></span>
    </h4>

    <div id="journal-1324-notes" class="wiki"><blockquote>

	<p>6_fix_test_conversions_timezone indep*</p>


	<p>Set correct timezone for test. 'make test' currently fails, if local time zone not GMT-8</p>


</blockquote>

	<p>Checked-in with <a class="changeset" title="#533: Applied patch 6_fix_test_conversions_timezone (Michael Ulbrich, Volker Grabsch)" href="/projects/exiv2/repository/exiv2/revisions/1849">r1849</a> (this time with #). I like the "elegant hack" used to fix this, thanks!<br />PS: Local timezone here is GMT+8, not -8</p>


	<p>Andreas</p></div>
    </div>
  </div>
  
  <div id="change-1325" class="journal has-notes">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/124">Michael Ulbrich</a> <a title="30 Jun 2009 03:56" href="/projects/exiv2/activity?from=2009-06-30">over 12 years</a> ago
      <span id="journal-1325-private_notes" class=""></span>
    </h4>

    <div id="journal-1325-notes" class="wiki"><blockquote>

	<p>The output of "cd test; make" now contains several warnings, is that intended?</p>


</blockquote>

	<p>For the moment, yes. Without patch 8 applied, any mismatch in claimed versus actual IRB size leads to an "Error: Invalid Photoshop IRB data size XXXX". We've changed this to "Warning: Invalid Photoshop IRB data size XXXX or extended Photoshop IRB" since a mismatch in IRB size may now resolve later in case of extended/split APP13 segments.</p>


	<p>We see two possibilities to get rid of the warnings:</p>


	<p>1. Completely eliminate the warnings and only report an error if a split APP13 situation cannot be resolved.</p>


	<p>2. Change condition from "#ifndef SUPPRESS_WARNINGS" to "#ifdef DEBUG".</p>


<blockquote>

	<p>Can I add you to the list of authors of the modified files but retain the copyright for the complete files myself?</p>


</blockquote>

	<p>The answer is "yes" for Volker as well as for me.</p>


	<p>... Michael</p></div>
    </div>
  </div>
  
  <div id="change-1326" class="journal has-notes">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="30 Jun 2009 04:22" href="/projects/exiv2/activity?from=2009-06-30">over 12 years</a> ago
      <span id="journal-1326-private_notes" class=""></span>
    </h4>

    <div id="journal-1326-notes" class="wiki"><p>Michael Ulbrich wrote:</p>


<blockquote>

	<p>We see two possibilities to get rid of the warnings:</p>


	<p>1. Completely eliminate the warnings and only report an error if a split APP13 situation cannot be resolved.</p>


</blockquote>

	<p>Yes, I think that is the correct behavior.</p>


<blockquote><blockquote>

	<p>Can I add you to the list of authors of the modified files but retain the copyright for the complete files myself?</p>


</blockquote>

	<p>The answer is "yes" for Volker as well as for me.</p>


</blockquote>

	<p>Thank you. I'll update the source files.</p>


	<p>Andreas</p></div>
    </div>
  </div>
  
  <div id="change-1327" class="journal has-notes">
    <div id="note-10">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-10" class="journal-link">#10</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="30 Jun 2009 04:29" href="/projects/exiv2/activity?from=2009-06-30">over 12 years</a> ago
      <span id="journal-1327-private_notes" class=""></span>
    </h4>

    <div id="journal-1327-notes" class="wiki"><p>Michael, from your experience, what applications can deal with this kind of split APP13 segments (other than exiftool)?</p></div>
    </div>
  </div>
  
  <div id="change-1328" class="journal has-notes">
    <div id="note-11">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-11" class="journal-link">#11</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/124">Michael Ulbrich</a> <a title="01 Jul 2009 01:52" href="/projects/exiv2/activity?from=2009-07-01">over 12 years</a> ago
      <span id="journal-1328-private_notes" class=""></span>
    </h4>

    <div id="journal-1328-notes" class="wiki"><p>Andreas Huggel wrote:</p>


<blockquote>

	<p>Michael, from your experience, what applications can deal with this kind of split APP13 segments (other than exiftool)?</p>


</blockquote>

	<p>Hmm, we are mostly modifying IPTC/XMP metadata of existing images, which come from a broad range of sources. Before we switched to exiv2 we had a tool based on 'iptcutil', which can still be found in the libtiff distribution.</p>


	<p>From that perspective we do not handle a lot of metadata on the application level, but within our own software environment. OTOH people who work with our modified images, mostly use the tools from A***e. So compatibility with these apps is always a must.</p>


	<p>Exiftool is able to process split APP13 segments, but does AFAIR not distinguish between a true split and multiple APP13 segments that have been accidentally written.</p>


	<p>ImageMagick seems unable to handle any form of split APP13, neither the "old" method with split on the IPTC payload level nor the "new" with split on the IRB level. IM IPTC metadata handling still seems to be based on modified iptcutil code.</p>


	<p>Please let me know, if there are any other relevant - open source - apps, which are aware of image metadata. I may then check how they behave in these special cases.</p></div>
    </div>
  </div>
  
  <div id="change-1329" class="journal has-notes">
    <div id="note-12">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-12" class="journal-link">#12</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/124">Michael Ulbrich</a> <a title="02 Jul 2009 04:32" href="/projects/exiv2/activity?from=2009-07-02">over 12 years</a> ago
      <span id="journal-1329-private_notes" class=""></span>
    </h4>

    <div id="journal-1329-notes" class="wiki"><p>Andreas Huggel wrote:</p>


<blockquote>

	<p>Michael Ulbrich wrote:</p>


<blockquote>

	<p>We see two possibilities to get rid of the warnings:</p>


	<p>1. Completely eliminate the warnings and only report an error if a split APP13 situation cannot be resolved.</p>


</blockquote>

	<p>Yes, I think that is the correct behavior.</p>


</blockquote>

	<p>From our POV it would be better to be able to reactivate the warnings by defining the DEBUG symbol and recompile. There is already other DEBUG output from Photoshop::locateIrb() in jpgimage.cpp. In case of troubleshooting some strange or broken input format (which I expect to show up), this would be helpful.</p></div>
    </div>
  </div>
  
  <div id="change-1330" class="journal has-notes">
    <div id="note-13">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-13" class="journal-link">#13</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="02 Jul 2009 20:27" href="/projects/exiv2/activity?from=2009-07-02">over 12 years</a> ago
      <span id="journal-1330-private_notes" class=""></span>
    </h4>

    <div id="journal-1330-notes" class="wiki"><p>Reminder for myself: Review the test which seems to filter large IPTC previews:</p>


	<p><a class="external" href="http://bugs.kde.org/show_bug.cgi?id=152210#c21">http://bugs.kde.org/show_bug.cgi?id=152210#c21</a></p></div>
    </div>
  </div>
  
  <div id="change-1332" class="journal has-notes">
    <div id="note-14">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-14" class="journal-link">#14</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="12 Jul 2009 06:40" href="/projects/exiv2/activity?from=2009-07-12">over 12 years</a> ago
      <span id="journal-1332-private_notes" class=""></span>
    </h4>

    <div id="journal-1332-notes" class="wiki"><p>Michael Ulbrich wrote:</p>


<blockquote>

	<p>From our POV it would be better to be able to reactivate the warnings by defining the DEBUG symbol and recompile. There is already other DEBUG output from Photoshop::locateIrb() in jpgimage.cpp. In case of troubleshooting some strange or broken input format (which I expect to show up), this would be helpful.</p>


</blockquote>

	<p><a class="changeset" title="Changed warning &#39;Invalid Photoshop IRB data size X or extended Photoshop IRB&#39; to debug message." href="/projects/exiv2/repository/exiv2/revisions/1858">r1858</a></p></div>
    </div>
  </div>
  
  <div id="change-1333" class="journal has-notes">
    <div id="note-15">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-15" class="journal-link">#15</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="12 Jul 2009 06:44" href="/projects/exiv2/activity?from=2009-07-12">over 12 years</a> ago
      <span id="journal-1333-private_notes" class=""></span>
    </h4>

    <div id="journal-1333-notes" class="wiki"><p>Andreas Huggel wrote:</p>


<blockquote>

	<p>Reminder for myself: Review the test which seems to filter large IPTC previews:</p>


	<p><a class="external" href="http://bugs.kde.org/show_bug.cgi?id=152210#c21">http://bugs.kde.org/show_bug.cgi?id=152210#c21</a></p>


</blockquote>

	<p>The test is in order. It doesn't filter just large IPTC previews.</p></div>
    </div>
  </div>
  
  <div id="change-1334" class="journal has-details">
    <div id="note-16">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-16" class="journal-link">#16</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="12 Jul 2009 06:45" href="/projects/exiv2/activity?from=2009-07-12">over 12 years</a> ago
      <span id="journal-1334-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Resolved</i></li>
       <li><strong>Target version</strong> set to <i>0.19</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>100</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-1336" class="journal has-notes has-details">
    <div id="note-17">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-17" class="journal-link">#17</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/206">Volker Grabsch</a> <a title="13 Jul 2009 04:53" href="/projects/exiv2/activity?from=2009-07-13">over 12 years</a> ago
      <span id="journal-1336-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/100">change_Photoshop_IRB_warning_to_debug.patch</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/100/change_Photoshop_IRB_warning_to_debug.patch">change_Photoshop_IRB_warning_to_debug.patch</a> added</li>
    </ul>
    <div id="journal-1336-notes" class="wiki"><p>Thanks for <a class="changeset" title="Changed warning &#39;Invalid Photoshop IRB data size X or extended Photoshop IRB&#39; to debug message." href="/projects/exiv2/repository/exiv2/revisions/1858">r1858</a>.</p>


	<p>However, the two other warnings "Invalid or extended Photoshop IRB" should be converted to DEBUG messages, too, since they may also appear in a valid split APP13.</p>


	<p>Attached is a patch which solves the problem.</p>


	<p>Greets,<br />Volker</p></div>
    </div>
  </div>
  
  <div id="change-1337" class="journal has-notes">
    <div id="note-18">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-18" class="journal-link">#18</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="13 Jul 2009 08:03" href="/projects/exiv2/activity?from=2009-07-13">over 12 years</a> ago
      <span id="journal-1337-private_notes" class=""></span>
    </h4>

    <div id="journal-1337-notes" class="wiki"><blockquote>

	<p>However, the two other warnings "Invalid or extended Photoshop IRB" should be converted to DEBUG messages, too, since they may also appear in a valid split APP13.</p>


	<p>Attached is a patch which solves the problem.</p>


</blockquote>

	<p>Patch checked-in. Thanks.</p></div>
    </div>
  </div>
  
  <div id="change-1443" class="journal has-details">
    <div id="note-19">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-19" class="journal-link">#19</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="30 Dec 2009 07:50" href="/projects/exiv2/activity?from=2009-12-30">almost 12 years</a> ago
      <span id="journal-1443-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Resolved</i> to <i>Closed</i></li>
    </ul>
    
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/533.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/533.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
