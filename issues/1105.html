<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #1105: exiv2 output is inconsistent and seemingly random 1% of the time - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="qGk67SDcHHqFdbnlT2stq0oFrFtHO8e8XL/itSXaTn1KJJECUqbQetARpunwvCGYdZf4IrbYZgahn3I9ZuOpEg==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #1105: exiv2 output is inconsistent and seemingly random 1% of the time" href="https://dev.exiv2.org/issues/1105.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #1105</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>exiv2 output is inconsistent and seemingly random 1% of the time</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/4495">Daniel Lu</a> <a title="13 Aug 2015 00:33" href="/projects/exiv2/activity?from=2015-08-13">over 6 years</a> ago.
        Updated <a title="21 Aug 2015 08:20" href="/projects/exiv2/activity?from=2015-08-21">over 6 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">not-a-bug</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="28 Apr 2017" href="/versions/52">0.26</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">13 Aug 2015</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">4.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>I ran the following script:</p>


<pre>
#!/bin/bash
for i in `seq 1000`
do
    exiv2 -q DSC01825.jpg | grep 'Image timestamp' &gt;&gt; test2.txt
end
</pre>

	<p>The resulting 1000 lines contains mostly "Image timestamp" with the correct timestamp as desired, but a few lines say instead "Binary file (standard input) matches" (test2.txt attached). This indicates that exiv2 is occasionally outputting certain characters causing grep to think it is a Binary file. But I could see no pattern to this, suggesting that exiv2 is behaving in a flaky way.</p>


	<p>Also, it can't possibly be that my hardware is failing because I also ran sha1sum 1000 times and the output was the same all 1000 times (test3.txt attached).</p>


	<p>I've also uploaded the picture. (DSC01825.jpg attached)</p>


	<p>Using exiv2 0.25 001900 (64 bit build) on Arch Linux (kernel version 4.1.4).</p>


	<p>The picture was taken with a Sony ILCE-7R.</p>


	<p>The expected output of exiv2 should be consistent and not randomly change about 1% of the time.</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/811">test2.txt</a>    <span class="size">(37.1 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/811/test2.txt">test2.txt</a>  </td>
  <td>log of running exiv2 1000 times and then grepping for Image timestamp</td>
  <td>
      <span class="author">Daniel Lu, 13 Aug 2015 00:33</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/812">DSC01825.jpg</a>    <span class="size">(9.66 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/812/DSC01825.jpg">DSC01825.jpg</a>  </td>
  <td>image for which exiv2 output is inconsistent</td>
  <td>
      <span class="author">Daniel Lu, 13 Aug 2015 00:33</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/813">test3.txt</a>    <span class="size">(53.7 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/813/test3.txt">test3.txt</a>  </td>
  <td>sha1sum of DSC01825.jpg</td>
  <td>
      <span class="author">Daniel Lu, 13 Aug 2015 00:33</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>







<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/1105" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="DU+tG/4rHPm5jAHrqZoKjmOkuqRRhEtLVQVzm5snvnzvAgb0jFHQ+ezoHucWTQa9XDbu3aBn6vGoJeMT2B5ZEw==" />
  <table class="list issues odd-even"><tr id="relation-161" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="740" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/740">Bug #740</a>: Error: Offset of directory Sony1, entry 0x2001 is out of bounds: Offset = 0x004a805e; truncating the entry</td><td class="status">Closed</td><td class="start_date">12 Nov 2010</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-162" class="issue hascontextmenu issue tracker-2 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1108" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-2 status-5 priority-4 priority-default closed" href="/issues/1108">Feature #1108</a>: Recursively dump sub-files of an image</td><td class="status">Closed</td><td class="start_date">21 Aug 2015</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/1105/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=1105&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>




<div id="history">
<h3>History</h3>
  <div id="change-3963" class="journal has-notes">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="13 Aug 2015 18:13" href="/projects/exiv2/activity?from=2015-08-13">over 6 years</a> ago
      <span id="journal-3963-private_notes" class=""></span>
    </h4>

    <div id="journal-3963-notes" class="wiki"><p>Nice photo.  Seattle, I think.</p>


	<p>I can't reproduce this on MacOS-X 10.10 (Yosemite), Cygwin, or Linux Ubunutu 15.04 with Exiv2 v0.25 svn=3883 when I use this image: <a class="external" href="http://dev.exiv2.org/attachments/download/805/DSC_7154.jpg">http://dev.exiv2.org/attachments/download/805/DSC_7154.jpg</a></p>


	<p>I can't reproduce this with your file and script on MacOS-X.  I can reproduce this with your file on Ubunutu 15.04 and Cygwin.  However your test file is suspect:<pre>$ for i in {1..300}; do exiv2 -pa -g DateTimeOriginal DSC01825.jpg ; done
Error: Offset of directory Sony1, entry 0x2001 is out of bounds: Offset = 0x00901076; truncating the entry
Exif.Photo.DateTimeOriginal                  Ascii      20  2015:07:09 00:47:56
.....
$ </pre>I don't know what the meaning of the message <em>"Error: Offset of directory...."</em>.</p>


	<p>I've dumped the structure of the file without discovered anything about directory Sony1.<pre>261 rmills@rmillsmbp-k1504:~/temp/foo $ exiv2 -pS DSC01825.jpg 
STRUCTURE OF JPEG FILE: DSC01825.jpg
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xe1 APP1  |   48842 | Exif..II*........... ..........
   48848 | 0xe2 APP2  |     304 | MPF.II*...............0100.....
   49154 | 0xdb DQT   |     132 
   49288 | 0xc4 DHT   |     418 
   49708 | 0xc0 SOF0  |      17 
   49727 | 0xda SOS   |      12 
$ </pre>It's odd that I only get the message on Linux and Cygwin - however both use the GCC compiler.  The Mac compiles with clang.  I've built exiv2 on Linux with clang and that reproduces your fault.  So although this issue can only be reproduced on some platforms, it doesn't appear to be compiler dependent.</p>


	<p>Its unlikely to be a coincidence that the message and the random binary output arrive together on the same platform.  It almost feels like a buffer is not being correctly filled.  <br />I don't see any evidence that exiv2 is not consistent with good files.  The exiv2 test suite would not work if we were producing random results on solid test files.</p>


	<p>However there seems to be something odd about your test file DSC01825.jpg.  I'm not going to pursue that investigation at this time in the hope that somebody else can explain the message.   This matter was reported several years ago <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Error: Offset of directory Sony1, entry 0x2001 is out of bounds: Offset = 0x004a805e; truncating ... (Closed)" href="/issues/740">#740</a>.</p></div>
    </div>
  </div>
  
  <div id="change-3964" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="13 Aug 2015 19:13" href="/projects/exiv2/activity?from=2015-08-13">over 6 years</a> ago
      <span id="journal-3964-private_notes" class=""></span>
    </h4>

    <div id="journal-3964-notes" class="wiki"><p>Solved!</p>


	<p>I've made a couple of interesting discoveries about this:</p>


	<p>1) Meaning of message <em>Offset of directory ...</em><br /><a class="external" href="http://sourceforge.net/p/darktable/mailman/message/29000541/">http://sourceforge.net/p/darktable/mailman/message/29000541/</a></p>


	<p>2) This is only related to the output from exiv2's default output.  (e.g. exiv2 DSC01825.jpg) sometimes producing binary output.</p>


	<p>If I run these commands:<pre>
$ exiv2 -pa -q -g Original DSC01825.jpg;
Exif.Photo.DateTimeOriginal                  Ascii      20  2015:07:09 00:47:56
$ for i in {1..3000}; do exiv2 -pa -q -g Original DSC01825.jpg; done | wc
   3000   15000  240000
$ </pre>I've trapped the culprit with this command:<pre>$ exiv2 -q DSC01825.jpg | nl
     1  File name       : DSC01825.jpg
     2  File size       : 10125312 Bytes
     3  MIME type       : image/jpeg
     4  Image size      : 7360 x 4912
     5  Camera make     : SONY
     6  Camera model    : ILCE-7R
     7  Image timestamp : 2015:07:09 00:47:56
     8  Image number    : 
     9  Exposure time   : 1/10 s
    10  Aperture        : F2.8
    11  Exposure bias   : 0 EV
    12  Flash           : No, compulsory
    13  Flash bias      : 0 EV
    14  Focal length    : 28.0 mm (35 mm equivalent: 28.0 mm)
    15  Subject distance: 
    16  ISO speed       : 800
    17  Exposure mode   : Aperture priority
    18  Metering mode   : Multi-segment
    19  Macro mode      : 
    20  Image quality   : n/a
    21  Exif Resolution : 7360 x 4912
    22  White balance   : Auto
    23  Thumbnail       : image/jpeg, 10408 Bytes
    24  Copyright       : 
    25  Exif comment    : 

$ for i in {1..100};do exiv2 -q DSC01825.jpg | head -24| grep timestamp ; done
Image timestamp : 2015:07:09 00:47:56
Image timestamp : 2015:07:09 00:47:56
...
</pre>There's something binary being written out occasionally in the Exif comment: field.  And when I dump it:<pre>$ exiv2 -q DSC01825.jpg | tail -2 | od -a
0000000   E   x   i   f  sp   c   o   m   m   e   n   t  sp  sp  sp  sp
0000020   :  sp nul nul nul nul nul nul nul nul nul nul nul nul nul nul
0000040 nul nul nul nul nul nul nul nul nul nul nul nul nul nul nul nul
*
0000100 nul nul nul nul nul nul nul nul nul nul  nl  nl
0000114
$</pre>Indeed there are binary bytes!  Why grep is being inconsistent in detecting these binary bytes I do not know.  exiv2 is consistent.  grep is not.  Case Closed.</p>


	<p>I'll update <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Error: Offset of directory Sony1, entry 0x2001 is out of bounds: Offset = 0x004a805e; truncating ... (Closed)" href="/issues/740">#740</a> with the explanation about the error message: <a class="external" href="http://sourceforge.net/p/darktable/mailman/message/29000541/">http://sourceforge.net/p/darktable/mailman/message/29000541/</a></p></div>
    </div>
  </div>
  
  <div id="change-3966" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4495">Daniel Lu</a> <a title="13 Aug 2015 20:06" href="/projects/exiv2/activity?from=2015-08-13">over 6 years</a> ago
      <span id="journal-3966-private_notes" class=""></span>
    </h4>

    <div id="journal-3966-notes" class="wiki"><p>Thanks for investigating. It is odd that GNU grep would behave this way, but it kind of makes sense if the input is piped through stdin. It could be the case that, if exiv2 is running slowly, then grep optimistically prints out matching lines if the input lines are coming in slow enough that grep matches the "Image timestamp" line before receiving the binary bytes at the end. But on fast days, grep receives all the lines at once and summarily decides the whole thing is binary. Not too sure...</p>


	<p>I also tried:</p>


<pre>
exiv2 -q DSC01825.jpg &gt; exif.txt
for i in {1..100}
do
    grep 'Image timestamp' exif.txt &gt;&gt; test4.txt
end
for i in {1..100}
do
    cat exif.txt | grep 'Image timestamp' &gt;&gt; test5.txt
end
</pre>

	<p>and the output is consistent in both test4 and test5: they are all "Binary file (standard input) matches".</p>


	<p>In any case, as a design decision: maybe exiv2 should not print out binary data at all, should there be any binary data present in the EXIF comment. Imagemagick, for example, prints out the byte values as a list of integers between 0 and 255.</p>


<pre>
identify -verbose DSC01825.jpg
</pre>

	<p>By the way, DSC01825.jpg was (as far as I recall) unmodified straight out of camera. Although Sony does not seem to perfectly adhere to EXIF standards, perhaps exiv2 should behave nicer with it.</p>


	<p>And you were right, the photo was taken in Seattle! It's Convention Place Station, actually.</p></div>
    </div>
  </div>
  
  <div id="change-3967" class="journal has-notes">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="13 Aug 2015 21:21" href="/projects/exiv2/activity?from=2015-08-13">over 6 years</a> ago
      <span id="journal-3967-private_notes" class=""></span>
    </h4>

    <div id="journal-3967-notes" class="wiki"><p>Daniel</p>


	<p>Right.  I think we've just about done this to death.  I suspect the grep business has something to do with flushing the pipe - however I'm not going to worry about it.  The Mac provides BSD grep: <pre>521 rmills@rmillsmbp:~/gnu/exiv2/trunk $ grep --version
grep (BSD grep) 2.5.1-FreeBSD
522 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>As you've said, Linux provides GNU grep.<pre>314 rmills@rmillsmbp-k1504:~ $ grep --version
grep (GNU grep) 2.20
Copyright Â© 2014 Free Software Foundation, Inc.
Licence GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Written by Mike Haertel and others, see &lt;http://git.sv.gnu.org/cgit/grep.git/tree/AUTHORS&gt;.
315 rmills@rmillsmbp-k1504:~ $ </pre>I'm sure the code for GNU grep will build on the Mac - however I can't be bothered (it's 22:19 in England and I'm off to bed).</p>


	<p>I've now retired and decided to leave Team Exiv2 in May (after 7 years of working on the project).  So it's up to somebody else to decide if exiv2 should change behaviour.  I'm a little bored this evening and thought your puzzle was interesting.  Having satisfied my curiosity, I'm not going to get involved with any consequential tasks.</p>


	<p>I've been to Seattle many times.  I worked for Adobe and lived in San Jose, CA for 14 years.  It's nice to be home in England.  I miss the weather, but not the drought.</p></div>
    </div>
  </div>
  
  <div id="change-3968" class="journal has-notes">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="14 Aug 2015 01:44" href="/projects/exiv2/activity?from=2015-08-14">over 6 years</a> ago
      <span id="journal-3968-private_notes" class=""></span>
    </h4>

    <div id="journal-3968-notes" class="wiki"><p>Great investigation, Robin, thanks!</p></div>
    </div>
  </div>
  
  <div id="change-3970" class="journal has-notes">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Aug 2015 11:25" href="/projects/exiv2/activity?from=2015-08-14">over 6 years</a> ago
      <span id="journal-3970-private_notes" class=""></span>
    </h4>

    <div id="journal-3970-notes" class="wiki"><p>Thanks, Andreas.  I've made another amazing discovery about this, thanks to a comment by Jeroen in this thread:  <a class="external" href="http://dev.exiv2.org/boards/3/topics/1131">http://dev.exiv2.org/boards/3/topics/1131</a></p>


	<p>The "improper" data in the Sony1 image is the preview.  Here's the proof:</p>


	<p>1 Dump the Structure of DSC01825.jpg<pre>561 rmills@rmillsmbp:~/temp/foo $ exiv2 -pS DSC01825.jpg 
STRUCTURE OF JPEG FILE: DSC01825.jpg
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xe1 APP1  |   48842 | Exif..II*........... ..........
   48848 | 0xe2 APP2  |     304 | MPF.II*...............0100.....
   49154 | 0xdb DQT   |     132 
   49288 | 0xc4 DHT   |     418 
   49708 | 0xc0 SOF0  |      17 
   49727 | 0xda SOS   |      12 
$</pre>2 Extract the APP1 segment into buff.tif and dump that:<pre>562 rmills@rmillsmbp:~/temp/foo $ dd bs=1 skip=12 count=48842 if=DSC01825.jpg of=buff.tif ; exiv2 -pS buff.tif
48842+0 records in
48842+0 records out
48842 bytes transferred in 0.125983 secs (387687 bytes/sec)
STRUCTURE OF TIFF FILE (II): buff.tif
 address |    tag                           |      type |    count |   offset | value
      10 | 0x010e ImageDescription          |     ASCII |       32 |      158 |                                
      22 | 0x010f Make                      |     ASCII |        5 |      190 | SONY
      34 | 0x0110 Model                     |     ASCII |        8 |      196 | ILCE-7R
      46 | 0x0112 Orientation               |     SHORT |        1 |        1 | 1
      58 | 0x011a XResolution               |  RATIONAL |        1 |      204 | 204/0
      70 | 0x011b YResolution               |  RATIONAL |        1 |      212 | 212/0
      82 | 0x0128 ResolutionUnit            |     SHORT |        1 |        2 | 2
      94 | 0x0131 Software                  |     ASCII |       14 |      220 | ILCE-7R v2.00
     106 | 0x0132 DateTime                  |     ASCII |       20 |      234 | 2015:07:09 00:47:56
     118 | 0x0213 YCbCrPositioning          |     SHORT |        1 |        2 | 2
     130 | 0x8769 ExifTag                   |      LONG |        1 |      360 | 360
     142 | 0xc4a5 PrintImageMatching        | UNDEFINED |      106 |      254 |  ...
   38170 | 0x0103 Compression               |     SHORT |        1 |        6 | 6
   38182 | 0x010e ImageDescription          |     ASCII |       32 |    38330 |                                
   38194 | 0x010f Make                      |     ASCII |        5 |    38362 | SONY
   38206 | 0x0110 Model                     |     ASCII |        8 |    38368 | ILCE-7R
   38218 | 0x0112 Orientation               |     SHORT |        1 |        1 | 1
   38230 | 0x011a XResolution               |  RATIONAL |        1 |    38376 | 38376/0
   38242 | 0x011b YResolution               |  RATIONAL |        1 |    38384 | 38384/0
   38254 | 0x0128 ResolutionUnit            |     SHORT |        1 |        2 | 2
   38266 | 0x0131 Software                  |     ASCII |       14 |    38392 | ILCE-7R v2.00
   38278 | 0x0132 DateTime                  |     ASCII |       20 |    38406 | 2015:07:09 00:47:56
   38290 | 0x0201 JPEGInterchangeFormat     |      LONG |        1 |    38426 | 38426
   38302 | 0x0202 JPEGInterchangeFormatLeng |      LONG |        1 |    10408 | 10408
   38314 | 0x0213 YCbCrPositioning          |     SHORT |        1 |        2 | 2
$ </pre>3 Extract the 0x0201 JPEGInterchangeFormat record (of length JPEGInterchangeFormatLength) into buff.jpg and dump that:<pre>563 rmills@rmillsmbp:~/temp/foo $ dd bs=1 skip=38426 count=10408 if=buff.tif of=buff.jpg ; exiv2 -pS buff.jpg 
10408+0 records in
10408+0 records out
10408 bytes transferred in 0.045672 secs (227886 bytes/sec)
STRUCTURE OF JPEG FILE: buff.jpg
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xdb DQT   |     132 
     138 | 0xc4 DHT   |     418 
     558 | 0xc0 SOF0  |      17 
     577 | 0xda SOS   |      12 
</pre>It's a valid little jpg.  Open it.  It's the preview.</p>


	<p>4 Now let's examine the previews:<pre>576 rmills@rmillsmbp:~/temp/foo $ exiv2 -pp  DSC01825.jpg 
Error: Offset of directory Sony1, entry 0x2001 is out of bounds: Offset = 0x00901076; truncating the entry
Preview 1: image/jpeg, 160x120 pixels, 10408 bytes
577 rmills@rmillsmbp:~/temp/foo $ 571 rmills@rmillsmbp:~/temp/foo $ exiv2 --verbose --force -ep1  DSC01825.jpg 
File 1/1: DSC01825.jpg
Error: Offset of directory Sony1, entry 0x2001 is out of bounds: Offset = 0x00901076; truncating the entry
Writing preview 1 (image/jpeg, 160x120 pixels, 10408 bytes) to file ./DSC01825-preview1.jpg</pre>5 DSC01825-preview1.jpg and buff.jpg are identical.<pre>567 rmills@rmillsmbp:~/temp/foo $ 572 rmills@rmillsmbp:~/temp/foo $ ls -alt *.jpg
-rw-r--r--+ 1 rmills  staff     10408 14 Aug 11:44 DSC01825-preview1.jpg
-rw-r--r--@ 1 rmills  staff     10408 14 Aug 11:31 buff.jpg
-rw-r--r--@ 1 rmills  staff  10125312 13 Aug 17:52 DSC01825.jpg
573 rmills@rmillsmbp:~/temp/foo $ diff buff.jpg DSC01825-preview1.jpg 
574 rmills@rmillsmbp:~/temp/foo $ md5 buff.jpg DSC01825-preview1.jpg 
MD5 (buff.jpg) = 4d49a9ce3d980b69bfa129e05483b041
MD5 (DSC01825-preview1.jpg) = 4d49a9ce3d980b69bfa129e05483b041
575 rmills@rmillsmbp:~/temp/foo $ </pre>I'm delighted by this discovery because I've been contemplating buying a Sony Alpha 7 Mirrorless camera and it seems that exiv2 is going to complain about 0x0201 with every image.  Not good.</p>


	<p>I think it would be better for libexiv2 to respect this situation and suppress the warning.  We should however validate the integrity of the situation before deciding to suppress.  It's very likely that some software could rewrite the image and blindly copy/relocate the APP1 segment with the resulting 0x0201 address being wrong.  Exiv2 should report that situation.</p>


	<p>Another reason for being pleased about this discovery is to restore my admiration of Sony.  Yesterday I was thinking "Why have Sony not fixed a bug that has been in their Exif firmware for at least 5 years?".  Now I'm not so sure it's a bug.  The preview is embedded in the APP1 segment.</p>


	<p>And the final reason for being pleased is to see how effectively the -pS option can be used to analyse this file.  I could almost be motivated to add a -pR option to exiv2 to recursively dump subfiles in the image.  Cool stuff, eh?</p></div>
    </div>
  </div>
  
  <div id="change-3980" class="journal has-notes has-details">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="21 Aug 2015 08:05" href="/projects/exiv2/activity?from=2015-08-21">over 6 years</a> ago
      <span id="journal-3980-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> set to <i>not-a-bug</i></li>
       <li><strong>Status</strong> changed from <i>New</i> to <i>Closed</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Target version</strong> set to <i>0.26</i></li>
    </ul>
    <div id="journal-3980-notes" class="wiki"><p>I'm going to close this as "not a bug" and open a feature request to add the option -pR described above.</p></div>
    </div>
  </div>
  
  <div id="change-3981" class="journal has-details">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="21 Aug 2015 08:20" href="/projects/exiv2/activity?from=2015-08-21">over 6 years</a> ago
      <span id="journal-3981-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>0</i> to <i>100</i></li>
       <li><strong>Estimated time</strong> set to <i>4.00 h</i></li>
    </ul>
    
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1105.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1105.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
