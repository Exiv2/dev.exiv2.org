<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #1113: Crash in Exiv2 0.25 - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="Ue0yIA+LAVaCx4IsBmtg3XCAzLZNHMNcaBpcqPxjJnCzoJnPffHNVtejnSC5vGzuTxKYz7z/YuaVOswgv1rBHw==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #1113: Crash in Exiv2 0.25" href="https://dev.exiv2.org/issues/1113.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #1113</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Crash in Exiv2 0.25</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/4464">Harry McKame</a> <a title="31 Aug 2015 16:56" href="/projects/exiv2/activity?from=2015-08-31">about 6 years</a> ago.
        Updated <a title="13 Oct 2015 19:53" href="/projects/exiv2/activity?from=2015-10-13">about 6 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">basicio</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="28 Apr 2017" href="/versions/52">0.26</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">31 Aug 2015</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">4.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>I have succeeded in creating a test case for the crash, which I enclose here.<br />The problem is memory overrun, but I cannot debug it very much for some unknown reason.</p>


	<p>The crash message is :</p>
	<pre><code>Unhandled exception at 0x761dc42d in test.exe: Microsoft C++ exception:<br />  Exiv2::BasicError&amp;lt;char&amp;gt; at memory location OxOleef0cO.</code></pre>


	<p>The enclosed file Eiv2demo.7z was created from the folder C:\Eiv2demo,<br />designed to be stand-alone in the sense of containing as subfolders<br />the exiv2 include, lib and dll files; something you might prefer to change.</p>


	<p>The folder C:\Eiv2demo is the test folder where are stored all executables and data.<br />Its sub-folders are :</p>


	<p>- ReleaseDLL, DebugDLL : the exiv2 .lib files<br />- Include : the exiv2 .h files<br />- Test : The .sln that creates test.exe in C:\Eiv2demo<br />- Interdll : The .sln that creates the interface interdll.dll in C:\Eiv2demo<br />             This DLL does the calls to exiv2.<br />- root folder C:\Eiv2demo : contains test.exe, interdll.dll, the exiv2 dlls and the test image</p>


	<p>What the test program does (as approximation of our product) :</p>


	<p>1. copy the image file 321786_2.jpg to test.jpg (for repeated testing)<br />2. Starts a thread which does the test<br />3. The thread reads all metadata tags from test.jpg, keeping them in memory, except for one tag whose value it changes<br />4. The thread deletes all metadata in test.jpg<br />5. The thread re-creates all the stored tags in global variables containing exiv2 tag-repositories<br />6. The thread assigns these repositories to the image<br />7. The metadata is written to test.jpg (crash happens in the previous step)</p>


	<p>To see the crash before you start debugging, just execute the furnished test.exe.<br />You might like to reset in test.sln and interdll.sln the include and lib folders to yours.</p>


	<p>Remark : I have used Visual Studio 2008.<br />If you wish to convert them to VS2005, perhaps this will help : <a class="external" href="http://stackoverflow.com/a/58286/165358">http://stackoverflow.com/a/58286/165358</a></p>


	<p>Side question: How do I get this website to inform me about changes only to my questions?<br />I tried to set it to Watch, but now I get all messages of everybody, which is quite confusing, and Unwatch doesn't seem to help.</p>


	<p>Thanks in advance.</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/825">Eiv2demo.7z</a>    <span class="size">(6.64 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/825/Eiv2demo.7z">Eiv2demo.7z</a>  </td>
  <td>test program to demo the crash</td>
  <td>
      <span class="author">Harry McKame, 31 Aug 2015 16:56</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/826">Eiv2demo.7z</a>    <span class="size">(5.86 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/826/Eiv2demo.7z">Eiv2demo.7z</a>  </td>
  <td>2nd test program to demo the crash</td>
  <td>
      <span class="author">Harry McKame, 01 Sep 2015 08:48</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>







<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/1113" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="hGaYe2PoSXpZcJ38EUD6ugW6T6nfkopWrkSMbSfmGghmKzOUEZKFegwUgvCul/aJOigb0C5xK+xTZBzlZN/9Zw==" />
  <table class="list issues odd-even"><tr id="relation-176" class="issue hascontextmenu issue tracker-2 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="640" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-2 status-5 priority-4 priority-default closed" href="/issues/640">Feature #640</a>: method is missing in Exiv2 to get list of known XMP namespaces</td><td class="status">Closed</td><td class="start_date">18 Jul 2009</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-177" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="751" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/751">Bug #751</a>: adobe xmp namespace</td><td class="status">Closed</td><td class="start_date">17 Jan 2011</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/1113/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=1113&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>




<div id="history">
<h3>History</h3>
  <div id="change-4161" class="journal has-notes has-details">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="31 Aug 2015 17:08" href="/projects/exiv2/activity?from=2015-08-31">about 6 years</a> ago
      <span id="journal-4161-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> set to <i>basicio</i></li>
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Priority</strong> changed from <i>High</i> to <i>Normal</i></li>
       <li><strong>Target version</strong> set to <i>0.26</i></li>
    </ul>
    <div id="journal-4161-notes" class="wiki"><p>Harry</p>


	<p>I don't know the answer your question about when Redmine sends email.  I believe "Watch" will subscribe you to individual issues and forum topics.</p>


	<p>Can I ask you to simplify this test case.  Whenever possible, it's much easier for me to reproduce your situation if you can demonstrate it with exiv2(.exe) or another sample application.  And if that's not possible, maybe you can modify samples/exifprint.cpp and let me have your "crasher" code - that's so much quicker and easier for me.</p>


	<p>I have all the major editions of Microsoft Visual Studio (2005/8/10 and 12).  Our build server uses 2005 by default.</p></div>
    </div>
  </div>
  
  <div id="change-4162" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4464">Harry McKame</a> <a title="31 Aug 2015 17:13" href="/projects/exiv2/activity?from=2015-08-31">about 6 years</a> ago
      <span id="journal-4162-private_notes" class=""></span>
    </h4>

    <div id="journal-4162-notes" class="wiki"><p>I'll try to simplify it tomorrow as much as I can.</p></div>
    </div>
  </div>
  
  <div id="change-4164" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="31 Aug 2015 20:59" href="/projects/exiv2/activity?from=2015-08-31">about 6 years</a> ago
      <span id="journal-4164-private_notes" class=""></span>
    </h4>

    <div id="journal-4164-notes" class="wiki"><p>Can you check that you are linking debug DLLs everywhere, or release DLLs.  Mixing debug/release DLLs can lead to problems:  <a class="external" href="http://dev.exiv2.org/boards/3/topics/2192">http://dev.exiv2.org/boards/3/topics/2192</a></p></div>
    </div>
  </div>
  
  <div id="change-4166" class="journal has-notes has-details">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4464">Harry McKame</a> <a title="01 Sep 2015 08:48" href="/projects/exiv2/activity?from=2015-09-01">about 6 years</a> ago
      <span id="journal-4166-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/826">Eiv2demo.7z</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/826/Eiv2demo.7z">Eiv2demo.7z</a> added</li>
    </ul>
    <div id="journal-4166-notes" class="wiki"><p>Mixing: I used my own compiled debug DLLs from ..msvc2005\bin\Win32\DebugDLL.<br />I don't believe there was any mixing, but all is possible (Murphy).</p>


	<p>I have managed to simplify the test case a lot.<br />It is now one exe without threads, and all it does is :</p>


	<p>1. store tags in 3 global exiv2 tag-repositories (for iptc, exif and xmp)<br />2. assign these 3 repositories to the image test.jpg (crash happens when assigning xmp)<br />3. write the metadata to test.jpg</p>


	<p>The attached file contains my zipped folder "C:\Eiv2demo".<br />The "Test" sub-folder contains the test solution files, test.exe is linked into C:\Eiv2demo.<br />"DebugDLL" contain the exiv2 debug .lib files.<br />"Include" contains the exiv2 header files.</p></div>
    </div>
  </div>
  
  <div id="change-4167" class="journal has-notes">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="01 Sep 2015 10:42" href="/projects/exiv2/activity?from=2015-09-01">about 6 years</a> ago
      <span id="journal-4167-private_notes" class=""></span>
    </h4>

    <div id="journal-4167-notes" class="wiki"><p>Thanks, Harry.  I'll investigate this evening (I'm in England).  We'll get this fixed today.  I'm 100% confident.</p>


	<p>Just taking a quick "peek" at your code with the editor, I have a few thoughts:</p>


	<p>1) I'm puzzled.  Is there code to initialize list missing?  Possibly a loop over argv or something?  <pre>for (p1list = list;  p1list-&gt;ptag != 0;  p1list++)</pre></p>


	<p>2) The code in SetComment() looks safe enough on quick inspection.</p>


	<p>3) Is it possible to simplify this into a single file and forget about the DLL.  Is there any reason not to put the code from interdll.cpp into test.cpp.  Once we know the code's solid, we can hive it off into a DLL.</p>


	<p>4) Put a try { .... } catch (Exiv2::Error&#38; e) { ... } round main() to get more information about the exception.  Just like in samples/exifprint.cpp:<pre>int main(int argc, char* const argv[])
try {

    if (argc != 2) {
        std::cout &lt;&lt; "Usage: " &lt;&lt; argv[0] &lt;&lt; " file\n";
        return 1;
    }

... deleted ...

    return 0;
}
catch (Exiv2::Error&#38; e) {
    std::cout &lt;&lt; "Caught Exiv2 exception '" &lt;&lt; e.what() &lt;&lt; "'\n";
    return -1;
} </p></pre></div>
    </div>
  </div>
  
  <div id="change-4168" class="journal has-notes">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4464">Harry McKame</a> <a title="01 Sep 2015 11:21" href="/projects/exiv2/activity?from=2015-09-01">about 6 years</a> ago
      <span id="journal-4168-private_notes" class=""></span>
    </h4>

    <div id="journal-4168-notes" class="wiki"><p>Hi Robin,</p>


	<p>1) "list" is a memory structure, whose data is found in the file struct.h, and which is initialized in test.cpp via :<br />#include "struct.h"</p>


	<p>It's an array of struct containing a pair of pointers : { ptag , pvalue }.<br />There are about 171 such pairs in the array, terminated by a null entry.</p>


	<p>2) I have been through that code 1000 times, and it all looks correct.</p>


	<p>3) Already done - no more dll.<br />test.cpp is a trivial program that calls functions in interdll.cpp (the "dll" part is of archaeological interest only).<br />All is in one simple exe.</p>


	<p>4) try-catch will not give a better error message, since this error is not thrown by the exiv2 software.<br />It's a hard memory exception (I would guess because of using a zero pointer), so can only be caught using a debugger.</p>


	<p>If I had to guess, I would say that the xmp code conflicts with iptc/exif, since<br />if I omit the meta-tags with "Iptc.*" and "Exif.*", leaving only "Xmp.*", there is no crash.</p></div>
    </div>
  </div>
  
  <div id="change-4169" class="journal has-notes">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="01 Sep 2015 17:21" href="/projects/exiv2/activity?from=2015-09-01">about 6 years</a> ago
      <span id="journal-4169-private_notes" class=""></span>
    </h4>

    <div id="journal-4169-notes" class="wiki"><p>Fixed.  I added the try .. catch guard and the message was:<pre>Caught Exiv2 exception 'No namespace info available for XMP prefix `illustrator''
Press any key to continue . . .</pre>So I've added calls to registerNs and your code works fine.  Here's the output: <pre>506 rmills@rmillsmbp-w7:/cygdrive/y/Downloads $ exiv2 -pa -g illustrator /cygdrive/c/Eiv2demo/test.jpg
Warning: Directory Thumbnail, entry 0x0201: Data area exceeds data buffer, ignoring it.
Xmp.illustrator.StartupProfile               XmpText     5  Print
507 rmills@rmillsmbp-w7:/cygdrive/y/Downloads $
</pre>And here's the code:<pre>// test.cpp : Defines the entry point for the console application.
//

#ifndef _WIN32_WINNT
#define _WIN32_WINNT 0x0600
#endif

#include &lt;windows.h&gt;

#include &lt;process.h&gt;
#include &lt;stdio.h&gt;
#include &lt;tchar.h&gt;

#include &lt;exiv2/exiv2.hpp&gt;

typedef struct t1list {
  char*  ptag;
  char*  pvalue;
} t1list;
#include "struct.h" 

int     errflag = -1;             /* flag to stop */

extern void EraseComments();
extern int  SetComment(const char * ptag, const char * pvalue);
extern int  PutImageMetaFile(const char * pfilename, char ** perrmsg);

int main(int argc, _TCHAR* argv[])
try {
  t1list  *p1list;
  char    *perrmsg;

  Exiv2::XmpProperties::registerNs("http://clanmills.com/illustrator","illustrator");
  Exiv2::XmpProperties::registerNs("http://clanmills.com/fwc","fwc");
  Exiv2::XmpProperties::registerNs("http://clanmills.com/fwr","fwr");

  EraseComments();
  for (p1list = list;  p1list-&gt;ptag != 0;  p1list++)
    SetComment(p1list-&gt;ptag, p1list-&gt;pvalue);
  errflag = PutImageMetaFile("C:\\Eiv2demo\\test.jpg", &#38;perrmsg);
  return(0);
} catch (Exiv2::Error&#38; e) {
    std::cout &lt;&lt; "Caught Exiv2 exception '" &lt;&lt; e.what() &lt;&lt; "'\n";
    return -1;
}</pre></p>


	<p>Some other points:</p>


	<ol>
	<li>You'll have to modify the include path to exiv2-directory/include to find "&lt;exiv2/exiv2.hppp&gt;</li>
		<li>don't use <a class="external" href="http://clanmills.com/anything">http://clanmills.com/anything</a> as a namespace URI - get the correct URI from Adobe (and fwc/fwr)</li>
		<li>The message about 0x201is usually harmless and caused by incorrect exif data references in the file</li>
	</ol>


	<p>There are more than 60 registered namespaces in libexiv2 and xmpsdk.  You can list them from the command line with <pre>exiv2 --verbose --version -g xmlns</pre>--verbose --version -g grep-pattern has been in Exiv2 for a couple of years, however I only added reporting xmlns a couple of weeks ago.</p>


	<p>It's OK to call registerNs on a preregistered NS provided you use the same prefix and URI.  Better to avoid re-registering namespaces.  We have an API in development for v0.26 for you to obtain a map of the registered namespaces.  <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: method is missing in Exiv2 to get list of known XMP namespaces (Closed)" href="/issues/640">#640</a></p></div>
    </div>
  </div>
  
  <div id="change-4170" class="journal has-notes">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4464">Harry McKame</a> <a title="01 Sep 2015 18:47" href="/projects/exiv2/activity?from=2015-09-01">about 6 years</a> ago
      <span id="journal-4170-private_notes" class=""></span>
    </h4>

    <div id="journal-4170-notes" class="wiki"><p>Robin,</p>


	<p>Thanks very much, but your solution seems to me like highly concentrated black magic.</p>


	<p>My problems are:</p>


	<p>1. The exiv2 command you gave produces only the version number as output.<br />   Without "-g" I get what looks like build options but no namespaces.<br />2. I can't find any documentation or guidelines for using registerNs with xmp<br />3. Why do you registerNs a URL from your family's website? I don't think I should do the same.<br />   And in addition they do not exist.<br />   Specifying dummy URLs to make xmp tags work looks really weird.<br />4. I suppose that the "illustrator" problem is caused by the tag "Xmp.illustrator.StartupProfile",<br />   but how come exiv2 is capable of passing me tags it cannot receive back ?<br />5. How can I avoid the need for specifying namespaces, or what to specify ?<br />   (quote from above : "more than 60 registered namespaces in libexiv2 and xmpsdk" !!)<br />6. If I need to specify URLs for xmp to work, what do I do when the Internet is not available ?</p>


	<p>Any documentation that explains the problem and its solution would be more than appreciated.</p></div>
    </div>
  </div>
  
  <div id="change-4171" class="journal has-notes">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="01 Sep 2015 19:20" href="/projects/exiv2/activity?from=2015-09-01">about 6 years</a> ago
      <span id="journal-4171-private_notes" class=""></span>
    </h4>

    <div id="journal-4171-notes" class="wiki"><p>Harry McKame wrote:</p>


<blockquote>

	<p>2. I can't find any documentation or guidelines for using registerNs with xmp</p>


</blockquote>

	<p><a class="external" href="http://www.exiv2.org/doc/xmpsample_8cpp-example.html">http://www.exiv2.org/doc/xmpsample_8cpp-example.html</a><br /><pre>
// -------------------------------------------------------------------------
    // Register a namespace which Exiv2 doesn't know yet. This is only needed
    // when properties are added manually. If the XMP metadata is read from an
    // image, namespaces are decoded and registered at the same time.
    Exiv2::XmpProperties::registerNs("myNamespace/", "ns");
</pre></p>


	<p>Command line is on this example page: <a class="external" href="http://www.exiv2.org/sample.html">www.exiv2.org/sample.html</a><br /><pre>
# Register a namespace which Exiv2 doesn't know yet with a prefix.
reg ns myNamespace/
</pre></p>


<blockquote>

	<p>3. Why do you registerNs a URL from your family's website? I don't think I should do the same.<br />And in addition they do not exist.<br />Specifying dummy URLs to make xmp tags work looks really weird.</p>


</blockquote>

	<p>Exactly. As Robin said, don't use those dummy sample namespaces, look up the correct ones.</p>


	<p>They are:<br /><pre>
    illustrator = "http://ns.adobe.com/illustrator/1.0/" 
    fwc = "http://ns.fotoware.com/iptcxmp-custom/1.0/" 
    fwr = "http://ns.fotoware.com/iptcxmp-reserved/1.0/" 

</pre></p>


<blockquote>

	<p>6. If I need to specify URLs for xmp to work, what do I do when the Internet is not available ?</p>


</blockquote>

	<p>While XMP namespaces look like URL's, they are actually just a text string. Applications do not actually try to connect to them as URL's, nor is there any requirement for them to actually exist on the Internet. No connectivity is needed.</p>


	<p>XMP stands for "Extensible Metadata Platform". That means it can be and has been extended. Everyone and her sister can and has created their own custom namespace. exiv2 cannot possibly include every obscure namespace on the planet. That is why it has the function to register any unknown namespace on the fly. If you can make a business case for including these namespaces and provide a link to the schema specification, I would be happy to add them to exiv2.</p>


	<p>The XMP specification can be found here: <a class="external" href="http://www.adobe.com/devnet/xmp.html">http://www.adobe.com/devnet/xmp.html</a></p></div>
    </div>
  </div>
  
  <div id="change-4172" class="journal has-notes">
    <div id="note-10">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-10" class="journal-link">#10</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4464">Harry McKame</a> <a title="01 Sep 2015 20:29" href="/projects/exiv2/activity?from=2015-09-01">about 6 years</a> ago
      <span id="journal-4172-private_notes" class=""></span>
    </h4>

    <div id="journal-4172-notes" class="wiki"><p>Alan,</p>


	<p>Thanks for your answer. I apologize for still being mystified.</p>


	<p>You say :<br />"While XMP namespaces look like URL's, they are actually just a text string. Applications do not actually try to connect to them as URL's, nor is there any requirement for them to actually exist on the Internet. No connectivity is needed."</p>


	<p>So why does exiv2 crash in weird ways if these useless strings are not specified?<br />(small remark: It really should terminate more gracefully. Putting every call in try-catch is cumbersome.)</p>


	<p>I have written XMP-processing software, and I understand that knowledge of the schema is required to process the tags.<br />It is still strange to me that by specifying a non-existent schema Robin managed to get it working.<br />I will see what comes out of his code, but a correct XMP packet needs its RDF.</p>


	<p>This raises new questions:</p>


	<p>1. If the namespaces are never actually read, where does the RDF come from when adding XMP to an image that doesn't have it?<br />   How can exiv2 work correctly without a schema unless it's built-in (and which schemata are built-in) ?<br />2. How can I detect which XMP tag is problematic before adding it to Exiv2::XmpData ?<br />3. Do I always need to call readMetadata() before calling writeMetadata() ?</p></div>
    </div>
  </div>
  
  <div id="change-4173" class="journal has-notes">
    <div id="note-11">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-11" class="journal-link">#11</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="01 Sep 2015 20:34" href="/projects/exiv2/activity?from=2015-09-01">about 6 years</a> ago
      <span id="journal-4173-private_notes" class=""></span>
    </h4>

    <div id="journal-4173-notes" class="wiki"><p>Thanks to Alan for answering most of Harry's questions.  It only looks like magic.  I assure you that it isn't.  And please believe I have not attempted to confuse you.</p>


<blockquote>

	<p>1. The exiv2 command you gave produces only the version number as output.<br />Without "-g" I get what looks like build options but no namespaces.</p>


</blockquote>

	<p>I only added the xmlns output recently to exiv2 --verbose --version  (<a class="changeset" title="exiv2 -vV lists registered Namespaces.  #640 and topic 2169 http://dev.exiv2.org/boards/3/topics/..." href="/projects/exiv2/repository/exiv2/revisions/3891">r3891</a>).  I'll post the output from the current trunk (<a class="changeset" title="#640 and # 751.  Fixing linux build-breaker." href="/projects/exiv2/repository/exiv2/revisions/3916">r3916</a>) below.</p>


<blockquote>

	<p>2. I can't find any documentation or guidelines for using registerNs with xmp</p>


</blockquote>

	<p>I think Alan has answered this.</p>


<blockquote>

	<p>3. Why do you registerNs a URL from your family's website? I don't think I should do the same.<br />And in addition they do not exist.<br />Specifying dummy URLs to make xmp tags work looks really weird.</p>


</blockquote>

	<p>It's not a URL, its a URI.  URL = uniform resource <strong>location</strong> URI = uniform resource <strong>indentifier</strong>.  <a class="external" href="https://en.wikipedia.org/wiki/Uniform_resource_identifier">https://en.wikipedia.org/wiki/Uniform_resource_identifier</a></p>


	<p>This is "bread-and-butter" XML.  I made up something unique to get your code to work, and, although I know about illustrator, I didn't know fwc and fwr.  I wanted to alert you to this and instead confused you.   Prefixes such as "illustrator" have a standard definition defined by Adobe.  You should always use the standard definition.</p>


<blockquote>

	<p>4. I suppose that the "illustrator" problem is caused by the tag "Xmp.illustrator.StartupProfile",<br />but how come exiv2 is capable of passing me tags it cannot receive back ?</p>


</blockquote>

	<p>If you have a file that has embedded XMP, it can contain XML such as:<br />&lt;xmlns:illustrator="http://...adobe...."&gt;</p>


	<p>The &lt;xmlns:prefix="URI"&gt; syntax is standard XML.  When the XMP is read (by the Adobe XMPsdk which is compiled into libexiv2), it will register the illustrator namespace dynamically.  Once registered, XMPsdk (and so libexiv2) respects that namespace.  So, although "illustrator" isn't in the pre-registered namespaces, exiv2 can emit Xmp.illustrator keys.</p>


	<p>I suspect you obtained the code in your file struct.h from output from exiv2.exe -pa one-of-your-test files.jpg.  Indeed, that file <em>one-of-your-test files.jpg</em> will contain&lt;xmlns:illustrator="http://...adobe..."&gt;.  To push the Xmp.illustrator.something key into your file test.jpg, you need to register the namespace.  This isn't a "strange little way of libexiv2", its XML.  You must register a namespace to use it.</p>


<blockquote>

	<p>5. How can I avoid the need for specifying namespaces, or what to specify ?<br />(quote from above : "more than 60 registered namespaces in libexiv2 and xmpsdk" !!)</p>


</blockquote>

	<p>The point I'm making is that we have quite a number if namespaces built into libexiv2 which you can you use.  For example:<pre>
955 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -vV -g microsoft
exiv2 0.25 001900 (64 bit build)
xmlns=MP:http://ns.microsoft.com/photo/1.2/
xmlns=MPRI:http://ns.microsoft.com/photo/1.2/t/RegionInfo#
xmlns=MPReg:http://ns.microsoft.com/photo/1.2/t/Region#
xmlns=MicrosoftPhoto:http://ns.microsoft.com/photo/1.0/
xmlns=expressionmedia:http://ns.microsoft.com/expressionmedia/1.0/
956 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>We have photoshop:<pre>956 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -vV -g photoshop
exiv2 0.25 001900 (64 bit build)
xmlns=photoshop:http://ns.adobe.com/photoshop/1.0/
957 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>Surprisingly, we don't have illustrator.  Why not?  Nobody knows.  I doubt if my buddies at Adobe can explain that either.  Remember, we're building libexiv2 above Adobe XMPsdk and Adobe didn't include illustrator.</p>


<blockquote>

	<p>6. If I need to specify URLs for xmp to work, what do I do when the Internet is not available ?</p>


</blockquote>

	<p>The namespace prefix/URI is standard XML syntax.  It doesn't require a connection to the internet.</p>


	<p>One final point.  This might seem like some kind of magic.  It's supported magic.  Alan and I and other members of Team Exiv2 are here and willing to help you learn about metadata and libexiv2.  We didn't invent any of this.  We are confident that our technology and support will help you achieve your goals.</p>


	<p>Here's the promised output from r3916:<pre>958 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -vV -g xmlns -g svn
exiv2 0.25 001900 (64 bit build)
svn=3916
xmlns=DICOM:http://ns.adobe.com/DICOM/
xmlns=GPano:http://ns.google.com/photos/1.0/panorama/
xmlns=Iptc4xmpCore:http://iptc.org/std/Iptc4xmpCore/1.0/xmlns/
xmlns=MP:http://ns.microsoft.com/photo/1.2/
xmlns=MPRI:http://ns.microsoft.com/photo/1.2/t/RegionInfo#
xmlns=MPReg:http://ns.microsoft.com/photo/1.2/t/Region#
xmlns=MicrosoftPhoto:http://ns.microsoft.com/photo/1.0/
xmlns=acdsee:http://ns.acdsee.com/iptc/1.0/
xmlns=album:http://ns.adobe.com/album/1.0/
xmlns=asf:http://ns.adobe.com/asf/1.0/
xmlns=aux:http://ns.adobe.com/exif/1.0/aux/
xmlns=bmsp:http://ns.adobe.com/StockPhoto/1.0/
xmlns=creatorAtom:http://ns.adobe.com/creatorAtom/1.0/
xmlns=crs:http://ns.adobe.com/camera-raw-settings/1.0/
xmlns=dc:http://purl.org/dc/elements/1.1/
xmlns=dcterms:http://purl.org/dc/terms/
xmlns=digiKam:http://www.digikam.org/ns/1.0/
xmlns=dwc:http://rs.tdwg.org/dwc/index.htm
xmlns=exif:http://ns.adobe.com/exif/1.0/
xmlns=exifEX:http://cipa.jp/exif/1.0/
xmlns=expressionmedia:http://ns.microsoft.com/expressionmedia/1.0/
xmlns=iX:http://ns.adobe.com/iX/1.0/
xmlns=iptcExt:http://iptc.org/std/Iptc4xmpExt/2008-02-29/
xmlns=jp2k:http://ns.adobe.com/jp2k/1.0/
xmlns=jpeg:http://ns.adobe.com/jpeg/1.0/
xmlns=kipi:http://www.digikam.org/ns/kipi/1.0/
xmlns=lr:http://ns.adobe.com/lightroom/1.0/
xmlns=mediapro:http://ns.iview-multimedia.com/mediapro/1.0/
xmlns=mwg-kw:http://www.metadataworkinggroup.com/schemas/keywords/
xmlns=mwg-rs:http://www.metadataworkinggroup.com/schemas/regions/
xmlns=pdf:http://ns.adobe.com/pdf/1.3/
xmlns=pdfaExtension:http://www.aiim.org/pdfa/ns/extension/
xmlns=pdfaField:http://www.aiim.org/pdfa/ns/field#
xmlns=pdfaProperty:http://www.aiim.org/pdfa/ns/property#
xmlns=pdfaSchema:http://www.aiim.org/pdfa/ns/schema#
xmlns=pdfaType:http://www.aiim.org/pdfa/ns/type#
xmlns=pdfaid:http://www.aiim.org/pdfa/ns/id/
xmlns=pdfx:http://ns.adobe.com/pdfx/1.3/
xmlns=pdfxid:http://www.npes.org/pdfx/ns/id/
xmlns=photoshop:http://ns.adobe.com/photoshop/1.0/
xmlns=plus:http://ns.useplus.org/ldf/xmp/1.0/
xmlns=png:http://ns.adobe.com/png/1.0/
xmlns=rdf:http://www.w3.org/1999/02/22-rdf-syntax-ns#
xmlns=stArea:http://ns.adobe.com/xmp/sType/Area#
xmlns=stDim:http://ns.adobe.com/xap/1.0/sType/Dimensions#
xmlns=stEvt:http://ns.adobe.com/xap/1.0/sType/ResourceEvent#
xmlns=stFnt:http://ns.adobe.com/xap/1.0/sType/Font#
xmlns=stJob:http://ns.adobe.com/xap/1.0/sType/Job#
xmlns=stMfs:http://ns.adobe.com/xap/1.0/sType/ManifestItem#
xmlns=stRef:http://ns.adobe.com/xap/1.0/sType/ResourceRef#
xmlns=stVer:http://ns.adobe.com/xap/1.0/sType/Version#
xmlns=tiff:http://ns.adobe.com/tiff/1.0/
xmlns=wav:http://ns.adobe.com/xmp/wav/1.0/
xmlns=xml:http://www.w3.org/XML/1998/namespace
xmlns=xmp:http://ns.adobe.com/xap/1.0/
xmlns=xmpBJ:http://ns.adobe.com/xap/1.0/bj/
xmlns=xmpDM:http://ns.adobe.com/xmp/1.0/DynamicMedia/
xmlns=xmpG:http://ns.adobe.com/xap/1.0/g/
xmlns=xmpGImg:http://ns.adobe.com/xap/1.0/g/img/
xmlns=xmpMM:http://ns.adobe.com/xap/1.0/mm/
xmlns=xmpNote:http://ns.adobe.com/xmp/note/
xmlns=xmpRights:http://ns.adobe.com/xap/1.0/rights/
xmlns=xmpT:http://ns.adobe.com/xap/1.0/t/
xmlns=xmpTPg:http://ns.adobe.com/xap/1.0/t/pg/
xmlns=xmpidq:http://ns.adobe.com/xmp/Identifier/qual/1.0/
959 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre></p></div>
    </div>
  </div>
  
  <div id="change-4174" class="journal has-notes">
    <div id="note-12">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-12" class="journal-link">#12</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="01 Sep 2015 20:40" href="/projects/exiv2/activity?from=2015-09-01">about 6 years</a> ago
      <span id="journal-4174-private_notes" class=""></span>
    </h4>

    <div id="journal-4174-notes" class="wiki"><p>rdf is pre-registered by the library:<pre>959 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -vV -g rdf
exiv2 0.25 001900 (64 bit build)
xmlns=rdf:http://www.w3.org/1999/02/22-rdf-syntax-ns#
960 rmills@rmillsmbp:~/gnu/exiv2/trunk $</pre>I think your test program does terminate gracefully when gruarded by try .. catch.  Sadly, you refused to follow my guidance on this subject.</p>


	<p>This technology is built using contemporary C++ STL code.  Throwing exceptions is part of that environment.</p></div>
    </div>
  </div>
  
  <div id="change-4175" class="journal has-notes">
    <div id="note-13">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-13" class="journal-link">#13</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="01 Sep 2015 20:45" href="/projects/exiv2/activity?from=2015-09-01">about 6 years</a> ago
      <span id="journal-4175-private_notes" class=""></span>
    </h4>

    <div id="journal-4175-notes" class="wiki"><p>I found the namespaces for your file by running the command: <br /><pre>
exiv2 -eX 321786_2.jpg
</pre><br />and then reading the resulting xmp sidecar file in a text editor. The XMP file contains the correct namespace URI's.</p>


	<p>I did a quick search on the Interwebs and did not find the schemas for illustrator nor for fotoware.</p></div>
    </div>
  </div>
  
  <div id="change-4176" class="journal has-details">
    <div id="note-14">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-14" class="journal-link">#14</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="01 Sep 2015 21:43" href="/projects/exiv2/activity?from=2015-09-01">about 6 years</a> ago
      <span id="journal-4176-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Closed</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>100</i></li>
       <li><strong>Estimated time</strong> set to <i>4.00 h</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-4177" class="journal has-notes">
    <div id="note-15">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-15" class="journal-link">#15</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4464">Harry McKame</a> <a title="02 Sep 2015 09:02" href="/projects/exiv2/activity?from=2015-09-02">about 6 years</a> ago
      <span id="journal-4177-private_notes" class=""></span>
    </h4>

    <div id="journal-4177-notes" class="wiki"><p>Alan, Robin : Thanks for your answers and the wealth of information that they contain.</p>


	<p>Note: None of your examples for exiv2.exe works for the release in exiv2-0.25-win.zip. Is it because I don't have Cygwin installed?</p>


	<p>Robin:<br />I assure you that our production code is protected by try-catch. I wasn't aware that uncaught exceptions cause such weird crashes.<br />I also confirm that with your dummy namespaces the test program works and the generated xmp is even correct.</p>


	<p>So big question 1: Why do you crash when an unknown namespace is found?<br />Evidently, exiv2 can handle simple cases with its default code, so why not just invent a namespace string, say "http://dev.exiv2.org/illustrator", and just go on?</p>


	<p>Until you do that, question 2: How can I detect which XMP tag is problematic before adding it to Exiv2::XmpData and before it crashes setXmpData() ?</p>


	<p>FYI, our current use of Exiv2 is to replace software I have written for read/write of XMP, IPTC &#38; EXIF. Yours is much more general and much better, although mine handles unknown namespaces without crashing - ;)</p></div>
    </div>
  </div>
  
  <div id="change-4178" class="journal has-notes">
    <div id="note-16">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-16" class="journal-link">#16</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="02 Sep 2015 11:11" href="/projects/exiv2/activity?from=2015-09-02">about 6 years</a> ago
      <span id="journal-4178-private_notes" class=""></span>
    </h4>

    <div id="journal-4178-notes" class="wiki"><p>Don't use the dummy namespaces, use the official ones.</p>


<pre>
    illustrator = "http://ns.adobe.com/illustrator/1.0/" 
    fwc = "http://ns.fotoware.com/iptcxmp-custom/1.0/" 
    fwr = "http://ns.fotoware.com/iptcxmp-reserved/1.0/" 
</pre></div>
    </div>
  </div>
  
  <div id="change-4179" class="journal has-notes">
    <div id="note-17">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-17" class="journal-link">#17</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4464">Harry McKame</a> <a title="02 Sep 2015 11:21" href="/projects/exiv2/activity?from=2015-09-02">about 6 years</a> ago
      <span id="journal-4179-private_notes" class=""></span>
    </h4>

    <div id="journal-4179-notes" class="wiki"><p>Alan, sure I will, but this is just one image out of potentially hundreds of thousands coming from multiple sources.</p>


	<p>I'm interested in a robust solution that will withstand anything I can throw at it, while still doing its job as much as possible, which is why I posted my above 2 questions.</p></div>
    </div>
  </div>
  
  <div id="change-4180" class="journal has-notes">
    <div id="note-18">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-18" class="journal-link">#18</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="02 Sep 2015 12:16" href="/projects/exiv2/activity?from=2015-09-02">about 6 years</a> ago
      <span id="journal-4180-private_notes" class=""></span>
    </h4>

    <div id="journal-4180-notes" class="wiki"><p>Q1.  The reason, I suggested adding try/catch was because of the message:<pre>Unhandled exception at 0x761dc42d in test.exe: Microsoft C++ exception:
  Exiv2::BasicError&lt;char&gt;; at memory location OxOleef0cO.</pre>Sure, Microsoft are angry.  However they caught an exception from Exiv2.</p>


	<p>I believe the exception is originally thrown by the Adobe XMPsdk<pre>984 rmills@rmillsmbp:~/gnu/exiv2/trunk $ grep -H Throw xmpsdk/src/*.cpp | grep -i unregistered
xmpsdk/src/XMPCore_Impl.cpp:        XMP_Throw ( "Unregistered schema namespace URI", kXMPErr_BadSchema );
985 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>libexiv2 catches and throws an Exiv2 exception.<pre>971 rmills@rmillsmbp:~/gnu/exiv2/trunk $ grep 'namespace info' src/*.cpp
src/error.cpp:        { 35, N_("No namespace info available for XMP prefix `%1'") }, // %1=prefix
972 rmills@rmillsmbp:~/gnu/exiv2/trunk $ grep -H throw src/*.cpp | grep 35
src/properties.cpp:        if (!xn) throw Error(35, prefix);
$ </pre>Because you haven't caught the exception, your program falls back on a Microsoft exception handler.  By that time, your application stack or heap has been erased and all hell lets loose.  It looks catastrophic.  However they correctly identified that the exception was thrown by Exiv2.</p>


	<p>Q2.  You can catch the exception, register a namespace and try again.  However the Adobe SDK does <em><strong>NOT</strong></em> do that.  libexiv2 does <em><strong>NOT</strong></em> do that.  However you can if you wish.  <em>A word of caution however:</em>  If you're going to invent URIs for unregistered namespaces and publish those files elsewhere, you could create chaos.</p>


	<p>Adobe changed a prefix from xap to xmp and it has caused trouble (for us and others).  It's very important to get the prefix/URI correct if anybody in the universe can access your file.  <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: adobe xmp namespace (Closed)" href="/issues/751">#751</a></p>


<hr />


	<p>Throwing Exceptions is the C++/STL error mechanism (SEH = Structured Exception Handling.).  I personally much prefer returning error codes.  I've seldom found an engineer who agrees with my dislike of try/catch/throw.</p>


<hr />


	<p>I strongly encourage you to adopt libexiv2.  The success of metadata workflows depends on standards compliant code to read and <em>more importantly <strong>write</strong></em> metadata.  Metadata <em><strong>write</strong></em> bugs will destroy workflows.  Work with us because our code is mature, robust, cross-platform, tested, supported and actively developed.  Alan and I and the rest of Team Exiv2 don't earn 1¢ from working on this project, so we're not motivated by self-interest.  When we all work together, everybody gains.   In software (1+1)==3</p></div>
    </div>
  </div>
  
  <div id="change-4181" class="journal has-notes">
    <div id="note-19">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-19" class="journal-link">#19</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4464">Harry McKame</a> <a title="02 Sep 2015 12:39" href="/projects/exiv2/activity?from=2015-09-02">about 6 years</a> ago
      <span id="journal-4181-private_notes" class=""></span>
    </h4>

    <div id="journal-4181-notes" class="wiki"><p>Robin,</p>


	<p>For Q2: When my program sees a key and a value, and before it does :<br />  gxmpData[ptag] = pvalue;<br />is there some way to find out if ptag belongs to an unknown schema?</p>


	<p>If I can do that, I can recover from the error.</p></div>
    </div>
  </div>
  
  <div id="change-4182" class="journal has-notes">
    <div id="note-20">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-20" class="journal-link">#20</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="02 Sep 2015 15:21" href="/projects/exiv2/activity?from=2015-09-02">about 6 years</a> ago
      <span id="journal-4182-private_notes" class=""></span>
    </h4>

    <div id="journal-4182-notes" class="wiki"><p>The simple way is to catch the exception:<pre>try {
  gxmpData[ptag] = pvalue;
} catch (Exiv2::Error&#38; e .... ) {
  if ( e something ) { // e tells you the name of the unregistered namespace
    XmpProperties::registerNs(a,b);
    gxmpData[ptag] = pvalue;
  }
} </pre></p>


	<p>Usually XMP tags are something like:<pre>Xmp.illustrator.StartupProfile</pre>In this case the <em>namespace prefix</em> is <strong>illustrator</strong>.  However, namespaces can exist deeper in the key.  For example:<pre>Xmp.xmpMM.History[4]/stEvt:action</pre>Uses the <em>namespace prefix</em> <strong>xmpMM</strong> and <em>namespace prefix</em> <strong>stEvt</strong> (both of which are preregistered):<pre>1008 rmills@rmillsmbp:~/Downloads/Eiv2demo $ exiv2 -vV -g xmpMM -g stEvt
exiv2 0.25 001900 (64 bit build)
xmlns=stEvt:http://ns.adobe.com/xap/1.0/sType/ResourceEvent#
xmlns=xmpMM:http://ns.adobe.com/xap/1.0/mm/
1009 rmills@rmillsmbp:~/Downloads/Eiv2demo $</pre>So the code has to allow for multiple exceptions to be thrown as several namespaces may be required.  Something like this (<em><strong>Caution</strong></em> untested) code:<pre>int  tries     = 0 ;
bool try_again = true ;
while ( try_again &#38;&#38; tries++ &lt; 100) {
 try_again = false ;
 try {
   gxmp[ptag] = pvalue ;
 } catch (Exiv2::error&#38; e) {
  if ( e something ) { // e tells you the name of the unregistered namespace
    XmpProperties::registerNs(a,b);
    try_again=true;
  }
 }
}</pre></p></div>
    </div>
  </div>
  
  <div id="change-4183" class="journal has-details">
    <div id="note-21">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-21" class="journal-link">#21</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="02 Sep 2015 15:26" href="/projects/exiv2/activity?from=2015-09-02">about 6 years</a> ago
      <span id="journal-4183-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Closed</i> to <i>Resolved</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-4184" class="journal has-notes">
    <div id="note-22">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-22" class="journal-link">#22</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="02 Sep 2015 16:11" href="/projects/exiv2/activity?from=2015-09-02">about 6 years</a> ago
      <span id="journal-4184-private_notes" class=""></span>
    </h4>

    <div id="journal-4184-notes" class="wiki"><p>Whoops.  I didn't answer your question about Cygwin/exiv2-0.25-win.zip  I've never looked in that bundle.  I think it is cross compiled for MinGW, so it should accept Dos filenames.  However, I think you may need to \\ the path separators or something.  For example: exiv2 -pa c:\\Eiv2Demo\\test.jpg</p>


I think it's better to build your own binaries.
	<ul>
	<li>If you're working in DOS/cmd.exe, build with msvc2005 (which builds with Visual Studio 2005/2008/10/12)</li>
		<li>If you're working in Cygwin (which I highly recommend), build with ./configure or CMake.</li>
		<li>If you're working in MinGW (which I don't recommend), build with ./configure.</li>
	</ul>


	<p>My hesitation with MinGW is lack of experience with that system and not a criticism of MinGW.  I only started supporting MinGW during the last 12 months.</p></div>
    </div>
  </div>
  
  <div id="change-4185" class="journal has-notes">
    <div id="note-23">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-23" class="journal-link">#23</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4464">Harry McKame</a> <a title="02 Sep 2015 16:39" href="/projects/exiv2/activity?from=2015-09-02">about 6 years</a> ago
      <span id="journal-4185-private_notes" class=""></span>
    </h4>

    <div id="journal-4185-notes" class="wiki"><p>Robin,</p>


	<p>I think I have now all I need to continue advancing with Exiv2.</p>


	<p>Thank you for your heroic support.</p></div>
    </div>
  </div>
  
  <div id="change-4186" class="journal has-notes">
    <div id="note-24">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-24" class="journal-link">#24</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="03 Sep 2015 14:09" href="/projects/exiv2/activity?from=2015-09-03">about 6 years</a> ago
      <span id="journal-4186-private_notes" class=""></span>
    </h4>

    <div id="journal-4186-notes" class="wiki"><p>You're welcome.</p>


	<p>Here's the bill:  You go to open hub:  <a class="external" href="https://www.openhub.net/p/exiv2">https://www.openhub.net/p/exiv2</a>, register (it's free) and click "I use this" for Exiv2 and give me some kudos.  Or gimme some endorsements on LinkedIn.</p></div>
    </div>
  </div>
  
  <div id="change-4187" class="journal has-notes">
    <div id="note-25">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-25" class="journal-link">#25</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4464">Harry McKame</a> <a title="03 Sep 2015 17:57" href="/projects/exiv2/activity?from=2015-09-03">about 6 years</a> ago
      <span id="journal-4187-private_notes" class=""></span>
    </h4>

    <div id="journal-4187-notes" class="wiki"><p>I don't use much LinkedIn, but bill paid in full on OpenHUB, where I even posted the first review for Exiv2 (your name is there).</p>


	<p>For the moment everything works fine, although the C++ framework is a bit restrictive. I have had to change our processing workflow to make it work with your design concepts.</p>


	<p>The GPLv2 license is another problem. No idea why do you need or care for a restrictive license. We ourselves are months away from publishing this version of our software, so we will handle that when the time comes (currently using our own product).</p></div>
    </div>
  </div>
  
  <div id="change-4188" class="journal has-notes">
    <div id="note-26">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-26" class="journal-link">#26</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="03 Sep 2015 18:53" href="/projects/exiv2/activity?from=2015-09-03">about 6 years</a> ago
      <span id="journal-4188-private_notes" class=""></span>
    </h4>

    <div id="journal-4188-notes" class="wiki"><p>Thanks.  And very nice review.  Nice to be thanked by name.  There's a thing called Kudos on OpenHub - you can press the button on my Open Hub Page:  <a class="external" href="https://www.openhub.net/p/13985/contributors/60065117754297">https://www.openhub.net/p/13985/contributors/60065117754297</a>  Nobody's ever given me kudos.  I don't expect it to be painful for either of us.</p>


	<p>I'm surprised by your comment about C++.  Perhaps we can discuss this further in a new thread on the forum.  I was a Senior Computer Scientist at Adobe and all of Adobe's "core" libraries are C++ (search your copy of Adobe Reader for dlls/frameworks).  I've never encountered a situation where a C++/DLL was an obstacle in product integration.  All the common languages: perl, python, java, .Net, COM/DCOM have ways to call C++ libraries.</p>


	<p>I don't know anything about GPLv2.  Andreas, the project founder, set that up for Open Source use of libexiv2.  If you have a commercial product, you can purchase a commercial license for Exiv2 and, as I understand it, your product will be totally free of any relationship to GPLv2.  Andreas will provide details and cost (it's not expensive).</p>


	<p>In providing support for Exiv2, it makes no difference to me if you are using an Open Source or Commercial License.  I don't get paid in any way for the work I do for Exiv2.</p></div>
    </div>
  </div>
  
  <div id="change-4189" class="journal has-notes">
    <div id="note-27">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-27" class="journal-link">#27</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="03 Sep 2015 20:01" href="/projects/exiv2/activity?from=2015-09-03">about 6 years</a> ago
      <span id="journal-4189-private_notes" class=""></span>
    </h4>

    <div id="journal-4189-notes" class="wiki"><p>Thanks, Harry.  I got the Kudos on OpenHUB.  Painless for me at least.  Much appreciated.</p></div>
    </div>
  </div>
  
  <div id="change-4390" class="journal has-details">
    <div id="note-28">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-28" class="journal-link">#28</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="13 Oct 2015 19:53" href="/projects/exiv2/activity?from=2015-10-13">about 6 years</a> ago
      <span id="journal-4390-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Resolved</i> to <i>Closed</i></li>
    </ul>
    
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1113.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1113.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
