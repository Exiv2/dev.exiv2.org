<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #888: (near-)infinite loop in video decoders - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="LZQsDa7z6+4vsDEtiHdHknfJ5/XbFzuJTxEw6Mv+fLTP2Yfi3Ikn7nrULiE3oEuhSFuzjCr0mjOyMaBgiMeb2w==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #888: (near-)infinite loop in video decoders" href="https://dev.exiv2.org/issues/888.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #888</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>(near-)infinite loop in video decoders</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/3772">Alyssa Milburn</a> <a title="10 Mar 2013 16:02" href="/projects/exiv2/activity?from=2013-03-10">over 8 years</a> ago.
        Updated <a title="24 Jul 2013 15:09" href="/projects/exiv2/activity?from=2013-07-24">over 8 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/3290">Abhinav Badola</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">-</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="31 Jul 2013" href="/versions/50">0.24</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">10 Mar 2013</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value"></div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>If I hand RiffVideo::nikonTagsHandler() data with a size value &lt;4, then it subtracts 4 from it (riffvideo.cpp:745 at the time of writing)<br />and will loop for a very long time. I guess you could cause a similar effect by messing with the size value subtracted on line 751.</p>


	<p>The attached file can be used as a testcase.</p>


	<p>You can do a similar trick with AsfVideo::decodeBlock (which will loop forever if given size==0).</p>


	<p>I don't know if you care about these kind of bugs. If you do, at a glance it looks like might be some other candidates for similar issues, at least on 32-bit platforms, such as jpgimage.cpp:187 (by overflowing the position if long is 32 bits), and psdimage.cpp:241/242 (by using a large value for resourceSize).</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/460">infiniteloop.riff</a>    <span class="size">(64 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/460/infiniteloop.riff">infiniteloop.riff</a>  </td>
  <td></td>
  <td>
      <span class="author">Alyssa Milburn, 10 Mar 2013 16:02</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>








</div>




<div id="history">
<h3>History</h3>
  <div id="change-2414" class="journal has-details">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/3290">Abhinav Badola</a> <a title="10 Mar 2013 16:04" href="/projects/exiv2/activity?from=2013-03-10">over 8 years</a> ago
      <span id="journal-2414-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Assignee</strong> set to <i>Abhinav Badola</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-2415" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/3290">Abhinav Badola</a> <a title="10 Mar 2013 16:10" href="/projects/exiv2/activity?from=2013-03-10">over 8 years</a> ago
      <span id="journal-2415-private_notes" class=""></span>
    </h4>

    <div id="journal-2415-notes" class="wiki"><p>Thank you Alyssa for reporting the crash.</p>


	<p>Indeed it is a quite a notorious bug.<br />I will look into the matter asap and patch the video code accordingly.</p></div>
    </div>
  </div>
  
  <div id="change-2416" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/3290">Abhinav Badola</a> <a title="11 Mar 2013 01:19" href="/projects/exiv2/activity?from=2013-03-11">over 8 years</a> ago
      <span id="journal-2416-private_notes" class=""></span>
    </h4>

    <div id="journal-2416-notes" class="wiki"><p>Hi Alyssa,<br />I looked into the problem, and this is what I observed. Please correct me if I may have missed some point.</p>


	<p>The file that you provided with the issue seems to have been generated manually. (<strong>I really appreciate the effort.</strong>)<br />But it seems that the file doesn't follow the RIFF standard specification.</p>


	<p>I am saying this, because when I run the exiv2 utility while debugging the Video File, this is what I got as the size.</p>


	<p>Tag  = NCDT<br />Size = 153428472</p>


	<p>The size is not turning out to be zero, as such.<br />I guess this is the reason for the long run of the loop that you specified, "and will loop for a very long time".<br />This simply means that it is trying to subtract 4 recursively from the size, and will definitely take time.</p>


	<p>I guess this problem should not occur, if the file has proper fields according to the RIFF standards.</p>


	<p>Please can you send a link or upload a proper RIIF or ASF file which would produce a similar effect.</p></div>
    </div>
  </div>
  
  <div id="change-2417" class="journal has-notes">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/3772">Alyssa Milburn</a> <a title="11 Mar 2013 02:38" href="/projects/exiv2/activity?from=2013-03-11">over 8 years</a> ago
      <span id="journal-2417-private_notes" class=""></span>
    </h4>

    <div id="journal-2417-notes" class="wiki"><p>Sorry, if you don't care about bugs caused by invalid data, these bugs are irrelevant. That's why I said "I don't know if you care about these kind of bugs". Various projects are using libexiv2 right now for reading metadata on files which may have been downloaded from the internet, for example, so trusting input files sounds like a bad idea.</p></div>
    </div>
  </div>
  
  <div id="change-2418" class="journal has-notes">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="11 Mar 2013 07:27" href="/projects/exiv2/activity?from=2013-03-11">over 8 years</a> ago
      <span id="journal-2418-private_notes" class=""></span>
    </h4>

    <div id="journal-2418-notes" class="wiki"><p>Thanks for reporting this issue, Alyssa. We do care about such things; making sure Exiv2 behaves well for any kind of input is a challenge that we have accepted. We have many checks to avoid issues with corrupted (or 'doctored') images in the more mature code and we'll be happy to add more. The video metadata support on the other hand is relatively new and has not been exposed to as many problematic files, so it may not be quite as stable.</p>


	<p>Abhinav, see e.g., tiffvisitor.cpp for examples of sanity checks and how they are typically handled. Generally, if we detect an anomaly, we issue a warning, make sure the process doesn't fail (e.g., by skipping the suspicious section) and continue parsing as much of the remaining metadata as possible. Below is an example from this file. Without having looked at the reported case in detail, it sounds like a similar check might be possible to avoid processing unreasonably large values and avoid the reported issue(s). As you program more, it will become a reflex to consider "what if" scenarios and document your assumptions (e.g., using assert) in your code routinely, so that many such cases (never all) will be taken care of from the beginning.</p>


<pre>
        // Sanity check with an "unreasonably" large number
        if (n &gt; 256) {
#ifndef SUPPRESS_WARNINGS
            EXV_ERROR &lt;&lt; "Directory " &lt;&lt; groupName(object-&gt;group()) &lt;&lt; " with " 
                      &lt;&lt; n &lt;&lt; " entries considered invalid; not read.\n";
#endif
            return;
        }
</pre></div>
    </div>
  </div>
  
  <div id="change-2419" class="journal has-notes">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/3290">Abhinav Badola</a> <a title="11 Mar 2013 08:21" href="/projects/exiv2/activity?from=2013-03-11">over 8 years</a> ago
      <span id="journal-2419-private_notes" class=""></span>
    </h4>

    <div id="journal-2419-notes" class="wiki"><p>Thank you Alyssa and Andreas for your valuable feedback.<br />I will fix the errors asap.</p></div>
    </div>
  </div>
  
  <div id="change-2426" class="journal has-notes has-details">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/3290">Abhinav Badola</a> <a title="13 Mar 2013 14:54" href="/projects/exiv2/activity?from=2013-03-13">over 8 years</a> ago
      <span id="journal-2426-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>0</i> to <i>50</i></li>
    </ul>
    <div id="journal-2426-notes" class="wiki"><p>Hi Alyssa,</p>


	<p>I have applied some patches in the latest revision <strong>R2996</strong> and <strong>R2997</strong>.<br />I have tested thoroughly on my local machine, and now the code seems to be working fine.</p>


	<p>Whenever you get time, please confirm if the bug is solved at your end as well.<br />Once I have your confirmation, I will be closing this issue and marking it as solved.</p>


	<p>Thank you for your patience and support in making Video Code better.</p></div>
    </div>
  </div>
  
  <div id="change-2470" class="journal has-details">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/3290">Abhinav Badola</a> <a title="05 May 2013 04:45" href="/projects/exiv2/activity?from=2013-05-05">over 8 years</a> ago
      <span id="journal-2470-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>New</i> to <i>Resolved</i></li>
       <li><strong>% Done</strong> changed from <i>50</i> to <i>100</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-2511" class="journal has-notes has-details">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Jul 2013 15:09" href="/projects/exiv2/activity?from=2013-07-24">over 8 years</a> ago
      <span id="journal-2511-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Target version</strong> set to <i>0.24</i></li>
    </ul>
    <div id="journal-2511-notes" class="wiki"><p>Fixed in 0.24.</p></div>
    </div>
  </div>
  
  <div id="change-2512" class="journal has-notes has-details">
    <div id="note-10">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-10" class="journal-link">#10</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Jul 2013 15:09" href="/projects/exiv2/activity?from=2013-07-24">over 8 years</a> ago
      <span id="journal-2512-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Resolved</i> to <i>Closed</i></li>
    </ul>
    <div id="journal-2512-notes" class="wiki"><p>Fixed in 0.24.</p></div>
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/888.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/888.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
