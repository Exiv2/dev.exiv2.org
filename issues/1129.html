<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #1129: Different behaviour of exiv2 between remote and local file. - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="eZQ18p76zAoVUPUsRtixM9CSdvBFGh+57jT47UE7A0Ob2Z4d7IAACkA06iD5D70A7wAiibT5vgMTFGhlAgLkLA==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #1129: Different behaviour of exiv2 between remote and local file." href="https://dev.exiv2.org/issues/1129.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #1129</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Different behaviour of exiv2 between remote and local file.</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="12 Oct 2015 19:50" href="/projects/exiv2/activity?from=2015-10-12">about 6 years</a> ago.
        Updated <a title="06 Dec 2015 21:01" href="/projects/exiv2/activity?from=2015-12-06">almost 6 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">tiff parser</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="28 Apr 2017" href="/versions/52">0.26</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">12 Oct 2015</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">2.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>This issue has surfaced during discussion of <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Division by zero / crash on malformed input file (Closed)" href="/issues/1080">#1080</a>.</p>


	<p>The file exiv2 -pa <a class="external" href="http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg">http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg</a> behaves differently when local.<pre>690 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pa http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg
Exiv2 exception in print action for file http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg:
Failed to read image data
691 rmills@rmillsmbp:~/gnu/exiv2/trunk $ curl http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg | exiv2 -pa -
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  4404    0  4404    0     0  45235      0 --:--:-- --:--:-- --:--:-- 46851
Error: Directory Image: Next pointer is out of bounds; ignored.
Warning: Directory Image, entry 0x3030 has unknown Exif (TIFF) type 12336; setting type size 1.
Error: Directory Image, entry 0x3030 has invalid size 808464432*1; skipping entry.
... hundreds of similar lines deleted ...
Error: Directory Image, entry 0x3030 has invalid size 808464432*1; skipping entry.
Warning: JPEG format error, rc = 5
Exif.Image.ExifTag                           Long        1  217
Floating point exception: 8
692 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>Curiously, the file appears to corrupt and is diagnosed consistently with option -pS<pre>694 rmills@rmillsmbp:~/gnu/exiv2/trunk $ curl http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg | exiv2 -pS -
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  4404    0  4404    0     0  60926      0 --:--:-- --:--:-- --:--:-- 63826
STRUCTURE OF JPEG FILE: 1444679207.exiv2_temp
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xe1 APP1  |    4400 | Exif..MM.*.....00000000000000000
    4404 | 0xffffffff ?HU?Exiv2 exception in print action for file -:
This does not look like a JPEG image
695 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>The floating point exception reported by the local file is the subject of <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Division by zero / crash on malformed input file (Closed)" href="/issues/1080">#1080</a>.</p>


	<p>The scope of this issue is to investigate why FileIo and HttpIo result in different output with option -pa.</p>
  </div>
</div>






<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/1129" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="mgOd0lHR1isJbhLWBqluwjOSLDQBTIgMfnDUWLPKl1p4TjY9I6saK1wKDdq5fmLxDAB4TfCvKbaDUETQ8PNwNQ==" />
  <table class="list issues odd-even"><tr id="relation-184" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1080" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/1080">Bug #1080</a>: Division by zero / crash on malformed input file</td><td class="status">Closed</td><td class="start_date">13 May 2015</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/1129/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=1129&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 3991" href="/projects/exiv2/repository/exiv2/revisions/3991">Revision 3991</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/3991/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="13 Oct 2015 21:19" href="/projects/exiv2/activity?from=2015-10-13">about 6 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Different behaviour of exiv2 between remote and local file. (Closed)" href="/issues/1129">#1129</a>.  Fix submitted.</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-4385" class="journal has-notes">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="12 Oct 2015 20:10" href="/projects/exiv2/activity?from=2015-10-12">about 6 years</a> ago
      <span id="journal-4385-private_notes" class=""></span>
    </h4>

    <div id="journal-4385-notes" class="wiki"><pre>699 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pS http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg
STRUCTURE OF JPEG FILE: http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xe1 APP1  |    4400 | Exif..MM.*.....00000000000000000
    4404 | 0xffffffff q$V?Exiv2 exception in print action for file http://dev.exiv2.org/attachments/download/786/exiv2-divzero.jpg:
This does not look like a JPEG image
700 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre></div>
    </div>
  </div>
  
  <div id="change-4394" class="journal has-notes has-details">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="13 Oct 2015 21:19" href="/projects/exiv2/activity?from=2015-10-13">about 6 years</a> ago
      <span id="journal-4394-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Resolved</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>100</i></li>
       <li><strong>Estimated time</strong> set to <i>2.00 h</i></li>
    </ul>
    <div id="journal-4394-notes" class="wiki"><p>Fix submitted: <a class="changeset" title="#1129.  Fix submitted." href="/projects/exiv2/repository/exiv2/revisions/3991">r3991</a></p>


	<p>This is a very interesting bug.  It's caused by different semantics of eof() in the classes RemoteIo and FileIo.</p>


	<p>In jpgimage.cpp#365 in function jpegBase::ReadMetadata(), we have:<pre>                io_-&gt;read(rawExif.pData_, rawExif.size_);
                if (io_-&gt;error() || io_-&gt;eof()) throw Error(14);</pre>RemoteIo::eof() returns true when every byte in the file has been read.  class FileIo is a wrapper for the standard "C" FILE pointer and FileIo::eof() returns feof(f) != 0.  However feof(f) only returns > 0 when there has been an attempt to read past the end-of-file.  This is an artefact of the stdio.h implementation.  The function feof(f) returns the status of the EOF bit which is only set when an attempt to read beyond the final byte is requested. That every byte in the file has been consumed is not understood/respected by feof(f).</p>


	<p>My fix makes RemoteIo and FileIo consistent as follows:<pre>    bool FileIo::eof() const
    {
        assert(p_-&gt;fp_ != 0);
        return feof(p_-&gt;fp_) != 0 || tell() &gt;= size() ;
    }</pre>The test suite fails on bugfixes-test.sh bug=480 in largeiptc-test.cpp in the following code:<pre>    Exiv2::DataBuf buf(io.size());
    std::cout &lt;&lt; "Reading " &lt;&lt; buf.size_ &lt;&lt; " bytes from " &lt;&lt; data &lt;&lt; "\n";
    io.read(buf.pData_, buf.size_);
    if (io.error() || io.eof()) throw Exiv2::Error(14);</pre>This code reads the complete file into memory and throws if the file is at EOF.  However, I've modified the semantics of eof() to report true when the whole file has been read.  The fix for largeiptc-test.cpp is to require eof() to be true:<pre>    Exiv2::DataBuf buf(io.size());
    std::cout &lt;&lt; "Reading " &lt;&lt; buf.size_ &lt;&lt; " bytes from " &lt;&lt; data &lt;&lt; "\n";
    io.read(buf.pData_, buf.size_);
    if (io.error() || !io.eof()) throw Exiv2::Error(14);</pre>And now we pass the test suite.</p>


	<p>I am a little nervous of this change as we are changing the semantics of basicio::eof().  The documentation <a class="external" href="http://www.exiv2.org/doc/classExiv2_1_1BasicIo.html">http://www.exiv2.org/doc/classExiv2_1_1BasicIo.html</a> states:<pre>Returns true if the IO position has reached the end, otherwise false.</pre>I believe my RemoteIo implementation is totally correct and FileIo should be modified to implement this definition.</p>


	<p>The messages from local fileio such as:<pre>Error: Directory Image, entry 0x3030 has invalid size 808464432*1; skipping entry.
... hundreds of similar lines deleted ...
Error: Directory Image, entry 0x3030 has invalid size 808464432*1; skipping entry.</pre>are totally bogus and coming from TiffParser.  We shouldn't be in TiffParser.  The file is corrupt and jpegBase::ReadMetadata() now behaves correctly by throwing for both local and remote files.</p>


	<p>There is a English typo in the documentation generated from basicio.hpp and has been fixed.</p></div>
    </div>
  </div>
  
  <div id="change-4526" class="journal has-details">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="06 Dec 2015 21:01" href="/projects/exiv2/activity?from=2015-12-06">almost 6 years</a> ago
      <span id="journal-4526-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Resolved</i> to <i>Closed</i></li>
    </ul>
    
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1129.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1129.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
