<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #1360: exiv2 can&#39;t read metadata from tiff file (tiff directory length is too large) - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="PS73MzaFEDRze7nwrIo3aTGZ7voV8Z10oNJS6lmvdyffY1zcRP/cNCYfpvwTXTtaDgu6g+QSPM5d8sJiGpaQSA==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #1360: exiv2 can&#39;t read metadata from tiff file (tiff directory length is too large)" href="https://dev.exiv2.org/issues/1360.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #1360</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>exiv2 can&#39;t read metadata from tiff file (tiff directory length is too large)</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/4008">T Modes</a> <a title="16 Jul 2018 18:49" href="/projects/exiv2/activity?from=2018-07-16">over 3 years</a> ago.
        Updated <a title="17 Jul 2018 17:32" href="/projects/exiv2/activity?from=2018-07-17">over 3 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">tiff parser</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="28 Dec 2018" href="/versions/55">0.27</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">16 Jul 2018</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">1.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>I currently experiment with RAW conversion and stumbled about a strange issue in exiv2 (using as exiv2 as library, but also reproducible with the exiv2 command line tool):</p>


	<p>RAW file from Panasonic (.rw2 file): exiv2 reads fine.<br />JPG file converted from this RAW file (inclusive metadata): exiv2 reads fine.<br />but<br />TIFF file converted from the same RAW file (also inclusive metadata): exiv2 can't read any metadata:</p>


	<p><code>exiv2.exe test.tif<br />Exiv2 exception in print action for file test.tif:<br />tiff directory length is too large</code></p>


	<p>(tiffinfo, exiftool and image viewer have no problem with this file.)</p>


	<p>I will attach a small test file which shows the error.</p>


	<p>I tracked it down to the makernotes. When I remove the makernotes in the TIFF file with exiftool, exiv2 can read the file again.</p>


	<p>Ideally exiv2 should also read the makernotes also from the TIFF (because it works fine for JPEG).<br />Or as a workaround would it possible to skip the makernotes tag and issue a warning only instead of an exception and skipping the whole file?</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1235">test.tif</a>    <span class="size">(8.59 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1235/test.tif">test.tif</a>  </td>
  <td></td>
  <td>
      <span class="author">T Modes, 16 Jul 2018 18:49</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>








</div>




<div id="history">
<h3>History</h3>
  <div id="change-6226" class="journal has-notes has-details">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="16 Jul 2018 21:25" href="/projects/exiv2/activity?from=2018-07-16">over 3 years</a> ago
      <span id="journal-6226-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> set to <i>tiff parser</i></li>
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Target version</strong> set to <i>0.27</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>50</i></li>
       <li><strong>Estimated time</strong> set to <i>1.00 h</i></li>
    </ul>
    <div id="journal-6226-notes" class="wiki"><p>Thanks for bringing this to your attention.  And thank you for providing such a clear explanation of your situation.</p>


	<p>Good News.  I have a fix.</p>


	<p>In v0.26, I added 10 lines of code to Exiv2 that I wish I had not added.  I'd like you to remove 4 lines and I think you'll be happy.</p>


<pre>
diff --git a/src/rw2image.cpp b/src/rw2image.cpp
index c252fba0..6b3ec444 100644
--- a/src/rw2image.cpp
+++ b/src/rw2image.cpp
@@ -126,8 +126,8 @@ namespace Exiv2 {
             throw Error(kerNotAnImage, "RW2");
         }
         clearMetadata();
-        std::ofstream devnull;
-        printStructure(devnull, kpsRecursive, 0);
+        //std::ofstream devnull;
+        //printStructure(devnull, kpsRecursive, 0);
         ByteOrder bo = Rw2Parser::decode(exifData_,
                                          iptcData_,
                                          xmpData_,
diff --git a/src/tiffimage.cpp b/src/tiffimage.cpp
index c256b904..efcdda67 100644
--- a/src/tiffimage.cpp
+++ b/src/tiffimage.cpp
@@ -183,8 +183,8 @@ namespace Exiv2 {

         // recursively print the structure to /dev/null to ensure all metadata is in memory
         // must be recursive to handle NEFs which stores the raw image in a subIFDs
-        std::ofstream devnull;
-        printStructure(devnull,kpsRecursive);
+        //std::ofstream devnull;
+        //printStructure(devnull,kpsRecursive);
         ByteOrder bo = TiffParser::decode(exifData_,
                                           iptcData_,
                                           xmpData_,
</pre>Let me know how that works for you and I'll give you more explanation tomorrow.</div>
    </div>
  </div>
  
  <div id="change-6227" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4008">T Modes</a> <a title="17 Jul 2018 15:25" href="/projects/exiv2/activity?from=2018-07-17">over 3 years</a> ago
      <span id="journal-6227-private_notes" class=""></span>
    </h4>

    <div id="journal-6227-notes" class="wiki"><p>Thanks for the fast feedback. I can confirm: with your patch it works fine for me.</p></div>
    </div>
  </div>
  
  <div id="change-6228" class="journal has-notes has-details">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="17 Jul 2018 17:32" href="/projects/exiv2/activity?from=2018-07-17">over 3 years</a> ago
      <span id="journal-6228-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Closed</i></li>
       <li><strong>% Done</strong> changed from <i>50</i> to <i>100</i></li>
    </ul>
    <div id="journal-6228-notes" class="wiki"><p>Thanks for the update.  I've known about the issues introduced by this for about one year.  However, fixing this in 'master' causes the test harness changes involving binary files.  Those changes cause 'master' to bloat (become fat).  We're rewriting the test suite for v0.27.</p>


	<p>For sure the changes above (and similar in cr2image.cpp, crwimage.cpp and orfimage.cpp) will be included in v0.27</p>


<pre>
502 rmills@rmillsmbp:~/gnu/github/exiv2/exiv2 $ grep -l devnull src/*.cpp
src/cr2image.cpp
src/crwimage.cpp
src/orfimage.cpp
src/rw2image.cpp
src/tiffimage.cpp
503 rmills@rmillsmbp:~/gnu/github/exiv2/exiv2 $ </pre></div>
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1360.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1360.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
