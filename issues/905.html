<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #905: Exiv2 does not run on Windows Vista - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="ozbKRd4inVyg6Iv1873m7p3kDhGMuIYJTUXrJicr0htBe2GqrFhRXPWMlPlMaurdonZaaH1bJ7OwZXuuZBI1dA==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #905: Exiv2 does not run on Windows Vista" href="https://dev.exiv2.org/issues/905.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #905</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Exiv2 does not run on Windows Vista</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/2456">Daniel Kaneider</a> <a title="04 Jun 2013 01:26" href="/projects/exiv2/activity?from=2013-06-04">over 8 years</a> ago.
        Updated <a title="21 Jun 2015 16:42" href="/projects/exiv2/activity?from=2015-06-21">over 6 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">build</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="17 May 2015" href="/versions/51">0.25</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">04 Jun 2013</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">4.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>Hi,</p>


	<p>we got reports that our application did not work on Windows Vista, getting an error message like <br /><pre>
The procedure entry point K32EnumProcessModules could not be located in the dynamic link library KERNEL32.dll
</pre><br />and we tracked down the problem to the exiv2 library. The problem just turns up, if the compilation is done with newer versions of the Windows SDK. We actually did the compilation on Win8 with VS2012.</p>


Documentations on the problem:
	<ul>
	<li><a href="http://blogs.msdn.com/b/vcblog/archive/2009/08/27/windows-sdk-v7-0-v7-0a-incompatibility-workaround.aspx" class="external">Visual C++ Team Blog</a></li>
		<li><a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms682631%28v=vs.85%29.aspx" class="external">EnumProcessModules function</a> (look at the Requirements/library section)</li>
	</ul>


Possible solutions that developers using exiv2 must be aware of:
	<ul>
	<li>Define <em>PSAPI_VERSION=1</em> during compilation of exiv2 (maybe optional)</li>
		<li>Define _<em>WIN32_WINNT=0x501</em> (not that recommended)</li>
		<li>Remove the usage of EnumProcessModules from the <em>version.cpp</em> file</li>
	</ul>


	<p>I suggest the first solution by adding the definition to CMake.</p>


	<p>Best,<br />Daniel</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/507">exiv2.patch</a>    <span class="size">(391 Bytes)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/507/exiv2.patch">exiv2.patch</a>  </td>
  <td></td>
  <td>
      <span class="author">Daniel Kaneider, 09 Jun 2013 08:34</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>








</div>




<div id="history">
<h3>History</h3>
  <div id="change-2482" class="journal has-notes has-details">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="08 Jun 2013 21:04" href="/projects/exiv2/activity?from=2013-06-08">over 8 years</a> ago
      <span id="journal-2482-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> set to <i>build</i></li>
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Estimated time</strong> set to <i>4.00 h</i></li>
    </ul>
    <div id="journal-2482-notes" class="wiki"><p>Daniel</p>


	<p>Thanks for reporting this.  An interesting issue.  This is a run-time error, so compiler switches are of limited value.  Sure, if you build and run on the same machine, this will work fine.  However if the build has been performed on W7, Vista will be unable to find the desired entry point and exiv2.exe will refuse to load and execute.</p>


	<p>I've thought of three ways to solve this:<br />1) delay-load PSAPI and avoid EnumProcessModules when the host-os is Vista<br />2) remove references to PSAPI in version.cpp and the build environments<br />3) get version.cpp to call LoadLibrary/GetProcAddress explicitly (and forgive failure)</p>


	<p>The reason version.cpp uses PSAPI was introduced by the command exiv2 --verbose --version. This is used by test/build-test.py to determine libraries loaded at run time. Other build information is also reported.</p>


	<p>I think the best/simplest solution is 3) LoadLibrary/GetProcAddress.  The consequence is that Vista will not enumerate loaded libraries.  I'll also modify/build-test.py to say "Vista doesn't know what's in his brain!".  I'm on sabbatical until mid-July, so I'm unable to test and submit this fix at present.</p>


	<p>As you are building with Visual Studio, you could do the following in version.cpp</p>


	<p>1) Comment off the linking psapi (around line 110)<br />// tell MSVC to link psapi.<br />#ifdef  _MSC_VER<br />//#pragma comment( lib, "psapi" )<br />#endif</p>


	<p>2) Dummy out dumpLibraryInfo (around line 140):</p>


	<p>EXIV2API void dumpLibraryInfo(std::ostream&#38; os)
{<br />return;<br />}</p>


	<p>This change will have no affect on the run-time performance/functionality of exiv2 executables and libraries (other than to throttle the output from exiv2 -v -V).</p>


	<p>Robin</p></div>
    </div>
  </div>
  
  <div id="change-2483" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/2456">Daniel Kaneider</a> <a title="09 Jun 2013 03:00" href="/projects/exiv2/activity?from=2013-06-09">over 8 years</a> ago
      <span id="journal-2483-private_notes" class=""></span>
    </h4>

    <div id="journal-2483-notes" class="wiki"><p>Well, the runtime error is caused by compiling with specific flags. If you look at the psapi.h header file you can see that Microsoft allows to downlevel the psapi version. It should suffice by adding</p>


<pre>
ADD_DEFINITIONS(-DPSAPI_VERSION=1)
</pre>

	<p>to the exiv2 main CMakeList file at around line 75. This means that the library compiled on Win8 should definitely work on WinVista. I did so, and could see using Depends that the K32 symbol didn't get used anymore. Instead, the same symbols from the psapi.dll were used.</p>


	<p>Best,<br />Daniel</p></div>
    </div>
  </div>
  
  <div id="change-2484" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="09 Jun 2013 06:54" href="/projects/exiv2/activity?from=2013-06-09">over 8 years</a> ago
      <span id="journal-2484-private_notes" class=""></span>
    </h4>

    <div id="journal-2484-notes" class="wiki"><ul>
	<li>Thanks, Daniel.  I'm very pleased that you've got this working.  You said in the report:</li>
	</ul>


	<p><em>'I suggest the first solution by adding the definition to CMake.'</em></p>


	<p>Did you put something into one of the CMake*.txt files, or an argument on the Cmake command?</p></div>
    </div>
  </div>
  
  <div id="change-2485" class="journal has-notes has-details">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/2456">Daniel Kaneider</a> <a title="09 Jun 2013 08:34" href="/projects/exiv2/activity?from=2013-06-09">over 8 years</a> ago
      <span id="journal-2485-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/507">exiv2.patch</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/507/exiv2.patch">exiv2.patch</a> added</li>
    </ul>
    <div id="journal-2485-notes" class="wiki"><p>Just to be clear</p></div>
    </div>
  </div>
  
  <div id="change-2486" class="journal has-notes">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="09 Jun 2013 22:27" href="/projects/exiv2/activity?from=2013-06-09">over 8 years</a> ago
      <span id="journal-2486-private_notes" class=""></span>
    </h4>

    <div id="journal-2486-notes" class="wiki"><p>Thank you, Daniel.</p>


	<p>I'm unable to submit the patch at the moment.  I don't know if this is because there's something wrong with the SVN server on dev.exiv2.org, or the internet connection from my vacation hotel in Utah.  I'll try to submit this at my next stop in Colorado.</p>


	<p>This fix is fine for the CMake build and I'll update the msvc/msvc64 build environments once I am home in July.</p></div>
    </div>
  </div>
  
  <div id="change-2487" class="journal has-notes">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="10 Jun 2013 09:29" href="/projects/exiv2/activity?from=2013-06-10">over 8 years</a> ago
      <span id="journal-2487-private_notes" class=""></span>
    </h4>

    <div id="journal-2487-notes" class="wiki"><p>Submitted: <a class="changeset" title="Issue:#905.  Thank you Daniel for the patch." href="/projects/exiv2/repository/exiv2/revisions/3049">r3049</a>.</p></div>
    </div>
  </div>
  
  <div id="change-2567" class="journal has-notes has-details">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Jul 2013 15:49" href="/projects/exiv2/activity?from=2013-07-24">over 8 years</a> ago
      <span id="journal-2567-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Target version</strong> changed from <i>0.24</i> to <i>0.25</i></li>
    </ul>
    <div id="journal-2567-notes" class="wiki"><p>The MSVC build implications of this issue are being deferred for 0.25.</p></div>
    </div>
  </div>
  
  <div id="change-2932" class="journal has-notes has-details">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="07 Oct 2014 20:10" href="/projects/exiv2/activity?from=2014-10-07">about 7 years</a> ago
      <span id="journal-2932-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Resolved</i></li>
    </ul>
    <div id="journal-2932-notes" class="wiki"><p>I'm going to mark this as "Resolved".  I think Daniel's patch is perfect for CMake builds and I thought I would have to make similar/parallel changes for msvc/msvc2005/msvc2012 build environments.  I've been using Vista/64 on a VM on my Mac Book Pro for 1 year and it builds and runs the test suite without trouble using the CMake and/or Visual Studio environments.  So, unless Daniel knows otherwise, I think this is resolved.</p></div>
    </div>
  </div>
  
  <div id="change-3641" class="journal has-details">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="08 May 2015 16:24" href="/projects/exiv2/activity?from=2015-05-08">over 6 years</a> ago
      <span id="journal-3641-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>0</i> to <i>100</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-3922" class="journal has-details">
    <div id="note-10">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-10" class="journal-link">#10</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="21 Jun 2015 16:42" href="/projects/exiv2/activity?from=2015-06-21">over 6 years</a> ago
      <span id="journal-3922-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Resolved</i> to <i>Closed</i></li>
    </ul>
    
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/905.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/905.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
