<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #1253: After setting LensModel, Lightroom no longer recognizes image - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="OOPTNtV4B0LEiNKtklTAVB/Kw+l5ZHzW9vvvzo22oYnarnjZpwLLQpHszaEtg8xnIFiXkIiH3WwL239Gzo9G5g==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #1253: After setting LensModel, Lightroom no longer recognizes image" href="https://dev.exiv2.org/issues/1253.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #1253</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>After setting LensModel, Lightroom no longer recognizes image</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/4840">Martin Stolle</a> <a title="13 Nov 2016 15:07" href="/projects/exiv2/activity?from=2016-11-13">about 5 years</a> ago.
        Updated <a title="17 Nov 2016 12:53" href="/projects/exiv2/activity?from=2016-11-17">about 5 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">makernote</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="28 Apr 2017" href="/versions/52">0.26</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">13 Nov 2016</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">20.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>Hi,</p>


	<p>I have a manual lens and am using exiv to set the LensModel afterwards:</p>
	<pre><code>exiv2 -M "set Exif.Photo.FocalLength Rational 75/10" -M "set Exif.Photo.LensModel Ascii Samyang 7.5mm F/3.5 UMC Fish-eye MFT"  mo "$image"</code></pre>


	<p>While geeqie and exiftool show the new lens information, Lightroom refuses to import such images.  Looking at a diff of the tags, there is a suspicious change of size of MakerNoteOlympus2 and of datatypes for a couple of IFD sections.</p>


	<p>I have attached before and after raw files.</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1106">20161113-114050_pb132546.orf</a>    <span class="size">(13.5 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1106/20161113-114050_pb132546.orf">20161113-114050_pb132546.orf</a>  </td>
  <td>before modifying metadata</td>
  <td>
      <span class="author">Martin Stolle, 13 Nov 2016 15:07</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1107">20161113-114050_pb132546_tagged.orf</a>    <span class="size">(13.2 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1107/20161113-114050_pb132546_tagged.orf">20161113-114050_pb132546_tagged.orf</a>  </td>
  <td>after modifying metadata</td>
  <td>
      <span class="author">Martin Stolle, 13 Nov 2016 15:07</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1108">20161113-114050_pb132546_exiftool.orf</a>    <span class="size">(13.2 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1108/20161113-114050_pb132546_exiftool.orf">20161113-114050_pb132546_exiftool.orf</a>  </td>
  <td></td>
  <td>
      <span class="author">Martin Stolle, 13 Nov 2016 17:58</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>







<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/1253" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="F9BZ99N1caTZtYvbQJ/mExo8R+j40E1P+ty8XDV1eUX1nfIYoQ+9pIzRlNf/SOogJa4TkQkz7PUH/CzUdkyeKg==" />
  <table class="list issues odd-even"><tr id="relation-256" class="issue hascontextmenu issue tracker-1 status-1 priority-4 priority-default"><td class="checkbox"><input type="checkbox" name="ids[]" value="1255" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-1 priority-4 priority-default" href="/issues/1255">Bug #1255</a>: ORF MakerNote incorrectly re-written</td><td class="status">New</td><td class="start_date">17 Nov 2016</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-0"><tr><td style="width: 100%;" class="todo"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/1253/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=1253&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>




<div id="history">
<h3>History</h3>
  <div id="change-5742" class="journal has-notes">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4840">Martin Stolle</a> <a title="13 Nov 2016 15:07" href="/projects/exiv2/activity?from=2016-11-13">about 5 years</a> ago
      <span id="journal-5742-private_notes" class=""></span>
    </h4>

    <div id="journal-5742-notes" class="wiki"><p>version of exiv2 used: exiv2 0.25 001900 (64 bit build)  (Ubuntu 16.04)</p></div>
    </div>
  </div>
  
  <div id="change-5743" class="journal has-notes has-details">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="13 Nov 2016 15:49" href="/projects/exiv2/activity?from=2016-11-13">about 5 years</a> ago
      <span id="journal-5743-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> set to <i>makernote</i></li>
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Target version</strong> set to <i>0.26</i></li>
    </ul>
    <div id="journal-5743-notes" class="wiki"><p>This sounds painful for you and for me.  Thanks for attaching the images.  A couple of questions:</p>


	<p>1) Which version of LR are you using?<br />2) Have you been able to successfully assign the Lens with any other metadata tool such as ExifTool or Adobe Bridge?</p>


	<p>I'll look at this later today.  It's nice sunny afternoon in England and I'm dealing with the leaves in the garden at the moment.</p></div>
    </div>
  </div>
  
  <div id="change-5744" class="journal has-notes has-details">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4840">Martin Stolle</a> <a title="13 Nov 2016 17:58" href="/projects/exiv2/activity?from=2016-11-13">about 5 years</a> ago
      <span id="journal-5744-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/1108">20161113-114050_pb132546_exiftool.orf</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/1108/20161113-114050_pb132546_exiftool.orf">20161113-114050_pb132546_exiftool.orf</a> added</li>
    </ul>
    <div id="journal-5744-notes" class="wiki"><p>I was able to add the same information with the following exiftool command:</p>
	<pre><code>exiftool -FocalLength=75/10 -LensModel="Samyang 7.5mm F/3.5 UMC Fish-eye MFT" 20161113-114050_pb132546_exiftool.orf</code></pre>


	<p>This was importable (with recognizable lens model) into Lightroom.</p>


	<p>Lightroom is the latest Lightroom CC (2015.7 Release, Camera Raw 9.7)</p>


	<p>Surprisingly, darktable still didn't recognize the lens, but I guess that's a darktable problem.</p></div>
    </div>
  </div>
  
  <div id="change-5745" class="journal has-notes">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4840">Martin Stolle</a> <a title="13 Nov 2016 18:01" href="/projects/exiv2/activity?from=2016-11-13">about 5 years</a> ago
      <span id="journal-5745-private_notes" class=""></span>
    </h4>

    <div id="journal-5745-notes" class="wiki"><p>Just for completeness, this is darktable 2.0.3 (from Ubuntu 16.04)</p></div>
    </div>
  </div>
  
  <div id="change-5746" class="journal has-notes">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="13 Nov 2016 18:37" href="/projects/exiv2/activity?from=2016-11-13">about 5 years</a> ago
      <span id="journal-5746-private_notes" class=""></span>
    </h4>

    <div id="journal-5746-notes" class="wiki"><p>I've reproduced the LR import issue with LR5.0/Camera Raw 8.1 (2013 Edition of LR)</p>


	<p>Some success, and some unhappiness!  I'm not bothered about the IFD observation.  The file was rewritten and some of the data has been relocated.</p>


	<a name="Happyness"></a>
<h3 > Happyness:<a href="#Happyness" class="wiki-anchor">&para;</a></h3>


	<p>The original file has 32 bytes allocate for LensModel. <pre>525 rmills@rmillsmm:~/Downloads $ exiv2 -pR 20161113-114050_pb132546.orf | grep -i Maker
       460 | 0x927c MakerNote                 | UNDEFINED |  1447744 |      3264 | OLYMPUS.II........\....@....... ...
526 rmills@rmillsmm:~/Downloads $ exiv2 -pR 20161113-114050_pb132546_exiftool.orf | grep -i Maker
      1258 | 0x927c MakerNote                 | UNDEFINED |  1212494 |      1546 | OLYMPUS.II........\...r........ ...
527 rmills@rmillsmm:~/Downloads $ </pre></p>


	<p>Keep the new lens name to less than 32 bytes and it will import:<pre>  511  18:02:14 cp 20161113-114050_pb132546.orf modify.orf
  513  18:03:06 exiv2 -M "set Exif.Photo.LensModel Ascii Samyang 7.5mm lens" modify.orf </pre></p>


	<p>Inspecting the "raw" metadata with -pR (print Recursive), your exiftool file has achieved almost an identical result to exiv2: <pre>516 rmills@rmillsmm:~/Downloads $ exiv2 -pR 20161113-114050_pb132546_exiftool.orf | grep -i lens
      1438 | 0xa432 LensSpecification         |  RATIONAL |        4 |   1214182 | 0/0 0/0 0/0 0/0
      1450 | 0xa434 LensModel                 |     ASCII |       37 |   1214214 | Samyang 7.5mm F/3.5 UMC Fish-eye ...
517 rmills@rmillsmm:~/Downloads $ exiv2 -pR 20161113-114050_pb132546_tagged.orf | grep -i lens
      1438 | 0xa432 LensSpecification         |  RATIONAL |        4 |   1214176 | 0/0 0/0 0/0 0/0
      1450 | 0xa434 LensModel                 |     ASCII |       37 |   1214208 | Samyang 7.5mm F/3.5 UMC Fish-eye ...
518 rmills@rmillsmm:~/Downloads $</pre></p>


	<a name="Unhappiness"></a>
<h3 >Unhappiness:<a href="#Unhappiness" class="wiki-anchor">&para;</a></h3>


	<p>LensMode greater than 32 bytes will not import.</p>


	<p>There's a substantial difference in the MakerNote:<pre>525 rmills@rmillsmm:~/Downloads $ exiv2 -pR 20161113-114050_pb132546.orf | grep -i Maker
       460 | 0x927c MakerNote                 | UNDEFINED |  1447744 |      3264 | OLYMPUS.II........\....@....... ...
526 rmills@rmillsmm:~/Downloads $ exiv2 -pR 20161113-114050_pb132546_exiftool.orf | grep -i Maker
      1258 | 0x927c MakerNote                 | UNDEFINED |  1212494 |      1546 | OLYMPUS.II........\...r........ ...
527 rmills@rmillsmm:~/Downloads $ </pre></p>


	<a name="So-whats-wrong"></a>
<h3 >So what's wrong?<a href="#So-whats-wrong" class="wiki-anchor">&para;</a></h3>


	<p>I think the MakerNote has been corrupted by Exiv2 when LensModel is greater than 32 bytes</p>


	<a name="What-can-you-and-I-do-about-this"></a>
<h3 >What can you and I do about this?<a href="#What-can-you-and-I-do-about-this" class="wiki-anchor">&para;</a></h3>


	<p>I don't have time at the moment to dig through all the makernote encoder/decoder for Olympus Cameras as I'm about to ship v0.26.</p>


	<p>Can you ask Adobe to give you an explanation for why Camera Raw dislikes the _tagged.orf file.  Don't give them a hint about my suspicion of our MakerNote encoder.  If you tell them that, they'll instantly say that's the fault.  Ask them to check their logs to determine the reason they can't import it.</p></div>
    </div>
  </div>
  
  <div id="change-5747" class="journal has-details">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="13 Nov 2016 21:36" href="/projects/exiv2/activity?from=2016-11-13">about 5 years</a> ago
      <span id="journal-5747-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>New</i></li>
       <li><strong>Target version</strong> changed from <i>0.26</i> to <i>0.28</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-5748" class="journal has-notes has-details">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="13 Nov 2016 23:32" href="/projects/exiv2/activity?from=2016-11-13">about 5 years</a> ago
      <span id="journal-5748-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Target version</strong> changed from <i>0.28</i> to <i>0.26</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>40</i></li>
       <li><strong>Estimated time</strong> set to <i>10.00 h</i></li>
    </ul>
    <div id="journal-5748-notes" class="wiki"><p>I've download the latest DNGConvertor for Mac (9.7.0).  I've set the (1) Select the images to convert: Select Folder... to my ~/Downloads.  Everything converts <em><strong>except</strong></em> tagged.orf who is totally ignored.  I've monitored this operation with Console.app and filtered with "Adobe".  Lots of messages appearing (including assertions) from the process "Adobe DNG Convertor".  Sadly, none of them mean anything much to me (copy below).</p>


	<p>Curiously the messages all involve dancing with Apple Software and AppKit in particular.  I've tried to open our friend _tagged.orf with Preview.app and got this:<pre>PVImageContainer initWithURL:file:///Users/rmills/Downloads/20161113-114050_pb132546_tagged.orf failed, error = Error Domain=NSCocoaErrorDomain Code=259 "The file “20161113-114050_pb132546_tagged.orf” could not be opened." UserInfo={NSURL=file:///Users/rmills/Downloads/20161113-114050_pb132546_tagged.orf, NSLocalizedDescription=The file “20161113-114050_pb132546_tagged.orf” could not be opened., NSLocalizedRecoverySuggestion=Preview currently does not support this raw file format.}</pre>We're getting somewhere.  The Apple Raw Image code hates the _tagged.orf file.  However, we don't know why!</p>


	<p>You told me you're working on Ubuntu, so none of the Apple code is implicated.  However there's little doubt that _tagged.orf is a sorry file.  And LightRoom dislikes the file as well.  This puzzle shows up in LightRoom, however it is the file _tagged.orf that is not good.</p>


	<p>For the moment, there is a work-around.  You'll have to take care to restrict your lens name to the original 32 bytes allocated in the original file.  Clearly we can rewrite that safely, however when we write a name longer that 32 bytes, the file has been damaged in some way.</p>


	<p>I've inspected the decoded MakerNote - especially the Exif.OlympusEq.XXXX tags.  All are unchanged between your good.orf and <em>tagged.orf.  So suspicion now lands on the tag _<strong>Exif.Photo.LensModel</em></strong>.  I don't believe any tag in Exif.Photo.XXX could damage a file because that family of tags occurs in every image with Exif metadata (almost every single image).  However, unlike the MakerNote decoder/encoder, it will be easy to step that code with the debugger.  It's late now (23:30 in England).  I'll have another look at this tomorrow.</p>


<pre>default    22:50:55.839812 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:50:57.298552 +0000    Adobe DNG Converter    &lt;private&gt; is not MNT_LOCAL!
default    22:50:57.298596 +0000    Adobe DNG Converter    &lt;private&gt;
default    22:50:57.299870 +0000    Adobe DNG Converter    /Network/Servers is not MNT_LOCAL!
default    22:50:57.299910 +0000    Adobe DNG Converter    &lt;private&gt;
default    22:50:57.300584 +0000    Adobe DNG Converter    &lt;private&gt; is not MNT_LOCAL!
default    22:50:57.300619 +0000    Adobe DNG Converter    &lt;private&gt;
default    22:50:57.300926 +0000    Adobe DNG Converter    discovered extensions
default    22:50:57.301116 +0000    Adobe DNG Converter    &lt;private&gt; is not MNT_LOCAL!
default    22:50:57.301155 +0000    Adobe DNG Converter    &lt;private&gt;
default    22:50:57.301797 +0000    Adobe DNG Converter    got a connection for: com.apple.cache_delete
default    22:50:57.301950 +0000    Adobe DNG Converter    got proxy: &lt;private&gt; for service: com.apple.cache_delete
default    22:50:57.303094 +0000    Adobe DNG Converter    setting target uid to: 501 for service: com.apple.cache_delete
default    22:50:57.303125 +0000    Adobe DNG Converter    connection invalidated
default    22:50:57.542175 +0000    Adobe DNG Converter    calling plugIn beginUsing:
default    22:50:57.569760 +0000    Adobe DNG Converter    SFBrowserCallBack (node = &lt;SFNode 0x6180002e0480&gt;{domain = Network})
default    22:50:57.644040 +0000    Adobe DNG Converter    completed calling plugIn beginUsing: for pid: 67369
default    22:50:59.693317 +0000    Adobe DNG Converter    Connection to sharingd became invalid
default    22:50:59.742727 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:50:59.743086 +0000    Adobe DNG Converter    errors encountered while discovering extensions
default    22:50:59.747423 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:50:59.747562 +0000    Adobe DNG Converter    tearing down extension request for pid 67369
default    22:50:59.747655 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:50:59.747817 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:50:59.747965 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:50:59.748093 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:50:59.751308 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:50:59.894974 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:50:59.988915 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:00.094786 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:00.234902 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:00.235245 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:00.235390 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:00.235537 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:00.235616 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:00.245576 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:00.245987 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:00.294794 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:00.495149 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:00.651280 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:00.694530 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:00.895385 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:01.094548 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:01.295332 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:01.494741 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:01.691023 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:01.694602 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:01.840220 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:04.823697 +0000    Adobe DNG Converter    discovered extensions
default    22:51:05.852762 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:25.677271 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:51:25.990201 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014
default    22:52:57.652568 +0000    Adobe DNG Converter    *** Assertion failure in -[NSEvent subtype], /Library/Caches/com.apple.xbs/Sources/AppKit/AppKit-1504.60/AppKit.subproj/NSEvent.m:3014</pre></div>
    </div>
  </div>
  
  <div id="change-5749" class="journal has-notes has-details">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Nov 2016 11:44" href="/projects/exiv2/activity?from=2016-11-14">about 5 years</a> ago
      <span id="journal-5749-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>40</i> to <i>50</i></li>
    </ul>
    <div id="journal-5749-notes" class="wiki"><p>I'm making steady progress with this.  There's no question TiffParserWorker::encode is unconditionally taking the wmIntrusive branch.  This is fine when it's overwriting the 32 bytes already allocated for LensModel.  It's not OK then it must be totally rewritten (wmNonIntrusive).  On my local copy,  I am unconditionally setting wmIntrusive, this "sort of" works in that the file is not corrupted.  However, LensModel is not updated either and retains the 32 bytes (which I think are all nulls).</p>


	<p>I hardly know this part of the code, so I will have to read/step/think.  I expect/hope to fix this today.</p></div>
    </div>
  </div>
  
  <div id="change-5758" class="journal has-notes has-details">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Nov 2016 18:07" href="/projects/exiv2/activity?from=2016-11-14">about 5 years</a> ago
      <span id="journal-5758-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>50</i> to <i>40</i></li>
       <li><strong>Estimated time</strong> changed from <i>10.00 h</i> to <i>20.00 h</i></li>
    </ul>
    <div id="journal-5758-notes" class="wiki"><p>I'm giving up on this for today.  Here's what I know.<br />1) tiffimage.cpp # 1934 <br />The following lines seem in the wrong order:<pre><code class="cplusplus syntaxhl">           <span class="n">parsedTree</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">encoder</span><span class="p">.</span><span class="n">dirty</span><span class="p">())</span> <span class="n">writeMethod</span> <span class="o">=</span> <span class="n">wmNonIntrusive</span><span class="p">;</span></code></pre>And should be:<pre><code class="cplusplus syntaxhl">           <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">encoder</span><span class="p">.</span><span class="n">dirty</span><span class="p">())</span> <span class="n">writeMethod</span> <span class="o">=</span> <span class="n">wmNonIntrusive</span><span class="p">;</span>
            <span class="n">parsedTree</span><span class="o">-&gt;</span><span class="n">accept</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span></code></pre>parsedTree->accept() captures encoder.exifdata_.  So encoder.dirty() is never true (because it has lost its metadata).  So the code always takes the Intrusive branch which works when the new value of LensModel is less than the allocated 32 bytes in the file.</p>


	<p>2) I still don't know why Preview (and LR and others) reject the file.  I have investigated the possibility that we have forgotten to write the 4byte ZERO at the end of an IFD.  That is working well (and many other matters I have considered). <pre>$ cp ~/Downloads/pb.orf . ; build/bin/Debug/exiv2 -M'set Exif.Photo.LensModel 12345678901234567890123456789012345' pb.orf ; exiv2 -pR pb.orf
STRUCTURE OF TIFF FILE (II): pb.orf
 address |    tag                           |      type |    count |    offset | value
      10 | 0x0100 ImageWidth                |      LONG |        1 |      4640 | 4640
      22 | 0x0101 ImageLength               |      LONG |        1 |      3472 | 3472
      34 | 0x0102 BitsPerSample             |     SHORT |        1 |        16 | 16
      46 | 0x0103 Compression               |     SHORT |        1 |         1 | 1
      58 | 0x0106 PhotometricInterpretation |     SHORT |        1 |         1 | 1
      70 | 0x010e ImageDescription          |     ASCII |       32 |       290 | OLYMPUS DIGITAL CAMERA         
      82 | 0x010f Make                      |     ASCII |       24 |       322 | OLYMPUS IMAGING CORP.  
      94 | 0x0110 Model                     |     ASCII |       17 |       346 | E-M5            
     106 | 0x0111 StripOffsets              |      LONG |        1 |   1214244 | 1214244
     118 | 0x0112 Orientation               |     SHORT |        1 |         1 | 1
     130 | 0x0115 SamplesPerPixel           |     SHORT |        1 |         1 | 1
     142 | 0x0116 RowsPerStrip              |      LONG |        1 |      3472 | 3472
     154 | 0x0117 StripByteCounts           |      LONG |        1 |  12656269 | 12656269
     166 | 0x011a XResolution               |  RATIONAL |        1 |       364 | 350/1
     178 | 0x011b YResolution               |  RATIONAL |        1 |       372 | 350/1
     190 | 0x011c PlanarConfiguration       |     SHORT |        1 |         1 | 1
     202 | 0x0128 ResolutionUnit            |     SHORT |        1 |         2 | 2
     214 | 0x0131 Software                  |     ASCII |       32 |       380 | Version 2.2                    
     226 | 0x0132 DateTime                  |     ASCII |       20 |       412 | 2016:11:13 10:40:50
     238 | 0x013b Artist                    |     ASCII |       64 |       432 | Martin Stolle                    ...
     250 | 0x8298 Copyright                 |     ASCII |       64 |       496 | Martin Stolle                    ...
     262 | 0x8769 ExifTag                   |      LONG |        1 |      1088 | 1088
  STRUCTURE OF TIFF FILE (II): pb.orf
   address |    tag                           |      type |    count |    offset | value
      1090 | 0x829a ExposureTime              |  RATIONAL |        1 |      1466 | 1/100
      1102 | 0x829d FNumber                   |  RATIONAL |        1 |      1474 | 0/10
      1114 | 0x8822 ExposureProgram           |     SHORT |        1 |         2 | 2
      1126 | 0x8827 ISOSpeedRatings           |     SHORT |        1 |       640 | 640
      1138 | 0x8830 SensitivityType           |     SHORT |        1 |         1 | 1
      1150 | 0x9000 ExifVersion               | UNDEFINED |        4 | 808661552 | 0230
      1162 | 0x9003 DateTimeOriginal          |     ASCII |       20 |      1482 | 2016:11:13 10:40:50
      1174 | 0x9004 DateTimeDigitized         |     ASCII |       20 |      1502 | 2016:11:13 10:40:50
      1186 | 0x9204 ExposureBiasValue         | SRATIONAL |        1 |      1522 | 0/10
      1198 | 0x9205 MaxApertureValue          |  RATIONAL |        1 |      1530 | 0/256
      1210 | 0x9207 MeteringMode              |     SHORT |        1 |         5 | 5
      1222 | 0x9208 LightSource               |     SHORT |        1 |         0 | 0
      1234 | 0x9209 Flash                     |     SHORT |        1 |         8 | 8
      1246 | 0x920a FocalLength               |  RATIONAL |        1 |      1538 | 0/10
      1258 | 0x927c MakerNote                 | UNDEFINED |  1212488 |      1546 | OLYMPUS.II........\...r........ ...
      1270 | 0x9286 UserComment               | UNDEFINED |      125 |   1214034 | ........                         ...
      1282 | 0xa000 FlashpixVersion           | UNDEFINED |        4 | 808464688 | 0100
      1294 | 0xa001 ColorSpace                |     SHORT |        1 |         1 | 1
      1306 | 0xa300 FileSource                | UNDEFINED |        1 |         3 | .
      1318 | 0xa302 CFAPattern                | UNDEFINED |        8 |   1214160 | ........
      1330 | 0xa401 CustomRendered            |     SHORT |        1 |         0 | 0
      1342 | 0xa402 ExposureMode              |     SHORT |        1 |         0 | 0
      1354 | 0xa403 WhiteBalance              |     SHORT |        1 |         0 | 0
      1366 | 0xa404 DigitalZoomRatio          |  RATIONAL |        1 |   1214168 | 100/100
      1378 | 0xa406 SceneCaptureType          |     SHORT |        1 |         0 | 0
      1390 | 0xa407 GainControl               |     SHORT |        1 |         2 | 2
      1402 | 0xa408 Contrast                  |     SHORT |        1 |         0 | 0
      1414 | 0xa409 Saturation                |     SHORT |        1 |         0 | 0
      1426 | 0xa40a Sharpness                 |     SHORT |        1 |         1 | 1
      1438 | 0xa432 LensSpecification         |  RATIONAL |        4 |   1214176 | 0/0 0/0 0/0 0/0
      1450 | 0xa434 LensModel                 |     ASCII |       36 |   1214208 | 12345678901234567890123456789012 ...
  END pb.orf
     274 | 0xc4a5 PrintImageMatching        | UNDEFINED |      528 |       560 | PrintIM.0300..%................ ...
END pb.orf
$ dd skip=1088 bs=1 count=2 if=pb.orf 2&gt;/dev/null | od -h -w12 | cut -d' ' -f 2- | head -1
001f
$ dd skip=1090 bs=1 count=400 if=pb.orf 2&gt;/dev/null | od -h -w12 | cut -d' ' -f 2- | head -32
829a 0005 0001 0000 05ba 0000
829d 0005 0001 0000 05c2 0000
8822 0003 0001 0000 0002 0000
8827 0003 0001 0000 0280 0000
8830 0003 0001 0000 0001 0000
9000 0007 0004 0000 3230 3033
9003 0002 0014 0000 05ca 0000
9004 0002 0014 0000 05de 0000
9204 000a 0001 0000 05f2 0000
9205 0005 0001 0000 05fa 0000
9207 0003 0001 0000 0005 0000
9208 0003 0001 0000 0000 0000
9209 0003 0001 0000 0008 0000
920a 0005 0001 0000 0602 0000
927c 0007 8048 0012 060a 0000
9286 0007 007d 0000 8652 0012
a000 0007 0004 0000 3130 3030
a001 0003 0001 0000 0001 0000
a300 0007 0001 0000 0003 0000
a302 0007 0008 0000 86d0 0012
a401 0003 0001 0000 0000 0000
a402 0003 0001 0000 0000 0000
a403 0003 0001 0000 0000 0000
a404 0005 0001 0000 86d8 0012
a406 0003 0001 0000 0000 0000
a407 0003 0001 0000 0002 0000
a408 0003 0001 0000 0000 0000
a409 0003 0001 0000 0000 0000
a40a 0003 0001 0000 0001 0000
a432 0005 0004 0000 86e0 0012
a434 0002 000b 0000 8700 0012
0000 0000 0001 0000 0064 0000
$</pre></p>


	<p>I didn't write tiffcomposite.cpp and have never changed a line of code in that file.  So, I've spent several hours in the debugger.  The code is well written and clear.  It has been very stable for years.</p>


	<p>Tomorrow is another day.</p></div>
    </div>
  </div>
  
  <div id="change-5760" class="journal has-notes has-details">
    <div id="note-10">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-10" class="journal-link">#10</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Nov 2016 10:22" href="/projects/exiv2/activity?from=2016-11-15">about 5 years</a> ago
      <span id="journal-5760-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> changed from <i>makernote</i> to <i>miscellaneous</i></li>
       <li><strong>% Done</strong> changed from <i>40</i> to <i>80</i></li>
       <li><strong>Estimated time</strong> changed from <i>20.00 h</i> to <i>12.00 h</i></li>
    </ul>
    <div id="journal-5760-notes" class="wiki"><p>I have run out of ideas about why LightRoom rejects the _tagged.orf file.  Here are things that I have done today:</p>


	<p>1) Modified the header of _tagged.orf to be a TIFF (bytes 2 and 3 are short 42.  Header: 0x4949002a "II\0*").<br />libtiff utilities tiffinfo and tiffdump run as expected.<br />2) I've downloaded LibRaw-0.17.2 and run simple_dcraw.  It produces at 47mb tiff image.<br />3) Picasa and darkroom do not complain about the _tagged.orf (neither use LibRaw)<br />4) I've analysed the difference in the metadata between the original and modified _tagged files:<pre>$ exiv2 -pa ~/Downloads/pb.orf | sort &gt; pb.txt
$ exiv2 -pa ~/Downloads/ta.orf | sort &gt; ta.txt
$ diff pb.txt ta.txt 
6c6
&lt; Exif.Image.ExifTag                           Long        1  290
---
&gt; Exif.Image.ExifTag                           Long        1  1088 &lt;---- Correct.  Larger ExifTag relocated
21c21
&lt; Exif.Image.StripOffsets                      Long        1  1451008
---
&gt; Exif.Image.StripOffsets                      Long        1  1214246
25c25
&lt; Exif.MakerNote.Offset                        Long        1  3264
---
&gt; Exif.MakerNote.Offset                        Long        1  1546
27,31c27,31
&lt; Exif.Olympus2.CameraSettings                 Ifd         1  420
&lt; Exif.Olympus2.Equipment                      Ifd         1  114
&lt; Exif.Olympus2.FocusInfo                      Ifd         1  2994
&lt; Exif.Olympus2.ImageProcessing                Ifd         1  1344
&lt; Exif.Olympus2.RawDevelopment                 Ifd         1  1170
---
&gt; Exif.Olympus2.CameraSettings                 Long        1  5190
&gt; Exif.Olympus2.Equipment                      Long        1  4602
&gt; Exif.Olympus2.FocusInfo                      Long        1  1207556
&gt; Exif.Olympus2.ImageProcessing                Long        1  1076176
&gt; Exif.Olympus2.RawDevelopment                 Long        1  1075970
75c75
&lt; Exif.OlympusCs.PreviewImageStart             Long        1  48960
---
&gt; Exif.OlympusCs.PreviewImageStart             Long        1  6660
191c191
&lt; Exif.Photo.FocalLength                       Rational    1  0.0 mm
---
&gt; Exif.Photo.FocalLength                       Rational    1  7.5 mm &lt;--- Correct
194c194
&lt; Exif.Photo.LensModel                         Ascii      32  
---
&gt; Exif.Photo.LensModel                         Ascii      37  Samyang 7.5mm F/3.5 UMC Fish-eye MFT &lt;--- Correct
197c197
&lt; Exif.Photo.MakerNote                         Undefined 1447744  (Binary value suppressed)
---
&gt; Exif.Photo.MakerNote                         Undefined 1212488  (Binary value suppressed)
505 rmills@rmillsmbp:~ $</pre>Several observations about this:</p>


	<p>1) I acknowledge that Exiv2 has modified this file.  Adobe and Apple code refuses to open the modified file.<br />2) Other image viewers (Picasa, darktable, DCRaw) accept the modified file.<br />3) The work-around is to restrict Exif.Photo.LensModel to 32 bytes (including the null terminator).<br />4) I have spent 10+ hours on this matter and examined everything I believe is relevant.  I have been unable to find any violation of the TIFF Specification in the _tagged.orf file.<br />5) There are differences in the files concerning the MakerNote.  I doubt if any image viewer decodes the maker note, so although I can't explain the difference, I don't think this explains LightRoom and Preview's behaviour.  exiftool is happy to process the file, so the metadata structures in the file are valid.</p>


	<p>The only way we can make progress is to get information from an image viewer that refuses to recognise the file (LightRoom, DNG Convertor, or Preview).</p>


	<p>I am thinking to close this issue as "Bug in Lightroom".  This is a very unsatisfactory conclusion, however I don't know what else I can do.</p>


	<p>So, Mr Stolle:  Three questions:</p>


	<p>1) Can you live with my workaround (restrict the LensModel value to 32 bytes)?<br />2) Can you contact Adobe and ask why LightRoom rejected the _tagged file and Picasa does not?<br />3) Can you suggest anything else that you or I can do to progress this issue?</p></div>
    </div>
  </div>
  
  <div id="change-5761" class="journal has-notes">
    <div id="note-11">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-11" class="journal-link">#11</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4840">Martin Stolle</a> <a title="15 Nov 2016 20:49" href="/projects/exiv2/activity?from=2016-11-15">about 5 years</a> ago
      <span id="journal-5761-private_notes" class=""></span>
    </h4>

    <div id="journal-5761-notes" class="wiki"><p>Hi, thanks for looking into this issue.</p>


	<p>To answer your question:</p>


	<p>1) I will probably use ExifTool to set the LensModel, as setting it there does not exhibit the import problem.<br />2) I will try to contact them tomorrow or later this week.  They unfortunately only offer live chat support during business hours, when I am not at home. (There is no email/form I could find.  If you know of an asynchronous contact mechanism, I'd be more than happy to contact them.)<br />3) My exiv2 foo is not very strong, but could you try removing the MakerNote?  Based on your investigation so far, it seems as if the assumption that Lightroom doesn't care about the contents of MakeNote may be wrong (as Sherlock Holmes once said: "Once you eliminate the impossible, whatever remains, no matter how improbable, must be the truth.")</p></div>
    </div>
  </div>
  
  <div id="change-5762" class="journal has-notes">
    <div id="note-12">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-12" class="journal-link">#12</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="16 Nov 2016 09:45" href="/projects/exiv2/activity?from=2016-11-16">about 5 years</a> ago
      <span id="journal-5762-private_notes" class=""></span>
    </h4>

    <div id="journal-5762-notes" class="wiki"><p>Martin</p>


	<p>Can you email me please <a class="email" href="mailto:robin@clanmills.com">robin@clanmills.com</a>  I want to discuss something privately with you.  (nothing sinister, simply something I would prefer not to discuss in public).</p>


	<p>Robin</p></div>
    </div>
  </div>
  
  <div id="change-5763" class="journal has-notes has-details">
    <div id="note-13">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-13" class="journal-link">#13</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="16 Nov 2016 13:39" href="/projects/exiv2/activity?from=2016-11-16">about 5 years</a> ago
      <span id="journal-5763-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>80</i> to <i>70</i></li>
       <li><strong>Estimated time</strong> changed from <i>12.00 h</i> to <i>20.00 h</i></li>
    </ul>
    <div id="journal-5763-notes" class="wiki"><p>I'm glad you're happy with your work around to use ExifTool.  Phil reads the Exiv2 forum and occasionally chips in very helpful comments.  I might ask him about this, however there's no reason to disturb him while we're making progress.</p>


	<p>There are three groups of applications crashing your file:</p>


	<p>1) Adobe applications<br />2) Apple’s Core Graphics<br />3) Microsoft Windows/10 Photo app (very nice app incidentally).</p>


	<p>The following open-source apps render your file:  digiKam, GwenView, darktable, GIMP, RawTherepee, Krita.</p>


	<p>I like you suggestion to remove the MakerNote.  I’ll do that today.  It’ll require some brain surgery in Exiv2 - however I’m confident of success.</p>


	<p>Another possibility is that the graphics are incorrect!  The following tags identify the location of the pixels: <pre>518 rmills@rmillsmbp:~/gnu/exiv2/trunk $ build/bin/Debug/exiv2 -pv --grep strip/i pb.orf
0x0111 Image        StripOffsets                Long        1  1451008
0x0116 Image        RowsPerStrip                Long        1  3472
0x0117 Image        StripByteCounts             Long        1  12656269
519 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre></p>


	<p>If there’s something wrong with those tags, a Tiff Renderer could detect a buffer overflow.  Or it might not!</p>


	<p>It’s something, that’s for certain.  We’ll find and fix it.  I’m confident.</p></div>
    </div>
  </div>
  
  <div id="change-5764" class="journal has-notes">
    <div id="note-14">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-14" class="journal-link">#14</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="16 Nov 2016 22:26" href="/projects/exiv2/activity?from=2016-11-16">about 5 years</a> ago
      <span id="journal-5764-private_notes" class=""></span>
    </h4>

    <div id="journal-5764-notes" class="wiki"><p>I've made steady progress with this <em><strong>AND</strong></em> feel very close to solving this puzzle.  That file has a rather strange value of StripByteCounts of 12656269.  This is an ODD number for Compression=1 BitsPerSample=16 SamplesPerPixel=1 Width=4640 Height=3472.  I would expect the frame buffer to be 2*4640*3471 = 32210880  (32mb).  The file is 12mb. I think the Olympus people have compressed the frame buffer!  However both Exiv2 and exiftool have relocate the frame buffer and the exiftool version does not crash! Both exiv2 and exiftool have the framebuffer 4-byte aligned.</p>


<pre>$ exiv2 -pR pb.orf  | grep -i -e strip -i -e image -i -e compres -i -e per
      10 | 0x0100 ImageWidth                |      LONG |        1 |      4640 | 4640
      22 | 0x0101 ImageLength               |      LONG |        1 |      3472 | 3472
      34 | 0x0102 BitsPerSample             |     SHORT |        1 |        16 | 16
      46 | 0x0103 Compression               |     SHORT |        1 |         1 | 1
      70 | 0x010e ImageDescription          |     ASCII |       32 |       290 | OLYMPUS DIGITAL CAMERA         
     106 | 0x0111 StripOffsets              |      LONG |        1 |      1744 | 1744
     130 | 0x0115 SamplesPerPixel           |     SHORT |        1 |         1 | 1
     142 | 0x0116 RowsPerStrip              |      LONG |        1 |      3472 | 3472
     154 | 0x0117 StripByteCounts           |      LONG |        1 |  12656269 | 12656269
      1198 | 0x9205 MaxApertureValue          |  RATIONAL |        1 |      1518 | 0/256
     274 | 0xc4a5 PrintImageMatching        | UNDEFINED |      528 |       560 | PrintIM.0300..%................ ...
$  </pre>

	<p>In your 3 files, there's a significant difference between _exiftool.org and _tagged.orf in StripOffsets! <pre>$ exiv2 -pa --grep offset/i ~/Downloads/201*orf
20161113-114050_pb132546.orf  Exif.Image.StripOffsets                      Long        1  1451008
20161113-114050_pb132546_exiftool.orf  Exif.Image.StripOffsets                      Long        1  1214252
20161113-114050_pb132546_tagged.orf  Exif.Image.StripOffsets                      Long        1  1214246</pre></p>


	<p>And the file sizes are different by 8 bytes. <pre>$ ls -alt ~/Downloads/201*orf
-rw-r--r--+ 1 rmills staff 13870516 Nov 16 22:05 20161113-114050_pb132546_tagged.orf
-rw-r--r--+ 1 rmills staff 13870522 Nov 16 22:05 20161113-114050_pb132546_exiftool.orf
-rw-r--r--+ 1 rmills staff 14107277 Nov 16 21:37 20161113-114050_pb132546.orf
$ </pre></p>


	<p>I've been able to nuke the MakerNote. <pre>628 rmills@rmillsmbp:~/gnu/exiv2/trunk $ svn diff .
Index: src/tiffcomposite.cpp
===================================================================
--- src/tiffcomposite.cpp    (revision 4684)
+++ src/tiffcomposite.cpp    (working copy)
@@ -916,7 +916,7 @@
         visitor.visitDirectory(this);
         for (Components::const_iterator i = components_.begin();
              visitor.go(TiffVisitor::geTraverse) &#38;&#38; i != components_.end(); ++i) {
-            (*i)-&gt;accept(visitor);
+            if ( (*i)-&gt;tag() != 0x927c) (*i)-&gt;accept(visitor);
         }
         if (visitor.go(TiffVisitor::geTraverse)) visitor.visitDirectoryNext(this);
         if (pNext_) pNext_-&gt;accept(visitor);
$ </pre>File is much smaller:<pre>$ ls -alt ~/Downloads/pb.orf 
$ cp ~/Downloads/pb.orf .
$ exiv2 -M'set Exif.Photo.LensModel 12345678901234567890123456789012345' pb.orf
$ ls -alt pb.orf
-rw-r--r--+ 1 rmills staff 14107277 Nov 13 17:16 /Users/rmills/Downloads/pb.orf
-rw-r--r--+ 1 rmills staff 12658014 Nov 16 21:27 pb.orf
$ </pre>The file is now so simple that I can easily inspect the two IFDs.</p>


	<p>Tomorrow, I will investigate the 8 byte mystery between exiftool and exiv2.  Tomorrow I will get to the bottom of this and declare victory!</p></div>
    </div>
  </div>
  
  <div id="change-5765" class="journal has-details">
    <div id="note-15">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-15" class="journal-link">#15</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="16 Nov 2016 22:26" href="/projects/exiv2/activity?from=2016-11-16">about 5 years</a> ago
      <span id="journal-5765-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Estimated time</strong> changed from <i>20.00 h</i> to <i>25.00 h</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-5766" class="journal has-notes has-details">
    <div id="note-16">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-16" class="journal-link">#16</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="17 Nov 2016 09:16" href="/projects/exiv2/activity?from=2016-11-17">about 5 years</a> ago
      <span id="journal-5766-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>70</i> to <i>80</i></li>
    </ul>
    <div id="journal-5766-notes" class="wiki"><p>Sherlock Holmes Strikes Again! When I remove the MakerNote, Preview is very upset.<pre>$ cp ~/Downloads/20161113-114050_pb132546.orf pb.orf
$ ls -alt pb.orf
-rw-r--r--+ 1 rmills staff 14107277 Nov 17 08:38 pb.orf
$ exiftool -LensModel=different pb.orf
    1 image files updated
$ ls -alt pb.orf
-rw-r--r--+ 1 rmills staff 13870466 Nov 17 08:38 pb.orf
$ open pb.orf     # Opens in Preview.app
$ exiftool -makernotes:all= pb.orf
    1 image files updated
$ ls -alt pb.orf
-rw-r--r--+ 1 rmills staff 12657988 Nov 17 08:39 pb.orf
$ open pb.orf      # Preview.app barfs</pre>And I know where to look.  exiftool has 4 more bytes in the makernote:<pre>$ cp ~/Downloads/20161113-114050_pb132546.orf pb.orf
$ exiv2 -M'set Exif.Photo.LensModel 12345678901234567890123456789012345' pb.orf
$ exiv2 -pR pb.orf | grep -i maker
      1258 | 0x927c MakerNote                 | UNDEFINED |  1212488 |      1546 | OLYMPUS.II........\...r........ ...
$ </pre></p>


<pre>$ cp ~/Downloads/20161113-114050_pb132546.orf pb.orf
$ exiftool -LensModel=12345678901234567890123456789012345 pb.orf
    1 image files updated
$ exiv2 -pR pb.orf | grep -i maker
      1258 | 0x927c MakerNote                 | UNDEFINED |  1212492 |      1546 | OLYMPUS.II........\...r........ ...
$ </pre>

	<p>So we have now returned to my observation/guess on Sunday afternoon:</p>


<blockquote>

	<p>I think the MakerNote has been corrupted by Exiv2 when LensModel is greater than 32 bytes</p>


</blockquote></div>
    </div>
  </div>
  
  <div id="change-5767" class="journal has-notes has-details">
    <div id="note-17">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-17" class="journal-link">#17</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="17 Nov 2016 11:25" href="/projects/exiv2/activity?from=2016-11-17">about 5 years</a> ago
      <span id="journal-5767-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Closed</i></li>
       <li><strong>% Done</strong> changed from <i>80</i> to <i>100</i></li>
       <li><strong>Estimated time</strong> changed from <i>25.00 h</i> to <i>20.00 h</i></li>
    </ul>
    <div id="journal-5767-notes" class="wiki"><p>I'm closing this issue as we have identified the "true" fault for which I have opened a new issue: <a class="issue tracker-1 status-1 priority-4 priority-default" title="Bug: ORF MakerNote incorrectly re-written (New)" href="/issues/1255">#1255</a>.  Martin and I have identified a couple of work-arounds.</p>


	<p>The underlying fault (rewriting the file has corrupted the MakerNote) has never been reported.  The code to write the MakerNote was added in <a class="changeset" title="#665: Added write-support for ORF files." href="/projects/exiv2/repository/exiv2/revisions/1992">r1992</a> in 2010.  I think this has gone un-noticed because most open-source renderers do not decode the MakerNote.  However it's clear that Apple, Adobe and Microsoft decode the MakerNote and do no forgive this error.</p>


	<p>I've had a look at the code involved in rewriting the MakerNote.  I've never had reason to explore this code in the past.  It's quite abstract and uses arrays of structures to encode various IFDs.  It's going to take a considerable effort to understand and debug this code.  I've opened issue <a class="issue tracker-1 status-1 priority-4 priority-default" title="Bug: ORF MakerNote incorrectly re-written (New)" href="/issues/1255">#1255</a> to undertake that task in v0.27.</p></div>
    </div>
  </div>
  
  <div id="change-5768" class="journal has-details">
    <div id="note-18">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-18" class="journal-link">#18</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="17 Nov 2016 12:53" href="/projects/exiv2/activity?from=2016-11-17">about 5 years</a> ago
      <span id="journal-5768-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> changed from <i>miscellaneous</i> to <i>makernote</i></li>
    </ul>
    
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1253.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1253.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
