<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Patch #1272: Possible issue with temp files being left behind. - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="gB3SG120WhjOunrX9aC6QyebxqKkIbZRK2jq2nUTC/liUHn0L86WGJveZdtKd7ZwGAmS21XCF+vWSHpSNirslg==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Patch #1272: Possible issue with temp files being left behind." href="https://dev.exiv2.org/issues/1272.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Patch #1272</h2>

<div class="issue tracker-4 status-5 priority-4 priority-default closed details">
    <div class="next-prev-links contextual">
      <a title="#1277" accesskey="p" href="/issues/1277">« Previous</a> |
        <span class="position">
          <a href="/issues?f%5B%5D=status_id&amp;f%5B%5D=author_id&amp;op%5Bauthor_id%5D=%3D&amp;op%5Bstatus_id%5D=%2A&amp;page=1&amp;per_page=100&amp;set_filter=1&amp;sort=id%3Adesc&amp;v%5Bauthor_id%5D%5B%5D=4722&amp;v%5Bstatus_id%5D%5B%5D=">3 of 9</a>
        </span> |
      <a title="#1271" accesskey="n" href="/issues/1271">Next »</a>
    </div>

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Possible issue with temp files being left behind.</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/4722">Ben Touchette</a> <a title="19 Jan 2017 21:43" href="/projects/exiv2/activity?from=2017-01-19">almost 5 years</a> ago.
        Updated <a title="09 Mar 2017 19:56" href="/projects/exiv2/activity?from=2017-03-09">over 4 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">basicio</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="28 Apr 2017" href="/versions/52">0.26</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">19 Jan 2017</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">15.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>While working with a client we noticed that it was possible that some temporary files maybe left behind in the default path in the event of crash. i I don't have a test right now, figured we could be proactive, this patch should address that.</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1127">temp_files.diff</a>    <span class="size">(2.11 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1127/temp_files.diff">temp_files.diff</a>  </td>
  <td>temp files may be left undeleted after use.</td>
  <td>
      <span class="author">Ben Touchette, 19 Jan 2017 21:43</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1128">temp_file-1.diff</a>    <span class="size">(4.22 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1128/temp_file-1.diff">temp_file-1.diff</a>  </td>
  <td>This patch supersedes the previous one. Adds a widestring version of temporaryPath.</td>
  <td>
      <span class="author">Ben Touchette, 20 Jan 2017 15:45</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>







<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/1272" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="zSAuqwvH775K1Yk3pQzA7WMUfbYP3qsJRBO4KaQcc5YvbYVEeb0jvh+xljsa28zeXIYpz/49CrO5Myih5yWU+Q==" />
  <table class="list issues odd-even"><tr id="relation-260" class="issue hascontextmenu issue tracker-2 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="747" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-2 status-5 priority-4 priority-default closed" href="/issues/747">Feature #747</a>: Direct FILE* access from FileIo interface</td><td class="status">Closed</td><td class="start_date">10 Dec 2010</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/1272/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=1272&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 4707" href="/projects/exiv2/repository/exiv2/revisions/4707">Revision 4707</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4707/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Feb 2017 20:53" href="/projects/exiv2/activity?from=2017-02-15">almost 5 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-4 status-5 priority-4 priority-default closed" title="Patch: Possible issue with temp files being left behind. (Closed)" href="/issues/1272">#1272</a> Submitting modified version of Ben's patch.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4715" href="/projects/exiv2/repository/exiv2/revisions/4715">Revision 4715</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4715/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="03 Mar 2017 19:36" href="/projects/exiv2/activity?from=2017-03-03">over 4 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-4 status-5 priority-4 priority-default closed" title="Patch: Possible issue with temp files being left behind. (Closed)" href="/issues/1272">#1272</a> Do not use ReaganLargeTiff.tiff in icc-test.out (see <a class="issue tracker-4 status-5 priority-4 priority-default closed" title="Patch: Possible issue with temp files being left behind. (Closed)" href="/issues/1272">#1272</a> for discussion)</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4716" href="/projects/exiv2/repository/exiv2/revisions/4716">Revision 4716</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4716/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="04 Mar 2017 10:50" href="/projects/exiv2/activity?from=2017-03-04">over 4 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-4 status-5 priority-4 priority-default closed" title="Patch: Possible issue with temp files being left behind. (Closed)" href="/issues/1272">#1272</a> Supplement to <a class="changeset" title="#1272 Do not use ReaganLargeTiff.tiff in icc-test.out (see #1272 for discussion)" href="/projects/exiv2/repository/exiv2/revisions/4715">r4715</a></p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4717" href="/projects/exiv2/repository/exiv2/revisions/4717">Revision 4717</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4717/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="05 Mar 2017 17:42" href="/projects/exiv2/activity?from=2017-03-05">over 4 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-4 status-5 priority-4 priority-default closed" title="Patch: Possible issue with temp files being left behind. (Closed)" href="/issues/1272">#1272</a> Use in-memory temporary files.</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-5807" class="journal has-notes has-details">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4722">Ben Touchette</a> <a title="20 Jan 2017 15:45" href="/projects/exiv2/activity?from=2017-01-20">almost 5 years</a> ago
      <span id="journal-5807-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/1128">temp_file-1.diff</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/1128/temp_file-1.diff">temp_file-1.diff</a> added</li>
    </ul>
    <div id="journal-5807-notes" class="wiki"><p>This patch supersedes the previous one. Adds a widestring version of temporaryPath.</p></div>
    </div>
  </div>
  
  <div id="change-5846" class="journal has-details">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="09 Feb 2017 20:37" href="/projects/exiv2/activity?from=2017-02-09">almost 5 years</a> ago
      <span id="journal-5846-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> set to <i>jpeg parser</i></li>
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Target version</strong> set to <i>0.26</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-5851" class="journal has-notes has-details">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Feb 2017 07:44" href="/projects/exiv2/activity?from=2017-02-15">almost 5 years</a> ago
      <span id="journal-5851-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>0</i> to <i>50</i></li>
       <li><strong>Estimated time</strong> set to <i>8.00 h</i></li>
    </ul>
    <div id="journal-5851-notes" class="wiki"><p>Ben:</p>


	<p>Thanks for providing this patch.</p>


	<p>The file temp_file-1.diff respects the build flag EXV_UNICODE_PATH which enables wide character paths in MSVC builds.  There's something in the patch which is causing the MinGW/32 build to fail to build.</p>


	<p>I decided to investigate MinGW + EXV_UNICODE_PATH.  This is not good.  I do support a nightly build of MinGW/32 for users of Qt.  However, I've reached several conclusions about MinGW:</p>


	<ol>
	<li>MinGW is not fit for any purpose.  It's time for Qt to stop using this obsolete (and unfinished) technology.  I believe there is new edition "MinGW2" which is posix compliant (and probably based on Cygwin).</li>
		<li>There really isn't an MinGW/msys/64 environment.  You can build 64 bit libraries using a 64 bit version of GCC from MinGW/32.</li>
		<li>Exiv2 + MinGW + EXV_UNICODE_PATH is unable to build and link samples/exifprint.cpp as it attempts to link <em><strong><code>WinMain@16</code></strong></em>   This can be addressed with the command: <pre>$ make exifprint CXXFLAGS=-console LDFLAGS=-lmingw32</pre>Amazingly, it then fails to link Exiv2:dumpLibraryInfo and Exiv2::ImageFactory::open(...);  <pre>undefined reference to
`Exiv2::ImageFactory::open(std::basic_string&lt;wchar_t, std::char_traits&lt;wchar_t&gt;, std::allocator&lt;wchar_t&gt; &gt; const&#38;, bool)'</pre>I cannot find the reason for this link failure. The following tool reveals the entry points <pre>$ nm -g /usr/local/lib/libexiv2.a | grep ImageFactory | grep open | grep T | cut -d' ' -f 3</pre>The unsatisfied external seems to be in the library<pre>$ 466 -32- /home/rmills/gnu/exiv2/trunk&gt; c++filt $(nm -g /usr/local/lib/libexiv2.a | grep ImageFactory | grep open | grep T | cut -d' ' -f 3)
Exiv2::ImageFactory::open(unsigned char const*, long)
Exiv2::ImageFactory::open(std::basic_string&lt;wchar_t, std::char_traits&lt;wchar_t&gt;, std::allocator&lt;wchar_t&gt; &gt; const&#38;, bool)
Exiv2::ImageFactory::open(std::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&#38;, bool)
Exiv2::ImageFactory::open(std::auto_ptr&lt;Exiv2::BasicIo&gt;)
467 -32- /home/rmills/gnu/exiv2/trunk&gt;</pre>It also grumbles about: <em><strong><code>bad reloc address 0xe in section `.text$_ZNSt9exceptionC2Ev[__ZNSt9exceptionC2Ev]'</code></strong></em> which is in the standard library.</li>
	</ol>


	<p>I'm going to reconsider your patch as follows:  It has to successfully build the currently supported platforms: MSVC 2005/8/10/12/13/15 (with/without EXV_UNICODE_PATH) + Cygwin + MinGW/32 (without EXV_UNICODE_PATH) + Linux + MacOSX</p>


	<p>I know there are issues with your patch as it uses the C run-time library <em><strong><code>remove</code></strong></em> which isn't supported by MSVC.  It should be <em><strong><code>_remove/_wremove*</code></strong></em> depending on EXV_UNICODE_PATH.</p>


	<p>I hope to successfully undertake this work today (2017-02-15)</p></div>
    </div>
  </div>
  
  <div id="change-5853" class="journal has-notes">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4722">Ben Touchette</a> <a title="15 Feb 2017 11:27" href="/projects/exiv2/activity?from=2017-02-15">almost 5 years</a> ago
      <span id="journal-5853-private_notes" class=""></span>
    </h4>

    <div id="journal-5853-notes" class="wiki"><p>I had remove working here with MSVC. Interesting mess or something :)</p>


	<p>MinGW64 at minimum? it uses a more modern version of gcc. It's what i tested some of these patches with that i've submitted in the last few weeks. I hadn't realized someone would build that antique.</p></div>
    </div>
  </div>
  
  <div id="change-5856" class="journal has-notes has-details">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Feb 2017 11:35" href="/projects/exiv2/activity?from=2017-02-15">almost 5 years</a> ago
      <span id="journal-5856-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>50</i> to <i>70</i></li>
       <li><strong>Estimated time</strong> changed from <i>8.00 h</i> to <i>10.00 h</i></li>
    </ul>
    <div id="journal-5856-notes" class="wiki"><p>Good News.  I got up at 6am and have your patch working on MSVC.  I have to go out today and I will test my version of your patch on Cygwin/etc this evening.  I hope to have this finished this evening.</p>


	<p>Do you have a use case that leaves files in the temporary directory?  Several people have mentioned this.  I've only observed it when I'm debugging and terminate the program early and therefore don't execute the cleanup code.</p></div>
    </div>
  </div>
  
  <div id="change-5858" class="journal has-notes">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4722">Ben Touchette</a> <a title="15 Feb 2017 11:38" href="/projects/exiv2/activity?from=2017-02-15">almost 5 years</a> ago
      <span id="journal-5858-private_notes" class=""></span>
    </h4>

    <div id="journal-5858-notes" class="wiki"><p>Sounds good, no i don't have a use case but my client had some issues with it in their app where it happened mostly in windows to my knowledge.</p></div>
    </div>
  </div>
  
  <div id="change-5865" class="journal has-notes has-details">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Feb 2017 19:46" href="/projects/exiv2/activity?from=2017-02-15">almost 5 years</a> ago
      <span id="journal-5865-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>70</i> to <i>50</i></li>
       <li><strong>Estimated time</strong> changed from <i>10.00 h</i> to <i>14.00 h</i></li>
    </ul>
    <div id="journal-5865-notes" class="wiki"><p>I've discovered there MSVC test failures on the trunk.  I think they've been here for a few weeks.  These are "clouding the issue" with your patch.  I will fix them of course (probably tomorrow).  In the meanwhile, I'm testing my modified version of your patch on several platforms.</p>


	<p>The issues are all concerning ICC profiles in the file ReaganLargeTiff.tiff  For example:<pre>C:\Users\Shared\workspace\Exiv2-trunk@2\label\msvc\test\data\bugfixes-test.out differ
2722c2722,2765
&lt; ./functions.source: line 6:  9628 Segmentation fault      $VALGRIND $bin$prog "$@" 
---
&gt;      334 | 0x8769 ExifTag                   |      LONG |        1 |   1622642 | 1622642
&gt;   STRUCTURE OF TIFF FILE (II): ReaganLargeTiff.tiff</pre>The tests icc-test.sh and stdin-test.sh are impacted as they also use that file for ICC Profile Extraction.</p></div>
    </div>
  </div>
  
  <div id="change-5866" class="journal has-notes">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4722">Ben Touchette</a> <a title="15 Feb 2017 19:49" href="/projects/exiv2/activity?from=2017-02-15">almost 5 years</a> ago
      <span id="journal-5866-private_notes" class=""></span>
    </h4>

    <div id="journal-5866-notes" class="wiki"><p>Interesting. I hadn't run all the tests, just what they needed when i did that first patch.</p></div>
    </div>
  </div>
  
  <div id="change-5867" class="journal has-notes has-details">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Feb 2017 20:55" href="/projects/exiv2/activity?from=2017-02-15">almost 5 years</a> ago
      <span id="journal-5867-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>50</i> to <i>60</i></li>
    </ul>
    <div id="journal-5867-notes" class="wiki"><p>I've submitted a modified variant of your patch.  The original code uses DeleteFile and not remove in MSVC.  So no particular change required and that explains why it built and passed the test suite for you.</p>


	<p>I understand what's wrong in icc_test.sh.  On MSVC, writing the ICC profile to stdout is adding 32 mysterious bytes to the profile.  This issue #2120 was solved using _binmode() out std::cout.  I'll hunt back some builds to discover when/how this has been reintroduced.<pre>C:\Users\rmills\gnu\exiv2\trunk\msvc\bin\win32\releasedll&gt;exiv2 -eC- --verbose ReaganLargeTiff.tiff &gt; foo.icc

C:\Users\rmills\gnu\exiv2\trunk\msvc\bin\win32\releasedll&gt;exiv2 -eC  --verbose ReaganLargeTiff.tiff
File 1/1: ReaganLargeTiff.tiff
Writing iccProfile: .\ReaganLargeTiff.icc

C:\Users\rmills\gnu\exiv2\trunk\msvc\bin\win32\releasedll&gt;dir *.icc
 Volume in drive C has no label.
 Volume Serial Number is 0899-EF40

 Directory of C:\Users\rmills\gnu\exiv2\trunk\msvc\bin\win32\releasedll

2017-02-15  20:33         1,613,632 foo.icc
2017-02-15  20:33         1,613,600 ReaganLargeTiff.icc
               2 File(s)      3,227,232 bytes
               0 Dir(s)  25,019,547,648 bytes free

C:\Users\rmills\gnu\exiv2\trunk\msvc\bin\win32\releasedll&gt;</pre>Even with the additional bytes in foo.icc, it shouldn't crash of course.</p>


	<p>I'm still not sure how/when temporary files are being left on the disk.  I'll add some instrumentation code to static std::string tempPath().</p>


	<p>std::string tempPath() is not thread safe.  On Windows it should use <em><strong><code>InterlockedIncrement</code></strong></em> and declared atomic on other platforms.</p>


	<p>So, I've got some work to do to fix this.  Priority:<br />1) Fix the crash and writing the wrong number of bytes to std::cout<br />2) Make tempPath() thread safe.<br />3) Instrument tempPath() to find out what's going on.</p></div>
    </div>
  </div>
  
  <div id="change-5874" class="journal has-notes">
    <div id="note-10">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-10" class="journal-link">#10</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="03 Mar 2017 19:24" href="/projects/exiv2/activity?from=2017-03-03">over 4 years</a> ago
      <span id="journal-5874-private_notes" class=""></span>
    </h4>

    <div id="journal-5874-notes" class="wiki"><p>I've done a lot of investigation into <em><strong>ReaganLargeTiff.tiff</strong></em> <em>and</em> <em><strong>test/icc-test.sh</strong></em> and reached the unsatisfactory conclusion that this file is causing the Cygwin/bash test environment distress of some kind which results in a <em><strong>segfault</strong></em> in the releasedll (but neither release nor debugdll) versions.  It doesn't happen from a DOS bat file.  It doesn't happen when I source the script from Cygwin/bash.  I've reduced the script to the minimum as follows for test/1272.sh:<pre>#/bin/bash
cd tmp
cp -f ../data/ReaganLargeTiff.tiff          ReaganLargeTiff.tiff
cp -f ../data/large.icc                     ReaganLargeTiff.icc
../../msvc/bin/win32/releasedll/exiv2 -iC   ReaganLargeTiff.tiff</pre>And test/1272.bat<pre>pushd  tmp
copy/y ..\data\ReaganLargeTiff.tiff
copy/y ..\data\large.icc                      ReaganLargeTiff.icc
..\..\msvc\bin\win32\releasedll\exiv2.exe -iC ReaganLargeTiff.tiff
popd</pre>The error is a "Segmentation Error" which occurs in exiv2(.exe) in src/actions.cpp here:<pre>    int Insert::insertIccProfile(const std::string&#38; path,Exiv2::DataBuf&#38; iccProfileBlob) const
    {
        int rc = 0;
        // test path exists
        if (rc==0 &#38;&#38; !Exiv2::fileExists(path, true)) {
            std::cerr &lt;&lt; path
                      &lt;&lt; ": " &lt;&lt; _("Failed to open the file\n");
            rc=-1;
        }

        // read in the metadata
        if ( rc == 0 ) {
            std::cerr &lt;&lt; "opening path " &lt;&lt; path &lt;&lt; std::endl;
            Exiv2::Image::AutoPtr image = Exiv2::ImageFactory::open(path);
            assert(image.get() != 0);
            image-&gt;readMetadata();  // &lt;---- fails to return from here
            // clear existing profile, assign the blob and rewrite image
            image-&gt;clearIccProfile();
            if ( iccProfileBlob.size_ ) {
                std::cerr &lt;&lt; "about to set the data" &lt;&lt; std::endl;
                image-&gt;setIccProfile(iccProfileBlob);
            }
            image-&gt;writeMetadata();
        }

        return rc;
    } // Insert::insertIccProfile</pre>The failure to return is mysterious and smells of stack corruption as I have added trace statements and readMetadata() ran to completion.</p>


	<p>It's easy to reproduce this error from the test harness.  It's almost impossible to reproduce it with any debugging tools to obtain more information.  It's very likely that no user will be inserting a large (1.6mb) ICC profile using an MSVC build from Cygwin.  If they report such a calamity, these notes will be useful as a start for further investigation.  For the moment, I intend to update the test harness to omit use of ReaganLargeTiff.tiff and this will fix the test harness.</p>


	<p>This matter has been given at least 12 hours of investigation and analysis.  No further activity is possible into <em><strong>ReaganLargeTiff.tiff</strong></em> <em>and</em> <em><strong>test/icc-test.sh</strong></em> at this time.</p></div>
    </div>
  </div>
  
  <div id="change-5875" class="journal has-notes has-details">
    <div id="note-11">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-11" class="journal-link">#11</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="04 Mar 2017 11:55" href="/projects/exiv2/activity?from=2017-03-04">over 4 years</a> ago
      <span id="journal-5875-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>60</i> to <i>50</i></li>
       <li><strong>Estimated time</strong> changed from <i>14.00 h</i> to <i>20.00 h</i></li>
    </ul>
    <div id="journal-5875-notes" class="wiki"><p>I'm not convinced that there's an issue to be investigated with temporary files when an application crashes.  The application could provide an atExit() handler to clean up.  Libraries should not get involved with atExit() handlers which is a process responsibility (and therefore host application responsibility).  I'll say more about this later.</p>


	<p>The library does contain a thread unsafe function tempPath() which is called by BasicIo::AutoPtr FileIo::temporary() to create a temporary io stream.  The concept of tempPath() is horrible and I take the blame, it should be tempFile() and return an open FILE* and pathname.  Thread safe.  The BasicIo::AutoPtr FileIo::temporary() should call tempFile() and set a flag bool bDeleteOnClose in class FileIo.</p>


	<p>A better idea is to never use temporary files and use BasicIo::AutoPtr MemIo::temporary() const instead as it maintains the data in memory which will be cleaned when the BasicIo::AutoPtr goes out of scope.</p>


	<p>I am going to investigate removing BasicIo::AutoPtr FileIo::temporary() from the library and using BasicIo::AutoPtr MemIo::temporary() instead.</p>


	<p>If it's necessary to keep FileIo::temporary(), I will investigate tempFile() and add the bDelete flag.  I could add a BasicIo static function to return a list of all open tempFile() paths which could be called by the application's atExit() handler.  I don't intend to add such code for v0.26.</p></div>
    </div>
  </div>
  
  <div id="change-5876" class="journal has-notes">
    <div id="note-12">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-12" class="journal-link">#12</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4722">Ben Touchette</a> <a title="04 Mar 2017 12:13" href="/projects/exiv2/activity?from=2017-03-04">over 4 years</a> ago
      <span id="journal-5876-private_notes" class=""></span>
    </h4>

    <div id="journal-5876-notes" class="wiki"><p>If you do that what happens to classes using remoteio ?</p></div>
    </div>
  </div>
  
  <div id="change-5877" class="journal has-notes has-details">
    <div id="note-13">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-13" class="journal-link">#13</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="04 Mar 2017 13:44" href="/projects/exiv2/activity?from=2017-03-04">over 4 years</a> ago
      <span id="journal-5877-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>50</i> to <i>80</i></li>
       <li><strong>Estimated time</strong> changed from <i>20.00 h</i> to <i>15.00 h</i></li>
    </ul>
    <div id="journal-5877-notes" class="wiki"><p>No problem with remoteio.  The temporary files are used in the image handlers to create the metadata in a temporary file.  This is done within the safety of try/catch.  If the metadata is successfully written in temporary storage, it is "transferred" to the "real" file being processed (which may be a remote file).  So the temporary file is almost invisible to the remote file.  For sure, there is no concept in Exiv2 of a "temporary remote file".</p>


	<p>I have removed the API FileIo::temporary().  Every image handler uses BasicIo::MemIo for temporary storage.  No temporary FileIo objects are used by the library.  Everything is in memory.  Incidentally, those files are small as they only contain metadata.  Typically 5k-10k.  Test suite detects no issues.  Very pleased and happy.</p>


	<p>I've moved the horrible/ugly static tempPath() to actions.cpp which is compiled/linked with exiv2(.exe).  Whose idea was it to have a horror like that in the library?  I've added a mutex (on Unix) and a critical_section (on Windows) to make it thread safe.  I strongly dislike anything like this because it can dead-lock <em><strong>however</strong></em> it's only used by the function metacopy() in actions.cpp in exiv2(.exe) which isn't multi-threaded and is sample code.  It's good enough for purpose.</p>


	<p>I'll submit the code this evening.  It's a nice sunny Saturday afternoon in England and I'm going to do some work in the garden.</p></div>
    </div>
  </div>
  
  <div id="change-5878" class="journal has-notes has-details">
    <div id="note-14">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-14" class="journal-link">#14</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="05 Mar 2017 17:44" href="/projects/exiv2/activity?from=2017-03-05">over 4 years</a> ago
      <span id="journal-5878-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Resolved</i></li>
       <li><strong>% Done</strong> changed from <i>80</i> to <i>100</i></li>
    </ul>
    <div id="journal-5878-notes" class="wiki"><p>Fix submitted <a class="changeset" title="#1272 Use in-memory temporary files." href="/projects/exiv2/repository/exiv2/revisions/4717">r4717</a></p>


	<p>I investigated the possibility of tempPath() returning a FILE*.  This would provide the lock courtesy of fopen().  However this would require a new FileIo API to pass a FILE*.  Too risky at this time in v0.26.</p>


	<p>I'll close this in the next few days when it's building and passing the test suite on the buildserver.</p></div>
    </div>
  </div>
  
  <div id="change-5879" class="journal has-details">
    <div id="note-15">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-15" class="journal-link">#15</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="06 Mar 2017 13:38" href="/projects/exiv2/activity?from=2017-03-06">over 4 years</a> ago
      <span id="journal-5879-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Resolved</i> to <i>Closed</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-5881" class="journal has-details">
    <div id="note-16">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-16" class="journal-link">#16</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="09 Mar 2017 19:56" href="/projects/exiv2/activity?from=2017-03-09">over 4 years</a> ago
      <span id="journal-5881-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> changed from <i>jpeg parser</i> to <i>basicio</i></li>
    </ul>
    
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1272.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1272.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
