<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #1143: Unable to extract embedded preview from jpg for Sony a77 - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="Gp7m1cNFuKg9OUl55h1dsyaEAO8rQphCeAKiAd8P6vz40006sT90qGhdVnVZylGAGRZUltqhOfiFIjKJnDYNkw==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #1143: Unable to extract embedded preview from jpg for Sony a77" href="https://dev.exiv2.org/issues/1143.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #1143</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Unable to extract embedded preview from jpg for Sony a77</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/4592">Michael Waldor</a> <a title="24 Dec 2015 12:40" href="/projects/exiv2/activity?from=2015-12-24">almost 6 years</a> ago.
        Updated <a title="24 Apr 2016 05:51" href="/projects/exiv2/activity?from=2016-04-24">over 5 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">image format</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="28 Apr 2017" href="/versions/52">0.26</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">24 Dec 2015</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">15.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>By accident I have learned that my Sony A77 DSLR stores a preview image within the jpg output. That preview picture can be utilized by DigiKam as a fast preview - and that works fine. But if I try to extract that preview with exiv2 I encounter the error message</p>


	<p>exiv2 -p p screen.jpg <br />Error: Offset of directory Sony1, entry 0x2001 is out of bounds: Offset = 0x00784876; truncating the entry<br />Preview 1: image/jpeg, 160x120 pixels, 6530 bytes</p>


	<p>exiftool -previewimage -b screen.jpg > preview.jpg<br />sees this picture and can extract it.</p>


	<p>But now the ugly thing: During loading of all my figures from the last 4 years I asked digikam to autorotate portrait photos and fix the exifs accordingly. From all these photos even exiftool is unable to extract the preview image. But digikam still can display these previews not accessible to exiv2 or exiftool?!?!</p>


	<p>These are the versions used (as being included within Opensuse distribution):<br />exiftool 10.00<br />exiv2 0.25 001900<br />Suse leap 42.1<br />digikam 4.23</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/869">screen.jpg</a>    <span class="size">(8.09 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/869/screen.jpg">screen.jpg</a>  </td>
  <td>jpg directly from camera without digicam processing</td>
  <td>
      <span class="author">Michael Waldor, 24 Dec 2015 12:40</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/870">2015-12-06_005.jpg</a>    <span class="size">(6.15 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/870/2015-12-06_005.jpg">2015-12-06_005.jpg</a>  </td>
  <td>preprocessed jpeg from digikam - no preview seen by exiv2 or exiftool, but by digikam</td>
  <td>
      <span class="author">Michael Waldor, 24 Dec 2015 15:04</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/871">preview.jpg</a>    <span class="size">(570 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/871/preview.jpg">preview.jpg</a>  </td>
  <td></td>
  <td>
      <span class="author">Robin Mills, 24 Dec 2015 16:24</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/873">tamron.tgz</a>    <span class="size">(11.2 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/873/tamron.tgz">tamron.tgz</a>  </td>
  <td>tar ball with jpegs from different tamron lenses</td>
  <td>
      <span class="author">Michael Waldor, 27 Dec 2015 14:46</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>







<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/1143" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="RHNps4Tq+SoqA6mLpWPgJpQ/Xx/BJ/Ctm7uJP/m22SWmPsJc9pA1Kn9ntocatOwVq60LZjDEURdmmxm3uo8+Sg==" />
  <table class="list issues odd-even"><tr id="relation-190" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1144" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/1144">Bug #1144</a>: Sigma 10-20mm f/4-5.6 EX DC is detected as Tamaron </td><td class="status">Closed</td><td class="start_date">26 Dec 2015</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-191" class="issue hascontextmenu issue tracker-2 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="816" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-2 status-5 priority-4 priority-default closed" href="/issues/816">Feature #816</a>: Enable detection of Sigma 55-200mm lens</td><td class="status">Closed</td><td class="start_date">18 Mar 2012</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-192" class="issue hascontextmenu issue tracker-2 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1145" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-2 status-5 priority-4 priority-default closed" href="/issues/1145">Feature #1145</a>: Respect Sony/Minolta lenses with shared LensID such as Tamron SP AF 17-50mm F2.8 XR Di II LD</td><td class="status">Closed</td><td class="start_date">27 Dec 2015</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-196" class="issue hascontextmenu issue tracker-2 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1108" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-2 status-5 priority-4 priority-default closed" href="/issues/1108">Feature #1108</a>: Recursively dump sub-files of an image</td><td class="status">Closed</td><td class="start_date">21 Aug 2015</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-200" class="issue hascontextmenu issue tracker-2 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1153" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-2 status-5 priority-4 priority-default closed" href="/issues/1153">Feature #1153</a>: Sony ILCE-6000 + Sony E 50mm F1.8 OSS .JPG files without lens model.</td><td class="status">Closed</td><td class="start_date">11 Jan 2016</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-203" class="issue hascontextmenu issue tracker-1 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="1035" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-5 priority-4 priority-default closed" href="/issues/1035">Bug #1035</a>: Lens model not detected ( exiv2 -&gt; LensFun -&gt; darktable )</td><td class="status">Closed</td><td class="start_date">19 Feb 2015</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/1143/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=1143&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 4148" href="/projects/exiv2/repository/exiv2/revisions/4148">Revision 4148</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4148/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="27 Dec 2015 10:44" href="/projects/exiv2/activity?from=2015-12-27">almost 6 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Respect Sony/Minolta lenses with shared LensID such as Tamron SP AF 17-50mm F2.8 XR Di II LD (Closed)" href="/issues/1145">#1145</a>.  Fix submitted.</p>


	<p>I haven't submitted a change to the test suite at this time, however I'll do that when I resolve <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Unable to extract embedded preview from jpg for Sony a77 (Closed)" href="/issues/1143">#1143</a>.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4155" href="/projects/exiv2/repository/exiv2/revisions/4155">Revision 4155</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4155/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="28 Dec 2015 21:21" href="/projects/exiv2/activity?from=2015-12-28">almost 6 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Unable to extract embedded preview from jpg for Sony a77 (Closed)" href="/issues/1143">#1143</a>.  Partial solution.  I have suppressed the warning and allocated memory for Exif.Sony1.Preview.  So now the size is revealed to the user.  However: for reasons documented in the code, I am unable to locate the image in the source file and copy it into the metadata.</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-4571" class="journal has-notes has-details">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Dec 2015 14:06" href="/projects/exiv2/activity?from=2015-12-24">almost 6 years</a> ago
      <span id="journal-4571-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> set to <i>not-a-bug</i></li>
       <li><strong>Status</strong> changed from <i>New</i> to <i>Resolved</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Target version</strong> set to <i>0.26</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>100</i></li>
       <li><strong>Estimated time</strong> set to <i>1.00 h</i></li>
    </ul>
    <div id="journal-4571-notes" class="wiki"><p>Ah, you're being gentle on me and giving me an easy puzzle for Christmas.  The option -pp lists previews (as in print preview).  The option -ep extracts previews.  So:<pre>585 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 --verbose --force -ep http://dev.exiv2.org/attachments/download/869/screen.jpg
File 1/1: http://dev.exiv2.org/attachments/download/869/screen.jpg
Error: Offset of directory Sony1, entry 0x2001 is out of bounds: Offset = 0x00784876; truncating the entry
Writing preview 1 (image/jpeg, 160x120 pixels, 6530 bytes) to file screen-preview1.jpg
586 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>The option --verbose prints "Writing preview 1...." and --force means "overwrite files without asking permission".  The warning: <pre>Error: Offset of directory Sony1, entry 0x2001 is out of bounds: Offset = 0x00784876; truncating the entry</pre>is a little confusing.  It's saying "The Sony makernote is referencing part of your file that is out of the bounds of the makernote.".  This is a violation of the Exif specification.  This is a common warning from Sony files and discussed here.  <a class="external" href="http://dev.exiv2.org/issues/1108#note-1">http://dev.exiv2.org/issues/1108#note-1</a></p>


	<p>The warning is written to errout and can be piped into oblivion.<pre>586 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 --verbose --force -ep http://dev.exiv2.org/attachments/download/869/screen.jpg 2&gt;/dev/null
File 1/1: http://dev.exiv2.org/attachments/download/869/screen.jpg
Writing preview 1 (image/jpeg, 160x120 pixels, 6530 bytes) to file screen-preview1.jpg
587 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre></p>


	<p>I'm going to mark this 100% Resolved not-a-bug.  If you wish to discuss this further you are welcome to update this issue report.  If nothing else arises, I'll close this issue at the end of January.</p>


	<p>Happy Holidays</p>


	<p><img src="http://exiv2.org/Exiv2Logo.png" alt="" /></p></div>
    </div>
  </div>
  
  <div id="change-4572" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Dec 2015 14:36" href="/projects/exiv2/activity?from=2015-12-24">almost 6 years</a> ago
      <span id="journal-4572-private_notes" class=""></span>
    </h4>

    <div id="journal-4572-notes" class="wiki"><p>I've had another read at your issue report and more carefully read: <em>But now the ugly thing</em></p>


	<p>You'll have to send me an image with which to investigate this.  The preview may been removed, or damaged beyond repair, however DigiKam may have retained a preview in the database.</p></div>
    </div>
  </div>
  
  <div id="change-4573" class="journal has-notes has-details">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4592">Michael Waldor</a> <a title="24 Dec 2015 15:04" href="/projects/exiv2/activity?from=2015-12-24">almost 6 years</a> ago
      <span id="journal-4573-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/870">2015-12-06_005.jpg</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/870/2015-12-06_005.jpg">2015-12-06_005.jpg</a> added</li>
    </ul>
    <div id="journal-4573-notes" class="wiki"><p>Thanks for your fast reply. I come back to my first message ...</p>


	<p>1. Of course I could extract the thumbnail image. BUT: Using exiftool I could as well extract a preview figure packed within my screen.jpg with size 1616 x 1080. I assume that this preview image is somehow hidden behind Sony specific manufacturer tags.</p>


	<p>... and to your second reply<br />2. After processing such a picture by digikam (doing an autorotate just to help some jpeg viewers) the main jpeg is rotated and its orientation flag is fixed. But the thumbnail is NOT rotated, and its orientation is not changed. It's not nice, but consistent. BUT: As a sideeffect the preview image seems to be completely obscured and is neither accessible by exiv2 nor by exiftool. exiftool stills knows about the preview's size. But digikam sees it somehow completely (and can even display it if I select the preview display option). I have added such an jpeg...</p>


	<p>Thus I still feel that something is going wrong.</p>


	<p>Hope you will enjoy Christmas nevertheless:-)</p>


	<p>Michael</p></div>
    </div>
  </div>
  
  <div id="change-4574" class="journal has-notes has-details">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Dec 2015 16:24" href="/projects/exiv2/activity?from=2015-12-24">almost 6 years</a> ago
      <span id="journal-4574-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/871">preview.jpg</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/871/preview.jpg">preview.jpg</a> added</li>
       <li><strong>Category</strong> changed from <i>not-a-bug</i> to <i>image format</i></li>
       <li><strong>% Done</strong> changed from <i>100</i> to <i>20</i></li>
       <li><strong>Estimated time</strong> changed from <i>1.00 h</i> to <i>10.00 h</i></li>
    </ul>
    <div id="journal-4574-notes" class="wiki"><p>Ah, there isn't a Santa Claus after all.  You've dumped a couple of corkers on me and I don't mean bottles of Champagne!</p>


	<p>1 There's a mysterious hidden 1616x1080 preview image.<br />2 The thumbnail and image orientation can be in some kind of conflict</p>


	<p><em><strong>1 Mysterious hidden 1616x1080 preview image</strong></em></p>


	<p>I've extracted preview with exiftool and attached him to this issue:<pre>607 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiftool -previewimage -b screen.jpg &gt; preview.jpg
608 rmills@rmillsmbp:~/gnu/exiv2/trunk $ ls -alt preview.jpg
-rw-r--r--+ 1 rmills  staff  583985 24 Dec 15:20 preview.jpg
609 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>He's quite large.  My instant guess is <em>"That's what's in the illegal makernote reference that we have (inconveniently) ignored.".</em>  583985 bytes can't be in the makernote which is 38792 bytes.<pre>610 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pa --grep makernote/i http://dev.exiv2.org/attachments/download/869/screen.jpg 2&gt;/dev/null
Exif.Photo.MakerNote                         Undefined 38972  (Binary value suppressed)
Exif.MakerNote.Offset                        Long        1  922
Exif.MakerNote.ByteOrder                     Ascii       3  II</pre>I've tried extracting him:<pre> $ dd bs=1 skip=$((0x00784876)) count=583985 if=screen.jpg of=incredible.jpg </pre>It's not a JPG.  I've sniffed around unsuccessfully with a hex editor in screen.jpg without spotting preview.jpg sitting waiting for me to put some handcuffs on him.  I'll look again another day.</p>


	<p><em><strong>2 The thumbnail and image orientation</strong></em></p>


	<p>preview.jpg has metadata:<pre>611 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pa preview.jpg 
Exif.Image.XResolution                       Rational    1  72
Exif.Image.YResolution                       Rational    1  72
Exif.Image.ResolutionUnit                    Short       1  inch
Exif.Image.ExifTag                           Long        1  78
Exif.Photo.PixelXDimension                   Long        1  1616
Exif.Photo.PixelYDimension                   Long        1  1080
612 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre></p>


	<p>I believe that previews normally do not have metadata.  However this preview.jpg has metadata.  I believe it's possible to rotate an image by modifying the Orientation metadata.  This is almost instant and lossless as it's not necessary to think about the pixels.</p>


	<p>Curiously, screen.jpg has distinct keys for Thumbnail and Image Orientation:<pre>615 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pa --grep orientation/i http://dev.exiv2.org/attachments/download/869/screen.jpg 2&gt;/dev/null
Exif.Image.Orientation                       Short       1  top, left
Exif.Thumbnail.Orientation                   Short       1  top, left
616 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>And these have been edited independently by DigiKam in 2015-12-06_005.jpg<pre>617 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pa --grep orientation/i http://dev.exiv2.org/attachments/download/870/2015-12-06_005.jpg
Exif.Image.Orientation                       Short       1  top, left
Exif.Thumbnail.Orientation                   Short       1  left, bottom
Xmp.tiff.Orientation                         XmpText     1  top, left
618 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>Maybe this is causing an issue.  What do you think?  Can I ask you to modify Exif.Thumbnail.Orientation (and Exif.Image.Orientation) and examine the consequences in DigiKam.</p>


	<p>I've reset this to 20% solved and I'm guessing 10 hours work to nail these puzzles: a further 4 hours on each of items 1 and 2.  May I ask you to:</p>


	<p>1) Sniff around in screen.jpg to see if you can find preview.jpg - he must be in there somewhere.<br />2) Investigate the dance between DigiKam and Exif.Thumbnail.Orientation and Exif.Image.Orientation.</p></div>
    </div>
  </div>
  
  <div id="change-4575" class="journal has-notes has-details">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="25 Dec 2015 15:07" href="/projects/exiv2/activity?from=2015-12-25">almost 6 years</a> ago
      <span id="journal-4575-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>20</i> to <i>40</i></li>
    </ul>
    <div id="journal-4575-notes" class="wiki"><p>OK, I've mostly solved puzzle 1: <em><strong>Mysterious hidden 1616x1080 preview image</em></strong></p>


	<p>It's in screen.jpg starting at byte 0x784800 which is a few bytes before the warning.<br /><pre>661 rmills@rmillsmbp:~/temp $ exiv2 -pa screen.jpg &gt;/dev/null
Error: Offset of directory Sony1, entry 0x2001 is out of bounds: Offset = 0x00784876; truncating the entry
662 rmills@rmillsmbp:~/temp $ ls -alt screen.jpg
-rw-r--r--+ 1 rmills  staff  8486912 24 Dec 13:46 screen.jpg
663 rmills@rmillsmbp:~/temp $ dd bs=1 skip=$((0x00784800)) count=$((8486912-0x00784800)) if=screen.jpg of=mystery.jpg
604160+0 records in
604160+0 records out
604160 bytes transferred in 1.697599 secs (355891 bytes/sec)
664 rmills@rmillsmbp:~/temp $ exiv2 -pS mystery.jpg 
STRUCTURE OF JPEG FILE: mystery.jpg
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xe1 APP1  |     160 | Exif..II*...............&gt;......
     166 | 0xdb DQT   |     132 
     300 | 0xc4 DHT   |     418 
     720 | 0xc0 SOF0  |      17 
     739 | 0xda SOS   |      12 
665 rmills@rmillsmbp:~/temp $ exiv2 -pa mystery.jpg 
Exif.Image.XResolution                       Rational    1  72
Exif.Image.YResolution                       Rational    1  72
Exif.Image.ResolutionUnit                    Short       1  inch
Exif.Image.ExifTag                           Long        1  78
Exif.Photo.PixelXDimension                   Long        1  1616
Exif.Photo.PixelYDimension                   Long        1  1080
666 rmills@rmillsmbp:~/temp $ </pre>And there's metadata Exiv2.Sony1.PreviewImage that indicates the presence of this additional preview.<pre>680 rmills@rmillsmbp:~/temp $ exiv2 -pa --grep Preview screen.jpg   2&gt;/dev/null
Exif.Sony1.PreviewImage                      Undefined   0  
Exif.Sony1.PreviewImageSize                  Long        2  1080 x 1616
681 rmills@rmillsmbp:~/temp $ </pre>I have to solve the puzzle of how to know the location is 0x784800.<pre>681 rmills@rmillsmbp:~/temp $ echo $((0x784800))
7882752
682 rmills@rmillsmbp:~/temp $ </pre>I'll figure that in the next day or two and then consider updating our preview code to respect this guy.  There is an APP2 segment which contains a little tiff object.<pre>686 rmills@rmillsmbp:~/temp $ exiv2 -pS screen.jpg 
STRUCTURE OF JPEG FILE: screen.jpg
 address | marker     | length  | data
       2 | 0xd8 SOI   |       0 
       4 | 0xe1 APP1  |   46888 | Exif..II*........... ..........
   46894 | 0xe2 APP2  |     210 | MPF.II*...............0100.....
   47106 | 0xdb DQT   |     132 
   47240 | 0xc4 DHT   |     418 
   47660 | 0xc0 SOF0  |      17 
   47679 | 0xda SOS   |      12 
687 rmills@rmillsmbp:~/temp $ dd bs=1 skip=$((46894+6)) count=$((210-6)) if=screen.jpg of=screen.tif
204+0 records in
204+0 records out
204 bytes transferred in 0.000751 secs (271631 bytes/sec)
688 rmills@rmillsmbp:~/temp $ exiv2 -pS screen.tif 
STRUCTURE OF TIFF FILE (II): screen.tif
 address |    tag                           |      type |    count |   offset | value
      10 | 0xb000                           | UNDEFINED |        4 |808464688 | 
      22 | 0xb001                           |      LONG |        1 |        2 | 2
      34 | 0xb002                           | UNDEFINED |       32 |       50 |  ...
689 rmills@rmillsmbp:~/temp $ </pre></p>


	<p>About puzzle 2: <em><strong>The thumbnail and image orientation</strong></em></p>


	<p>I'm not going to do any work on this matter.  I don't feel this is an exiv2 puzzle.  Have you discussed this with my friend Gilles at DigiKam?</p>


	<p>OK, Turkey Time.  I'm off for Christmas lunch with my family.</p></div>
    </div>
  </div>
  
  <div id="change-4576" class="journal has-notes">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4592">Michael Waldor</a> <a title="25 Dec 2015 17:24" href="/projects/exiv2/activity?from=2015-12-25">almost 6 years</a> ago
      <span id="journal-4576-private_notes" class=""></span>
    </h4>

    <div id="journal-4576-notes" class="wiki"><p>Hope you don't spend too much time fiddling with software issues instead of enjoying Christmas season...</p>


	<p>I have investigated my exif problem from digikam's perspective. Now I have discovered the reason when pictures got different orientations. Only for those figures I have applied GPS coordinates. And if I add GPS data, the file must be written by digikam. And portrait photos are then rotated automatically (because I have configured that). New (minor) mystery: All pictures get GPS data and are written, but only the portrait ones get additional exif informations (image width/height, processing software) not added for landscape ones. Maybe I'll discuss this within digikam forum... I think that's a feature and not a bug.</p>


	<p>BTW I look into orientation problems due to another device: I'm using a linux based digital satellite receiver with openatv. It can also display jpegs, but sometimes portrait pictures are displayed in a wrong orientation. Till yesterday I had believed that all pictures will be rotated during download by digikam. Now I've learned that the rotation is only applied if saving GPS coordinates explaining the "random" behaviour.<br />Sadly openatv doesn't use your exiv2 library but their own implementation<br />(<a class="external" href="https://github.com/openatv/enigma2/blob/master/lib/gdi/picexif.cpp">https://github.com/openatv/enigma2/blob/master/lib/gdi/picexif.cpp</a>). The orientation extracted by that routine by error reports the orientation of the embedded preview.</p>


	<p>Conclusion: The simplest solution to my problem is to rotate all portrait figures with a small shell script/digikam batch if they are not already rotated. And for new downloads I'll have a look onto the options for downloading within digikam (there IS one to enforce auto rotation, I'm quite sure).</p></div>
    </div>
  </div>
  
  <div id="change-4577" class="journal has-notes">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="25 Dec 2015 20:30" href="/projects/exiv2/activity?from=2015-12-25">almost 6 years</a> ago
      <span id="journal-4577-private_notes" class=""></span>
    </h4>

    <div id="journal-4577-notes" class="wiki"><p>Michael: Thanks for looking into all of this while Alison and I have been enjoying a wonderful Christmas Afternoon and Dinner with my son and his family.</p>


	<p>I'm confident about solving <em><strong>Puzzle 1</strong></em> and I'll take care of it in the next few days.</p>


	<p><em><strong>Puzzle 2</strong></em> is getting more complex and adding this portrait/GPS complication.  I was under the impression that DigiKam performs all metadata processing using libexiv2 exclusively.  However I also believe that our preview code does not permit metadata in preview images.  So I think something outside of libexiv2 is being done by DigiKam to handle Exif.Sony1.PreviewImage.</p>


	<p>I didn't write Exiv2 - that honour goes to Andreas with great contributions from Brad, Gilles, Volker and others.  However it's my agenda to strongly discourage applications from using home-made metadata code.  Why roll-your-own, when you can get a mature, well-written, tested, documented, supported, cross-platform open-source library?  I'd like to see Apple, Adobe, Microsoft and Google put their talents and efforts into Exiv2.  Everybody would benefit.   Spread the word!</p>


	<p>For sure, <em><strong>Puzzle 2++</strong></em> is now so multi-faceted that I can only agree with your conclusion.  Scripting to fix your library of images sounds like a good plan.  If I can help, please let me know.</p></div>
    </div>
  </div>
  
  <div id="change-4578" class="journal has-notes">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="26 Dec 2015 15:55" href="/projects/exiv2/activity?from=2015-12-26">almost 6 years</a> ago
      <span id="journal-4578-private_notes" class=""></span>
    </h4>

    <div id="journal-4578-notes" class="wiki"><p>Michael:  I've just notice that Exiv2 has not detected the lens you are using.  Here's what I see:<pre>551 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pa --grep Lens ~/temp/screen.jpg 2&gt;/dev/null
Exif.Sony1.LensID                            Long        1  Tamron SP AF 17-50mm F2.8 XR Di II LD Aspherical 
    | Tamron AF 18-250mm F3.5-6.3 XR Di II LD 
    | Tamron AF 55-200mm F4-5.6 Di II LD Macro 
    | Tamron AF 70-300mm F4-5.6 Di LD Macro 1:2 
    | Tamron SP AF 200-500mm F5.0-6.3 Di LD IF 
    | Tamron SP AF 10-24mm F3.5-4.5 Di II LD Aspherical IF 
    | Tamron SP AF 70-200mm F2.8 Di LD IF Macro 
    | Tamron SP AF 28-75mm F2.8 XR Di LD Aspherical IF 
    | Tamron AF 90-300mm F4.5-5.6 Telemacro
Exif.Photo.LensSpecification                 Rational    4  0/10 0/10 0/10 0/10
Exif.Photo.LensModel                         Ascii       5  ----
552 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>Which lens are you using?</p></div>
    </div>
  </div>
  
  <div id="change-4581" class="journal has-notes">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4592">Michael Waldor</a> <a title="27 Dec 2015 08:02" href="/projects/exiv2/activity?from=2015-12-27">almost 6 years</a> ago
      <span id="journal-4581-private_notes" class=""></span>
    </h4>

    <div id="journal-4581-notes" class="wiki"><p>The first one - a Tamron SP AF 17-50mm F2.8 XR Di II LD Aspherical</p>


	<p>That would be great if the Tamron lens could be identified correctly. I thought that all Tamron lenses would use the same lens ID.</p>


	<p>If it might help I can send to you pictures from several other Tamron lenses, too (90mm, 70-300mm, 18-200mm, 11-17mm) - I exclusively use Tamron lenses. But I should extract the exif information only to reduce the data amount transported. Can I do that with exiv2?</p></div>
    </div>
  </div>
  
  <div id="change-4582" class="journal has-notes has-details">
    <div id="note-10">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-10" class="journal-link">#10</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="27 Dec 2015 08:47" href="/projects/exiv2/activity?from=2015-12-27">almost 6 years</a> ago
      <span id="journal-4582-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Resolved</i> to <i>Assigned</i></li>
       <li><strong>% Done</strong> changed from <i>40</i> to <i>50</i></li>
    </ul>
    <div id="journal-4582-notes" class="wiki"><p>Thanks for getting back to me.  After I asked you about the Lens, I thought "Ah I'll use exiftool" and of course he knew. <pre>$ exiftool ~/temp/screen.jpg 2&gt;/dev/null | grep -i lens
Lens Type                       : Tamron Lens (255)
Lens Spec                       : Unknown (00 0 0 0 0 00)
Lens Mount                      : A-mount
Lens Format                     : Full-frame
Lens Spec Features              : 
Lens Info                       : 0mm f/0
Lens Model                      : ----
Lens ID                         : Tamron SP AF 17-50mm F2.8 XR Di II LD Aspherical
762 rmills@rmillsmbp:~/clanmills $ </pre>Your LensId is 0xff:<pre>$ exiv2 -pv --grep lens/i ~/temp/screen.jpg 2&gt;/dev/null 
0xb027 Sony1        LensID                      Long        1  255
0xa432 Photo        LensSpecification           Rational    4  0/10 0/10 0/10 0/10
0xa434 Photo        LensModel                   Ascii       5  ----
$</pre>And we know about 9 Tamron Lenses that share that ID.<pre>$ exiv2 -pa --grep lens/i ~/temp/screen.jpg 2&gt;/dev/null | sed -e 's/|/  \'$'\n''|/g' 
Tamron SP AF 17-50mm F2.8 XR Di II LD Aspherical   
| Tamron AF 18-250mm F3.5-6.3 XR Di II LD   
| Tamron AF 55-200mm F4-5.6 Di II LD Macro   
| Tamron AF 70-300mm F4-5.6 Di LD Macro 1:2   
| Tamron SP AF 200-500mm F5.0-6.3 Di LD IF   
| Tamron SP AF 10-24mm F3.5-4.5 Di II LD Aspherical IF   
| Tamron SP AF 70-200mm F2.8 Di LD IF Macro   
| Tamron SP AF 28-75mm F2.8 XR Di LD Aspherical IF   
| Tamron AF 90-300mm F4.5-5.6 Telemacro
Exif.Photo.LensSpecification                 Rational    4  0/10 0/10 0/10 0/10
Exif.Photo.LensModel                         Ascii       5  ----
$ </pre>We don't have any <em><strong>magic</strong></em> in our code for Minolta/Sony lenses.  Send me sample images using different lens/camera combinations and I'll see what I can do.</p>


	<p>Phil (Harvey of exiftool) has already done this and pointed me to his beautiful perl code that contains his <em><strong>magic</strong></em>.  It's beautiful and ingenious perl.  Can I can transform it into C++?  Not easy as it uses perl hashes/arrays/references that can't easily be represented in C++.</p>


	<p>I'm thinking I might call exiftool when I encounter a shared LensID.  Cheating?  Maybe.  Effective?  We'll see.  If I can get this to work, I'll ask Phil to bless this.  Exiv2 has a good friendly relationship with Phil.</p>


	<p>So, yes please attach images of different camera/lens combinations and I'll see that I can do.</p>


	<p><img src="http://clanmills.com/Exiv2Facebook.png" alt="" /></p></div>
    </div>
  </div>
  
  <div id="change-4583" class="journal has-notes">
    <div id="note-11">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-11" class="journal-link">#11</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="27 Dec 2015 09:38" href="/projects/exiv2/activity?from=2015-12-27">almost 6 years</a> ago
      <span id="journal-4583-private_notes" class=""></span>
    </h4>

    <div id="journal-4583-notes" class="wiki"><p>For completeness, here is Phil's code.  <a class="external" href="http://sourceforge.net/p/exiftool/code/ci/master/tree/lib/Image/ExifTool/Exif.pm#l3580">http://sourceforge.net/p/exiftool/code/ci/master/tree/lib/Image/ExifTool/Exif.pm#l3580</a></p>


	<p>Lines: 3576-3730:<pre>#------------------------------------------------------------------------------
# Attempt to identify the specific lens if multiple lenses have the same LensType
# Inputs: 0) ExifTool object ref, 1) LensType print value, 2) PrintConv hash ref,
#         3) LensSpec print value, 4) LensType numerical value, 5) FocalLength,
#         6) MaxAperture, 7) MaxApertureValue, 8) MinFocalLength, 9) MaxFocalLength,
#         10) LensModel, 11) LensFocalRange, 12) LensSpec
sub PrintLensID($$@)
{
    my ($et, $lensTypePrt, $printConv, $lensSpecPrt, $lensType, $focalLength,
        $maxAperture, $maxApertureValue, $shortFocal, $longFocal, $lensModel,
        $lensFocalRange, $lensSpec) = @_;
    # this logic relies on the LensType lookup:
    return undef unless defined $lensType;
    # get print conversion hash if necessary
    $printConv or $printConv = $$et{TAG_INFO}{LensType}{PrintConv};
    # just copy LensType PrintConv value if it was a lens name
    # (Olympus or Panasonic -- just exclude things like Nikon and Leaf LensType)
    unless (ref $printConv eq 'HASH') {
        if (ref $printConv eq 'ARRAY' and ref $$printConv[0] eq 'HASH') {
            $printConv = $$printConv[0];
            $lensTypePrt =~ s/;.*//;
            $lensType =~ s/ .*//;
        } else {
            return $lensTypePrt if $lensTypePrt =~ /mm/;
            return $lensTypePrt if $lensTypePrt =~ s/(\d)\/F/$1mm F/;
            return undef;
        }
    }
    # get LensSpec information if available (Sony)
    my ($sf0, $lf0, $sa0, $la0);
    if ($lensSpecPrt) {
        ($sf0, $lf0, $sa0, $la0) = GetLensInfo($lensSpecPrt);
        undef $sf0 unless $sa0; # (make sure aperture isn't zero)
    }
    # use MaxApertureValue if MaxAperture is not available
    $maxAperture = $maxApertureValue unless $maxAperture;
    if ($lensFocalRange and $lensFocalRange =~ /^(\d+)(?: (?:to )?(\d+))?$/) {
        ($shortFocal, $longFocal) = ($1, $2 || $1);
    }
    if ($$et{Make} eq 'SONY') {
        # patch for Metabones Canon adapters on Sony cameras (ref Jos Roost)
        # (the Metabones adapters add 0xef00 or 0x7700 to the high byte
        # for 2-byte LensType values, so we need to adjust for these)
        if ($lensType != 0xffff) {
            require Image::ExifTool::Minolta;
            if ($Image::ExifTool::Minolta::metabonesID{$lensType &#38; 0xff00}) {
                $lensType -= ($lensType &gt;= 0xef00 ? 0xef00 : $lensType &gt;= 0xbc00 ? 0xbc00 : 0x7700);
                require Image::ExifTool::Canon;
                $printConv = \%Image::ExifTool::Canon::canonLensTypes;
                $lensTypePrt = $$printConv{$lensType} if $$printConv{$lensType};
            }
        }
    } elsif ($shortFocal and $longFocal) {
        # Canon (and some other makes) include makernote information
        # which allows better lens identification
        require Image::ExifTool::Canon;
        return Image::ExifTool::Canon::PrintLensID($printConv, $lensType,
                    $shortFocal, $longFocal, $maxAperture, $lensModel);
    }
    my $lens = $$printConv{$lensType};
    return ($lensModel || $lensTypePrt) unless $lens;
    return $lens unless $$printConv{"$lensType.1"};
    $lens =~ s/ or .*//s;    # remove everything after "or" 
    # make list of all possible matching lenses
    my @lenses = ( $lens );
    my $i;
    for ($i=1; $$printConv{"$lensType.$i"}; ++$i) {
        push @lenses, $$printConv{"$lensType.$i"};
    }
    # attempt to determine actual lens
    my (@matches, @best, @user, $diff);
    foreach $lens (@lenses) {
        push @user, $lens if $Image::ExifTool::userLens{$lens};
        # sf = short focal
        # lf = long focal
        # sa = max aperture at short focal
        # la = max aperture at long focal
        my ($sf, $lf, $sa, $la) = GetLensInfo($lens);
        next unless $sf;
        # check against LensSpec parameters if available
        if ($sf0) {
            next if abs($sf - $sf0) &gt; 0.5 or abs($sa - $sa0) &gt; 0.15 or
                    abs($lf - $lf0) &gt; 0.5 or abs($la - $la0) &gt; 0.15;
            # the basic parameters match, but also check against additional lens features:
            # for Sony A and E lenses, the full LensSpec string should match with end of LensType,
            # excluding any part between () at the end, and preceded by a space (the space
            # ensures that e.g. Zeiss Loxia 21mm having LensSpec "E 21mm F2.8" will not be
            # identified as "Sony FE 21mm F2.8 (SEL28F20 + SEL075UWC)")
            $lensSpecPrt and $lens =~ / \Q$lensSpecPrt\E( \(|$)/ and @best = ( $lens ), last;
            # exactly-matching Sony lens should have been found above, so only add non-Sony lenses
            push @best, $lens unless $lens =~ /^Sony /;
            next;
        }
        # adjust focal length and aperture if teleconverter is attached (Minolta)
        if ($lens =~ / \+ .*? (\d+(\.\d+)?)x( |$)/) {
            $sf *= $1;  $lf *= $1;
            $sa *= $1;  $la *= $1;
        }
        # see if we can rule out this lens using FocalLength and MaxAperture
        if ($focalLength) {
            next if $focalLength &lt; $sf - 0.5;
            next if $focalLength &gt; $lf + 0.5;
        }
        if ($maxAperture) {
            # it seems that most manufacturers set MaxAperture and MaxApertureValue
            # to the maximum aperture (smallest F number) for the current focal length
            # of the lens, so assume that MaxAperture varies with focal length and find
            # the closest match (this is somewhat contrary to the EXIF specification which
            # states "The smallest F number of the lens", without mention of focal length)
            next if $maxAperture &lt; $sa - 0.15;  # (0.15 is arbitrary)
            next if $maxAperture &gt; $la + 0.15;
            # now determine the best match for this aperture
            my $aa; # approximate maximum aperture at this focal length
            if ($sf == $lf or $sa == $la or $focalLength &lt;= $sf) {
                # either 1) prime lens, 2) fixed-aperture zoom, or 3) zoom at min focal
                $aa = $sa;
            } elsif ($focalLength &gt;= $lf) {
                $aa = $la;
            } else {
                # assume a log-log variation of max aperture with focal length
                # (see http://regex.info/blog/2006-10-05/263)
                $aa = exp(log($sa) + (log($la)-log($sa)) / (log($lf)-log($sf)) *
                                     (log($focalLength)-log($sf)));
                # a linear relationship between 1/FocalLength and 1/MaxAperture fits Sony better (ref 27)
                #$aa = 1 / (1/$sa + (1/$focalLength - 1/$sf) * (1/$la - 1/$sa) / (1/$lf - 1/$sf));
            }
            my $d = abs($maxAperture - $aa);
            if (defined $diff) {
                $d &gt; $diff + 0.15 and next;     # (0.15 is arbitrary)
                $d &lt; $diff - 0.15 and undef @best;
            }
            $diff = $d;
            push @best, $lens;
        }
        push @matches, $lens;
    }
    # return the user-defined lens if it exists
    if (@user) {
        # choose the best match if we have more than one
        if (@user &gt; 1) {
            my ($try, @good);
            foreach $try (\@best, \@matches) {
                $Image::ExifTool::userLens{$_} and push @good, $_ foreach @$try;
                return join(' or ', @good) if @good;
            }
        }
        return join(' or ', @user);
    }
    # return the best match(es) from the possible lenses
    return join(' or ', @best) if @best;
    return join(' or ', @matches) if @matches;
    $lens = $$printConv{$lensType};
    return $lensModel if $lensModel and $lens =~ / or /; # (eg. Sony NEX-5N)
    return $lens;
}</pre></p></div>
    </div>
  </div>
  
  <div id="change-4586" class="journal has-notes has-details">
    <div id="note-12">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-12" class="journal-link">#12</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4592">Michael Waldor</a> <a title="27 Dec 2015 14:46" href="/projects/exiv2/activity?from=2015-12-27">almost 6 years</a> ago
      <span id="journal-4586-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/873">tamron.tgz</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/873/tamron.tgz">tamron.tgz</a> added</li>
    </ul>
    <div id="journal-4586-notes" class="wiki"><p>I have taken some sample shots with all my tamron lenses (appended as tar ball). I have chosen the lowest resolution available, but the jpegs still occupy at least 2MB:-(</p>


	<p>The lenses are<br />Tamron SP AF 11-18mm F4.5-5.6 Di II  LD<br />Tamron SP AF 17-50mm F2.8 XR Di II LD Aspherical<br />Tamron AF 18-200mm F3.5-6.3 XR Di II LD Macro<br />Tamron SP AF 70-300mm F4-5.6 Di USD<br />Tamron SP AF 90mm F2.8 Di Macro 1:1<br />and the jpegs have the focal length in their names.</p>


	<p>Thanks for considering Tamron lenses to be recognized by exiv2,<br />Michael</p></div>
    </div>
  </div>
  
  <div id="change-4587" class="journal has-notes has-details">
    <div id="note-13">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-13" class="journal-link">#13</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="27 Dec 2015 16:15" href="/projects/exiv2/activity?from=2015-12-27">almost 6 years</a> ago
      <span id="journal-4587-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>50</i> to <i>60</i></li>
       <li><strong>Estimated time</strong> changed from <i>10.00 h</i> to <i>20.00 h</i></li>
    </ul>
    <div id="journal-4587-notes" class="wiki"><p>Thanks.  I opened that as a separate issue for working on the Tamron Lens issues.  I will attach your bundle to issue: <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Respect Sony/Minolta lenses with shared LensID such as Tamron SP AF 17-50mm F2.8 XR Di II LD (Closed)" href="/issues/1145">#1145</a>.</p>


	<p>I'm in trouble with Puzzle 1:  <em><strong>Mysterious hidden 1616x1080 preview image</em></strong>  There are 3 serious difficulties with implementing this:</p>


	<ol>
	<li>I have implemented a solution which caused a change in the API.  That change ripples across 18 files.</li>
		<li>It requires a static in TiffWorker (because the TiffWorker::Decoder is static).  The decoder is thread-safe, however a static IO_ reference is not.  This will  break our thread safety model.</li>
		<li>Although I can obtain the size of the preview at 583985 bytes, I don't know exactly where it is located (the warning is near, but not at the location of the hidden preview).</li>
	</ol>


	<p>I have to take a break from this for couple of days.  I cannot submit this "fix".</p>


	<p>The difficulty is being caused by TiffVisitor which is event driven code for parsing Tiff Dictionaries.  TiffVisitor does not know the source of the bytes he is fed.  To reference the IO object in TiffVisitor, I have to update every image handler in the code (jpg, tiff, cr2, png, tiff, etc).  I have to update both the .cpp and .hpp files.</p>


	<p>I'm quite sure there's another way to deal with this.  Having approximately located this image, and knowing his size, I think I can provide a thread-safe function to extract him.  Changing TiffVisitor (and all his clients) is not the correct solution.  And once I have the image, I have to visit the preview code and get him to respect the new bandit.</p>


	<p>As I said on the day before Christmas, you've dropped a corker on me.  I didn't write Exiv2 - so there's a lot of thinking and learning to get this fixed.  I've pushed the solution estimate to 20 hours.</p></div>
    </div>
  </div>
  
  <div id="change-4589" class="journal has-details">
    <div id="note-14">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-14" class="journal-link">#14</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="27 Dec 2015 16:30" href="/projects/exiv2/activity?from=2015-12-27">almost 6 years</a> ago
      <span id="journal-4589-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>60</i> to <i>50</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-4607" class="journal has-notes has-details">
    <div id="note-15">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-15" class="journal-link">#15</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="28 Dec 2015 21:36" href="/projects/exiv2/activity?from=2015-12-28">almost 6 years</a> ago
      <span id="journal-4607-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>50</i> to <i>70</i></li>
    </ul>
    <div id="journal-4607-notes" class="wiki"><p>Partial fix submitted: <a class="changeset" title="#1143.  Partial solution.  I have suppressed the warning and allocated memory for Exif.Sony1.Prev..." href="/projects/exiv2/repository/exiv2/revisions/4155">r4155</a>.   This fix suppresses the warning (only for Exif.Sony1.PreviewImage) and allocates a 'hollow' block of memory.<pre>$ exiv2 -pa --grep Preview http://dev.exiv2.org/attachments/download/869/screen.jpg
Exif.Sony1.PreviewImage                      Undefined 583855  (Binary value suppressed)
Exif.Sony1.PreviewImageSize                  Long        2  1080 x 1616
$ </pre>This is a difficult issue for reasons explained in <a class="changeset" title="#1143.  Partial solution.  I have suppressed the warning and allocated memory for Exif.Sony1.Prev..." href="/projects/exiv2/repository/exiv2/revisions/4155">r4155</a>.  It might be possible to populate the Exif.Sony1.PreviewImage image in a post process when we recover Exif.Sony1.LensID.  Andreas might be willing to look at this in 2016.</p></div>
    </div>
  </div>
  
  <div id="change-4957" class="journal has-notes has-details">
    <div id="note-16">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-16" class="journal-link">#16</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Apr 2016 05:51" href="/projects/exiv2/activity?from=2016-04-24">over 5 years</a> ago
      <span id="journal-4957-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Closed</i></li>
       <li><strong>% Done</strong> changed from <i>70</i> to <i>100</i></li>
       <li><strong>Estimated time</strong> changed from <i>20.00 h</i> to <i>15.00 h</i></li>
    </ul>
    <div id="journal-4957-notes" class="wiki"><p>This is a very difficult issue for reasons explained in <a class="changeset" title="#1143.  Partial solution.  I have suppressed the warning and allocated memory for Exif.Sony1.Prev..." href="/projects/exiv2/repository/exiv2/revisions/4155">r4155</a>.  Sony have violated the Exif Specification and this breaks the Exiv2 architecture.  I'm going to reduce the Estimated time to 15 hours and close this matter.  I don't believe there is solution for this issue.</p></div>
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1143.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1143.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
