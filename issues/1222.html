<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #1222: Failed to rename file to - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="aFOgECcTJ2Ib9fPKebl1DUnRw21m2XZkMGnnDcAhz8iKHgv/VWnrYk6R7MbGbnk+dkOXFJc6197NSXeFgxgopw==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #1222: Failed to rename file to" href="https://dev.exiv2.org/issues/1222.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #1222</h2>

<div class="issue tracker-1 status-2 priority-4 priority-default details">
    <div class="next-prev-links contextual">
      <a title="#1228" accesskey="p" href="/issues/1228">« Previous</a> |
        <span class="position">
          <a href="/issues?f%5B%5D=status_id&amp;op%5Bstatus_id%5D=o&amp;page=2&amp;per_page=25&amp;set_filter=1&amp;sort=updated_on%3Adesc%2Cid%3Adesc&amp;v%5Bstatus_id%5D%5B%5D=">29 of 78</a>
        </span> |
      <a title="#1227" accesskey="n" href="/issues/1227">Next »</a>
    </div>

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Failed to rename file to</h3></div>
</div>
        <p class="author">
        Added by Anonymous <a title="06 Sep 2016 01:48" href="/projects/exiv2/activity?from=2016-09-06">about 5 years</a> ago.
        Updated <a title="30 Sep 2016 07:04" href="/projects/exiv2/activity?from=2016-09-30">about 5 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Assigned</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">jpeg parser</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="31 Dec 2020" href="/versions/54">0.28</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">06 Sep 2016</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-0"><tr><td style="width: 100%;" class="todo"></td></tr></table><p class="percent">0%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value"></div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>Hello Guys</p>


	<p>I have a little problem creating JPGs files (and then updating metadata inmediatly). I mean, I first create the image file, and then I update the metadata. But, I do it in a loop, proessing 100 or more files. At some point (unfortunately, at random file), the resulting file size is zero. I found this issue in the forum:</p>


	<p><a class="external" href="http://dev.exiv2.org/boards/3/topics/1816">http://dev.exiv2.org/boards/3/topics/1816</a></p>


	<p>While my version already has all patches, the problem continues. I captured the exception, and this is the message:</p>


	<p>ABC.JPG7888: Failed to rename file to ABC.JPG. The created file is ABC.JPG, but I think, the library adds a temporal suffix before rename it back to ABC.jpg. And there should be the problem. It is possible that ABC.jpg was not deleted at all due to antivirus, or something else. I am working with large files (for example 20k*20k image resolution).</p>


	<p>If you have any suggestion, I may try to do something. For example, use copy (with replace option) instead of rename. THen delete temp file. But it seems like I have to read the code in deep to know where to put it, without affecting the other functionalities. It scared me a bit.</p>


	<p>Thanks in advance<br />Ritz</p>
  </div>
</div>






<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/1222" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="UZrcYoChGj9qxmFbRwRC/aaSlJw/uyjo/SZHxr5bacOz13eN8tvWPz+iflf4007OmQDA5c5YiVIABtdO/WKOrA==" />
  <table class="list issues odd-even"><tr id="relation-243" class="issue hascontextmenu issue tracker-1 status-2 priority-4 priority-default"><td class="checkbox"><input type="checkbox" name="ids[]" value="1227" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-2 priority-4 priority-default" href="/issues/1227">Bug #1227</a>:  File extension Issue</td><td class="status">Assigned</td><td class="start_date">18 Sep 2016</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-0"><tr><td style="width: 100%;" class="todo"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-247" class="issue hascontextmenu issue tracker-1 status-2 priority-4 priority-default"><td class="checkbox"><input type="checkbox" name="ids[]" value="1228" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-2 priority-4 priority-default" href="/issues/1228">Bug #1228</a>: Crash in Windows when reading metadata in parallel</td><td class="status">Assigned</td><td class="start_date">22 Sep 2016</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-0"><tr><td style="width: 100%;" class="todo"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/1222/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=1222&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>




<div id="history">
<h3>History</h3>
  <div id="change-5540" class="journal has-notes has-details">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="06 Sep 2016 06:25" href="/projects/exiv2/activity?from=2016-09-06">about 5 years</a> ago
      <span id="journal-5540-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Target version</strong> set to <i>0.28</i></li>
    </ul>
    <div id="journal-5540-notes" class="wiki"><p>Ritz:</p>


	<p>There's not much information here with which to make progress.  When this matter was discussed in 2014 we didn't really solve it then and I haven't heard from George for some time.  There were other changes made around the same time that are relevant:  <a class="issue tracker-4 status-5 priority-4 priority-default closed" title="Patch: Fix &#39;failed to rename file&#39; problem caused by virus scanner in windows (Closed)" href="/issues/984">#984</a></p>


	<p>Obvious questions:<br />1 Platform, build and version?<br />2 Have you tried the recent trunk builds available here:  <a class="external" href="http://exiv2.dyndns.org:8080/userContent/builds/Categorized/">http://exiv2.dyndns.org:8080/userContent/builds/Categorized/</a><br />3 Have you run this with/without your virus checker running?<br />4 Are you using the exiv2.exe application or something you have written?<br />5 Are your files and temporary files on local storage or a network device?<br />6 Are your files and temporary files on the same storage (or network) device?<br />7 Is your application multi-threaded?</p>


	<p>Let me guess that you are using Windows and building with MSVC.  There's important code in src/basicio.cpp function <em><strong><code>FileIo::transfer(BasicIo&#38; src)</code></strong></em> concerned with renaming files.  We're going to have to get that instrumented (peppered with trace/output code) to understand this issue.</p>


	<p>You've seen the previous discussion.  It's very difficult to make progress with an intermittent fault that I cannot reproduce.  I think it's going to take a while to get this properly identified and isolated.</p></div>
    </div>
  </div>
  
  <div id="change-5545" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by Anonymous <a title="06 Sep 2016 20:25" href="/projects/exiv2/activity?from=2016-09-06">about 5 years</a> ago
      <span id="journal-5545-private_notes" class=""></span>
    </h4>

    <div id="journal-5545-notes" class="wiki"><p>Hello Robin</p>


	<p>Thanks for your feedback. Yeah, I think it is hard to reproduce. I cannot do it in my machine (in my machine it does not happen). It is happening in a remote machine. They are using SAN (something related to network filesystem). They also disable the antivirus and the problem persists. I think that it can be solved by using copy instead of replace.</p>


	<p>I am using exiv2-0.25: the generated dll (libexiv2.dll). My app is multi thread, but, one thread is working with the files, the other thread is not doing anything (just waiting for stop button pressed). The platform is windows (dont know the version, cause the machine is not mine...I can ask later), and the code was compiled in visual studio 2015 c++.</p>


	<p>Best wishes!.<br />Ritz</p></div>
    </div>
  </div>
  
  <div id="change-5612" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="21 Sep 2016 23:38" href="/projects/exiv2/activity?from=2016-09-21">about 5 years</a> ago
      <span id="journal-5612-private_notes" class=""></span>
    </h4>

    <div id="journal-5612-notes" class="wiki"><blockquote>

	<p>ABC.JPG7888: Failed to rename file to ABC.JPG</p>


</blockquote>

	<p>Yes.  The 7888 is the process ID.  To minimise the risk of corrupting your file, the library makes a temporary copy using the file name and the process ID.  That copy is updated and if everything's fine, your original file is deleted and the new copy renamed (or something like that).</p>


	<p>Something in your system is occasionally breaking with this approach.  Virus checkers are an obvious possibility.  They monitor the file system for changes and go to inspect new files.  They can lock the file in the process.  If you have a cloud sharing system such as Dropbox monitoring your files, that could be another culprit.  There are very good file system analysis tools for Windows from SysInternals.com (now part of Microsoft).  FileMon.exe monitors one (or more) directories and logs the File I/O being performed by the Operating System and including the requesting process.  It might be quite easy to identify the bandit.</p>


	<p>Another, way to deal with this is to do your image processing in local storage on your computer and push the file to the server when you are done.  You'll have a lot more control of events and tools.</p>


	<p>A 20k*20k file is a whopper.  Maybe your script has to be defensive.  Before you update any file, make a copy.  If exiv2 hammers your file, sleep for 10 seconds, restore the original and try again.  I know that's not a fix - however it enables you to safely process your images AND you can log these events for analysis.</p>


	<p>You're going to need a lot of patience.  Intermittent faults are usually difficult to isolate.</p></div>
    </div>
  </div>
  
  <div id="change-5618" class="journal has-notes">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/134">Niels Kristian Bech Jensen</a> <a title="23 Sep 2016 04:45" href="/projects/exiv2/activity?from=2016-09-23">about 5 years</a> ago
      <span id="journal-5618-private_notes" class=""></span>
    </h4>

    <div id="journal-5618-notes" class="wiki"><p>It seems to me that this issue, issue <a class="issue tracker-1 status-2 priority-4 priority-default" title="Bug:  File extension Issue (Assigned)" href="/issues/1227">#1227</a> and this bug report from UFRaw: <a class="external" href="https://sourceforge.net/p/ufraw/bugs/409/">https://sourceforge.net/p/ufraw/bugs/409/</a> might be related. The common demoninator seems to be spawning processes/multi threading on the Windows platform. Could it be some sort of file lock mechanism playing havoc? I do not know anything about the Windows internals.</p>


	<p>Best regards,<br />Niels Kristian Bech Jensen</p></div>
    </div>
  </div>
  
  <div id="change-5620" class="journal has-notes">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="23 Sep 2016 08:12" href="/projects/exiv2/activity?from=2016-09-23">about 5 years</a> ago
      <span id="journal-5620-private_notes" class=""></span>
    </h4>

    <div id="journal-5620-notes" class="wiki"><p>Niels:</p>


	<p>Thanks for stepping into <a class="issue tracker-1 status-2 priority-4 priority-default" title="Bug: Failed to rename file to (Assigned)" href="/issues/1222">#1222</a> and <a class="issue tracker-1 status-2 priority-4 priority-default" title="Bug:  File extension Issue (Assigned)" href="/issues/1227">#1227</a>  For sure, there's something nasty happening and it's going to take some time to discover what's at the bottom of this.</p>


	<p>When I investigated <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: digiKam maintenance tool to synchronize files metadata and database crash in Exiv2 (re-entrancy i... (Closed)" href="/issues/1207">#1207</a> for Gilles on MacOS-X, he asked me to use "a lot more than 3 threads".  So I did.  I got messages from the OS that I've never seen before about "resource not available".  I've subsequently learned that MacOS-X has limits of about 256 open files per process.  Those limits can be changed by the user, however that is not a useful fix.  It's important that multi-threaded application control/limit the number of threads opening files.  I think we'll learn that Windows requires similar treatment.</p>


	<p>The Windows platform is also challenged by invisible processes such as Virus Checkers, Dropbox and other agents who may be locking the files.  <em><strong>We are not alone</strong></em>.  Something's going on.</p>


	<p>Regrettably, I am flat out at present getting finished with v0.26.  The test program samples/mt-test.cpp may be a useful starting point from which to investigate this issue.</p></div>
    </div>
  </div>
  
  <div id="change-5644" class="journal has-notes">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by Anonymous <a title="29 Sep 2016 22:43" href="/projects/exiv2/activity?from=2016-09-29">about 5 years</a> ago
      <span id="journal-5644-private_notes" class=""></span>
    </h4>

    <div id="journal-5644-notes" class="wiki"><p>Hi Robin and Niels</p>


	<p>Thanks for your help. I am adding some "Sleep" before the rename call. I am going to test it in this way, and tell you later if it works.</p>


	<p>Best Regards!<br />Ritz</p></div>
    </div>
  </div>
  
  <div id="change-5645" class="journal has-notes">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by Anonymous <a title="30 Sep 2016 02:56" href="/projects/exiv2/activity?from=2016-09-30">about 5 years</a> ago
      <span id="journal-5645-private_notes" class=""></span>
    </h4>

    <div id="journal-5645-notes" class="wiki"><p>and yes, it works... :) ... of course, it is not a real pro solution, but works for me</p>


	<p>thx 4 all<br />ritz</p></div>
    </div>
  </div>
  
  <div id="change-5646" class="journal has-notes">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="30 Sep 2016 07:04" href="/projects/exiv2/activity?from=2016-09-30">about 5 years</a> ago
      <span id="journal-5646-private_notes" class=""></span>
    </h4>

    <div id="journal-5646-notes" class="wiki"><p>Ritz</p>


	<p>Thanks for the update.</p>


	<p>As you know the world is not homogenous.  I'm a compiler/interpreter engineer, so I like things to be engineered to work with 100% accuracy and every fault to be 100% reproducible.  However, this issue is more like medicine.  You take a pill and if you feel better you say "ah that fixed it".  We will get to the bottom of this when the issue moves from "randomly reproducible on a user's machine" to "frequently happens on our buildserver".  We have a project in the plan for v0.27 to improve our raw image support and testing.  We have ExifTool's 7000 test files and my own 60,000 digital photos and there's a website in Switzerland with thousands of raw images from many camera manufacturers.  We'll get the buildserver to work with them for 2 or 3 hours every day on Mac/Linux/Windows.  We'll smoke him out.</p>


	<p>Robin</p></div>
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1222.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1222.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
