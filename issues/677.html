<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #677: Nikon Makernote tags regresssion in exiv 0.19 - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="rQVw5cTRvRCzm6BUzdLg0Xm13cDDBuX8EcLNxlIEXstPSNsKtqtxEOb/v1hyBeziRieJuTLlREbs4l1OET25pA==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #677: Nikon Makernote tags regresssion in exiv 0.19" href="https://dev.exiv2.org/issues/677.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #677</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Nikon Makernote tags regresssion in exiv 0.19</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/118">Mark Purcell</a> <a title="27 Jan 2010 13:44" href="/projects/exiv2/activity?from=2010-01-27">almost 12 years</a> ago.
        Updated <a title="29 May 2010 10:43" href="/projects/exiv2/activity?from=2010-05-29">over 11 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value">-</div></div><div class="category attribute"><div class="label">Category:</div><div class="value">metadata</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="30 May 2010" href="/versions/45">0.20</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">27 Jan 2010</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value"></div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p><a class="external" href="https://bugs.kde.org/show_bug.cgi?id=224094">https://bugs.kde.org/show_bug.cgi?id=224094</a></p>
	<pre><code>------- Comment #19 From  Mark Purcell   2010-01-27 22:26:29  (<del>) [reply] ------</del>  <br />Using the test file from #6 &#38; exiv2 0.19 it takes some 20 seconds to reset<br />NoName:</code></pre>


	<p>$ time exiv2 -M'set Exif.Image.Make NoName' digikam-example-d90.jpg</p>


	<p>real    0m20.371s<br />user    0m20.141s<br />sys     0m0.052s</p>


	<p>Downgrading to exiv2 0.18.2 (and refreshing the test file) works much smoother:</p>


	<p>mark@hp:~/Desktop/digikam-test$ exiv2 -V<br />exiv2 0.18.2<br />Copyright (C) 2004-2009 Andreas Huggel.</p>


	<p>This program is free software; you can redistribute it and/or<br />modify it under the terms of the GNU General Public License<br />as published by the Free Software Foundation; either version 2<br />of the License, or (at your option) any later version.</p>


	<p>This program is distributed in the hope that it will be useful,<br />but WITHOUT ANY WARRANTY; without even the implied warranty of<br />MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the<br />GNU General Public License for more details.</p>


	<p>You should have received a copy of the GNU General Public<br />License along with this program; if not, write to the Free<br />Software Foundation, Inc., 51 Franklin Street, Fifth Floor,<br />Boston, MA 02110-1301 USA</p>


	<p>$ time exiv2 -v -M'set Exif.Image.Make NoName' digikam-example-d90.jpg<br />File 1/1: digikam-example-d90.jpg<br />Set Exif.Image.Make "NoName" (Ascii)</p>


	<p>real    0m0.087s<br />user    0m0.020s<br />sys     0m0.032s</p>


	<p>So issue isn't with digikam, rather exiv2..</p>


	<p>I have placed a copy of exiv2 0.18.2 .deb at <a class="external" href="http://people.debian.org/~msp/">http://people.debian.org/~msp/</a>,<br />however this will still require the rebuild of libkexiv2, which is<br />non-trivial..</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/136">digikam-example-d90.jpg</a>    <span class="size">(1.96 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/136/digikam-example-d90.jpg">digikam-example-d90.jpg</a>  </td>
  <td>test file</td>
  <td>
      <span class="author">Mark Purcell, 27 Jan 2010 13:44</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/139">callgrind.out.r2017</a>    <span class="size">(1.35 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/139/callgrind.out.r2017">callgrind.out.r2017</a>  </td>
  <td>Callgrind trace file for r2017</td>
  <td>
      <span class="author">Andreas Huggel, 30 Jan 2010 22:28</span>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/140">callgrind.out.r2018</a>    <span class="size">(1.35 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/140/callgrind.out.r2018">callgrind.out.r2018</a>  </td>
  <td>Callgrind trace file for r2018</td>
  <td>
      <span class="author">Andreas Huggel, 30 Jan 2010 22:28</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>







<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/677" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="akFuuATcVN+BCKCpgkAla/UolfPHbwMs/ROfDDBCeUSIDMVXdqaY39Rsv6U9lylYyrrBijaMopYAMw+Ec3ueKw==" />
  <table class="list issues odd-even"><tr id="relation-55" class="issue hascontextmenu issue tracker-2 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="666" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-2 status-5 priority-4 priority-default closed" href="/issues/666">Feature #666</a>: Optimize binary array elements</td><td class="status">Closed</td><td class="start_date">29 Dec 2009</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr><tr id="relation-56" class="issue hascontextmenu issue tracker-2 status-5 priority-4 priority-default closed"><td class="checkbox"><input type="checkbox" name="ids[]" value="620" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-2 status-5 priority-4 priority-default closed" href="/issues/620">Feature #620</a>: Update Nikon makernotes</td><td class="status">Closed</td><td class="start_date">14 Mar 2009</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/677/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=677&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 2017" href="/projects/exiv2/repository/exiv2/revisions/2017">Revision 2017</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/2017/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="30 Jan 2010 01:50" href="/projects/exiv2/activity?from=2010-01-30">almost 12 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Nikon Makernote tags regresssion in exiv 0.19 (Closed)" href="/issues/677">#677</a>: Changed the container for Exif metadata from a std::vector to a std::list (plus an unrelated optimization).</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 2018" href="/projects/exiv2/repository/exiv2/revisions/2018">Revision 2018</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/2018/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="30 Jan 2010 02:05" href="/projects/exiv2/activity?from=2010-01-30">almost 12 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Nikon Makernote tags regresssion in exiv 0.19 (Closed)" href="/issues/677">#677</a>: Avoid deleting Exif metadata from the container when writing.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 2019" href="/projects/exiv2/repository/exiv2/revisions/2019">Revision 2019</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/2019/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="30 Jan 2010 22:31" href="/projects/exiv2/activity?from=2010-01-30">almost 12 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Nikon Makernote tags regresssion in exiv 0.19 (Closed)" href="/issues/677">#677</a>: Reversed changes from <a class="changeset" title="#677: Avoid deleting Exif metadata from the container when writing." href="/projects/exiv2/repository/exiv2/revisions/2018">r2018</a>.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 2020" href="/projects/exiv2/repository/exiv2/revisions/2020">Revision 2020</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/2020/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="31 Jan 2010 05:03" href="/projects/exiv2/activity?from=2010-01-31">almost 12 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p>Various optimizations (side-effect of the analysis for <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Nikon Makernote tags regresssion in exiv 0.19 (Closed)" href="/issues/677">#677</a>).</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-1528" class="journal has-notes">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="27 Jan 2010 22:32" href="/projects/exiv2/activity?from=2010-01-27">almost 12 years</a> ago
      <span id="journal-1528-private_notes" class=""></span>
    </h4>

    <div id="journal-1528-notes" class="wiki"><p>Because of the way the Nikon Makernote currently works, the Exif metadata of this image has 6785 tags (mostly unknown, see <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Optimize binary array elements (Closed)" href="/issues/666">#666</a>). An average image with a different Makernote probably has only in the order of 100 Exif tags.</p>


	<p>A quick analysis with kcachegrind shows the problematic area is this sequence of calls:</p>


	<p>. TiffEncoder::encodeTiffComponent (called 13530 times)<br />.. ExifData::erase (6769)<br />... std::vector&lt;Exifdatum&gt;::erase (6769)<br />.... Exifdatum::operator= (called 22.9M times!!!)</p>


	<p>This happens during intrusive writing. Erasing elements of a std::vector apparently becomes a major issue with the larger number of elements and a non-trivial assignment operator.</p>


	<p>What can be done?</p>


	<ul>
	<li>Use a different std container with a cheaper erase method</li>
		<li>Avoid deleting the elements from the container</li>
		<li>Reduce the number of Exif tags decoded from Nikon Makernotes (by implementing <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Optimize binary array elements (Closed)" href="/issues/666">#666</a>)</li>
		<li>Improve performance of the assignment operator (e.g., by using a smart pointer with a copy-on-write strategy for the data members of Exifdatum)</li>
	</ul></div>
    </div>
  </div>
  
  <div id="change-1529" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="30 Jan 2010 00:03" href="/projects/exiv2/activity?from=2010-01-30">almost 12 years</a> ago
      <span id="journal-1529-private_notes" class=""></span>
    </h4>

    <div id="journal-1529-notes" class="wiki"><p>Current status, <a class="changeset" title="Compile WError stuff only if Unicode paths are configured." href="/projects/exiv2/repository/exiv2/revisions/2016">r2016</a>:</p>


<pre>
andreas@mowgli:~/src/exiv2/trunk/src$ time ./exiv2 -M'set Exif.Image.Make NoName' digikam-example-d90.jpg

real    0m22.555s
user    0m20.065s
sys     0m0.200s
andreas@mowgli:~/src/exiv2/trunk/src$ cp ../../pic/digikam-example-d90.jpg .
cp: overwrite `./digikam-example-d90.jpg'? y
andreas@mowgli:~/src/exiv2/trunk/src$ valgrind ./exiv2 -M'set Exif.Image.Make NoName' digikam-example-d90.jpg
==25441== Memcheck, a memory error detector
==25441== Copyright (C) 2002-2009, and GNU GPL'd, by Julian Seward et al.
==25441== Using Valgrind-3.5.0-Debian and LibVEX; rerun with -h for copyright info
==25441== Command: ./exiv2 -Mset\ Exif.Image.Make\ NoName digikam-example-d90.jpg
==25441==
==25441==
==25441== HEAP SUMMARY:
==25441==     in use at exit: 0 bytes in 0 blocks
==25441==   total heap usage: 69,529,350 allocs, 69,529,350 frees, 1,219,947,195 bytes allocated
==25441==
==25441== All heap blocks were freed -- no leaks are possible
==25441==
==25441== For counts of detected and suppressed errors, rerun with: -v
==25441== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 21 from 6)
</pre>

	<p>Crazy... and a nice optimization challenge</p></div>
    </div>
  </div>
  
  <div id="change-1530" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="30 Jan 2010 01:50" href="/projects/exiv2/activity?from=2010-01-30">almost 12 years</a> ago
      <span id="journal-1530-private_notes" class=""></span>
    </h4>

    <div id="journal-1530-notes" class="wiki"><p><a class="changeset" title="#677: Changed the container for Exif metadata from a std::vector to a std::list (plus an unrelate..." href="/projects/exiv2/repository/exiv2/revisions/2017">r2017</a>: Changed the std container from a std::vector to a std::list (plus an unrelated optimization). A small (4 lines) and simple change with a drastic result:</p>


<pre>
andreas@mowgli:~/src/exiv2/trunk/src$ cp ../../pic/digikam-example-d90.jpg .
cp: overwrite `./digikam-example-d90.jpg'? y
andreas@mowgli:~/src/exiv2/trunk/src$ time ./exiv2 -M'set Exif.Image.Make NoName' digikam-example-d90.jpg

real    0m0.486s
user    0m0.464s
sys     0m0.016s
andreas@mowgli:~/src/exiv2/trunk/src$ cp ../../pic/digikam-example-d90.jpg .
cp: overwrite `./digikam-example-d90.jpg'? y
andreas@mowgli:~/src/exiv2/trunk/src$ valgrind ./exiv2 -M'set Exif.Image.Make NoName' digikam-example-d90.jpg
==30722== Memcheck, a memory error detector
==30722== Copyright (C) 2002-2009, and GNU GPL'd, by Julian Seward et al.
==30722== Using Valgrind-3.5.0-Debian and LibVEX; rerun with -h for copyright info
==30722== Command: ./exiv2 -Mset\ Exif.Image.Make\ NoName digikam-example-d90.jpg
==30722==
==30722==
==30722== HEAP SUMMARY:
==30722==     in use at exit: 0 bytes in 0 blocks
==30722==   total heap usage: 353,962 allocs, 353,962 frees, 22,674,838 bytes allocated
==30722==
==30722== All heap blocks were freed -- no leaks are possible
==30722==
==30722== For counts of detected and suppressed errors, rerun with: -v
==30722== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 21 from 6)
</pre></div>
    </div>
  </div>
  
  <div id="change-1531" class="journal has-notes">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="30 Jan 2010 21:24" href="/projects/exiv2/activity?from=2010-01-30">almost 12 years</a> ago
      <span id="journal-1531-private_notes" class=""></span>
    </h4>

    <div id="journal-1531-notes" class="wiki"><p><a class="changeset" title="#677: Avoid deleting Exif metadata from the container when writing." href="/projects/exiv2/repository/exiv2/revisions/2018">r2018</a>: Don't delete Exif metadata during writing.</p>


<pre>
andreas@mowgli:~/src/exiv2/trunk/src$ time ./exiv2 -M'set Exif.Image.Make NoName' digikam-example-d90.jpg

real    0m4.604s
user    0m4.480s
sys     0m0.016s
andreas@mowgli:~/src/exiv2/trunk/src$ cp ../../pic/digikam-example-d90.jpg .
cp: overwrite `./digikam-example-d90.jpg'? y
andreas@mowgli:~/src/exiv2/trunk/src$ valgrind ./exiv2 -M'set Exif.Image.Make NoName' digikam-example-d90.jpg
==6819== Memcheck, a memory error detector
==6819== Copyright (C) 2002-2009, and GNU GPL'd, by Julian Seward et al.
==6819== Using Valgrind-3.5.0-Debian and LibVEX; rerun with -h for copyright info
==6819== Command: ./exiv2 -Mset\ Exif.Image.Make\ NoName digikam-example-d90.jpg
==6819==
==6819==
==6819== HEAP SUMMARY:
==6819==     in use at exit: 0 bytes in 0 blocks
==6819==   total heap usage: 353,962 allocs, 353,962 frees, 22,674,837 bytes allocated
==6819==
==6819== All heap blocks were freed -- no leaks are possible
==6819==
==6819== For counts of detected and suppressed errors, rerun with: -v
==6819== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 21 from 6)
</pre>

	<p>Interestingly, now that deleting an element from the container is cheap, not deleting them makes things worse. That's because ExifData::findKey() has to work much harder if all the elements remain in the container, compared to before when every find operation worked on a container with one element less. I'll undo this change.</p></div>
    </div>
  </div>
  
  <div id="change-1532" class="journal has-details">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="30 Jan 2010 22:28" href="/projects/exiv2/activity?from=2010-01-30">almost 12 years</a> ago
      <span id="journal-1532-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/139">callgrind.out.r2017</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/139/callgrind.out.r2017">callgrind.out.r2017</a> added</li>
       <li><strong>File</strong> <a href="/attachments/140">callgrind.out.r2018</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/140/callgrind.out.r2018">callgrind.out.r2018</a> added</li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-1533" class="journal has-notes has-details">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="31 Jan 2010 05:36" href="/projects/exiv2/activity?from=2010-01-31">almost 12 years</a> ago
      <span id="journal-1533-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>New</i> to <i>Resolved</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>100</i></li>
    </ul>
    <div id="journal-1533-notes" class="wiki"><p>Changed the container for Exif metadata to a std::list plus a few minor optimizations. With that, performance is acceptable again, taking into account the large number of tags in the Makernote of this image. That will be reduced considerably with the fix for <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Optimize binary array elements (Closed)" href="/issues/666">#666</a>, after which images with Nikon makernotes will again perform like any other.</p></div>
    </div>
  </div>
  
  <div id="change-1536" class="journal has-notes">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="05 Feb 2010 18:35" href="/projects/exiv2/activity?from=2010-02-05">almost 12 years</a> ago
      <span id="journal-1536-private_notes" class=""></span>
    </h4>

    <div id="journal-1536-notes" class="wiki"><p>With the fix for <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Optimize binary array elements (Closed)" href="/issues/666">#666</a> the number of tags decoded from the sample image is reduced to only 206 (by concatenating unknown tags):</p>


<pre>
andreas@mowgli:~/src/exiv2/trunk/src$ time ./exiv2 -M'set Exif.Image.Make NoName' digikam-example-d90.jpg

real    0m0.031s
user    0m0.020s
sys     0m0.008s
andreas@mowgli:~/src/exiv2/trunk/src$ \cp -f ../../pic/digikam-example-d90.jpg .
andreas@mowgli:~/src/exiv2/trunk/src$ valgrind ./exiv2 -M'set Exif.Image.Make NoName' digikam-example-d90.jpg
==5057== Memcheck, a memory error detector
==5057== Copyright (C) 2002-2009, and GNU GPL'd, by Julian Seward et al.
==5057== Using Valgrind-3.5.0-Debian and LibVEX; rerun with -h for copyright info
==5057== Command: ./exiv2 -Mset\ Exif.Image.Make\ NoName digikam-example-d90.jpg
==5057==
==5057==
==5057== HEAP SUMMARY:
==5057==     in use at exit: 0 bytes in 0 blocks
==5057==   total heap usage: 11,821 allocs, 11,821 frees, 2,138,217 bytes allocated
==5057==
==5057== All heap blocks were freed -- no leaks are possible
==5057==
==5057== For counts of detected and suppressed errors, rerun with: -v
==5057== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 21 from 6)
</pre></div>
    </div>
  </div>
  
  <div id="change-1537" class="journal has-notes">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="05 Feb 2010 18:46" href="/projects/exiv2/activity?from=2010-02-05">almost 12 years</a> ago
      <span id="journal-1537-private_notes" class=""></span>
    </h4>

    <div id="journal-1537-notes" class="wiki"><p>And finally, for comparison, the same tests with 0.18.2, which decodes 131 tags from the sample image (on the same machine, also compiled with debug symbols):</p>


<pre>
andreas@mowgli:~/src/exiv2/exiv2-0.18.2/src$ time ./exiv2 -M'set Exif.Image.Make NoName' digikam-example-d90.jpg

real    0m0.035s
user    0m0.012s
sys     0m0.016s
andreas@mowgli:~/src/exiv2/exiv2-0.18.2/src$ \cp -f ../../pic/digikam-example-d90.jpg .
andreas@mowgli:~/src/exiv2/exiv2-0.18.2/src$ valgrind ./exiv2 -M'set Exif.Image.Make NoName' digikam-example-d90.jpg
==13070== Memcheck, a memory error detector
==13070== Copyright (C) 2002-2009, and GNU GPL'd, by Julian Seward et al.
==13070== Using Valgrind-3.5.0-Debian and LibVEX; rerun with -h for copyright info
==13070== Command: ./exiv2 -Mset\ Exif.Image.Make\ NoName digikam-example-d90.jpg
==13070==
==13070==
==13070== HEAP SUMMARY:
==13070==     in use at exit: 0 bytes in 0 blocks
==13070==   total heap usage: 29,825 allocs, 29,825 frees, 5,454,252 bytes allocated
==13070==
==13070== All heap blocks were freed -- no leaks are possible
==13070==
==13070== For counts of detected and suppressed errors, rerun with: -v
==13070== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 21 from 6)
</pre></div>
    </div>
  </div>
  
  <div id="change-1669" class="journal has-details">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="29 May 2010 10:43" href="/projects/exiv2/activity?from=2010-05-29">over 11 years</a> ago
      <span id="journal-1669-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Resolved</i> to <i>Closed</i></li>
    </ul>
    
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/677.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/677.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
