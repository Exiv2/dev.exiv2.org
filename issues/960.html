<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #960: Problem With Exiv2 ( Video files) - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="pm/k/LmB7uLlqtzfqpkEC3rNJoFSlrHQyKVvwmWOJYNEIk8Ty/si4rDOw9MVTgg4RV9y+KN1EGo1hf9KJrfC7A==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #960: Problem With Exiv2 ( Video files)" href="https://dev.exiv2.org/issues/960.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #960</h2>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Problem With Exiv2 ( Video files)</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/4163">Henrique Fernandes</a> <a title="05 Jun 2014 20:04" href="/projects/exiv2/activity?from=2014-06-05">over 7 years</a> ago.
        Updated <a title="21 Jun 2015 16:41" href="/projects/exiv2/activity?from=2015-06-21">over 6 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/3290">Abhinav Badola</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">video</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="17 May 2015" href="/versions/51">0.25</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">05 Jun 2014</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value"></div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>Sorry i might don't be much help but here <br /><a class="external" href="https://bugs.kde.org/show_bug.cgi?id=335816">https://bugs.kde.org/show_bug.cgi?id=335816</a></p>


	<p>When i try to open digikam it crashes, when i filled the bug they told me the problem might be with exiv2</p>


	<p>So here i am!</p>


	<p>I am willing to help!</p>


	<p>I can separate all my video files to see with one causes the bug if it realy is!</p>


	<p>Thanks</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/616">18.png</a>    <span class="size">(105 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/616/18.png">18.png</a>  </td>
  <td></td>
  <td>
      <span class="author">Henrique Fernandes, 08 Jun 2014 08:28</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>







<hr />
<div id="relations">
<div class="contextual">
</div>

<p><strong>Related issues</strong></p>

<form data-cm-url="/issues/context_menu" action="/issues/960" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="bOn3Jb88WWqtLbEIjTSuXPzOOZJDPhwdRO1TXULmoR2OpFzKzUaVavhJrgQy46Jvw1xt67Ldvae5zcPVAd9Gcg==" />
  <table class="list issues odd-even"><tr id="relation-160" class="issue hascontextmenu issue tracker-1 status-1 priority-4 priority-default"><td class="checkbox"><input type="checkbox" name="ids[]" value="1091" /></td><td class="subject" style="width: 50%">Related to Exiv2 - <a class="issue tracker-1 status-1 priority-4 priority-default" href="/issues/1091">Bug #1091</a>: exiv2 segfaults on Matroska video in Exiv2::MatroskaVideo::decodeBlock()</td><td class="status">New</td><td class="start_date">07 Jun 2015</td><td class="due_date"></td><td class="done_ratio"><table class="progress progress-0"><tr><td style="width: 100%;" class="todo"></td></tr></table><p class="percent"></p></td><td class="buttons"><a title="Actions" class="icon-only icon-actions js-contextmenu" href="#">Actions</a></td></tr></table>
</form>
<form class="new_relation" id="new-relation-form" style="display: none;" action="/issues/960/relations" accept-charset="UTF-8" data-remote="true" method="post"><input name="utf8" type="hidden" value="&#x2713;" />


<p><select onchange="setPredecessorFieldsVisibility();" name="relation[relation_type]" id="relation_relation_type"><option selected="selected" value="relates">Related to</option>
<option value="duplicates">Is duplicate of</option>
<option value="duplicated">Has duplicate</option>
<option value="blocks">Blocks</option>
<option value="blocked">Blocked by</option>
<option value="precedes">Precedes</option>
<option value="follows">Follows</option>
<option value="copied_to">Copied to</option>
<option value="copied_from">Copied from</option></select>
Issue #<input size="10" type="text" name="relation[issue_to_id]" id="relation_issue_to_id" />
<span id="predecessor_fields" style="display:none;">
Delay: <input size="3" type="text" name="relation[delay]" id="relation_delay" /> days
</span>
<input type="submit" name="commit" value="Add" data-disable-with="Add" />
<a href="#" onclick="$(&quot;#new-relation-form&quot;).hide();; return false;">Cancel</a>
</p>

<script>
//<![CDATA[
observeAutocompleteField('relation_issue_to_id', '/issues/auto_complete?issue_id=960&project_id=exiv2&scope=all')
//]]>
</script>

<script>
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>
</div>

</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 3264" href="/projects/exiv2/repository/exiv2/revisions/3264">Revision 3264</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/3264/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/3290">Abhinav Badola</a> <a title="19 Jun 2014 13:28" href="/projects/exiv2/activity?from=2014-06-19">over 7 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Problem With Exiv2 ( Video files) (Closed)" href="/issues/960">#960</a>: Added a Buffer Overflow Fix in INFO tags of RIFFVIDEO.CPP</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 3265" href="/projects/exiv2/repository/exiv2/revisions/3265">Revision 3265</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/3265/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/3290">Abhinav Badola</a> <a title="19 Jun 2014 13:43" href="/projects/exiv2/activity?from=2014-06-19">over 7 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Problem With Exiv2 ( Video files) (Closed)" href="/issues/960">#960</a>: Fixed a small bug found by coverity scan results</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 3912" href="/projects/exiv2/repository/exiv2/revisions/3912">Revision 3912</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/3912/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="28 Aug 2015 19:57" href="/projects/exiv2/activity?from=2015-08-28">about 6 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Problem With Exiv2 ( Video files) (Closed)" href="/issues/960">#960</a> added API: static void Exiv2::XMPParser::getRegisteredNamespaces(std::map&lt;std::string,std::string&gt;&#38;);</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-2755" class="journal has-notes has-details">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4163">Henrique Fernandes</a> <a title="08 Jun 2014 08:28" href="/projects/exiv2/activity?from=2014-06-08">over 7 years</a> ago
      <span id="journal-2755-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/616">18.png</a> <a class="icon-only icon-download" title="Download" href="/attachments/download/616/18.png">18.png</a> added</li>
    </ul>
    <div id="journal-2755-notes" class="wiki"><p>I found the file, i can't upload it here. (27MB)</p>


	<p>I am uploading it to drive.<br />Here the link to the file:</p>


	<p><a class="external" href="https://drive.google.com/file/d/0B5CHbb3RVwicYXNjbW54VERmTG8/edit?usp=sharing">https://drive.google.com/file/d/0B5CHbb3RVwicYXNjbW54VERmTG8/edit?usp=sharing</a></p>


	<p>Here s what exiv2 outputs when i try to run:<br /><pre>
$ exiv2 bugado/12/31/100_0182.AVI 
*** Error in `exiv2': malloc(): memory corruption (fast): 0x0000000001a260e0 ***

</pre></p>


	<p>And the terminal gets stuck. I have to Ctrl + C to get out.</p>


	<p>exiv2 info:</p>


<pre>
[sfrique@arch-desktop Videos]$ exiv2 -Vv
exiv2 0.24 001800 (64 bit build)
Copyright (C) 2004-2013 Andreas Huggel.

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public
License along with this program; if not, write to the Free
Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
Boston, MA 02110-1301 USA
exiv2=0.24.0
platform=linux
compiler=G++
bits=64
dll=1
debug=0
version=4.8.2 20131219 (prerelease)
date=Jan 24 2014
time=11:25:52
executable=/usr/bin/exiv2
library=/usr/lib/libexiv2.so.13
library=/usr/lib/libstdc++.so.6
library=/usr/lib/libgcc_s.so.1
library=/usr/lib/libc.so.6
library=/usr/lib/libdl.so.2
library=/usr/lib/libz.so.1
library=/usr/lib/libexpat.so.1
library=/usr/lib/libm.so.6
library=/lib64/ld-linux-x86-64.so.2

</pre>

	<p>Computer info:<br /><pre>
[sfrique@arch-desktop ~]$ uname -a
Linux arch-desktop 3.14.5-1-ARCH #1 SMP PREEMPT Sun Jun 1 07:36:23 CEST 2014 x86_64 GNU/Linux
[sfrique@arch-desktop ~]$ cat /etc/os-release 
NAME="Arch Linux" 
ID=arch
PRETTY_NAME="Arch Linux" 
ANSI_COLOR="0;36" 
HOME_URL="https://www.archlinux.org/" 
SUPPORT_URL="https://bbs.archlinux.org/" 
BUG_REPORT_URL="https://bugs.archlinux.org/" 
</pre></p>


	<p>Here teh info i got from smplayer:</p>


<pre>
100_0182.AVI
Geral
Arquivo
/RAID/sfrique/Videos/bugado/12/31/100_0182.AVI
Tamanho
26848 KB (26 MB)
Duração
00:01:41
Demuxer
avi

Informação do clip
Software
EASTMAN KODAK COMPANY KODAK EASYSHARE Sport Camera, C123

Vídeo
Resolução
640 x 480
Tamanho do Vídeo
1.33333
Formato
MJPG
Taxa de bits
2021 kbps
Quadros por segundo
30.039
Codificador selecionado
ffmjpeg

Transmissão Inicial de Áudio
Formato
7
Taxa de bits
128 kbps
Taxa
8000 Hz
Canais
2
Codificador selecionado
ulaw

Transmissões Áudio
#
Idioma
Nome
ID
0
&lt;vazio&gt;
&lt;vazio&gt;
1

</pre></div>
    </div>
  </div>
  
  <div id="change-2756" class="journal has-notes has-details">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="08 Jun 2014 11:59" href="/projects/exiv2/activity?from=2014-06-08">over 7 years</a> ago
      <span id="journal-2756-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Assignee</strong> set to <i>Robin Mills</i></li>
       <li><strong>Target version</strong> set to <i>0.25</i></li>
    </ul>
    <div id="journal-2756-notes" class="wiki"><p>Henrique</p>


	<p>Thanks for providing the test file and the analysis.   I've reproduced this on Mac/Windows/Linux.  Here's the Mac Terminal output<br /><pre>
577 rmills@rmills-mbp:~/gnu/exiv2/bugs $ exiv2 100_0182.AVI 
*** exiv2(11723,0x7fff77ba9310) malloc: ***
error for object 0x7fdd63e01858: incorrect checksum for freed object
- object was probably modified after being freed.
set a breakpoint in malloc_error_break to debug
Abort trap: 6
578 rmills@rmills-mbp:~/gnu/exiv2/bugs $</pre>Curiously, when I rerun it on the Mac, it's OK.<br /><pre>
580 rmills@rmills-mbp:~/gnu/exiv2/bugs $ exiv2 100_0182.AVI 
File name       : 100_0182.AVI
File size       : 27492808 Bytes
MIME type       : video/riff
Image size      : 0 x 0
100_0182.AVI: No Exif data found in the file
581 rmills@rmills-mbp:~/gnu/exiv2/bugs $ </pre></p></div>
    </div>
  </div>
  
  <div id="change-2757" class="journal has-details">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="08 Jun 2014 12:00" href="/projects/exiv2/activity?from=2014-06-08">over 7 years</a> ago
      <span id="journal-2757-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Category</strong> set to <i>video</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-2779" class="journal has-notes has-details">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="17 Jun 2014 16:42" href="/projects/exiv2/activity?from=2014-06-17">over 7 years</a> ago
      <span id="journal-2779-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Assignee</strong> changed from <i>Robin Mills</i> to <i>Abhinav Badola</i></li>
    </ul>
    <div id="journal-2779-notes" class="wiki"><p>Abhinav</p>


	<p>I think this is being caused by localization of Xmp keys.  riffvideo.cpp calls exvGettext() about line# 880.</p>


	<p>I've changed this to:<br /><pre>
    xmpData_[exvGettext(tv-&gt;label_)] = buf.pData_;
</pre>to<pre>
    xmpData_[tv-&gt;label_] = buf.pData_;
</pre></p>


	<p>I'm not certain, however I suspect that exvGettext() is not thread safe and returning a char* to a static buffer.  Sometimes the buffer is OK, and sometimes he has been freed when XmpData[key] = value is processed.  Of even worse, exvGettext() doesn't handle unknown keys gracefully and returns random pointers for unknown input strings.</p>


	<p>I'm not sure why the key is being passed through exvGettext() at all.  If it's essential to use exvGettext, it might be a good idea to have an additional API:<br /><pre>
  std::string&#38; exvGettext(const char*, std::string&#38;);
</pre><br />This additional exvGettext() would update the string passed to him and return a reference to the passed string.  A lot safer than a static buffer.  You'd call it like this:<br /><pre>
    String key;
    xmpData[exvGettext(tv-&gt;label_,key)]=buf.pData;
</pre><br />There about 60 calls to exvGettext() in the video code.  Before I change them all, I'd appreciate your review and opinion.  Please reassign the issue back to me with your comments.</p>


	<p>Robin</p></div>
    </div>
  </div>
  
  <div id="change-2780" class="journal has-notes">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="17 Jun 2014 17:01" href="/projects/exiv2/activity?from=2014-06-17">over 7 years</a> ago
      <span id="journal-2780-private_notes" class=""></span>
    </h4>

    <div id="journal-2780-notes" class="wiki"><p>I'm even more confident that it's exvGettext() that is causing this.  When I configure and build with --disable-nls, the problem goes away.  When NLS is disabled, exvGettext() is compiled as:<br /><pre>
const char* exvGettext(const char* key)
{
    return key;
}
</pre><br />No more mysterious calls into dgettext.  Being a native English speaker, I don't have a strong feel for localization.  However I don't see a need to localize XMP keys.</p></div>
    </div>
  </div>
  
  <div id="change-2781" class="journal has-notes">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/3290">Abhinav Badola</a> <a title="19 Jun 2014 13:22" href="/projects/exiv2/activity?from=2014-06-19">over 7 years</a> ago
      <span id="journal-2781-private_notes" class=""></span>
    </h4>

    <div id="journal-2781-notes" class="wiki"><p>Hi Robin, Henrique,</p>


	<p>Robin Mills wrote:</p>


<blockquote>

	<p>I'm even more confident that it's exvGettext() that is causing this.  When I configure and build with --disable-nls, the problem goes away.  When NLS is disabled, exvGettext() is compiled as:<br />[...]<br />No more mysterious calls into dgettext.  Being a native English speaker, I don't have a strong feel for localization.  However I don't see a need to localize XMP keys.</p>


</blockquote>

	<p>I took the sample file and was able to reproduce the bug on my Linux Machine as well.<br />I tried to do away with all the exvGettext(), but it didn't solve the problem for me.</p>


	<p>So I took the problem a little deeper and saw what was being fetched in the XMP container.</p>


	<p>The program was getting stuck because the data to be read was too large for the buffer allocated. The default size of the buffer was 100, and the data that was to be read was 8192 in size.</p>


<pre>
infoSize :8310   8310
infoTagsHandler :DTIM
infoSize :20
before :20
after :20Data : 2012:01:01 00:07:14Size : 8278
true for label Xmp.video.DateTimeOriginal
Info Tag Xmp.video.DateTimeOriginal       infoData :2012:01:01 00:07:14
infoTagsHandler :IKEY
infoSize :8192
before :8192
after :8192Data : Size : 78
true for label Xmp.video.PerformerKeywords
Info Tag Xmp.video.PerformerKeywords       infoData :
infoTagsHandler :ISFT
infoSize :60
before :60
after :60Data : EASTMAN KODAK COMPANY KODAK EASYSHARE Sport Camera, C123Size : 10
true for label Xmp.video.Software
Info Tag Xmp.video.Software       infoData :EASTMAN KODAK COMPANY KODAK EASYSHARE Sport Camera, C123
infoTagsHandler :SRAT
infoSize :2
before :2
after :2Data : Size : 0Exit and runReached the DECODE BLOCK
JUNK
Reached the DECODE BLOCK
LIST
Reached the DECODE BLOCK
movi

</pre>

	<p>When I looked into the data of the file closely, it was a bit clear where the potential problem was lying.<br />On looking at the data of the TAG - IKEY, it seemed strange that the data was out of range.</p>


<pre>
infoTagsHandler :IKEY
infoSize :8192
before :8192
after :8192Data : Size : 78
true for label Xmp.video.PerformerKeywords
Info Tag Xmp.video.PerformerKeywords       infoData :
</pre>

	<p>Generally it is supposed to have a few words as information, but the size of the TAG in this file was exceptionally large, and at the same time, empty.</p>


	<p>For now I would be inserting this buffer overflow fix.</p>


	<p>@Robin,<br />You are absolutely right about fixing the issue with exvGettext(), as it may not be always safe to call it.</p>


	<p>Please do tell me what is your opinion on this issue as of now. Does it seem fixed..?</p>


	<p>I think it would be best if I change the code in the places where exvGettext() has been used, for the following reasons -<br />[a] It is mostly used in Video code which has been written by me.<br />[b] I have a lot of video files at my home PC which I can use to test and verify that all changes have been done without breaking the previous working of the code.</p></div>
    </div>
  </div>
  
  <div id="change-2782" class="journal has-notes">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4163">Henrique Fernandes</a> <a title="20 Jun 2014 06:32" href="/projects/exiv2/activity?from=2014-06-20">over 7 years</a> ago
      <span id="journal-2782-private_notes" class=""></span>
    </h4>

    <div id="journal-2782-notes" class="wiki"><p>Hello,</p>


	<p>If needed i can try to use the code in multiple videos files as well. That is the most i can do, not much help with the code!</p>


	<p>I did run exiv2 in all my videos  files before to find this problem.</p></div>
    </div>
  </div>
  
  <div id="change-2783" class="journal has-notes">
    <div id="note-8">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="20 Jun 2014 11:03" href="/projects/exiv2/activity?from=2014-06-20">over 7 years</a> ago
      <span id="journal-2783-private_notes" class=""></span>
    </h4>

    <div id="journal-2783-notes" class="wiki"><p>Henrique and Abinhav</p>


	<p>Thank You both for your work on this.  We're close to resolving this.</p>


	<p>@Henrique<br />There were bugs reported with DigiKam <-> Exiv2 crashing (<a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash in digikam while reading metadata from a .MTS movie file (Closed)" href="/issues/961">#961</a> and <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Digikam is crashing for the image formats that it is not able to detect. (Closed)" href="/issues/963">#963</a>).  These were in the exception handler in libkexiv2 (the sandwich between DigiKam and Exiv2).  That part of the code has been made more robust.  So, it's been fixed and DigiKam won't crash here any more.  The fix isn't part of Exiv2.  I've no idea how/when it willl appear in DigiKam.</p>


	<p>However, it's only the crash that has been fixed.  You will still not be able to open this file.  I think we'll resolve that puzzle in the next few days.</p>


	<p>@Abhinav<br />Thanks very much for offering to undertake the fix.  I think you've discovered the real issue here.  There is a buffer overflow.  For sure you know more about this code.  It sounds as though the overflow is being caused by the file containing erroneous data and 8000 bytes are traveling a road designed for less that 100 bytes.  I encourage to find a fix which prevents the overflow by chopping the data (say after 90 bytes), or throw an Exiv2 exception.</p>


	<p>I think my concerns about exvGettext() are probably a lucky, but bad, guess and do not deserve further investigation/attention at the moment.</p>


	<p>@Henrique and Abhinav<br />I think it's very helpful that you have loads of test files.  When we get this fixed, please run every test you can.  You cannot perform "too much testing!".</p>


	<p>Robin</p></div>
    </div>
  </div>
  
  <div id="change-2999" class="journal has-notes">
    <div id="note-9">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/3290">Abhinav Badola</a> <a title="30 Nov 2014 20:59" href="/projects/exiv2/activity?from=2014-11-30">almost 7 years</a> ago
      <span id="journal-2999-private_notes" class=""></span>
    </h4>

    <div id="journal-2999-notes" class="wiki"><p>Hi Henrique,<br />Shall we close this bug now..??</p>


	<p>Can you please confirm if this got fixed at your end as well..?</p></div>
    </div>
  </div>
  
  <div id="change-3000" class="journal has-notes">
    <div id="note-10">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-10" class="journal-link">#10</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4163">Henrique Fernandes</a> <a title="30 Nov 2014 21:41" href="/projects/exiv2/activity?from=2014-11-30">almost 7 years</a> ago
      <span id="journal-3000-private_notes" class=""></span>
    </h4>

    <div id="journal-3000-notes" class="wiki"><p>Hi Abhinav Badola,</p>


	<p>Sorry but the error persists for me</p>


<pre>
*** Error in `digikam': malloc(): memory corruption (fast): 0x00007ffcb802f370 ***
&lt;pre&gt;

And i keep geting weird errors.

Problem is i am not using the latest digikam!

I still with 4.2.

Rigth now i can't do more debuging or testing... i don't even have time to fix my just broken digikam again.

Sorry =/</pre></div>
    </div>
  </div>
  
  <div id="change-3011" class="journal has-notes">
    <div id="note-11">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-11" class="journal-link">#11</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/3290">Abhinav Badola</a> <a title="04 Dec 2014 04:38" href="/projects/exiv2/activity?from=2014-12-04">almost 7 years</a> ago
      <span id="journal-3011-private_notes" class=""></span>
    </h4>

    <div id="journal-3011-notes" class="wiki"><p>Hi Henrique,</p>


	<p>Are you building digiKam from source..?<br />Or are you using some distribution of digiKam..?</p></div>
    </div>
  </div>
  
  <div id="change-3013" class="journal has-notes">
    <div id="note-12">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-12" class="journal-link">#12</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4163">Henrique Fernandes</a> <a title="04 Dec 2014 13:28" href="/projects/exiv2/activity?from=2014-12-04">almost 7 years</a> ago
      <span id="journal-3013-private_notes" class=""></span>
    </h4>

    <div id="journal-3013-notes" class="wiki"><p>Hello,</p>


	<p>I am using it from distro.<br />Manjaro or Arch</p>


	<p>I think manjaro update it to lastest. So i might be able ot test it later today!<br />But at the end of the week i will test with digikam 4.5</p></div>
    </div>
  </div>
  
  <div id="change-3014" class="journal has-notes">
    <div id="note-13">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-13" class="journal-link">#13</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/3290">Abhinav Badola</a> <a title="05 Dec 2014 04:19" href="/projects/exiv2/activity?from=2014-12-05">almost 7 years</a> ago
      <span id="journal-3014-private_notes" class=""></span>
    </h4>

    <div id="journal-3014-notes" class="wiki"><p>Hi Henrique,</p>


	<p>I would like to inform you that this bug won't get fixed even after you update digiKam to the latest.</p>


	<p>The fix is currently in our trunk (i.e. main development svn repository).<br />If you install digiKam with default packages, it will use the older version of Exiv2, i.e. 0.24</p>


	<p>The fix to your specific bug will be shipped in the next version of our library.(0.25)</p>


	<p>To fix digiKam for the time being, you will have to manually install the latest version of Exiv2 from the svn repository.</p>


	<p>It is pretty easy to install Exiv2 as it only depends on very few C++ libraries, and most of them are part of Standard C++ Libraries for development. The below links can help you get started with installing the latest version of Exiv2.<br />[1] <a class="external" href="http://www.exiv2.org/download.html">http://www.exiv2.org/download.html</a><br />[2] <a class="external" href="http://dev.exiv2.org/projects/exiv2/wiki/How_do_I_build_Exiv2_on_the_XYZ_platform">http://dev.exiv2.org/projects/exiv2/wiki/How_do_I_build_Exiv2_on_the_XYZ_platform</a></p>


	<p>Henrique Fernandes wrote:</p>


<blockquote>

	<p>Hello,</p>


	<p>I am using it from distro.<br />Manjaro or Arch</p>


	<p>I think manjaro update it to lastest. So i might be able ot test it later today!<br />But at the end of the week i will test with digikam 4.5</p>


</blockquote></div>
    </div>
  </div>
  
  <div id="change-3015" class="journal has-notes">
    <div id="note-14">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-14" class="journal-link">#14</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4163">Henrique Fernandes</a> <a title="05 Dec 2014 15:41" href="/projects/exiv2/activity?from=2014-12-05">almost 7 years</a> ago
      <span id="journal-3015-private_notes" class=""></span>
    </h4>

    <div id="journal-3015-notes" class="wiki"><p>Hi Abhinav,</p>


	<p>Thanks for the info, but one reason that i am usign arch now if to get up to date packages from repository.<br />When in ubuntu i always had to updatd packages by hand and for security fix and etc this way doesn't work well.</p>


	<p>But still, i am glad to see it was fixed. I will simple remove this video file from my library, later on i can put it in again!</p>


	<p>So if you know 0.25 fixed the issue you can close the ticket. The only video i have that gives me any errors is the one i uploaded here!</p>


	<p>Thanks!</p></div>
    </div>
  </div>
  
  <div id="change-3786" class="journal has-details">
    <div id="note-15">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-15" class="journal-link">#15</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4035">Alan Pater</a> <a title="02 Jun 2015 23:31" href="/projects/exiv2/activity?from=2015-06-02">over 6 years</a> ago
      <span id="journal-3786-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Resolved</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>100</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-3864" class="journal has-details">
    <div id="note-16">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-16" class="journal-link">#16</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="21 Jun 2015 16:41" href="/projects/exiv2/activity?from=2015-06-21">over 6 years</a> ago
      <span id="journal-3864-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Resolved</i> to <i>Closed</i></li>
    </ul>
    
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/960.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/960.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
