<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Patch #1292: Fix targeting Windows XP (regression) - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="cjYcMPv30C6fuqmRqYVrxojvS3OYEdlYX5Ycetr4QTyQe7ffiY0cLsretp0WUmf1t30fCmnyeOKitozymcGmUw==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Patch #1292: Fix targeting Windows XP (regression)" href="https://dev.exiv2.org/issues/1292.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Patch #1292</h2>

<div class="issue tracker-4 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Fix targeting Windows XP (regression)</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/80">Dimitri Schoolwerth</a> <a title="26 Apr 2017 12:56" href="/projects/exiv2/activity?from=2017-04-26">over 4 years</a> ago.
        Updated <a title="03 Feb 2018 13:03" href="/projects/exiv2/activity?from=2018-02-03">almost 4 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Closed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">build</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="28 Apr 2017" href="/versions/52">0.26</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">26 Apr 2017</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-100"><tr><td style="width: 100%;" class="closed" title="100%"></td></tr></table><p class="percent">100%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">2.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>SRW lock functions are used since <a class="changeset" title="#1187 Thank You to Taras for the patch." href="/projects/exiv2/repository/exiv2/revisions/4308">r4308</a>, these are only available since Windows Vista and some since Windows 7. The attached patch fixes XP support when using VS2013+, yet still targeting XP.</p>


	<p>Note that this doesn't solve compatibility with Vista when XP is not targeted (which is the default). Ideally availability of the SRW lock functions would be checked at run-time but given the desired performance nature of this piece of code that may not be wanted (I didn't profile).</p>


	<p>Quite frankly I would probably just always use the critical section part of the code, unless it's been shown that using those functions are reason for real world performance concerns.</p>


	<p>Random commit message suggestion (no need for possible thanks (only), I would rather just have more sensible commit messages if that's OK) :</p>


	<p>" <br />Fix targeting XP systems</p>


	<p>SRW lock functions are being used which are only available since Windows 7. Fix by not making use of them when targeting XP.</p>


	<p>Regression since <a class="changeset" title="#1187 Thank You to Taras for the patch." href="/projects/exiv2/repository/exiv2/revisions/4308">r4308</a>.<br />"</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1157">xp-target.patch</a>    <span class="size">(1.06 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1157/xp-target.patch">xp-target.patch</a>  </td>
  <td></td>
  <td>
      <span class="author">Dimitri Schoolwerth, 26 Apr 2017 12:56</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>








</div>

<div id="issue-changesets">
<h3>Associated revisions</h3>
    <div class="changeset">
    <p><a title="Revision 4768" href="/projects/exiv2/repository/exiv2/revisions/4768">Revision 4768</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4768/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="26 Apr 2017 14:09" href="/projects/exiv2/activity?from=2017-04-26">over 4 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-4 status-5 priority-4 priority-default closed" title="Patch: Fix targeting Windows XP (regression) (Closed)" href="/issues/1292">#1292</a>  Dimitri: Thank You for reporting this and providing the patch.</p>
    </div>
    </div>
    <div class="changeset">
    <p><a title="Revision 4769" href="/projects/exiv2/repository/exiv2/revisions/4769">Revision 4769</a>
        (<a href="/projects/exiv2/repository/exiv2/revisions/4769/diff">diff</a>)
        <br />
        <span class="author">Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="26 Apr 2017 16:26" href="/projects/exiv2/activity?from=2017-04-26">over 4 years</a> ago</span></p>
    <div class="wiki changeset-comments">
        <p><a class="issue tracker-4 status-5 priority-4 priority-default closed" title="Patch: Fix targeting Windows XP (regression) (Closed)" href="/issues/1292">#1292</a> Fix submitted.</p>
    </div>
    </div>

</div>



<div id="history">
<h3>History</h3>
  <div id="change-5988" class="journal has-notes">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="26 Apr 2017 13:49" href="/projects/exiv2/activity?from=2017-04-26">over 4 years</a> ago
      <span id="journal-5988-private_notes" class=""></span>
    </h4>

    <div id="journal-5988-notes" class="wiki"><p>Dimitri</p>


	<p>I thought I had to do something like this to build with Visual Studio 2003 (which will be deprecated after v0.26 ships).  Do you think there is a risk to the build here?  Perhaps it's better to leave this as a patch for the occasional user of XP.  What do you think?</p>


	<p>Robin</p></div>
    </div>
  </div>
  
  <div id="change-5989" class="journal has-notes has-details">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="26 Apr 2017 14:11" href="/projects/exiv2/activity?from=2017-04-26">over 4 years</a> ago
      <span id="journal-5989-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>New</i> to <i>Assigned</i></li>
       <li><strong>Target version</strong> set to <i>0.26</i></li>
       <li><strong>% Done</strong> changed from <i>0</i> to <i>100</i></li>
       <li><strong>Estimated time</strong> set to <i>1.00 h</i></li>
    </ul>
    <div id="journal-5989-notes" class="wiki"><p>Thank You, Dimitri for reporting this and providing the patch.  I've reviewed this and submitted this:  <a class="changeset" title="#1292  Dimitri: Thank You for reporting this and providing the patch." href="/projects/exiv2/repository/exiv2/revisions/4768">r4768</a></p>


	<p>I'm going to accept it and do a full build (2005/8/10/12/13/15).  If anything breaks, I will revert the patch.</p></div>
    </div>
  </div>
  
  <div id="change-5990" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="26 Apr 2017 14:15" href="/projects/exiv2/activity?from=2017-04-26">over 4 years</a> ago
      <span id="journal-5990-private_notes" class=""></span>
    </h4>

    <div id="journal-5990-notes" class="wiki"><p>By the way, the reason the code uses SRWLOCK is because it was a contribution from a user.  Then I discover it doesn't work on older version of Windows - and other consequences.  I have a strong dislike of locks.  Multi-threading is a very tricky beast and very difficult to test.  And of course a host application could deadlock.  Anyway, it's in the code for v0.26.</p></div>
    </div>
  </div>
  
  <div id="change-5991" class="journal has-notes has-details">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="26 Apr 2017 19:22" href="/projects/exiv2/activity?from=2017-04-26">over 4 years</a> ago
      <span id="journal-5991-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Assigned</i> to <i>Closed</i></li>
       <li><strong>Estimated time</strong> changed from <i>1.00 h</i> to <i>2.00 h</i></li>
    </ul>
    <div id="journal-5991-notes" class="wiki"><p>This patch has successfully built and passed the test suite on all 17 Supported Platforms which are:</p>


	<p>12 builds: MSVC {2005/8/10/12/13/15}x{ 32/64 } dll<br />1 build: MSVC2003/32 static<br />1 build: Linux/64/GCC5.2 shared<br />1 build: Linux/64/GCC4.9 shared<br />1 build: MacOSX/64/clang dylib<br />1 build: MinGW/32/GCC4.9 static</p>


	<p>Congrats.  I hope this is the final patch for v0.26.  Hoping to ship v0.26 tonight.</p></div>
    </div>
  </div>
  
  <div id="change-5999" class="journal has-notes">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/80">Dimitri Schoolwerth</a> <a title="27 Apr 2017 10:28" href="/projects/exiv2/activity?from=2017-04-27">over 4 years</a> ago
      <span id="journal-5999-private_notes" class=""></span>
    </h4>

    <div id="journal-5999-notes" class="wiki"><p>Thank you Robin (and for all of your work!).</p>


	<p>Robin Mills wrote:</p>


<blockquote>

	<p>I thought I had to do something like this to build with Visual Studio 2003 (which will be deprecated after v0.26 ships).  Do you think there is a risk to the build here?</p>


</blockquote>

	<p>I don't think there's a risk. Even if the 'wrong' branch would be picked it still works: The #else branch (with critical section code) is sure to work since at least Windows 95 (which is not supported, but just for reference) and with very old SDKs too. The only reason the SRW lock branch is there is for (profiled?) performance reasons, according to note <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Crash while reading in parallel threads (Closed)" href="/issues/1187#note-29">#1187-29</a>.</p>


<blockquote>

	<p>Perhaps it's better to leave this as a patch for the occasional user of XP.  What do you think?</p>


</blockquote>

	<p>That's already what it is supposed to do: Only if someone using a newer VS explicitly targets XP then the critical section code is used which is compatible with releases prior to Windows 7.</p>


	<p>Which VS version is used to create the downloadable Windows binary by the way, VS2003? If it's VS2012 (actually it depends on SDK version, not so much VS version) or earlier than the code will work with XP and Vista. In other cases Exiv2 will require at least Windows 7 by default, unlike 0.25.</p></div>
    </div>
  </div>
  
  <div id="change-6000" class="journal has-notes">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="27 Apr 2017 22:59" href="/projects/exiv2/activity?from=2017-04-27">over 4 years</a> ago
      <span id="journal-6000-private_notes" class=""></span>
    </h4>

    <div id="journal-6000-notes" class="wiki"><p>Thanks, Dimitri.  I asked for your "risk assessment" before I reviewed your patch.  We agree that your patch is good.</p>


	<p>Exiv2 v0.26 will publish builds from the buildserver for 16 platforms.  I believe the VS2005/32 dll build will work on XP.</p>


	<p>12 builds: MSVC {2005/8/10/12/13/15}x{ 32/64 } dll<br />1 build: Linux/64/GCC5.2 shared<br />1 build: Cygwin/64/GCC4.9 shared<br />1 build: MacOSX/64/clang dylib<br />1 build: MinGW/32/GCC4.9 static</p>


	<p>As you know, Exiv2 is open-source.  We publish source code.  Binary builds in the release are provided for user convenience.  "VS 2003 .Net is deprecated", means that I do not actively build and test that platform.  However the source code probably works.  After v0.26, I intend to remove the msvc2003 directory and move forward with only the msvc directory which builds successfully with VS: {2005|8|10|12|13|15|17} x {dll|static} x {32|64} x {debug|release} (56 configurations).</p>


	<p>I will continue to support Linux, Cygwin and MacOS-X with numerous versions of GCC and clang.</p>


	<p>The MinGW msys/1.0 platform seems in poor shape and will be deprecated after Exiv2 v0.26 ships.  Please remember "deprecated" = I don't build and test this platform.  However it probably works.</p></div>
    </div>
  </div>
  
  <div id="change-6155" class="journal has-notes">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="03 Feb 2018 13:03" href="/projects/exiv2/activity?from=2018-02-03">almost 4 years</a> ago
      <span id="journal-6155-private_notes" class=""></span>
    </h4>

    <div id="journal-6155-notes" class="wiki"><p>Dimitri</p>


	<p>Last year we discussed the project to "fix 64 bit I/O in Exiv2" and I believe you said "Maybe in 2018".  So we're now is 2018 and probably even busier than 2017.  Are you still interested?</p>


	<p>I'm glad to say that I now have a little team of 4 helping me with Exiv2.  I've proposed to hold a developer's meeting in May:  <a class="external" href="https://github.com/Exiv2/exiv2/issues/225">https://github.com/Exiv2/exiv2/issues/225</a></p>


	<p>There are many interesting projects which could be usefully added to Exiv2.  The puzzle for the future is to find people willing to commit the time to develop and support the library.  I am 67 years old and announced my retirement last year.  I'm still contributing and very pleased that, after years on my own, others are actively contributing to Exiv2.  <a class="external" href="http://dev.exiv2.org/boards/3/topics/2992">http://dev.exiv2.org/boards/3/topics/2992</a></p></div>
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1292.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1292.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
