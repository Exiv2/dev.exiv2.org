<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Bug #1195: Misclassified Canon Lens TagInfo - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="b5nzkGeLY6+xOkP5qQdbFKChu/hw2qU2d9ClrVzqaeGN1Fh/FfGvr+ReXPUW0FcnnzPvgYE5BIyK8DUlH9OOjg==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
    <link rel="alternate" type="application/atom+xml" title="Exiv2 - Bug #1195: Misclassified Canon Lens TagInfo" href="https://dev.exiv2.org/issues/1195.atom" />
<script src="/javascripts/context_menu.js?1550767427"></script><link rel="stylesheet" media="screen" href="/stylesheets/context_menu.css?1550767427" /></head>
<body class="project-exiv2 has-main-menu controller-issues action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="issues" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="issues" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          <h3>Issues</h3>

<ul>
<li><a href="/projects/exiv2/issues?set_filter=1">View all issues</a></li>
<li><a href="/projects/exiv2/issues/report">Summary</a></li>

</ul>









        
    </div>

    <div id="content">
        
        <div class="contextual">





</div>


<h2>Bug #1195</h2>

<div class="issue tracker-1 status-2 priority-4 priority-default details">
    <div class="next-prev-links contextual">
      <a title="#1048" accesskey="p" href="/issues/1048">« Previous</a> |
        <span class="position">
          <a href="/issues?f%5B%5D=status_id&amp;op%5Bstatus_id%5D=o&amp;page=3&amp;per_page=25&amp;set_filter=1&amp;sort=updated_on%3Adesc%2Cid%3Adesc&amp;v%5Bstatus_id%5D%5B%5D=">52 of 78</a>
        </span> |
      <a title="#826" accesskey="n" href="/issues/826">Next »</a>
    </div>

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Misclassified Canon Lens TagInfo</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="22 Jun 2016 07:12" href="/projects/exiv2/activity?from=2016-06-22">over 5 years</a> ago.
        Updated <a title="30 Jun 2016 07:20" href="/projects/exiv2/activity?from=2016-06-30">over 5 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Assigned</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="assigned-to attribute"><div class="label">Assignee:</div><div class="value"><a class="user active" href="/users/119">Robin Mills</a></div></div><div class="category attribute"><div class="label">Category:</div><div class="value">makernote</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="31 Dec 2020" href="/versions/54">0.28</a></div></div></div><div class="splitcontentleft"><div class="start-date attribute"><div class="label">Start date:</div><div class="value">22 Jun 2016</div></div><div class="due-date attribute"><div class="label">Due date:</div><div class="value"></div></div><div class="progress attribute"><div class="label">% Done:</div><div class="value"><table class="progress progress-10"><tr><td style="width: 10%;" class="closed" title="10%"></td><td style="width: 90%;" class="todo"></td></tr></table><p class="percent">10%</p></div></div><div class="estimated-hours attribute"><div class="label">Estimated time:</div><div class="value">20.00 h</div></div></div></div>


</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>I’ve been using your library in the context of implementing some improvements to the hdrmerge tool, an application written by Wenzel Jakob, available on github.</p>


	<p>I am working on a way to do automatic TCA/Vignetting correction using the lensfun library.</p>


	<p>This in turn relies on having access to the lens name, as provided by exiftool in its LensID tag (this I’m recovering using the write() method on the iterator returned by Exiv2::lensName(), per a suggestion from Andreas). The other thing it relies on is information about the focus distance, for Canon cameras this is available as a pair of integers (uint16) in the File Info block of the maker notes, number 0x14 and 0x15. I noticed these entries are misclassified in canonmn.cpp:1347 (the TagInfo is set up as signedShort instead of unsignedShort), so I went in and changed the TagInfo setup, but nothing seems to have changed in the returned result, somehow the Metadatum still has signedShort type. The I noticed that the canonFiCfg struct in tiffimage.cpp defaults to ttSignedShort entries, while seems to ignore the type provided in the TagInfo struct. Indeed changing the defult decoded type to ttUnsignedShort changes the whole struct types around. So I’m guessing if you could help me find where the type overriding should engage, I could fix it (and if you like send you a patch of some kind).</p>
  </div>
</div>







</div>




<div id="history">
<h3>History</h3>
  <div id="change-5191" class="journal has-notes has-details">
    <div id="note-1">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="22 Jun 2016 07:35" href="/projects/exiv2/activity?from=2016-06-22">over 5 years</a> ago
      <span id="journal-5191-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>0</i> to <i>20</i></li>
       <li><strong>Estimated time</strong> set to <i>5.00 h</i></li>
    </ul>
    <div id="journal-5191-notes" class="wiki"><p>In general, exiv2 isn't a metadata policeman. He reports what he finds in an image, so I'm not surprised that changing TagInfo has no effect.</p>


	<p>You may find the option -pR useful for exploring the data stored in an image. -pR = Recursively print image data structures embedded in the file. Perhaps you could provide a test file so that we are both "on the same page" in this discussion.</p></div>
    </div>
  </div>
  
  <div id="change-5192" class="journal has-notes">
    <div id="note-2">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="22 Jun 2016 08:00" href="/projects/exiv2/activity?from=2016-06-22">over 5 years</a> ago
      <span id="journal-5192-private_notes" class=""></span>
    </h4>

    <div id="journal-5192-notes" class="wiki"><p>I've received this email from Lucas:</p>


	<p>Are you saying that the type in the TagInfo is meant to be overridden by the default setup in canonFiCfg? Or are you saying that the type comes from the IFD data in the file?</p>


	<p>In either case we have a bug: in the first case, the setup of the code is inappropriate, because Canon’s File Info struct has a mixture of datatypes in it, and these are not being propagated correctly when the Exifmetadatum object is constructed (because of this overriding behaviour that seems defective). In the case in which the file should command the type, we also have a defect, because other evidence (exfitool, for example) suggests the type should be uint16 whereas still the struct’s opinion dominates. So it seems to me, a way or another there is some further understanding to be gained.</p>


	<p><em><strong>And a second email</em></strong></p>


	<p>Further to this, I suspect I’m seeing further evidence of this being a problem:<br />If you look at tiffcomposite.cpp:1837, you can see how the fix for issue 1337 was put a patch in toTypeId() to make it “understand” how pentax and nikon’s tags such and such have a different signedness compared to their neighbours.</p>


	<p>What I keep not understanding is why isn’t it simpler to use the values in the tagInfo structures directly. It seems that this double-<br />definition can only cause problems…</p>


	<p>FWIW, at present the fix for this “bug” I found is simply to add another similar special case:<br />Canonmn.cpp:1347 and 1348: change signedShort to unsignedShort<br />Canonmn.cpp:1824, same change<br />Tiffcomposite.cpp:1851: add check much like the Nikon/Pentax trap already present:<pre><code class="cplusplus syntaxhl"><span class="n">If</span> <span class="n">ti</span> <span class="o">==</span> <span class="n">signedShort</span>
  <span class="n">If</span> <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="mh">0x14</span> <span class="n">or</span> <span class="n">tag</span> <span class="o">==</span> <span class="mh">0x15</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">group</span> <span class="o">==</span> <span class="n">canonFiId</span>
    <span class="n">Ti</span> <span class="o">=</span> <span class="n">unsignedShort</span></code></pre></p>


	<p>I suppose the actual issue is understand whether or not this is desirable behaviour or not.</p>


	<p><em><strong>My response</strong></em></p>


	<p>Please provide a test file.  I didn't write Exiv2, so I have to read/debug/think/guess what's going on. If we are both dealing with the same data, that's one less source of confusion.</p>


	<p>I see you are in NZ and I am in England.  So no overlap in the working day.  I'm available on Skype 'clanmills' until about 11pm in England (10am in NZ).</p></div>
    </div>
  </div>
  
  <div id="change-5199" class="journal has-notes">
    <div id="note-3">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Jun 2016 10:26" href="/projects/exiv2/activity?from=2016-06-24">over 5 years</a> ago
      <span id="journal-5199-private_notes" class=""></span>
    </h4>

    <div id="journal-5199-notes" class="wiki"><p>I spoke to Luca on Skype.  Here's the transcript from the post-mortem (Time is BST = UTC+1.00)</p>


	<p><em>23-Jun-2016, 22:57:55 <strong>Robin Mills:</strong></em> Call  35 minutes 54 seconds</p>


	<p><em>23-Jun-2016, 23:01:13 <strong>Robin Mills:</strong></em> 35 minutes usefully spent.  Right. You patch your v0.25 code and you're OK for now.  Later in the year (September) we'll work on tiffvisitor and see if we can get him to enforce the data type.  And you may be able to compare the exiftool tables with Exiv2/mumbleMN.cpp tables - although without us enforcing the data coercion, that's possibly of limited help.  Anyway, let's regroup about this in (your) spring/ (my) fall.</p>


	<p><em>23-Jun-2016, 23:02:58 <strong>Luca Fascione:</strong></em> Yes that's right. Thanks a lot it was great meeting you!</p>


	<p><em>23-Jun-2016, 23:04:10 <strong>Robin Mills:</strong></em> The test-suite stuff is documented in several places such as:<br /><a class="external" href="http://www.exiv2.org/download.html">http://www.exiv2.org/download.html</a> where Andreas says to run <pre>$ svn export svn://dev.exiv2.org/svn/tags/0.25/test # to get the test files (34mb)
$ make tests # to run the tests themselves.</pre></p>


	<p>I've written a longer note about the test suite here:  <a class="external" href="http://dev.exiv2.org/projects/exiv2/wiki/How_do_I_run_the_test_suite_for_Exiv2">http://dev.exiv2.org/projects/exiv2/wiki/How_do_I_run_the_test_suite_for_Exiv2</a></p>


	<p><em>23-Jun-2016, 23:06:29 <strong>Luca Fascione:</strong></em> Great thanks!</p>


	<p><em>23-Jun-2016, 23:07:28 <strong>Robin Mills:</strong></em> You may email me directly and I will reply.  I've no idea why you've had trouble with Redmine.  Perhaps you could register with your gmail account or something.  For sure, it's better to talk on the forum because I'm not the only person to read it.  And replies are stored forever and can be searched.  In this case, I had totally forgotten about this from 3 years ago, and yet you were able to see my previous words/work on the subject.  So .... let's try to use the Forum.  Better for everybody.</p>


	<p><em>23-Jun-2016, 23:08:29 <strong>Luca Fascione:</strong></em> Yes. I'll see to make another account</p>


	<p><em>23-Jun-2016, 23:08:46 <strong>Robin Mills:</strong></em> Good.  Speak Later.</p>


	<p><em>23-Jun-2016, 23:09:08 <strong>Luca Fascione:</strong></em> Best of luck there (y)</p></div>
    </div>
  </div>
  
  <div id="change-5200" class="journal has-details">
    <div id="note-4">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Jun 2016 10:28" href="/projects/exiv2/activity?from=2016-06-24">over 5 years</a> ago
      <span id="journal-5200-private_notes" class=""></span>
    </h4>

    <ul class="details">
       <li><strong>% Done</strong> changed from <i>20</i> to <i>10</i></li>
       <li><strong>Estimated time</strong> changed from <i>5.00 h</i> to <i>20.00 h</i></li>
    </ul>
    
    </div>
  </div>
  
  <div id="change-5202" class="journal has-notes">
    <div id="note-5">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="25 Jun 2016 05:28" href="/projects/exiv2/activity?from=2016-06-25">over 5 years</a> ago
      <span id="journal-5202-private_notes" class=""></span>
    </h4>

    <div id="journal-5202-notes" class="wiki"><p>How does Exiv2 determine Exif tag types?</p>


	<p>1) When writing: For normal Exif tags, the type used in the Exifdatum will determine the type written to the file. For makernote tags, which do not store tag type information in their binary representation, the user has to make sure the Exifdatum type is compatible with the binary structure of the makernote tag. (As complicated as that may sound, it is not an issue.)</p>


	<p>2) When reading: For normal Exif tags, the type from the Exif binary structure is used. For some makernote tags, the binary structure does not contain type information, so Exiv2 has to know it. Such makernote constructs are configured in the TIFF parser, in tiffimage.cpp. For example, the canonFiCfg structure contains configurations for the entire array and in canonFiDef you can configure individual tags, if they are not all the same. It is there where you'd configure, among other things, if the 16 bit should be read as a signed or unsigned integer.<br />As camera vendors rarely provide makernote specifications, all these configurations have been reverse engineered. The best and most up-to-date understanding of makernote tags is usually found in the exiftool source code.<br />(I do not immediately understand why the toType() function had to be changed in tiffcomposite.cpp in <a class="changeset" title="Fix: http://dev.exiv2.org/boards/3/topics/1337 extended to handle Exif.Pentax.Temperature. Thanks..." href="/projects/exiv2/repository/exiv2/revisions/2962">r2962</a> as pointed out above, maybe that should be revisited with these explanations in mind.)</p>


	<p>3) The role of TagInfo: The type in the TagInfo structure is <strong>only</strong> used as the default type to create an Exifdatum when the user doesn't explicitely specify a type, e.g., in a statement like <code>exifData["Exif.Image.YResolution"] = "-2/3";</code> (and for the reference documentation on the website.)<br />Yes, the type in TagInfo is redundant in the case of binary makernote constructs without type info, like canonFiCfg. For consistency, it has to correspond to the configuration in tiffimage.cpp.</p></div>
    </div>
  </div>
  
  <div id="change-5203" class="journal has-notes">
    <div id="note-6">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/4698">Luca Fascione</a> <a title="26 Jun 2016 21:52" href="/projects/exiv2/activity?from=2016-06-26">over 5 years</a> ago
      <span id="journal-5203-private_notes" class=""></span>
    </h4>

    <div id="journal-5203-notes" class="wiki"><p>Hi Andreas,<br />thanks for the explanation, I will review my proposal patch accordingly (and while I'm at it, also recode <a class="changeset" title="Fix: http://dev.exiv2.org/boards/3/topics/1337 extended to handle Exif.Pentax.Temperature. Thanks..." href="/projects/exiv2/repository/exiv2/revisions/2962">r2962</a> in the same way).<br />As much as I understand it won't be the most elegant thing in the world, what do you think about the idea of adding a piece of code somewhere that verifies the two definitions agree? Potentially conditioned to some flag, be that runtime or a pre-processor define of some kind. You know, just so that on the one side one could run a test and check it's all consistent, and on the other side, it'd be a very useful breadcrumb for somebody else trying to find their way around the code, to see a couple lines of code saying "this is what the tiff parser thinks, this is what the TagInfo layer thinks, they ought to agree".</p>


	<p>Thanks again<br />Luca</p></div>
    </div>
  </div>
  
  <div id="change-5204" class="journal has-notes">
    <div id="note-7">
    <div class="contextual">
      <span class="journal-actions"></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4>
      
      Updated by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="30 Jun 2016 07:20" href="/projects/exiv2/activity?from=2016-06-30">over 5 years</a> ago
      <span id="journal-5204-private_notes" class=""></span>
    </h4>

    <div id="journal-5204-notes" class="wiki"><p>An automatic way to verify that the types in the tag definitions of the TIFF parser and corresponding TagInfo types match would be a welcome check; it's not straightforward to check manually. Personally, I'd prefer it to be completely outside of the library code (e.g., a test script or program), as this is not something we need to ship to every exiv2 library user. And I suspect it will take more than a couple of lines of code. ;)</p>


	<p>To make the code more understandable, maybe I should put some of the explanations above in the code as comments and/or into the wiki.</p></div>
    </div>
  </div>
  


</div>

<div style="clear: both;"></div>
<div class="contextual">





</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/1195.atom">Atom</a></span>
  <span><a class="pdf" rel="nofollow" href="/issues/1195.pdf">PDF</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
