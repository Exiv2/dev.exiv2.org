<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Revision 2 - History - The server-side script to handle Exiv2 HTTP Write Access - The server-side script to handle Exiv2 HTTP Write Access - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="BSaGjED9rAMME3nmCtCJalFdt0N9lo4eDYCTzyOK0HDnay1jModgA1l3Zuq1B4VZbs/jOox1L6TwoANHYLM3Hw==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
  <meta name="robots" content="noindex,follow,noarchive" />
</head>
<body class="project-exiv2 has-main-menu controller-wiki action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="wiki_pages" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="wiki_pages" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=wiki" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=wiki">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki selected" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="">
    <div id="sidebar">
          
<h3>Wiki</h3>
<ul>
  <li><a href="/projects/exiv2/wiki">Start page</a></li>
  <li><a href="/projects/exiv2/wiki/index">Index by title</a></li>
  <li><a href="/projects/exiv2/wiki/date_index">Index by date</a></li>
</ul>


        
    </div>

    <div id="content">
        
        <div class="contextual">


  <span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions">Actions</span></span><div class="drdn-content"><div class="drdn-items">
    <a class="icon icon-history" href="/projects/exiv2/wiki/The_server-side_script_to_handle_Exiv2_HTTP_Write_Access/history">History</a>

      

</div></div></span></div>



  <h2><a href="/projects/exiv2/wiki/The_server-side_script_to_handle_Exiv2_HTTP_Write_Access">The server-side script to handle Exiv2 HTTP Write Access</a> &#187; <a href="/projects/exiv2/wiki/The_server-side_script_to_handle_Exiv2_HTTP_Write_Access/history">History</a> &#187; Revision 2</h2>

    <p>
      <a href="/projects/exiv2/wiki/The_server-side_script_to_handle_Exiv2_HTTP_Write_Access/1">« Previous</a> |
    Revision 2/3
      (<a href="/projects/exiv2/wiki/The_server-side_script_to_handle_Exiv2_HTTP_Write_Access/2/diff">diff</a>)
      | <a href="/projects/exiv2/wiki/The_server-side_script_to_handle_Exiv2_HTTP_Write_Access/3">Next »</a>
    <br />
    <em><a class="user active" href="/users/3761">Tuan Nhu</a>, 17 Aug 2013 08:34 </em><br />
    
    </p>
    <hr />

<div class="wiki wiki-page">
  <a name="The-server-side-script-to-handle-Exiv2-HTTP-Write-Access"></a>
<h1 >The server-side script to handle Exiv2 HTTP Write Access<a href="#The-server-side-script-to-handle-Exiv2-HTTP-Write-Access" class="wiki-anchor">&para;</a></h1>


	<p>The remote I/O feature will be available on the release 0.25. It allows Exiv2 to support http, ftp and ssh protocols (both read and write access).  The write access for HTTP/HTTPS protocol requires the script on the server to handle the submitted data. This wiki helps you to create this script.</p>


	<a name="The-submitted-data"></a>
<h2 >The submitted data<a href="#The-submitted-data" class="wiki-anchor">&para;</a></h2>


	<p>Exiv2 doesn't submit the whole file to the server to make efficient use of band-width. It only submits the part which is different from the original image file. The data is submitted via <strong>POST</strong> method and there are four parameters.</p>


	<table>
		<tr>
			<th>name </th>
			<th>type   </th>
			<th>description</th>
		</tr>
		<tr>
			<td>path </td>
			<td> string  </td>
			<td> The path of the image file.</td>
		</tr>
		<tr>
			<td>from </td>
			<td> integer </td>
			<td> The start position (byte index) in the image file is replaced by the submitted data.</td>
		</tr>
		<tr>
			<td>to   </td>
			<td> integer </td>
			<td> The end position (byte index) in the image file is replaced by the submitted data.</td>
		</tr>
		<tr>
			<td>data </td>
			<td> base64-encoded data </td>
			<td> The data.</td>
		</tr>
	</table>




	<p>Example:</p>


<code> ./exiv2 -M"set Exif.Photo.UserComment charset=Ascii Hello World" http://example.com/photo/test.jpg </code>

	<p>After running the above command, let's assume that the part from the byte 100 to the byte 110 in the original image file is changed to "2f77 7777 2e69 6563 2e63 6800 0000 0000" (hexadecimal). The POST data should be.</p>


	<table>
		<tr>
			<td>path</td>
			<td>/photo/test.jpg</td>
		</tr>
		<tr>
			<td>from</td>
			<td> 100</td>
		</tr>
		<tr>
			<td>to</td>
			<td> 110</td>
		</tr>
		<tr>
			<td>data</td>
			<td> MmY3NyA3Nzc3IDJlNjkgNjU2MyAyZTYzIDY4MDAgMDAwMCAwMDAw</td>
		</tr>
	</table>




	<a name="The-example-sever-side-script-in-PHP"></a>
<h2 >The example sever-side script in PHP<a href="#The-example-sever-side-script-in-PHP" class="wiki-anchor">&para;</a></h2>


<pre><code class="PHP syntaxhl"><span class="nv">$HTTP_DIR</span>    <span class="o">=</span> <span class="s2">"/var/www"</span><span class="p">;</span>                   <span class="c1">// the web root directory.</span>
<span class="nv">$path</span>        <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'path'</span><span class="p">];</span>            <span class="c1">// the path of image file.</span>
<span class="nv">$from</span>        <span class="o">=</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'from'</span><span class="p">]);</span>    <span class="c1">// the start position.</span>
<span class="nv">$to</span>          <span class="o">=</span> <span class="nb">intval</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'to'</span><span class="p">]);</span>      <span class="c1">// the end position.</span>
<span class="nv">$binaryData</span>  <span class="o">=</span> <span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'data'</span><span class="p">]);</span><span class="c1">// the data.</span>

<span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$path</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$from</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$to</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Please POST: path, from, to, data"</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$imagePath</span>   <span class="o">=</span> <span class="nv">$HTTP_DIR</span><span class="o">.</span><span class="nv">$path</span><span class="p">;</span>              <span class="c1">// the absolute path of image file.</span>
<span class="nv">$tempPath</span>    <span class="o">=</span> <span class="nv">$HTTP_DIR</span><span class="o">.</span><span class="nv">$path</span><span class="o">.</span><span class="s2">"_temp"</span><span class="p">;</span>      <span class="c1">// the absolute path of temporary file.</span>
<span class="nv">$imageHandle</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$imagePath</span><span class="p">,</span> <span class="s2">"rb"</span><span class="p">);</span>
<span class="nv">$tempHandle</span>  <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$tempPath</span><span class="p">,</span> <span class="s2">"w+b"</span><span class="p">);</span>

<span class="c1">#copy the head of image file (index 0 -&gt; $from index) to the temp file.</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$from</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$contents</span> <span class="o">=</span> <span class="nb">fread</span><span class="p">(</span><span class="nv">$imageHandle</span><span class="p">,</span> <span class="nv">$from</span><span class="p">);</span>
    <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$tempHandle</span><span class="p">,</span> <span class="nv">$contents</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">#insert the submitted data to the temp file.</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$binaryData</span><span class="p">))</span> <span class="p">{</span>
    <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$tempHandle</span><span class="p">,</span> <span class="nv">$binaryData</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1"># move to index $to in the image file</span>
<span class="nb">fseek</span><span class="p">(</span><span class="nv">$imageHandle</span><span class="p">,</span> <span class="nv">$to</span><span class="p">,</span> <span class="nx">SEEK_SET</span> <span class="p">);</span>

<span class="c1"># write the rest of image file to temp file</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">feof</span><span class="p">(</span><span class="nv">$imageHandle</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$contents</span> <span class="o">=</span> <span class="nb">fread</span><span class="p">(</span><span class="nv">$imageHandle</span><span class="p">,</span> <span class="nb">filesize</span><span class="p">(</span><span class="nv">$imagePath</span><span class="p">)</span> <span class="o">-</span> <span class="nv">$to</span><span class="p">);</span>    
    <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$tempHandle</span><span class="p">,</span> <span class="nv">$contents</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">#replace the image file with the temp file.</span>
<span class="nb">fclose</span><span class="p">(</span><span class="nv">$imageHandle</span><span class="p">);</span>
<span class="nb">fclose</span><span class="p">(</span><span class="nv">$tempHandle</span><span class="p">);</span>
<span class="nb">unlink</span><span class="p">(</span><span class="nv">$imagePath</span><span class="p">);</span>
<span class="nb">rename</span><span class="p">(</span><span class="nv">$tempPath</span><span class="p">,</span> <span class="nv">$imagePath</span><span class="p">);</span></code></pre>

	<a name="EXIV2_HTTP_POST-environmental-variable"></a>
<h2 >EXIV2_HTTP_POST environmental variable.<a href="#EXIV2_HTTP_POST-environmental-variable" class="wiki-anchor">&para;</a></h2>


	<p>The server-side script url must be specified with the environmental variable EXIV2_HTTP_POST, so Exiv2 knows the place to post the data.</p>


	<p>Example:</p>


<code> export EXIV2_HTTP_POST=http://example.com/script/exiv2.php </code>
</div>


<fieldset class="collapsible collapsed hide-when-print">
  <legend onclick="toggleFieldset(this);">Files (0)</legend>
  <div style="display: none;">

  

</div>
</fieldset>

<p class="wiki-update-info">
  Updated by <a class="user active" href="/users/3761">Tuan Nhu</a> <a title="17 Aug 2013 08:34" href="/projects/exiv2/activity?from=2013-08-17">over 8 years</a> ago
 · <a href="/projects/exiv2/wiki/The_server-side_script_to_handle_Exiv2_HTTP_Write_Access/history">2 revisions</a>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
