<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>who&#39;s mishandling UTF-8? - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="Zs3hKm4kAlTrnBEYA5UpxopeeVxEIfxpnaaWcICjqnWEgErFHF7OVL74DhS8QiX1tcwtJbXCXdNghgb4w5pNGg==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
</head>
<body class="project-exiv2 has-main-menu controller-messages action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="messages" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="messages" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=boards" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=boards">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards selected" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="nosidebar">
    <div id="sidebar">
        
        
    </div>

    <div id="content">
        
        <p class="breadcrumb"><a href="/projects/exiv2/boards">Forums</a> » <a href="/projects/exiv2/boards/3">Forum</a> » </p>

<div class="contextual">
    
    
    
    
</div>

<h2>who&#39;s mishandling UTF-8?</h2>

<div class="message">
<p><span class="author">Added by <a class="user active" href="/users/1038">Matěj Cepl</a> <a title="18 Aug 2010 09:33" href="/projects/exiv2/activity?from=2010-08-18">over 11 years</a> ago</span></p>
<div class="wiki">
<p>Hi,</p>


	<p>could with somebody with deeper knowledge of EXIF/IPTC tell me where could be the issue with <a class="external" href="http://trac.yorba.org/ticket/2247">http://trac.yorba.org/ticket/2247</a> IMHO, jbrout just passes the information down to exiv. Are all my images irrevocably corrupted?</p>


	<p>Thank you for any response,</p>


	<p>Matěj</p>
</div>

</div>
<br />

<div id="replies">
<h3 class="comments icon icon-comments">Replies (8)</h3>
  <div class="message reply" id="message-594">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/590?r=594#message-594">RE: who&#39;s mishandling UTF-8?</a>
    -
    Added by <a class="user active" href="/users/133">Robin Mills</a> <a title="18 Aug 2010 22:44" href="/projects/exiv2/activity?from=2010-08-18">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>I believe that jbrout uses pyexiv2 and exiv2.  I built it for them a couple of years ago - around exiv2 0.18, I think.  I haven't heard this story before and I hope exiv2 isn't responsible.  Perhaps Andreas can comment on the library's UTF-8 performance.</p>


	<p>It's not really clear to me from the bug report that exiv2 is responsible for this.  Have you discussed this with jbrout and/or fdiba?</p></div>
  
  </div>
  <div class="message reply" id="message-598">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/590?r=598#message-598">RE: who&#39;s mishandling UTF-8?</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="20 Aug 2010 02:22" href="/projects/exiv2/activity?from=2010-08-20">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>You need to take this question back to the application which wrote the metadata to this image. Let them decide what is wrong and if necessary forward their analysis to whoever they think is the root cause for the observed issue.</p>


	<p>This is what exiv2 and hd show for the relevant tags from the sample picture in the referred bug report:</p>


<pre>
Iptc.Application2.Keywords                   String      7  Máminy
Iptc.Application2.Keywords                   String      5  Praha
Iptc.Application2.Keywords                   String      8  Květná
Xmp.dc.subject                               XmpBag      3  MÃ¡miny, Praha, KvÄ›tnÃ¡
</pre>

<pre>
Iptc.Application2.Keywords                     7
  0000  4d c3 a1 6d 69 6e 79                             M..miny

Iptc.Application2.Keywords                     5
  0000  50 72 61 68 61                                   Praha

Iptc.Application2.Keywords                     8
  0000  4b 76 c4 9b 74 6e c3 a1                          Kv..tn..
</pre>

<pre>
00001c70  3e 0a 20 20 3c 64 63 3a  73 75 62 6a 65 63 74 3e  |&gt;.  &lt;dc:subject&gt;|
00001c80  0a 20 20 20 3c 72 64 66  3a 42 61 67 3e 0a 20 20  |.   &lt;rdf:Bag&gt;.  |
00001c90  20 20 3c 72 64 66 3a 6c  69 3e 4d c3 83 c2 a1 6d  |  &lt;rdf:li&gt;M....m|
00001ca0  69 6e 79 3c 2f 72 64 66  3a 6c 69 3e 0a 20 20 20  |iny&lt;/rdf:li&gt;.   |
00001cb0  20 3c 72 64 66 3a 6c 69  3e 50 72 61 68 61 3c 2f  | &lt;rdf:li&gt;Praha&lt;/|
00001cc0  72 64 66 3a 6c 69 3e 0a  20 20 20 20 3c 72 64 66  |rdf:li&gt;.    &lt;rdf|
00001cd0  3a 6c 69 3e 4b 76 c3 84  e2 80 ba 74 6e c3 83 c2  |:li&gt;Kv.....tn...|
00001ce0  a1 3c 2f 72 64 66 3a 6c  69 3e 0a 20 20 20 3c 2f  |.&lt;/rdf:li&gt;.   &lt;/|
00001cf0  72 64 66 3a 42 61 67 3e  0a 20 20 3c 2f 64 63 3a  |rdf:Bag&gt;.  &lt;/dc:|
</pre>

	<p>The IPTC keywords are UTF-8 encoded, just that the Iptc.Envelope.CharacterSet dataset to indicate the IPTC character set is missing. (That could easily be added.)</p>


	<p>The XMP strings are not UTF-8 encoded. It looks like something went wrong when the XMP data was written to the file.<br />From the XMP data it is also clear that that was not done with Exiv2.</p>


	<p>Andreas</p></div>
  
  </div>
  <div class="message reply" id="message-599">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/590?r=599#message-599">RE: who&#39;s mishandling UTF-8?</a>
    -
    Added by <a class="user active" href="/users/1038">Matěj Cepl</a> <a title="20 Aug 2010 07:00" href="/projects/exiv2/activity?from=2010-08-20">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>Yes, that's exactly what I hoped for to get here. I have filed a new <a href="http://code.google.com/p/jbrout/issues/detail?id=158" class="external">ticket</a> against jbrout for this issue.</p>


	<p>Thank you very much</p></div>
  
  </div>
  <div class="message reply" id="message-600">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/590?r=600#message-600">RE: who&#39;s mishandling UTF-8?</a>
    -
    Added by <a class="user active" href="/users/1038">Matěj Cepl</a> <a title="20 Aug 2010 08:33" href="/projects/exiv2/activity?from=2010-08-20">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>Plot thickens ... <a class="external" href="https://bugs.launchpad.net/pyexiv2/+bug/621201">https://bugs.launchpad.net/pyexiv2/+bug/621201</a> (from <a class="external" href="https://code.google.com/p/jbrout/issues/detail?id=158#c1">https://code.google.com/p/jbrout/issues/detail?id=158#c1</a>)</p></div>
  
  </div>
  <div class="message reply" id="message-604">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/590?r=604#message-604">RE: who&#39;s mishandling UTF-8?</a>
    -
    Added by <a class="user active" href="/users/140">Olivier Tilloy</a> <a title="23 Aug 2010 02:46" href="/projects/exiv2/activity?from=2010-08-23">about 11 years</a> ago
  </h4>
  <div class="wiki"><blockquote>

	<p>From the XMP data it is also clear that that was not done with Exiv2.</p>


</blockquote>

	<p>Andreas, do you mean that the tags were not written using libexiv2’s writer methods?<br />Note that pyexiv2 relies solely on libexiv2 to read and write metadata, it doesn’t do any custom I/O operations aside.<br />Could that possibly mean that those faulty tags were in fact written by another application using another library (I’m extrapolating here)?</p></div>
  
  </div>
  <div class="message reply" id="message-605">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/590?r=605#message-605">RE: who&#39;s mishandling UTF-8?</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="23 Aug 2010 03:56" href="/projects/exiv2/activity?from=2010-08-23">about 11 years</a> ago
  </h4>
  <div class="wiki"><p>Olivier,</p>


	<p>Yes, that's exactly what I mean. The XMP metadata in this image was not written by Exiv2. With what you're saying I take it that means it was also not done with pyexiv2.</p>


	<p>Andreas</p></div>
  
  </div>
  <div class="message reply" id="message-612">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/590?r=612#message-612">RE: who&#39;s mishandling UTF-8?</a>
    -
    Added by <a class="user active" href="/users/1038">Matěj Cepl</a> <a title="27 Aug 2010 10:20" href="/projects/exiv2/activity?from=2010-08-27">about 11 years</a> ago
  </h4>
  <div class="wiki"><p>Thanks, we were working on this last couple of days with maintainers of both pyexiv2 and jbrout (<a class="external" href="https://bugs.launchpad.net/pyexiv2/+bug/621201">https://bugs.launchpad.net/pyexiv2/+bug/621201</a>, and <a class="external" href="https://code.google.com/p/jbrout/issues/detail?id=160">https://code.google.com/p/jbrout/issues/detail?id=160</a>) and the conclusion is that XMP metadata are hopelessly corrupted by previous versions of jbrout (or the auxiliary programs it uses). However, it seems to be almost impossible to remove corrupted metadata (<a class="external" href="https://code.google.com/p/jbrout/issues/detail?id=161">https://code.google.com/p/jbrout/issues/detail?id=161</a>), even</p>


	<p>exiv2 -d x picture.jpg</p>


	<p>(from exiv2-0.20-1.fc14.x86_64) doesn't seem to be able to remove corrupted XMP data from the attached image. Any help?</p></div>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/196">p20090318_024642.jpg</a>    <span class="size">(1.76 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/196/p20090318_024642.jpg">p20090318_024642.jpg</a>  </td>
  <td>testing image with corrupted metadata</td>
  <td>
  </td>
  <td>
  </td>
</tr>
</table>
</div>

  </div>
  <div class="message reply" id="message-681">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/590?r=681#message-681">RE: who&#39;s mishandling UTF-8?</a>
    -
    Added by <a class="user active" href="/users/1038">Matěj Cepl</a> <a title="25 Oct 2010 15:24" href="/projects/exiv2/activity?from=2010-10-25">about 11 years</a> ago
  </h4>
  <div class="wiki"><p>OK, this is not completely PEBKAC, but there was a mistaken assumption on my part. I thought (based on my understanding of <a class="external" href="https://code.google.com/p/jbrout/issues/detail?id=161#c1">https://code.google.com/p/jbrout/issues/detail?id=161#c1</a>) that the problem is in XMP, but in the end looks it was more in IPTC tags "Iptc.Application2.Keywords" which were corrupted. This simple script:<br /><pre>
#!/usr/bin/python
# -*- coding: utf-8 -*-

import sys,codecs,pyexiv2

knownKeywords = codecs.open("/home/matej/archiv/2010/projekty/cleanKeywords/knownKeywords.txt",
        encoding="utf-8").read().split("\n")

goodKeywords = []
metadata = pyexiv2.ImageMetadata(unicode(sys.argv[1], "utf-8"))
metadata.read()
if ('Iptc.Application2.Keywords' in metadata.iptc_keys):
        tag = metadata['Iptc.Application2.Keywords']
        for a in tag.raw_values:
                a = unicode(a, "utf-8")
                if ((a in knownKeywords) and (a not in goodKeywords)):
                        goodKeywords.append(a)
        tag.values = goodKeywords
        metadata.write(preserve_timestamps=True)
</pre><br />allowed me to clear my photos from all unwanted keywords and so I have clean data now. Hopefully.</p>


	<p>Thanks for all help.</p></div>
  
  </div>
</div>
<span class="pagination"><ul class="pages"></ul><span><span class="items">(1-8/8)</span> </span></span>



        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
