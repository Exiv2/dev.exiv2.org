<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Clone function - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="NhyFWXoZZqrvzphCAzJOXRJrValRAF9/DVu0IQXZUoTUUS62CGOqqrqqh0685UJuLfkB0KDj/sXweySpRuC16w==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
</head>
<body class="project-exiv2 has-main-menu controller-messages action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="messages" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="messages" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=boards" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=boards">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards selected" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="nosidebar">
    <div id="sidebar">
        
        
    </div>

    <div id="content">
        
        <p class="breadcrumb"><a href="/projects/exiv2/boards">Forums</a> » <a href="/projects/exiv2/boards/3">Forum</a> » </p>

<div class="contextual">
    
    
    
    
</div>

<h2>Clone function</h2>

<div class="message">
<p><span class="author">Added by <a class="user active" href="/users/384">David Vongrad</a> <a title="26 Feb 2010 11:39" href="/projects/exiv2/activity?from=2010-02-26">over 11 years</a> ago</span></p>
<div class="wiki">
<p>I've been using Exiv2 for a number of years now without even getting new versions. My sole purpose of using it was simply to get the date and time of the image so I could rename the JPG file to YYYY-MM-DD HH.MM.SS.JPG based on the date the photo was taken. Now when I use the application I wrote, it crashes on me with the call:</p>


	<p>Exiv2::ExifData exifData = image -> exifData ();</p>


	<p>which leads to</p>


	<p>AutoPtr clone() const { return AutoPtr(clone_()); }</p>


	<p>This is puzzling since files that I have renamed before no longer work, which lead me to believe that the EXIF data is possibly corrupted, although the image opens in Photoshop CS4 and the data is readable in PhotoME EXIF reader.</p>


	<p>I think I mighht benefit from an updated version of Exiv2 but I'm not convinced that is the solution since I've used the same version for years now with any problems. Any thoughts on why this issue may have suddenly occurred? TIA</p>
</div>

</div>
<br />

<div id="replies">
<h3 class="comments icon icon-comments">Replies (19)</h3>
  <div class="message reply" id="message-420">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=420#message-420">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/133">Robin Mills</a> <a title="26 Feb 2010 14:41" href="/projects/exiv2/activity?from=2010-02-26">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>Hi David</p>


	<p>I'm very surprised by your report and I'm sure Andreas will have something very helpful to say about this later.  3 questions spring immediately to mind:</p>


	<p>1) Could you let us know which version/platform of the library you are using.<br />2) Are you saying that you only read the meta-data and renamed the file, and all those files seem to be damaged in some way?<br />3) Can you upload a sample JPG which exhibits this issue (preferably before and after processing).</p>


	<p>Robin</p></div>
  
  </div>
  <div class="message reply" id="message-422">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=422#message-422">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/384">David Vongrad</a> <a title="26 Feb 2010 17:14" href="/projects/exiv2/activity?from=2010-02-26">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>Hi Robin,</p>


	<p>Attached is a ZIP file containing the EXE I've written to rename the files with the Exiv2 library, two JPG files taken with a Nikon D700 and post-processed in Photoshop CS4 for color and tonality only and the Exiv2.lib file that was linked into the EXE. One file is named as a date, but no longer works with my app and the other is the original file name. I'm not sure of the LIB version since it's been the same one I've used for several years now, but it has worked flawlessly for the last several years on the thousands of JPG files I've used it on. The undated JPG file is in its original state because it fails processing by the Exiv2 library. I have a feeling the failure may not actually be the fault of the Exiv2 library, but I still wanted to contact you in the event you may have some insight as to what could be going wrong.</p>


	<p>The EXE is an MFC aplication originally written in Visual C++ 6 and most recently compiled in Visual Studio 2008. The LIB file did not change. Using the EXE is straightforward: retrieve the file list from a directory containing JPG files and date the pictures.</p>


	<p>Excerpts from the code I use are as follows:</p>


	<p>byte abytDateTimeDigitized<sup><a href="#fn20">20</a></sup>;</p>


	<p>Exiv2::Image::AutoPtr image = Exiv2::ImageFactory::open (strFullPath.GetBuffer ());<br />image -> readMetadata ();<br />Exiv2::ExifData exifData = image -> exifData ();<br />if (!exifData.empty ()) {<br />  Exiv2::ExifData::const_iterator end = exifData.end ();<br />  for (Exiv2::ExifData::const_iterator i = exifData.begin (); i != end; ++i) {<br />     if (i -> key () == "Exif.Photo.DateTimeDigitized") {<br />         i -> value ().copy (abytDateTimeDigitized, Exiv2::bigEndian);<br />         break;<br />    }<br />}</p>


	<p>char *strBuffer = (char *) abytDateTimeDigitized;<br />...<br />}</p>


	<p>I know I'm probably not using the library correctly in determining where the DateTimeDigitized meta-data actually is in the file, but as I said, my approach has worked quite well until just recently.</p>


	<p>I tried compiling the most recent Exiv2 code in Visual Studio 2008, but it didn't seem to work after successfully compiling expat and zlib. Perhaps I did something wrong there and I'll have to review the README-MSVC.txt file to see if I've missed anything.</p>


	<p>My application also resets the system creation and last modified date of the file but these actions are done with SetFileTime calls using the date data retrieved from the Exiv2 library. At the moment, my application has a preference to reset the date taken and date digitized to an offset in hours in the event that I did not reset my camera time to account for daylight savings time. Because at the time I was not familiar with the Exiv2 API, I did the time update in the file by looking for the date string in the file and modifying it by force rather that a proper Exiv2 API call. I would prefer to do it the proper way, so if you can let me know what the proper call is, I would appreciate it.</p>


	<p>Use of the Exiv2 library has worked great with several different camera, both point-and-shoot and DSLRs, some being as much as 6 years old, so I was quite surprised when my app no longer worked when nothing obvious had changed. I'm hoping there might be a simple solution to the issue I'm facing. If you need any further information, please do not hesitate to contact me.</p>


	<p>Regards,</p>


	<p>David C. Vongrad</p></div>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/152">exiv2.zip</a>    <span class="size">(15.7 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/152/exiv2.zip">exiv2.zip</a>  </td>
  <td>App using library and sample JPG files.</td>
  <td>
  </td>
  <td>
  </td>
</tr>
</table>
</div>

  </div>
  <div class="message reply" id="message-423">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=423#message-423">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/384">David Vongrad</a> <a title="26 Feb 2010 21:28" href="/projects/exiv2/activity?from=2010-02-26">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>After some tweaking by move missing include files, etc. to proper locations (probably because of changes in library hierarchy), I was able to compile and link the latest release of the Exiv2 files and link them to my own application. For whatever reason, the files I was having problems with indicated that there was no embedded Exif data. I'm not sure why this is since I did nothing more in Photoshop than I usually do with my photos. I'd be curious to know why the older version of Exiv2.lib failed because of that, but since I was able to get a build, don't feel compelled to investigate it for me unless you too are curious about it. :)</p></div>
  
  </div>
  <div class="message reply" id="message-424">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=424#message-424">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/384">David Vongrad</a> <a title="27 Feb 2010 00:16" href="/projects/exiv2/activity?from=2010-02-27">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>What I thought was a fix by using the ReleaseDLL version of exiv2.lib with the appropriate DLLs was not a fix after all; my app still said there was no EXIF data in the JPG files! My app uses the following code, with some minor revisions for simplicity of this post:</p>


	<p>CString strLogEntry;<br />CString strFullPath;</p>


	<p>Exiv2::Image::AutoPtr image = Exiv2::ImageFactory::open (strFullPath.GetBuffer ());<br />ASSERT (image.get () != 0);<br />image -> readMetadata ();</p>


	<p>Exiv2::ExifData exifData = image -> exifData ();</p>


	<p>if (exifData.empty ()) 
{<br />     strLogEntry.Format ("No EXIF data found in %s.", strFullPath);<br />     cout >> strLogEntry;<br />}<br />else 
{<br />     // read meta-data and do something with it<br />}</p>


	<p>Even with the libraries linked statically, the exifData.empty() call was true every time on a JPG that was taken with a Nikon D700 and simply copied to my computer a few seconds later, just as if there really was no meta-data in the file! I have attached the offending JPG and my statically linked updated app for your reference.</p></div>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/153">DSC_1088.JPG</a>    <span class="size">(4.66 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/153/DSC_1088.JPG">DSC_1088.JPG</a>  </td>
  <td></td>
  <td>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/154">DatePics.exe</a>    <span class="size">(1.78 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/154/DatePics.exe">DatePics.exe</a>  </td>
  <td></td>
  <td>
  </td>
  <td>
  </td>
</tr>
</table>
</div>

  </div>
  <div class="message reply" id="message-425">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=425#message-425">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/133">Robin Mills</a> <a title="27 Feb 2010 15:25" href="/projects/exiv2/activity?from=2010-02-27">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>David</p>


	<p>Thanks for sending all of this stuff.  I'm the DevStudio guy here - Andreas is so smart he keeps away from Windows!  We have guests for the weekend and I'll take a good look at this on Sunday evening (I'm in California).  I really like puzzles and I know I'm going to have a pleasant time investigating this for you.</p></div>
  
  </div>
  <div class="message reply" id="message-426">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=426#message-426">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/384">David Vongrad</a> <a title="27 Feb 2010 16:32" href="/projects/exiv2/activity?from=2010-02-27">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>I appreciate any time you can take to look into this for me. I've attached another JPG file because I noticed something that you may find interesting. When the JPG from my last post is alone in a folder, DatePics.exe says the file has no EXIF data. When this attachment is the only file in that folder, again the app says there is no EXIF data. It's only when both JPGs are in the same folder that the app says there's no EXIF data for the first (1088) and completely crashes on the second (1134). I did find it interesting, however, that stepping through the app's code in VS 2008 leads to the same result: it saying there is no EXIF data in either file. I'm not sure what to make of this, but I hope your efforts to investigate this do not go to waste because of a possible flaw in my code.</p>


	<p>I'm from Alberta, where, as you may know, hockey is very big here in Canada. I assume with you being in California, that you're American, so we're probably on the opposite sides of the fence as far as cheering on a team in tomorrow's men's hockey gold medal final. Go Canada Go! :)</p>


	<p>I'm looking forward to your response. Thanks again for looking into this for me. I think Exiv2 is a great library and I certainly hope I can continue using it after being so reliable for the past few years. I know I'd like to explore its potential further in handling my meta-data needs.</p>


	<p>Dave</p></div>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/155">DSC_1134.JPG</a>    <span class="size">(4.17 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/155/DSC_1134.JPG">DSC_1134.JPG</a>  </td>
  <td></td>
  <td>
  </td>
  <td>
  </td>
</tr>
</table>
</div>

  </div>
  <div class="message reply" id="message-427">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=427#message-427">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="28 Feb 2010 07:05" href="/projects/exiv2/activity?from=2010-02-28">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>I don't want to interfere :) We were away this weekend but it's Sunday evening quite a few hours earlier here in KL than in California, so I have a bit of an advantage here.<br />What follows are just some generic statements (without even having looked at the attachments - Robin will surely be more specific).</p>


	<ul>
	<li>Several memory corruption bugs were fixed in Exiv2 over time. These strike randomly. A program may work fine one day and crash the next without any obvious changes in the environment</li>
		<li>Bug <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Digikam bug 136855: Editing metadata on a few selected imagefiles and clicking forward or apply c... (Closed)" href="/issues/496">#496</a> is an example of such a beast. It was fixed in version 0.12, a long time ago, but only after months of <a href="http://bugs.kde.org/show_bug.cgi?id=136855#c38" class="external">hide-and-seek</a>. It eventually turned out to be an issue with ExifData::operator= (nowadays we don't even have that operator anymore) and only happened with images from certain cameras; Nikon was one. So it might as well be a candidate for your scenario, but no point speculating</li>
		<li>If you only need to rename pictures as described, you should be able to use the exiv2 utility for that. Have a look at the "rename" action and the "-r" option. Problems with the exiv2 utility may be easier for us to track down than issues with your own program that uses the Exiv2 library</li>
		<li>If you decide to use a newer version of Exiv2 in your program, please make sure you use one that doesn't suffer from bug <a class="issue tracker-1 status-5 priority-6 priority-high2 closed" title="Bug: Image file gets deleted when writing to it (Closed)" href="/issues/672">#672</a>, which seems to show especially when compiling with MSVC (but not with g++), i.e., version 0.18.2 or the SVN trunk version in the absence of any release with that fix</li>
	</ul>


	<p>Andreas</p></div>
  
  </div>
  <div class="message reply" id="message-428">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=428#message-428">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/384">David Vongrad</a> <a title="28 Feb 2010 08:47" href="/projects/exiv2/activity?from=2010-02-28">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>Hi Andreas,</p>


	<p>My most recent EXE attachment links with version 0.19 of the library. I'm not even convinced that Exiv2 is at fault with the issue I'm facing as it may very well be something in my own code that is causing the problem. But with my success in linking with a version of the library that is now a few years old with my own code that hasn't changed in almost as long, I was surprised to see that there was now a problem when it seemed nothing had changed. I've had my Nikon D700 for several months now, and even though I use Exiv2 only for renaming the file based on the timestamp and ensure that the Exif timestamp corresponds to the current daylight savings time (if I forget to adjust the time in my camera for this change), I also use Win32 functions to change the system file create and last modified time back to the Exif timestamp so that edits to the files after it was taken are not readily apparent. I thought that it could also be that camera settings that I've recently changed may have affected the Exif data and Exiv2's interpretation of it, but I quickly discounted that since resetting the camera to factory defaults did not fix the problem.</p>


	<p>I did look at the Exiv2 utility options and was able to rename a file in the format that I use. I haven't yet fully investigated the option of adjusting the Exif timestamp to a time when the camera is not set to DST or ensuring that system file times correspond to the Exif times, but I assume that would work as well. The only thing about using this utility is that the .jpg extension after a rename is in lowercase when I would prefer it as uppercase. I didn't see an Exiv2 option to force a rename to be lower or uppercase, but it shouldn't be overly difficult to do if I were to dabble in your code (I wouldn't expect you to do that just to appease my own preference since I may be the only one using the utility that cares about such a thing) and it's also quite easy to issue a command like "ren *.jpg *.JPG" anyway. I was just hoping that I wouldn't have to use another EXE in conjunction with my own application when linking to the library should suffice. My app is by no means commercial since I wrote it for myself to do what I wanted it to do regarding filenames and internal timestamps. As such, I have no real aversion to using Exiv2.exe as a separate process call in my app, especially when I'm confident it'll most likely do what I need it to. I have several family and friends using my app and I haven't reviewed your license terms in enough detail to be certain that including Exiv2.exe in my distribution would be a violation of the license agreement. Since you do provide the code for the library, I'm assuming that redistributing it wouldn't be a problem. I'd also be comfortable in having you or Robin look at my own code to help isolate this issue, but I wouldn't expect either of you to do so since it may very well be an issue with my own code or improper use of the Exiv2 library.</p>


	<p>In any event, thank you for your input and I'm looking forward to hearing from you or Robin regarding resolution of this issue.</p>


	<p>Dave</p></div>
  
  </div>
  <div class="message reply" id="message-429">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=429#message-429">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/133">Robin Mills</a> <a title="28 Feb 2010 21:16" href="/projects/exiv2/activity?from=2010-02-28">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>Dave</p>


	<p>Good News.</p>


	<p>I used your code to construct a little command line program (DatePics2) and linked DebugDLL.  Crashes on DSC_1134.JPG (OK with the other two files).  I investigated: ah, it's in jpgimage.cpp readMetadata().  psBlob is empty.  I invent a fix if ( psBlob.size()) { ... }.  Everything is happy again.</p>


	<p>I'm amazed to see that I haven't synced up with exiv2 on my desktop since last July.  I sync up and rebuild.  DatePic2.exe works fine!  The bug has already been fixed in the trunk.  I inspect the code.  Yes somebody's been in and modified the code at the exact same spot in jpgimage.cpp</p>


	<p>My code's in the DatePics2 directory.  Usual excuses and guarantees.</p>


	<p>So I recommend that you sync the trunk, build the libraries and relink your application and all should be OK.</p>


	<p>Not quite so good (but not bad) (Commit #2032)<br />----------------------------------------------</p>


	<p>Because I haven't rebuilt exiv2 on Windows for a while, a couple of new MSVC only issues have appeared in the trunk:</p>


	<p>1) actions.cpp has a reference to gmtime_r which isn't available in MSVC 2008.<br />Patch (line 1853)<br />#ifdef EXV_HAVE_GMTIME_R<br />        if (time  (time_t)-1 || gmtime_r(&#38;time, tm)  0) return 11;<br />#else<br />        if (time  (time_t)-1 || std::gmtime(&#38;time)   0) return 11;<br />#endif</p>


	<p>2) I'm getting unsatisfied external the CharsetId::name() method (which is in a Windows DLL)<br />Patch is to preface the declaration with EXV_DLLLOCAL (line 542 value.hpp)</p>
	<pre><code>EXV_DLLLOCAL static const char* name(CharsetId charsetId);</code></pre>


	<p>Something completely different<br />------------------------------</p>


	<p>I wrote a command-line program like DatePics in 2002 using GdiPlus (before the birth of exiv2).  I haven't recompiled it for almost 8 years and it's still working fine.  If you're interested, I'll give you the code.  Of course, I recommend always (and only) recommend exiv2 for processing metadata.</p>


	<p>For Andreas:<br />I've committed the fixes #2032 and I would appreciate your review.  As far as I can see, they are 100% MSVC only changes.</p>


	<p>Robin</p></div>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/156">DatePics2.zip</a>    <span class="size">(4.42 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/156/DatePics2.zip">DatePics2.zip</a>  </td>
  <td></td>
  <td>
  </td>
  <td>
  </td>
</tr>
</table>
</div>

  </div>
  <div class="message reply" id="message-430">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=430#message-430">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="01 Mar 2010 06:12" href="/projects/exiv2/activity?from=2010-03-01">over 11 years</a> ago
  </h4>
  <div class="wiki"><blockquote>

	<p>I did look at the Exiv2 utility options and was able to rename a file in the format that I use. I haven't yet fully investigated the option of adjusting the Exif timestamp to a time when the camera is not set to DST or ensuring that system file times correspond to the Exif times, but I assume that would work as well.</p>


</blockquote>

	<p>Yes, both of these should be possible</p>


<blockquote>

	<p>The only thing about using this utility is that the .jpg extension after a rename is in lowercase when I would prefer it as uppercase. I didn't see an Exiv2 option to force a rename to be lower or uppercase, but it shouldn't be overly difficult to do if I were to dabble in your code</p>


</blockquote>

	<p>Right</p>


<blockquote>

	<p>and I haven't reviewed your license terms in enough detail to be certain that including Exiv2.exe in my distribution would be a violation of the license agreement.</p>


</blockquote>

	<p>It's the GPL2. What you describe is fine.</p>


	<p>-ahu.</p></div>
  
  </div>
  <div class="message reply" id="message-431">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=431#message-431">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="01 Mar 2010 06:21" href="/projects/exiv2/activity?from=2010-03-01">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>Robin,</p>


	<p>Thanks for fixing the MSVC issues you found. Your changes look ok, although I don't understand the one in value.hpp (I'll compile without and see what happens, no worries).</p>


<blockquote>

	<p>I used your code to construct a little command line program (DatePics2) and linked DebugDLL.  Crashes on DSC_1134.JPG (OK with the other two files).  I investigated: ah, it's in jpgimage.cpp readMetadata().  psBlob is empty.  I invent a fix if ( psBlob.size()) { ... }.  Everything is happy again.</p>


</blockquote>

	<p>Yes, taking the address of the first element of an empty vector is something that MSVC (rightly) doesn't like, while g++ is more forgiving.</p>


	<p>-ahu.</p></div>
  
  </div>
  <div class="message reply" id="message-432">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=432#message-432">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="01 Mar 2010 07:53" href="/projects/exiv2/activity?from=2010-03-01">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>Andreas Huggel wrote:</p>


<blockquote>

	<p>Robin,</p>


	<p>Thanks for fixing the MSVC issues you found. Your changes look ok, although I don't understand the one in value.hpp (I'll compile without and see what happens, no worries).</p>


</blockquote>

	<p>It appears to break the Mac OS X build though:</p>


<pre>
libtool: link: g++ -o .libs/exiv2 exiv2.o actions.o utils.o -Wl,-bind_at_load  -L/Users/ahuggel/src/exiv2/trunk/xmpsdk/src ./.libs/libexiv2.dylib -liconv -lz -lexpat
Undefined symbols:
  "Exiv2::CommentValue::CharsetInfo::name(Exiv2::CommentValue::CharsetId)", referenced from:
      Action::Print::printMetadatum(Exiv2::Metadatum const&#38;, Exiv2::Image const*)in actions.o
      Action::FixCom::run(std::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&#38;)in actions.o
ld: symbol(s) not found
</pre></div>
  
  </div>
  <div class="message reply" id="message-433">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=433#message-433">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/384">David Vongrad</a> <a title="01 Mar 2010 08:48" href="/projects/exiv2/activity?from=2010-03-01">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>Hi Robin,</p>


	<p>I checked out the code from the repository and linked your DatePics2 to the DebugDLL as you had done and it worked as you said it would. When I linked exiv2.lib to my app, it still crashed on me when run outside the debugger. I'm convinced now that the problem lies in my own code and will investigate it further rather than wasting anymore of your time. At the very least I can use the exiv2 utility to rename my photos until I figure out what is happening within my app.</p>


	<p>As a developer, I'm always interested in others' perpective on programming issues so I'd like to see your GdiPlus utility code. I'm still committed to using Exiv2 once I figure out what is going wrong in my own code, but that may take some time as there are more pressing projects to work on at the moment.</p>


	<p>Thanks again for your and Andreas' help.</p>


	<p>Dave</p>


	<p>P.S. Are there any C#.NET interfaces available to use with Exiv2?</p></div>
  
  </div>
  <div class="message reply" id="message-434">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=434#message-434">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/133">Robin Mills</a> <a title="01 Mar 2010 09:21" href="/projects/exiv2/activity?from=2010-03-01">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>You can use exiv2 from C# using the exiv2net wrapper written by Andreas Grimme (not to be confused with Andreas Huggel).  It's written in C++ and there is a sample C# application.  We don't support exiv2net in the exiv2 repository because Mr Huggel (quite rightly in my opinion) wants to keep out of 'wrappers' for .Net, Python, Perl and so on.  I haven't built exiv2net for almost 2 years - however it worked fine for me.  You can get the code from:</p>


	<p>exiv2net<br /><a class="external" href="http://code.google.com/p/exiv2net/">http://code.google.com/p/exiv2net/</a></p>


	<p>Here's another wrapper - however I've looked at it:<br />exiv2-sharp<br /><a class="external" href="http://www.ohloh.net/p/exiv2-sharp">http://www.ohloh.net/p/exiv2-sharp</a><br /><a class="external" href="http://anonsvn.mono-project.com/viewvc/trunk/exiv2-sharp/">http://anonsvn.mono-project.com/viewvc/trunk/exiv2-sharp/</a></p>


	<p>Drop me an email at <a class="email" href="mailto:robin@clanmills.com">robin@clanmills.com</a> and I'll send you the pdate.cpp directly.  I'm in the office and I don't have the code here.  So I'll send it from home this evening.</p>


	<p>Robin</p></div>
  
  </div>
  <div class="message reply" id="message-435">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=435#message-435">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/133">Robin Mills</a> <a title="01 Mar 2010 09:29" href="/projects/exiv2/activity?from=2010-03-01">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>Andreas Huggel wrote:</p>


<blockquote>

	<p>It appears to break the Mac OS X build though:</p>


	<p>[...]</p>


</blockquote>

	<p>Andreas</p>


	<p>Goodness, I'm surprised.  I thought (from memory) that EXV_DLLLOCAL was a MSVC only macro for __decl(export) (or something like that) to export the entry point.  On other platforms it doesn't do anything.  Well, another interesting puzzle for me to investigate after work this evening.</p>


	<p>Robin</p></div>
  
  </div>
  <div class="message reply" id="message-436">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=436#message-436">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="01 Mar 2010 16:19" href="/projects/exiv2/activity?from=2010-03-01">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>Robin,</p>


	<p>Yes, this macro and its friends are also used for library symbol visibility control with gcc (available since gcc 4.0).<br />It was implemented as issue <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: C++ symbol visibility support for gcc builds (Closed)" href="/issues/523">#523</a>, mainly using this gcc article for guidance: <a class="external" href="http://gcc.gnu.org/wiki/Visibility">http://gcc.gnu.org/wiki/Visibility</a></p>


	<p>-ahu.</p></div>
  
  </div>
  <div class="message reply" id="message-437">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=437#message-437">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="01 Mar 2010 16:34" href="/projects/exiv2/activity?from=2010-03-01">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>Thanks, Andreas.  I'm sure I'll get this fixed this evening.  I was mistakenly under the impression that EXV_DLLLOCAL magic was unique to MSVC.  I'd failed to realise it was used by GCC - thanks for pointer to the 'visibility' guidelines.</p>


	<p>I'll revisit this and find something that keeps everybody (MSVC, GCC/Mac and GCC/Linux and possibly GCC/Windows) happy.  I'm still due you an email about GCC/Cygwin (not forgotten, simply not done yet).</p></div>
  
  </div>
  <div class="message reply" id="message-438">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=438#message-438">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/133">Robin Mills</a> <a title="01 Mar 2010 23:53" href="/projects/exiv2/activity?from=2010-03-01">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>Andreas</p>


	<p>There are two fixes:</p>


	<p>The safest/simplest fix is:<br />EXV_EXPORT static const char* name(CharsetId charsetId);<br />For sure this repairs the build because EXV_EXPORT is only defined for MSVC and adds the DLL export declaration to the name() method.</p>


	<p>I hesitate however.   I only intended to use EXV_EXPORT within the context of your EXIV2API declaration.  So I think the 'better fix' is to declare class CommentValue::CharsetInfo as EXIV2API (value.hpp line 532).</p>


	<p>Unfortunately, I haven't given myself enough time to do all the builds and tests and to be certain that both possible fixes are good.  However, I'll be happy to spend more time on this tomorrow evening.  Alternatively, if you're happy to commit one of these (and I prefer the EXIV2API solution), then I'll be happy to be done on this.</p>


	<p>David requested my pdate.cpp code and I've sent that to him in a private email.  I really don't want that published.  It was a 'throwaway' windows-only program that lived too long on my machine.</p>


	<p>So let me know.  If you want me to spend more time on Tuesday evening, that's fine with me.</p>


	<p>Robin</p></div>
  
  </div>
  <div class="message reply" id="message-439">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/419?r=439#message-439">RE: Clone function</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="02 Mar 2010 01:41" href="/projects/exiv2/activity?from=2010-03-02">over 11 years</a> ago
  </h4>
  <div class="wiki"><blockquote>

	<p>I hesitate however.   I only intended to use EXV_EXPORT within the context of your EXIV2API declaration.  So I think the 'better fix' is to declare class CommentValue::CharsetInfo as EXIV2API (value.hpp line 532).</p>


</blockquote>

	<p>Yes, please do this if it fixes the issue. That way the whole class will be part of the published API. In other words, it looks like a nested class doesn't inherit the EXIV2API declaration from its parent in MSVC (it's in the public section of the parent class, isn't it?). Am I right?</p>


	<p>Andreas</p></div>
  
  </div>
</div>
<span class="pagination"><ul class="pages"></ul><span><span class="items">(1-19/19)</span> </span></span>



        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
