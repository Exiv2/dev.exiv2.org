<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Exiv2  &amp; wmNonIntrusive Flag - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="CP/J0rLE1h4dC+r8aUp9Oe43b8iwDLJKUEOLqViCRn3qsmI9wL4aHkhv9fDWnXEK0aU7sUHvE/CtYxshG7uhEg==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
</head>
<body class="project-exiv2 has-main-menu controller-messages action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="messages" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="messages" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=boards" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=boards">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards selected" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="nosidebar">
    <div id="sidebar">
        
        
    </div>

    <div id="content">
        
        <p class="breadcrumb"><a href="/projects/exiv2/boards">Forums</a> » <a href="/projects/exiv2/boards/3">Forum</a> » </p>

<div class="contextual">
    
    
    
    
</div>

<h2>Exiv2  &amp; wmNonIntrusive Flag</h2>

<div class="message">
<p><span class="author">Added by <a class="user active" href="/users/384">David Vongrad</a> <a title="29 Nov 2017 21:29" href="/projects/exiv2/activity?from=2017-11-29">almost 4 years</a> ago</span></p>
<div class="wiki">
<p>In my MFC C++ application (VS 2017) using Exiv2 0.26, I would like to change some time stamps like Exif.Photo.DateTimeOriginal to a new value. However, I am noticing that on 24 MB files from a Nikon D810, this can be quite slow since it appears that the entire EXIF data is being rewritten to the file making it 10 K smaller in one JPG file I'm using. I have been made aware of a "wmNonIntrusive" flag which I of the understanding means not to rewrite EXIF unless necessary but I'm not sure how to use it properly. Since I am replacing 19 bytes in a file with a call to writeMetadata which the API docs for it say that "If no values have been assigned to a given metadata type, any exists section for that metadata type will be removed from the image", I am unsure as to why Exiv2 thinks rewriting all the EXIF data is required.</p>


	<p>Are there some API calls that will allow me to change EXIF data that is non-intrusive to improve the performance of Exiv2 or is my best bet to find the date/time strings within the file and change them with standard file I/O? Thanks.</p>
</div>

</div>
<br />

<div id="replies">
<h3 class="comments icon icon-comments">Replies (9)</h3>
  <div class="message reply" id="message-3005">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3004?r=3005#message-3005">RE: Exiv2 &amp; wmNonIntrusive Flag</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="30 Nov 2017 08:06" href="/projects/exiv2/activity?from=2017-11-30">almost 4 years</a> ago
  </h4>
  <div class="wiki"><p>David</p>


	<p>Somebody raised an issue last week concerning wmIntrusive.  I will investigate this in the next few days.  <a class="external" href="http://dev.exiv2.org/issues/1324">http://dev.exiv2.org/issues/1324</a></p>


	<p>I've just returned this morning from attending a wedding of a member of Team Exiv2 in Vietnam.  So I'll be jet lagged for a few days and hope to work on this next week.</p>


	<p>I'll see if something can be done to "pump" the performance of Exiv2 for your use case.  However, my hunch is that the Exiv2 data convertors cause your file to increase in size with the consequential I/O.</p>


	<p>A totally different approach is to determine the offset of DateTimeOriginal metadata in your file, memory map the file, and modify the bytes.  This will be "almost instantaneous" as the file will not be rewritten.   This approach requires your files to be parsed.  If you are only using JPEGs, it might be quite easy to write code to do this for a single format.  However, if you are using several formats, this approach doesn't scale.  I can't remember if you've provided me with samples of your files.  Can you do that please?  Which formats are you using: DNG, Tiff, JPEG?</p>


	<p>I'm sorry this issue is giving you angst.  You'll appreciate that I am an unpaid volunteer.  The engineering effort to optimise this use case could be considerable.  How often do you modify the time stamps and how much time will this save?</p></div>
  
  </div>
  <div class="message reply" id="message-3006">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3004?r=3006#message-3006">RE: Exiv2  &amp; wmNonIntrusive Flag</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="30 Nov 2017 12:43" href="/projects/exiv2/activity?from=2017-11-30">almost 4 years</a> ago
  </h4>
  <div class="wiki"><p>Here's something that looks rather promising:  <a class="external" href="https://docs.python.org/2/library/mmap.html">https://docs.python.org/2/library/mmap.html</a></p>


	<p>A memory mapping module for python and it includes a method to search the memory mapped file.  So, you can hunt for the metadata and determine the location in memory of the date strings.  I'm doing the search in bash (however it's just as easy in python):</p>


	<p><strong>1 Find the metadata using exiv2</strong><pre>533 rmills@rmillsmbp:~/clanmills $ exiv2 -pa --grep DateTime ~/Stonehenge.jpg 
Exif.Image.DateTime                          Ascii      20  2015:07:16 20:25:28
Exif.Photo.DateTimeOriginal                  Ascii      20  2015:07:16 15:38:54
Exif.Photo.DateTimeDigitized                 Ascii      20  2015:07:16 15:38:54
534 rmills@rmillsmbp:~/clanmills $ </pre><strong>2 Find the offset in the file of the DateTime strings</strong><pre>534 rmills@rmillsmbp:~/clanmills $ strings -a -t d ~/Stonehenge.jpg | grep '2015:07:16 20:25:28' 
    214 2015:07:16 20:25:28
535 rmills@rmillsmbp:~/clanmills $ strings -a -t d ~/Stonehenge.jpg | grep '2015:07:16 15:38:54' 
    760 2015:07:16 15:38:54
    780 2015:07:16 15:38:54
536 rmills@rmillsmbp:~/clanmills $ </pre>Now we know that DateTime is at offset 214.  DateTimeOriginal and DateTimeDigitized are at 760 and 780.</p>


	<p>When you know the offset, the document says that you can write the new substring data with a python "slice": <pre>mm[780:799] = '2015:07:16 10:11:12'</pre></p></div>
  
  </div>
  <div class="message reply" id="message-3007">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3004?r=3007#message-3007">RE: Exiv2  &amp; wmNonIntrusive Flag</a>
    -
    Added by <a class="user active" href="/users/384">David Vongrad</a> <a title="30 Nov 2017 20:28" href="/projects/exiv2/activity?from=2017-11-30">almost 4 years</a> ago
  </h4>
  <div class="wiki"><p>Hi Robin,</p>


	<p>Thanks for your reply. I had wanted to title this thread “Exiv2 and Image->writeMetadata”, but I didn’t see any way to correct my blunder after it was submitted. Your title is just as good so thanks for changing it.</p>


	<p>The goal is to set EXIF data like Exif.Photo.DateTimeOriginal and other date fields along with matching file system times only once (perhaps twice if I forget about DST changes). So far, I have been working with a small sample of JPG files from my Nikon D810 (~24 MB) and JPG from my daughter’s Sony a6000 from her spring trip to Austria (~7.3 MB) where a DST change for Austria did occur while she was there. Simply reading date stamps from around 380 Nikon JPG or 840 Sony JPG and renaming the files based on those dates is quite acceptable at only a few seconds, but modifying the date fields for all those files is quite time consuming at over about 17 minutes for Nikon and 6 minutes for Sony.</p>


	<p>The JPG images are decreasing in size as I suspect writeMetadata is removing EXIF “empty” data as was my understanding in the documentation. It’s doubtful I can use offsets to find the date fields in any files as I suspect these offsets would change for camera manufacturer or even file type (I’m using JPG from a few cameras, Nikon’s NEF, Sony’s ARW, and Canon’s CR2 so far). For example, the first date field in a Sony a6000 JPG is at 0xFA0A and at 0xF404 in a Nikon D810 JPG. I know that if I insert “Exif.Photo.UserComment” into the image, it is written between one date and the next and obviously dates farther into the file are dependent on how long the comment is. I haven’t yet tried to see if I can use comment length plus a known number of bytes to find the next date field, but I have my doubts this would be consistent from one camera to the next.</p>


	<p>I’m not adverse to opening a file in write binary mode, finding an ASCII string to change a few bytes and closing the file. As you said this would be quite fast, but I wanted to explore the possibility of using existing features of Exiv2 before doing it “by hand”. I would prefer to put my trust into Exiv2 rather than a brute force method, but it’s something I think I’ll try just for “fun”.</p>


	<p>I don’t want you to spend to much time on this, especially now if you are recovering from jet lag. I certainly know what being an unpaid volunteer is all about, but I will certainly appreciate any efforts you or your team can offer. Whether or not the engineering efforts are worth it to handle the request of me and a few others is something only the Exiv2 team can make. My app is a personal endeavour for myself and a few friends and extended family members so it’s not like it needs to be done today. I could send you a 24 MB Nikon JPG, but there is a 20 MB limit in this forum and time delays in rewriting files might be considered bearable unless you were processing hundreds of files at once.</p>


	<p>In the meantime, I’ll look at the links you provided and keep you apprised if I trust my brute force method to be a workable solution if I don’t hear from you by the time I’ve coded it and tested it enough to be comfortable with it.</p>


	<p>Thanks again.</p></div>
  
  </div>
  <div class="message reply" id="message-3008">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3004?r=3008#message-3008">RE: Exiv2  &amp; wmNonIntrusive Flag</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="30 Nov 2017 20:39" href="/projects/exiv2/activity?from=2017-11-30">almost 4 years</a> ago
  </h4>
  <div class="wiki"><p>Well, let's see what turns up.  I've promised to investigate <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Pentax Makernote written twice (Closed)" href="/issues/1324">#1324</a> next week.  So, I'll look at your use case when I'm working in that part of the code.  I'd prefer not to involve other members of the team in this investigation as they are focused in code for v0.27.  We hope to reach v0.27 RC1 in December.</p></div>
  
  </div>
  <div class="message reply" id="message-3009">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3004?r=3009#message-3009">RE: Exiv2  &amp; wmNonIntrusive Flag</a>
    -
    Added by <a class="user active" href="/users/384">David Vongrad</a> <a title="01 Dec 2017 16:36" href="/projects/exiv2/activity?from=2017-12-01">almost 4 years</a> ago
  </h4>
  <div class="wiki"><p>With 3 file seeks to consistent hard-coded offsets in the 840 Sony JPGs, I got the updates down to about 30 seconds from 6 minutes. I'm thinking searches for the date strings might increase that time to about a minute at most. Of course, I'm still quite open to any Exiv2 offerings. Good luck with <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Pentax Makernote written twice (Closed)" href="/issues/1324">#1324</a> and the release of 0.27!</p></div>
  
  </div>
  <div class="message reply" id="message-3010">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3004?r=3010#message-3010">RE: Exiv2  &amp; wmNonIntrusive Flag</a>
    -
    Added by <a class="user active" href="/users/384">David Vongrad</a> <a title="10 Dec 2017 21:09" href="/projects/exiv2/activity?from=2017-12-10">almost 4 years</a> ago
  </h4>
  <div class="wiki"><p>Well, I searched for the 3 date tag values and saved them to a std::map that is keyed on the values it finds. Each mapped value contains a vector where I can then search for the keys in the image and save their offsets from the beginning of the file. The vector is used in case the date key is the same for more than one of the date tags. Using those offsets, I can then seek to those offsets and write 19 new bytes of whatever date I want. The process for 840 Sony JPGs is only a couple seconds longer than the hard-coded test I mentioned above, thus cutting the Exiv2 EXIF rewrite time from about six minutes to just over 30 seconds. I put an option in my app to write the dates by Exiv2 methods that will make the files smaller if the user wants that at the expense of waiting longer to process them or by offsets that keeps the file sizes the same. I tested my approach on files from several cameras and all seems to be good. It may sound like a sloppy hack, but it works for what I need it for! :)</p></div>
  
  </div>
  <div class="message reply" id="message-3011">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3004?r=3011#message-3011">RE: Exiv2  &amp; wmNonIntrusive Flag</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="10 Dec 2017 22:41" href="/projects/exiv2/activity?from=2017-12-10">almost 4 years</a> ago
  </h4>
  <div class="wiki"><p>This is good news.  You’re doing the right thing here.  Sometimes general purpose code simply does not know the short cut to dealing with something.  You can probably make this even faster when you know that in JPG files, the maximum delta offset of two items of EXIF Metadata is 64k.  So once you find one date string, you have a upper bound for how far to search.</p>


	<p>I’m glad you’ve found this fix because I’ve been sick this week and haven’t been able to work on this nor <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Pentax Makernote written twice (Closed)" href="/issues/1324">#1324</a>.</p>


	<p>Very happy that you’ve “dug in” and found a solution.</p></div>
  
  </div>
  <div class="message reply" id="message-3119">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3004?r=3119#message-3119">RE: Exiv2  &amp; wmNonIntrusive Flag</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="10 Apr 2018 09:02" href="/projects/exiv2/activity?from=2018-04-10">over 3 years</a> ago
  </h4>
  <div class="wiki"><p>We're going to have a meeting of Team Exiv2 at my home in England 4-6 May 2018.  I've put this optimisation on the list to be discussed for development in v0.28 (in 2019).  I've called it "Turbo TimeStamp Editor"  <a class="external" href="http://dev.exiv2.org/news/3">http://dev.exiv2.org/news/3</a></p>


	<p>Although this is not a high priority for v0.28, the implementation would be very instructive concerning both metadata and Exiv2 architecture.  It's possible that a Team Exiv2 Engineer will undertake this challenge.</p></div>
  
  </div>
  <div class="message reply" id="message-3120">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3004?r=3120#message-3120">RE: Exiv2  &amp; wmNonIntrusive Flag</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="10 Apr 2018 11:24" href="/projects/exiv2/activity?from=2018-04-10">over 3 years</a> ago
  </h4>
  <div class="wiki"><p>David,</p>


	<p>If all you want to do is change some timestamps in a "non-intrusive" way, try with the exiv2 binary from the distribution first, and, if it doesn't work with the version you have, try with an older version. "Non-intrusive" meaning that only the existing timestamp bytes are changed in the image and nothing else. You don't need any flags, exiv2 used to handle that by itself. (I'm sure you can find more detailed explanations about that in the forum or in old issues.)</p>


	<p>Andreas</p></div>
  
  </div>
</div>
<span class="pagination"><ul class="pages"></ul><span><span class="items">(1-9/9)</span> </span></span>



        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
