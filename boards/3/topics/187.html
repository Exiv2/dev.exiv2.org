<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>BasicIo Api - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="h+/RESU11zPD7yP4FU5XmN0Lt+3kFRTSZzUkIogdZpNlonr+V08bM5aLPPSqmVur4pnjlBX2tWiaFbSqyySB/A==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
</head>
<body class="project-exiv2 has-main-menu controller-messages action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="messages" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="messages" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=boards" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=boards">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards selected" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="nosidebar">
    <div id="sidebar">
        
        
    </div>

    <div id="content">
        
        <p class="breadcrumb"><a href="/projects/exiv2/boards">Forums</a> » <a href="/projects/exiv2/boards/3">Forum</a> » </p>

<div class="contextual">
    
    
    
    
</div>

<h2>BasicIo Api</h2>

<div class="message">
<p><span class="author">Added by <a class="user active" href="/users/201">Mike Gemünde</a> <a title="13 Jul 2009 10:18" href="/projects/exiv2/activity?from=2009-07-13">over 12 years</a> ago</span></p>
<div class="wiki">
<p>Hi,</p>


	<p>I'm currently writing a wrapper for exiv2 for C# to make it usable for F-Spot (<a class="external" href="http://www.f-spot.org">www.f-spot.org</a>). To do this, I'm implementing a new BasicIo subclass to handle streams. I wondered a little bit about the API, especially mmap, munmap.<br />Memory mapping seems also be used for reading files, which is a little bit annoying, because its just explicitly buffering the file in memory. So if the stream is also highly buffered, copying it to memory ist not necessary.</p>


	<p>regards,<br />Mike</p>


	<p>P.S.: nice lib</p>
</div>

</div>
<br />

<div id="replies">
<h3 class="comments icon icon-comments">Replies (8)</h3>
  <div class="message reply" id="message-188">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/187?r=188#message-188">RE: BasicIo Api</a>
    -
    Added by <a class="user active" href="/users/133">Robin Mills</a> <a title="14 Jul 2009 12:27" href="/projects/exiv2/activity?from=2009-07-14">over 12 years</a> ago
  </h4>
  <div class="wiki"><p>Currently, the MSVC build does not use mmap/munmap to memory map the file.  Instead the file is copied totally into memory.  Memory mapping provides dramatic improvement (6x) on TIFF files as only the accessed parts of the files are copied from disk to memory.  I believe there are switches in exv_msvc.h to tell the build if mmap/munmap is available and this is disabled by default for MSVC builds.</p>


	<p>A C# wrapper was contributed last year and is available from Google code.  You may find this sufficient and/or provide you with useful ideas.</p></div>
  
  </div>
  <div class="message reply" id="message-189">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/187?r=189#message-189">RE: BasicIo Api</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Jul 2009 21:29" href="/projects/exiv2/activity?from=2009-07-14">over 12 years</a> ago
  </h4>
  <div class="wiki"><p>I've just discovered that there are several .Net wrappers for the exiv2 library.  The one I remember was exiv2net:  <a class="external" href="http://code.google.com/p/exiv2net/">http://code.google.com/p/exiv2net/</a> which I did download and build.</p></div>
  
  </div>
  <div class="message reply" id="message-190">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/187?r=190#message-190">RE: BasicIo Api</a>
    -
    Added by <a class="user active" href="/users/201">Mike Gemünde</a> <a title="14 Jul 2009 22:21" href="/projects/exiv2/activity?from=2009-07-14">over 12 years</a> ago
  </h4>
  <div class="wiki"><p>Hi,</p>


	<p>thx for your answers. I know about this wrapper. But since MSVC does not run under linux and mono does not compile c++ to cil, I do not really care about it.</p>


	<p>To mmap. This will be enabled for most linux distributions, so it can't be ignored.</p>


	<p>Mike</p></div>
  
  </div>
  <div class="message reply" id="message-191">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/187?r=191#message-191">RE: BasicIo Api</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="14 Jul 2009 22:55" href="/projects/exiv2/activity?from=2009-07-14">over 12 years</a> ago
  </h4>
  <div class="wiki"><p>I think I am unable to really appreciate your concern here.  Perhaps you could explain your environment as I always associate C# with Microsoft and MSVC.  From your comments, this doesn't appear to be your use case.  I believe mmap/munmap is used on the Linux/Mac/Unix builds.  You have a choice of using or ignoring mmap (the default is to use on *nix and to ignore with MSVC).</p>


	<p>Memory mapping is much faster that copying the whole file. This is because the OS reserves address space for the complete file - however it demand pages from disk to memory.  For a typical 8-16mb TIFF file - this usually involves reading a few blocks instead of the complete file.  So the result is to use about the same address space, however it uses less physical memory and results in much less slow disk access.  We've found exiv2 with mmap is about 6x faster for querying image properties.</p>


	<p>However there may be implementations of mmap which simply copy the file to real memory and such an implementation would result in slower performance than to rewrite part of exiv2 to search using buffered streams.  I believe Linux, Windows and MacOSX all use the demand paging strategy and taking the time to implement searching with buffered streams is unlikely to produce any change in performance (although it would use less address space/virtual memory).</p></div>
  
  </div>
  <div class="message reply" id="message-192">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/187?r=192#message-192">RE: BasicIo Api</a>
    -
    Added by <a class="user active" href="/users/201">Mike Gemünde</a> <a title="14 Jul 2009 23:31" href="/projects/exiv2/activity?from=2009-07-14">over 12 years</a> ago
  </h4>
  <div class="wiki"><p>Sorry, since most projects do not provide Windows builds, I forgot to point, that we are talking about Linux implementations.</p>


	<p>I do belive, that you have a speedup by using mmap. But I don't already understand, why a BasicIo must provide a mmap() function for that. If you want to use mmap for your FileIo, implement it locally and let read, seek, write, operate on the mapped file. I do not think this is a mechanism the API should provide, it is a implementation detail for speedup file access (and nothing else) which should be hided (my opinion). I think this way would not slow down your implementation for FileIO, but can speedup others.</p>


	<p>hope you can understand my concern.</p>


	<p>Mike</p></div>
  
  </div>
  <div class="message reply" id="message-193">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/187?r=193#message-193">RE: BasicIo Api</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="15 Jul 2009 00:30" href="/projects/exiv2/activity?from=2009-07-15">over 12 years</a> ago
  </h4>
  <div class="wiki"><p>Ahhhhhhhhh.  I now understand.  You are using C# from Mono on Linux.  And you are quite correct - it would be possible to hide mmap as an internal detail of the BasicIo implementation.</p>


	<p>I've never written a wrapper for the library.  Is it really necessary to provide an implementation of BasicIo ?  I've only thought about using that for different types of IO (for example over FTP or HTTP).  I've just taken a quick look at the exiv2net source and he didn't implement that class - he left it to the existing C++ code.</p></div>
  
  </div>
  <div class="message reply" id="message-194">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/187?r=194#message-194">RE: BasicIo Api</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="15 Jul 2009 04:18" href="/projects/exiv2/activity?from=2009-07-15">over 12 years</a> ago
  </h4>
  <div class="wiki"><p>Mike Gemünde wrote:</p>


<blockquote>

	<p>I do belive, that you have a speedup by using mmap. But I don't already understand, why a BasicIo must provide a mmap() function for that. If you want to use mmap for your FileIo, implement it locally and let read, seek, write, operate on the mapped file.</p>


</blockquote>

	<p>That is in fact a possibility. But just like adding some sort of <a href="http://dev.exiv2.org/issues/show/505#note-8" class="external">stream-based random access interface</a> to BasicIo, it will require a lot of changes to the existing library code (considerably more actually). That's because the existing library code which uses the mmap() feature is written as if it was dealing with memory. There are no read/seek/write calls in this code, it uses random access through memory pointers.</p>


	<p>Historically, before the BasicIo::mmap() feature existed, we used to read the whole TIFF file into memory before decoding it, because it was easier to do that than using stream functions. Adding BasicIo::mmap() later was a cheap way to get that 6-fold performance improvement, with hardly any changes.</p>


	<p>But it breaks the BasicIo stream interface, I agree. Realistically, because of the work involved and the performance boost that mmap() gives, this is not something that will change overnight now. Unless of course someone commits to not only come up with a better design but also re-write a lot of existing library code.</p>


	<p>On the other hand, parsing JPEG files does not use mmap(). So a BasicIo implementation which just buffers the complete stream for mmap(), will still be efficient for at least JPEG files. All those who use F-Spot only for JPEG images will be happy.</p>


	<p>Andreas</p>


	<p>PS:</p>


<blockquote>

	<p>I'm currently writing a wrapper for exiv2 for C# to make it usable for F-Spot (<a class="external" href="http://www.f-spot.org">www.f-spot.org</a>).</p>


</blockquote>

	<p>I was under the impression F-Spot is using Stephane Delcroix' .NET wrapper for exiv2 ?</p></div>
  
  </div>
  <div class="message reply" id="message-195">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/187?r=195#message-195">RE: BasicIo Api</a>
    -
    Added by <a class="user active" href="/users/201">Mike Gemünde</a> <a title="15 Jul 2009 04:18" href="/projects/exiv2/activity?from=2009-07-15">over 12 years</a> ago
  </h4>
  <div class="wiki"><p>Hi,</p>


	<p>you do not to implement a BsicIo for wrapper. But we want to take care of other file sources since FileIo provide. We want to have support for virtual filesystems like GioFilestreams and any other streams like the ones provided by .NET library.</p>


	<p>Hiding it would be nice, but I think it should be internally used by FileIo and nowhere else. Just to clarify what I mean.</p>


	<p>A little other API detail, the temporary() method is just used for writing (I think). Maybe a rename to getOutputIo() and outputFinished() would be more clarifying the intention of those methods. But just little detail.</p>


	<p>Mike</p></div>
  
  </div>
</div>
<span class="pagination"><ul class="pages"></ul><span><span class="items">(1-8/8)</span> </span></span>



        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
