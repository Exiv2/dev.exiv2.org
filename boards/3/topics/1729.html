<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Empty elements in a rdf:Seq - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="VzYiMDxd8HYTNeYnQryvz2k1cI4FieJHbEX++twaDLG1e4nfTic8dkZR+Sv9a6P8Vqck9/RqQ/2RZW5ynyPr3g==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
</head>
<body class="project-exiv2 has-main-menu controller-messages action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="messages" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="messages" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=boards" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=boards">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards selected" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="nosidebar">
    <div id="sidebar">
        
        
    </div>

    <div id="content">
        
        <p class="breadcrumb"><a href="/projects/exiv2/boards">Forums</a> » <a href="/projects/exiv2/boards/3">Forum</a> » </p>

<div class="contextual">
    
    
    
    
</div>

<h2>Empty elements in a rdf:Seq</h2>

<div class="message">
<p><span class="author">Added by <a class="user active" href="/users/3663">Tobias E.</a> <a title="14 Mar 2014 04:56" href="/projects/exiv2/activity?from=2014-03-14">over 7 years</a> ago</span></p>
<div class="wiki">
<p>Hello,</p>


	<p>after reading the API docs for a while now without finding anything that's helping me I guess I need your help.</p>


	<p>I have to read XMP files containing a rdf:Seq which can contain empty elements. The XML looks something like this:</p>


<pre>
  &lt;rdf:Seq&gt;
    &lt;rdf:li&gt;foo&lt;/rdf:li&gt;
    &lt;rdf:li&gt;bar&lt;/rdf:li&gt;
    &lt;rdf:li/&gt;
    &lt;rdf:li&gt;baz&lt;/rdf:li&gt;
  &lt;/rdf:Seq&gt;
</pre>

	<p>In my use case not only the order of these matters, but also that the 3rd entry is an empty one. If I use findKey() I can get an iterator to that sequence, but count() only returns 3. Consequently toString(3) crashes. Is there any way to make libexiv2 honour these empty entries, too?</p>


	<p>Thanks<br />Tobias</p>
</div>

</div>
<br />

<div id="replies">
<h3 class="comments icon icon-comments">Replies (24)</h3>
  <div class="message reply" id="message-1730">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=1730#message-1730">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="15 Mar 2014 03:00" href="/projects/exiv2/activity?from=2014-03-15">over 7 years</a> ago
  </h4>
  <div class="wiki"><p>Tobias,</p>


	<p>That doesn't sound right and it certainly shouldn't crash. Can you provide an image or xmp file that I could play with? Please attach it here or send it to ahuggel &lt;at&gt; gmx &lt;dot&gt; net</p>


	<p>Andreas</p></div>
  
  </div>
  <div class="message reply" id="message-1731">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=1731#message-1731">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/3663">Tobias E.</a> <a title="15 Mar 2014 07:14" href="/projects/exiv2/activity?from=2014-03-15">over 7 years</a> ago
  </h4>
  <div class="wiki"><p>Hi Andreas,</p>


	<p>here is a small XMP file and test program.</p>


	<p>Tobias</p></div>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/602">crash.xmp</a>    <span class="size">(506 Bytes)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/602/crash.xmp">crash.xmp</a>  </td>
  <td>XMP file with a rdf:Seq that has one empty element</td>
  <td>
  </td>
  <td>
  </td>
</tr>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/603">crash.cc</a>    <span class="size">(720 Bytes)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/603/crash.cc">crash.cc</a>  </td>
  <td>C++ test that crashes on crash.xmp in toString()</td>
  <td>
  </td>
  <td>
  </td>
</tr>
</table>
</div>

  </div>
  <div class="message reply" id="message-1732">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=1732#message-1732">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/3663">Tobias E.</a> <a title="18 Mar 2014 06:14" href="/projects/exiv2/activity?from=2014-03-18">over 7 years</a> ago
  </h4>
  <div class="wiki"><p>I would like to make it clear that I don't think that crashing is the bug here (well, a minor one maybe), but that the empty element is not accounted for. And most importantly, I would like to know if there is any way at all to get that empty rdf:li element.</p></div>
  
  </div>
  <div class="message reply" id="message-2666">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2666#message-2666">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/3663">Tobias E.</a> <a title="26 Aug 2016 16:07" href="/projects/exiv2/activity?from=2016-08-26">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>Is there anyone who can help? This issue is causing major problems in darktable and I would like to find a way to get that solved.</p></div>
  
  </div>
  <div class="message reply" id="message-2667">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2667#message-2667">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="26 Aug 2016 16:55" href="/projects/exiv2/activity?from=2016-08-26">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>I'll help you with this, Tobias.  I'm not aware of the issue.  I'm not sure what I'm looking for as I don't get a crash (on current trunk build).  It looks as though you have 4 elements in Seq:<pre>685 rmills@rmillsmbp:~/Downloads $ xmllint -pretty 1 crash.xmp 
&lt;?xml version="1.0"?&gt;
&lt;?xpacket begin="﻿" id="W5M0MpCehiHzreSzNTczkc9d"?&gt;
&lt;x:xmpmeta xmlns:x="adobe:ns:meta/" x:xmptk="XMP Core 4.4.0-Exiv2"&gt;
  &lt;rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"&gt;
    &lt;rdf:Description xmlns:darktable="http://darktable.sf.net/" rdf:about=""&gt;
      &lt;darktable:multi_name&gt;
        &lt;rdf:Seq&gt;
          &lt;rdf:li&gt;foo&lt;/rdf:li&gt;
          &lt;rdf:li&gt;bar&lt;/rdf:li&gt;
          &lt;rdf:li/&gt;
          &lt;rdf:li&gt;baz&lt;/rdf:li&gt;
        &lt;/rdf:Seq&gt;
      &lt;/darktable:multi_name&gt;
    &lt;/rdf:Description&gt;
  &lt;/rdf:RDF&gt;
&lt;/x:xmpmeta&gt;
&lt;?xpacket end="w"?&gt;
686 rmills@rmillsmbp:~/Downloads $ </pre>Exiv2 is reporting 3:<pre>683 rmills@rmillsmbp:~/Downloads $ exiv2 -pa crash.xmp 
Xmp.darktable.multi_name                     XmpSeq      3  foo, bar, baz
684 rmills@rmillsmbp:~/Downloads $</pre>I've changed your code a little:<pre><code class="cplusplus syntaxhl"><span class="c1">// g++ -W -Wall -g `pkg-config --cflags --libs exiv2` -o crash crash.cc</span>
<span class="cp">#include &lt;exiv2/easyaccess.hpp&gt;
#include &lt;exiv2/xmp.hpp&gt;
#include &lt;exiv2/error.hpp&gt;
#include &lt;exiv2/image.hpp&gt;
#include &lt;exiv2/exif.hpp&gt;
</span>
<span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">filename</span> <span class="o">=</span> <span class="s">"crash.xmp"</span><span class="p">;</span>
  <span class="n">Exiv2</span><span class="o">::</span><span class="n">Image</span><span class="o">::</span><span class="n">AutoPtr</span> <span class="n">image</span> <span class="o">=</span> <span class="n">Exiv2</span><span class="o">::</span><span class="n">ImageFactory</span><span class="o">::</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"unable to open file %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">filename</span><span class="p">);</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
  <span class="n">image</span><span class="o">-&gt;</span><span class="n">readMetadata</span><span class="p">();</span>

  <span class="n">Exiv2</span><span class="o">::</span><span class="n">XmpData</span>                 <span class="o">&amp;</span><span class="n">xmpData</span> <span class="o">=</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">xmpData</span><span class="p">();</span>
  <span class="n">Exiv2</span><span class="o">::</span><span class="n">XmpData</span><span class="o">::</span><span class="n">const_iterator</span>  <span class="n">pos</span>     <span class="o">=</span> <span class="n">xmpData</span><span class="p">.</span><span class="n">findKey</span><span class="p">(</span><span class="n">Exiv2</span><span class="o">::</span><span class="n">XmpKey</span><span class="p">(</span><span class="s">"Xmp.darktable.multi_name"</span><span class="p">));</span>
  <span class="k">if</span><span class="p">(</span><span class="n">pos</span> <span class="o">!=</span> <span class="n">xmpData</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"found %ld entries</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">());</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">()</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span><span class="s">" : "</span> <span class="o">&lt;&lt;</span> <span class="n">pos</span><span class="o">-&gt;</span><span class="n">toString</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"not found</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span></code></pre>When I run ./crash, it returns 3 in the Seq.<pre>689 rmills@rmillsmbp:~/Downloads $ g++ -W -Wall -g `pkg-config --cflags --libs exiv2` -o crash crash.cc
690 rmills@rmillsmbp:~/Downloads $ ./crash
found 3 entries
0 : foo
1 : bar
2 : baz
691 rmills@rmillsmbp:~/Downloads $ </pre>Can we agree on the issue here.</p>


	<p>1) There is no crash here.  Correct?<br />2) We are reporting 3 <strong><code>li</code></strong> elements in <strong><code>Seq</code></strong> and you are expecting 4.  Is that correct?</p>


	<p>I don't know anything much about XMP.  I'm a C++ build engineer.  Is there a rule in XMP that says "ignore empty Seq/li elements?"</p>


	<p>I've changed crash.xml.  First, I changed <strong><code>&lt;rdf:li/&gt;</code></strong> to <strong><code>&lt;rdf:li&gt;&lt;/rdf:li&gt;</code></strong> and that made no difference.  Then I changed it to <strong><code>&lt;rdf:li&gt;bullshit&lt;/rdf:li&gt;</code></strong>.  Good result:<pre>693 rmills@rmillsmbp:~/Downloads $ ./crash
found 4 entries
0 : foo
1 : bar
2 : bullshit
3 : baz
694 rmills@rmillsmbp:~/Downloads $ </pre>It feels to me that the XMPsdk is hiding the empty <strong><code>&lt;rdf:li&gt;&lt;rdf:li/&gt;</code></strong> tag.  What do you expect it to do?</p>


	<p>Curiously, if I change "bullshit" in crash.xml to " " (a single space), the count == 4 and element 3 is a space.  When I change "bullshit" in crash.xml to the empty string, the count returns to 3.  There's something determined to hide empty list elements.</p></div>
  
  </div>
  <div class="message reply" id="message-2668">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2668#message-2668">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="26 Aug 2016 17:02" href="/projects/exiv2/activity?from=2016-08-26">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>There's a discussion here about something similar:  <a class="external" href="http://u88.n24.queensu.ca/exiftool/forum/index.php?topic=5237.msg25351#msg25351">http://u88.n24.queensu.ca/exiftool/forum/index.php?topic=5237.msg25351#msg25351</a></p>


	<p>Phil (Harvey) says:</p>


<blockquote>

	<p>The empty lists were removed, but no actual metadata was lost.</p>


	<p>Darktable should not be writing empty lists.  It is a waste of space.</p>


</blockquote></div>
  
  </div>
  <div class="message reply" id="message-2669">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2669#message-2669">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="26 Aug 2016 17:34" href="/projects/exiv2/activity?from=2016-08-26">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>More amazing discoveries after attempting to understand Adobe's and W3C's documents about XMP and RDF. <pre>&lt;?xpacket begin="﻿" id="W5M0MpCehiHzreSzNTczkc9d"?&gt;
&lt;x:xmpmeta xmlns:x="adobe:ns:meta/" x:xmptk="XMP Core 4.4.0-Exiv2"&gt;
 &lt;rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"&gt;
  &lt;rdf:Description rdf:about="" xmlns:darktable="http://darktable.sf.net/" &gt;
   &lt;darktable:multi_name&gt;
    &lt;rdf:Seq&gt;
     &lt;rdf:li&gt;foo&lt;/rdf:li&gt;
     &lt;rdf:li&gt;bar&lt;/rdf:li&gt;
     &lt;rdf:li rdf:resource=""/&gt;
     &lt;rdf:li&gt;baz&lt;/rdf:li&gt;
    &lt;/rdf:Seq&gt;
   &lt;/darktable:multi_name&gt;
  &lt;/rdf:Description&gt;
 &lt;/rdf:RDF&gt;
&lt;/x:xmpmeta&gt;
&lt;?xpacket end="w"?&gt;</pre>Run this through ./crash: <pre>713 rmills@rmillsmbp:~/Downloads $ ./crash
found 3 entries
0 : foo
1 : bar
2 : baz
714 rmills@rmillsmbp:~/Downloads $ </pre>Now change <strong><code>resource=""</code></strong> to <strong><code>resource="911"</code></strong> : <pre>./crash
found 4 entries
0 : foo
1 : bar
2 : 911
3 : baz
715 rmills@rmillsmbp:~/Downloads $ </pre>There's code inside the xmpsdk (which came from Adobe) which does not like empty list elements in a Seq.</p></div>
  
  </div>
  <div class="message reply" id="message-2670">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2670#message-2670">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/3663">Tobias E.</a> <a title="27 Aug 2016 09:20" href="/projects/exiv2/activity?from=2016-08-27">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>Hello Robin,</p>


	<p>thanks for looking into this. I am still on 0.25 which does crash. But as I said, that's only a side issue. The real thing is, as you correctly understood, the missing empty element. I haven't tried compiling libexiv2 myself, but I can give it a try to see how that works.</p></div>
  
  </div>
  <div class="message reply" id="message-2671">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2671#message-2671">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="27 Aug 2016 11:58" href="/projects/exiv2/activity?from=2016-08-27">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>I did some debugging on this last night.  There is no doubt in my mind that XMPsdk removes empty list elements.  However, I don't know why.  I'm not an expert in metadata.</p>


	<p>I've searched the Adobe/XMP specs, the W3C/RDF spec and the comments in the code in xmpsdk.  I haven't found anything to say that an empty <strong><code> li </code></strong> element is legal or illegal.  For sure, it seems an odd thing to put into XMP. There are three very similar RDF containers.  Bag, Seq, and Alt.  For a 'Bag', you should think of a mathematical set of entities.  A 'Seq' is an ordered set of entities.  An 'Alt' is an unordered set from which you are expected to choose one.  So, it's kind of odd to say "I want an empty element" in a 'Seq'.  It's like saying "Waiter!  I want a black hole in my soup!".</p>


	<p>I've also looked at your file crash.xmp with the latest version of Adobe's XMPsdk (released July 2016).<pre>553 rmills@rmillsmbp:~/gnu/xmpsdk/XMP-Toolkit-SDK-CC201607 $ samples/target/macintosh/intel_64/Release/ReadingXMP ~/Downloads/crash.xmp 
No smart handler available for /Users/rmills/Downloads/crash.xmp
Trying packet scanning.

/Users/rmills/Downloads/crash.xmp is opened successfully
dc:title in English = 
dc:title in French = 

XMP dumped to XMPDump.txt
554 rmills@rmillsmbp:~/gnu/xmpsdk/XMP-Toolkit-SDK-CC201607 $ cat XMPDump.txt

Dumping XMPMeta object ""  (0x0)

   darktable:  http://darktable.sf.net/  (0x80000000 : schema)
      darktable:multi_name  (0x600 : isOrdered isArray)
         [1] = "foo" 
         [2] = "bar" 
         [3] = "baz" 
555 rmills@rmillsmbp:~/gnu/xmpsdk/XMP-Toolkit-SDK-CC201607 $ </pre>100% proof that the Adobe XMPsdk quietly rejects empty list elements.</p>


	<p>I'd like to know more about why this is causing you to be unhappy.  Why is DarkTable generating this XMP?  Have you spoken to our friends at DT about this?</p></div>
  
  </div>
  <div class="message reply" id="message-2672">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2672#message-2672">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="27 Aug 2016 13:34" href="/projects/exiv2/activity?from=2016-08-27">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>I've raised a topic on the Adobe XMPsdk Forum about this matter.  <a class="external" href="https://forums.adobe.com/message/8968850#8968850">https://forums.adobe.com/message/8968850#8968850</a></p></div>
  
  </div>
  <div class="message reply" id="message-2673">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2673#message-2673">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/4035">Alan Pater</a> <a title="27 Aug 2016 13:41" href="/projects/exiv2/activity?from=2016-08-27">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>Would updating the XMPSDK help with this issue?</p>


	<p><a class="external" href="http://dev.exiv2.org/issues/941">http://dev.exiv2.org/issues/941</a></p></div>
  
  </div>
  <div class="message reply" id="message-2674">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2674#message-2674">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="27 Aug 2016 13:55" href="/projects/exiv2/activity?from=2016-08-27">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>Regrettably not.  As you can see above, I built the latest XMPsdk and ran the sample application ReadingXMP on Tobias' code.  The <strong><code>&lt;rdf:li/&gt;</code></strong> tag was silently ignored.</p>


	<p>I think we'll have to get input from an XMP "language lawyer" at Adobe to say why this is ignored.  Equally, we need to hear from DarkTable about the meaning of this code.  I'm not sure the XMPsdk (and therefore libexiv2) can create that XMP.  So, lots of strange things about this.  I believe exiv2 is blameless in this situation.</p>


	<p>Incidentally, I have not been able to reproduce the crash that is alleged with v0.25.  However, Tobias has been explicit in asking us to focus on the <em><strong>empty element</strong></em>.  So the crash is of no importance.</p>


	<p>BTW, I downloaded and built the latest Adobe XMPsdk about a week ago.  I have started looking at that in anticipation of integrating it into Exiv2 in v0.27.</p></div>
  
  </div>
  <div class="message reply" id="message-2675">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2675#message-2675">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/3663">Tobias E.</a> <a title="27 Aug 2016 15:16" href="/projects/exiv2/activity?from=2016-08-27">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>The XMP files with the empty elements were created by libexiv2. In my sample I just deleted some unrelated things to make it more obvious what is going on. To explain why darktable relies on those empty elements I have to show a more complete example. I still removed some unrelated elements, but the important parts are there:</p>


<pre>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;x:xmpmeta xmlns:x="adobe:ns:meta/" x:xmptk="XMP Core 4.4.0-Exiv2"&gt;
 &lt;rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"&gt;
  &lt;rdf:Description rdf:about="" 
    xmlns:darktable="http://darktable.sf.net/"&gt;
   &lt;darktable:history_operation&gt;
    &lt;rdf:Seq&gt;
     &lt;rdf:li&gt;sharpen&lt;/rdf:li&gt;
     &lt;rdf:li&gt;flip&lt;/rdf:li&gt;
     &lt;rdf:li&gt;basecurve&lt;/rdf:li&gt;
     &lt;rdf:li&gt;tonecurve&lt;/rdf:li&gt;
     &lt;rdf:li&gt;tonecurve&lt;/rdf:li&gt;
     &lt;rdf:li&gt;tonecurve&lt;/rdf:li&gt;
    &lt;/rdf:Seq&gt;
   &lt;/darktable:history_operation&gt;
   &lt;darktable:history_params&gt;
    &lt;rdf:Seq&gt;
     &lt;rdf:li&gt;000000400000003f0000003f&lt;/rdf:li&gt;
     &lt;rdf:li&gt;ffffffff&lt;/rdf:li&gt;
     &lt;rdf:li&gt;gz09eJxjYIAAM6vnNnqyn22E9n235b6aa3cy6rVdRaK9/Y970fYf95bbMzA0QPEoGEqADYnNhEUeAHH1EJo=&lt;/rdf:li&gt;
     &lt;rdf:li&gt;gz06eJxjYICAcvFa669/NltdSOewY77w1NY+e5ndCreddgESofZT1qXYMzA0QPHAAK7ri21BeNbMmXYgDBQCucXe2NgYjOVbs8F4oNw5WN3HBsTsUIwMGJFoAHvBKzs=&lt;/rdf:li&gt;
     &lt;rdf:li&gt;gz12eJxjYIAA6/BO2x0r620YGBrsIXjQAXsIHnUfKYAZCTMhYUaoPIgGALM+CPw=&lt;/rdf:li&gt;
     &lt;rdf:li&gt;gz13eJxjYICAe7b29vrVpfYMDA1QPOiAPQSPuo8UwIyEmZAwI1QeRAMAvvwIfw==&lt;/rdf:li&gt;
    &lt;/rdf:Seq&gt;
   &lt;/darktable:history_params&gt;
   &lt;darktable:multi_name&gt;
    &lt;rdf:Seq&gt;
     &lt;rdf:li/&gt;
     &lt;rdf:li/&gt;
     &lt;rdf:li/&gt;
     &lt;rdf:li/&gt;
     &lt;rdf:li&gt;1&lt;/rdf:li&gt;
     &lt;rdf:li&gt;2&lt;/rdf:li&gt;
    &lt;/rdf:Seq&gt;
   &lt;/darktable:multi_name&gt;
  &lt;/rdf:Description&gt;
 &lt;/rdf:RDF&gt;
&lt;/x:xmpmeta&gt;
</pre>

	<p>In <code>darktable:history_operation</code> there is an ordered list of image editing operations. In <code>darktable:history_params</code> there are the settings for those, and <code>darktable:multi_name</code> holds the instance names for those to make the multiple applications of the tonecurve distinguishable. If the empty elements are kept darktable can assign an empty name to the first 4 operations and "1" and "2" to the last two. When empty elements are skipped however, the non-empty names are applied to <code>sharpen</code> and <code>flip</code> which is wrong.</p>


	<p>Of course that layout isn't ideal and some day™ the whole schema should be redesigned to have one set of settings per operation which includes everything, but as there are millions of those XMP files out in the wild it would be great if reading them back as intended was somehow possible.</p></div>
  
  </div>
  <div class="message reply" id="message-2676">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2676#message-2676">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="27 Aug 2016 16:10" href="/projects/exiv2/activity?from=2016-08-27">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>Thanks for the clarification.  I'll investigate how to create such a pattern of XMP with libexiv2.  I hope somebody on the Adobe Forum provides some insight concerning this matter as this behaviour of XMPsdk seems quite intentional.</p>


	<p>Here's a proposal about how to fix this.  We can read/rewrite the XMP using expat to convert the empty tags from <strong><code>&lt;rdf:li/&gt;</code></strong> to <strong><code>&lt;rdf:li&gt;X&lt;/rdf:li&gt;</code></strong>.  The content of <em><strong>X</strong></em> is any string except the empty string.  It could be a <em><strong><code>(space)</code></strong></em> , <em><strong><code>0</code></strong></em> or any string such as <em><strong><code>empty</code></strong></em>.  So the following transform would occur:<pre>   FROM                    -&gt;   TO
   &lt;darktable:multi_name&gt;       &lt;darktable:multi_name&gt;                                               
    &lt;rdf:Seq&gt;                    &lt;rdf:Seq&gt;                 
     &lt;rdf:li/&gt;                    &lt;rdf:li&gt;empty&lt;/rdf:li&gt;                                     
     &lt;rdf:li/&gt;                    &lt;rdf:li&gt;empty&lt;/rdf:li&gt;                
     &lt;rdf:li/&gt;                    &lt;rdf:li&gt;empty&lt;/rdf:li&gt;                
     &lt;rdf:li/&gt;                    &lt;rdf:li&gt;empty&lt;/rdf:li&gt;                
     &lt;rdf:li&gt;1&lt;/rdf:li&gt;           &lt;rdf:li&gt;1&lt;/rdf:li&gt;                         
     &lt;rdf:li&gt;2&lt;/rdf:li&gt;           &lt;rdf:li&gt;2&lt;/rdf:li&gt;                         
    &lt;/rdf:Seq&gt;                   &lt;/rdf:Seq&gt;</pre>The code to fix this could reside in DT.  DT can extract the "raw" XMP using image->printStructure(), modify it (with expat) and <em>if there were changes</em> write it back using image->setXmpPacket().  Or we could add a new API to libexiv2 such as image->rewriteEmptySeqLiElements("empty").</p>


	<p>Let's talk some more about this.  For sure, I'm confident that we can achieve your goal to respect the millions of existing DT files with this troublesome XMP.  We'll raise a Redmine Feature Request on libexiv2 when we have agreed on the appropriate remedy.</p></div>
  
  </div>
  <div class="message reply" id="message-2677">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2677#message-2677">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/3663">Tobias E.</a> <a title="28 Aug 2016 12:50" href="/projects/exiv2/activity?from=2016-08-28">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>Thank you, that helped a lot. Using <code>image->xmpPacket()</code> and <code>image->setXmpPacket()</code> I can manually fix the XML data just fine. No need for any extra libexiv2 API I guess.</p>


	<p>However, this leads me to a second question: In order to avoid problems like this in the future I would like to change the data layout to something like this:</p>


<pre>
&lt;darktable:history&gt;
  &lt;rdf:Seq&gt;
    &lt;rdf:li&gt;
      &lt;darktable:modversion&gt;&lt;/darktable:modversion&gt;
      &lt;darktable:enabled&gt;&lt;/darktable:enabled&gt;
      &lt;darktable:operation&gt;&lt;/darktable:operation&gt;
      &lt;darktable:params&gt;&lt;/darktable:params&gt;
      &lt;darktable:blendop_params&gt;&lt;/darktable:blendop_params&gt;
      &lt;darktable:blendop_version&gt;&lt;/darktable:blendop_version&gt;
      &lt;darktable:multi_priority&gt;&lt;/darktable:multi_priority&gt;
        &lt;darktable:multi_name&gt;&lt;/darktable:multi_name&gt;
    &lt;/rdf:li&gt;
  &lt;rdf:Seq&gt;
&lt;/darktable:history
</pre>

	<p>Following the examples from the API docs I am able to put everything into attributes of the <code>&lt;rdf:li&gt;</code> using code like this</p>


<pre>
  Exiv2::XmpProperties::registerNs("http://darktable.sf.net/", "darktable");

  Exiv2::XmpData xmpData;

  Exiv2::XmpTextValue tv("");

  tv.setXmpArrayType(Exiv2::XmpValue::xaSeq);
  xmpData.add(Exiv2::XmpKey("Xmp.darktable.history"), &#38;tv); // Set the array type.
  tv.setXmpArrayType(Exiv2::XmpValue::xaNone);

  tv.read("flip");
  xmpData.add(Exiv2::XmpKey("Xmp.darktable.history[1]/darktable:operation"), &#38;tv);

  tv.read("1");
  xmpData.add(Exiv2::XmpKey("Xmp.darktable.history[1]/darktable:priority"), &#38;tv);

  tv.read("spot");
  xmpData.add(Exiv2::XmpKey("Xmp.darktable.history[2]/darktable:operation"), &#38;tv);

  tv.read("2");
  xmpData.add(Exiv2::XmpKey("Xmp.darktable.history[2]/darktable:priority"), &#38;tv);

</pre>

	<p>Is there any way to get the format I want, i.e., having proper XML tags in the <code>&lt;rdf:li&gt;</code>?</p>


	<p>Tobias</p></div>
  
  </div>
  <div class="message reply" id="message-2678">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2678#message-2678">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="28 Aug 2016 13:29" href="/projects/exiv2/activity?from=2016-08-28">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>I'm a little lost.  Can we divide your question into parts:</p>


	<p>1 What XML do you want?<br />2 Is it legal XMP?<br />3 How do you get the exiv2 API to build it?</p>


	<p>Example:  <strong>DT.xmp</strong>:<pre>617 rmills@rmillsmbp:~/gnu/exiv2/trunk $ xmllint --pretty 1 DT.xmp 
&lt;?xml version="1.0"?&gt;
&lt;?xpacket begin="﻿" id="W5M0MpCehiHzreSzNTczkc9d"?&gt;
&lt;x:xmpmeta xmlns:x="adobe:ns:meta/" x:xmptk="XMP Core 4.4.0-Exiv2"&gt;
  &lt;rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"&gt;
    &lt;rdf:Description xmlns:darktable="http://darktable.sf.net/" rdf:about=""&gt;
      &lt;darktable:multi_name&gt;
        &lt;rdf:Seq&gt;
          &lt;rdf:li&gt;
            &lt;rdf:Bag&gt;
              &lt;darktable:modversion&gt;xxx&lt;/darktable:modversion&gt;
              &lt;darktable:enabled&gt;yyy&lt;/darktable:enabled&gt;
            &lt;/rdf:Bag&gt;
          &lt;/rdf:li&gt;
        &lt;/rdf:Seq&gt;
      &lt;/darktable:multi_name&gt;
    &lt;/rdf:Description&gt;
  &lt;/rdf:RDF&gt;
&lt;/x:xmpmeta&gt;
&lt;?xpacket end="w"?&gt;
618 rmills@rmillsmbp:~/gnu/exiv2/trunk $ xmllint --pretty 1 DT.xmp  | wc
      19      30     659
619 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pa DT.xmp 
Error: XMP Toolkit error 102: Named children only allowed for schemas and structs
Warning: Failed to decode XMP metadata.
620 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>When you have a pattern of XML/XMP that is accepted by exiv2/xmpsdk,  play with the exiv2 executable to figure out how to generate it.</p>


	<p>However before we discuss the API, can you define the XMP/XML please.</p></div>
  
  </div>
  <div class="message reply" id="message-2679">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2679#message-2679">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/3663">Tobias E.</a> <a title="28 Aug 2016 15:00" href="/projects/exiv2/activity?from=2016-08-28">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>Using exiv2 to have a look at the actual Xmp path to be used was a good hint, it seems that <code>Xmp.darktable.history[1]/?darktable:mod version</code> does the trick. However, the final XML is quite bloated so I guess I will just keep everything in attributes.</p></div>
  
  </div>
  <div class="message reply" id="message-2681">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2681#message-2681">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="29 Aug 2016 04:29" href="/projects/exiv2/activity?from=2016-08-29">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>Like this? <pre>629 rmills@rmillsmbp:~/gnu/exiv2/trunk $ cat DT.xmp 
&lt;?xpacket begin="﻿" id="W5M0MpCehiHzreSzNTczkc9d"?&gt;
&lt;x:xmpmeta xmlns:x="adobe:ns:meta/" x:xmptk="XMP Core 4.4.0-Exiv2"&gt;
 &lt;rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"&gt;
  &lt;rdf:Description rdf:about="" xmlns:darktable="http://darktable.sf.net/" &gt;
   &lt;darktable:multi_name&gt;
    &lt;rdf:Seq&gt;
     &lt;rdf:li rdf:resource="1" darktable:modversion="abc" darktable:parameters="ABC"/&gt;
     &lt;rdf:li rdf:resource="2" darktable:modversion="xyz" darktable:parameters="XYZ"/&gt;
    &lt;/rdf:Seq&gt;
   &lt;/darktable:multi_name&gt;
  &lt;/rdf:Description&gt;
 &lt;/rdf:RDF&gt;
&lt;/x:xmpmeta&gt;
&lt;?xpacket end="w"?&gt;630 rmills@rmillsmbp:~/gnu/exiv2/trunk $ exiv2 -pa DT.xmp 
Xmp.darktable.multi_name                     XmpText     0  type="Seq" 
Xmp.darktable.multi_name[1]                  XmpText     1  1
Xmp.darktable.multi_name[1]/?darktable:modversion XmpText     3  abc
Xmp.darktable.multi_name[1]/?darktable:parameters XmpText     3  ABC
Xmp.darktable.multi_name[2]                  XmpText     1  2
Xmp.darktable.multi_name[2]/?darktable:modversion XmpText     3  xyz
Xmp.darktable.multi_name[2]/?darktable:parameters XmpText     3  XYZ
631 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre></p></div>
  
  </div>
  <div class="message reply" id="message-2683">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2683#message-2683">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/3663">Tobias E.</a> <a title="29 Aug 2016 09:29" href="/projects/exiv2/activity?from=2016-08-29">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>Yes, like that.</p></div>
  
  </div>
  <div class="message reply" id="message-2684">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2684#message-2684">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="29 Aug 2016 09:33" href="/projects/exiv2/activity?from=2016-08-29">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>Good.  I think this has a happy ending with no action required by Exiv2.  Do you agree?</p></div>
  
  </div>
  <div class="message reply" id="message-2685">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2685#message-2685">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/3663">Tobias E.</a> <a title="29 Aug 2016 10:35" href="/projects/exiv2/activity?from=2016-08-29">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>Indeed. Thank you for your help!</p></div>
  
  </div>
  <div class="message reply" id="message-2698">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2698#message-2698">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/3663">Tobias E.</a> <a title="03 Sep 2016 08:30" href="/projects/exiv2/activity?from=2016-09-03">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>Sorry to bother you again. I didn't want to start a new topic for this follow up question.</p>


	<p>I am now writing XMP files like this:</p>


<pre>
&lt;x:xmpmeta xmlns:x="adobe:ns:meta/" x:xmptk="XMP Core 4.4.0-Exiv2"&gt;
 &lt;rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"&gt;
  &lt;rdf:Description rdf:about="" 
    xmlns:darktable="http://darktable.sf.net/" 
   darktable:xmp_version="2"&gt;
   &lt;darktable:history&gt;
    &lt;rdf:Seq&gt;
     &lt;rdf:li&gt;
      &lt;rdf:Description
       darktable:operation="sharpen" 
       darktable:enabled="1"&gt;
      &lt;darktable:settings&gt;
       &lt;rdf:Seq&gt;
        &lt;rdf:li
         darktable:name="width" 
         darktable:type="int" 
         darktable:value="23"/&gt;
        &lt;rdf:li
         darktable:name="height" 
         darktable:type="int" 
         darktable:value="42"/&gt;
       &lt;/rdf:Seq&gt;
      &lt;/darktable:settings&gt;
      &lt;/rdf:Description&gt;
     &lt;/rdf:li&gt;
     &lt;rdf:li
      darktable:operation="flip" 
      darktable:enabled="1"/&gt;
     &lt;rdf:li
      darktable:operation="tonecurve" 
      darktable:enabled="1"/&gt;
    &lt;/rdf:Seq&gt;
   &lt;/darktable:history&gt;
  &lt;/rdf:Description&gt;
 &lt;/rdf:RDF&gt;
&lt;/x:xmpmeta&gt;
</pre>

	<p>Using libexiv2 I can get an iterator to <code>Xmp.darktable.history</code> and iterate that, however since that isn't a simple array I get XmpText values only, containing everything in that subtree:</p>


<pre>
Xmp.darktable.history = type="Seq" 
Xmp.darktable.history[1] = type="Struct" 
Xmp.darktable.history[1]/darktable:operation = sharpen
Xmp.darktable.history[1]/darktable:enabled = 1
Xmp.darktable.history[1]/darktable:settings = type="Seq" 
Xmp.darktable.history[1]/darktable:settings[1] = type="Struct" 
Xmp.darktable.history[1]/darktable:settings[1]/darktable:name = width
Xmp.darktable.history[1]/darktable:settings[1]/darktable:type = int
Xmp.darktable.history[1]/darktable:settings[1]/darktable:value = 23
Xmp.darktable.history[1]/darktable:settings[2] = type="Struct" 
Xmp.darktable.history[1]/darktable:settings[2]/darktable:name = height
Xmp.darktable.history[1]/darktable:settings[2]/darktable:type = int
Xmp.darktable.history[1]/darktable:settings[2]/darktable:value = 42
Xmp.darktable.history[2] = type="Struct" 
Xmp.darktable.history[2]/darktable:operation = flip
Xmp.darktable.history[2]/darktable:enabled = 1
Xmp.darktable.history[3] = type="Struct" 
Xmp.darktable.history[3]/darktable:operation = tonecurve
Xmp.darktable.history[3]/darktable:enabled = 1
</pre>

	<p>Is there any way to access that in a more structured way, without the type attributes and as arrays per level? Or am I required to do string matching against the keys and parse that myself?</p></div>
  
  </div>
  <div class="message reply" id="message-2699">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2699#message-2699">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="03 Sep 2016 09:01" href="/projects/exiv2/activity?from=2016-09-03">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>You're not bothering me.  I'm always happy to help you and all our friends at Dark Table (and GIMP, digiKam and all users of Exiv2 technology).</p>


	<p>I'm not sure I've really understood your question, however I think it's involved with the rather awkward syntax for querying attributes.  I attach the file Tobias.jpg which I made from test/data/Reagan.jpg and inserting your XMP with the v0.26 command <em><strong><code>$ exiv2 -iXX Tobias.jpg </code></strong></em> which reads Tobias.xmp and replaces the XMP.</p>


	<p>Run sample/exiv2json.cpp on Tobias.jpg and the XMP will be converted to JSON which you can read with your favourite JSON parser.<pre>579 rmills@rmillsmbp:~/gnu/exiv2/trunk $ bin/exiv2json -x Tobias.jpg  
{
    "Xmp": {
        "darktable": {
            "xmp_version": "2",
            "history": [
                {
                    "darktable": {
                        "operation": "sharpen",
                        "enabled": "1",
                        "settings": [
                            {
                                "darktable": {
                                    "name": "width",
                                    "type": "int",
                                    "value": "23" 
                                }
                            },
                            {
                                "darktable": {
                                    "name": "height",
                                    "type": "int",
                                    "value": "42" 
                                }
                            }
                        ]
                    }
                },
                {
                    "darktable": {
                        "operation": "flip",
                        "enabled": "1" 
                    }
                },
                {
                    "darktable": {
                        "operation": "tonecurve",
                        "enabled": "1" 
                    }
                }
            ]
        },
        "xmlns": {
            "darktable": "http:\/\/darktable.sf.net\/" 
        }
    }
}
580 rmills@rmillsmbp:~/gnu/exiv2/trunk $</pre>samples/exiv2json.cpp is sample code and not part of the library.  You are welcome to copy samples/exiv2json.cpp (and Jzon.cpp and Jzon.h) into DT if you find that code useful.</p>


	<p>Another approach is to extract the XMP with <em><strong><code>image-&gt;printStructure()</code></strong> or <strong><code>image-&gt;xmpPacket()</code></strong></em> and manipulate it with an XML library such as expat or Sax.</p>


	<p>If you don't have exiv2json available, you can build it from source, or download it for your platform from our buildserver:  <a class="external" href="http://exiv2.dyndns.org:8080/userContent/builds/Categorized/Latest/">http://exiv2.dyndns.org:8080/userContent/builds/Categorized/Latest/</a></p></div>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1048">Tobias.jpg</a>    <span class="size">(45.8 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1048/Tobias.jpg">Tobias.jpg</a>  </td>
  <td></td>
  <td>
  </td>
  <td>
  </td>
</tr>
</table>
</div>

  </div>
  <div class="message reply" id="message-2700">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1729?r=2700#message-2700">RE: Empty elements in a rdf:Seq</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="03 Sep 2016 09:40" href="/projects/exiv2/activity?from=2016-09-03">about 5 years</a> ago
  </h4>
  <div class="wiki"><p>I should have pointed out another couple of things:</p>


	<p>1 samples/exiv2json.cpp is a deep recursive parser of the Exiv2/XMP Syntax.  It rebuilds the data into a tree of JSON objects and arrays.  The code is non-trivial.<br />2 you can use your favourite JSON parser to decode the JSON or you can use the api in Jzon.h/Jzon.cpp to navigate the tree.</p>


	<p>//// I'm a little bored and have wondered "Is there a tool like XSLT or SQL for JSON?"  Yes.  jq (Json Query, I think).  <pre>706 rmills@rmillsmbp:~/gnu/exiv2/trunk $ jq ".Xmp.darktable.history|length" Tobias.json
3
707 rmills@rmillsmbp:~/gnu/exiv2/trunk $ jq ".Xmp.darktable.history[2]" Tobias.json
{
  "darktable": {
    "operation": "tonecurve",
    "enabled": "1" 
  }
}
708 rmills@rmillsmbp:~/gnu/exiv2/trunk $ for i in $(seq 0 1 $(( $(jq ".Xmp.darktable.history|length" Tobias.json) -1)));do echo operation: $(jq ".Xmp.darktable.history[$i].darktable.operation" Tobias.json); done
operation: "sharpen" 
operation: "flip" 
operation: "tonecurve" 
709 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre>You can even read the XMP over the internet using Exiv2/webready and not bother with having the file Tobias.json<pre>722 rmills@rmillsmbp:~/gnu/exiv2/trunk $ json=$(bin/exiv2json -x http://dev.exiv2.org/attachments/download/1048/Tobias.jpg)
723 rmills@rmillsmbp:~/gnu/exiv2/trunk $ for i in $(seq 0 1 $(( $(echo $json|jq ".Xmp.darktable.history|length") -1)));do echo operation: $(echo $json|jq ".Xmp.darktable.history[$i].darktable.operation"); done
operation: "sharpen" 
operation: "flip" 
operation: "tonecurve" 
724 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre></p></div>
  
  </div>
</div>
<span class="pagination"><ul class="pages"></ul><span><span class="items">(1-24/24)</span> </span></span>



        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
