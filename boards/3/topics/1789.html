<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Dateikonflikt Exiv2 Library unter Windows - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="a2E0vOQDGAdspQmsiHJQbDOqofvfS/Bln5y/N9ENbM6JLJ9TlnnUBznBFqA3pVxfDDj1gi6oUd9ivC+/kjSLoQ==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
</head>
<body class="project-exiv2 has-main-menu controller-messages action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="messages" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="messages" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=boards" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=boards">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards selected" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="nosidebar">
    <div id="sidebar">
        
        
    </div>

    <div id="content">
        
        <p class="breadcrumb"><a href="/projects/exiv2/boards">Forums</a> » <a href="/projects/exiv2/boards/3">Forum</a> » </p>

<div class="contextual">
    
    
    
    
</div>

<h2>Dateikonflikt Exiv2 Library unter Windows</h2>

<div class="message">
<p><span class="author">Added by <a class="user active" href="/users/4185">LaserSoft Imaging</a> <a title="29 Jul 2014 05:41" href="/projects/exiv2/activity?from=2014-07-29">over 7 years</a> ago</span></p>
<div class="wiki">
<p>Sehr geehrter Herr Huggel, liebe Mitleser,</p>


	<p>if it is necessary, we could also translate our question to english.</p>


	<p>Bei der Verwendung der Exiv2 Bibliothek sind wir vereinzelt auf Dateikonflikte unter Windows gestoßen. Es scheint als würde beim Schreiben von Metadaten in ein Image-Objekt die Datei einen temporären Namen "Dateiname + Prozess ID" erhalten. Hier ein Beispiel, wie wir die Metadaten derzeit schreiben:</p>


<pre>
Exiv2::XmpData exiv2IptcData;
Exiv2::Image::AutoPtr image = Exiv2::ImageFactory::open(filename.toStdString());
// ...fill exiv2IptcData...
image-&gt;readMetadata(); // Read meta data
// Get exif- and xmp-data and set it again to the image
Exiv2::ExifData exiv2ExifData = image-&gt;exifData();
image-&gt;setExifData(exiv2ExifData);
Exiv2::XmpData exiv2XmpData = image-&gt;xmpData();
image-&gt;setXmpData(exiv2XmpData);
// Set the freshly created IPTC data
image-&gt;setIptcData(exiv2IptcData);
// Write the meta data to the file.
image-&gt;writeMetadata();
</pre>

	<p>Abhängig von der jeweiligen Dateigröße erscheint im Windows Datei-Explorer die temporäre Datei mit der zusätzlich Endung, die die Prozess ID unserer Programmsitzung darstellt. Interagiert man mit dieser, also markiert sie beispielsweise mit der Maus, erzwingt man einen Fehler mit dem Errorcode 17:</p>


<pre>
catch(Exiv2::AnyError&#38; error)
{
    int errCode(error.code());
    // Write error message to log-file:
    sfDebug("CsfIptc::applyIptcToFile() Exiv2 Error " + QString::number(errCode) + " while storing IPTC data: " + QString(error.what()));
}
</pre>

	<p>...ergibt die Fehlermeldung:<br /><code>CsfIptc::applyIptcToFile() Exiv2 Error 17 while storing IPTC data: C:/Users/tester/Pictures/iptcTest/iptc2/OF120_0516.tif1884: Failed to rename file to C:/Users/tester/Pictures/iptcTest/iptc2/OF120_0516.tif: File exists (errno = 17)</code></p>


	<p>Unsere Frage ist, ob es bestimmte Gründe gibt, warum die Datei von der Exiv2-Bibliothek zwischenzeitlich umbenannt wird, beziehungsweise ob man diese Umbenennung auch komplett verhindern kann?</p>
</div>

</div>
<br />

<div id="replies">
<h3 class="comments icon icon-comments">Replies (7)</h3>
  <div class="message reply" id="message-1795">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1789?r=1795#message-1795">RE: Dateikonflikt Exiv2 Library unter Windows</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="06 Aug 2014 01:25" href="/projects/exiv2/activity?from=2014-08-06">over 7 years</a> ago
  </h4>
  <div class="wiki"><p>I've been on vacation and left this for Andreas to handle as he's a native German speaker.  May I ask you to translate this to English and I will reply.</p></div>
  
  </div>
  <div class="message reply" id="message-1796">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1789?r=1796#message-1796">RE: Dateikonflikt Exiv2 Library unter Windows</a>
    -
    Added by <a class="user active" href="/users/4185">LaserSoft Imaging</a> <a title="08 Aug 2014 01:39" href="/projects/exiv2/activity?from=2014-08-08">over 7 years</a> ago
  </h4>
  <div class="wiki"><p>Yes, of course. We met the behavior that obviously exiv2-library renames the file it is working with to a temporary name. This name should be its original name extended by the process-id of the application which is using exiv2-library. The first code fragment above shows how we use the exiv2-library for writing the meta-data to a file.<br />Depending on the size of the (temporary-named) file and a possible user-interaction with it while exiv2-library tries to write the meta-data, it appears that the library throws error no 17. It tells that while storing the IPTC data the renaming failed.<br />We are now using some kind of a work-around which renames the file by our application since we at least know the temporary name and the target name.<br />We ask ourself if this renaming to "name + process-id" is even necessary or if it could be prevented somehow? By the way, we only experienced this behavior on Windows so far.</p></div>
  
  </div>
  <div class="message reply" id="message-1797">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1789?r=1797#message-1797">RE: Dateikonflikt Exiv2 Library unter Windows</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="08 Aug 2014 03:47" href="/projects/exiv2/activity?from=2014-08-08">over 7 years</a> ago
  </h4>
  <div class="wiki"><p>Thanks.  Before I asked you to translate, I used Google Translate.  Now I know what you're talking about!  Human translators don't need to worry (yet) about machines taking over their job!</p>


	<p>I suspect that 'name+process-id' has been used for process safety.  Two applications can operate on the same file with some independence.  However without a mutex, or some other system wide exclusion lock, the rename operation is vulnerable.  This code does not seems to be thread safe.  Two threads could easily collide.</p>


	<p>Windows "rename" is different from Unix "mv" and fails when the target already exists.  There's a comment in the code concerning this at src/basicio.cpp+710.</p>


<pre><code class="c syntaxhl">            <span class="c1">// MSVCRT rename that does not overwrite existing files</span>
<span class="cp">#ifdef EXV_UNICODE_PATH
</span>            <span class="k">if</span> <span class="p">(</span><span class="n">p_</span><span class="o">-&gt;</span><span class="n">wpMode_</span> <span class="o">==</span> <span class="n">Impl</span><span class="o">::</span><span class="n">wpUnicode</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">fileExists</span><span class="p">(</span><span class="n">wpf</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">::</span><span class="n">_wremove</span><span class="p">(</span><span class="n">wpf</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">throw</span> <span class="n">WError</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">wpf</span><span class="p">,</span> <span class="n">strError</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span> <span class="s">"::_wremove"</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">::</span><span class="n">_wrename</span><span class="p">(</span><span class="n">fileIo</span><span class="o">-&gt;</span><span class="n">wpath</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">wpf</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">throw</span> <span class="n">WError</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="n">fileIo</span><span class="o">-&gt;</span><span class="n">wpath</span><span class="p">(),</span> <span class="n">wpf</span><span class="p">,</span> <span class="n">strError</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
                <span class="p">}</span>
                <span class="o">::</span><span class="n">_wremove</span><span class="p">(</span><span class="n">fileIo</span><span class="o">-&gt;</span><span class="n">wpath</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
                <span class="c1">// Check permissions of new file</span>
                <span class="k">struct</span> <span class="n">_stat</span> <span class="n">buf2</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">statOk</span> <span class="o">&amp;&amp;</span> <span class="o">::</span><span class="n">_wstat</span><span class="p">(</span><span class="n">wpf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf2</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">statOk</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#ifndef SUPPRESS_WARNINGS
</span>                    <span class="n">EXV_WARNING</span> <span class="o">&lt;&lt;</span> <span class="n">Error</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">wpf</span><span class="p">,</span> <span class="n">strError</span><span class="p">(),</span> <span class="s">"::_wstat"</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
<span class="cp">#endif
</span>                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">statOk</span> <span class="o">&amp;&amp;</span> <span class="n">origStMode</span> <span class="o">!=</span> <span class="n">buf2</span><span class="p">.</span><span class="n">st_mode</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// Set original file permissions</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">::</span><span class="n">_wchmod</span><span class="p">(</span><span class="n">wpf</span><span class="p">,</span> <span class="n">origStMode</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef SUPPRESS_WARNINGS
</span>                        <span class="n">EXV_WARNING</span> <span class="o">&lt;&lt;</span> <span class="n">Error</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">wpf</span><span class="p">,</span> <span class="n">strError</span><span class="p">(),</span> <span class="s">"::_wchmod"</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
<span class="cp">#endif
</span>                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="c1">// if (p_-&gt;wpMode_ == Impl::wpUnicode)</span>
</code></pre>

	<p>You'll notice that the '17' appears to come from here.</p>


	<p>The bracketing of the #ifdef EXV_UNICODE_PATH code looks suspicious to me.  I think the code is running both the EXV_UNICODE_PATH and ASCII branches.  Our normal build does not set EXV_UNICODE_PATH, so this code doesn't get exercised by our test suite.  I'll rebuild and test with EXV_UNICODE_PATH and see what happens.</p>


	<p>May I ask a couple of questions:<br />1) Do you set EXV_UNICODE_PATH for your build in MSVC and/or LINUX?<br />2) Are you using multi-processing and/or multi-threading?</p>


	<p>Robin</p></div>
  
  </div>
  <div class="message reply" id="message-1798">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1789?r=1798#message-1798">RE: Dateikonflikt Exiv2 Library unter Windows</a>
    -
    Added by <a class="user active" href="/users/4185">LaserSoft Imaging</a> <a title="08 Aug 2014 08:24" href="/projects/exiv2/activity?from=2014-08-08">over 7 years</a> ago
  </h4>
  <div class="wiki"><p>Thanks for your reply, Robin!</p>


	<p>Robin Mills wrote:</p>


<blockquote>

	<p>May I ask a couple of questions:<br />1) Do you set EXV_UNICODE_PATH for your build in MSVC and/or LINUX?</p>


</blockquote>

	<p>From what we remember, we haven't set this in purpose for building the library.</p>


	<p>Robin Mills wrote:</p>


<blockquote>

	<p>2) Are you using multi-processing and/or multi-threading?</p>


</blockquote>

	<p>No, not for writing the metadata. We would rather expect Windows to be the second "thread" accessing the file.</p></div>
  
  </div>
  <div class="message reply" id="message-1799">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1789?r=1799#message-1799">RE: Dateikonflikt Exiv2 Library unter Windows</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="08 Aug 2014 15:01" href="/projects/exiv2/activity?from=2014-08-08">over 7 years</a> ago
  </h4>
  <div class="wiki"><p>I've built and run our test suite on the trunk with/without EXV_UNICODE_PATH defined.  Incidentally, EXV_UNICODE_PATH is defined by default in exv_msvc.h</p>


	<p>I think we're going on Safari to hunt down this beast.  I'm fairly sure this issue arrives from the code in src/basicio.cpp line#710+.  I can only think of three ways to get closer:<br />1) You debug it from your application (with Visual Studio, or std::cout statements).<br />2) You find a way (with a sample images) to isolate the issue with the exiv2(.exe) command.<br />3) I (or you)  have a new idea in the next day or two.</p>


	<p>If I don't update this topic for the next couple of days, can you start a new Issue (bug) report and reference this topic (t1789)?  It will not be forgotten when tracked as an Issue.</p>


	<p>Robin</p></div>
  
  </div>
  <div class="message reply" id="message-1800">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1789?r=1800#message-1800">RE: Dateikonflikt Exiv2 Library unter Windows</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="12 Aug 2014 13:09" href="/projects/exiv2/activity?from=2014-08-12">over 7 years</a> ago
  </h4>
  <div class="wiki"><p>I've opened an issue (bug) report about this.  <a class="external" href="http://dev.exiv2.org/issues/979">http://dev.exiv2.org/issues/979</a></p></div>
  
  </div>
  <div class="message reply" id="message-1825">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1789?r=1825#message-1825">RE: Dateikonflikt Exiv2 Library unter Windows</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="16 Sep 2014 01:46" href="/projects/exiv2/activity?from=2014-09-16">about 7 years</a> ago
  </h4>
  <div class="wiki"><p>We believe the Virus checker make be the bandit here.  See discussion:  <a class="external" href="http://dev.exiv2.org/boards/3/topics/1816">http://dev.exiv2.org/boards/3/topics/1816</a></p></div>
  
  </div>
</div>
<span class="pagination"><ul class="pages"></ul><span><span class="items">(1-7/7)</span> </span></span>



        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
