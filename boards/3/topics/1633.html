<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Why does a JPG change in many places, if i add GPS Metadata? - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="wpS7THxlUcAlArNAelRmFyJCVuck7oSC4y2BEfkm0JEg2RCjDh+dwHBmrEzFg2okHdACntUNJTgeDRGZuh83/g==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
</head>
<body class="project-exiv2 has-main-menu controller-messages action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="messages" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="messages" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=boards" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=boards">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards selected" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="nosidebar">
    <div id="sidebar">
        
        
    </div>

    <div id="content">
        
        <p class="breadcrumb"><a href="/projects/exiv2/boards">Forums</a> » <a href="/projects/exiv2/boards/3">Forum</a> » </p>

<div class="contextual">
    
    
    
    
</div>

<h2>Why does a JPG change in many places, if i add GPS Metadata?</h2>

<div class="message">
<p><span class="author">Added by <a class="user active" href="/users/3972">Claudius Coenen</a> <a title="27 Sep 2013 03:31" href="/projects/exiv2/activity?from=2013-09-27">about 8 years</a> ago</span></p>
<div class="wiki">
<p>I recently added GPS Metadata to a few images of mine. This is the first time that i used exiv2 for that (actually i used DigiKam, but that's besides the point).</p>


	<p>These images are very important to me, so i thought i'd look at the changes more closely, and sure enough this question emerged: If the metadata is supposed to be in APP1, and APP1 is usually at the start of an image, why do other parts of the image change? I created a copy of an image, and ran this command on it:</p>
	<pre><code>exiv2 -m data.txt IMG_0228_exiv2gps.JPG</code></pre>


	<p>data.txt content:</p>
	<pre><code>add Exif.GPSInfo.GPSLatitudeRef                  Ascii       S<br />    add Exif.GPSInfo.GPSLatitude                     Rational    45/1 1584000/1000000 0/1<br />    add Exif.GPSInfo.GPSLongitudeRef                 Ascii       E<br />    add Exif.GPSInfo.GPSLongitude                    Rational    168/1 38969088/1000000 0/1<br />    add Exif.GPSInfo.GPSAltitudeRef                  Byte        0<br />    add Exif.GPSInfo.GPSAltitude                     Rational    797/1<br />    add Exif.GPSInfo.GPSMapDatum                     Ascii       WGS-84</code></pre>


	<p>Afterwards, i did a diff with kdiff3, which produced a number of changes (lots of change in the header, which i expected, but also 1-byte changes all over the file).</p>


	<p>!Screenshot from 2013-09-27 22:30:19.png!</p>
</div>
<div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/545">19.png</a>    <span class="size">(76.8 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/545/19.png">19.png</a>  </td>
  <td></td>
  <td>
  </td>
  <td>
  </td>
</tr>
</table>
</div>

</div>
<br />

<div id="replies">
<h3 class="comments icon icon-comments">Replies (6)</h3>
  <div class="message reply" id="message-1634">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1633?r=1634#message-1634">RE: Why does a JPG change in many places, if i add GPS Metadata?</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="27 Sep 2013 08:13" href="/projects/exiv2/activity?from=2013-09-27">about 8 years</a> ago
  </h4>
  <div class="wiki"><p>Claudius</p>


	<p>Good News:  We're adding new tools to exiv2 to help you diagnose and understand this this situation.  They are currently in development in the gsoc13 branch, however they will be added to the trunk for 0.25 (expected late 2013).  <a class="external" href="http://dev.exiv2.org/issues/922">http://dev.exiv2.org/issues/922</a></p>


<pre>
575 rmills@rmills-mbp:~/gnu/exiv2/gsoc13 $ cp ~/Pictures/Wallpapers/Andrew\ Molera\ SP\,\ CA.jpg R.jpg  # copy an image
576 rmills@rmills-mbp:~/gnu/exiv2/gsoc13 $ exiv2 -pa R.jpg | grep -i gps  # sniff to see the GPS tags
577 rmills@rmills-mbp:~/gnu/exiv2/gsoc13 $ bin/exifprint --struc R.jpg # dump the structure (APP1 is 16082 bytes)
STRUCTURE OF FILE:
  offset | marker     | size | signature
       2   0xd8 SOI          
       4   0xe1 APP1   16082   Exif..II*........... .........
   16088   0xe1 APP1     676   http://ns.adobe.com/xap/1.0/.&lt;
   16766   0xed APP13    102   Photoshop 3.0.8BIM............
   16870   0xdb DQT      132   
   17004   0xc4 DHT      418   
   17424   0xc0 SOF0      17   
   17443   0xda SOS       12   
-----------------
578 rmills@rmills-mbp:~/gnu/exiv2/gsoc13 $ exiv2 -m data.txt R.jpg  # run Claudius 'data.txt' GPS modification 
579 rmills@rmills-mbp:~/gnu/exiv2/gsoc13 $ bin/exifprint --struc R.jpg # examine the structure - YES APP1 is longer (now 16248 bytes)
STRUCTURE OF FILE:
  offset | marker     | size | signature
       2   0xd8 SOI          
       4   0xe1 APP1   16248   Exif..II*........... .........
   16254   0xe1 APP1    2602   http://ns.adobe.com/xap/1.0/.&lt;
   18858   0xed APP13    102   Photoshop 3.0.8BIM............
   18962   0xdb DQT      132   
   19096   0xc4 DHT      418   
   19516   0xc0 SOF0      17   
   19535   0xda SOS       12   
-----------------
580 rmills@rmills-mbp:~/gnu/exiv2/gsoc13 $ exiv2 -pa R.jpg | grep -i gps (sniff the GPS tags)
Exif.Image.GPSTag                            Long        1  2602
Exif.GPSInfo.GPSLatitudeRef                  Ascii       2  South
Exif.GPSInfo.GPSLatitude                     Rational    3  45deg 1.58400' 
Exif.GPSInfo.GPSLongitudeRef                 Ascii       2  East
Exif.GPSInfo.GPSLongitude                    Rational    3  168deg 38.96909' 
Exif.GPSInfo.GPSAltitudeRef                  Byte        1  Above sea level
Exif.GPSInfo.GPSAltitude                     Rational    1  797 m
Exif.GPSInfo.GPSMapDatum                     Ascii       7  WGS-84
581 rmills@rmills-mbp:~/gnu/exiv2/gsoc13 $ </pre><br />I've done more or less the same to your PNG.<br /><pre>
589 rmills@rmills-mbp:~/gnu/exiv2/gsoc13 $ curl http://dev.exiv2.org/attachments/545/19.png &gt; 19.png
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 78622  100 78622    0     0  77999      0  0:00:01  0:00:01 --:--:-- 78937
590 rmills@rmills-mbp:~/gnu/exiv2/gsoc13 $ exiv2 -pa -g GPS 19.png   # sniff the GPS tags
591 rmills@rmills-mbp:~/gnu/exiv2/gsoc13 $ bin/exifprint --struc 19.png # dump the structure
index   |  chunk_type  | chunk_size
    0       IHDR          13
    1       sBIT          4
    2       tEXt          25
    3       IDAT          8192
    4       IDAT          8192
    5       IDAT          8192
    6       IDAT          8192
    7       IDAT          8192
    8       IDAT          8192
    9       IDAT          8192
   10       IDAT          8192
   11       IDAT          8192
   12       IDAT          4676
   13       IEND          0
592 rmills@rmills-mbp:~/gnu/exiv2/gsoc13 $ exiv2 -m data.txt 19.png # add the GPS data
593 rmills@rmills-mbp:~/gnu/exiv2/gsoc13 $ bin/exifprint --struc 19.png # file is longer
index   |  chunk_type  | chunk_size
    0       IHDR          13
    1       zTXt          178
    2       sBIT          4
    3       tEXt          25
    4       IDAT          8192
    5       IDAT          8192
    6       IDAT          8192
    7       IDAT          8192
    8       IDAT          8192
    9       IDAT          8192
   10       IDAT          8192
   11       IDAT          8192
   12       IDAT          8192
   13       IDAT          4676
   14       IEND          0
594 rmills@rmills-mbp:~/gnu/exiv2/gsoc13 $ exiv2 -pa -g GPS 19.png # dump the GPS tags
Exif.Image.GPSTag                            Long        1  26
Exif.GPSInfo.GPSLatitudeRef                  Ascii       2  South
Exif.GPSInfo.GPSLatitude                     Rational    3  45deg 1.58400' 
Exif.GPSInfo.GPSLongitudeRef                 Ascii       2  East
Exif.GPSInfo.GPSLongitude                    Rational    3  168deg 38.96909' 
Exif.GPSInfo.GPSAltitudeRef                  Byte        1  Above sea level
Exif.GPSInfo.GPSAltitude                     Rational    1  797 m
Exif.GPSInfo.GPSMapDatum                     Ascii       7  WGS-84
595 rmills@rmills-mbp:~/gnu/exiv2/gsoc13 $
</pre><br />There are documents on our wiki which discuss the structure of PNG and JPG files.  <br />PNG:  <a class="external" href="http://dev.exiv2.org/projects/exiv2/wiki/The_Metadata_in_PNG_files">http://dev.exiv2.org/projects/exiv2/wiki/The_Metadata_in_PNG_files</a><br />JPEG: <a class="external" href="http://dev.exiv2.org/projects/exiv2/wiki/The_Metadata_in_JPEG_files">http://dev.exiv2.org/projects/exiv2/wiki/The_Metadata_in_JPEG_files</a>

	<p>I'm not sure I understand your concern or have really answered your question, however I hope this helps.</p>


	<p>Robin</p></div>
  
  </div>
  <div class="message reply" id="message-1638">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1633?r=1638#message-1638">RE: Why does a JPG change in many places, if i add GPS Metadata?</a>
    -
    Added by <a class="user active" href="/users/3972">Claudius Coenen</a> <a title="29 Sep 2013 01:19" href="/projects/exiv2/activity?from=2013-09-29">about 8 years</a> ago
  </h4>
  <div class="wiki"><p>Thanks for the detailed answer. It is very insightful and interesting, but i may have posed the question a little too vague.</p>


	<p>The behaviour i'm observing is, that my JPG is changed in roughly 20 different places all <em>over_the_file</em>. Kdiff 3 (screenshot below) displays this with the red lines right next to the right-hand scrollbar.</p>


	<p>As mentioned, i totally expect the header to change and grow, but i don't know why all the rest of the file changes as well?</p>


	<p><img src="http://dev.exiv2.org/attachments/545/19.png" alt="" /></p></div>
  
  </div>
  <div class="message reply" id="message-1639">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1633?r=1639#message-1639">RE: Why does a JPG change in many places, if i add GPS Metadata?</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="29 Sep 2013 10:10" href="/projects/exiv2/activity?from=2013-09-29">about 8 years</a> ago
  </h4>
  <div class="wiki"><p>Ah, I think I've understood your point.  You asking "why are there red strips all along the file, and not just in the header?".  And my answer is "looks like a bug in kdiff3" as I will explain.</p>


	<p>Here are my files:</p>


<pre>
650 rmills@rmills-mbp:~/gnu/exiv2/gsoc13 $ ls -alt data.txt ~/Pictures/Wallpapers/Andrew\ Molera\ SP\,\ CA.jpg R.jpg
-rw-r--r--+ 1 rmills staff 2712193 Sep 27 07:53 R.jpg  # modified file
-rw-r--r--+ 1 rmills staff     532 Sep 27 07:51 data.txt  # your data
-rwx------+ 1 rmills staff 2710101 Sep  7  2007 /Users/rmills/Pictures/Wallpapers/Andrew Molera SP, CA.jpg # the original image
</pre><br />I've run kdiff3 on R.jpg.  I also have 'red stripes' along the length of the file which makes we wonder "has exiv2 modified the graphical image?".  R.jpg is 2712193-2710101=2092 bytes longer than the original image.  Looking at the output from exifprint -struc (above), we can see the two APP1 segments have increased by 16248-16082=166 and 2602-676=1926.  And (hey presto) 166+1926=2092.  Conclusion, the files changes are restricted to the APP1 segments which are the EXIF and XMP data blocks.

	<p>So, why are there changes along the length of the file and not only at the start of the file?  There is code available to help investigate this matter.  I have discussed 'basicio' in this document: <a class="external" href="http://dev.exiv2.org/projects/exiv2/wiki/GSoC_2013_%22Cloud_Ready%22_Project_Specification">http://dev.exiv2.org/projects/exiv2/wiki/GSoC_2013_%22Cloud_Ready%22_Project_Specification</a> under "Notes about prototyping a solution" section 3 you'll find a link to code which instruments exiv2 I/O.</p>


	<p>Another approach is to extract the data blocks with dd and compare them before/after exiv2 has modified the file.  I've discussed using dd for this purpose in topic 1608.  <a class="external" href="http://dev.exiv2.org/boards/3/topics/1608">http://dev.exiv2.org/boards/3/topics/1608</a></p>


	<p>That kdiff3 is showing differences along the length of the file is a surprise.  However, I'm suspicious that kdiff3 is a little confused by the binary files.  I used FileMerge on the Mac (/usr/bin/opendiff).  This is very similar to kdiff3.  FileMerge only highlighted changes near the start of the file.  <img src="http://clanmills.com/files/opendiff-1633.png" alt="" /></p>


	<p>I'm not going to investigate this matter further as I think my "smoking gun" evidence concerning the APP1 block lengths and file sizes is strong evidence that Exiv2 has only modified metadata.  And opendiff appears to confirm my suspicion that kdiff3 is confused.</p>


	<p>Robin</p></div>
  
  </div>
  <div class="message reply" id="message-1641">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1633?r=1641#message-1641">RE: Why does a JPG change in many places, if i add GPS Metadata?</a>
    -
    Added by <a class="user active" href="/users/3972">Claudius Coenen</a> <a title="01 Oct 2013 00:34" href="/projects/exiv2/activity?from=2013-10-01">about 8 years</a> ago
  </h4>
  <div class="wiki"><p>Wow, I think you're right.</p>


	<p>I just ran it through plain old regular diff with</p>
	<pre><code>diff -da IMG_0228_camera_original.JPG IMG_0228_exiv2gps.JPG</code></pre>


	<p>And it returned nothing beyond "line" 59. I'm sorry for blaming exiv2 before double-checking my (presumed) results! Thanks for taking the time!</p></div>
  
  </div>
  <div class="message reply" id="message-1642">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1633?r=1642#message-1642">Why does a JPG change in many places, if i add GPS Metadata? [solved: it doesn&#39;t]</a>
    -
    Added by <a class="user active" href="/users/3972">Claudius Coenen</a> <a title="01 Oct 2013 00:36" href="/projects/exiv2/activity?from=2013-10-01">about 8 years</a> ago
  </h4>
  <div class="wiki"><p>I have no authorization to change the topics title, but i'd suggest changing it to "Why does a JPG change in many places, if i add GPS Metadata? [solved: it doesn't]"</p></div>
  
  </div>
  <div class="message reply" id="message-1643">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1633?r=1643#message-1643">RE: Why does a JPG change in many places, if i add GPS Metadata?</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="01 Oct 2013 00:46" href="/projects/exiv2/activity?from=2013-10-01">about 8 years</a> ago
  </h4>
  <div class="wiki"><p>Claudius</p>


	<p>I'm glad you agree with my analysis.  You've made my day.  I believe I am authorized to modify and delete stuff on the forum.  However I've never done this, because all the Exiv2 users are well behaved on the forum.  So let's leave it as it is.</p>


	<p>Robin</p></div>
  
  </div>
</div>
<span class="pagination"><ul class="pages"></ul><span><span class="items">(1-6/6)</span> </span></span>



        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
