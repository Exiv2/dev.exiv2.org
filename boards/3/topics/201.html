<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>TIFF write meta-data corruption (OS X) - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="oTmqj5SmxJIL5nrC/QEVI8DqH0nZNiVwiKfHO0/+4d9DdAFg5twIkl6CZc5C1hkQ/3hLMCjVhMp1h1ezDMcGsA==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
</head>
<body class="project-exiv2 has-main-menu controller-messages action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="messages" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="messages" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=boards" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=boards">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards selected" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="nosidebar">
    <div id="sidebar">
        
        
    </div>

    <div id="content">
        
        <p class="breadcrumb"><a href="/projects/exiv2/boards">Forums</a> » <a href="/projects/exiv2/boards/3">Forum</a> » </p>

<div class="contextual">
    
    
    
    
</div>

<h2>TIFF write meta-data corruption (OS X)</h2>

<div class="message">
<p><span class="author">Added by <a class="user active" href="/users/221">Paul Miller</a> <a title="13 Aug 2009 14:50" href="/projects/exiv2/activity?from=2009-08-13">over 12 years</a> ago</span></p>
<div class="wiki">
<p>I'm using 0.18.2 and when I write metadata to a TIFF file it shrinks the file down to 4K and corrupts the file. Is this a known problem?</p>
</div>

</div>
<br />

<div id="replies">
<h3 class="comments icon icon-comments">Replies (13)</h3>
  <div class="message reply" id="message-202">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/201?r=202#message-202">RE: TIFF write meta-data corruption (OS X)</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="13 Aug 2009 17:59" href="/projects/exiv2/activity?from=2009-08-13">over 12 years</a> ago
  </h4>
  <div class="wiki"><p>Hi Paul,</p>


	<p>No that shouldn't happen. But it <em>is</em> possible to cripple a TIFF file when writing to it. Can you provide a sample image and show what you're doing with it?</p>


	<p>Andreas</p></div>
  
  </div>
  <div class="message reply" id="message-203">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/201?r=203#message-203">RE: TIFF write meta-data corruption (OS X)</a>
    -
    Added by <a class="user active" href="/users/221">Paul Miller</a> <a title="13 Aug 2009 18:29" href="/projects/exiv2/activity?from=2009-08-13">over 12 years</a> ago
  </h4>
  <div class="wiki"><p>Andreas Huggel wrote:</p>


<blockquote>

	<p>No that shouldn't happen. But it <em>is</em> possible to cripple a TIFF file when writing to it. Can you provide a sample image and show what you're doing with it?</p>


</blockquote>

	<p>I just followed the sample program, really - it happens with any TIFF I write out using libtiff:</p>


	<p>@Exiv2::Image::AutoPtr image = Exiv2::ImageFactory::open(path);<br />if (image.get())
{<br />    image->setExifData(exif_data_i_got_from_another_file);<br />    image->writeMetadata();<br />}<br />@</p></div>
  
  </div>
  <div class="message reply" id="message-204">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/201?r=204#message-204">RE: TIFF write meta-data corruption (OS X)</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="13 Aug 2009 18:56" href="/projects/exiv2/activity?from=2009-08-13">over 12 years</a> ago
  </h4>
  <div class="wiki"><p>Hi Paul,</p>


	<p><code>setExifData</code> replaces all existing Exif data in the target with those of the source. This is fine if the target image has metadata which is clearly separated from the image structure. TIFF-like formats don't do that and this operation potentially wipes out the image tags.</p>


	<p>There was an issue in the exiv2 command line tool related to this, <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Exiv2 generated TIFF incompatible with libtiff (Closed)" href="/issues/602">#602</a>. It was fixed in 0.18.2, see <a href="http://dev.exiv2.org/issues/show/602#note-4" class="external">note 4</a> and <a class="changeset" title="#602: Added specialized insert and delete code for TIFF-like target images." href="/projects/exiv2/repository/exiv2/revisions/1759">r1759</a>, in particular <a href="http://dev.exiv2.org/repositories/diff/exiv2/trunk/src/actions.cpp?rev=1759" class="external">the changes in actions.cpp</a> - you may want to do something similar in your code.</p>


	<p>Andreas</p></div>
  
  </div>
  <div class="message reply" id="message-205">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/201?r=205#message-205">RE: TIFF write meta-data corruption (OS X)</a>
    -
    Added by Anonymous <a title="14 Aug 2009 05:36" href="/projects/exiv2/activity?from=2009-08-14">over 12 years</a> ago
  </h4>
  <div class="wiki"><p>Ooh, that explains the troubles I was having too.</p>


	<p>Could we get a "tiff-safe" setExifData variant in exiv2, instead of copying the special exceptions into every applications?</p>


	<p>- Mike</p></div>
  
  </div>
  <div class="message reply" id="message-206">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/201?r=206#message-206">RE: TIFF write meta-data corruption (OS X)</a>
    -
    Added by <a class="user active" href="/users/221">Paul Miller</a> <a title="14 Aug 2009 05:50" href="/projects/exiv2/activity?from=2009-08-14">over 12 years</a> ago
  </h4>
  <div class="wiki"><p>Yeah there is a fair bit of special-purpose code there - it would be nice if the TIFF implementation of setExifData() would just "do the right thing", so we don't need to worry about which format we're dealing with. I've reverted to 0.16 for the time being since I had to get a quick update put out.</p></div>
  
  </div>
  <div class="message reply" id="message-207">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/201?r=207#message-207">RE: TIFF write meta-data corruption (OS X)</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="15 Aug 2009 01:51" href="/projects/exiv2/activity?from=2009-08-15">over 12 years</a> ago
  </h4>
  <div class="wiki"><p>Yes, I agree that should be added to the library. Especially also as exiv2 will sooner or later be able to write to TIFF-like RAW formats. I can think of a few ways to achieve this:</p>


	<p>1. Variant: Leave Image::setExifData (and Image::setMetadata) as they are and add a new function, e.g., Image::copyExifData (and Image::copyMetadata). Applications that want to use it may currently be using setExifData and will have to change.<br />2. Modify: Change Image::setExifData (and Image::setMetadata). Instead of being a simple setter function, for TIFF images, it now has the necessary logic. That way the change is transparent for apps which need that functionality. But unless we add another simple setter function, it wouldn't be possible to write all TIFF tags anymore. (E.g., to compose a TIFF image from scratch). And those are usually called set*.<br />3. Add something like the metacopy() function from actions.cpp to the library (possibly taking a source and target Image instead of paths).</p>


	<p>Now after typing all of this, I like 1 best. What do you think?</p>


	<p>Andreas</p></div>
  
  </div>
  <div class="message reply" id="message-208">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/201?r=208#message-208">RE: TIFF write meta-data corruption (OS X)</a>
    -
    Added by <a class="user active" href="/users/221">Paul Miller</a> <a title="15 Aug 2009 05:20" href="/projects/exiv2/activity?from=2009-08-15">over 12 years</a> ago
  </h4>
  <div class="wiki"><p>1 would work for me - but instead of naming it "copy" how about "merge"? So it would take the incoming tags and "merge" them with whatever necessary TIFF tags are already there?</p>


	<p>As an aside: I'm talking theory here and not advocating doing #2, but it seems to me there are a certain set of necessary TIFF tags that a TIFF file needs to make the image "work", and then there are other "exif" data tags that are meta-data and "optional", and that setExifData() should NOT overwrite any "necessary" tags but simply insert the meta-data information. This is how I thought it worked when I was attempting to use it the same way I write my JPEG tags. It's current behavior seems to be exposing implementation details about the underlying format.</p></div>
  
  </div>
  <div class="message reply" id="message-209">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/201?r=209#message-209">RE: TIFF write meta-data corruption (OS X)</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="17 Aug 2009 06:24" href="/projects/exiv2/activity?from=2009-08-17">over 12 years</a> ago
  </h4>
  <div class="wiki"><p>Paul Miller wrote:</p>


<blockquote>

	<p>1 would work for me - but instead of naming it "copy" how about "merge"? So it would take the incoming tags and "merge" them with whatever necessary TIFF tags are already there?</p>


</blockquote>

	<p>Or using a flag, similar to that in metacopy(), for the caller to indicate if existing "unnecessary" tags in the target should be preserved or not.</p>


	<p>Andreas</p></div>
  
  </div>
  <div class="message reply" id="message-379">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/201?r=379#message-379">RE: TIFF write meta-data corruption (OS X)</a>
    -
    Added by Anonymous <a title="05 Feb 2010 10:06" href="/projects/exiv2/activity?from=2010-02-05">almost 12 years</a> ago
  </h4>
  <div class="wiki"><p>I have the same problem with setExifData/writeMetadata for TIFF files on Win32. It's corrupts file.</p></div>
  
  </div>
  <div class="message reply" id="message-381">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/201?r=381#message-381">RE: TIFF write meta-data corruption (OS X)</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="05 Feb 2010 18:07" href="/projects/exiv2/activity?from=2010-02-05">almost 12 years</a> ago
  </h4>
  <div class="wiki"><p>This has become issue <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: &quot;TIFF-safe&quot; setExifData variant (Closed)" href="/issues/668">#668</a> and it's on the roadmap for the next release. (It happens on any platform.)</p></div>
  
  </div>
  <div class="message reply" id="message-496">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/201?r=496#message-496">RE: TIFF write meta-data corruption (OS X)</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="26 Apr 2010 07:36" href="/projects/exiv2/activity?from=2010-04-26">over 11 years</a> ago
  </h4>
  <div class="wiki"><p><a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: &quot;TIFF-safe&quot; setExifData variant (Closed)" href="/issues/668">#668</a> is almost done, the "special-purpose code" has been removed from the command-line tool. The logic to take care of "image tags" is now part of the library. The interface remains the same. So please test again, throw any metadata at your TIFFs and see if you can harm them. Or simply truncate it all (exiv2 -da img.tif) and see if the image remains intact as it should. (TIFFs only for now, DNGs and TIFF-like RAW images are not quite as robust yet.)</p>


	<p>Andreas</p></div>
  
  </div>
  <div class="message reply" id="message-497">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/201?r=497#message-497">RE: TIFF write meta-data corruption (OS X)</a>
    -
    Added by Anonymous <a title="26 Apr 2010 07:49" href="/projects/exiv2/activity?from=2010-04-26">over 11 years</a> ago
  </h4>
  <div class="wiki"><p>Just so I understand - you've gone with choice "2. Modify", and setExifData should "just work"?</p>


	<p>- Mike</p></div>
  
  </div>
  <div class="message reply" id="message-498">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/201?r=498#message-498">RE: TIFF write meta-data corruption (OS X)</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="26 Apr 2010 19:32" href="/projects/exiv2/activity?from=2010-04-26">over 11 years</a> ago
  </h4>
  <div class="wiki"><blockquote>

	<p>Just so I understand - you've gone with choice "2. Modify", and setExifData should "just work"?</p>


</blockquote>

	<p>Yes, setExifData should "just work" and the API hasn't changed. The approach is different from that proposed above though, as it turned out that it is necessary to implement this in the lower-level TIFF serialization code (in the the TIFF parser, setExifData itself is unchanged). See issue <a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: &quot;TIFF-safe&quot; setExifData variant (Closed)" href="/issues/668">#668</a> for details.</p>


	<p>Andreas</p></div>
  
  </div>
</div>
<span class="pagination"><ul class="pages"></ul><span><span class="items">(1-13/13)</span> </span></span>



        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
