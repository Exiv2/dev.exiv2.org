<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>bogus timezone value - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="dDp7e2vrZc70Qoz1BI70y/9hgMLFnPXvt1bp8RurKxeWd9CUGZGpzqEmk/m7Wfj4wPPUuzR/VFVKdnl5WJLMeA==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
</head>
<body class="project-exiv2 has-main-menu controller-messages action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="messages" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="messages" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=boards" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=boards">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards selected" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="nosidebar">
    <div id="sidebar">
        
        
    </div>

    <div id="content">
        
        <p class="breadcrumb"><a href="/projects/exiv2/boards">Forums</a> » <a href="/projects/exiv2/boards/3">Forum</a> » </p>

<div class="contextual">
    
    
    
    
</div>

<h2>bogus timezone value</h2>

<div class="message">
<p><span class="author">Added by <a class="user active" href="/users/146">Anonymous Poster</a> <a title="02 Jan 2014 14:48" href="/projects/exiv2/activity?from=2014-01-02">almost 8 years</a> ago</span></p>
<div class="wiki">
<p>I noticed, that some of my images contained a bogus value for timezone:</p>


	<p>$ exiv2 -g Exif.NikonWt.Timezone DSC_3249-nc.jpg <br />Exif.NikonWt.Timezone                        SShort      1  UTC +256:00</p>


	<p>The originating RAW file was okay:</p>


	<p>$ exiv2 -g Exif.NikonWt.Timezone DSC_3249.NEF <br />Exif.NikonWt.Timezone                        SShort      1  UTC +01:00</p>


	<p>So I decided to remove all EXIF data</p>


	<p>$ exiv2 rm DSC_3249-nc.jpg <br />$ exiv2 -g Exif.NikonWt.Timezone DSC_3249-nc.jpg<br />&lt;nothing&gt;</p>


	<p>and re-import the data from the RAW file:</p>


	<p>$ exiv2 ex DSC_3249.NEF<br />$ mv DSC_3249.exv DSC_3249-nc.exv<br />$ exiv2 in DSC_3249-nc.jpg<br />$ exiv2 -g Exif.NikonWt.Timezone DSC_3249-nc.jpg<br />Exif.NikonWt.Timezone                        SShort      1  UTC +01:00</p>


	<p>So everything looked fine. As I had tagged the JPEG before, I added this tag afterwards:</p>


	<p>$ exiv2 -M"add Iptc.Application2.Keywords String 2400pix" DSC_3249-nc.jpg</p>


	<p>But this last step damages the timezone data again:</p>


	<p>$ exiv2 -g Exif.NikonWt.Timezone DSC_3249-nc.jpg<br />Exif.NikonWt.Timezone                        SShort      1  UTC +256:00</p>


	<p>Adding a description "fixes" this:</p>


	<p>$ exiv2 -M"add Iptc.Application2.Caption String Storch" DSC_3249-nc.jpg<br />$ exiv2 -g Exif.NikonWt.Timezone DSC_3249-nc.jpg<br />Exif.NikonWt.Timezone                        SShort      1  UTC +01:00</p>


	<p>What's going on here? This happens with exiv2 0.23 on NetBSD 6.0/amd64.</p>
</div>

</div>
<br />

<div id="replies">
<h3 class="comments icon icon-comments">Replies (11)</h3>
  <div class="message reply" id="message-1692">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1691?r=1692#message-1692">RE: bogus timezone value</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="02 Jan 2014 23:29" href="/projects/exiv2/activity?from=2014-01-02">almost 8 years</a> ago
  </h4>
  <div class="wiki"><p>Happy to report that I can't reproduce this ;-)</p>


<pre>
$ exiv2 -u -pa ee.jpg 
$ exiv2 -M 'set Exif.Image.Make NIKON' -M 'set Exif.NikonWt.Timezone 60' ee.jpg 
$ exiv2 -u -pa ee.jpg 
Exif.Image.Make                              Ascii       6  NIKON
Exif.Image.ExifTag                           Long        1  44
Exif.Photo.MakerNote                         Undefined  36  78 105 107 111 110 0 2 16 0 0 73 73 42 0 8 0 0 0 1 0 36 0 7 0 4 0 0 0 60 0 0 0 0 0 0 0
Exif.MakerNote.Offset                        Long        1  62
Exif.MakerNote.ByteOrder                     Ascii       3  II
Exif.NikonWt.Timezone                        SShort      1  UTC +01:00
Exif.NikonWt.DaylightSavings                 Byte        1  No
Exif.NikonWt.DateDisplayFormat               Byte        1  Y/M/D
$ exiv2 -M"add Iptc.Application2.Keywords String 2400pix" ee.jpg 
$ exiv2 -u -pa ee.jpg 
Exif.Image.Make                              Ascii       6  NIKON
Exif.Image.ExifTag                           Long        1  44
Exif.Photo.MakerNote                         Undefined  36  78 105 107 111 110 0 2 16 0 0 73 73 42 0 8 0 0 0 1 0 36 0 7 0 4 0 0 0 60 0 0 0 0 0 0 0
Exif.MakerNote.Offset                        Long        1  62
Exif.MakerNote.ByteOrder                     Ascii       3  II
Exif.NikonWt.Timezone                        SShort      1  UTC +01:00
Exif.NikonWt.DaylightSavings                 Byte        1  No
Exif.NikonWt.DateDisplayFormat               Byte        1  Y/M/D
Iptc.Application2.Keywords                   String      7  2400pix
$ 
</pre>

	<p>But seriously, this sounds very strange. Can you provide a picture that has the Nikon Exif data but not the IPTC tag for me to play with? (Either upload it here or send it to ahuggel at gmx dot net.)</p>


	<p>Andreas</p></div>
  
  </div>
  <div class="message reply" id="message-1693">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1691?r=1693#message-1693">RE: bogus timezone value</a>
    -
    Added by <a class="user active" href="/users/146">Anonymous Poster</a> <a title="03 Jan 2014 11:21" href="/projects/exiv2/activity?from=2014-01-03">almost 8 years</a> ago
  </h4>
  <div class="wiki"><p>What a surprise ;)</p>


	<p>I have uploaded two sets (RAW and JPEGs) of images to</p>


	<p><a class="external" href="https://drive.google.com/folderview?id=0B_8w9Tstv6xZT0szWjAzQjJlRHM">https://drive.google.com/folderview?id=0B_8w9Tstv6xZT0szWjAzQjJlRHM</a></p>


	<p>DSC_8184.NEF was made with a D300s, DSC_3249.NEF with a D800 (i.e. the RAW file is quite big!). The JPEGs already contain bogus timezone values, but I can't remember the exact way how these images were created.</p>


	<p>I have repeated the same sequence of commands on Mac OS X 10.9, and there the timezone is not mangled. On Solaris 10/i86, I can repeat the problem.</p>


	<p>In all cases, exiv2 is built via pkgsrc. The compilers used are</p>


	<p>NetBSD 6.0/amd64: gcc (NetBSD nb2 20110806) 4.5.3<br />Solaris 10/i86: gcc (GCC) 4.7.0<br />Mac OS X: Apple LLVM version 5.0 (clang-500.2.79) (based on LLVM 3.3svn)</p>


	<p>On NetBSD, the gcc generates 64bit code, on Solaris 32bit code. So this might be a GCC problem.</p></div>
  
  </div>
  <div class="message reply" id="message-1694">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1691?r=1694#message-1694">RE: bogus timezone value</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="04 Jan 2014 10:01" href="/projects/exiv2/activity?from=2014-01-04">almost 8 years</a> ago
  </h4>
  <div class="wiki"><p>I can reproduce the issue now. The first step is enough: <pre>$ exiv2 ex DSC_8184.NEF</pre> generates an exv file with the bogus timezone value. Valgrind doesn't complain, so it must be a relatively straightforward issue. However, I still can't re-create it with my own little image <code>ee.jpg</code> from the example above. Please bear with me, I'll investigate further.</p>


	<p>Can you try the above command again on your Mac, does it still not happen there?</p></div>
  
  </div>
  <div class="message reply" id="message-1695">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1691?r=1695#message-1695">RE: bogus timezone value</a>
    -
    Added by <a class="user active" href="/users/4081">Jörn Clausen</a> <a title="04 Jan 2014 12:13" href="/projects/exiv2/activity?from=2014-01-04">almost 8 years</a> ago
  </h4>
  <div class="wiki"><p>(thought I'd better register if this drags on... :)</p>


	<p>The exported .exv file actually does contain the wrong value on Mac OS X, too:</p>


	<p>$ exiv2 ex DSC_8184.NEF<br />$ exiv2 -g Exif.NikonWt.Timezone DSC_8184.*<br />DSC_8184.NEF          Exif.NikonWt.Timezone                        SShort      1  UTC +01:00<br />DSC_8184.exv          Exif.NikonWt.Timezone                        SShort      1  UTC +256:00</p>


	<p>But for some reason it is "fixed" on import:</p>


	<p>$ mv DSC_8184.exv DSC_8184-800x600.exv<br />$ exiv2 in DSC_8184-800x600.jpg<br />$ exiv2 -g Exif.NikonWt.Timezone DSC_8184*<br />DSC_8184-800x600.exv  Exif.NikonWt.Timezone                        SShort      1  UTC +256:00<br />DSC_8184-800x600.jpg  Exif.NikonWt.Timezone                        SShort      1  UTC +01:00<br />DSC_8184.NEF          Exif.NikonWt.Timezone                        SShort      1  UTC +01:00</p></div>
  
  </div>
  <div class="message reply" id="message-1696">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1691?r=1696#message-1696">RE: bogus timezone value</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="04 Jan 2014 12:21" href="/projects/exiv2/activity?from=2014-01-04">almost 8 years</a> ago
  </h4>
  <div class="wiki"><p>256 = 255 +1</p>


	<p>Is this a formatting issue or an unsigned char is being used instead of an unsigned short?  It's something like that.</p>


	<p>Robin</p></div>
  
  </div>
  <div class="message reply" id="message-1697">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1691?r=1697#message-1697">RE: bogus timezone value</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="04 Jan 2014 16:40" href="/projects/exiv2/activity?from=2014-01-04">almost 8 years</a> ago
  </h4>
  <div class="wiki"><p>Or an endianness issue: 1 = 0x0001, 256 = 0x0100<br />If the bytes are wrongly swapped every time the operation is run, it would also explain why a seemingly unrelated command can "fix" the problem.<br />I just haven't had time to look for the code that is responsible for this mess yet..</p></div>
  
  </div>
  <div class="message reply" id="message-1700">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1691?r=1700#message-1700">RE: bogus timezone value</a>
    -
    Added by <a class="user active" href="/users/146">Anonymous Poster</a> <a title="07 Jan 2014 14:13" href="/projects/exiv2/activity?from=2014-01-07">almost 8 years</a> ago
  </h4>
  <div class="wiki"><p>One thing I forgot to try before: Repeating the exactly same operation over and over again flips the timezone value each time:</p>


	<p>$ exiv2 -g Exif.NikonWt.Timezone DSC_8184-800x600.jpg <br />Exif.NikonWt.Timezone                        SShort      1  UTC +01:00<br />$ exiv2 -M"add Iptc.Application2.Keywords String birding" DSC_8184-800x600.jpg<br />$ exiv2 -g Exif.NikonWt.Timezone DSC_8184-800x600.jpg<br />Exif.NikonWt.Timezone                        SShort      1  UTC +256:00<br />$ exiv2 -M"add Iptc.Application2.Keywords String birding" DSC_8184-800x600.jpg<br />$ exiv2 -g Exif.NikonWt.Timezone DSC_8184-800x600.jpg<br />Exif.NikonWt.Timezone                        SShort      1  UTC +01:00<br />$ exiv2 -M"add Iptc.Application2.Keywords String birding" DSC_8184-800x600.jpg<br />$ exiv2 -g Exif.NikonWt.Timezone DSC_8184-800x600.jpg<br />Exif.NikonWt.Timezone                        SShort      1  UTC +256:00</p>


	<p>So a byte-swap seems to be a reasonable explanation.</p>


	<p>A workaround for me is to remove all EXIF data, copy over the original value from the RAW file and then make sure that an even number of operations is used to add tags and descriptions - by simply repeating each command twice. Some of my images have only tags but no descriptions, those were the cases where I ended up with a wrong timezone value.</p></div>
  
  </div>
  <div class="message reply" id="message-1701">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1691?r=1701#message-1701">RE: bogus timezone value</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="08 Jan 2014 07:43" href="/projects/exiv2/activity?from=2014-01-08">almost 8 years</a> ago
  </h4>
  <div class="wiki"><p>Interestingly, the 4 bytes that make up the NikonWt array are exactly the same in DSC_8184.NEF and DSC_8184.exv; the 2 timezone bytes are NOT swapped. One difference is however that DSC_8184.NEF uses big-endian (MM) for both the TIFF (Exif) data as well as for the Makernote, whereas the Exif data in the exv file uses little-endian (II) and the Makernote uses big-endian (MM). So this seems to rather be an issue with the code that <strong>reads</strong> the data, not the writing part.</p></div>
  
  </div>
  <div class="message reply" id="message-1708">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1691?r=1708#message-1708">RE: bogus timezone value</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="17 Jan 2014 02:29" href="/projects/exiv2/activity?from=2014-01-17">almost 8 years</a> ago
  </h4>
  <div class="wiki"><p>I've created bug <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Binary array elements should be decoded using the Makernote&#39;s endianness, not that of the image  (Closed)" href="/issues/945">#945</a> for this and checked-in a fix. Jörn, could you please test the current trunk revision and confirm if that solves the issue for you?</p>


	<p>Andreas</p></div>
  
  </div>
  <div class="message reply" id="message-1709">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1691?r=1709#message-1709">RE: bogus timezone value</a>
    -
    Added by <a class="user active" href="/users/4081">Jörn Clausen</a> <a title="17 Jan 2014 13:29" href="/projects/exiv2/activity?from=2014-01-17">almost 8 years</a> ago
  </h4>
  <div class="wiki"><p>I have applied the changes to version 0.23, as I have problems building 0.24 (different story, maybe later :). With these patches, the problem seems to be gone:</p>


	<p>$ exiv2 -g Exif.NikonWt.Timezone DSC_3249*<br />DSC_3249-800.jpg      Exif.NikonWt.Timezone                        SShort      1  UTC +256:00<br />DSC_3249.NEF          Exif.NikonWt.Timezone                        SShort      1  UTC +01:00</p>


	<p>$ exiv2 ex DSC_3249.NEF</p>


	<p>$ exiv2 -g Exif.NikonWt.Timezone DSC_3249*<br />DSC_3249-800.jpg      Exif.NikonWt.Timezone                        SShort      1  UTC +256:00<br />DSC_3249.NEF          Exif.NikonWt.Timezone                        SShort      1  UTC +01:00<br />DSC_3249.exv          Exif.NikonWt.Timezone                        SShort      1  UTC +01:00</p>


	<p>$ mv DSC_3249.exv DSC_3249-800.exv<br />$ exiv2 in DSC_3249-800.jpg</p>


	<p>$ exiv2 -g Exif.NikonWt.Timezone DSC_3249*<br />DSC_3249-800.exv      Exif.NikonWt.Timezone                        SShort      1  UTC +01:00<br />DSC_3249-800.jpg      Exif.NikonWt.Timezone                        SShort      1  UTC +01:00<br />DSC_3249.NEF          Exif.NikonWt.Timezone                        SShort      1  UTC +01:00</p>


	<p>$ exiv2 -M"add Iptc.Application2.Keywords String birding" DSC_3249-800.jpg<br />$ exiv2 -g Exif.NikonWt.Timezone DSC_3249*<br />DSC_3249-800.exv      Exif.NikonWt.Timezone                        SShort      1  UTC +01:00<br />DSC_3249-800.jpg      Exif.NikonWt.Timezone                        SShort      1  UTC +01:00<br />DSC_3249.NEF          Exif.NikonWt.Timezone                        SShort      1  UTC +01:00</p>


	<p>$ exiv2 -M"add Iptc.Application2.Caption String Storch" DSC_3249-800.jpg<br />$ exiv2 -g Exif.NikonWt.Timezone DSC_3249*<br />DSC_3249-800.exv      Exif.NikonWt.Timezone                        SShort      1  UTC +01:00<br />DSC_3249-800.jpg      Exif.NikonWt.Timezone                        SShort      1  UTC +01:00<br />DSC_3249.NEF          Exif.NikonWt.Timezone                        SShort      1  UTC +01:00</p>


	<p>No more byte swapping, no matter what operation is executed. I have also tested the other example image, with the same results. This looks really good. I have tried it on NetBSD/amd64 with GCC 4.5.3. I can crosscheck on Solaris and Mac OS X in the next days, but I don't expect any more problems.</p>


	<p>Thanks a lot!!!</p></div>
  
  </div>
  <div class="message reply" id="message-1710">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1691?r=1710#message-1710">RE: bogus timezone value</a>
    -
    Added by <a class="user active" href="/users/53">Andreas Huggel</a> <a title="17 Jan 2014 21:34" href="/projects/exiv2/activity?from=2014-01-17">almost 8 years</a> ago
  </h4>
  <div class="wiki"><p>Great, thanks for the quick response!</p></div>
  
  </div>
</div>
<span class="pagination"><ul class="pages"></ul><span><span class="items">(1-11/11)</span> </span></span>



        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
