<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Calculating FocusDistanceUpper and Lower - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="1C50S0ykn9vmlaBex2iJdM//Og7LBxapmmcv+N1ddAA2Y9+kPt5T27Pxv1J4v4VH8G1udzrktxNnR79wnmSTbw==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
</head>
<body class="project-exiv2 has-main-menu controller-messages action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="messages" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="messages" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=boards" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=boards">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards selected" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="nosidebar">
    <div id="sidebar">
        
        
    </div>

    <div id="content">
        
        <p class="breadcrumb"><a href="/projects/exiv2/boards">Forums</a> » <a href="/projects/exiv2/boards/3">Forum</a> » </p>

<div class="contextual">
    
    
    
    
</div>

<h2>Calculating FocusDistanceUpper and Lower</h2>

<div class="message">
<p><span class="author">Added by <a class="user active" href="/users/7060">Dan narsh</a> <a title="26 Mar 2018 19:28" href="/projects/exiv2/activity?from=2018-03-26">over 3 years</a> ago</span></p>
<div class="wiki">
<p>Hi All,</p>


	<p>Wondering if anyone could give detail to how the "FocusDistanceUpper" and "FocusDistanceLower" tags are calculated for the Canon ShotInfo information? I've been looking around with no luck...</p>


	<p>Thanks for your time!</p>


	<p>- DAN</p>
</div>

</div>
<br />

<div id="replies">
<h3 class="comments icon icon-comments">Replies (9)</h3>
  <div class="message reply" id="message-3094">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3093?r=3094#message-3094">RE: Calculating FocusDistanceUpper and Lower</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="26 Mar 2018 19:49" href="/projects/exiv2/activity?from=2018-03-26">over 3 years</a> ago
  </h4>
  <div class="wiki"><p>Dan:  Thanks for bringing this to our attention.  Can ExifTool recognise this metadata?  Please attach an image (or images) and I'll investigate.</p></div>
  
  </div>
  <div class="message reply" id="message-3095">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3093?r=3095#message-3095">RE: Calculating FocusDistanceUpper and Lower</a>
    -
    Added by <a class="user active" href="/users/7060">Dan narsh</a> <a title="26 Mar 2018 20:22" href="/projects/exiv2/activity?from=2018-03-26">over 3 years</a> ago
  </h4>
  <div class="wiki"><p>Hi Robin,</p>


	<p>Thanks for your quick reply, I've attached a sample image here.<br />I have used exiftool to read this meta data. What I'm really wanting to know is if the lens uses a sensor to return this "FocusDistanceUpper" and "FocusDistanceLower" values or if there is an equation used to determine them based on focal length, aperture, etc...</p>


	<p>Thank you again,</p>


	<p>Andy</p></div>
  <div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/1217">L_084_0117.jpg</a>    <span class="size">(1.18 MB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/1217/L_084_0117.jpg">L_084_0117.jpg</a>  </td>
  <td></td>
  <td>
  </td>
  <td>
  </td>
</tr>
</table>
</div>

  </div>
  <div class="message reply" id="message-3096">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3093?r=3096#message-3096">RE: Calculating FocusDistanceUpper and Lower</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="26 Mar 2018 21:20" href="/projects/exiv2/activity?from=2018-03-26">over 3 years</a> ago
  </h4>
  <div class="wiki"><p>Thanks for your reply and file.  Here's what I see:<pre>546 rmills@rmillsmbp:~/Downloads $ curl -O http://dev.exiv2.org/attachments/download/1217/L_084_0117.jpg
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 1205k    0 1205k    0     0   519k      0 --:--:--  0:00:02 --:--:--  520k
547 rmills@rmillsmbp:~/Downloads $ exiv2 -pa L_084_0117.jpg  | grep -i foc
Exif.Photo.FocalLength                       Rational    1  28.0 mm
Exif.CanonCs.FocusMode                       Short       1  Manual focus (3)
Exif.CanonCs.FocusType                       Short       1  Not known
Exif.CanonCs.FocusContinuous                 Short       1  (65535)
Exif.Canon.FocalLength                       Short       4  28.0 mm
Exif.CanonSi.AFPointUsed                     Short       1  3 focus points; none used
Exif.Photo.FocalPlaneXResolution             Rational    1  3443.95
Exif.Photo.FocalPlaneYResolution             Rational    1  3442.02
Exif.Photo.FocalPlaneResolutionUnit          Short       1  inch
548 rmills@rmillsmbp:~/Downloads $ exiv2 -pR L_084_0117.jpg  | grep -i foc
         366 | 0x920a FocalLength                  |  RATIONAL |        1 |       934 | 28/1
          1004 | 0x0007 Focus                        |     ASCII |       32 |      1352 | Firmware Version 1.0.4.........
         462 | 0xa20e FocalPlaneXResolution        |  RATIONAL |        1 |      1850 | 3072000/892
         474 | 0xa20f FocalPlaneYResolution        |  RATIONAL |        1 |      1858 | 2048000/595
         486 | 0xa210 FocalPlaneResolutionUnit     |     SHORT |        1 |           | 2
549 rmills@rmillsmbp:~/Downloads $ exiftool L_084_0117.jpg  | grep -i foc
Focal Length                    : 28.0 mm
Focus Mode                      : Manual Focus (3)
Focus Range                     : Not Known
Max Focal Length                : 135 mm
Min Focal Length                : 28 mm
Focal Units                     : 1/mm
Focal Plane X Size              : 23.22 mm
Focal Plane Y Size              : 15.49 mm
AF Points In Focus              : None (MF)
Focus Distance Upper            : 0.71 m
Focus Distance Lower            : 1.21 m
Focal Plane X Resolution        : 3443.946188
Focal Plane Y Resolution        : 3442.016807
Focal Plane Resolution Unit     : inches
Focal Length                    : 28.0 mm (35 mm equivalent: 44.5 mm)
Hyperfocal Distance             : 10.36 m
550 rmills@rmillsmbp:~/Downloads $ </pre>Our buddy Phil at ExifTool understands/discovers/calculates the upper/lower values.  For me this is a puzzle.</p>


	<p>Please understand that Exiv2 reports what is stored in the file.  Other inspectors such as ExifTool (for which I have the greatest respect) may deduce other properties.</p></div>
  
  </div>
  <div class="message reply" id="message-3097">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3093?r=3097#message-3097">RE: Calculating FocusDistanceUpper and Lower</a>
    -
    Added by <a class="user active" href="/users/7060">Dan narsh</a> <a title="26 Mar 2018 23:01" href="/projects/exiv2/activity?from=2018-03-26">over 3 years</a> ago
  </h4>
  <div class="wiki"><p>Robin,</p>


	<p>Thank you so much for you response and results.<br />I've been looking on ExifTool's forums as well to see if there is an answer asked by others. And contacted Canon about the parameters, to which they aren't sure where they come from. I'll check in with Phil/ExifTool for further detail.</p>


	<p>Thank you again,</p>


	<p>Dan</p></div>
  
  </div>
  <div class="message reply" id="message-3098">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3093?r=3098#message-3098">RE: Calculating FocusDistanceUpper and Lower</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="27 Mar 2018 08:07" href="/projects/exiv2/activity?from=2018-03-27">over 3 years</a> ago
  </h4>
  <div class="wiki"><p>Here's a discussion about this:  <a class="external" href="https://www.dpreview.com/forums/thread/2917509">https://www.dpreview.com/forums/thread/2917509</a></p>


	<p>I'm on vacation at the moment (44th Wedding Anniversary today).  I've been contributing to Exiv2 for 10 years.  I didn't write the Canon MakerNote decoder and don't know how it works.</p>


	<p>And here's some documentation in /usr/local/bin/lib/Image/ExifTool/TagNames.pod<br /><pre>=head3 Canon CameraInfo1DmkIV Tags

CameraInfo tags for the EOS 1D Mark IV.  Indices shown are for firmware
versions 1.0.x, but they may be different for other firmware versions.

  Index1   Tag Name                             Writable
  ------   --------                             --------
      3    FNumber                              int8u
      4    ExposureTime                         int8u
      6    ISO                                  int8u
      7    HighlightTonePriority                int8u
      8    MeasuredEV2                          int8u
      9    MeasuredEV3                          int8u
     21    FlashMeteringMode                    int8u
     25    CameraTemperature                    int8u
     30    FocalLength                          int16uRev
     53    CameraOrientation                    int8u
     84    FocusDistanceUpper                   int16uRev
     86    FocusDistanceLower                   int16uRev
    120    WhiteBalance                         int16u
    124    ColorTemperature                     int16u
    335    LensType                             int16uRev
    337    MinFocalLength                       int16uRev
    339    MaxFocalLength                       int16uRev
    493    FirmwareVersion                      no
    556    FileIndex                            int32u
    568    DirectoryIndex                       int32u
    872    PictureStyleInfo                     Canon PSInfo</pre></p></div>
  
  </div>
  <div class="message reply" id="message-3099">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3093?r=3099#message-3099">RE: Calculating FocusDistanceUpper and Lower</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="27 Mar 2018 08:37" href="/projects/exiv2/activity?from=2018-03-27">over 3 years</a> ago
  </h4>
  <div class="wiki"><p>Positive Progress.  This information is stored in CanonShotInfo: <pre>
534 rmills@rmillsmbp:~/gnu/exiv2/v0.26 $ exiftool -verbose ~/Downloads/L_084_0117.jpg | grep -i dis
  | | | | DisplayAperture = 0
  | | | | FocusDistanceUpper = 71
  | | | | FocusDistanceLower = 121
  | | | | 13) SuperimposedDisplay = 0
535 rmills@rmillsmbp:~/gnu/exiv2/v0.26 $ </pre><pre>  | | | 3)  CanonShotInfo (SubDirectory) --&gt;
  | | | + [BinaryData directory, 54 bytes]
  | | | | AutoISO = 0
  | | | | BaseISO = 224
  | | | | MeasuredEV = 8
  | | | | TargetAperture = 128
  | | | | TargetExposureTime = 96
  | | | | ExposureCompensation = 0
  | | | | WhiteBalance = 0
  | | | | SlowShutter = 3
  | | | | SequenceNumber = 0
  | | | | OpticalZoomCode = 8
  | | | | CameraTemperature = 0
  | | | | FlashGuideNumber = 0
  | | | | AFPointsInFocus = 12288
  | | | | FlashExposureComp = 0
  | | | | AutoExposureBracketing = 0
  | | | | AEBBracketValue = 0
  | | | | ControlMode = 3
  | | | | FocusDistanceUpper = 71
  | | | | FocusDistanceLower = 121
  | | | | FNumber = 128
  | | | | ExposureTime = 104
  | | | | MeasuredEV2 = 90
  | | | | BulbDuration = 0
  | | | | CameraType = 252
</pre>I'll have a sniff around the Canon Maker Note Decoder in the debugger.</p></div>
  
  </div>
  <div class="message reply" id="message-3100">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3093?r=3100#message-3100">RE: Calculating FocusDistanceUpper and Lower</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="28 Mar 2018 23:29" href="/projects/exiv2/activity?from=2018-03-28">over 3 years</a> ago
  </h4>
  <div class="wiki"><p>I know where the information is stored!   Here's the documentation: <a class="external" href="https://www.sno.phy.queensu.ca/~phil/exiftool/TagNames/Canon.html#ShotInfo">https://www.sno.phy.queensu.ca/~phil/exiftool/TagNames/Canon.html#ShotInfo</a>.  It's tag 0x0004 in the MakerNote and coded as 27xSHORT (54 bytes)</p>


<pre>527 rmills@rmillsmbp:~/gnu/github/exiv2/exiv2 $ exiv2 -pR ~/Downloads/L_084_0117.jpg | grep 27
         222 | 0x8827 ISOSpeedRatings              |     SHORT |        1 |           | 400
         270 | 0x9101 ComponentsConfiguration      | UNDEFINED |        4 |           | ...
         378 | 0x927c MakerNote                    | UNDEFINED |      908 |       942 | ......+........................ ...
           980 | 0x0004 Quality                      |     SHORT |       27 |      1266 | 54 0 224 8 128 ...   &lt;---- It's in here
          1124 | 0x00aa                              |     SHORT |        5 |      1758 | 10 930 1021 1027 789
    3227 | 0xffc4 DHT   |     418 
528 rmills@rmillsmbp:~/gnu/github/exiv2/exiv2 $ </pre>I've doctored my local copy to dump all 27 SHORTS and:<br /><pre>980 | 0x0004 Quality  |  SHORT |  27 |  1266 | 54 0 224 8 128 96 0 0 3 0 8 8 0 0 12288 0 0 0 3 71 121 128 104 90 0 0 252 </pre>

	<p>I need to do more work to understand how the decoder works.  Positive Progress.  I'll probably solve this next week when I get home from vacation.</p></div>
  
  </div>
  <div class="message reply" id="message-3101">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3093?r=3101#message-3101">RE: Calculating FocusDistanceUpper and Lower</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="29 Mar 2018 09:08" href="/projects/exiv2/activity?from=2018-03-29">over 3 years</a> ago
  </h4>
  <div class="wiki"><p>Here's the CanonShotInfo in exiv2:<pre>549 rmills@rmillsmbp:~/gnu/github/exiv2/exiv2 $ exiv2 --grep CanonSi -pa ~/Downloads/L_084_0117.jpg 
Exif.CanonSi.ISOSpeed                        Short       1  400
Exif.CanonSi.MeasuredEV                      Short       1  5.25
Exif.CanonSi.TargetAperture                  Short       1  F4
Exif.CanonSi.TargetShutterSpeed              Short       1  1/8 s
Exif.CanonSi.WhiteBalance                    Short       1  Auto
Exif.CanonSi.Sequence                        Short       1  0
Exif.CanonSi.AFPointUsed                     Short       1  3 focus points; none used
Exif.CanonSi.FlashBias                       Short       1  0 EV
Exif.CanonSi.SubjectDistance                 Short       1  0.71 m
Exif.CanonSi.ApertureValue                   Short       1  F4
Exif.CanonSi.ShutterSpeedValue               Short       1  1/10 s
Exif.CanonSi.MeasuredEV2                     Short       1  5.25
550 rmills@rmillsmbp:~/gnu/github/exiv2/exiv2 $ </pre>exiftool output is above.  Exiv2 reports <em><strong>FocusDistanceUpper</strong></em>  as <strong>SubjectDistance</strong> and doesn't report FocusDistanceUpper.  When I modify the ShotInfo definitions (in src/canonmn_int.cpp, as follows): <pre>
    const TagInfo CanonMakerNote::tagInfoSi_[] = {
...
        TagInfo(0x0013, "SubjectDistance", N_("Subject Distance"), N_("Subject distance"), canonSiId, makerTags, unsignedShort, 1, printSi0x0013),
        TagInfo(0x0014, "FocalDistanceLower", N_("Focal Distance Lower"), N_("Focal Distance Lower"), canonSiId, makerTags, unsignedShort, 1, printSi0x0013),
...
    };

</pre>The output is:<pre>560 rmills@rmillsmbp:~/gnu/github/exiv2/exiv2/build $ bin/exiv2 --grep distance/i -pa ~/Downloads/L_084_0117.jpg 
Exif.CanonSi.SubjectDistance                 Short       1  0.71 m
Exif.CanonSi.FocalDistanceLower              Short       1  1.21 m
561 rmills@rmillsmbp:~/gnu/github/exiv2/exiv2/build $  </pre></p>


	<p>So, almost there.  For sure we have a work-around.</p>


	<p>There's a sting in the tail.  The following code is in src/actions.cpp (which is mostly the exiv2 command line):<pre>        // Subject distance
        {
            printLabel(_("Subject distance"));
            bool done = false;
            if (!done) {
                done = 0 != printTag(exifData, "Exif.Photo.SubjectDistance");
            }
            if (!done) {
                done = 0 != printTag(exifData, "Exif.CanonSi.SubjectDistance");
                done = 0 != printTag(exifData, "Exif.CanonFi.FocusDistanceLower");
                done = 0 != printTag(exifData, "Exif.CanonFi.FocusDistanceUpper");
            }
            std::cout &lt;&lt; std::endl;
        }
</pre>That code acknowledges the existence of Exif.CanonFi.FocusDistanceLower and Exif.CanonFi.FocusDistanceLower. These tags are defined:<pre>../src/canonmn_int.cpp:        TagInfo(0x0014, "FocusDistanceUpper", N_("Focus Distance Upper"), N_("Focus Distance Upper"), canonFiId, makerTags, signedShort, 1, printFiFocusDistance),
../src/canonmn_int.cpp:        TagInfo(0x0015, "FocusDistanceLower", N_("Focus Distance Lower"), N_("Focus Distance Lower"), canonFiId, makerTags, signedShort, 1, printFiFocusDistance),</pre>Here's the table:<pre>    // Canon File Info Tag
    const TagInfo CanonMakerNote::tagInfoFi_[] = {
        TagInfo(0x0001, "FileNumber", N_("File Number"), N_("File Number"), canonFiId, makerTags, unsignedLong, 1, printFiFileNumber),
        TagInfo(0x0003, "BracketMode", N_("Bracket Mode"), N_("Bracket Mode"), canonFiId, makerTags, signedShort, 1, EXV_PRINT_TAG(canonBracketMode)),
        TagInfo(0x0004, "BracketValue", N_("Bracket Value"), N_("Bracket Value"), canonFiId, makerTags, signedShort, 1, printValue),
        TagInfo(0x0005, "BracketShotNumber", N_("Bracket Shot Number"), N_("Bracket Shot Number"), canonFiId, makerTags, signedShort, 1, printValue),
        TagInfo(0x0006, "RawJpgQuality", N_("Raw Jpg Quality"), N_("Raw Jpg Quality"), canonFiId, makerTags, signedShort, 1, EXV_PRINT_TAG(canonCsQuality)),
        TagInfo(0x0007, "RawJpgSize", N_("Raw Jpg Size"), N_("Raw Jpg Size"), canonFiId, makerTags, signedShort, 1, EXV_PRINT_TAG(canonRawJpgSize)),
        TagInfo(0x0008, "NoiseReduction", N_("Noise Reduction"), N_("Noise Reduction"), canonFiId, makerTags, signedShort, 1, EXV_PRINT_TAG(canonNoiseReduction)),
        TagInfo(0x0009, "WBBracketMode", N_("WB Bracket Mode"), N_("WB Bracket Mode"), canonFiId, makerTags, signedShort, 1, EXV_PRINT_TAG(canonWBBracketMode)),
        TagInfo(0x000c, "WBBracketValueAB", N_("WB Bracket Value AB"), N_("WB Bracket Value AB"), canonFiId, makerTags, signedShort, 1, printValue),
        TagInfo(0x000d, "WBBracketValueGM", N_("WB Bracket Value GM"), N_("WB Bracket Value GM"), canonFiId, makerTags, signedShort, 1, printValue),
        TagInfo(0x000e, "FilterEffect", N_("Filter Effect"), N_("Filter Effect"), canonFiId, makerTags, signedShort, 1, EXV_PRINT_TAG(canonFilterEffect)),
        TagInfo(0x000f, "ToningEffect", N_("Toning Effect"), N_("Toning Effect"), canonFiId, makerTags, signedShort, 1, EXV_PRINT_TAG(canonToningEffect)),
        TagInfo(0x0010, "MacroMagnification", N_("Macro Magnification"), N_("Macro magnification"), canonFiId, makerTags, signedShort, 1, printValue),
        TagInfo(0x0013, "LiveViewShooting", N_("Live View Shooting"), N_("Live view shooting"), canonFiId, makerTags, signedShort, 1, EXV_PRINT_TAG(canonOffOn)),
        TagInfo(0x0014, "FocusDistanceUpper", N_("Focus Distance Upper"), N_("Focus Distance Upper"), canonFiId, makerTags, signedShort, 1, printFiFocusDistance),
        TagInfo(0x0015, "FocusDistanceLower", N_("Focus Distance Lower"), N_("Focus Distance Lower"), canonFiId, makerTags, signedShort, 1, printFiFocusDistance),
        TagInfo(0x0019, "FlashExposureLock", N_("Flash Exposure Lock"), N_("Flash exposure lock"), canonFiId, makerTags, signedShort, 1, EXV_PRINT_TAG(canonOffOn)),
        // End of list marker
        TagInfo(0xffff, "(UnknownCanonFiTag)", "(UnknownCanonFiTag)", N_("Unknown Canon File Info tag"), canonFiId, makerTags, signedShort, 1, printValue)
    };</pre><br />I suspect this is for use by a different camera.  I'll have to think about this and look more at the exiftool documentation.</p></div>
  
  </div>
  <div class="message reply" id="message-3102">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/3093?r=3102#message-3102">RE: Calculating FocusDistanceUpper and Lower</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="29 Mar 2018 15:55" href="/projects/exiv2/activity?from=2018-03-29">over 3 years</a> ago
  </h4>
  <div class="wiki"><p>There was a patch in 2014 about FocusDistanceUpper and FocusDistanceUpper in Canon .CR2 Raw files. <a class="external" href="http://dev.exiv2.org/issues/0000954">http://dev.exiv2.org/issues/0000954</a></p>


	<p>I found a discussion on a Forum:  <a class="external" href="https://www.dpreview.com/forums/post/42411527">https://www.dpreview.com/forums/post/42411527</a><br />This referenced a page of sample images: <a class="external" href="http://www.imaging-resource.com/PRODS/canon-1dx/canon-1dxA7.HTM">http://www.imaging-resource.com/PRODS/canon-1dx/canon-1dxA7.HTM</a><br />I've downloaded one:  <a class="external" href="https://www.imaging-resource.com/PRODS/canon-1dx/FULLRES/E1DXINBI000050.CR2">https://www.imaging-resource.com/PRODS/canon-1dx/FULLRES/E1DXINBI000050.CR2</a></p>


<pre>590 rmills@rmillsmbp:~/gnu/exiv2 $ exiv2 -pa --grep CanonFi E1DXINBI000050.CR2
Exif.CanonFi.FileNumber                      Long        1  (0)
Exif.CanonFi.BracketMode                     SShort      1  Off
Exif.CanonFi.BracketValue                    SShort      1  0
Exif.CanonFi.BracketShotNumber               SShort      1  0
Exif.CanonFi.RawJpgQuality                   SShort      1  (0)
Exif.CanonFi.RawJpgSize                      SShort      1  Large
Exif.CanonFi.NoiseReduction                  SShort      1  (-1)
Exif.CanonFi.WBBracketMode                   SShort      1  Off
Exif.CanonFi.WBBracketValueAB                SShort      1  0
Exif.CanonFi.WBBracketValueGM                SShort      1  0
Exif.CanonFi.FilterEffect                    SShort      1  (-1)
Exif.CanonFi.ToningEffect                    SShort      1  (-1)
Exif.CanonFi.MacroMagnification              SShort      1  136
Exif.CanonFi.LiveViewShooting                SShort      1  Off
Exif.CanonFi.FocusDistanceUpper              SShort      1  2.13 m  &lt;--- Yes
Exif.CanonFi.FocusDistanceLower              SShort      1  1.73 m  &lt;--- Yes
Exif.CanonFi.FlashExposureLock               SShort      1  Off
591 rmills@rmillsmbp:~/gnu/exiv2 $ </pre>So the CanonFi (Canon File Information) data structure is for Cameras that support .CR2.  I download the equivalent JPG and:<br /><pre>
592 rmills@rmillsmbp:~/gnu/exiv2 $ exiv2 -pa --grep dist/i ~/Downloads/E1DXINBI000050.jpg 
Exif.CanonSi.SubjectDistance                 Short       1  0 m
Exif.CanonFi.FocusDistanceUpper              SShort      1  2.13 m
Exif.CanonFi.FocusDistanceLower              SShort      1  1.73 m
593 rmills@rmillsmbp:~/gnu/exiv2 $ 
</pre>And that plays perfectly with the code above discovered in actions.cpp:<pre>
593 rmills@rmillsmbp:~/gnu/exiv2 $ exiv2 ~/Downloads/E1DXINBI000050.jpg 
File name       : /Users/rmills/Downloads/E1DXINBI000050.jpg
File size       : 8982640 Bytes
MIME type       : image/jpeg
Image size      : 5184 x 3456
Camera make     : Canon
Camera model    : Canon EOS-1D X
Image timestamp : 2012:08:30 14:32:08
Image number    : 
Exposure time   : 0.6 s
Aperture        : F4
Exposure bias   : +2/3 EV
Flash           : No, compulsory
Flash bias      : 0 EV
Focal length    : 70.0 mm
Subject distance: 0 m1.73 m2.13 m  &lt;---------- Yes!  That works.
ISO speed       : 50
Exposure mode   : Aperture priority
Metering mode   : Multi-segment
Macro mode      : Off
Image quality   : Fine
Exif Resolution : 5184 x 3456
White balance   : Custom
Thumbnail       : image/jpeg, 15513 Bytes
Copyright       : 
Exif comment    : 

594 rmills@rmillsmbp:~/gnu/exiv2 $ </pre>The work-around suggested above (add 0x0014, "FocalDistanceLower") disturbs our test suite because we are reporting data that has been ignored in the past.  When I modify "Subject Distance" to be "FocalDistanceUpper" in tagInfoSi_ in src/canonmn_int.cpp, many more exceptions.<pre>
    const TagInfo CanonMakerNote::tagInfoSi_[] = {
...
        TagInfo(0x0013, "FocalDistanceUpper", N_("Focal Distance Upper"), N_("Focal Distance Upper"), canonSiId, makerTags, unsignedShort, 1, printSi0x0013),
        TagInfo(0x0014, "FocalDistanceLower", N_("Focal Distance Lower"), N_("Focal Distance Lower"), canonSiId, makerTags, unsignedShort, 1, printSi0x0013),
...
    };
</pre>I've looked at exiftool documentation for Canon Tags.  I suspect the Exiv2 code which treats 0x0013 as "SubjectDistance" is a long term error.  However, I'm bothered that changing to "FocalDistanceUpper" could cause issues for applications that use Exiv2 (such as digiKam and darktable) which may be expecting "Subject Distance" in the metadata for lens correction.

	<p>Having investigated this, I also think we should populate other members of CanonSi which have been documented by exiftool.  This will cause more ripples in the test suite.</p>


	<p>I don't think I'm going to do any more work on this for the moment.  I've done enough to answer the original question: <em>Wondering if anyone could give detail to how the "FocusDistanceUpper" and "FocusDistanceLower" tags are calculated for the Canon ShotInfo information? I've been looking around with no luck..</em></p>


	<p>If you feel this must be fixed in Exiv2, please raise an issue on <a class="external" href="https://github.com/Exiv2/exiv2/issues">https://github.com/Exiv2/exiv2/issues</a> and it will receive attention.</p></div>
  
  </div>
</div>
<span class="pagination"><ul class="pages"></ul><span><span class="items">(1-9/9)</span> </span></span>



        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
