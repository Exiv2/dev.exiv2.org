<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Problem with Universal libs ] - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="I2YI5YpvhtaznR6i3Mn0B0EXit+x8nj49mnp6f7uSxzBK6MK+BVK1ub5Aa5jHvg0foXepkAR2UILSXlhvdescw==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
</head>
<body class="project-exiv2 has-main-menu controller-messages action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="messages" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="messages" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=boards" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=boards">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards selected" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="nosidebar">
    <div id="sidebar">
        
        
    </div>

    <div id="content">
        
        <p class="breadcrumb"><a href="/projects/exiv2/boards">Forums</a> » <a href="/projects/exiv2/boards/3">Forum</a> » </p>

<div class="contextual">
    
    
    
    
</div>

<h2>Problem with Universal libs ]</h2>

<div class="message">
<p><span class="author">Added by <a class="user active" href="/users/3670">Dominik Pietrzak</a> <a title="19 Oct 2012 03:32" href="/projects/exiv2/activity?from=2012-10-19">about 9 years</a> ago</span></p>
<div class="wiki">
<p>Dear All,</p>


	<p>I am working with QtCreator and qmake project under Mac OSX and have built and installed Exiv2 with basic steps and it works fine.<br />The build runs perfectly ok using linking steps from (<a class="external" href="http://clanmills.com/exiv2/qt.shtml">http://clanmills.com/exiv2/qt.shtml</a>).<br />My qmake project contains:<br />macx {<br />    INCLUDEPATH  += /usr/local/include<br />    LIBS         += -L/usr/local/lib -lexiv2<br />}</p>


	<p>Then, I have build the "Universal" libraries of Exiv2-0.23 on Mac OSX 10.6 (Snow Leopard) with steps explain here:<br /><a class="external" href="http://clanmills.com/exiv2/macosx.shtml">http://clanmills.com/exiv2/macosx.shtml</a><br />However what I am trying to do is to link statically (or/and dynamically) with the universal libraries located in project directory.<br />For this I deleted the libs (.a and .dylib) from the deafault locations and copied the Universal build (.a and .dylib) to project folder so my new qmake looks like :<br />macx {<br />    INCLUDEPATH  += /project/include<br />    LIBS         += -L/project/lib -lexiv2<br />}</p>


	<p>The project process make, build and compilation without errors and warnings. <br />Although, at the beginning of run the application crashes with crash log:</p>


	<ul>
	<li>/usr/local/bin/exiv2 ; exit;<br />dyld: Library not loaded: /usr/local/lib/libexiv2.12.dylib<br />  Referenced from: /usr/local/bin/exiv2<br />  Reason: image not found<br />Trace/BPT trap*</li>
	</ul>


	<p>That means that exiv2 library is still searching in the local deafault location of libraries (.a and .dylib).<br />The app crashes either while dynamic or static link.<br />Static link I obtain by adding CONFIG += staticlib to the qmake.</p>


	<p>Did I missed something with configuration process? Honestly, I am not very familiar with this kind of operations and I just followed the steps from mentioned webpage.<br />Any help, tip would be appreciated.</p>
</div>

</div>
<br />

<div id="replies">
<h3 class="comments icon icon-comments">Replies (12)</h3>
  <div class="message reply" id="message-1279">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1278?r=1279#message-1279">RE: Problem with Universal libs ]</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="19 Oct 2012 09:16" href="/projects/exiv2/activity?from=2012-10-19">about 9 years</a> ago
  </h4>
  <div class="wiki"><p>You'll have to use the tool install_name_tool to modify the dylib when you copy it.</p>


	<p>Dynamic libraries in MacOSX have records which tell their customers where they live.  The linker copies the record into the executable.  At run time, your executable will use this information to find the library.  You can inspect the information inside an executable with otool -L foo.dylib</p>


	<p>Sounds complicated?  That's the way it is!</p>


	<p>Several things you have to know how to make this work:<br />1) Inspect the records with otool -L foo.dylib<br />2) Modify the records with install_name_tool<br />3) The copy from the dylib to the executable occurs during linking</p>


	<p>If you're no using the "standard" locations for the library (such as /usr/local/lib), you can specify a relative path with the record @executable_path/.../libexiv2.12.dylib.  An application on Mac-OSX is a directory with the extension .app (usually called a bundle).  It's normal for the bundle executable to be the file foo.app/Contents/MacOS/foo.  If you add a directory foo.app/Libraries, then you can put your dylib into that location and use @executable_path/../../Libraries/libexiv2.12.dylib</p>


	<p>If you'd like to a model of this being used, I recommend you look in any of the Adobe applications (such as Reader.app).</p>


	<p>If you adopt this approach, then the user can put your bundle (foo.app) anywhere on the file system and it will work.  As a bonus, the library that your application loads is guaranteed to the one you shipped and not an arbitrary library in /usr/local/lib.  When you're debugging this, you'll find the various environment strings documented in 'man dyld' very useful.  export DYLD_PRINT_LIBRARIES=1 is your friend.  You should start your application from the Terminal as $ .... foo.app/Contents/MacOS/foo to see the messages.  When you use 'open foo.app' (or double click the icon), the UI hides those messages.  I think they are written to log and you can use console.app to see/inspect them.  However I prefer to use the Terminal for this purpose.</p>


	<p>Lastly, I recommend that you do this by hand to learn/discover how this works.  Once you are comfortable with this, you'll want to write a script and add it to your build machinery.  The script should copy libexiv2.12.dylib to somewhere and use install_name_tool to modify the copy. Then you link (and your executable will have your install_name), and finally you'll execute your app.  It's fun when you get this to work.</p>


	<p>Good Luck.  Let me know how it goes.</p>


	<p>Robin</p></div>
  
  </div>
  <div class="message reply" id="message-1280">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1278?r=1280#message-1280">RE: Problem with Universal libs ]</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="19 Oct 2012 10:19" href="/projects/exiv2/activity?from=2012-10-19">about 9 years</a> ago
  </h4>
  <div class="wiki"><p>On my way to work, I thought of something very obvious that I should said.  The "quick fix" to get your application to run is to use:</p>


	<p>$ otool -L foo.app/Contents/MacOS/foo<br />... inspect the link records in your app ...</p>


	<p>$ install_name_tool  -change /usr/local/lib/libexiv2.12.dylib .../your-project/.../libexiv2.12.dylib<br />$ otool -L foo.app/Contents/MacOS/foo<br />... inspect again ...<br />$ open foo.app  (or better: $ env DYLD_PRINT_LIBRARIES=1 foo.app/Contents/MacOS/foo)</p>


	<p>.. and you should be happy.  However your happiness won't last when you have to do this every time you link your application.</p>


	<p>By the way, when you run in the terminal $ foo.app/Contents/MacOS/foo</p>


	<p>stdout is in your terminal.  You can then use the much maligned, but very useful printf to help you debug your code.</p></div>
  
  </div>
  <div class="message reply" id="message-1281">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1278?r=1281#message-1281">RE: Problem with Universal libs ]</a>
    -
    Added by <a class="user active" href="/users/3670">Dominik Pietrzak</a> <a title="22 Oct 2012 00:40" href="/projects/exiv2/activity?from=2012-10-22">about 9 years</a> ago
  </h4>
  <div class="wiki"><p>Thank you Robin for the extensive answer. This is exactly what I was asking for! <br />This is the deployment topic and I am recently becoming familiar with it. I will play around with tips you gave me.<br />I have read these tips briefly and already have one additional question.<br />You focused here on dynamic linking for libexiv2.12.dylib only.<br />What about the static linking ?<br />After I run the script exiv2-0.23/contrib/buildForMac I got 3 directories with "Universal" libs :<br />exiv2-0.23/src/i.386 (for Intel 32-bits Mac OSX)<br />exiv2-0.23/src/.libs (for 32-bits Mac OSX)<br />exiv2-0.23/src/x86_64 (for 64-bits Mac OSX)</p>


	<p>Each location contains binary file exiv2, dynamic libs with .dylib extension and static libraries with .a extension.<br />I can copy static libraries ( libexiv2.a  file) to the desired folder where I set my application.<br />Thus my question is if there is any way to link the project with <strong>static</strong> linking libexiv2.a ? <br />I work with QtCreator and would build and link with following qmake script:</p>


	<p>CONFIG += staticlib<br />macx {<br />INCLUDEPATH += /project/include<br />LIBS += -L/project/lib -lexiv2<br />}</p>


	<p>where necessary include headers are in include directory and libexiv2.a  in project/lib directory.<br />Previously, I work with different libraries and this was the way I link them in my project and everything was ok.</p></div>
  
  </div>
  <div class="message reply" id="message-1282">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1278?r=1282#message-1282">RE: Problem with Universal libs ]</a>
    -
    Added by <a class="user active" href="/users/3670">Dominik Pietrzak</a> <a title="22 Oct 2012 00:50" href="/projects/exiv2/activity?from=2012-10-22">about 9 years</a> ago
  </h4>
  <div class="wiki"><p>I forgot to mention to you that I am using DESTDIR in my qmake, so the final script looks as follows:</p>


	<p>DESTDIR = /project/executables<br />CONFIG += staticlib<br />macx {<br />INCLUDEPATH += /project/include<br />LIBS += -L/project/lib -lexiv2<br />}</p></div>
  
  </div>
  <div class="message reply" id="message-1283">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1278?r=1283#message-1283">RE: Problem with Universal libs ]</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="22 Oct 2012 08:38" href="/projects/exiv2/activity?from=2012-10-22">about 9 years</a> ago
  </h4>
  <div class="wiki"><p>When you link &lt;exiv2-dir&gt;/src/.libs/..libexiv2.a and &lt;exiv2-dir&gt;/xmpsdk/src/.libs/libxmpsdk.a you should be done.  The linker switch -lexiv2 will link libexiv2.a.  The linker switch -L src/.libs add to the library search path.</p>


<pre>
$ make distclean ; make config --disable-shared --enable-static ; make 
$ ls -alt xmpsdk/src/.libs/libxmpsdk.a
-rw-r--r--  1 rmills  staff  509440 Oct 22 07:49 xmpsdk/src/.libs/libxmpsdk.a
$ ls -alt src/.libs/libexiv2.a 
-rw-r--r--  1 rmills  staff  4615312 Oct 22 07:50 src/.libs/libexiv2.a
$ cd samples
$ g++ exifprint.cpp -o exifprint -lexiv2 -L../src/.libs -lxmpsdk -L../xmpsdk/src/.libs -lexpat -lz -liconv -lintl
$ ls -alt exifprint
-rwxr-xr-x  1 rmills  staff  2416932 Oct 22 07:55 exifprint
$ ./exifprint
Usage: ./exifprint file
$ otool -L exifprint
exifprint:
    /usr/lib/libexpat.1.dylib (compatibility version 7.0.0, current version 7.2.0)
    /usr/lib/libz.1.dylib (compatibility version 1.0.0, current version 1.2.5)
    /usr/lib/libiconv.2.dylib (compatibility version 7.0.0, current version 7.0.0)
    /usr/local/lib/libintl.8.dylib (compatibility version 10.0.0, current version 10.1.0)
    /usr/lib/libstdc++.6.dylib (compatibility version 7.0.0, current version 56.0.0)
    /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 169.3.0)
$ 
</pre><br />You can see that I've statically linked exifprint with the static build of libexiv2.a and libxmpsdk.a.  However we're dynamically linked to libexpat, libz, libiconv (in /usr/lib).  I'm a little surprised to see I'm linked to /usr/local/lib/libintl.

	<p>Static libraries reduce build complexity. No need to bother with otool, install_name_tool or any other complication. I personally prefer to link with shared libraries, even with the install_name_tool complication.  It is however your choice.</p>


	<p>Please be aware that universal binaries are almost dead with Mountain Lion (which does not have 32 bit support).  If you're using Mountain Lion, it's better to forget about Universal binaries.  I discovered then when I tested 0.23 with the developer preview of Mountain Lion.  I didn't publish this because I was under NDA.   Just do a regular build on ML.  The script contrib/buildForMac was tested on Lion with static and shared libraries and passed our test suite.</p></div>
  
  </div>
  <div class="message reply" id="message-1284">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1278?r=1284#message-1284">RE: Problem with Universal libs</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="22 Oct 2012 08:54" href="/projects/exiv2/activity?from=2012-10-22">about 9 years</a> ago
  </h4>
  <div class="wiki"><p>One more thing (before I head off for work).  I don't have Qt on my Mac at the moment.  If you're still stuck, let me know and I will download Qt this evening and create a sample project for you.</p></div>
  
  </div>
  <div class="message reply" id="message-1285">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1278?r=1285#message-1285">RE: Problem with Universal libs ]</a>
    -
    Added by <a class="user active" href="/users/3670">Dominik Pietrzak</a> <a title="23 Oct 2012 01:08" href="/projects/exiv2/activity?from=2012-10-23">about 9 years</a> ago
  </h4>
  <div class="wiki"><p>Thank you very much for extensive support, Robin!</p>


	<p>Although, still have some troubles with linking.<br />I have tried to build statically via QtCreator with settings you posted. Thus my qmake .pro file looks as follows:</p>


	<p>CONFIG += static<br />macx {<br />INCLUDEPATH += exiv2-0.23/include/exiv2<br />LIBS += exiv2-0.23/xmpsdk/src/.libs/libxmpsdk.a \<br />             exiv2-0.23/src/.libs/libexiv2.a <br />}<br />what surely should do the job you mentioned.<br />However it turns the linking error again :<br />_<em>error: duplicate symbol XML_Node::IsWhitespaceNode() const <br />in exiv2-0.23/xmpsdk/src/.libs/libxmpsdk.a(XML_Node.o) and exiv2-0.23/lib/libexiv2.a(XML_Node.o)</em></p>


	<p>It seems that there is some kind of symbols confict in these two static libs...<br />The linking errors are pretty hard to track and I am not sure what am I doing wrong.</p>


	<p>By the way, I am working with Snow Leopard OSX 10.6, so it handles either 32 or 64 bit modes.</p></div>
  
  </div>
  <div class="message reply" id="message-1286">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1278?r=1286#message-1286">RE: Problem with Universal libs ]</a>
    -
    Added by <a class="user active" href="/users/3670">Dominik Pietrzak</a> <a title="23 Oct 2012 01:11" href="/projects/exiv2/activity?from=2012-10-23">about 9 years</a> ago
  </h4>
  <div class="wiki"><p>If you could create sample Qt projects for OSX with:<br />1) static linking<br />2) dynamic linking</p>


	<p>I would be very happy and I think it would be useful for the others.<br />Possibly you may add it to wiki so anyone could take advantage of that.</p></div>
  
  </div>
  <div class="message reply" id="message-1287">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1278?r=1287#message-1287">RE: Problem with Universal libs ]</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="23 Oct 2012 07:59" href="/projects/exiv2/activity?from=2012-10-23">about 9 years</a> ago
  </h4>
  <div class="wiki"><p>Dominic</p>


	<p>Are you sure that QtCreator is building "Universal" binaries.  Create a "hello-world" command line program and run $ lipo -info hello to see if he's building universal.</p>


	<p>It's going to take me most of this evening for me to load Snow Leopard, QtCreator and so on.  Can I ask you to setup a command-line program in QtCreator and use the source code samples/exifprint.cpp and see if you can get that to link and run?</p>


	<p>It looks as though both libxmpsdk.a and libexiv2.a have the same entry points.  However I know that all our samples programs are working fine and don't give this linking error.</p>


<pre>
$ nm xmpsdk/src/.libs/libxmpsdk.a | grep IsWhitespaceNode
0000000000000000 T __ZNK8XML_Node16IsWhitespaceNodeEv
00000000000020a8 S __ZNK8XML_Node16IsWhitespaceNodeEv.eh
                 U __ZNK8XML_Node16IsWhitespaceNodeEv
$ nm src/.libs/libexiv2.a | grep IsWhitespaceNode
                 U __ZNK8XML_Node16IsWhitespaceNodeEv
0000000000000000 T __ZNK8XML_Node16IsWhitespaceNodeEv
00000000000020a8 S __ZNK8XML_Node16IsWhitespaceNodeEv.eh
$ c++filt __ZNK8XML_Node16IsWhitespaceNodeEv
XML_Node::IsWhitespaceNode() const
$ find . -name "*.hpp" -exec grep -H IsWhitespaceNode {} ";" 
./xmpsdk/src/XMLParserAdapter.hpp:    bool IsWhitespaceNode() const;
$ 
</pre></div>
  
  </div>
  <div class="message reply" id="message-1289">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1278?r=1289#message-1289">RE: Problem with Universal libs ]</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="24 Oct 2012 23:01" href="/projects/exiv2/activity?from=2012-10-24">about 9 years</a> ago
  </h4>
  <div class="wiki"><p>Dominic</p>


	<p>The good news is that this is working just fine for me.  I created a new partition on my hard drive and installed Snow Leopard from CD + the developer tools.  Here's all the stuff I downloaded (I probably don't need cmake).  I've downloaded/installed QtCreator 2.5.2 and Qt SDK 4.8.3.</p>


<pre>
48 rmills@Robin-Millss-iMac:~/Downloads $ dir
-rw-------  1 rmills  staff   545K Oct 24 19:51 About Downloads.pdf
-rw-r--r--@ 1 rmills  staff   182M Sep 13 01:59 qt-mac-opensource-4.8.3.dmg
-rw-r--r--@ 1 rmills  staff    93M Sep 11 00:40 qt-creator-mac-opensource-2.5.2.dmg
-rw-r--r--@ 1 rmills  staff    33M Aug  9 12:36 cmake-2.8.9-Darwin64-universal.dmg
-rw-r--r--@ 1 rmills  staff    68K Nov  2  2011 libintl-0.18.1.1-4.pkg
-rw-r--r--@ 1 rmills  staff   2.3M Oct 23  2011 PkgConfig.pkg
49 rmills@Robin-Millss-iMac:~/Downloads $ 
</pre>

	<p>I built the shared libraries and installed them with:<br /><pre>
$ contrib/buildForMac
$ sudo make install
$ make samples
$ make tests
</pre></p>


	<p>Everything built and the test suite passed with no errors.</p>


	<p>I configured QtCreator to use the qmake in /usr/bin/qmake and he figured out the 4.8.3 for himself.  I created a console application 'exiv-console', removed the wizard's C++ and copied in exifprint.cpp from &lt;exiv2dir&gt;/samples/.  I cut'n'pasted your code above into exiv-console.pro.  It compiled, linked and ran first time!</p>


<pre>
macx {
    INCLUDEPATH += /usr/local/include
    LIBS += -L/usr/local/lib -lexiv2
}
</pre>

	<p>Here's what was built:</p>


<pre>
76 rmills@Robin-Millss-iMac:~/Projects/Qt/exiv-console-build-desktop-Qt_4_8_3__System__Debug/ $ ls -alt exiv-console 
-rwxr-xr-x  1 rmills  staff  43736 Oct 24 21:24 exiv-console
76 rmills@Robin-Millss-iMac:~/Projects/Qt/exiv-console-build-desktop-Qt_4_8_3__System__Debug/ $ otool -L exiv-console
exiv-console:
    /usr/local/lib/libexiv2.12.dylib (compatibility version 13.0.0, current version 13.0.0)
    QtCore.framework/Versions/4/QtCore (compatibility version 4.8.0, current version 4.8.3)
    /usr/lib/libstdc++.6.dylib (compatibility version 7.0.0, current version 7.9.0)
    /usr/lib/libgcc_s.1.dylib (compatibility version 1.0.0, current version 103.0.0)
    /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 123.0.0)
78 rmills@Robin-Millss-iMac:~/Projects/Qt/exiv-console-build-desktop-Qt_4_8_3__System__Debug/ $ 
</pre><br />You can see that exiv-console was 43736 bytes and links /usr/local/lib/libexiv2.12.dylib.

	<p>So then I build the static library, removed the shared libraries and installed the static libraries:<br /><pre>
$ contrib/buildForMac --disable-shared --enable-static
$ sudo rm -rf /usr/local/lib/*exiv2*
$ sudo make install
</pre><br />Back to QtCreator.  Rebuild/relink.  Linker errors.  No problem, tell him to link zlib and friends.  Modified exiv-console.pro:<br /><pre>
macx {
    INCLUDEPATH += /usr/local/include
    LIBS += -L/usr/local/lib -lexiv2 -lexpat -lz -liconv -lintl
}
</pre><br />And things were just as happy.<br /><pre>
32 rmills@Robin-Millss-iMac:~/Projects/Qt/exiv-console-build-desktop-Qt_4_8_3__System__Debug $ ls -alt exiv-console 
-rwxr-xr-x  1 rmills  staff  4002344 Oct 24 21:54 exiv-console
33 rmills@Robin-Millss-iMac:~/Projects/Qt/exiv-console-build-desktop-Qt_4_8_3__System__Debug $ lipo -info exiv-console 
Non-fat file: exiv-console is architecture: x86_64
34 rmills@Robin-Millss-iMac:~/Projects/Qt/exiv-console-build-desktop-Qt_4_8_3__System__Debug $ otool -L exiv-console 
exiv-console:
    /usr/lib/libexpat.1.dylib (compatibility version 7.0.0, current version 7.2.0)
    /usr/lib/libz.1.dylib (compatibility version 1.0.0, current version 1.2.3)
    /usr/lib/libiconv.2.dylib (compatibility version 7.0.0, current version 7.0.0)
    /usr/local/lib/libintl.8.dylib (compatibility version 10.0.0, current version 10.1.0)
    QtCore.framework/Versions/4/QtCore (compatibility version 4.8.0, current version 4.8.3)
    /usr/lib/libstdc++.6.dylib (compatibility version 7.0.0, current version 7.9.0)
    /usr/lib/libgcc_s.1.dylib (compatibility version 1.0.0, current version 103.0.0)
    /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 123.0.0)
35 rmills@Robin-Millss-iMac:~/Projects/Qt/exiv-console-build-desktop-Qt_4_8_3__System__Debug $ 
</pre></p>


	<p>This time, exiv-console was  4002344 bytes (4mb), however he doesn't need libexiv2.12.dylib.</p>


	<a name="Things-learned"></a>
<h3 >Things learned<a href="#Things-learned" class="wiki-anchor">&para;</a></h3>


	<p>You don't need universal binaries to make this work.  QtCreator doesn't build universal binaries by default.  I think you'd have to add some -arch i386 -arch x86_64 arguments in various places to the .pro file.</p>


	<p>So, forget contrib/buildForMac and simply use $ make config ; ./configure ; make ; sudo make install ; make samples ; make tests and you'll be fine.</p>


	<a name="What-didnt-go-too-well"></a>
<h3 >What didn't go too well<a href="#What-didnt-go-too-well" class="wiki-anchor">&para;</a></h3>


	<p>1. /usr/local/lib/libexiv2.la was corrupted when installed by the shared library build</p>


	<p>libexiv2.la is some kind of magic file used by libtool/pkgtool to determine how to link the code.  I don't why he didn't copy correctly from the build tree to /usr/local/lib/libexiv2.la.  I got messages about "couldn't find file ???" from libtool.  So I just copied libexiv2.la from the build tree to /usr/local/lib/libexiv2.la and everything was fine.</p>


	<p>2. libexiv2.a wasn't build correctly as a universal binary</p>


	<p>I had to look in contrib/makeUniversal and figured out to execute the following commands:</p>


<pre>
$ lipo -arch i386 src/.i386/libexiv2.a -arch x86_64 src/.x86_64/libexiv2.a -create -output src/.libs/libexiv2.a
$ sudo cp src/.libs/libexiv2.a /usr/local/lib
</pre>

	<p>I don't know why contrib/buildForMac didn't do this correctly.  I know that script was good on Lion.  Perhaps it needs a little fix for SL.</p>


	<a name="What-Im-going-to-do-next"></a>
<h3 >What I'm going to do next<a href="#What-Im-going-to-do-next" class="wiki-anchor">&para;</a></h3>


	<p>With both my confessions (about the copy of libexiv2.la and not executing lipo on the universal static build), I will investigate and submit a fix if necessary.  However you don't need it immediately, because I'm encouraging you to simply build for x86_64.</p>


	<a name="How-do-move-you-forward"></a>
<h3 >How do move you forward?<a href="#How-do-move-you-forward" class="wiki-anchor">&para;</a></h3>


	<p>I've given you a considerable amount of time here.  I don't believe your troubles are related to the exiv2 software.  You have Mac/Qt/Build Engineering issues.  If you want me to do more work with you on this, you will have to share your code with me.  I assure you that I will treat it confidentially and with respect.</p>


	<p>Finally, may I ask why you are doing this?  If this is for another open-source project, I'm happy to help without charge.  However I'm reluctant to give you very much more free time if this is a commercial project.</p></div>
  
  </div>
  <div class="message reply" id="message-1290">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1278?r=1290#message-1290">RE: Problem with Universal libs ]</a>
    -
    Added by <a class="user active" href="/users/3670">Dominik Pietrzak</a> <a title="25 Oct 2012 06:09" href="/projects/exiv2/activity?from=2012-10-25">about 9 years</a> ago
  </h4>
  <div class="wiki"><p>Thank you very much for your time, Robin ! <br />I have learned a lot from your posts.<br />I am surprised you put so much time into this and provide such extensive explanation. During my work here I also invested quite much time to figure out how the things works (lack of experience in general). Therefore I am really thankful for your involvement.</p>


	<p>Actually I am doing some research for a company which considers commercial license of Exiv2. Therefore I tried different ways of linking since the possible usage would be a part of large, cross-platform project (OSX, Windows, 32 and 64 mode for both platforms). Thus the Universal library was a choice.</p>


	<p>Your posts were extremely helpful to me and I believe some other developers will also appreciate them.</p></div>
  
  </div>
  <div class="message reply" id="message-1291">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/1278?r=1291#message-1291">RE: Problem with Universal libs ]</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="25 Oct 2012 09:37" href="/projects/exiv2/activity?from=2012-10-25">about 9 years</a> ago
  </h4>
  <div class="wiki"><p>Dominic</p>


	<p>I am quite certain that you can create a successful cross-platform OSX/Win32/64 and even Linux/32 Linux/64 software component using Qt.  And exiv2 will work perfectly in the mix.  The reason I am so certain is because I have done this successfully.</p>


	<p>I'm a freelance software guy and do C++, Build Engineering, Installers and Web.  <a class="external" href="http://clanmills.com/files/CV.pdf">http://clanmills.com/files/CV.pdf</a></p>


	<p>I had a couple of weeks at home a couple of years ago and spent them on a Qt project involving exiv2.  This was when Snow Leopard was the current Mac-OSX (before Lion and Moutain Lion).  The project wasn't finished when I got a call to do some work (for money) and the project has been sitting unfinished on the SVN server ever since.  Linking on Windows was much harder than Mac or Unix.  At that is when I wrote the articles: <a class="external" href="http://clanmills.com/exiv2/mingw.shtml">http://clanmills.com/exiv2/mingw.shtml</a> and <a class="external" href="http://clanmills.com/exiv2/qt.shtml">http://clanmills.com/exiv2/qt.shtml</a></p>


	<p>So I've documented this already, however I might add a link from those articles to this thread as we've discussed many additional details here.</p>


	<p>Please assure your customer that this project is feasible.  A commercial license for exiv2 is very inexpensive.  Email Andreas for details.  I'm not looking for work, however I'm always willing to discuss opportunities for the future.  If you wish to discuss how to involve me in the project then email me privately at <a class="email" href="mailto:robin@clanmills.com">robin@clanmills.com</a></p>


	<p>Best Wishes</p></div>
  
  </div>
</div>
<span class="pagination"><ul class="pages"></ul><span><span class="items">(1-12/12)</span> </span></span>



        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
