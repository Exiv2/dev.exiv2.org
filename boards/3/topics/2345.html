<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>Possibly bugs in value parsing - Exiv2</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="Ntr8bjwJriNxSQhhztkHaVhmQEkOrN79jGIRTiFdvDvUl1eBTnNiIyQtF21xDgtaZ/QUMP9Pf0dxQoHGYmRbVA==" />
<link rel='shortcut icon' href='/favicon.ico?1550767427' />
<link rel="stylesheet" media="all" href="/stylesheets/jquery/jquery-ui-1.11.0.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/application.css?1550767427" />
<link rel="stylesheet" media="all" href="/stylesheets/responsive.css?1550767427" />

<script src="/javascripts/jquery-1.11.1-ui-1.11.0-ujs-4.3.1.js?1550767427"></script>
<script src="/javascripts/application.js?1550767427"></script>
<script src="/javascripts/responsive.js?1550767427"></script>
<script>
//<![CDATA[
$(window).load(function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>


<!-- page specific tags -->
</head>
<body class="project-exiv2 has-main-menu controller-messages action-show avatars-off">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">


        <div class="flyout-menu__search">
            <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
            <input type="hidden" name="messages" value="1" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search">&#9906;</label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>

<div id="wrapper2">
<div id="wrapper3">
<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/exiv2/search" accept-charset="UTF-8" method="get"><input name="utf8" type="hidden" value="&#x2713;" />
        <input type="hidden" name="scope" />
        <input type="hidden" name="messages" value="1" />
        <label for='q'>
          <a accesskey="4" href="/projects/exiv2/search">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Exiv2</span><div class="drdn-content"><div class="quick-search"><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=boards" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=boards">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Exiv2</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/exiv2">Overview</a></li><li><a class="activity" href="/projects/exiv2/activity">Activity</a></li><li><a class="roadmap" href="/projects/exiv2/roadmap">Roadmap</a></li><li><a class="issues" href="/projects/exiv2/issues">Issues</a></li><li><a class="news" href="/projects/exiv2/news">News</a></li><li><a class="wiki" href="/projects/exiv2/wiki">Wiki</a></li><li><a class="boards selected" href="/projects/exiv2/boards">Forums</a></li><li><a class="repository" href="/projects/exiv2/repository">Repository</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="nosidebar">
    <div id="sidebar">
        
        
    </div>

    <div id="content">
        
        <p class="breadcrumb"><a href="/projects/exiv2/boards">Forums</a> » <a href="/projects/exiv2/boards/3">Forum</a> » </p>

<div class="contextual">
    
    
    
    
</div>

<h2>Possibly bugs in value parsing</h2>

<div class="message">
<p><span class="author">Added by <a class="user active" href="/users/4340">Mikayel Egibyan</a> <a title="09 Feb 2016 23:13" href="/projects/exiv2/activity?from=2016-02-09">almost 6 years</a> ago</span></p>
<div class="wiki">
<p>Hi,</p>


	<p>Some observations regarding value parsing in Exiv2.</p>


	<p><strong>1.</strong><br /><code>...<br /> exifData["Exif.Image.ApertureValue"] = Exiv2::floatToRationalCast(1.2);<br />...</code></p>


	<p>When reading back the value is <code>1.5</code>.</p>


	<p>This is true for many rational tags, independently what the setting value is.</p>


	<p><strong>2.</strong><br />ApertureValue and MaxApertureValue values are different when extracting it as:</p>


	<p><code>exifData[key]</code> and <code>i->value().toString()</code></p>


	<p>An example image is attached.</p>


	<p>Please let me know if these are bugs, or maybe I misunderstand something.</p>


	<p>Thanks :)<br />Mikayel</p>
</div>
<div class="attachments">
<div class="contextual">
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment" href="/attachments/959">559572663_061680528a_o.jpg</a>    <span class="size">(675 KB)</span>
    <a class="icon-only icon-download" title="Download" href="/attachments/download/959/559572663_061680528a_o.jpg">559572663_061680528a_o.jpg</a>  </td>
  <td></td>
  <td>
  </td>
  <td>
  </td>
</tr>
</table>
</div>

</div>
<br />

<div id="replies">
<h3 class="comments icon icon-comments">Replies (6)</h3>
  <div class="message reply" id="message-2346">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/2345?r=2346#message-2346">RE: Possibly bugs in value parsing</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="09 Feb 2016 23:57" href="/projects/exiv2/activity?from=2016-02-09">almost 6 years</a> ago
  </h4>
  <div class="wiki"><p>Ah yes, this is an interesting matter and was discussed at length in  Issue 1039.  Phil explained Aperture to be an APEX value:  <a class="external" href="http://dev.exiv2.org/issues/1039#note-8">http://dev.exiv2.org/issues/1039#note-8</a>.  I added the syntax <em>Fnumber</em> to exiv2 to deal with this <a class="changeset" title="#1039.  Thank You, Torsten for raising this matter.  Thank You, Phil for your help with this." href="/projects/exiv2/repository/exiv2/revisions/3621">r3621</a></p></div>
  
  </div>
  <div class="message reply" id="message-2347">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/2345?r=2347#message-2347">RE: Possibly bugs in value parsing</a>
    -
    Added by <a class="user active" href="/users/4340">Mikayel Egibyan</a> <a title="10 Feb 2016 11:02" href="/projects/exiv2/activity?from=2016-02-10">almost 6 years</a> ago
  </h4>
  <div class="wiki"><p>Does this mean that 0.25 should already act correctly? Or this is for next release?</p></div>
  
  </div>
  <div class="message reply" id="message-2348">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/2345?r=2348#message-2348">RE: Possibly bugs in value parsing</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="10 Feb 2016 11:25" href="/projects/exiv2/activity?from=2016-02-10">almost 6 years</a> ago
  </h4>
  <div class="wiki"><p>It's in v0.25.  Parsing <em>Fnumber</em> is in types.cpp and provided for application exiv2(.exe).  The code is quoted here: <a class="external" href="http://dev.exiv2.org/boards/3/topics/2345?r=2347#message-2347">http://dev.exiv2.org/boards/3/topics/2345?r=2347#message-2347</a>  I think there's code to write <em>Fnumber</em>  in several locations.  Here are places to look:<pre>882 rmills@rmillsmbp:~/gnu/exiv2/trunk $ grep log\( src/*.cpp
src/canonmn.cpp:            os &lt;&lt; exp(canonEv(value.toLong()) * log(2.0)) * 100.0 / 32.0;
src/nikonmn.cpp:        double v = 100 * exp((value.toLong() / 12.0 - 5) * log(2.0));
src/tags.cpp:        return static_cast&lt;float&gt;(std::exp(std::log(2.0) * apertureValue / 2));
src/tags.cpp:        double tmp = std::exp(std::log(2.0) * shutterSpeedValue);
src/types.cpp:            f  = 2.0f * std::log(f) / std::log(2.0f) ;
src/types.cpp:            f  = 2.0f * std::log(f) / std::log(2.0f) ;
$ </pre></p></div>
  
  </div>
  <div class="message reply" id="message-2349">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/2345?r=2349#message-2349">RE: Possibly bugs in value parsing</a>
    -
    Added by <a class="user active" href="/users/4340">Mikayel Egibyan</a> <a title="10 Feb 2016 12:09" href="/projects/exiv2/activity?from=2016-02-10">almost 6 years</a> ago
  </h4>
  <div class="wiki"><p>Sorry, maybe I misunderstood something. If it is in 0.25 already shouldn't exifData["Exif.Image.ApertureValue"] = Exiv2::floatToRationalCast(1.2); already use your automatic parsing?</p>


	<p>Thanks,<br />Mikayel</p></div>
  
  </div>
  <div class="message reply" id="message-2350">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/2345?r=2350#message-2350">RE: Possibly bugs in value parsing</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="10 Feb 2016 12:45" href="/projects/exiv2/activity?from=2016-02-10">almost 6 years</a> ago
  </h4>
  <div class="wiki"><p>No!  The API floatToRationalCast has not been modified.  So:<pre><code class="cplusplus syntaxhl"><span class="n">floatToRationalCast</span><span class="p">(</span><span class="mf">1.2</span><span class="p">);</span></code></pre>returns 12/10 (or something like that).</p>


	<p>The parser is an >> operator overload on an input stream.  So you use it something like this <em>caution: untested and possibly wrong!</em>: <pre><code class="cplusplus syntaxhl"><span class="n">std</span><span class="o">::</span><span class="n">istringstream</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">"F1.8"</span><span class="p">))</span> <span class="n">is</span><span class="p">;</span>
<span class="n">Exiv2</span><span class="o">::</span><span class="n">Rational</span> <span class="n">r</span><span class="p">;</span>
<span class="n">is</span> <span class="o">&gt;&gt;</span> <span class="n">r</span><span class="p">;</span></code></pre>You'll probably have to debug/fix this.  Be sure to update this thread to help another user.</p>


	<p>What we do is to set up an input stream using a string.  Then we read from the stream into a rational.  C++ generates the code to use our operator overload.  The overload also handles other syntax such as "f1.8" and "12/10".  Makes sense, yes?</p>


	<p>You can easily write a function: <pre><code class="cplusplus syntaxhl"><span class="n">Exiv2</span><span class="o">::</span><span class="n">Rational</span> <span class="n">stringToRational</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">);</span></code></pre>using the three lines of code above.  I didn't add this function because I didn't need it!</p></div>
  
  </div>
  <div class="message reply" id="message-2351">
    <div class="contextual">
      
      
      
    </div>
  <h4>
    
    <a href="/boards/3/topics/2345?r=2351#message-2351">RE: Possibly bugs in value parsing</a>
    -
    Added by <a class="user active" href="/users/119">Robin Mills</a> <a title="10 Feb 2016 21:58" href="/projects/exiv2/activity?from=2016-02-10">almost 6 years</a> ago
  </h4>
  <div class="wiki"><p>I've written and tested the code. <pre><code class="cplusplus syntaxhl"><span class="c1">// ***************************************************************** -*- C++ -*-</span>
<span class="c1">// exifprint.cpp, $Rev: 4108 $</span>
<span class="c1">// Sample program to print the Exif metadata of an image</span>

<span class="cp">#include &lt;exiv2/exiv2.hpp&gt;
</span>
<span class="cp">#include &lt;iostream&gt;
#include &lt;iomanip&gt;
#include &lt;cassert&gt;
</span>
<span class="cp">#include &lt;iostream&gt;     // std::cout
#include &lt;sstream&gt;      // std::istringstream
#include &lt;string&gt;       // std::string
#include &lt;cmath&gt;        // std::log
</span>
    <span class="c1">// *************************************************************************</span>
    <span class="c1">// free functions</span>

    <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="k">const</span> <span class="n">Exiv2</span><span class="o">::</span><span class="n">Rational</span><span class="o">&amp;</span> <span class="n">r</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="p">.</span><span class="n">first</span> <span class="o">&lt;&lt;</span> <span class="s">"/"</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">is</span><span class="p">,</span> <span class="n">Exiv2</span><span class="o">::</span><span class="n">Rational</span><span class="o">&amp;</span> <span class="n">r</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// http://dev.exiv2.org/boards/3/topics/1912?r=1915</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="n">tolower</span><span class="p">(</span><span class="n">is</span><span class="p">.</span><span class="n">peek</span><span class="p">())</span> <span class="o">==</span> <span class="sc">'f'</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kt">char</span>  <span class="n">F</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">f</span><span class="p">;</span>
            <span class="n">is</span> <span class="o">&gt;&gt;</span> <span class="n">F</span> <span class="o">&gt;&gt;</span> <span class="n">f</span> <span class="p">;</span>
            <span class="n">f</span>  <span class="o">=</span> <span class="mf">2.0</span><span class="n">f</span> <span class="o">*</span> <span class="n">std</span><span class="o">::</span><span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span><span class="o">::</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span><span class="n">f</span><span class="p">)</span> <span class="p">;</span>
            <span class="n">r</span>  <span class="o">=</span> <span class="n">Exiv2</span><span class="o">::</span><span class="n">floatToRationalCast</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kt">int32_t</span> <span class="n">nominator</span><span class="p">;</span>
            <span class="kt">int32_t</span> <span class="n">denominator</span><span class="p">;</span>
            <span class="kt">char</span> <span class="n">c</span><span class="p">(</span><span class="sc">'\0'</span><span class="p">);</span>
            <span class="n">is</span> <span class="o">&gt;&gt;</span> <span class="n">nominator</span> <span class="o">&gt;&gt;</span> <span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="n">denominator</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">'/'</span><span class="p">)</span> <span class="n">is</span><span class="p">.</span><span class="n">setstate</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ios</span><span class="o">::</span><span class="n">failbit</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="p">)</span> <span class="n">r</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">nominator</span><span class="p">,</span> <span class="n">denominator</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">is</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">Exiv2</span><span class="o">::</span><span class="n">Rational</span> <span class="n">stringToRational</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">s</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">istringstream</span> <span class="n">iss</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
        <span class="n">Exiv2</span><span class="o">::</span><span class="n">Rational</span>    <span class="n">result</span><span class="p">;</span>
        <span class="n">iss</span>   <span class="o">&gt;&gt;</span>           <span class="n">result</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">argv</span><span class="p">[])</span>
<span class="k">try</span> <span class="p">{</span>

    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">Exiv2</span><span class="o">::</span><span class="n">Rational</span> <span class="n">r</span> <span class="o">=</span> <span class="n">stringToRational</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="kt">double</span>          <span class="n">d</span> <span class="o">=</span> <span class="p">((</span><span class="kt">double</span><span class="p">)</span> <span class="n">r</span><span class="p">.</span><span class="n">first</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="kt">double</span><span class="p">)</span> <span class="n">r</span><span class="p">.</span><span class="n">second</span><span class="p">)</span> <span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">" =&gt; "</span> <span class="o">&lt;&lt;</span> <span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="s">" = "</span> <span class="o">&lt;&lt;</span> <span class="n">d</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//catch (std::exception&amp; e) {</span>
<span class="c1">//catch (Exiv2::AnyError&amp; e) {</span>
<span class="k">catch</span> <span class="p">(</span><span class="n">Exiv2</span><span class="o">::</span><span class="n">Error</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Caught Exiv2 exception '"</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">"'</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></pre>And here's the output:<pre>939 rmills@rmillsmbp:~/gnu/exiv2/trunk $ bin/exifprint F{1..22}
F1 =&gt; 0/1 = 0
F2 =&gt; 2/1 = 2
F3 =&gt; 126797/40000 = 3.16993
F4 =&gt; 4/1 = 4
F5 =&gt; 290241/62500 = 4.64386
F6 =&gt; 206797/40000 = 5.16993
F7 =&gt; 561471/100000 = 5.61471
F8 =&gt; 6/1 = 6
F9 =&gt; 126797/20000 = 6.33985
F10 =&gt; 415241/62500 = 6.64386
F11 =&gt; 432429/62500 = 6.91886
F12 =&gt; 286797/40000 = 7.16993
F13 =&gt; 92511/12500 = 7.40088
F14 =&gt; 761471/100000 = 7.61471
F15 =&gt; 3906891/500000 = 7.81378
F16 =&gt; 8/1 = 8
F17 =&gt; 4087463/500000 = 8.17493
F18 =&gt; 8339851/1000000 = 8.33985
F19 =&gt; 530991/62500 = 8.49586
F20 =&gt; 540241/62500 = 8.64386
F21 =&gt; 2196159/250000 = 8.78464
F22 =&gt; 557429/62500 = 8.91886
940 rmills@rmillsmbp:~/gnu/exiv2/trunk $ </pre></p></code></pre></div>
  
  </div>
</div>
<span class="pagination"><ul class="pages"></ul><span><span class="items">(1-6/6)</span> </span></span>



        
        <div style="clear:both;"></div>
    </div>
</div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

<div id="footer">
  <div class="bgl"><div class="bgr">
    Powered by <a href="https://www.redmine.org/">Redmine</a> &copy; 2006-2018 Jean-Philippe Lang
  </div></div>
</div>
</div>
</div>

</body>
</html>
